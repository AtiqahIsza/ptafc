<?php

namespace App\Http\Livewire;

use App\Exports\SalesByBus;
use App\Exports\SPADClaimDetailsGPS;
use App\Exports\SPADClaimDetails;
use App\Exports\SPADClaimSummary;
use App\Exports\SPADIsbsf;
use App\Exports\SPADRoute;
use App\Exports\SPADSalesDetails;
use App\Exports\SPADServiceGroup;
use App\Exports\SPADSummary;
use App\Exports\SPADSummaryByNetwork;
use App\Exports\SPADSummaryByRoute;
use App\Exports\SPADTopAlighting;
use App\Exports\SPADTopBoarding;
use App\Exports\SPADTrip;
use App\Exports\SPADTripMissed;
use App\Exports\SPADTripPlanned;
use App\Exports\SPADBusTransfer;
use App\Models\Bus;
use App\Models\BusDriver;
use App\Models\BusStand;
use App\Models\Company;
use App\Models\Route;
use App\Models\RouteSchedulerDetail;
use App\Models\RouteSchedulerMSTR;
use App\Models\Stage;
use App\Models\TicketSalesTransaction;
use App\Models\TripDetail;
use App\Models\VehiclePosition;
use Illuminate\Support\Carbon;
use Illuminate\Support\Facades\Redirect;
use Illuminate\Support\Facades\Validator;
use Livewire\Component;
use Maatwebsite\Excel\Facades\Excel;
use Symfony\Component\Console\Output\ConsoleOutput;
use Illuminate\Support\Facades\DB;

class ReportSpad extends Component
{
    public $companies;
    public $routes;
    public $selectedCompany = NULL;
    public $state = [];

    public function render()
    {
        $this->companies = Company::orderBy('company_name')->get();
        return view('livewire.report-spad');
    }

    public function mount()
    {
        $this->companies=collect();
        $this->routes=collect();
    }

    public function updatedSelectedCompany($company)
    {
        if (!is_null($company)) {
            $this->routes = Route::where('company_id', $company)->where('status',1)->get();
        }
    }

    //FAST
    public function printSummary()
    {
        $out = new ConsoleOutput();
        $out->writeln("YOU ARE IN printSummary()");

        $validatedData = Validator::make($this->state,[
            'dateFrom' => ['required', 'date'],
            'dateTo' => ['required', 'date'],
            'route_id' => ['required'],
        ])->validate();

        $dateFrom = new Carbon($validatedData['dateFrom']);
        $dateTo = new Carbon($validatedData['dateTo'] . '23:59:59');

        $prevStart = Carbon::create($validatedData['dateFrom'])->startOfMonth()->subMonthsNoOverflow()->toDateString();
        $prevEnd = Carbon::create($validatedData['dateTo'])->subMonthsNoOverflow()->endOfMonth()->toDateString();

        $previousStartMonth = new Carbon($prevStart);
        $previousEndMonth = new Carbon($prevEnd . ' 23:59:59');

        $startDate = new Carbon($validatedData['dateFrom']);
        $endDate = new Carbon($validatedData['dateTo']);
        $all_dates = array();

        while ($startDate->lte($endDate)){
            $all_dates[] = $startDate->toDateString();
            $startDate->addDay();
        }

        if($this->selectedCompany){
            if($this->selectedCompany=='All'){
                $networkArea = 'All';
                //Summary all routes for all company
                if($validatedData['route_id']=='All'){
                    $allRoutes = Route::where('status', 1)->orderBy('route_number')->get();
                    $allTrips = [];

                    foreach($allRoutes as $allRoute){
                        $tripPerRoute = DB::select("SELECT route.id, trip_details.trip_code, route.route_number,
                        (case when (trip_details.trip_code = 1) THEN CONCAT(SUBSTRING_INDEX(SUBSTRING_INDEX(route_name, '-', 2), '-', -1)
                        , ' - ', SUBSTRING_INDEX(SUBSTRING_INDEX(route_name, '-', 2), '-', 1)) ELSE route.route_name END) as route_name,
                        SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                        SUM(total_adult) + SUM(total_concession) AS ridership,
                        ROUND((case when ((SUM(total_adult) + SUM(total_concession)) = 0) THEN 0
                        ELSE (SUM(total_adult_amount) + SUM(total_concession_amount))/(SUM(total_adult) + SUM(total_concession)) END),2) as average_pax,
                        (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                        SUM(trip_details.total_mileage) as km_served,
                        COUNT(DISTINCT(trip_details.bus_id)) as bus_deployed
                        FROM mybas.trip_details
                        JOIN mybas.route ON route.id = trip_details.route_id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND route.status = 1
                        AND route.id = " . $allRoute->id . "
                        GROUP BY route.route_number, trip_details.trip_code
                        ORDER BY route.route_number, trip_details.trip_code;");

                        $outTripArr = [];
                        $inTripArr = [];
                        if(!$tripPerRoute){
                            $out->writeln("In tripPerRoute < 0");
                            $outTrip = new \stdClass;
                            $outTrip->id = $allRoute->id;
                            $outTrip->trip_code = 0;
                            $outTrip->route_number = $allRoute->route_number;
                            $outTrip->route_name = $allRoute->route_name;
                            $outTrip->farebox = 0.00;
                            $outTrip->ridership = 0;
                            $outTrip->average_pax = 0;
                            $outTrip->trip_served = 0;
                            $outTrip->km_served = 0.00;
                            $outTrip->bus_deployed = 0;
                            $outTripArr[] = $outTrip;
                            $allTrips = array_merge($allTrips, $outTripArr);

                            $inTrip = new \stdClass;
                            $inTrip->id = $allRoute->id;
                            $inTrip->trip_code = 1;
                            $inTrip->route_number = $allRoute->route_number;
                            $inTrip->route_name = implode(" - ", array_reverse(explode("-", $allRoute->route_name)));
                            $inTrip->farebox = 0.00;
                            $inTrip->ridership = 0;
                            $inTrip->average_pax = 0;
                            $inTrip->trip_served = 0;
                            $inTrip->km_served = 0.00;
                            $inTrip->bus_deployed = 0;

                            $inTripArr[] = $inTrip;
                            $allTrips = array_merge($allTrips, $inTripArr);
                        }else{
                            $out->writeln("In tripPerRoute > 0");
                            $outExist = false;
                            $inExist = false;
                            foreach($tripPerRoute as $loop => $trip){
                                if($trip->trip_code==0){
                                    $outExist = true;
                                }
                                if($trip->trip_code==1){
                                    $inExist = true;
                                }
                            }

                            if($outExist==false && $inExist==true){
                                $outTrip = new \stdClass;
                                $outTrip->id = $allRoute->id;
                                $outTrip->trip_code = 0;
                                $outTrip->route_number = $allRoute->route_number;
                                $outTrip->route_name = $allRoute->route_name;
                                $outTrip->farebox = 0.00;
                                $outTrip->ridership = 0;
                                $outTrip->average_pax = 0;
                                $outTrip->trip_served = 0;
                                $outTrip->km_served = 0.00;
                                $outTrip->bus_deployed = 0;
                                $outTripArr[] = $outTrip;
                                $allTrips = array_merge($allTrips, $outTripArr);
                                $allTrips = array_merge($allTrips, $tripPerRoute);
                            }
                            elseif($outExist==true && $inExist==false){
                                $allTrips = array_merge($allTrips, $tripPerRoute);

                                $inTrip = new \stdClass;
                                $inTrip->id = $allRoute->id;
                                $inTrip->trip_code = 1;
                                $inTrip->route_number = $allRoute->route_number;
                                $inTrip->route_name = implode(" - ", array_reverse(explode("-", $allRoute->route_name)));
                                $inTrip->farebox = 0.00;
                                $inTrip->ridership = 0;
                                $inTrip->average_pax = 0;
                                $inTrip->trip_served = 0;
                                $inTrip->km_served = 0.00;
                                $inTrip->bus_deployed = 0;

                                $inTripArr[] = $inTrip;
                                $allTrips = array_merge($allTrips, $inTripArr);
                            }else{
                                $allTrips = array_merge($allTrips, $tripPerRoute);
                            }
                        }
                    }

                    $prevTrips = DB::select("SELECT trip_details.trip_code, route.route_number, 
                    SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                    SUM(total_adult) + SUM(total_concession) AS ridership
                    FROM mybas.trip_details
                    JOIN mybas.route ON route.id = trip_details.route_id
                    WHERE trip_details.start_trip BETWEEN '" . $previousStartMonth . "' AND '" . $previousEndMonth . "'
                    AND route.status = 1
                    GROUP BY route.route_number, trip_details.trip_code
                    ORDER BY route.route_number, trip_details.trip_code;");

                    $plannedTrips = DB::select("SELECT route_scheduler_mstr.trip_code, route.route_number, 
                    count(route_scheduler_details.id) as trip_planned, 
                    count(route_scheduler_details.id) * route.distance as km_planned
                    FROM mybas.route
                    JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                    JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                    WHERE route_scheduler_details.schedule_date BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                    AND route.status = 1
                    GROUP BY route_number, route_scheduler_mstr.trip_code
                    ORDER BY route_number, route_scheduler_mstr.trip_code;");

                    $lastKey = array_key_last($allTrips);
                    $pastRoute = "";
                    $count = 0;
                    $countMissedTripPerRoute = 0;
                    $countMissedTripGrand = 0;
                    $earlyDepartCount = 0;
                    $lateDepartCount = 0;
                    $earlyEndCount = 0;
                    $lateEndCount = 0;
                    $prevRidership = 0;
                    $prevFarebox = 0.00;
                    $tripPlannedRoute = 0;
                    $kmPlannedRoute = 0;
                    $busUsedRoute = 0;
                    $earlyDepartGrand = 0;
                    $lateDepartGrand = 0;
                    $earlyEndGrand = 0;
                    $lateEndGrand = 0;
                    $prevRidershipGrand = 0;
                    $prevFareboxGrand = 0.00;
                    $tripPlannedGrand = 0;
                    $kmPlannedGrand = 0;
                    $busUsedGrand = 0;
                    foreach($allTrips as $key => $allTrip){
                        $out->writeln("New Loop: " . $key . " - " . $allTrip->route_number . " - " . $allTrip->trip_code . " ");
                        
                        //Total Per Route
                        if($allTrip->route_number != $pastRoute && $pastRoute != NULL){
                            $totPerRoute = DB::select("SELECT route.route_number, 
                            SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                            SUM(total_adult) + SUM(total_concession) AS ridership,
                            ROUND((case when ((SUM(total_adult) + SUM(total_concession)) = 0) THEN 0
                            ELSE (SUM(total_adult_amount) + SUM(total_concession_amount))/(SUM(total_adult) + SUM(total_concession)) END),2) as average_pax,
                            (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                            SUM(trip_details.total_mileage) as km_served
                            FROM mybas.trip_details
                            JOIN mybas.route ON route.id = trip_details.route_id
                            WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND route.status = 1
                            AND route.route_number = '" . $pastRoute . "'
                            GROUP BY route.route_number
                            ORDER BY route.route_number;");

                            $noTripArr = [];
                            if(!$totPerRoute){
                                $out->writeln("In totPerRoute < 0");
                                $noTrip = new \stdClass;
                                $noTrip->route_number = $pastRoute;
                                $noTrip->farebox = 0.00;
                                $noTrip->ridership = 0;
                                $noTrip->average_pax = 0;
                                $noTrip->trip_served = 0;
                                $noTrip->km_served = 0.00;
                                $noTrip->bus_deployed = 0;
                                $noTrip->ridership_prev = $prevRidership;
                                $noTrip->ridership_increase = 0;
                                $noTrip->farebox_prev = $prevFarebox;
                                $noTrip->farebox_increase = 0;
                                $noTrip->trip_planned = $tripPlannedRoute;
                                $noTrip->km_planned = $kmPlannedRoute;
                                $noTrip->missed_trip = $countMissedTripPerRoute;
                                $noTrip->early_depart = $earlyDepartCount;
                                $noTrip->late_depart = $lateDepartCount;
                                $noTrip->early_end = $earlyEndCount;
                                $noTrip->late_end = $lateEndCount;
                                $noTrip->bus_deployed = $busUsedRoute;
                                $noTrip->breakdown = 0;
                                $noTrip->accident = 0;
                                $noTrip->complaint = 0;

                                $noTripArr[] = $noTrip;
                                if($count==0){
                                    array_splice($allTrips, $key, 0, $noTripArr);
                                }else{
                                    $newKey = $key + $count;
                                    array_splice($allTrips, $newKey, 0, $noTripArr);
                                }
                            }else{
                                $out->writeln("In totPerRoute > 0");
                                foreach($totPerRoute as $keyRoute => $perRoute){
                                    $perRoute->ridership_prev = $prevRidership;
                                    if($perRoute->ridership_prev==0){
                                        if($perRoute->ridership==0){
                                            $perRoute->ridership_increase = 0;
                                        }else{
                                            $perRoute->ridership_increase = 100;
                                        }
                                    }else{
                                        $calcRidershipIn = (($perRoute->ridership -  $perRoute->ridership_prev) /  $perRoute->ridership_prev) * 100;
                                        $perRoute->ridership_increase = number_format((float)$calcRidershipIn, 2, '.', '');
                                    }
                                    
                                    $perRoute->farebox_prev = $prevFarebox;
                                    if($perRoute->farebox_prev==0){
                                        if($perRoute->farebox==0){
                                            $perRoute->farebox_increase = 0;
                                        }else{
                                            $perRoute->farebox_increase = 100;
                                        }
                                    }else{
                                        $calcFareboxIn = (($perRoute->farebox -  $perRoute->farebox_prev) /  $perRoute->farebox_prev) * 100;
                                        $perRoute->farebox_increase = number_format((float)$calcFareboxIn, 2, '.', '');
                                    }

                                    $perRoute->trip_planned = $tripPlannedRoute;
                                    $perRoute->km_planned = $kmPlannedRoute;
                                    $perRoute->missed_trip = $countMissedTripPerRoute;
                                    $perRoute->early_depart = $earlyDepartCount;
                                    $perRoute->late_depart = $lateDepartCount;
                                    $perRoute->early_end = $earlyEndCount;
                                    $perRoute->late_end = $lateEndCount;
                                    $perRoute->bus_deployed = $busUsedRoute;
                                    $perRoute->breakdown = 0;
                                    $perRoute->accident = 0;
                                    $perRoute->complaint = 0;
                                }
    
                                if($count==0){
                                    array_splice($allTrips, $key, 0, $totPerRoute);
                                }else{
                                    $newKey = $key + $count;
                                    array_splice($allTrips, $newKey, 0, $totPerRoute);
                                }
                            }
                            $count++;
                            $prevRidership=0;
                            $prevFarebox=0;
                            $tripPlannedRoute=0;
                            $kmPlannedRoute=0;
                            $countMissedTripPerRoute=0;
                            $earlyDepartCount = 0;
                            $lateDepartCount = 0;
                            $earlyEndCount = 0;
                            $lateEndCount = 0;
                            $busUsedRoute = 0;
                        }

                        $busUsedRoute += $allTrip->bus_deployed;
                        $busUsedGrand += $allTrip->bus_deployed;

                        //Previous month
                        $foundPrev = false;
                        foreach($prevTrips as $key1 => $prevTrip){
                            if($prevTrip->trip_code == $allTrip->trip_code && $prevTrip->route_number == $allTrip->route_number){
                                $prevRidership += $prevTrip->ridership;
                                $prevFarebox += $prevTrip->farebox;
                                $prevRidershipGrand += $prevTrip->ridership;
                                $prevFareboxGrand += $prevTrip->farebox;

                                $allTrip->ridership_prev = $prevTrip->ridership;
                                //Increment ridership collection (%)
                                if($prevTrip->ridership==0){
                                    if($allTrip->ridership==0){
                                        $allTrip->ridership_increase = 0;
                                    }else{
                                        $allTrip->ridership_increase = 100;
                                    }
                                }else{
                                    $increaseRidership = (($allTrip->ridership -  $allTrip->ridership_prev) /  $allTrip->ridership_prev) * 100;
                                    $allTrip->ridership_increase = number_format((float)$increaseRidership, 2, '.', '');
                                }
                
                                $allTrip->farebox_prev = $prevTrip->farebox;
                                //Incremeant farebox collection (%)
                                if($prevTrip->farebox==0){
                                    if($allTrip->farebox==0){
                                        $allTrip->farebox_increase = 0;
                                    }else{
                                        $allTrip->farebox_increase = 100;
                                    }
                                }else{
                                    $increaseFarebox = (($allTrip->farebox - $allTrip->farebox_prev) / $allTrip->farebox_prev) * 100;
                                    $allTrip->farebox_increase = number_format((float)$increaseFarebox, 2, '.', '');
                                }
                                
                                $foundPrev = true;
                                break ;
                            }
                        }if(!$foundPrev){
                            $allTrip->ridership_prev = 0;
                            if($allTrip->ridership==0){
                                $allTrip->ridership_increase = 0;
                            }else{
                                $allTrip->ridership_increase = 100;
                            }

                            $allTrip->farebox_prev = 0.00;
                            if($allTrip->farebox==0){
                                $allTrip->farebox_increase = 0;
                            }else{
                                $allTrip->farebox_increase = 100;
                            }
                        }

                        //Planned Trip
                        $foundPlanned = false;
                        foreach($plannedTrips as $key2 => $plannedTrip){
                            if($plannedTrip->trip_code == $allTrip->trip_code && $plannedTrip->route_number == $allTrip->route_number){
                                $tripPlannedRoute += $plannedTrip->trip_planned;
                                $kmPlannedRoute += $plannedTrip->km_planned;
                                $tripPlannedGrand += $plannedTrip->trip_planned;
                                $kmPlannedGrand += $plannedTrip->km_planned;

                                $allTrip->trip_planned = $plannedTrip->trip_planned;
                                $allTrip->km_planned = $plannedTrip->km_planned;

                                //Total Missed Trip
                                $diff= $allTrip->trip_planned - $allTrip->trip_served;
                                if($diff>0){
                                    $allTrip->missed_trip = $diff;
                                    $countMissedTripPerRoute += $diff;
                                    $countMissedTripGrand += $diff;
                                }else{
                                    $allTrip->missed_trip = 0;
                                }

                                $foundPlanned = true;
                                break;
                            }
                        }if(!$foundPlanned){
                            $allTrip->trip_planned = 0;
                            $allTrip->km_planned = 0.00;
                            $allTrip->missed_trip = 0;
                        }

                        //Early Depart
                        $earlyDeparts = DB::select("SELECT count(trip_details.id) as countEarlyLate
                        FROM trip_details
                        WHERE trip_details.id IN ( 
                        SELECT trip_details.id
                        FROM mybas.trip_details
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.id = trip_details.route_schedule_mstr_id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND trip_details.route_id =  " . $allTrip->id . "
                        AND route_scheduler_mstr.trip_code = " . $allTrip->trip_code . "
                        AND TIMEDIFF(route_scheduler_mstr.schedule_start_time, cast(trip_details.start_trip as TIME)) > '00:05:00'
                        GROUP BY trip_details.id);");

                        foreach($earlyDeparts as $key3 => $earlyDepart){
                            $allTrip->early_depart = $earlyDepart->countEarlyLate;
                            $earlyDepartCount += $earlyDepart->countEarlyLate;
                            $earlyDepartGrand += $earlyDepart->countEarlyLate;
                        }

                        //Late Depart
                        $lateDeparts = DB::select("SELECT count(trip_details.id) as countEarlyLate
                        FROM trip_details
                        WHERE trip_details.id IN ( 
                        SELECT trip_details.id
                        FROM mybas.trip_details
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.id = trip_details.route_schedule_mstr_id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND trip_details.route_id = " . $allTrip->id . "
                        AND route_scheduler_mstr.trip_code = " . $allTrip->trip_code . "
                        AND TIMEDIFF(route_scheduler_mstr.schedule_start_time, cast(trip_details.start_trip as TIME)) < '-00:05:00'
                        GROUP BY trip_details.id);");

                        foreach($lateDeparts as $key4 => $lateDepart){
                            $allTrip->late_depart = $lateDepart->countEarlyLate;
                            $lateDepartCount += $lateDepart->countEarlyLate;
                            $lateDepartGrand += $lateDepart->countEarlyLate;
                        }

                        //Early End
                        $earlyEnds = DB::select("SELECT count(trip_details.id) as countEarlyLate
                        FROM trip_details
                        WHERE trip_details.id IN ( 
                        SELECT trip_details.id
                        FROM mybas.trip_details
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.id = trip_details.route_schedule_mstr_id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND trip_details.route_id = " . $allTrip->id . "
                        AND route_scheduler_mstr.trip_code = " . $allTrip->trip_code . "
                        AND TIMEDIFF(route_scheduler_mstr.schedule_end_time, cast(trip_details.end_trip as TIME)) > '00:05:00'
                        GROUP BY trip_details.id);");

                        foreach($earlyEnds as $key5 => $earlyEnd){
                            $allTrip->early_end = $earlyEnd->countEarlyLate;
                            $earlyEndCount += $earlyEnd->countEarlyLate;
                            $earlyEndGrand += $earlyEnd->countEarlyLate;
                        }

                        //Late End
                        $lateEnds = DB::select("SELECT count(trip_details.id) as countEarlyLate
                        FROM trip_details
                        WHERE trip_details.id IN ( 
                        SELECT trip_details.id
                        FROM mybas.trip_details
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.id = trip_details.route_schedule_mstr_id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND trip_details.route_id = " . $allTrip->id . "
                        AND route_scheduler_mstr.trip_code = " . $allTrip->trip_code . "
                        AND TIMEDIFF(route_scheduler_mstr.schedule_end_time, cast(trip_details.end_trip as TIME)) < '-00:05:00'
                        GROUP BY trip_details.id);");

                        foreach($lateEnds as $key6 => $lateEnd){
                            $allTrip->late_end = $lateEnd->countEarlyLate;
                            $lateEndCount += $lateEnd->countEarlyLate;
                            $lateEndGrand += $lateEnd->countEarlyLate;
                        }

                        $allTrip->breakdown = 0;
                        $allTrip->accident = 0;
                        $allTrip->complaint = 0;

                        $pastRoute = $allTrip->route_number;

                        if($lastKey==$key){
                            $totGrands = DB::select("SELECT
                            SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                            SUM(total_adult) + SUM(total_concession) AS ridership,
                            ROUND((case when ((SUM(total_adult) + SUM(total_concession)) = 0) THEN 0
                            ELSE (SUM(total_adult_amount) + SUM(total_concession_amount))/(SUM(total_adult) + SUM(total_concession)) END),2) as average_pax,
                            (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                            SUM(trip_details.total_mileage) as km_served
                            FROM mybas.trip_details
                            JOIN mybas.route ON route.id = trip_details.route_id
                            WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND route.status = 1");

                            foreach($totGrands as $keyGrand => $grand){
                                $grand->ridership_prev = $prevRidershipGrand;
                                if($grand->ridership_prev==0){
                                    if($grand->ridership==0){
                                        $grand->ridership_increase = 0;
                                    }else{
                                        $grand->ridership_increase = 100;
                                    }
                                }else{
                                    $calcRidershipIn = (($grand->ridership -  $grand->ridership_prev) /  $grand->ridership_prev) * 100;
                                    $grand->ridership_increase = number_format((float)$calcRidershipIn, 2, '.', '');
                                }

                                $grand->farebox_prev = $prevFareboxGrand;
                                if($grand->farebox_prev==0){
                                    if($grand->farebox==0){
                                        $grand->farebox_increase = 0;
                                    }else{
                                        $grand->farebox_increase = 100;
                                    }
                                }else{
                                    $calcFareboxIn = (($grand->farebox -  $grand->farebox_prev) /  $grand->farebox_prev) * 100;
                                    $grand->farebox_increase = number_format((float)$calcFareboxIn, 2, '.', '');
                                }

                                $grand->trip_planned = $tripPlannedGrand;
                                $grand->km_planned = $kmPlannedGrand;
                                $grand->missed_trip = $countMissedTripGrand;
                                $grand->early_depart = $earlyDepartGrand;
                                $grand->late_depart = $lateDepartGrand;
                                $grand->early_end = $earlyEndGrand;
                                $grand->late_end = $lateEndGrand;
                                $grand->bus_deployed = $busUsedGrand;
                                $grand->breakdown = 0;
                                $grand->accident = 0;
                                $grand->complaint = 0;
                            }

                            $newKey = $key + $count +1;
                            array_splice($allTrips, $newKey, 0, $totGrands);

                            $totPerRoute = DB::select("SELECT route.route_number, 
                            SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                            SUM(total_adult) + SUM(total_concession) AS ridership,
                            ROUND((case when ((SUM(total_adult) + SUM(total_concession)) = 0) THEN 0
                            ELSE (SUM(total_adult_amount) + SUM(total_concession_amount))/(SUM(total_adult) + SUM(total_concession)) END),2) as average_pax,
                            (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                            SUM(trip_details.total_mileage) as km_served
                            FROM mybas.trip_details
                            JOIN mybas.route ON route.id = trip_details.route_id
                            WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND route.status = 1
                            AND route.route_number = '" . $pastRoute . "'
                            GROUP BY route.route_number
                            ORDER BY route.route_number;");

                            $noTripArr = [];
                            if(!$totPerRoute){
                                $out->writeln("In totPerRoute < 0");
                                $noTrip = new \stdClass;
                                $noTrip->route_number = $pastRoute;
                                $noTrip->farebox = 0.00;
                                $noTrip->ridership = 0;
                                $noTrip->average_pax = 0;
                                $noTrip->trip_served = 0;
                                $noTrip->km_served = 0.00;
                                $noTrip->bus_deployed = 0;
                                $noTrip->ridership_prev = $prevRidership;
                                $noTrip->ridership_increase = 0;
                                $noTrip->farebox_prev = $prevFarebox;
                                $noTrip->farebox_increase = 0;
                                $noTrip->trip_planned = $tripPlannedRoute;
                                $noTrip->km_planned = $kmPlannedRoute;
                                $noTrip->missed_trip = $countMissedTripPerRoute;
                                $noTrip->early_depart = $earlyDepartCount;
                                $noTrip->late_depart = $lateDepartCount;
                                $noTrip->early_end = $earlyEndCount;
                                $noTrip->late_end = $lateEndCount;
                                $noTrip->breakdown = 0;
                                $noTrip->accident = 0;
                                $noTrip->complaint = 0;

                                $noTripArr[] = $noTrip;
                                $newKey = $key + $count+1;
                                array_splice($allTrips, $newKey, 0, $noTripArr);
                            }else{
                                $out->writeln("In totPerRoute > 0");
                                foreach($totPerRoute as $keyRoute => $perRoute){
                                    $perRoute->ridership_prev = $prevRidership;
                                    if($perRoute->ridership_prev==0){
                                        if($perRoute->ridership==0){
                                            $perRoute->ridership_increase = 0;
                                        }else{
                                            $perRoute->ridership_increase = 100;
                                        }
                                    }else{
                                        $calcRidershipIn = (($perRoute->ridership -  $perRoute->ridership_prev) /  $perRoute->ridership_prev) * 100;
                                        $perRoute->ridership_increase = number_format((float)$calcRidershipIn, 2, '.', '');
                                    }
                                    
                                    $perRoute->farebox_prev = $prevFarebox;
                                    if($perRoute->farebox_prev==0){
                                        if($perRoute->farebox==0){
                                            $perRoute->farebox_increase = 0;
                                        }else{
                                            $perRoute->farebox_increase = 100;
                                        }
                                    }else{
                                        $calcFareboxIn = (($perRoute->farebox -  $perRoute->farebox_prev) /  $perRoute->farebox_prev) * 100;
                                        $perRoute->farebox_increase = number_format((float)$calcFareboxIn, 2, '.', '');
                                    }
    
                                    $perRoute->trip_planned = $tripPlannedRoute;
                                    $perRoute->km_planned = $kmPlannedRoute;
                                    $perRoute->missed_trip = $countMissedTripPerRoute;
                                    $perRoute->early_depart = $earlyDepartCount;
                                    $perRoute->late_depart = $lateDepartCount;
                                    $perRoute->early_end = $earlyEndCount;
                                    $perRoute->late_end = $lateEndCount;
                                    $perRoute->bus_deployed = $busUsedRoute;
                                    $perRoute->breakdown = 0;
                                    $perRoute->accident = 0;
                                    $perRoute->complaint = 0;
                                }
    
                                $newKey = $key + $count+1;
                                array_splice($allTrips, $newKey, 0, $totPerRoute);
                            }
                        }

                    }

                }
            }else{
                $companyDetails = Company::where('id', $this->selectedCompany)->first();
                $networkArea = $companyDetails->company_name;

                if($validatedData['route_id']=='All'){
                    $allRoutes = Route::where('company_id', $companyDetails->id)->where('status', 1)->orderBy('route_number')->get();
                    $allTrips = [];

                    foreach($allRoutes as $allRoute){
                        $tripPerRoute = DB::select("SELECT route.id, trip_details.trip_code, route.route_number,
                        (case when (trip_details.trip_code = 1) THEN CONCAT(SUBSTRING_INDEX(SUBSTRING_INDEX(route_name, '-', 2), '-', -1)
                        , ' - ', SUBSTRING_INDEX(SUBSTRING_INDEX(route_name, '-', 2), '-', 1)) ELSE route.route_name END) as route_name,
                        SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                        SUM(total_adult) + SUM(total_concession) AS ridership,
                        ROUND((case when ((SUM(total_adult) + SUM(total_concession)) = 0) THEN 0
                        ELSE (SUM(total_adult_amount) + SUM(total_concession_amount))/(SUM(total_adult) + SUM(total_concession)) END),2) as average_pax,
                        (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                        SUM(trip_details.total_mileage) as km_served,
                        COUNT(DISTINCT(trip_details.bus_id)) as bus_deployed
                        FROM mybas.trip_details
                        JOIN mybas.route ON route.id = trip_details.route_id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND route.status = 1
                        AND route.id = " . $allRoute->id . "
                        GROUP BY route.route_number, trip_details.trip_code
                        ORDER BY route.route_number, trip_details.trip_code;");

                        $outTripArr = [];
                        $inTripArr = [];
                        if(!$tripPerRoute){
                            $out->writeln("In tripPerRoute < 0");
                            $outTrip = new \stdClass;
                            $outTrip->id = $allRoute->id;
                            $outTrip->trip_code = 0;
                            $outTrip->route_number = $allRoute->route_number;
                            $outTrip->route_name = $allRoute->route_name;
                            $outTrip->farebox = 0.00;
                            $outTrip->ridership = 0;
                            $outTrip->average_pax = 0;
                            $outTrip->trip_served = 0;
                            $outTrip->km_served = 0.00;
                            $outTrip->bus_deployed = 0;
                            $outTripArr[] = $outTrip;
                            $allTrips = array_merge($allTrips, $outTripArr);

                            $inTrip = new \stdClass;
                            $inTrip->id = $allRoute->id;
                            $inTrip->trip_code = 1;
                            $inTrip->route_number = $allRoute->route_number;
                            $inTrip->route_name = implode(" - ", array_reverse(explode("-", $allRoute->route_name)));
                            $inTrip->farebox = 0.00;
                            $inTrip->ridership = 0;
                            $inTrip->average_pax = 0;
                            $inTrip->trip_served = 0;
                            $inTrip->km_served = 0.00;
                            $inTrip->bus_deployed = 0;

                            $inTripArr[] = $inTrip;
                            $allTrips = array_merge($allTrips, $inTripArr);
                        }else{
                            $out->writeln("In tripPerRoute > 0");
                            $outExist = false;
                            $inExist = false;
                            foreach($tripPerRoute as $loop => $trip){
                                if($trip->trip_code==0){
                                    $outExist = true;
                                }
                                if($trip->trip_code==1){
                                    $inExist = true;
                                }
                            }

                            if($outExist==false && $inExist==true){
                                $outTrip = new \stdClass;
                                $outTrip->id = $allRoute->id;
                                $outTrip->trip_code = 0;
                                $outTrip->route_number = $allRoute->route_number;
                                $outTrip->route_name = $allRoute->route_name;
                                $outTrip->farebox = 0.00;
                                $outTrip->ridership = 0;
                                $outTrip->average_pax = 0;
                                $outTrip->trip_served = 0;
                                $outTrip->km_served = 0.00;
                                $outTrip->bus_deployed = 0;
                                $outTripArr[] = $outTrip;
                                $allTrips = array_merge($allTrips, $outTripArr);
                                $allTrips = array_merge($allTrips, $tripPerRoute);
                            }
                            elseif($outExist==true && $inExist==false){
                                $allTrips = array_merge($allTrips, $tripPerRoute);

                                $inTrip = new \stdClass;
                                $inTrip->id = $allRoute->id;
                                $inTrip->trip_code = 1;
                                $inTrip->route_number = $allRoute->route_number;
                                $inTrip->route_name = implode(" - ", array_reverse(explode("-", $allRoute->route_name)));
                                $inTrip->farebox = 0.00;
                                $inTrip->ridership = 0;
                                $inTrip->average_pax = 0;
                                $inTrip->trip_served = 0;
                                $inTrip->km_served = 0.00;
                                $inTrip->bus_deployed = 0;

                                $inTripArr[] = $inTrip;
                                $allTrips = array_merge($allTrips, $inTripArr);
                            }else{
                                $allTrips = array_merge($allTrips, $tripPerRoute);
                            }
                        }
                    }

                    $prevTrips = DB::select("SELECT trip_details.trip_code, route.route_number, 
                    SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                    SUM(total_adult) + SUM(total_concession) AS ridership
                    FROM mybas.trip_details
                    JOIN mybas.route ON route.id = trip_details.route_id
                    WHERE trip_details.start_trip BETWEEN '" . $previousStartMonth . "' AND '" . $previousEndMonth . "'
                    AND route.status = 1
                    GROUP BY route.route_number, trip_details.trip_code
                    ORDER BY route.route_number, trip_details.trip_code;");

                    $plannedTrips = DB::select("SELECT route_scheduler_mstr.trip_code, route.route_number, 
                    count(route_scheduler_details.id) as trip_planned, 
                    count(route_scheduler_details.id) * route.distance as km_planned
                    FROM mybas.route
                    JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                    JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                    WHERE route_scheduler_details.schedule_date BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                    AND route.status = 1
                    GROUP BY route_number, route_scheduler_mstr.trip_code
                    ORDER BY route_number, route_scheduler_mstr.trip_code;");

                    $lastKey = array_key_last($allTrips);
                    $pastRoute = "";
                    $count = 0;
                    $countMissedTripPerRoute = 0;
                    $countMissedTripGrand = 0;
                    $earlyDepartCount = 0;
                    $lateDepartCount = 0;
                    $earlyEndCount = 0;
                    $lateEndCount = 0;
                    $prevRidership = 0;
                    $prevFarebox = 0.00;
                    $tripPlannedRoute = 0;
                    $kmPlannedRoute = 0;
                    $busUsedRoute = 0;
                    $earlyDepartGrand = 0;
                    $lateDepartGrand = 0;
                    $earlyEndGrand = 0;
                    $lateEndGrand = 0;
                    $prevRidershipGrand = 0;
                    $prevFareboxGrand = 0.00;
                    $tripPlannedGrand = 0;
                    $kmPlannedGrand = 0;
                    $busUsedGrand = 0;
                    foreach($allTrips as $key => $allTrip){
                        $out->writeln("New Loop: " . $key . " - " . $allTrip->route_number . " - " . $allTrip->trip_code . " ");
                        
                        //Total Per Route
                        if($allTrip->route_number != $pastRoute && $pastRoute != NULL){
                            $totPerRoute = DB::select("SELECT route.route_number, 
                            SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                            SUM(total_adult) + SUM(total_concession) AS ridership,
                            ROUND((case when ((SUM(total_adult) + SUM(total_concession)) = 0) THEN 0
                            ELSE (SUM(total_adult_amount) + SUM(total_concession_amount))/(SUM(total_adult) + SUM(total_concession)) END),2) as average_pax,
                            (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                            SUM(trip_details.total_mileage) as km_served
                            FROM mybas.trip_details
                            JOIN mybas.route ON route.id = trip_details.route_id
                            WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND route.status = 1
                            AND route.route_number = '" . $pastRoute . "'
                            GROUP BY route.route_number
                            ORDER BY route.route_number;");

                            $noTripArr = [];
                            if(!$totPerRoute){
                                $out->writeln("In totPerRoute < 0");
                                $noTrip = new \stdClass;
                                $noTrip->route_number = $pastRoute;
                                $noTrip->farebox = 0.00;
                                $noTrip->ridership = 0;
                                $noTrip->average_pax = 0;
                                $noTrip->trip_served = 0;
                                $noTrip->km_served = 0.00;
                                $noTrip->bus_deployed = 0;
                                $noTrip->ridership_prev = $prevRidership;
                                $noTrip->ridership_increase = 0;
                                $noTrip->farebox_prev = $prevFarebox;
                                $noTrip->farebox_increase = 0;
                                $noTrip->trip_planned = $tripPlannedRoute;
                                $noTrip->km_planned = $kmPlannedRoute;
                                $noTrip->missed_trip = $countMissedTripPerRoute;
                                $noTrip->early_depart = $earlyDepartCount;
                                $noTrip->late_depart = $lateDepartCount;
                                $noTrip->early_end = $earlyEndCount;
                                $noTrip->late_end = $lateEndCount;
                                $noTrip->bus_deployed = $busUsedRoute;
                                $noTrip->breakdown = 0;
                                $noTrip->accident = 0;
                                $noTrip->complaint = 0;

                                $noTripArr[] = $noTrip;
                                if($count==0){
                                    array_splice($allTrips, $key, 0, $noTripArr);
                                }else{
                                    $newKey = $key + $count;
                                    array_splice($allTrips, $newKey, 0, $noTripArr);
                                }
                            }else{
                                $out->writeln("In totPerRoute > 0");
                                foreach($totPerRoute as $keyRoute => $perRoute){
                                    $perRoute->ridership_prev = $prevRidership;
                                    if($perRoute->ridership_prev==0){
                                        if($perRoute->ridership==0){
                                            $perRoute->ridership_increase = 0;
                                        }else{
                                            $perRoute->ridership_increase = 100;
                                        }
                                    }else{
                                        $calcRidershipIn = (($perRoute->ridership -  $perRoute->ridership_prev) /  $perRoute->ridership_prev) * 100;
                                        $perRoute->ridership_increase = number_format((float)$calcRidershipIn, 2, '.', '');
                                    }
                                    
                                    $perRoute->farebox_prev = $prevFarebox;
                                    if($perRoute->farebox_prev==0){
                                        if($perRoute->farebox==0){
                                            $perRoute->farebox_increase = 0;
                                        }else{
                                            $perRoute->farebox_increase = 100;
                                        }
                                    }else{
                                        $calcFareboxIn = (($perRoute->farebox -  $perRoute->farebox_prev) /  $perRoute->farebox_prev) * 100;
                                        $perRoute->farebox_increase = number_format((float)$calcFareboxIn, 2, '.', '');
                                    }

                                    $perRoute->trip_planned = $tripPlannedRoute;
                                    $perRoute->km_planned = $kmPlannedRoute;
                                    $perRoute->missed_trip = $countMissedTripPerRoute;
                                    $perRoute->early_depart = $earlyDepartCount;
                                    $perRoute->late_depart = $lateDepartCount;
                                    $perRoute->early_end = $earlyEndCount;
                                    $perRoute->late_end = $lateEndCount;
                                    $perRoute->bus_deployed = $busUsedRoute;
                                    $perRoute->breakdown = 0;
                                    $perRoute->accident = 0;
                                    $perRoute->complaint = 0;
                                }
    
                                if($count==0){
                                    array_splice($allTrips, $key, 0, $totPerRoute);
                                }else{
                                    $newKey = $key + $count;
                                    array_splice($allTrips, $newKey, 0, $totPerRoute);
                                }
                            }
                            $count++;
                            $prevRidership=0;
                            $prevFarebox=0;
                            $tripPlannedRoute=0;
                            $kmPlannedRoute=0;
                            $countMissedTripPerRoute=0;
                            $earlyDepartCount = 0;
                            $lateDepartCount = 0;
                            $earlyEndCount = 0;
                            $lateEndCount = 0;
                            $busUsedRoute = 0;
                        }

                        $busUsedRoute += $allTrip->bus_deployed;
                        $busUsedGrand += $allTrip->bus_deployed;

                        //Previous month
                        $foundPrev = false;
                        foreach($prevTrips as $key1 => $prevTrip){
                            if($prevTrip->trip_code == $allTrip->trip_code && $prevTrip->route_number == $allTrip->route_number){
                                $prevRidership += $prevTrip->ridership;
                                $prevFarebox += $prevTrip->farebox;
                                $prevRidershipGrand += $prevTrip->ridership;
                                $prevFareboxGrand += $prevTrip->farebox;

                                $allTrip->ridership_prev = $prevTrip->ridership;
                                //Increment ridership collection (%)
                                if($prevTrip->ridership==0){
                                    if($allTrip->ridership==0){
                                        $allTrip->ridership_increase = 0;
                                    }else{
                                        $allTrip->ridership_increase = 100;
                                    }
                                }else{
                                    $increaseRidership = (($allTrip->ridership -  $allTrip->ridership_prev) /  $allTrip->ridership_prev) * 100;
                                    $allTrip->ridership_increase = number_format((float)$increaseRidership, 2, '.', '');
                                }
                
                                $allTrip->farebox_prev = $prevTrip->farebox;
                                //Incremeant farebox collection (%)
                                if($prevTrip->farebox==0){
                                    if($allTrip->farebox==0){
                                        $allTrip->farebox_increase = 0;
                                    }else{
                                        $allTrip->farebox_increase = 100;
                                    }
                                }else{
                                    $increaseFarebox = (($allTrip->farebox - $allTrip->farebox_prev) / $allTrip->farebox_prev) * 100;
                                    $allTrip->farebox_increase = number_format((float)$increaseFarebox, 2, '.', '');
                                }
                                
                                $foundPrev = true;
                                break ;
                            }
                        }if(!$foundPrev){
                            $allTrip->ridership_prev = 0;
                            if($allTrip->ridership==0){
                                $allTrip->ridership_increase = 0;
                            }else{
                                $allTrip->ridership_increase = 100;
                            }

                            $allTrip->farebox_prev = 0.00;
                            if($allTrip->farebox==0){
                                $allTrip->farebox_increase = 0;
                            }else{
                                $allTrip->farebox_increase = 100;
                            }
                        }

                        //Planned Trip
                        $foundPlanned = false;
                        foreach($plannedTrips as $key2 => $plannedTrip){
                            if($plannedTrip->trip_code == $allTrip->trip_code && $plannedTrip->route_number == $allTrip->route_number){
                                $tripPlannedRoute += $plannedTrip->trip_planned;
                                $kmPlannedRoute += $plannedTrip->km_planned;
                                $tripPlannedGrand += $plannedTrip->trip_planned;
                                $kmPlannedGrand += $plannedTrip->km_planned;

                                $allTrip->trip_planned = $plannedTrip->trip_planned;
                                $allTrip->km_planned = $plannedTrip->km_planned;

                                //Total Missed Trip
                                $diff= $allTrip->trip_planned - $allTrip->trip_served;
                                if($diff>0){
                                    $allTrip->missed_trip = $diff;
                                    $countMissedTripPerRoute += $diff;
                                    $countMissedTripGrand += $diff;
                                }else{
                                    $allTrip->missed_trip = 0;
                                }

                                $foundPlanned = true;
                                break;
                            }
                        }if(!$foundPlanned){
                            $allTrip->trip_planned = 0;
                            $allTrip->km_planned = 0.00;
                            $allTrip->missed_trip = 0;
                        }

                        //Early Depart
                        $earlyDeparts = DB::select("SELECT count(trip_details.id) as countEarlyLate
                        FROM trip_details
                        WHERE trip_details.id IN ( 
                        SELECT trip_details.id
                        FROM mybas.trip_details
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.id = trip_details.route_schedule_mstr_id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND trip_details.route_id =  " . $allTrip->id . "
                        AND route_scheduler_mstr.trip_code = " . $allTrip->trip_code . "
                        AND TIMEDIFF(route_scheduler_mstr.schedule_start_time, cast(trip_details.start_trip as TIME)) > '00:05:00'
                        GROUP BY trip_details.id);");

                        foreach($earlyDeparts as $key3 => $earlyDepart){
                            $allTrip->early_depart = $earlyDepart->countEarlyLate;
                            $earlyDepartCount += $earlyDepart->countEarlyLate;
                            $earlyDepartGrand += $earlyDepart->countEarlyLate;
                        }

                        //Late Depart
                        $lateDeparts = DB::select("SELECT count(trip_details.id) as countEarlyLate
                        FROM trip_details
                        WHERE trip_details.id IN ( 
                        SELECT trip_details.id
                        FROM mybas.trip_details
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.id = trip_details.route_schedule_mstr_id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND trip_details.route_id = " . $allTrip->id . "
                        AND route_scheduler_mstr.trip_code = " . $allTrip->trip_code . "
                        AND TIMEDIFF(route_scheduler_mstr.schedule_start_time, cast(trip_details.start_trip as TIME)) < '-00:05:00'
                        GROUP BY trip_details.id);");

                        foreach($lateDeparts as $key4 => $lateDepart){
                            $allTrip->late_depart = $lateDepart->countEarlyLate;
                            $lateDepartCount += $lateDepart->countEarlyLate;
                            $lateDepartGrand += $lateDepart->countEarlyLate;
                        }

                        //Early End
                        $earlyEnds = DB::select("SELECT count(trip_details.id) as countEarlyLate
                        FROM trip_details
                        WHERE trip_details.id IN ( 
                        SELECT trip_details.id
                        FROM mybas.trip_details
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.id = trip_details.route_schedule_mstr_id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND trip_details.route_id = " . $allTrip->id . "
                        AND route_scheduler_mstr.trip_code = " . $allTrip->trip_code . "
                        AND TIMEDIFF(route_scheduler_mstr.schedule_end_time, cast(trip_details.end_trip as TIME)) > '00:05:00'
                        GROUP BY trip_details.id);");

                        foreach($earlyEnds as $key5 => $earlyEnd){
                            $allTrip->early_end = $earlyEnd->countEarlyLate;
                            $earlyEndCount += $earlyEnd->countEarlyLate;
                            $earlyEndGrand += $earlyEnd->countEarlyLate;
                        }

                        //Late End
                        $lateEnds = DB::select("SELECT count(trip_details.id) as countEarlyLate
                        FROM trip_details
                        WHERE trip_details.id IN ( 
                        SELECT trip_details.id
                        FROM mybas.trip_details
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.id = trip_details.route_schedule_mstr_id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND trip_details.route_id = " . $allTrip->id . "
                        AND route_scheduler_mstr.trip_code = " . $allTrip->trip_code . "
                        AND TIMEDIFF(route_scheduler_mstr.schedule_end_time, cast(trip_details.end_trip as TIME)) < '-00:05:00'
                        GROUP BY trip_details.id);");

                        foreach($lateEnds as $key6 => $lateEnd){
                            $allTrip->late_end = $lateEnd->countEarlyLate;
                            $lateEndCount += $lateEnd->countEarlyLate;
                            $lateEndGrand += $lateEnd->countEarlyLate;
                        }

                        $allTrip->breakdown = 0;
                        $allTrip->accident = 0;
                        $allTrip->complaint = 0;

                        $pastRoute = $allTrip->route_number;

                        if($lastKey==$key){
                            $totGrands = DB::select("SELECT
                            SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                            SUM(total_adult) + SUM(total_concession) AS ridership,
                            ROUND((case when ((SUM(total_adult) + SUM(total_concession)) = 0) THEN 0
                            ELSE (SUM(total_adult_amount) + SUM(total_concession_amount))/(SUM(total_adult) + SUM(total_concession)) END),2) as average_pax,
                            (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                            SUM(trip_details.total_mileage) as km_served
                            FROM mybas.trip_details
                            JOIN mybas.route ON route.id = trip_details.route_id
                            WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND route.status = 1
                            AND route.company_id = " . $companyDetails->id . ";");

                            foreach($totGrands as $keyGrand => $grand){
                                $grand->ridership_prev = $prevRidershipGrand;
                                if($grand->ridership_prev==0){
                                    if($grand->ridership==0){
                                        $grand->ridership_increase = 0;
                                    }else{
                                        $grand->ridership_increase = 100;
                                    }
                                }else{
                                    $calcRidershipIn = (($grand->ridership -  $grand->ridership_prev) /  $grand->ridership_prev) * 100;
                                    $grand->ridership_increase = number_format((float)$calcRidershipIn, 2, '.', '');
                                }

                                $grand->farebox_prev = $prevFareboxGrand;
                                if($grand->farebox_prev==0){
                                    if($grand->farebox==0){
                                        $grand->farebox_increase = 0;
                                    }else{
                                        $grand->farebox_increase = 100;
                                    }
                                }else{
                                    $calcFareboxIn = (($grand->farebox -  $grand->farebox_prev) /  $grand->farebox_prev) * 100;
                                    $grand->farebox_increase = number_format((float)$calcFareboxIn, 2, '.', '');
                                }

                                $grand->trip_planned = $tripPlannedGrand;
                                $grand->km_planned = $kmPlannedGrand;
                                $grand->missed_trip = $countMissedTripGrand;
                                $grand->early_depart = $earlyDepartGrand;
                                $grand->late_depart = $lateDepartGrand;
                                $grand->early_end = $earlyEndGrand;
                                $grand->late_end = $lateEndGrand;
                                $grand->bus_deployed = $busUsedGrand;
                                $grand->breakdown = 0;
                                $grand->accident = 0;
                                $grand->complaint = 0;
                            }

                            $newKey = $key + $count +1;
                            array_splice($allTrips, $newKey, 0, $totGrands);

                            $totPerRoute = DB::select("SELECT route.route_number, 
                            SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                            SUM(total_adult) + SUM(total_concession) AS ridership,
                            ROUND((case when ((SUM(total_adult) + SUM(total_concession)) = 0) THEN 0
                            ELSE (SUM(total_adult_amount) + SUM(total_concession_amount))/(SUM(total_adult) + SUM(total_concession)) END),2) as average_pax,
                            (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                            SUM(trip_details.total_mileage) as km_served
                            FROM mybas.trip_details
                            JOIN mybas.route ON route.id = trip_details.route_id
                            WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND route.status = 1
                            AND route.route_number = '" . $pastRoute . "'
                            GROUP BY route.route_number
                            ORDER BY route.route_number;");

                            $noTripArr = [];
                            if(!$totPerRoute){
                                $out->writeln("In totPerRoute < 0");
                                $noTrip = new \stdClass;
                                $noTrip->route_number = $pastRoute;
                                $noTrip->farebox = 0.00;
                                $noTrip->ridership = 0;
                                $noTrip->average_pax = 0;
                                $noTrip->trip_served = 0;
                                $noTrip->km_served = 0.00;
                                $noTrip->bus_deployed = 0;
                                $noTrip->ridership_prev = $prevRidership;
                                $noTrip->ridership_increase = 0;
                                $noTrip->farebox_prev = $prevFarebox;
                                $noTrip->farebox_increase = 0;
                                $noTrip->trip_planned = $tripPlannedRoute;
                                $noTrip->km_planned = $kmPlannedRoute;
                                $noTrip->missed_trip = $countMissedTripPerRoute;
                                $noTrip->early_depart = $earlyDepartCount;
                                $noTrip->late_depart = $lateDepartCount;
                                $noTrip->early_end = $earlyEndCount;
                                $noTrip->late_end = $lateEndCount;
                                $noTrip->breakdown = 0;
                                $noTrip->accident = 0;
                                $noTrip->complaint = 0;

                                $noTripArr[] = $noTrip;
                                $newKey = $key + $count+1;
                                array_splice($allTrips, $newKey, 0, $noTripArr);
                            }else{
                                $out->writeln("In totPerRoute > 0");
                                foreach($totPerRoute as $keyRoute => $perRoute){
                                    $perRoute->ridership_prev = $prevRidership;
                                    if($perRoute->ridership_prev==0){
                                        if($perRoute->ridership==0){
                                            $perRoute->ridership_increase = 0;
                                        }else{
                                            $perRoute->ridership_increase = 100;
                                        }
                                    }else{
                                        $calcRidershipIn = (($perRoute->ridership -  $perRoute->ridership_prev) /  $perRoute->ridership_prev) * 100;
                                        $perRoute->ridership_increase = number_format((float)$calcRidershipIn, 2, '.', '');
                                    }
                                    
                                    $perRoute->farebox_prev = $prevFarebox;
                                    if($perRoute->farebox_prev==0){
                                        if($perRoute->farebox==0){
                                            $perRoute->farebox_increase = 0;
                                        }else{
                                            $perRoute->farebox_increase = 100;
                                        }
                                    }else{
                                        $calcFareboxIn = (($perRoute->farebox -  $perRoute->farebox_prev) /  $perRoute->farebox_prev) * 100;
                                        $perRoute->farebox_increase = number_format((float)$calcFareboxIn, 2, '.', '');
                                    }
    
                                    $perRoute->trip_planned = $tripPlannedRoute;
                                    $perRoute->km_planned = $kmPlannedRoute;
                                    $perRoute->missed_trip = $countMissedTripPerRoute;
                                    $perRoute->early_depart = $earlyDepartCount;
                                    $perRoute->late_depart = $lateDepartCount;
                                    $perRoute->early_end = $earlyEndCount;
                                    $perRoute->late_end = $lateEndCount;
                                    $perRoute->bus_deployed = $busUsedRoute;
                                    $perRoute->breakdown = 0;
                                    $perRoute->accident = 0;
                                    $perRoute->complaint = 0;
                                }
    
                                $newKey = $key + $count+1;
                                array_splice($allTrips, $newKey, 0, $totPerRoute);
                            }
                        }

                    }

                }
                else{
                    $allRoute = Route::where('id', $validatedData['route_id'])->first();
                    $allTrips = [];
                    $outTripArr = [];
                    $inTripArr = [];

                    $tripPerRoute = DB::select("SELECT route.id, trip_details.trip_code, route.route_number,
                    (case when (trip_details.trip_code = 1) THEN CONCAT(SUBSTRING_INDEX(SUBSTRING_INDEX(route_name, '-', 2), '-', -1)
                    , ' - ', SUBSTRING_INDEX(SUBSTRING_INDEX(route_name, '-', 2), '-', 1)) ELSE route.route_name END) as route_name,
                    SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                    SUM(total_adult) + SUM(total_concession) AS ridership,
                    ROUND((case when ((SUM(total_adult) + SUM(total_concession)) = 0) THEN 0
                    ELSE (SUM(total_adult_amount) + SUM(total_concession_amount))/(SUM(total_adult) + SUM(total_concession)) END),2) as average_pax,
                    (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                    SUM(trip_details.total_mileage) as km_served,
                    COUNT(DISTINCT(trip_details.bus_id)) as bus_deployed
                    FROM mybas.trip_details
                    JOIN mybas.route ON route.id = trip_details.route_id
                    WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                    AND route.status = 1
                    AND route.id = " . $allRoute->id . "
                    GROUP BY route.route_number, trip_details.trip_code
                    ORDER BY route.route_number, trip_details.trip_code;");

                    if(!$tripPerRoute){
                        $out->writeln("In tripPerRoute < 0");
                        $outTrip = new \stdClass;
                        $outTrip->id = $allRoute->id;
                        $outTrip->trip_code = 0;
                        $outTrip->route_number = $allRoute->route_number;
                        $outTrip->route_name = $allRoute->route_name;
                        $outTrip->farebox = 0.00;
                        $outTrip->ridership = 0;
                        $outTrip->average_pax = 0;
                        $outTrip->trip_served = 0;
                        $outTrip->km_served = 0.00;
                        $outTrip->bus_deployed = 0;
                        $outTripArr[] = $outTrip;
                        $allTrips = array_merge($allTrips, $outTripArr);

                        $inTrip = new \stdClass;
                        $inTrip->id = $allRoute->id;
                        $inTrip->trip_code = 1;
                        $inTrip->route_number = $allRoute->route_number;
                        $inTrip->route_name = implode(" - ", array_reverse(explode("-", $allRoute->route_name)));
                        $inTrip->farebox = 0.00;
                        $inTrip->ridership = 0;
                        $inTrip->average_pax = 0;
                        $inTrip->trip_served = 0;
                        $inTrip->km_served = 0.00;
                        $inTrip->bus_deployed = 0;

                        $inTripArr[] = $inTrip;
                        $allTrips = array_merge($allTrips, $inTripArr);
                    }else{
                        $out->writeln("In tripPerRoute > 0");
                        $outExist = false;
                        $inExist = false;
                        foreach($tripPerRoute as $loop => $trip){
                            if($trip->trip_code==0){
                                $outExist = true;
                            }
                            if($trip->trip_code==1){
                                $inExist = true;
                            }
                        }

                        if($outExist==false && $inExist==true){
                            $outTrip = new \stdClass;
                            $outTrip->id = $allRoute->id;
                            $outTrip->trip_code = 0;
                            $outTrip->route_number = $allRoute->route_number;
                            $outTrip->route_name = $allRoute->route_name;
                            $outTrip->farebox = 0.00;
                            $outTrip->ridership = 0;
                            $outTrip->average_pax = 0;
                            $outTrip->trip_served = 0;
                            $outTrip->km_served = 0.00;
                            $outTrip->bus_deployed = 0;
                            $outTripArr[] = $outTrip;
                            $allTrips = array_merge($allTrips, $outTripArr);
                            $allTrips = array_merge($allTrips, $tripPerRoute);
                        }
                        elseif($outExist==true && $inExist==false){
                            $allTrips = array_merge($allTrips, $tripPerRoute);

                            $inTrip = new \stdClass;
                            $inTrip->id = $allRoute->id;
                            $inTrip->trip_code = 1;
                            $inTrip->route_number = $allRoute->route_number;
                            $inTrip->route_name = implode(" - ", array_reverse(explode("-", $allRoute->route_name)));
                            $inTrip->farebox = 0.00;
                            $inTrip->ridership = 0;
                            $inTrip->average_pax = 0;
                            $inTrip->trip_served = 0;
                            $inTrip->km_served = 0.00;
                            $inTrip->bus_deployed = 0;

                            $inTripArr[] = $inTrip;
                            $allTrips = array_merge($allTrips, $inTripArr);
                        }else{
                            $allTrips = array_merge($allTrips, $tripPerRoute);
                        }
                    }

                    $prevTrips = DB::select("SELECT trip_details.trip_code, route.route_number, 
                    SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                    SUM(total_adult) + SUM(total_concession) AS ridership
                    FROM mybas.trip_details
                    JOIN mybas.route ON route.id = trip_details.route_id
                    WHERE trip_details.start_trip BETWEEN '" . $previousStartMonth . "' AND '" . $previousEndMonth . "'
                    AND route.status = 1
                    GROUP BY route.route_number, trip_details.trip_code
                    ORDER BY route.route_number, trip_details.trip_code;");

                    $plannedTrips = DB::select("SELECT route_scheduler_mstr.trip_code, route.route_number, 
                    count(route_scheduler_details.id) as trip_planned, 
                    count(route_scheduler_details.id) * route.distance as km_planned
                    FROM mybas.route
                    JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                    JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                    WHERE route_scheduler_details.schedule_date BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                    AND route.status = 1
                    GROUP BY route_number, route_scheduler_mstr.trip_code
                    ORDER BY route_number, route_scheduler_mstr.trip_code;");

                    $lastKey = array_key_last($allTrips);
                    $pastRoute = "";
                    $count = 0;
                    $countMissedTripPerRoute = 0;
                    $countMissedTripGrand = 0;
                    $earlyDepartCount = 0;
                    $lateDepartCount = 0;
                    $earlyEndCount = 0;
                    $lateEndCount = 0;
                    $prevRidership = 0;
                    $prevFarebox = 0.00;
                    $tripPlannedRoute = 0;
                    $kmPlannedRoute = 0;
                    $busUsedRoute = 0;
                    $earlyDepartGrand = 0;
                    $lateDepartGrand = 0;
                    $earlyEndGrand = 0;
                    $lateEndGrand = 0;
                    $prevRidershipGrand = 0;
                    $prevFareboxGrand = 0.00;
                    $tripPlannedGrand = 0;
                    $kmPlannedGrand = 0;
                    $busUsedGrand = 0;
                    foreach($allTrips as $key => $allTrip){
                        $out->writeln("New Loop: " . $key . " - " . $allTrip->route_number . " - " . $allTrip->trip_code . " ");
                        
                        //Total Per Route
                        if($allTrip->route_number != $pastRoute && $pastRoute != NULL){
                            $totPerRoute = DB::select("SELECT route.route_number, 
                            SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                            SUM(total_adult) + SUM(total_concession) AS ridership,
                            ROUND((case when ((SUM(total_adult) + SUM(total_concession)) = 0) THEN 0
                            ELSE (SUM(total_adult_amount) + SUM(total_concession_amount))/(SUM(total_adult) + SUM(total_concession)) END),2) as average_pax,
                            (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                            SUM(trip_details.total_mileage) as km_served
                            FROM mybas.trip_details
                            JOIN mybas.route ON route.id = trip_details.route_id
                            WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND route.status = 1
                            AND route.route_number = '" . $pastRoute . "'
                            GROUP BY route.route_number
                            ORDER BY route.route_number;");

                            $noTripArr = [];
                            if(!$totPerRoute){
                                $out->writeln("In totPerRoute < 0");
                                $noTrip = new \stdClass;
                                $noTrip->route_number = $pastRoute;
                                $noTrip->farebox = 0.00;
                                $noTrip->ridership = 0;
                                $noTrip->average_pax = 0;
                                $noTrip->trip_served = 0;
                                $noTrip->km_served = 0.00;
                                $noTrip->bus_deployed = 0;
                                $noTrip->ridership_prev = $prevRidership;
                                $noTrip->ridership_increase = 0;
                                $noTrip->farebox_prev = $prevFarebox;
                                $noTrip->farebox_increase = 0;
                                $noTrip->trip_planned = $tripPlannedRoute;
                                $noTrip->km_planned = $kmPlannedRoute;
                                $noTrip->missed_trip = $countMissedTripPerRoute;
                                $noTrip->early_depart = $earlyDepartCount;
                                $noTrip->late_depart = $lateDepartCount;
                                $noTrip->early_end = $earlyEndCount;
                                $noTrip->late_end = $lateEndCount;
                                $noTrip->bus_deployed = $busUsedRoute;
                                $noTrip->breakdown = 0;
                                $noTrip->accident = 0;
                                $noTrip->complaint = 0;

                                $noTripArr[] = $noTrip;
                                if($count==0){
                                    array_splice($allTrips, $key, 0, $noTripArr);
                                }else{
                                    $newKey = $key + $count;
                                    array_splice($allTrips, $newKey, 0, $noTripArr);
                                }
                            }else{
                                $out->writeln("In totPerRoute > 0");
                                foreach($totPerRoute as $keyRoute => $perRoute){
                                    $perRoute->ridership_prev = $prevRidership;
                                    if($perRoute->ridership_prev==0){
                                        if($perRoute->ridership==0){
                                            $perRoute->ridership_increase = 0;
                                        }else{
                                            $perRoute->ridership_increase = 100;
                                        }
                                    }else{
                                        $calcRidershipIn = (($perRoute->ridership -  $perRoute->ridership_prev) /  $perRoute->ridership_prev) * 100;
                                        $perRoute->ridership_increase = number_format((float)$calcRidershipIn, 2, '.', '');
                                    }
                                    
                                    $perRoute->farebox_prev = $prevFarebox;
                                    if($perRoute->farebox_prev==0){
                                        if($perRoute->farebox==0){
                                            $perRoute->farebox_increase = 0;
                                        }else{
                                            $perRoute->farebox_increase = 100;
                                        }
                                    }else{
                                        $calcFareboxIn = (($perRoute->farebox -  $perRoute->farebox_prev) /  $perRoute->farebox_prev) * 100;
                                        $perRoute->farebox_increase = number_format((float)$calcFareboxIn, 2, '.', '');
                                    }

                                    $perRoute->trip_planned = $tripPlannedRoute;
                                    $perRoute->km_planned = $kmPlannedRoute;
                                    $perRoute->missed_trip = $countMissedTripPerRoute;
                                    $perRoute->early_depart = $earlyDepartCount;
                                    $perRoute->late_depart = $lateDepartCount;
                                    $perRoute->early_end = $earlyEndCount;
                                    $perRoute->late_end = $lateEndCount;
                                    $perRoute->bus_deployed = $busUsedRoute;
                                    $perRoute->breakdown = 0;
                                    $perRoute->accident = 0;
                                    $perRoute->complaint = 0;
                                }
    
                                if($count==0){
                                    array_splice($allTrips, $key, 0, $totPerRoute);
                                }else{
                                    $newKey = $key + $count;
                                    array_splice($allTrips, $newKey, 0, $totPerRoute);
                                }
                            }
                            $count++;
                            $prevRidership=0;
                            $prevFarebox=0;
                            $tripPlannedRoute=0;
                            $kmPlannedRoute=0;
                            $countMissedTripPerRoute=0;
                            $earlyDepartCount = 0;
                            $lateDepartCount = 0;
                            $earlyEndCount = 0;
                            $lateEndCount = 0;
                            $busUsedRoute = 0;
                        }

                        $busUsedRoute += $allTrip->bus_deployed;
                        $busUsedGrand += $allTrip->bus_deployed;

                        //Previous month
                        $foundPrev = false;
                        foreach($prevTrips as $key1 => $prevTrip){
                            if($prevTrip->trip_code == $allTrip->trip_code && $prevTrip->route_number == $allTrip->route_number){
                                $prevRidership += $prevTrip->ridership;
                                $prevFarebox += $prevTrip->farebox;
                                $prevRidershipGrand += $prevTrip->ridership;
                                $prevFareboxGrand += $prevTrip->farebox;

                                $allTrip->ridership_prev = $prevTrip->ridership;
                                //Increment ridership collection (%)
                                if($prevTrip->ridership==0){
                                    if($allTrip->ridership==0){
                                        $allTrip->ridership_increase = 0;
                                    }else{
                                        $allTrip->ridership_increase = 100;
                                    }
                                }else{
                                    $increaseRidership = (($allTrip->ridership -  $allTrip->ridership_prev) /  $allTrip->ridership_prev) * 100;
                                    $allTrip->ridership_increase = number_format((float)$increaseRidership, 2, '.', '');
                                }
                
                                $allTrip->farebox_prev = $prevTrip->farebox;
                                //Incremeant farebox collection (%)
                                if($prevTrip->farebox==0){
                                    if($allTrip->farebox==0){
                                        $allTrip->farebox_increase = 0;
                                    }else{
                                        $allTrip->farebox_increase = 100;
                                    }
                                }else{
                                    $increaseFarebox = (($allTrip->farebox - $allTrip->farebox_prev) / $allTrip->farebox_prev) * 100;
                                    $allTrip->farebox_increase = number_format((float)$increaseFarebox, 2, '.', '');
                                }
                                
                                $foundPrev = true;
                                break ;
                            }
                        }if(!$foundPrev){
                            $allTrip->ridership_prev = 0;
                            if($allTrip->ridership==0){
                                $allTrip->ridership_increase = 0;
                            }else{
                                $allTrip->ridership_increase = 100;
                            }

                            $allTrip->farebox_prev = 0.00;
                            if($allTrip->farebox==0){
                                $allTrip->farebox_increase = 0;
                            }else{
                                $allTrip->farebox_increase = 100;
                            }
                        }

                        //Planned Trip
                        $foundPlanned = false;
                        foreach($plannedTrips as $key2 => $plannedTrip){
                            if($plannedTrip->trip_code == $allTrip->trip_code && $plannedTrip->route_number == $allTrip->route_number){
                                $tripPlannedRoute += $plannedTrip->trip_planned;
                                $kmPlannedRoute += $plannedTrip->km_planned;
                                $tripPlannedGrand += $plannedTrip->trip_planned;
                                $kmPlannedGrand += $plannedTrip->km_planned;

                                $allTrip->trip_planned = $plannedTrip->trip_planned;
                                $allTrip->km_planned = $plannedTrip->km_planned;

                                //Total Missed Trip
                                $diff= $allTrip->trip_planned - $allTrip->trip_served;
                                if($diff>0){
                                    $allTrip->missed_trip = $diff;
                                    $countMissedTripPerRoute += $diff;
                                    $countMissedTripGrand += $diff;
                                }else{
                                    $allTrip->missed_trip = 0;
                                }

                                $foundPlanned = true;
                                break;
                            }
                        }if(!$foundPlanned){
                            $allTrip->trip_planned = 0;
                            $allTrip->km_planned = 0.00;
                            $allTrip->missed_trip = 0;
                        }

                        //Early Depart
                        $earlyDeparts = DB::select("SELECT count(trip_details.id) as countEarlyLate
                        FROM trip_details
                        WHERE trip_details.id IN ( 
                        SELECT trip_details.id
                        FROM mybas.trip_details
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.id = trip_details.route_schedule_mstr_id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND trip_details.route_id =  " . $allTrip->id . "
                        AND route_scheduler_mstr.trip_code = " . $allTrip->trip_code . "
                        AND TIMEDIFF(route_scheduler_mstr.schedule_start_time, cast(trip_details.start_trip as TIME)) > '00:05:00'
                        GROUP BY trip_details.id);");

                        foreach($earlyDeparts as $key3 => $earlyDepart){
                            $allTrip->early_depart = $earlyDepart->countEarlyLate;
                            $earlyDepartCount += $earlyDepart->countEarlyLate;
                            $earlyDepartGrand += $earlyDepart->countEarlyLate;
                        }

                        //Late Depart
                        $lateDeparts = DB::select("SELECT count(trip_details.id) as countEarlyLate
                        FROM trip_details
                        WHERE trip_details.id IN ( 
                        SELECT trip_details.id
                        FROM mybas.trip_details
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.id = trip_details.route_schedule_mstr_id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND trip_details.route_id = " . $allTrip->id . "
                        AND route_scheduler_mstr.trip_code = " . $allTrip->trip_code . "
                        AND TIMEDIFF(route_scheduler_mstr.schedule_start_time, cast(trip_details.start_trip as TIME)) < '-00:05:00'
                        GROUP BY trip_details.id);");

                        foreach($lateDeparts as $key4 => $lateDepart){
                            $allTrip->late_depart = $lateDepart->countEarlyLate;
                            $lateDepartCount += $lateDepart->countEarlyLate;
                            $lateDepartGrand += $lateDepart->countEarlyLate;
                        }

                        //Early End
                        $earlyEnds = DB::select("SELECT count(trip_details.id) as countEarlyLate
                        FROM trip_details
                        WHERE trip_details.id IN ( 
                        SELECT trip_details.id
                        FROM mybas.trip_details
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.id = trip_details.route_schedule_mstr_id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND trip_details.route_id = " . $allTrip->id . "
                        AND route_scheduler_mstr.trip_code = " . $allTrip->trip_code . "
                        AND TIMEDIFF(route_scheduler_mstr.schedule_end_time, cast(trip_details.end_trip as TIME)) > '00:05:00'
                        GROUP BY trip_details.id);");

                        foreach($earlyEnds as $key5 => $earlyEnd){
                            $allTrip->early_end = $earlyEnd->countEarlyLate;
                            $earlyEndCount += $earlyEnd->countEarlyLate;
                            $earlyEndGrand += $earlyEnd->countEarlyLate;
                        }

                        //Late End
                        $lateEnds = DB::select("SELECT count(trip_details.id) as countEarlyLate
                        FROM trip_details
                        WHERE trip_details.id IN ( 
                        SELECT trip_details.id
                        FROM mybas.trip_details
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.id = trip_details.route_schedule_mstr_id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND trip_details.route_id = " . $allTrip->id . "
                        AND route_scheduler_mstr.trip_code = " . $allTrip->trip_code . "
                        AND TIMEDIFF(route_scheduler_mstr.schedule_end_time, cast(trip_details.end_trip as TIME)) < '-00:05:00'
                        GROUP BY trip_details.id);");

                        foreach($lateEnds as $key6 => $lateEnd){
                            $allTrip->late_end = $lateEnd->countEarlyLate;
                            $lateEndCount += $lateEnd->countEarlyLate;
                            $lateEndGrand += $lateEnd->countEarlyLate;
                        }

                        $allTrip->breakdown = 0;
                        $allTrip->accident = 0;
                        $allTrip->complaint = 0;

                        $pastRoute = $allTrip->route_number;

                        if($lastKey==$key){
                            $totGrands = DB::select("SELECT 
                            SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                            SUM(total_adult) + SUM(total_concession) AS ridership,
                            ROUND((case when ((SUM(total_adult) + SUM(total_concession)) = 0) THEN 0
                            ELSE (SUM(total_adult_amount) + SUM(total_concession_amount))/(SUM(total_adult) + SUM(total_concession)) END),2) as average_pax,
                            (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                            SUM(trip_details.total_mileage) as km_served
                            FROM mybas.trip_details
                            JOIN mybas.route ON route.id = trip_details.route_id
                            WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND route.status = 1
                            AND route.route_number = '" . $pastRoute . "'
                            GROUP BY route.route_number
                            ORDER BY route.route_number;");

                            $noTripArr = [];
                            if(!$totGrands){
                                $out->writeln("In totPerRoute < 0");
                                $noTrip = new \stdClass;
                                $noTrip->farebox = 0.00;
                                $noTrip->ridership = 0;
                                $noTrip->average_pax = 0;
                                $noTrip->trip_served = 0;
                                $noTrip->km_served = 0.00;
                                $noTrip->bus_deployed = 0;
                                $noTrip->ridership_prev = $prevRidershipGrand;
                                $noTrip->ridership_increase = 0;
                                $noTrip->farebox_prev = $prevFareboxGrand;
                                $noTrip->farebox_increase = 0;
                                $noTrip->trip_planned = $tripPlannedGrand;
                                $noTrip->km_planned = $kmPlannedGrand;
                                $noTrip->missed_trip = $countMissedTripGrand;
                                $noTrip->early_depart = $earlyDepartGrand;
                                $noTrip->late_depart = $lateDepartGrand;
                                $noTrip->early_end = $earlyEndGrand;
                                $noTrip->late_end = $lateEndGrand;
                                $noTrip->breakdown = 0;
                                $noTrip->accident = 0;
                                $noTrip->complaint = 0;

                                $noTripArr[] = $noTrip;
                                $newKey = $key + $count+1;
                                array_splice($allTrips, $newKey, 0, $noTripArr);
                            }else{
                                foreach($totGrands as $keyGrand => $grand){
                                    $grand->ridership_prev = $prevRidershipGrand;
                                    if($grand->ridership_prev==0){
                                        if($grand->ridership==0){
                                            $grand->ridership_increase = 0;
                                        }else{
                                            $grand->ridership_increase = 100;
                                        }
                                    }else{
                                        $calcRidershipIn = (($grand->ridership -  $grand->ridership_prev) /  $grand->ridership_prev) * 100;
                                        $grand->ridership_increase = number_format((float)$calcRidershipIn, 2, '.', '');
                                    }

                                    $grand->farebox_prev = $prevFareboxGrand;
                                    if($grand->farebox_prev==0){
                                        if($grand->farebox==0){
                                            $grand->farebox_increase = 0;
                                        }else{
                                            $grand->farebox_increase = 100;
                                        }
                                    }else{
                                        $calcFareboxIn = (($grand->farebox -  $grand->farebox_prev) /  $grand->farebox_prev) * 100;
                                        $grand->farebox_increase = number_format((float)$calcFareboxIn, 2, '.', '');
                                    }

                                    $grand->trip_planned = $tripPlannedGrand;
                                    $grand->km_planned = $kmPlannedGrand;
                                    $grand->missed_trip = $countMissedTripGrand;
                                    $grand->early_depart = $earlyDepartGrand;
                                    $grand->late_depart = $lateDepartGrand;
                                    $grand->early_end = $earlyEndGrand;
                                    $grand->late_end = $lateEndGrand;
                                    $grand->bus_deployed = $busUsedGrand;
                                    $grand->breakdown = 0;
                                    $grand->accident = 0;
                                    $grand->complaint = 0;
                                }

                                $newKey = $key + $count +1;
                                array_splice($allTrips, $newKey, 0, $totGrands);
                            }

                            $totPerRoute = DB::select("SELECT route.route_number, 
                            SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                            SUM(total_adult) + SUM(total_concession) AS ridership,
                            ROUND((case when ((SUM(total_adult) + SUM(total_concession)) = 0) THEN 0
                            ELSE (SUM(total_adult_amount) + SUM(total_concession_amount))/(SUM(total_adult) + SUM(total_concession)) END),2) as average_pax,
                            (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                            SUM(trip_details.total_mileage) as km_served
                            FROM mybas.trip_details
                            JOIN mybas.route ON route.id = trip_details.route_id
                            WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND route.status = 1
                            AND route.route_number = '" . $pastRoute . "'
                            GROUP BY route.route_number
                            ORDER BY route.route_number;");

                            $noTripArr = [];
                            if(!$totPerRoute){
                                $out->writeln("In totPerRoute < 0");
                                $noTrip = new \stdClass;
                                $noTrip->route_number = $pastRoute;
                                $noTrip->farebox = 0.00;
                                $noTrip->ridership = 0;
                                $noTrip->average_pax = 0;
                                $noTrip->trip_served = 0;
                                $noTrip->km_served = 0.00;
                                $noTrip->bus_deployed = 0;
                                $noTrip->ridership_prev = $prevRidership;
                                $noTrip->ridership_increase = 0;
                                $noTrip->farebox_prev = $prevFarebox;
                                $noTrip->farebox_increase = 0;
                                $noTrip->trip_planned = $tripPlannedRoute;
                                $noTrip->km_planned = $kmPlannedRoute;
                                $noTrip->missed_trip = $countMissedTripPerRoute;
                                $noTrip->early_depart = $earlyDepartCount;
                                $noTrip->late_depart = $lateDepartCount;
                                $noTrip->early_end = $earlyEndCount;
                                $noTrip->late_end = $lateEndCount;
                                $noTrip->breakdown = 0;
                                $noTrip->accident = 0;
                                $noTrip->complaint = 0;

                                $noTripArr[] = $noTrip;
                                $newKey = $key + $count+1;
                                array_splice($allTrips, $newKey, 0, $noTripArr);
                            }else{
                                $out->writeln("In totPerRoute > 0");
                                foreach($totPerRoute as $keyRoute => $perRoute){
                                    $perRoute->ridership_prev = $prevRidership;
                                    if($perRoute->ridership_prev==0){
                                        if($perRoute->ridership==0){
                                            $perRoute->ridership_increase = 0;
                                        }else{
                                            $perRoute->ridership_increase = 100;
                                        }
                                    }else{
                                        $calcRidershipIn = (($perRoute->ridership -  $perRoute->ridership_prev) /  $perRoute->ridership_prev) * 100;
                                        $perRoute->ridership_increase = number_format((float)$calcRidershipIn, 2, '.', '');
                                    }
                                    
                                    $perRoute->farebox_prev = $prevFarebox;
                                    if($perRoute->farebox_prev==0){
                                        if($perRoute->farebox==0){
                                            $perRoute->farebox_increase = 0;
                                        }else{
                                            $perRoute->farebox_increase = 100;
                                        }
                                    }else{
                                        $calcFareboxIn = (($perRoute->farebox -  $perRoute->farebox_prev) /  $perRoute->farebox_prev) * 100;
                                        $perRoute->farebox_increase = number_format((float)$calcFareboxIn, 2, '.', '');
                                    }
    
                                    $perRoute->trip_planned = $tripPlannedRoute;
                                    $perRoute->km_planned = $kmPlannedRoute;
                                    $perRoute->missed_trip = $countMissedTripPerRoute;
                                    $perRoute->early_depart = $earlyDepartCount;
                                    $perRoute->late_depart = $lateDepartCount;
                                    $perRoute->early_end = $earlyEndCount;
                                    $perRoute->late_end = $lateEndCount;
                                    $perRoute->bus_deployed = $busUsedRoute;
                                    $perRoute->breakdown = 0;
                                    $perRoute->accident = 0;
                                    $perRoute->complaint = 0;
                                }
    
                                $newKey = $key + $count+1;
                                array_splice($allTrips, $newKey, 0, $totPerRoute);
                            }
                        }

                    }

                }
            }
            return Excel::download(new SPADSummary($allTrips, $validatedData['dateFrom'], $validatedData['dateTo'], $networkArea), 'Summary_Report_SPAD_'.Carbon::now()->format('YmdHis').'.xlsx');
        }else{
            $this->dispatchBrowserEvent('company-required');
        }
    }

    public function printSummaryOld()
    {
        $out = new ConsoleOutput();
        $out->writeln("YOU ARE IN printSummary()");

        $validatedData = Validator::make($this->state,[
            'dateFrom' => ['required', 'date'],
            'dateTo' => ['required', 'date'],
            'route_id' => ['required'],
        ])->validate();

        $dateFrom = new Carbon($validatedData['dateFrom']);
        $dateTo = new Carbon($validatedData['dateTo'] . '23:59:59');

        $prevStart = Carbon::create($validatedData['dateFrom'])->startOfMonth()->subMonthsNoOverflow()->toDateString();
        $prevEnd = Carbon::create($validatedData['dateTo'])->subMonthsNoOverflow()->endOfMonth()->toDateString();

        $previousStartMonth = new Carbon($prevStart);
        $previousEndMonth = new Carbon($prevEnd . '23:59:59');

        $startDate = new Carbon($validatedData['dateFrom']);
        $endDate = new Carbon($validatedData['dateTo']);
        $all_dates = array();

        while ($startDate->lte($endDate)){
            $all_dates[] = $startDate->toDateString();
            $startDate->addDay();
        }

        $existInTrip = false;
        $existOutTrip = false;
        $summary = collect();
        $grandRidership = 0;
        $grandPrevRidership = 0;
        $grandIncreaseRidership = 0;
        $grandFarebox = 0;
        $grandPrevFarebox = 0;
        $grandIncreaseFarebox = 0;
        $grandAverageFare = 0;
        $grandTripPlanned = 0;
        $grandTripMade = 0;
        $grandTripMissed = 0;
        $grandKMPlanned = 0;
        $grandKMServed = 0;
        $grandKMGPS = 0;
        $grandEarlyDeparture = 0;
        $grandLateDeparture = 0;
        $grandEarlyEnd = 0;
        $grandLateEnd = 0;
        $grandBreakdown = 0;
        $grandBusUsed = 0;
        $grandAccident = 0;
        $grandComplaint = 0;
        if($this->selectedCompany){
            if($this->selectedCompany=='All'){
                $networkArea = 'All';
                if(!empty($validatedData['route_id'])) {
                     //Summary all routes for all company
                    if($validatedData['route_id']=='All'){
                        $allRoutes = Route::orderBy('route_number')->get();
                        //$allRoutes = Route::with('trip')->orderBy('route_number')->get();
                        //dd($allRoutes);
                        foreach($allRoutes as $allRoute) {
                            $existInTrip = false;
                            $existOutTrip = false;
                            $totalFareboxIn = 0;
                            $totalRidershipIn = 0;
                            $totalKMPlannedIn = 0;
                            $totalKMServedIn = 0;
                            $totalKMGPSIn = 0;
                            $earlyDepartureIn = 0;
                            $lateDepartureIn = 0;
                            $earlyEndIn = 0;
                            $lateEndIn = 0;
                            $totalTripIn = 0;
                            $inbound = [];
            
                            //Inbound
                            $allTripInbounds = TripDetail::where('route_id', $allRoute->id)
                                ->whereBetween('start_trip', [$dateFrom, $dateTo])
                                ->where('trip_code', 1)
                                ->get();
            
                            if (count($allTripInbounds)>0) {
                                foreach ($allTripInbounds as $allTripInbound) {
                                    $existInTrip = true;
            
                                    //Ridership
                                    $ridership = $allTripInbound->total_adult + $allTripInbound->total_concession;
                                    //Check tickets Ridership
                                    if($ridership==0){
                                        $ridership = TicketSalesTransaction::where('trip_id', $allTripInbound->id)->count();
                                    }
                                    $totalRidershipIn += $ridership;
            
                                    //Farebox Collection
                                    $farebox = $allTripInbound->total_adult_amount + $allTripInbound->total_concession_amount;
                                    //Check tickets Farebox
                                    if($farebox==0){
                                        $allTicketPerTrips = TicketSalesTransaction::where('trip_id', $allTripInbound->id)->get();
                                        if(count($allTicketPerTrips)>0){
                                            foreach($allTicketPerTrips as $allTicketPerTrip){
                                                $farebox += $allTicketPerTrip->actual_amount;
                                            }
                                        }
                                    }
                                    $totalFareboxIn += $farebox;
            
                                    //Total KM Service Served
                                    $kmServed = $allTripInbound->Route->inbound_distance;
                                    $totalKMServedIn += $kmServed;
            
                                    //Total KM Service Served by GPS
                                    $kmGPS = $allTripInbound->total_mileage;
                                    $totalKMGPSIn += $kmGPS;
            
                                    if ($allTripInbound->route_schedule_mstr_id != NULL) {
                                        //Total Early Departure
                                        $diffDepart = strtotime($allTripInbound->routeScheduleMSTR->schedule_start_time) - strtotime($allTripInbound->start_trip);
                                        if ($diffDepart > 5) {
                                            $earlyDepartureIn++;
                                        }elseif($diffDepart < -5){
                                            $lateDepartureIn++;
                                        }
                                        //Total Early End
                                        $diffEnd = strtotime($allTripInbound->routeScheduleMSTR->schedule_end_time) - strtotime($allTripInbound->end_trip);
                                        if ($diffEnd > 5) {
                                            $earlyEndIn++;
                                        }elseif($diffEnd < -5){
                                            $lateEndIn++;
                                        }
                                    }
                                    $totalTripIn++;
                                }
                            }
                            $prevRidershipIn = 0;
                            $prevFareboxIn = 0;
            
                            //Previous Month Inbound Trip
                            $prevTripInbounds = TripDetail::where('route_id', $allRoute->id)
                            ->whereBetween('start_trip', [$previousStartMonth, $previousEndMonth])
                            ->where('trip_code', 1)
                            ->get();
            
                            if(count($prevTripInbounds)>0){
                                foreach($prevTripInbounds as $prevTripInbound){
                                    //Previous Month Inbound Ridership collection
                                    $prevRidership = $prevTripInbound->total_adult + $prevTripInbound->total_concession;
                                    //Check tickets Ridership
                                    if($prevRidership==0){
                                        $prevRidership = TicketSalesTransaction::where('trip_id', $prevTripInbound->id)->count();
                                    }
                                    $prevRidershipIn += $prevRidership;
            
                                    //Previous Month Inbound Farebox collection
                                    $prevFarebox = $prevTripInbound->total_adult_amount + $prevTripInbound->total_concession_amount;
                                    //Check tickets Farebox
                                    if($prevFarebox==0){
                                        $allTicketPerTrips = TicketSalesTransaction::where('trip_id', $prevTripInbound->id)->get();
                                        if(count($allTicketPerTrips)>0){
                                            foreach($allTicketPerTrips as $allTicketPerTrip){
                                                $prevFarebox += $allTicketPerTrip->actual_amount;
                                            }
                                        }
                                    }
                                    $prevFareboxIn += $prevFarebox;
                                }
                            }
                            //Increment ridership collection (%)
                            if($prevRidershipIn==0){
                                $increaseRidershipIn = 100;
                                $increaseRidershipFormatIn = 100;
                            }else{
                                if($totalRidershipIn==0){
                                    $increaseRidershipIn = -100;
                                    $increaseRidershipFormatIn = -100;
                                }else{
                                    $increaseRidershipIn = (($totalRidershipIn - $prevRidershipIn) / $prevRidershipIn) * 100;
                                    $increaseRidershipFormatIn = number_format((float)$increaseRidershipIn, 2, '.', '');
                                }
                            }
            
                            //Incremeant farebox collection (%)
                            if($prevFareboxIn==0){
                                $increaseFareboxIn = 100;
                                $increaseFareboxFormatIn = 100;
                            }else{
                                if($totalFareboxIn==0){
                                    $increaseFareboxIn  = -100;
                                    $increaseFareboxFormatIn  = -100;
                                }else{
                                    $increaseFareboxIn = (($totalFareboxIn - $prevFareboxIn) / $prevFareboxIn) * 100;
                                    $increaseFareboxFormatIn = number_format((float)$increaseFareboxIn, 2, '.', '');
                                }
                            }
            
                            //Average Fare per pax (RM)
                            if($totalRidershipIn==0) {
                                $averageIn = 0;
                                $averageFormatIn = 0;
                            }
                            else{
                                $averageIn = $totalFareboxIn / $totalRidershipIn;
                                $averageFormatIn = number_format((float)$averageIn, 2, '.', '');
                            }
            
                            $countScheduleIn = 0;
                            $schedules = RouteSchedulerDetail::whereBetween('schedule_date', [$dateFrom, $dateTo])->get();
                            if(count($schedules))
                            foreach($schedules as $schedule){
                                if($schedule->RouteScheduleMSTR->route_id == $allRoute->id){
                                    if($schedule->RouteScheduleMSTR->trip_code == 1){
                                        $countScheduleIn++;
                                    }
                                }
                            }
                            //Total KM Service Planned
                            $totalKMPlannedIn = $countScheduleIn * $allRoute->inbound_distance;
            
                            //Number of Trips missed
                            $tripMissedIn = $countScheduleIn - $totalTripIn;
                            if($tripMissedIn<0){
                                $tripMissedIn=0;
                            }
            
                            /**Total Breakdown During Operation*/
                            $breakdownIn = 0;
            
                            //Total Bus In Used
                            $busUsedIn = TripDetail::where('route_id', $allRoute->id)
                                ->whereBetween('start_trip', [$dateFrom, $dateTo])
                                ->where('trip_code', 1)
                                ->distinct('bus_id')
                                ->count();
            
                            /**Total Accidents caused by Operator*/
                            $accidentIn = 0;
            
                            /**Total Complaint*/
                            $complaintsIn = 0;
            
                            $inbound['ridership_in'] = $totalRidershipIn;
                            $inbound['prev_ridership_in'] = $prevRidershipIn;
                            $inbound['increase_ridership_in'] = $increaseRidershipFormatIn;
                            $inbound['farebox_in'] = $totalFareboxIn;
                            $inbound['prev_farebox_in'] = $prevFareboxIn;
                            $inbound['increase_farebox_in'] = $increaseFareboxFormatIn;
                            $inbound['average_fare_in'] = $averageFormatIn;
                            $inbound['trip_planned_in'] = $countScheduleIn;
                            $inbound['trip_made_in'] = $totalTripIn;
                            $inbound['trip_missed_in'] = $tripMissedIn;
                            $inbound['km_planned_in'] = $totalKMPlannedIn;
                            $inbound['km_served_in'] = $totalKMServedIn;
                            $inbound['km_served_gps_in'] = $totalKMGPSIn;
                            $inbound['early_departure_in'] = $earlyDepartureIn;
                            $inbound['late_departure_in'] = $lateDepartureIn;
                            $inbound['early_end_in'] = $earlyEndIn;
                            $inbound['late_end_in'] = $lateEndIn;
                            $inbound['breakdown_in'] = $breakdownIn;
                            $inbound['bus_used_in'] = $busUsedIn;
                            $inbound['accidents_in'] = $accidentIn;
                            $inbound['complaints_in'] = $complaintsIn;
            
                            $totalFareboxOut = 0;
                            $totalRidershipOut = 0;
                            $totalKMPlannedOut = 0;
                            $totalKMServedOut = 0;
                            $totalKMGPSOut = 0;
                            $earlyDepartureOut = 0;
                            $lateDepartureOut = 0;
                            $earlyEndOut = 0;
                            $lateEndOut = 0;
                            $totalTripOut = 0;
                            $outbound = [];
            
                            //Outbound
                            $allTripOutbounds = TripDetail::where('route_id',$allRoute->id)
                                ->whereBetween('start_trip', [$dateFrom, $dateTo])
                                ->where('trip_code', 0)
                                ->get();
            
                            if (count($allTripOutbounds) > 0) {
                                foreach ($allTripOutbounds as $allTripOutbound) {
                                    $existOutTrip = true;
            
                                    //Ridership
                                    $ridership = $allTripOutbound->total_adult + $allTripOutbound->total_concession;
                                    //Check tickets Ridership
                                    if($ridership==0){
                                        $ridership = TicketSalesTransaction::where('trip_id', $allTripOutbound->id)->count();
                                    }
                                    $totalRidershipOut += $ridership;
            
                                    //Farebox Collection
                                    $farebox = $allTripOutbound->total_adult_amount + $allTripOutbound->total_concession_amount;
                                    //Check tickets Farebox
                                    if($farebox==0){
                                        $allTicketPerTrips = TicketSalesTransaction::where('trip_id', $allTripOutbound->id)->get();
                                        if(count($allTicketPerTrips)>0){
                                            foreach($allTicketPerTrips as $allTicketPerTrip){
                                                $farebox += $allTicketPerTrip->actual_amount;
                                            }
                                        }
                                    }
                                    $totalFareboxOut += $farebox;
            
                                    //Total KM Service Served
                                    $kmServed = $allTripOutbound->Route->outbound_distance;
                                    $totalKMServedOut += $kmServed;
            
                                    //Total KM Service Served by GPS
                                    $kmGPS = $allTripOutbound->total_mileage;
                                    $totalKMGPSOut += $kmGPS;
            
                                    if ($allTripOutbound->route_schedule_mstr_id != NULL) {
                                        //Total Early Departure
                                        $diffDepart = strtotime($allTripOutbound->routeScheduleMSTR->schedule_start_time) - strtotime($allTripOutbound->start_trip);
                                        if ($diffDepart > 5) {
                                            $earlyDepartureOut++;
                                        }elseif($diffDepart < -5){
                                            $lateDepartureOut++;
                                        }
                                        //Total Early End
                                        $diffEnd = strtotime($allTripOutbound->routeScheduleMSTR->schedule_end_time) - strtotime($allTripOutbound->end_trip);
                                        if ($diffEnd > 5) {
                                            $earlyEndOut++;
                                        }elseif($diffEnd < -5){
                                            $lateEndOut++;
                                        }
                                    }
                                    $totalTripOut++;
                                }
                            }
                            $prevRidershipOut = 0;
                            $prevFareboxOut = 0;
            
                            //Previous Month Outbound Trip
                            $prevTripOutbounds = TripDetail::where('route_id', $allRoute->id)
                            ->whereBetween('start_trip', [$previousStartMonth, $previousEndMonth])
                            ->where('trip_code', 0)
                            ->get();
            
                            if(count($prevTripOutbounds)>0){
                                foreach($prevTripOutbounds as $prevTripOutbound){
                                    //Previous Month Inbound Ridership collection
                                    $prevRidership = $prevTripOutbound->total_adult + $prevTripOutbound->total_concession;
                                    //Check tickets Ridership
                                    if($prevRidership==0){
                                        $prevRidership = TicketSalesTransaction::where('trip_id', $prevTripOutbound->id)->count();
                                    }
                                    $prevRidershipOut += $prevRidership;
            
                                    //Previous Month Inbound Farebox collection
                                    $prevFarebox = $prevTripOutbound->total_adult_amount + $prevTripOutbound->total_concession_amount;
                                    //Check tickets Farebox
                                    if($prevFarebox==0){
                                        $allTicketPerTrips = TicketSalesTransaction::where('trip_id', $prevTripOutbound->id)->get();
                                        if(count($allTicketPerTrips)>0){
                                            foreach($allTicketPerTrips as $allTicketPerTrip){
                                                $prevFarebox += $allTicketPerTrip->actual_amount;
                                            }
                                        }
                                    }
                                    $prevFareboxOut += $prevFarebox;
                                }
                            }
                            //Increment ridership collection (%)
                            if($prevRidershipOut==0){
                                $increaseRidershipOut = 100;
                                $increaseRidershipFormatOut = 100;
                            }else{
                                if($totalRidershipOut==0){
                                    $increaseRidershipOut = -100;
                                    $increaseRidershipFormatOut = -100;
                                }else{
                                    $increaseRidershipOut = (($totalRidershipOut - $prevRidershipOut) / $prevRidershipOut) * 100/100;
                                    $increaseRidershipFormatOut = number_format((float)$increaseRidershipOut, 2, '.', '');
                                }
                            }
                            //Increment farebox collection (%)
                            if($prevFareboxOut==0){
                                $increaseFareboxOut = 100;
                                $increaseFareboxFormatOut = 100;
                            }else{
                                if($totalRidershipOut==0){
                                    $increaseFareboxOut = -100;
                                    $increaseFareboxFormatOut = -100;
                                }else{
                                    $increaseFareboxOut = (($totalFareboxOut - $prevFareboxOut) / $prevFareboxOut) * 100;
                                    $increaseFareboxFormatOut = number_format((float)$increaseFareboxOut, 2, '.', '');
                                }
                            }
            
                            //Average Fare per pax (RM)
                            if($totalRidershipOut==0) {
                                $averageOut = 0;
                                $averageFormatOut = 0;
                            }
                            else{
                                $averageOut = $totalFareboxOut / $totalRidershipOut;
                                $averageFormatOut = number_format((float)$averageOut, 2, '.', '');
                            }
            
                            $countScheduleOut = 0;
                            $schedules = RouteSchedulerDetail::whereBetween('schedule_date', [$dateFrom, $dateTo])->get();
                            foreach($schedules as $schedule){
                                if($schedule->RouteScheduleMSTR->route_id == $allRoute->id){
                                    if($schedule->RouteScheduleMSTR->trip_code == 0){
                                        $countScheduleOut++;
                                    } 
                                }
                            }
                            //Total KM Service Planned
                            $totalKMPlannedOut = $countScheduleOut * $allRoute->outbound_distance;
            
                            //Number of Trips missed
                            $tripMissedOut = $countScheduleOut - $totalTripOut;
                            if($tripMissedOut<0) {
                                $tripMissedOut=0;
                            }
            
                            /**Total Breakdown During Operation*/
                            $breakdownOut = 0;
            
                            //Total Bus In Used
                            $busUsedOut = TripDetail::where('route_id', $allRoute->id)
                                ->whereBetween('start_trip', [$dateFrom, $dateTo])
                                ->where('trip_code', 0)
                                ->distinct('bus_id')
                                ->count();
            
                            /**Total Accidents caused by Operator*/
                            $accidentOut = 0;
            
                            /**Total Complaint*/
                            $complaintsOut = 0;
            
                            $outbound['ridership_out'] = $totalRidershipOut;
                            $outbound['prev_ridership_out'] = $prevRidershipOut;
                            $outbound['increase_ridership_out'] = $increaseRidershipFormatOut;
                            $outbound['farebox_out'] = $totalFareboxOut;
                            $outbound['prev_farebox_out'] = $prevFareboxOut;
                            $outbound['increase_farebox_out'] = $increaseFareboxFormatOut;
                            $outbound['average_fare_out'] = $averageFormatOut;
                            $outbound['trip_planned_out'] = $countScheduleOut;
                            $outbound['trip_made_out'] = $totalTripOut;
                            $outbound['trip_missed_out'] = $tripMissedOut;
                            $outbound['km_planned_out'] = $totalKMPlannedOut;
                            $outbound['km_served_out'] = $totalKMServedOut;
                            $outbound['km_served_gps_out'] = $totalKMGPSOut;
                            $outbound['early_departure_out'] = $earlyDepartureOut;
                            $outbound['late_departure_out'] = $lateDepartureOut;
                            $outbound['early_end_out'] = $earlyEndOut;
                            $outbound['late_end_out'] = $lateEndOut;
                            $outbound['breakdown_out'] = $breakdownOut;
                            $outbound['bus_used_out'] = $busUsedOut;
                            $outbound['accidents_out'] = $accidentOut;
                            $outbound['complaints_out'] = $complaintsOut;
            
                            $inbound_data=[];
                            $outbound_data=[];
                            $content = [];
                            $route_name_in = $allRoute->route_name;
                            $route_name_out = implode(" - ", array_reverse(explode("-", $route_name_in)));
                            if ($existInTrip == 1 && $existOutTrip == 1) {
                                $inbound_data[$route_name_in] = $inbound;
                                $outbound_data[$route_name_out] = $outbound;
            
                                $total['total_ridership'] = $totalRidershipOut + $totalRidershipIn;
                                $total['total_prev_ridership'] = $prevRidershipOut + $prevRidershipIn;
            
                                if($increaseRidershipIn==100 && $increaseRidershipOut==100){
                                    $sumIncreaseRidership = 100;
                                    $sumIncreaseRidershipFormat = 100;
                                }else{
                                    $sumIncreaseRidership = (($increaseRidershipIn + $increaseRidershipOut) / 200) * 100;
                                    $sumIncreaseRidershipFormat = number_format((float)$sumIncreaseRidership, 2, '.', '');
                                }
                                $total['total_increase_ridership'] = $sumIncreaseRidershipFormat;
            
                                $total['total_farebox'] = $totalFareboxOut + $totalFareboxIn;
                                $total['total_prev_farebox'] = $prevFareboxOut + $prevFareboxIn;
            
                                if($increaseFareboxIn==100 && $increaseFareboxOut==100){
                                    $sumIncreaseFarebox = 100;
                                    $sumIncreaseFareboxFormat = 100;
                                }else{
                                    $sumIncreaseFarebox = (($increaseFareboxIn + $increaseFareboxOut) / 200) * 100;
                                    $sumIncreaseFareboxFormat = number_format((float)$sumIncreaseFarebox, 2, '.', '');
                                }
                                $total['total_increase_farebox'] = $sumIncreaseFareboxFormat;
            
                                if($total['total_ridership']==0) {
                                    $sumAverageFormat = 0;
                                }
                                else{
                                    $sumAverage = $total['total_farebox'] / $total['total_ridership'];
                                    $sumAverageFormat = number_format((float)$sumAverage, 2, '.', '');
                                }
                                $total['total_average_fare'] = $sumAverageFormat;
            
                                $total['total_trip_planned'] = $countScheduleOut + $countScheduleIn;
                                $total['total_trip_made'] = $totalTripOut + $totalTripIn;
                                $total['total_trip_missed'] = $tripMissedOut + $tripMissedIn;
                                $total['total_km_planned'] = $totalKMPlannedOut + $totalKMPlannedIn;
                                $total['total_km_served'] = $totalKMServedOut + $totalKMServedIn;
                                $total['total_km_served_gps'] = $totalKMGPSOut + $totalKMGPSIn;
                                $total['total_early_departure'] = $earlyDepartureOut + $earlyDepartureIn;
                                $total['total_late_departure'] = $lateDepartureOut + $lateDepartureIn;
                                $total['total_early_end'] = $earlyEndOut + $earlyEndIn;
                                $total['total_late_end'] = $lateEndOut + $lateEndIn;
                                $total['total_breakdown'] = $breakdownOut + $breakdownIn;
                                $total['total_bus_used'] = $busUsedOut + $busUsedIn;
                                $total['total_accidents'] = $accidentOut + $accidentIn;
                                $total['total_complaints'] = $complaintsOut + $complaintsIn;
            
                                $content['inbound_data'] = $inbound_data;
                                $content['outbound_data'] = $outbound_data;
                                $content['total'] = $total;
                                $data[$allRoute->route_number] = $content;
            
                                $grandRidership += $total['total_ridership'];
                                $grandPrevRidership += $total['total_prev_ridership'];
                                $grandIncreaseRidership += $sumIncreaseRidership;
                                $grandFarebox += $total['total_farebox'];
                                $grandPrevFarebox += $total['total_prev_farebox'];
                                $grandIncreaseFarebox += $sumIncreaseFarebox;
                                $grandTripPlanned += $total['total_trip_planned'];
                                $grandTripMade += $total['total_trip_made'];
                                $grandTripMissed += $total['total_trip_missed'];
                                $grandKMPlanned += $total['total_km_planned'];
                                $grandKMServed += $total['total_km_served'];
                                $grandKMGPS += $total['total_km_served_gps'];
                                $grandEarlyDeparture += $total['total_early_departure'];
                                $grandLateDeparture += $total['total_late_departure'];
                                $grandEarlyEnd += $total['total_early_end'];
                                $grandLateEnd += $total['total_late_end'];
                                $grandBreakdown += $total['total_breakdown'];
                                $grandBusUsed += $total['total_bus_used'];
                                $grandAccident += $total['total_accidents'];
                                $grandComplaint += $total['total_complaints'];
            
                            } elseif ($existInTrip == 0 && $existOutTrip == 1) {
                                $inbound['ridership_in'] = 0;
                                $inbound['prev_ridership_in'] = 0;
                                $inbound['increase_ridership_in'] = 0;
                                $inbound['farebox_in'] = 0;
                                $inbound['prev_farebox_in'] = 0;
                                $inbound['increase_farebox_in'] = 0;
                                $inbound['average_fare_in'] = 0;
                                $inbound['trip_planned_in'] = 0;
                                $inbound['trip_made_in'] = 0;
                                $inbound['trip_missed_in'] = 0;
                                $inbound['km_planned_in'] = 0;
                                $inbound['km_served_in'] = 0;
                                $inbound['km_served_gps_in'] = 0;
                                $inbound['early_departure_in'] = 0;
                                $inbound['late_departure_in'] = 0;
                                $inbound['early_end_in'] = 0;
                                $inbound['late_end_in'] = 0;
                                $inbound['breakdown_in'] = 0;
                                $inbound['bus_used_in'] = 0;
                                $inbound['accidents_in'] = 0;
                                $inbound['complaints_in'] = 0;
            
                                $inbound_data[$route_name_in] = $inbound;
                                $outbound_data[$route_name_out] = $outbound;
            
                                $total['total_ridership'] = $totalRidershipOut;
                                $total['total_prev_ridership'] = $prevRidershipOut;
            
                                $totIncreaseRidership = ($increaseRidershipOut/ 200) * 100;
                                $totIncreaseRidershipFormat = number_format((float)$totIncreaseRidership, 2, '.', '');
                                $total['total_increase_ridership'] = $totIncreaseRidershipFormat;
            
                                $total['total_farebox'] = $totalFareboxOut;
                                $total['total_prev_farebox'] = $prevFareboxOut;
            
                                $totIncreaseFarebox = ($increaseFareboxOut/ 200) * 100;
                                $totIncreaseFareboxFormat = number_format((float)$totIncreaseFarebox, 2, '.', '');
                                $total['total_increase_farebox'] = $totIncreaseFareboxFormat;
            
                                $total['total_average_fare'] = $averageFormatOut;
                                $total['total_trip_planned'] = $countScheduleOut;
                                $total['total_trip_made'] = $totalTripOut;
                                $total['total_trip_missed'] = $tripMissedOut;
                                $total['total_km_planned'] = $totalKMPlannedOut;
                                $total['total_km_served'] = $totalKMServedOut;
                                $total['total_km_served_gps'] = $totalKMGPSOut;
                                $total['total_early_departure'] = $earlyDepartureOut;
                                $total['total_late_departure'] = $lateDepartureOut;
                                $total['total_early_end'] = $earlyEndOut;
                                $total['total_late_end'] = $lateEndOut;
                                $total['total_breakdown'] = $breakdownOut;
                                $total['total_bus_used'] = $busUsedOut;
                                $total['total_accidents'] = $accidentOut;
                                $total['total_complaints'] = $complaintsOut;
            
                                $content['inbound_data'] = $inbound_data;
                                $content['outbound_data'] = $outbound_data;
                                $content['total'] = $total;
                                $data[$allRoute->route_number] = $content;
            
                                $grandRidership += $total['total_ridership'];
                                $grandPrevRidership += $total['total_prev_ridership'];
                                $grandIncreaseRidership += $increaseRidershipOut;
                                $grandFarebox += $total['total_farebox'];
                                $grandPrevFarebox += $total['total_prev_farebox'];
                                $grandIncreaseFarebox += $increaseFareboxOut;
                                $grandTripPlanned += $total['total_trip_planned'];
                                $grandTripMade += $total['total_trip_made'];
                                $grandTripMissed += $total['total_trip_missed'];
                                $grandKMPlanned += $total['total_km_planned'];
                                $grandKMServed += $total['total_km_served'];
                                $grandKMGPS += $total['total_km_served_gps'];
                                $grandEarlyDeparture += $total['total_early_departure'];
                                $grandLateDeparture += $total['total_late_departure'];
                                $grandEarlyEnd += $total['total_early_end'];
                                $grandLateEnd += $total['total_late_end'];
                                $grandBreakdown += $total['total_breakdown'];
                                $grandBusUsed += $total['total_bus_used'];
                                $grandAccident += $total['total_accidents'];
                                $grandComplaint += $total['total_complaints'];
            
                            } elseif ($existInTrip == 1 && $existOutTrip == 0) {
                                $outbound['ridership_out'] = 0;
                                $outbound['prev_ridership_out'] = 0;
                                $outbound['increase_ridership_out'] = 0;
                                $outbound['farebox_out'] = 0;
                                $outbound['prev_farebox_out'] = 0;
                                $outbound['increase_farebox_out'] = 0;
                                $outbound['average_fare_out'] = 0;
                                $outbound['trip_planned_out'] = 0;
                                $outbound['trip_made_out'] = 0;
                                $outbound['trip_missed_out'] = 0;
                                $outbound['km_planned_out'] = 0;
                                $outbound['km_served_out'] = 0;
                                $outbound['km_served_gps_out'] = 0;
                                $outbound['early_departure_out'] = 0;
                                $outbound['late_departure_out'] = 0;
                                $outbound['early_end_out'] = 0;
                                $outbound['late_end_out'] = 0;
                                $outbound['breakdown_out'] = 0;
                                $outbound['bus_used_out'] = 0;
                                $outbound['accidents_out'] = 0;
                                $outbound['complaints_out'] = 0;
            
                                $outbound_data[$route_name_out] = $outbound;
                                $inbound_data[$route_name_in] = $inbound;
            
                                $total['total_ridership'] = $totalRidershipIn;
                                $total['total_prev_ridership'] = $prevRidershipIn;
            
                                $totIncreaseRidership = ($increaseRidershipIn/ 200) * 100;
                                $totIncreaseRidershipFormat = number_format((float)$totIncreaseRidership, 2, '.', '');
                                $total['total_increase_ridership'] = $totIncreaseRidershipFormat;
            
                                $total['total_farebox'] = $totalFareboxOut;
                                $total['total_prev_farebox'] = $prevFareboxOut;
            
                                $totIncreaseFarebox = ($increaseFareboxIn/ 200) * 100;
                                $totIncreaseFareboxFormat = number_format((float)$totIncreaseFarebox, 2, '.', '');
                                $total['total_increase_farebox'] = $totIncreaseFareboxFormat;
                            
                                $total['total_average_fare'] = $averageFormatIn;
                                $total['total_trip_planned'] = $countScheduleIn;
                                $total['total_trip_made'] = $totalTripIn;
                                $total['total_trip_missed'] = $tripMissedIn;
                                $total['total_km_planned'] = $totalKMPlannedIn;
                                $total['total_km_served'] = $totalKMServedIn;
                                $total['total_km_served_gps'] = $totalKMGPSIn;
                                $total['total_early_departure'] = $earlyDepartureIn;
                                $total['total_late_departure'] = $lateDepartureIn;
                                $total['total_early_end'] = $earlyEndIn;
                                $total['total_late_end'] = $lateEndIn;
                                $total['total_breakdown'] = $breakdownIn;
                                $total['total_bus_used'] = $busUsedIn;
                                $total['total_accidents'] = $accidentIn;
                                $total['total_complaints'] = $complaintsIn;
            
                                $content['outbound_data'] = $outbound_data;
                                $content['inbound_data'] = $inbound_data;
                                $content['total'] = $total;
                                $data[$allRoute->route_number] = $content;
            
                                $grandRidership += $total['total_ridership'];
                                $grandPrevRidership += $total['total_prev_ridership'];
                                $grandIncreaseRidership += $increaseRidershipIn;
                                $grandFarebox += $total['total_farebox'];
                                $grandPrevFarebox += $total['total_prev_farebox'];
                                $grandIncreaseFarebox += $increaseFareboxIn;
                                $grandTripPlanned += $total['total_trip_planned'];
                                $grandTripMade += $total['total_trip_made'];
                                $grandTripMissed += $total['total_trip_missed'];
                                $grandKMPlanned += $total['total_km_planned'];
                                $grandKMServed += $total['total_km_served'];
                                $grandKMGPS += $total['total_km_served_gps'];
                                $grandEarlyDeparture += $total['total_early_departure'];
                                $grandLateDeparture += $total['total_late_departure'];
                                $grandEarlyEnd += $total['total_early_end'];
                                $grandLateEnd += $total['total_late_end'];
                                $grandBreakdown += $total['total_breakdown'];
                                $grandBusUsed += $total['total_bus_used'];
                                $grandAccident += $total['total_accidents'];
                                $grandComplaint += $total['total_complaints'];
                            } else {
                                $out = new ConsoleOutput();
                                $out->writeln("YOU ARE IN HERE existInTrip == false && existOutTrip == false");
            
                                $inbound['ridership_in'] = 0;
                                $inbound['prev_ridership_in'] = 0;
                                $inbound['increase_ridership_in'] = 0;
                                $inbound['farebox_in'] = 0;
                                $inbound['prev_farebox_in'] = 0;
                                $inbound['increase_farebox_in'] = 0;
                                $inbound['average_fare_in'] = 0;
                                $inbound['trip_planned_in'] = 0;
                                $inbound['trip_made_in'] = 0;
                                $inbound['trip_missed_in'] = 0;
                                $inbound['km_planned_in'] = 0;
                                $inbound['km_served_in'] = 0;
                                $inbound['km_served_gps_in'] = 0;
                                $inbound['early_departure_in'] = 0;
                                $inbound['late_departure_in'] = 0;
                                $inbound['early_end_in'] = 0;
                                $inbound['late_end_in'] = 0;
                                $inbound['breakdown_in'] = 0;
                                $inbound['bus_used_in'] = 0;
                                $inbound['accidents_in'] = 0;
                                $inbound['complaints_in'] = 0;
            
                                $outbound['ridership_out'] = 0;
                                $outbound['prev_ridership_out'] = 0;
                                $outbound['increase_ridership_out'] = 0;
                                $outbound['farebox_out'] = 0;
                                $outbound['prev_farebox_out'] = 0;
                                $outbound['increase_farebox_out'] = 0;
                                $outbound['average_fare_out'] = 0;
                                $outbound['trip_planned_out'] = 0;
                                $outbound['trip_made_out'] = 0;
                                $outbound['trip_missed_out'] = 0;
                                $outbound['km_planned_out'] = 0;
                                $outbound['km_served_out'] = 0;
                                $outbound['km_served_gps_out'] = 0;
                                $outbound['early_departure_out'] = 0;
                                $outbound['late_departure_out'] = 0;
                                $outbound['early_end_out'] = 0;
                                $outbound['late_end_out'] = 0;
                                $outbound['breakdown_out'] = 0;
                                $outbound['bus_used_out'] = 0;
                                $outbound['accidents_out'] = 0;
                                $outbound['complaints_out'] = 0;
            
                                $inbound_data[$route_name_in] = $inbound;
                                $outbound_data[$route_name_out] = $outbound;
            
                                $total['total_ridership'] = 0;
                                $total['total_prev_ridership'] = 0;
                                $total['total_increase_ridership'] = 0;
                                $total['total_farebox'] = 0;
                                $total['total_prev_farebox'] = 0;
                                $total['total_increase_farebox'] = 0;
                                $total['total_average_fare'] = 0;
                                $total['total_trip_planned'] = 0;
                                $total['total_trip_made'] = 0;
                                $total['total_trip_missed'] = 0;
                                $total['total_km_planned'] = 0;;
                                $total['total_km_served'] = 0;
                                $total['total_km_served_gps'] = 0;
                                $total['total_early_departure'] = 0;
                                $total['total_late_departure'] = 0;
                                $total['total_early_end'] = 0;
                                $total['total_late_end'] = 0;
                                $total['total_breakdown'] = 0;
                                $total['total_bus_used'] = 0;
                                $total['total_accidents'] = 0;
                                $total['total_complaints'] = 0;
            
                                $content['outbound_data'] = $outbound_data;
                                $content['inbound_data'] = $inbound_data;
                                $content['total'] = $total;
                                $data[$allRoute->route_number] = $content;
            
                                $grandRidership += 0;
                                $grandPrevRidership += 0;
                                $grandIncreaseRidership += 0;
                                $grandFarebox += 0;
                                $grandPrevFarebox += 0;
                                $grandIncreaseFarebox += 0;
                                $grandTripPlanned += 0;
                                $grandTripMade += 0;
                                $grandTripMissed += 0;
                                $grandKMPlanned += 0;
                                $grandKMServed += 0;
                                $grandKMGPS += 0;
                                $grandEarlyDeparture += 0;
                                $grandLateDeparture += 0;
                                $grandEarlyEnd += 0;
                                $grandLateEnd += 0;
                                $grandBreakdown += 0;
                                $grandBusUsed += 0;
                                $grandAccident += 0;
                                $grandComplaint += 0;
                            }
                        }
                        $grand['grand_ridership'] = $grandRidership;
                        $grand['grand_prev_ridership'] =  $grandPrevRidership;
            
                        $percentAllRoutes = count($allRoutes) * 100;
                        if($percentAllRoutes==$grandIncreaseRidership){
                            $grandIncreaseRidershipFormat = 100;
                        }else{
                            $increaseRidershipFormat = ($grandIncreaseRidership / $percentAllRoutes) * 100;
                            $grandIncreaseRidershipFormat = number_format((float)$increaseRidershipFormat, 2, '.', '');
                        }
                        $grand['grand_increase_ridership'] = $grandIncreaseRidershipFormat;
            
                        $grand['grand_farebox'] = $grandFarebox;
                        $grand['grand_prev_farebox'] = $grandPrevFarebox;
            
                        if($percentAllRoutes==$grandIncreaseFarebox){
                            $grandIncreaseFareboxFormat = 100;
                        }else{
                            $increaseFareboxFormat = ($grandIncreaseFarebox / $percentAllRoutes) * 100;
                            $grandIncreaseFareboxFormat = number_format((float)$increaseFareboxFormat, 2, '.', '');
                        }
                        $grand['grand_increase_farebox'] = $grandIncreaseFareboxFormat;
            
                        if($grandRidership!=0){
                            $averageFareGrand =  $grandFarebox / $grandRidership;
                            $grandAverageFare = number_format((float)$averageFareGrand, 2, '.', '');
                        }
                        $grand['grand_average_fare'] = $grandAverageFare;
            
                        $grand['grand_trip_planned'] = $grandTripPlanned ;
                        $grand['grand_trip_made'] = $grandTripMade;
                        $grand['grand_trip_missed'] = $grandTripMissed;
                        $grand['grand_km_planned'] = $grandKMPlanned;;
                        $grand['grand_km_served'] = $grandKMServed;
                        $grand['grand_km_served_gps'] = $grandKMGPS;
                        $grand['grand_early_departure'] = $grandEarlyDeparture;
                        $grand['grand_late_departure'] = $grandLateDeparture;
                        $grand['grand_early_end'] = $grandEarlyEnd;
                        $grand['grand_late_end'] = $grandLateEnd;
                        $grand['grand_breakdown'] = $grandBreakdown;
                        $grand['grand_bus_used'] = $grandBusUsed;
                        $grand['grand_accidents'] = $grandAccident;
                        $grand['grand_complaints'] = $grandComplaint;
            
                        $data['grand'] = $grand;
                        $summary->add($data);
                    }
                }
            }
            else{
                $companyDetails = Company::where('id', $this->selectedCompany)->first();
                $networkArea = $companyDetails->company_name;

                if(!empty($validatedData['route_id'])){
                    //Summary all routes for specific company
                    if($validatedData['route_id']=='All'){
                        //Get all route per company
                        $allRoutes = Route::where('company_id', $this->selectedCompany)->orderBy('route_number')->get();
            
                        foreach($allRoutes as $allRoute) {
                            $existInTrip = false;
                            $existOutTrip = false;
                            $totalFareboxIn = 0;
                            $totalRidershipIn = 0;
                            $totalKMPlannedIn = 0;
                            $totalKMServedIn = 0;
                            $totalKMGPSIn = 0;
                            $earlyDepartureIn = 0;
                            $lateDepartureIn = 0;
                            $earlyEndIn = 0;
                            $lateEndIn = 0;
                            $inbound = [];
                            $totalTripIn = 0;

                            //Inbound
                            $allTripInbounds = TripDetail::where('route_id', $allRoute->id)
                                ->whereBetween('start_trip', [$dateFrom, $dateTo])
                                ->where('trip_code', 1)
                                ->get();
            
                            if (count($allTripInbounds)>0) {
                                foreach ($allTripInbounds as $allTripInbound) {
                                    $existInTrip = true;
            
                                    //Ridership
                                    $ridership = $allTripInbound->total_adult + $allTripInbound->total_concession;
                                    //Check tickets Ridership
                                    if($ridership==0){
                                        $ridership = TicketSalesTransaction::where('trip_id', $allTripInbound->id)->count();
                                    }
                                    $totalRidershipIn += $ridership;
            
                                    //Farebox Collection
                                    $farebox = $allTripInbound->total_adult_amount + $allTripInbound->total_concession_amount;
                                    //Check tickets Farebox
                                    if($farebox==0){
                                        $allTicketPerTrips = TicketSalesTransaction::where('trip_id', $allTripInbound->id)->get();
                                        if(count($allTicketPerTrips)>0){
                                            foreach($allTicketPerTrips as $allTicketPerTrip){
                                                $farebox += $allTicketPerTrip->actual_amount;
                                            }
                                        }
                                    }
                                    $totalFareboxIn += $farebox;
            
                                    //Total KM Service Served
                                    $kmServed = $allTripInbound->Route->inbound_distance;
                                    $totalKMServedIn += $kmServed;
            
                                    //Total KM Service Served by GPS
                                    $kmGPS = $allTripInbound->Route->inbound_distance;
                                    $totalKMGPSIn += $kmGPS;
            
                                    if ($allTripInbound->route_schedule_mstr_id != NULL) {
                                        //Total Early Departure
                                        $diffDepart = strtotime($allTripInbound->routeScheduleMSTR->schedule_start_time) - strtotime($allTripInbound->start_trip);
                                        if ($diffDepart > 5) {
                                            $earlyDepartureIn++;
                                        }elseif($diffDepart < -5){
                                            $lateDepartureIn++;
                                        }
                                        //Total Early End
                                        $diffEnd = strtotime($allTripInbound->routeScheduleMSTR->schedule_end_time) - strtotime($allTripInbound->end_trip);
                                        if ($diffEnd > 5) {
                                            $earlyEndIn++;
                                        }elseif($diffEnd < -5){
                                            $lateEndIn++;
                                        }
                                    }
                                    $totalTripIn++;
                                }
                            }
                            $prevRidershipIn = 0;
                            $prevFareboxIn = 0;
            
                            //Previous Month Inbound Trip
                            $prevTripInbounds = TripDetail::where('route_id', $allRoute->id)
                                ->whereBetween('start_trip', [$previousStartMonth, $previousEndMonth])
                                ->where('trip_code', 1)
                                ->get();
            
                            if(count($prevTripInbounds)>0){
                                foreach($prevTripInbounds as $prevTripInbound){
                                    //Previous Month Inbound Ridership collection
                                    $prevRidership = $prevTripInbound->total_adult + $prevTripInbound->total_concession;
                                    //Check tickets Ridership
                                    if($prevRidership==0){
                                        $prevRidership = TicketSalesTransaction::where('trip_id', $prevTripInbound->id)->count();
                                    }
                                    $prevRidershipIn += $prevRidership;
            
                                    //Previous Month Inbound Farebox collection
                                    $prevFarebox = $prevTripInbound->total_adult_amount + $prevTripInbound->total_concession_amount;
                                    //Check tickets Farebox
                                    if($prevFarebox==0){
                                        $allTicketPerTrips = TicketSalesTransaction::where('trip_id', $prevTripInbound->id)->get();
                                        if(count($allTicketPerTrips)>0){
                                            foreach($allTicketPerTrips as $allTicketPerTrip){
                                                $prevFarebox += $allTicketPerTrip->actual_amount;
                                            }
                                        }
                                    }
                                    $prevFareboxIn += $prevFarebox;
                                }
                            }
                            //Increment ridership collection (%)
                            if($prevRidershipIn==0){
                                $increaseRidershipIn = 100;
                                $increaseRidershipFormatIn = 100;
                            }else{
                            if($totalRidershipIn==0){
                                $increaseRidershipIn = -100;
                                $increaseRidershipFormatIn = -100;
                            }else{
                                $increaseRidershipIn = (($totalRidershipIn - $prevRidershipIn) / $prevRidershipIn) * 100;
                                $increaseRidershipFormatIn = number_format((float)$increaseRidershipIn, 2, '.', '');
                            }
                            }

                            //Incremeant farebox collection (%)
                            if($prevFareboxIn==0){
                                $increaseFareboxIn = 100;
                                $increaseFareboxFormatIn = 100;
                            }else{
                            if($totalFareboxIn==0){
                                $increaseFareboxIn = -100;
                                $increaseFareboxFormatIn = -100;
                            }else{
                                $increaseFareboxIn = (($totalFareboxIn - $prevFareboxIn) / $prevFareboxIn) * 100;
                                $increaseFareboxFormatIn = number_format((float)$increaseFareboxIn, 2, '.', '');
                            }
                            }

                            //Average Fare per pax (RM)
                            if($totalRidershipIn==0) {
                                $averageIn = 0;
                                $averageFormatIn = 0;
                            }
                            else{
                                $averageIn = $totalFareboxIn / $totalRidershipIn;
                                $averageFormatIn = number_format((float)$averageIn, 2, '.', '');
                            }

                            $countScheduleIn = 0;
                            $schedules = RouteSchedulerDetail::whereBetween('schedule_date', [$dateFrom, $dateTo])->get();
                            foreach($schedules as $schedule){
                                if($schedule->RouteScheduleMSTR->route_id == $allRoute->id){
                                    if($schedule->RouteScheduleMSTR->trip_code == 1){
                                        $countScheduleIn++;
                                    }
                                }
                            }
                            //Total KM Service Planned
                            $totalKMPlannedIn = $countScheduleIn * $allRoute->inbound_distance;

                            /**Number of Trips missed*/
                            //$tripMissed = MissedTrip::whereBetween('service_date', [$dateFrom, $dateTo])->count();
                            $tripMissedIn = $countScheduleIn - $totalTripIn;
                            if($tripMissedIn<0){
                                $tripMissedIn=0;
                            }

                            /**Total Breakdown During Operation*/
                            $breakdownIn = 0;

                            //Total Bus In Used
                            $busUsedIn = TripDetail::where('route_id', $allRoute->id)
                                ->whereBetween('start_trip', [$dateFrom, $dateTo])
                                ->where('trip_code', 1)
                                ->distinct('bus_id')
                                ->count();

                            /**Total Accidents caused by Operator*/
                            $accidentIn = 0;

                            /**Total Complaint*/
                            $complaintsIn = 0;

                            $inbound['ridership_in'] = $totalRidershipIn;
                            $inbound['prev_ridership_in'] = $prevRidershipIn;
                            $inbound['increase_ridership_in'] = $increaseRidershipFormatIn;
                            $inbound['farebox_in'] = $totalFareboxIn;
                            $inbound['prev_farebox_in'] = $prevFareboxIn;
                            $inbound['increase_farebox_in'] = $increaseFareboxFormatIn;
                            $inbound['average_fare_in'] = $averageFormatIn;
                            $inbound['trip_planned_in'] = $countScheduleIn;
                            $inbound['trip_made_in'] = $totalTripIn;
                            $inbound['trip_missed_in'] = $tripMissedIn;
                            $inbound['km_planned_in'] = $totalKMPlannedIn;
                            $inbound['km_served_in'] = $totalKMServedIn;
                            $inbound['km_served_gps_in'] = $totalKMGPSIn;
                            $inbound['early_departure_in'] = $earlyDepartureIn;
                            $inbound['late_departure_in'] = $lateDepartureIn;
                            $inbound['early_end_in'] = $earlyEndIn;
                            $inbound['late_end_in'] = $lateEndIn;
                            $inbound['breakdown_in'] = $breakdownIn;
                            $inbound['bus_used_in'] = $busUsedIn;
                            $inbound['accidents_in'] = $accidentIn;
                            $inbound['complaints_in'] = $complaintsIn;

                            $totalFareboxOut = 0;
                            $totalRidershipOut = 0;
                            $totalKMPlannedOut = 0;
                            $totalKMServedOut = 0;
                            $totalKMGPSOut = 0;
                            $earlyDepartureOut = 0;
                            $lateDepartureOut = 0;
                            $earlyEndOut = 0;
                            $lateEndOut = 0;
                            $outbound = [];
                            $totalTripOut = 0;

                            //Outbound
                            $allTripOutbounds = TripDetail::where('route_id',$allRoute->id)
                                ->whereBetween('start_trip', [$dateFrom, $dateTo])
                                ->where('trip_code', 0)
                                ->get();
            
                            if (count($allTripOutbounds) > 0) {
                                foreach ($allTripOutbounds as $allTripOutbound) {
                                    $existOutTrip = true;

                                    //Ridership
                                    $ridership = $allTripOutbound->total_adult + $allTripOutbound->total_concession;
                                    //Check tickets Ridership
                                    if($ridership==0){
                                        $ridership = TicketSalesTransaction::where('trip_id', $allTripOutbound->id)->count();
                                    }
                                    $totalRidershipOut += $ridership;
            
                                    //Farebox Collection
                                    $farebox = $allTripOutbound->total_adult_amount + $allTripOutbound->total_concession_amount;
                                    //Check tickets Farebox
                                    if($farebox==0){
                                        $allTicketPerTrips = TicketSalesTransaction::where('trip_id', $allTripOutbound->id)->get();
                                        if(count($allTicketPerTrips)>0){
                                            foreach($allTicketPerTrips as $allTicketPerTrip){
                                                $farebox += $allTicketPerTrip->actual_amount;
                                            }
                                        }
                                    }
                                    $totalFareboxOut += $farebox;
            
                                    //Total KM Service Served
                                    $kmServed = $allTripOutbound->Route->outbound_distance;
                                    $totalKMServedOut += $kmServed;
            
                                    //Total KM Service Served by GPS
                                    $kmGPS = $allTripOutbound->Route->outbound_distance;
                                    $totalKMGPSOut += $kmGPS;
            
                                    if ($allTripOutbound->route_schedule_mstr_id != NULL) {
                                        //Total Early Departure
                                        $diffDepart = strtotime($allTripOutbound->routeScheduleMSTR->schedule_start_time) - strtotime($allTripOutbound->start_trip);
                                        if ($diffDepart > 5) {
                                            $earlyDepartureOut++;
                                        }elseif($diffDepart < -5){
                                            $lateDepartureOut++;
                                        }
                                        //Total Early End
                                        $diffEnd = strtotime($allTripOutbound->routeScheduleMSTR->schedule_end_time) - strtotime($allTripOutbound->end_trip);
                                        if ($diffEnd > 5) {
                                            $earlyEndOut++;
                                        }elseif($diffEnd < -5){
                                            $lateEndOut++;
                                        }
                                    }
                                    $totalTripOut++;
                                }
                            }
                            $prevRidershipOut = 0;
                            $prevFareboxOut = 0;
            
                            //Previous Month Outbound Trip
                            $prevTripOutbounds = TripDetail::where('route_id', $allRoute->id)
                            ->whereBetween('start_trip', [$previousStartMonth, $previousEndMonth])
                            ->where('trip_code', 0)
                            ->get();
            
                            if(count($prevTripOutbounds)>0){
                                foreach($prevTripOutbounds as $prevTripOutbound){
                                    //Previous Month Inbound Ridership collection
                                    $prevRidership = $prevTripOutbound->total_adult + $prevTripOutbound->total_concession;
                                    //Check tickets Ridership
                                    if($prevRidership==0){
                                        $prevRidership = TicketSalesTransaction::where('trip_id', $prevTripOutbound->id)->count();
                                    }
                                    $prevRidershipOut += $prevRidership;
            
                                    //Previous Month Inbound Farebox collection
                                    $prevFarebox = $prevTripOutbound->total_adult_amount + $prevTripOutbound->total_concession_amount;
                                    //Check tickets Farebox
                                    if($prevFarebox==0){
                                        $allTicketPerTrips = TicketSalesTransaction::where('trip_id', $prevTripOutbound->id)->get();
                                        if(count($allTicketPerTrips)>0){
                                            foreach($allTicketPerTrips as $allTicketPerTrip){
                                                $prevFarebox += $allTicketPerTrip->actual_amount;
                                            }
                                        }
                                    }
                                    $prevFareboxOut += $prevFarebox;
                                }
                            }
                            //Increment ridership collection (%)
                            if($prevRidershipOut==0){
                                $increaseRidershipOut = 100;
                                $increaseRidershipFormatOut = 100;
                            }else{
                                if($totalRidershipOut==0){
                                    $increaseRidershipOut = -100;
                                    $increaseRidershipFormatOut = -100;
                                }else{
                                    $increaseRidershipOut = (($totalRidershipOut - $prevRidershipOut) / $prevRidershipOut) * 100/100;
                                    $increaseRidershipFormatOut = number_format((float)$increaseRidershipOut, 2, '.', '');
                                }
                            }
                            //Increment farebox collection (%)
                            if($prevFareboxOut==0){
                                $increaseFareboxOut = 100;
                                $increaseFareboxFormatOut = 100;
                            }else{
                                if($totalRidershipOut==0){
                                    $increaseFareboxOut = -100;
                                    $increaseFareboxFormatOut = -100;
                                }else{
                                    $increaseFareboxOut = (($totalFareboxOut - $prevFareboxOut) / $prevFareboxOut) * 100;
                                    $increaseFareboxFormatOut = number_format((float)$increaseFareboxOut, 2, '.', '');
                                }
                            }
            
                            //Average Fare per pax (RM)
                            if($totalRidershipOut==0) {
                                $averageOut = 0;
                                $averageFormatOut = 0;
                            }
                            else{
                                $averageOut = $totalFareboxOut / $totalRidershipOut;
                                $averageFormatOut = number_format((float)$averageOut, 2, '.', '');
                            }
            
                            $countScheduleOut = 0;
                            $schedules = RouteSchedulerDetail::whereBetween('schedule_date', [$dateFrom, $dateTo])->get();
                            foreach($schedules as $schedule){
                                if($schedule->RouteScheduleMSTR->route_id == $allRoute->id){
                                    if($schedule->RouteScheduleMSTR->trip_code == 0){
                                        $countScheduleOut++;
                                    }
                                }
                            }
                            //Total KM Service Planned
                            $totalKMPlannedOut = $countScheduleOut * $allRoute->outbound_distance;
            
                            /**Number of Trips missed*/
                            //$tripMissed = MissedTrip::whereBetween('service_date', [$dateFrom, $dateTo])->count();
                            $tripMissedOut =  $countScheduleOut - $totalTripOut;
                            if($tripMissedOut<0) {
                                $tripMissedOut=0;
                            }
            
                            /**Total Breakdown During Operation*/
                            $breakdownOut = 0;
            
                            //Total Bus In Used
                            $busUsedOut = TripDetail::where('route_id', $allRoute->id)
                                ->whereBetween('start_trip', [$dateFrom, $dateTo])
                                ->where('trip_code', 0)
                                ->distinct('bus_id')
                                ->count();
            
                            /**Total Accidents caused by Operator*/
                            $accidentOut = 0;
            
                            /**Total Complaint*/
                            $complaintsOut = 0;
            
                            $outbound['ridership_out'] = $totalRidershipOut;
                            $outbound['prev_ridership_out'] = $prevRidershipOut;
                            $outbound['increase_ridership_out'] = $increaseRidershipFormatOut;
                            $outbound['farebox_out'] = $totalFareboxOut;
                            $outbound['prev_farebox_out'] = $prevFareboxOut;
                            $outbound['increase_farebox_out'] = $increaseFareboxFormatOut;
                            $outbound['average_fare_out'] = $averageFormatOut;
                            $outbound['trip_planned_out'] = $countScheduleOut;
                            $outbound['trip_made_out'] = $totalTripOut;
                            $outbound['trip_missed_out'] = $tripMissedOut;
                            $outbound['km_planned_out'] = $totalKMPlannedOut;
                            $outbound['km_served_out'] = $totalKMServedOut;
                            $outbound['km_served_gps_out'] = $totalKMGPSOut;
                            $outbound['early_departure_out'] = $earlyDepartureOut;
                            $outbound['late_departure_out'] = $lateDepartureOut;
                            $outbound['early_end_out'] = $earlyEndOut;
                            $outbound['late_end_out'] = $lateEndOut;
                            $outbound['breakdown_out'] = $breakdownOut;
                            $outbound['bus_used_out'] = $busUsedOut;
                            $outbound['accidents_out'] = $accidentOut;
                            $outbound['complaints_out'] = $complaintsOut;
            
                            $inbound_data=[];
                            $outbound_data=[];
                            $content = [];
                            $route_name_in = $allRoute->route_name;
                            $route_name_out = implode(" - ", array_reverse(explode("-", $route_name_in)));
                            if ($existInTrip == 1 && $existOutTrip == 1) {
                                $out = new ConsoleOutput();
                                $out->writeln("YOU ARE IN HERE existInTrip == true && existOutTrip == true");
            
                                $inbound_data[$route_name_in] = $inbound;
                                $outbound_data[$route_name_out] = $outbound;
            
                                $total['total_ridership'] = $totalRidershipOut + $totalRidershipIn;
                                $total['total_prev_ridership'] = $prevRidershipOut + $prevRidershipIn;
            
                                if($increaseRidershipIn==100 && $increaseRidershipOut==100){
                                    $sumIncreaseRidership = 100;
                                    $sumIncreaseRidershipFormat = 100;
                                }else{
                                    $sumIncreaseRidership = (($increaseRidershipIn + $increaseRidershipOut) / 200) * 100;
                                    $sumIncreaseRidershipFormat = number_format((float)$sumIncreaseRidership, 2, '.', '');
                                }
                                $total['total_increase_ridership'] = $sumIncreaseRidershipFormat;
            
                                $total['total_farebox'] = $totalFareboxOut + $totalFareboxIn;
                                $total['total_prev_farebox'] = $prevFareboxOut + $prevFareboxIn;
            
                                if($increaseFareboxIn==100 && $increaseFareboxOut==100){
                                    $sumIncreaseFarebox = 100;
                                    $sumIncreaseFareboxFormat = 100;
                                }else{
                                    $sumIncreaseFarebox = (($increaseFareboxIn + $increaseFareboxOut) / 200) * 100;
                                    $sumIncreaseFareboxFormat = number_format((float)$sumIncreaseFarebox, 2, '.', '');
                                }
                                $total['total_increase_farebox'] = $sumIncreaseFareboxFormat;
            
                                if($total['total_ridership']==0) {
                                    $sumAverageFormat = 0;
                                }
                                else{
                                    $sumAverage = $total['total_farebox'] / $total['total_ridership'];
                                    $sumAverageFormat = number_format((float)$sumAverage, 2, '.', '');
                                }
                                $total['total_average_fare'] = $sumAverageFormat;
            
                                $total['total_trip_planned'] = $countScheduleOut +  $countScheduleIn;
                                $total['total_trip_made'] = $totalTripOut + $totalTripIn;
                                $total['total_trip_missed'] = $tripMissedOut + $tripMissedIn;
                                $total['total_km_planned'] = $totalKMPlannedOut + $totalKMPlannedIn;
                                $total['total_km_served'] = $totalKMServedOut + $totalKMServedIn;
                                $total['total_km_served_gps'] = $totalKMGPSOut + $totalKMGPSIn;
                                $total['total_early_departure'] = $earlyDepartureOut + $earlyDepartureIn;
                                $total['total_late_departure'] = $lateDepartureOut + $lateDepartureIn;
                                $total['total_early_end'] = $earlyEndOut + $earlyEndIn;
                                $total['total_late_end'] = $lateEndOut + $lateEndIn;
                                $total['total_breakdown'] = $breakdownOut + $breakdownIn;
                                $total['total_bus_used'] = $busUsedOut + $busUsedIn;
                                $total['total_accidents'] = $accidentOut + $accidentIn;
                                $total['total_complaints'] = $complaintsOut + $complaintsIn;
            
                                $content['inbound_data'] = $inbound_data;
                                $content['outbound_data'] = $outbound_data;
                                $content['total'] = $total;
                                $data[$allRoute->route_number] = $content;
            
                                $grandRidership += $total['total_ridership'];
                                $grandPrevRidership += $total['total_prev_ridership'];
                                $grandIncreaseRidership += $sumIncreaseRidership;
                                $grandFarebox += $total['total_farebox'];
                                $grandPrevFarebox += $total['total_prev_farebox'];
                                $grandIncreaseFarebox += $sumIncreaseFarebox;
                                $grandTripPlanned += $total['total_trip_planned'];
                                $grandTripMade += $total['total_trip_made'];
                                $grandTripMissed += $total['total_trip_missed'];
                                $grandKMPlanned += $total['total_km_planned'];
                                $grandKMServed += $total['total_km_served'];
                                $grandKMGPS += $total['total_km_served_gps'];
                                $grandEarlyDeparture += $total['total_early_departure'];
                                $grandLateDeparture += $total['total_late_departure'];
                                $grandEarlyEnd += $total['total_early_end'];
                                $grandLateEnd += $total['total_late_end'];
                                $grandBreakdown += $total['total_breakdown'];
                                $grandBusUsed += $total['total_bus_used'];
                                $grandAccident += $total['total_accidents'];
                                $grandComplaint += $total['total_complaints'];
            
                            } elseif ($existInTrip == 0 && $existOutTrip == 1) {
                                $out = new ConsoleOutput();
                                $out->writeln("YOU ARE IN HERE existInTrip == false && existOutTrip == true");
            
                                $inbound['ridership_in'] = 0;
                                $inbound['prev_ridership_in'] = 0;
                                $inbound['increase_ridership_in'] = 0;
                                $inbound['farebox_in'] = 0;
                                $inbound['prev_farebox_in'] = 0;
                                $inbound['increase_farebox_in'] = 0;
                                $inbound['average_fare_in'] = 0;
                                $inbound['trip_planned_in'] = 0;
                                $inbound['trip_made_in'] = 0;
                                $inbound['trip_missed_in'] = 0;
                                $inbound['km_planned_in'] = 0;
                                $inbound['km_served_in'] = 0;
                                $inbound['km_served_gps_in'] = 0;
                                $inbound['early_departure_in'] = 0;
                                $inbound['late_departure_in'] = 0;
                                $inbound['early_end_in'] = 0;
                                $inbound['late_end_in'] = 0;
                                $inbound['breakdown_in'] = 0;
                                $inbound['bus_used_in'] = 0;
                                $inbound['accidents_in'] = 0;
                                $inbound['complaints_in'] = 0;
            
                                $inbound_data[$route_name_in] = $inbound;
                                $outbound_data[$route_name_out] = $outbound;
            
                                $total['total_ridership'] = $totalRidershipOut;
                                $total['total_prev_ridership'] = $prevRidershipOut;
            
                                $totIncreaseRidership = ($increaseRidershipOut/ 200) * 100;
                                $totIncreaseRidershipFormat = number_format((float)$totIncreaseRidership, 2, '.', '');
                                $total['total_increase_ridership'] = $totIncreaseRidershipFormat;
            
                                $total['total_farebox'] = $totalFareboxOut;
                                $total['total_prev_farebox'] = $prevFareboxOut;
            
                                $totIncreaseFarebox = ($increaseFareboxOut/ 200) * 100;
                                $totIncreaseFareboxFormat = number_format((float)$totIncreaseFarebox, 2, '.', '');
                                $total['total_increase_farebox'] = $totIncreaseFareboxFormat;
            
                                $total['total_average_fare'] = $averageFormatOut;
                                $total['total_trip_planned'] =  $countScheduleOut;
                                $total['total_trip_made'] = $totalTripOut;
                                $total['total_trip_missed'] = $tripMissedOut;
                                $total['total_km_planned'] = $totalKMPlannedOut;
                                $total['total_km_served'] = $totalKMServedOut;
                                $total['total_km_served_gps'] = $totalKMGPSOut;
                                $total['total_early_departure'] = $earlyDepartureOut;
                                $total['total_late_departure'] = $lateDepartureOut;
                                $total['total_early_end'] = $earlyEndOut;
                                $total['total_late_end'] = $lateEndOut;
                                $total['total_breakdown'] = $breakdownOut;
                                $total['total_bus_used'] = $busUsedOut;
                                $total['total_accidents'] = $accidentOut;
                                $total['total_complaints'] = $complaintsOut;
            
                                $content['inbound_data'] = $inbound_data;
                                $content['outbound_data'] = $outbound_data;
                                $content['total'] = $total;
                                $data[$allRoute->route_number] = $content;
            
                                $grandRidership += $total['total_ridership'];
                                $grandPrevRidership += $total['total_prev_ridership'];
                                $grandIncreaseRidership += $increaseRidershipOut;
                                $grandFarebox += $total['total_farebox'];
                                $grandPrevFarebox += $total['total_prev_farebox'];
                                $grandIncreaseFarebox += $increaseFareboxOut;
                                $grandTripPlanned += $total['total_trip_planned'];
                                $grandTripMade += $total['total_trip_made'];
                                $grandTripMissed += $total['total_trip_missed'];
                                $grandKMPlanned += $total['total_km_planned'];
                                $grandKMServed += $total['total_km_served'];
                                $grandKMGPS += $total['total_km_served_gps'];
                                $grandEarlyDeparture += $total['total_early_departure'];
                                $grandLateDeparture += $total['total_late_departure'];
                                $grandEarlyEnd += $total['total_early_end'];
                                $grandLateEnd += $total['total_late_end'];
                                $grandBreakdown += $total['total_breakdown'];
                                $grandBusUsed += $total['total_bus_used'];
                                $grandAccident += $total['total_accidents'];
                                $grandComplaint += $total['total_complaints'];
            
                            } elseif ($existInTrip == 1 && $existOutTrip == 0) {
                                $out = new ConsoleOutput();
                                $out->writeln("YOU ARE IN HERE existInTrip == true && existOutTrip == false");
            
                                $outbound['ridership_out'] = 0;
                                $outbound['prev_ridership_out'] = 0;
                                $outbound['increase_ridership_out'] = 0;
                                $outbound['farebox_out'] = 0;
                                $outbound['prev_farebox_out'] = 0;
                                $outbound['increase_farebox_out'] = 0;
                                $outbound['average_fare_out'] = 0;
                                $outbound['trip_planned_out'] = 0;
                                $outbound['trip_made_out'] = 0;
                                $outbound['trip_missed_out'] = 0;
                                $outbound['km_planned_out'] = 0;
                                $outbound['km_served_out'] = 0;
                                $outbound['km_served_gps_out'] = 0;
                                $outbound['early_departure_out'] = 0;
                                $outbound['late_departure_out'] = 0;
                                $outbound['early_end_out'] = 0;
                                $outbound['late_end_out'] = 0;
                                $outbound['breakdown_out'] = 0;
                                $outbound['bus_used_out'] = 0;
                                $outbound['accidents_out'] = 0;
                                $outbound['complaints_out'] = 0;
            
                                $outbound_data[$route_name_out] = $outbound;
                                $inbound_data[$route_name_in] = $inbound;
            
                                $total['total_ridership'] = $totalRidershipIn;
                                $total['total_prev_ridership'] = $prevRidershipIn;
            
                                $totIncreaseRidership = ($increaseRidershipIn/ 200) * 100;
                                $totIncreaseRidershipFormat = number_format((float)$totIncreaseRidership, 2, '.', '');
                                $total['total_increase_ridership'] = $totIncreaseRidershipFormat;
            
                                $total['total_farebox'] = $totalFareboxOut;
                                $total['total_prev_farebox'] = $prevFareboxOut;
            
                                $totIncreaseFarebox = ($increaseFareboxIn/ 200) * 100;
                                $totIncreaseFareboxFormat = number_format((float)$totIncreaseFarebox, 2, '.', '');
                                $total['total_increase_farebox'] = $totIncreaseFareboxFormat;

                                $total['total_average_fare'] = $averageFormatIn;
                                $total['total_trip_planned'] =  $countScheduleIn;
                                $total['total_trip_made'] = $totalTripIn;
                                $total['total_trip_missed'] = $tripMissedIn;
                                $total['total_km_planned'] = $totalKMPlannedIn;
                                $total['total_km_served'] = $totalKMServedIn;
                                $total['total_km_served_gps'] = $totalKMGPSIn;
                                $total['total_early_departure'] = $earlyDepartureIn;
                                $total['total_late_departure'] = $lateDepartureIn;
                                $total['total_early_end'] = $earlyEndIn;
                                $total['total_late_end'] = $lateEndIn;
                                $total['total_breakdown'] = $breakdownIn;
                                $total['total_bus_used'] = $busUsedIn;
                                $total['total_accidents'] = $accidentIn;
                                $total['total_complaints'] = $complaintsIn;
            
                                $content['outbound_data'] = $outbound_data;
                                $content['inbound_data'] = $inbound_data;
                                $content['total'] = $total;
                                $data[$allRoute->route_number] = $content;
            
                                $grandRidership += $total['total_ridership'];
                                $grandPrevRidership += $total['total_prev_ridership'];
                                $grandIncreaseRidership += $increaseRidershipIn;
                                $grandFarebox += $total['total_farebox'];
                                $grandPrevFarebox += $total['total_prev_farebox'];
                                $grandIncreaseFarebox += $increaseFareboxIn;
                                $grandTripPlanned += $total['total_trip_planned'];
                                $grandTripMade += $total['total_trip_made'];
                                $grandTripMissed += $total['total_trip_missed'];
                                $grandKMPlanned += $total['total_km_planned'];
                                $grandKMServed += $total['total_km_served'];
                                $grandKMGPS += $total['total_km_served_gps'];
                                $grandEarlyDeparture += $total['total_early_departure'];
                                $grandLateDeparture += $total['total_late_departure'];
                                $grandEarlyEnd += $total['total_early_end'];
                                $grandLateEnd += $total['total_late_end'];
                                $grandBreakdown += $total['total_breakdown'];
                                $grandBusUsed += $total['total_bus_used'];
                                $grandAccident += $total['total_accidents'];
                                $grandComplaint += $total['total_complaints'];
                            } else {
                                $out = new ConsoleOutput();
                                $out->writeln("YOU ARE IN HERE existInTrip == false && existOutTrip == false");
            
                                $inbound['ridership_in'] = 0;
                                $inbound['prev_ridership_in'] = 0;
                                $inbound['increase_ridership_in'] = 0;
                                $inbound['farebox_in'] = 0;
                                $inbound['prev_farebox_in'] = 0;
                                $inbound['increase_farebox_in'] = 0;
                                $inbound['average_fare_in'] = 0;
                                $inbound['trip_planned_in'] = 0;
                                $inbound['trip_made_in'] = 0;
                                $inbound['trip_missed_in'] = 0;
                                $inbound['km_planned_in'] = 0;
                                $inbound['km_served_in'] = 0;
                                $inbound['km_served_gps_in'] = 0;
                                $inbound['early_departure_in'] = 0;
                                $inbound['late_departure_in'] = 0;
                                $inbound['early_end_in'] = 0;
                                $inbound['late_end_in'] = 0;
                                $inbound['breakdown_in'] = 0;
                                $inbound['bus_used_in'] = 0;
                                $inbound['accidents_in'] = 0;
                                $inbound['complaints_in'] = 0;
            
                                $outbound['ridership_out'] = 0;
                                $outbound['prev_ridership_out'] = 0;
                                $outbound['increase_ridership_out'] = 0;
                                $outbound['farebox_out'] = 0;
                                $outbound['prev_farebox_out'] = 0;
                                $outbound['increase_farebox_out'] = 0;
                                $outbound['average_fare_out'] = 0;
                                $outbound['trip_planned_out'] = 0;
                                $outbound['trip_made_out'] = 0;
                                $outbound['trip_missed_out'] = 0;
                                $outbound['km_planned_out'] = 0;
                                $outbound['km_served_out'] = 0;
                                $outbound['km_served_gps_out'] = 0;
                                $outbound['early_departure_out'] = 0;
                                $outbound['late_departure_out'] = 0;
                                $outbound['early_end_out'] = 0;
                                $outbound['late_end_out'] = 0;
                                $outbound['breakdown_out'] = 0;
                                $outbound['bus_used_out'] = 0;
                                $outbound['accidents_out'] = 0;
                                $outbound['complaints_out'] = 0;
            
                                $inbound_data[$route_name_in] = $inbound;
                                $outbound_data[$route_name_out] = $outbound;
            
                                $total['total_ridership'] = 0;
                                $total['total_prev_ridership'] = 0;
                                $total['total_increase_ridership'] = 0;
                                $total['total_farebox'] = 0;
                                $total['total_prev_farebox'] = 0;
                                $total['total_increase_farebox'] = 0;
                                $total['total_average_fare'] = 0;
                                $total['total_trip_planned'] = 0;
                                $total['total_trip_made'] = 0;
                                $total['total_trip_missed'] = 0;
                                $total['total_km_planned'] = 0;;
                                $total['total_km_served'] = 0;
                                $total['total_km_served_gps'] = 0;
                                $total['total_early_departure'] = 0;
                                $total['total_late_departure'] = 0;
                                $total['total_early_end'] = 0;
                                $total['total_late_end'] = 0;
                                $total['total_breakdown'] = 0;
                                $total['total_bus_used'] = 0;
                                $total['total_accidents'] = 0;
                                $total['total_complaints'] = 0;
            
                                $content['outbound_data'] = $outbound_data;
                                $content['inbound_data'] = $inbound_data;
                                $content['total'] = $total;
                                $data[$allRoute->route_number] = $content;
            
                                $grandRidership += 0;
                                $grandPrevRidership += 0;
                                $grandIncreaseRidership += 0;
                                $grandFarebox += 0;
                                $grandPrevFarebox += 0;
                                $grandIncreaseFarebox += 0;
                                $grandTripPlanned += 0;
                                $grandTripMade += 0;
                                $grandTripMissed += 0;
                                $grandKMPlanned += 0;
                                $grandKMServed += 0;
                                $grandKMGPS += 0;
                                $grandEarlyDeparture += 0;
                                $grandLateDeparture += 0;
                                $grandEarlyEnd += 0;
                                $grandLateEnd += 0;
                                $grandBreakdown += 0;
                                $grandBusUsed += 0;
                                $grandAccident += 0;
                                $grandComplaint += 0;
                            }
                        }
                        $grand['grand_ridership'] = $grandRidership;
                        $grand['grand_prev_ridership'] =  $grandPrevRidership;

                        $percentAllRoutes = count($allRoutes) * 100;
                        if($percentAllRoutes==$grandIncreaseRidership){
                            $grandIncreaseRidershipFormat = 100;
                        }else{
                            $increaseRidershipFormat = ($grandIncreaseRidership / $percentAllRoutes) * 100;
                            $grandIncreaseRidershipFormat = number_format((float)$increaseRidershipFormat, 2, '.', '');
                        }
                        $grand['grand_increase_ridership'] = $grandIncreaseRidershipFormat;

                        $grand['grand_farebox'] = $grandFarebox;
                        $grand['grand_prev_farebox'] = $grandPrevFarebox;

                        if($percentAllRoutes==$grandIncreaseFarebox){
                            $grandIncreaseFareboxFormat = 100;
                        }else{
                            $increaseFareboxFormat = ($grandIncreaseFarebox / $percentAllRoutes) * 100;
                            $grandIncreaseFareboxFormat = number_format((float)$increaseFareboxFormat, 2, '.', '');
                        }
                        $grand['grand_increase_farebox'] = $grandIncreaseFareboxFormat;

                        if($grandRidership!=0){
                            $averageFareGrand =  $grandFarebox / $grandRidership;
                            $grandAverageFare = number_format((float)$averageFareGrand, 2, '.', '');
                        }
                        $grand['grand_average_fare'] = $grandAverageFare;
                        
                        $grand['grand_trip_planned'] = $grandTripPlanned ;
                        $grand['grand_trip_made'] = $grandTripMade;
                        $grand['grand_trip_missed'] = $grandTripMissed;
                        $grand['grand_km_planned'] = $grandKMPlanned;;
                        $grand['grand_km_served'] = $grandKMServed;
                        $grand['grand_km_served_gps'] = $grandKMGPS;
                        $grand['grand_early_departure'] = $grandEarlyDeparture;
                        $grand['grand_late_departure'] = $grandLateDeparture;
                        $grand['grand_early_end'] = $grandEarlyEnd;
                        $grand['grand_late_end'] = $grandLateEnd;
                        $grand['grand_breakdown'] = $grandBreakdown;
                        $grand['grand_bus_used'] = $grandBusUsed;
                        $grand['grand_accidents'] = $grandAccident;
                        $grand['grand_complaints'] = $grandComplaint;
            
                        $data['grand'] = $grand;
                        $summary->add($data);
                    }
                    //Summary specific routes for specific company
                    else{
                        //Get all route per company
                        $chosenRoute = Route::with('trip')->where('id', $this->state['route_id'])->first();
                        dd($chosenRoute);
                        $existInTrip = false;
                        $existOutTrip = false;
                        $totalFareboxIn = 0;
                        $totalRidershipIn = 0;
                        $totalKMPlannedIn = 0;
                        $totalKMServedIn = 0;
                        $totalKMGPSIn = 0;
                        $earlyDepartureIn = 0;
                        $lateDepartureIn = 0;
                        $earlyEndIn = 0;
                        $lateEndIn = 0;
                        $inbound = [];
                        $totalTripIn = 0;

                        //Inbound
                        $allTripInbounds = TripDetail::where('route_id', $chosenRoute->id)
                            ->whereBetween('start_trip', [$dateFrom, $dateTo])
                            ->where('trip_code', 1)
                            ->get();

                        if (count($allTripInbounds)>0) {
                            foreach ($allTripInbounds as $allTripInbound) {
                                $existInTrip = true;

                                //Ridership
                                $ridership = $allTripInbound->total_adult + $allTripInbound->total_concession;
                                //Check tickets Ridership
                                if($ridership==0){
                                    $ridership = TicketSalesTransaction::where('trip_id', $allTripInbound->id)->count();
                                }
                                $totalRidershipIn += $ridership;

                                //Farebox Collection
                                $farebox = $allTripInbound->total_adult_amount + $allTripInbound->total_concession_amount;
                                //Check tickets Farebox
                                if($farebox==0){
                                    $allTicketPerTrips = TicketSalesTransaction::where('trip_id', $allTripInbound->id)->get();
                                    if(count($allTicketPerTrips)>0){
                                        foreach($allTicketPerTrips as $allTicketPerTrip){
                                            $farebox += $allTicketPerTrip->actual_amount;
                                        }
                                    }
                                }
                                $totalFareboxIn += $farebox;

                                //Total KM Service Served
                                $kmServed = $allTripInbound->Route->inbound_distance;
                                $totalKMServedIn += $kmServed;

                                //Total KM Service Served by GPS
                                $kmGPS = $allTripInbound->Route->inbound_distance;
                                $totalKMGPSIn += $kmGPS;

                                if ($allTripInbound->route_schedule_mstr_id != NULL) {
                                    //Total Early Departure
                                    $diffDepart = strtotime($allTripInbound->routeScheduleMSTR->schedule_start_time) - strtotime($allTripInbound->start_trip);
                                    if ($diffDepart > 5) {
                                        $earlyDepartureIn++;
                                    }elseif($diffDepart < -5){
                                        $lateDepartureIn++;
                                    }
                                    //Total Early End
                                    $diffEnd = strtotime($allTripInbound->routeScheduleMSTR->schedule_end_time) - strtotime($allTripInbound->end_trip);
                                    if ($diffEnd > 5) {
                                        $earlyEndIn++;
                                    }elseif($diffEnd < -5){
                                        $lateEndIn++;
                                    }
                                }
                                $totalTripIn++;
                            }
                        }
                        $prevRidershipIn = 0;
                        $prevFareboxIn = 0;

                        //Previous Month Inbound Trip
                        $prevTripInbounds = TripDetail::where('route_id', $chosenRoute->id)
                        ->whereBetween('start_trip', [$previousStartMonth, $previousEndMonth])
                        ->where('trip_code', 1)
                        ->get();

                        if(count($prevTripInbounds)>0){
                            foreach($prevTripInbounds as $prevTripInbound){
                                //Previous Month Inbound Ridership collection
                                $prevRidership = $prevTripInbound->total_adult + $prevTripInbound->total_concession;
                                //Check tickets Ridership
                                if($prevRidership==0){
                                    $prevRidership = TicketSalesTransaction::where('trip_id', $prevTripInbound->id)->count();
                                }
                                $prevRidershipIn += $prevRidership;
            
                                //Previous Month Inbound Farebox collection
                                $prevFarebox = $prevTripInbound->total_adult_amount + $prevTripInbound->total_concession_amount;
                                //Check tickets Farebox
                                if($prevFarebox==0){
                                    $allTicketPerTrips = TicketSalesTransaction::where('trip_id', $prevTripInbound->id)->get();
                                    if(count($allTicketPerTrips)>0){
                                        foreach($allTicketPerTrips as $allTicketPerTrip){
                                        $prevFarebox += $allTicketPerTrip->actual_amount;
                                        }
                                    }
                                }
                                $prevFareboxIn += $prevFarebox;
                            }
                        }
                        //Increment ridership collection (%)
                        if($prevRidershipIn==0){
                            $increaseRidershipIn = 100;
                            $increaseRidershipFormatIn = 100;
                        }else{
                            if($totalRidershipIn==0){
                                $increaseRidershipIn = -100;
                                $increaseRidershipFormatIn = -100;
                            }else{
                                $increaseRidershipIn = (($totalRidershipIn - $prevRidershipIn) / $prevRidershipIn) * 100/100;
                                $increaseRidershipFormatIn = number_format((float)$increaseRidershipIn, 2, '.', '');
                            }
                        }

                        //Incremeant farebox collection (%)
                        if($prevFareboxIn==0){
                            $increaseFareboxIn = 100;
                            $increaseFareboxFormatIn = 100;
                        }else{
                            if($totalFareboxIn==0){
                                $increaseFareboxIn = -100;
                                $increaseFareboxFormatIn = -100;
                            }else{
                                $increaseFareboxIn = (($totalFareboxIn - $prevFareboxIn) / $prevFareboxIn) * 100/100;
                                $increaseFareboxFormatIn = number_format((float)$increaseFareboxIn, 2, '.', '');
                            }
                        }

                        //Average Fare per pax (RM)
                        if($totalRidershipIn==0) {
                            $averageIn = 0;
                            $averageFormatIn = 0;
                        }
                        else{
                            $averageIn = $totalFareboxIn / $totalRidershipIn;
                            $averageFormatIn = number_format((float)$averageIn, 2, '.', '');
                        }

                        $countScheduleIn = 0;
                        $schedules = RouteSchedulerDetail::whereBetween('schedule_date', [$dateFrom, $dateTo])->get();
                        foreach($schedules as $schedule){
                            if($schedule->RouteScheduleMSTR->route_id == $chosenRoute->id){
                                if($schedule->RouteScheduleMSTR->trip_code == 1){
                                    $countScheduleIn++;
                                }
                            }
                        }
                        //Total KM Service Planned
                        $totalKMPlannedIn = $countScheduleIn * $chosenRoute->inbound_distance;

                        /**Number of Trips missed*/
                        $tripMissedIn = $countScheduleIn - $totalTripIn;
                        if($tripMissedIn<0){
                            $tripMissedIn=0;
                        }

                        /**Total Breakdown During Operation*/
                        $breakdownIn = 0;

                        //Total Bus In Used
                        $busUsedIn = TripDetail::where('route_id', $chosenRoute->id)
                            ->whereBetween('start_trip', [$dateFrom, $dateTo])
                            ->where('trip_code', 1)
                            ->distinct('bus_id')
                            ->count();

                        /**Total Accidents caused by Operator*/
                        $accidentIn = 0;

                        /**Total Complaint*/
                        $complaintsIn = 0;

                        $inbound['ridership_in'] = $totalRidershipIn;
                        $inbound['prev_ridership_in'] = $prevRidershipIn;
                        $inbound['increase_ridership_in'] = $increaseRidershipFormatIn;
                        $inbound['farebox_in'] = $totalFareboxIn;
                        $inbound['prev_farebox_in'] = $prevFareboxIn;
                        $inbound['increase_farebox_in'] = $increaseFareboxFormatIn;
                        $inbound['average_fare_in'] = $averageFormatIn;
                        $inbound['trip_planned_in'] = $countScheduleIn;
                        $inbound['trip_made_in'] = $totalTripIn;
                        $inbound['trip_missed_in'] = $tripMissedIn;
                        $inbound['km_planned_in'] = $totalKMPlannedIn;
                        $inbound['km_served_in'] = $totalKMServedIn;
                        $inbound['km_served_gps_in'] = $totalKMGPSIn;
                        $inbound['early_departure_in'] = $earlyDepartureIn;
                        $inbound['late_departure_in'] = $lateDepartureIn;
                        $inbound['early_end_in'] = $earlyEndIn;
                        $inbound['late_end_in'] = $lateEndIn;
                        $inbound['breakdown_in'] = $breakdownIn;
                        $inbound['bus_used_in'] = $busUsedIn;
                        $inbound['accidents_in'] = $accidentIn;
                        $inbound['complaints_in'] = $complaintsIn;

                        $totalFareboxOut = 0;
                        $totalRidershipOut = 0;
                        $totalKMPlannedOut = 0;
                        $totalKMServedOut = 0;
                        $totalKMGPSOut = 0;
                        $earlyDepartureOut = 0;
                        $lateDepartureOut = 0;
                        $earlyEndOut = 0;
                        $lateEndOut = 0;
                        $outbound = [];
                        $totalTripOut = 0;

                        //Outbound
                        $allTripOutbounds = TripDetail::where('route_id', $chosenRoute->id)
                            ->whereBetween('start_trip', [$dateFrom, $dateTo])
                            ->where('trip_code', 0)
                            ->get();

                        if (count($allTripOutbounds) > 0) {
                            foreach ($allTripOutbounds as $allTripOutbound) {
                                $existOutTrip = true;

                                //Ridership
                                $ridership = $allTripOutbound->total_adult + $allTripOutbound->total_concession;
                                //Check tickets Ridership
                                if($ridership==0){
                                    $ridership = TicketSalesTransaction::where('trip_id', $allTripOutbound->id)->count();
                                }
                                $totalRidershipOut += $ridership;

                                //Farebox Collection
                                $farebox = $allTripOutbound->total_adult_amount + $allTripOutbound->total_concession_amount;
                                //Check tickets Farebox
                                if($farebox==0){
                                    $allTicketPerTrips = TicketSalesTransaction::where('trip_id', $allTripOutbound->id)->get();
                                    if(count($allTicketPerTrips)>0){
                                        foreach($allTicketPerTrips as $allTicketPerTrip){
                                            $farebox += $allTicketPerTrip->actual_amount;
                                        }
                                    }
                                }
                                $totalFareboxOut += $farebox;

                                //Total KM Service Served
                                $kmServed = $allTripOutbound->Route->outbound_distance;
                                $totalKMServedOut += $kmServed;

                                //Total KM Service Served by GPS
                                $kmGPS = $allTripOutbound->Route->outbound_distance;
                                $totalKMGPSOut += $kmGPS;

                                if ($allTripOutbound->route_schedule_mstr_id != NULL) {
                                    //Total Early Departure
                                    $diffDepart = strtotime($allTripOutbound->routeScheduleMSTR->schedule_start_time) - strtotime($allTripOutbound->start_trip);
                                    if ($diffDepart > 5) {
                                        $earlyDepartureOut++;
                                    }elseif($diffDepart < -5){
                                        $lateDepartureOut++;
                                    }
                                    //Total Early End
                                    $diffEnd = strtotime($allTripOutbound->routeScheduleMSTR->schedule_end_time) - strtotime($allTripOutbound->end_trip);
                                    if ($diffEnd > 5) {
                                        $earlyEndOut++;
                                    }elseif($diffEnd < -5){
                                        $lateEndOut++;
                                    }
                                }
                                $totalTripOut++;
                            }
                        }
                        $prevRidershipOut = 0;
                        $prevFareboxOut = 0;

                        //Previous Month Outbound Trip
                        $prevTripOutbounds = TripDetail::where('route_id', $chosenRoute->id)
                            ->whereBetween('start_trip', [$previousStartMonth, $previousEndMonth])
                            ->where('trip_code', 0)
                            ->get();

                        if(count($prevTripOutbounds)>0){
                            foreach($prevTripOutbounds as $prevTripOutbound){
                                //Previous Month Inbound Ridership collection
                                $prevRidership = $prevTripOutbound->total_adult + $prevTripOutbound->total_concession;
                                //Check tickets Ridership
                                if($prevRidership==0){
                                    $prevRidership = TicketSalesTransaction::where('trip_id', $prevTripOutbound->id)->count();
                                }
                                $prevRidershipOut += $prevRidership;

                                //Previous Month Inbound Farebox collection
                                $prevFarebox = $prevTripOutbound->total_adult_amount + $prevTripOutbound->total_concession_amount;
                                //Check tickets Farebox
                                if($prevFarebox==0){
                                    $allTicketPerTrips = TicketSalesTransaction::where('trip_id', $prevTripOutbound->id)->get();
                                    if(count($allTicketPerTrips)>0){
                                        foreach($allTicketPerTrips as $allTicketPerTrip){
                                        $prevFarebox += $allTicketPerTrip->actual_amount;
                                        }
                                    }
                                }
                                $prevFareboxOut += $prevFarebox;
                            }
                        }
                        //Increment ridership collection (%)
                        if($prevRidershipOut==0){
                            $increaseRidershipOut = 100;
                            $increaseRidershipFormatOut = 100;
                        }else{
                            if($totalRidershipOut==0){
                                $increaseRidershipOut = -100;
                                $increaseRidershipFormatOut = -100;
                            }else{
                                $increaseRidershipOut = (($totalRidershipOut - $prevRidershipOut) / $prevRidershipOut) * 100;
                                $increaseRidershipFormatOut = number_format((float)$increaseRidershipOut, 2, '.', '');
                            }
                        }
                        //Increment farebox collection (%)
                        if($prevFareboxOut==0){
                            $increaseFareboxOut = 100;
                            $increaseFareboxFormatOut = 100;
                        }else{
                            if($totalRidershipOut==0){
                                $increaseFareboxOut = -100;
                                $increaseFareboxFormatOut = -100;
                            }else{
                                $increaseFareboxOut = (($totalFareboxOut - $prevFareboxOut) / $prevFareboxOut) * 100;
                                $increaseFareboxFormatOut = number_format((float)$increaseFareboxOut, 2, '.', '');
                            }
                        }

                        //Average Fare per pax (RM)
                        if($totalRidershipOut==0) {
                            $averageOut = 0;
                            $averageFormatOut = 0;
                        }
                        else{
                            $averageOut = $totalFareboxOut / $totalRidershipOut;
                            $averageFormatOut = number_format((float)$averageOut, 2, '.', '');
                        }

                        $countScheduleOut = 0;
                        $schedules = RouteSchedulerDetail::whereBetween('schedule_date', [$dateFrom, $dateTo])->get();
                        foreach($schedules as $schedule){
                            if($schedule->RouteScheduleMSTR->route_id == $chosenRoute->id){
                                if($schedule->RouteScheduleMSTR->trip_code == 0){
                                    $countScheduleOut++;
                                }
                            }
                        }
                        //Total KM Service Planned
                        $totalKMPlannedOut = $countScheduleOut * $chosenRoute->outbound_distance;

                        /**Number of Trips missed*/
                        //$tripMissed = MissedTrip::whereBetween('service_date', [$dateFrom, $dateTo])->count();
                        $tripMissedOut = $countScheduleOut - $totalTripOut;
                        if($tripMissedOut<0) {
                            $tripMissedOut=0;
                        }

                        /**Total Breakdown During Operation*/
                        $breakdownOut = 0;

                        //Total Bus In Used
                        $busUsedOut = TripDetail::where('route_id', $chosenRoute->id)
                            ->whereBetween('start_trip', [$dateFrom, $dateTo])
                            ->where('trip_code', 0)
                            ->distinct('bus_id')
                            ->count();

                        /**Total Accidents caused by Operator*/
                        $accidentOut = 0;

                        /**Total Complaint*/
                        $complaintsOut = 0;

                        $outbound['ridership_out'] = $totalRidershipOut;
                        $outbound['prev_ridership_out'] = $prevRidershipOut;
                        $outbound['increase_ridership_out'] = $increaseRidershipFormatOut;
                        $outbound['farebox_out'] = $totalFareboxOut;
                        $outbound['prev_farebox_out'] = $prevFareboxOut;
                        $outbound['increase_farebox_out'] = $increaseFareboxFormatOut;
                        $outbound['average_fare_out'] = $averageFormatOut;
                        $outbound['trip_planned_out'] = $countScheduleOut;
                        $outbound['trip_made_out'] = $totalTripOut;
                        $outbound['trip_missed_out'] = $tripMissedOut;
                        $outbound['km_planned_out'] = $totalKMPlannedOut;
                        $outbound['km_served_out'] = $totalKMServedOut;
                        $outbound['km_served_gps_out'] = $totalKMGPSOut;
                        $outbound['early_departure_out'] = $earlyDepartureOut;
                        $outbound['late_departure_out'] = $lateDepartureOut;
                        $outbound['early_end_out'] = $earlyEndOut;
                        $outbound['late_end_out'] = $lateEndOut;
                        $outbound['breakdown_out'] = $breakdownOut;
                        $outbound['bus_used_out'] = $busUsedOut;
                        $outbound['accidents_out'] = $accidentOut;
                        $outbound['complaints_out'] = $complaintsOut;

                        $inbound_data=[];
                        $outbound_data=[];
                        $route_name_in = $chosenRoute->route_name;
                        $route_name_out = implode(" - ", array_reverse(explode("-", $route_name_in)));
                        if ($existInTrip == 1 && $existOutTrip == 1) {
                            //$out->writeln("YOU ARE IN HERE existInTrip == true && existOutTrip == true");

                            $inbound_data[$route_name_in] = $inbound;
                            $outbound_data[$route_name_out] = $outbound;

                            $total['total_ridership'] = $totalRidershipOut + $totalRidershipIn;
                            $total['total_prev_ridership'] = $prevRidershipOut + $prevRidershipIn;

                            if($increaseRidershipIn==100 && $increaseRidershipOut==100){
                                $sumIncreaseRidership = 100;
                                $sumIncreaseRidershipFormat = 100;
                            }else{
                                $sumIncreaseRidership = (($increaseRidershipIn + $increaseRidershipOut) / 200) * 100;
                                $sumIncreaseRidershipFormat = number_format((float)$sumIncreaseRidership, 2, '.', '');
                            }
                            $total['total_increase_ridership'] = $sumIncreaseRidershipFormat;

                            $total['total_farebox'] = $totalFareboxOut + $totalFareboxIn;
                            $total['total_prev_farebox'] = $prevFareboxOut + $prevFareboxIn;

                            if($increaseFareboxIn==100 && $increaseFareboxOut==100){
                                $sumIncreaseFarebox = 100;
                                $sumIncreaseFareboxFormat = 100;
                            }else{
                                $sumIncreaseFarebox = (($increaseFareboxIn + $increaseFareboxOut) / 200) * 100;
                                $sumIncreaseFareboxFormat = number_format((float)$sumIncreaseFarebox, 2, '.', '');
                            }
                            $total['total_increase_farebox'] = $sumIncreaseFareboxFormat;

                            if($total['total_ridership']==0) {
                                $sumAverageFormat = 0;
                            }
                            else{
                                $sumAverage = $total['total_farebox'] / $total['total_ridership'];
                                $sumAverageFormat = number_format((float)$sumAverage, 2, '.', '');
                            }
                            $total['total_average_fare'] = $sumAverageFormat;

                            $total['total_trip_planned'] = $countScheduleIn + $totalTripIn;
                            $total['total_trip_made'] = $countScheduleOut + $totalTripOut;
                            $total['total_trip_missed'] = $tripMissedOut + $tripMissedIn;
                            $total['total_km_planned'] = $totalKMPlannedOut + $totalKMPlannedIn;
                            $total['total_km_served'] = $totalKMServedOut + $totalKMServedIn;
                            $total['total_km_served_gps'] = $totalKMGPSOut + $totalKMGPSIn;
                            $total['total_early_departure'] = $earlyDepartureOut + $earlyDepartureIn;
                            $total['total_late_departure'] = $lateDepartureOut + $lateDepartureIn;
                            $total['total_early_end'] = $earlyEndOut + $earlyEndIn;
                            $total['total_late_end'] = $lateEndOut + $lateEndIn;
                            $total['total_breakdown'] = $breakdownOut + $breakdownIn;
                            $total['total_bus_used'] = $busUsedOut + $busUsedIn;
                            $total['total_accidents'] = $accidentOut + $accidentIn;
                            $total['total_complaints'] = $complaintsOut + $complaintsIn;

                            $content['inbound_data'] = $inbound_data;
                            $content['outbound_data'] = $outbound_data;
                            $content['total'] = $total;
                            $data[$chosenRoute->route_number] = $content;

                            $grandRidership += $total['total_ridership'];
                            $grandPrevRidership += $total['total_prev_ridership'];
                            $grandIncreaseRidership += $sumIncreaseRidership;
                            $grandFarebox += $total['total_farebox'];
                            $grandPrevFarebox += $total['total_prev_farebox'];
                            $grandIncreaseFarebox += $sumIncreaseFarebox;;
                            $grandTripPlanned += $total['total_trip_planned'];
                            $grandTripMade += $total['total_trip_made'];
                            $grandTripMissed += $total['total_trip_missed'];
                            $grandKMPlanned += $total['total_km_planned'];
                            $grandKMServed += $total['total_km_served'];
                            $grandKMGPS += $total['total_km_served_gps'];
                            $grandEarlyDeparture += $total['total_early_departure'];
                            $grandLateDeparture += $total['total_late_departure'];
                            $grandEarlyEnd += $total['total_early_end'];
                            $grandLateEnd += $total['total_late_end'];
                            $grandBreakdown += $total['total_breakdown'];
                            $grandBusUsed += $total['total_bus_used'];
                            $grandAccident += $total['total_accidents'];
                            $grandComplaint += $total['total_complaints'];

                        } elseif ($existInTrip == 0 && $existOutTrip == 1) {
                            //$out->writeln("YOU ARE IN HERE existInTrip == false && existOutTrip == true");

                            $inbound['ridership_in'] = 0;
                            $inbound['prev_ridership_in'] = 0;
                            $inbound['increase_ridership_in'] = 0;
                            $inbound['farebox_in'] = 0;
                            $inbound['prev_farebox_in'] = 0;
                            $inbound['increase_farebox_in'] = 0;
                            $inbound['average_fare_in'] = 0;
                            $inbound['trip_planned_in'] = 0;
                            $inbound['trip_made_in'] = 0;
                            $inbound['trip_missed_in'] = 0;
                            $inbound['km_planned_in'] = 0;
                            $inbound['km_served_in'] = 0;
                            $inbound['km_served_gps_in'] = 0;
                            $inbound['early_departure_in'] = 0;
                            $inbound['late_departure_in'] = 0;
                            $inbound['early_end_in'] = 0;
                            $inbound['late_end_in'] = 0;
                            $inbound['breakdown_in'] = 0;
                            $inbound['bus_used_in'] = 0;
                            $inbound['accidents_in'] = 0;
                            $inbound['complaints_in'] = 0;

                            $inbound_data[$route_name_in] = $inbound;
                            $outbound_data[$route_name_out] = $outbound;

                            $total['total_ridership'] = $totalRidershipOut;
                            $total['total_prev_ridership'] = $prevRidershipOut;

                            $totIncreaseRidership = ($increaseRidershipOut/ 200) * 100;
                            $totIncreaseRidershipFormat = number_format((float)$totIncreaseRidership, 2, '.', '');
                            $total['total_increase_ridership'] = $totIncreaseRidershipFormat;

                            $total['total_farebox'] = $totalFareboxOut;
                            $total['total_prev_farebox'] = $prevFareboxOut;

                            $totIncreaseFarebox = ($increaseFareboxOut/ 200) * 100;
                            $totIncreaseFareboxFormat = number_format((float)$totIncreaseFarebox, 2, '.', '');
                            $total['total_increase_farebox'] = $totIncreaseFareboxFormat;

                            $total['total_average_fare'] = $averageFormatOut;
                            $total['total_trip_planned'] = $countScheduleOut;
                            $total['total_trip_made'] = $totalTripOut;
                            $total['total_trip_missed'] = $tripMissedOut;
                            $total['total_km_planned'] = $totalKMPlannedOut;
                            $total['total_km_served'] = $totalKMServedOut;
                            $total['total_km_served_gps'] = $totalKMGPSOut;
                            $total['total_early_departure'] = $earlyDepartureOut;
                            $total['total_late_departure'] = $lateDepartureOut;
                            $total['total_early_end'] = $earlyEndOut;
                            $total['total_late_end'] = $lateEndOut;
                            $total['total_breakdown'] = $breakdownOut;
                            $total['total_bus_used'] = $busUsedOut;
                            $total['total_accidents'] = $accidentOut;
                            $total['total_complaints'] = $complaintsOut;

                            $content['inbound_data'] = $inbound_data;
                            $content['outbound_data'] = $outbound_data;
                            $content['total'] = $total;
                            $data[$chosenRoute->route_number] = $content;

                            $grandRidership += $total['total_ridership'];
                            $grandPrevRidership += $total['total_prev_ridership'];
                            $grandIncreaseRidership += $increaseRidershipOut;
                            $grandFarebox += $total['total_farebox'];
                            $grandPrevFarebox += $total['total_prev_farebox'];
                            $grandIncreaseFarebox += $increaseFareboxOut;
                            $grandTripPlanned += $total['total_trip_planned'];
                            $grandTripMade += $total['total_trip_made'];
                            $grandTripMissed += $total['total_trip_missed'];
                            $grandKMPlanned += $total['total_km_planned'];
                            $grandKMServed += $total['total_km_served'];
                            $grandKMGPS += $total['total_km_served_gps'];
                            $grandEarlyDeparture += $total['total_early_departure'];
                            $grandLateDeparture += $total['total_late_departure'];
                            $grandEarlyEnd += $total['total_early_end'];
                            $grandLateEnd += $total['total_late_end'];
                            $grandBreakdown += $total['total_breakdown'];
                            $grandBusUsed += $total['total_bus_used'];
                            $grandAccident += $total['total_accidents'];
                            $grandComplaint += $total['total_complaints'];

                        } elseif ($existInTrip == 1 && $existOutTrip == 0) {
                            //$out->writeln("YOU ARE IN HERE existInTrip == true && existOutTrip == false");

                            $outbound['ridership_out'] = 0;
                            $outbound['prev_ridership_out'] = 0;
                            $outbound['increase_ridership_out'] = 0;
                            $outbound['farebox_out'] = 0;
                            $outbound['prev_farebox_out'] = 0;
                            $outbound['increase_farebox_out'] = 0;
                            $outbound['average_fare_out'] = 0;
                            $outbound['trip_planned_out'] = 0;
                            $outbound['trip_made_out'] = 0;
                            $outbound['trip_missed_out'] = 0;
                            $outbound['km_planned_out'] = 0;
                            $outbound['km_served_out'] = 0;
                            $outbound['km_served_gps_out'] = 0;
                            $outbound['early_departure_out'] = 0;
                            $outbound['late_departure_out'] = 0;
                            $outbound['early_end_out'] = 0;
                            $outbound['late_end_out'] = 0;
                            $outbound['breakdown_out'] = 0;
                            $outbound['bus_used_out'] = 0;
                            $outbound['accidents_out'] = 0;
                            $outbound['complaints_out'] = 0;

                            $outbound_data[$route_name_out] = $outbound;
                            $inbound_data[$route_name_in] = $inbound;

                            $total['total_ridership'] = $totalRidershipIn;
                            $total['total_prev_ridership'] = $prevRidershipIn;

                            $totIncreaseRidership = ($increaseRidershipIn/ 200) * 100;
                            $totIncreaseRidershipFormat = number_format((float)$totIncreaseRidership, 2, '.', '');
                            $total['total_increase_ridership'] = $totIncreaseRidershipFormat;

                            $total['total_farebox'] = $totalFareboxOut;
                            $total['total_prev_farebox'] = $prevFareboxOut;

                            $totIncreaseFarebox = ($increaseFareboxIn/ 200) * 100;
                            $totIncreaseFareboxFormat = number_format((float)$totIncreaseFarebox, 2, '.', '');
                            $total['total_increase_farebox'] = $totIncreaseFareboxFormat;

                            $total['total_average_fare'] = $averageFormatIn;
                            $total['total_trip_planned'] = $countScheduleIn;
                            $total['total_trip_made'] = $totalTripIn;
                            $total['total_trip_missed'] = $tripMissedIn;
                            $total['total_km_planned'] = $totalKMPlannedIn;
                            $total['total_km_served'] = $totalKMServedIn;
                            $total['total_km_served_gps'] = $totalKMGPSIn;
                            $total['total_early_departure'] = $earlyDepartureIn;
                            $total['total_late_departure'] = $lateDepartureIn;
                            $total['total_early_end'] = $earlyEndIn;
                            $total['total_late_end'] = $lateEndIn;
                            $total['total_breakdown'] = $breakdownIn;
                            $total['total_bus_used'] = $busUsedIn;
                            $total['total_accidents'] = $accidentIn;
                            $total['total_complaints'] = $complaintsIn;

                            $content['outbound_data'] = $outbound_data;
                            $content['inbound_data'] = $inbound_data;
                            $content['total'] = $total;
                            $data[$chosenRoute->route_number] = $content;

                            $grandRidership += $total['total_ridership'];
                            $grandPrevRidership += $total['total_prev_ridership'];
                            $grandIncreaseRidership += $increaseRidershipIn;
                            $grandFarebox += $total['total_farebox'];
                            $grandPrevFarebox += $total['total_prev_farebox'];
                            $grandIncreaseFarebox += $increaseFareboxIn;
                            $grandTripPlanned += $total['total_trip_planned'];
                            $grandTripMade += $total['total_trip_made'];
                            $grandTripMissed += $total['total_trip_missed'];
                            $grandKMPlanned += $total['total_km_planned'];
                            $grandKMServed += $total['total_km_served'];
                            $grandKMGPS += $total['total_km_served_gps'];
                            $grandEarlyDeparture += $total['total_early_departure'];
                            $grandLateDeparture += $total['total_late_departure'];
                            $grandEarlyEnd += $total['total_early_end'];
                            $grandLateEnd += $total['total_late_end'];
                            $grandBreakdown += $total['total_breakdown'];
                            $grandBusUsed += $total['total_bus_used'];
                            $grandAccident += $total['total_accidents'];
                            $grandComplaint += $total['total_complaints'];
                        } else {
                            //$out->writeln("YOU ARE IN HERE existInTrip == false && existOutTrip == false");

                            $inbound['ridership_in'] = 0;
                            $inbound['prev_ridership_in'] = 0;
                            $inbound['increase_ridership_in'] = 0;
                            $inbound['farebox_in'] = 0;
                            $inbound['prev_farebox_in'] = 0;
                            $inbound['increase_farebox_in'] = 0;
                            $inbound['average_fare_in'] = 0;
                            $inbound['trip_planned_in'] = 0;
                            $inbound['trip_made_in'] = 0;
                            $inbound['trip_missed_in'] = 0;
                            $inbound['km_planned_in'] = 0;
                            $inbound['km_served_in'] = 0;
                            $inbound['km_served_gps_in'] = 0;
                            $inbound['early_departure_in'] = 0;
                            $inbound['late_departure_in'] = 0;
                            $inbound['early_end_in'] = 0;
                            $inbound['late_end_in'] = 0;
                            $inbound['breakdown_in'] = 0;
                            $inbound['bus_used_in'] = 0;
                            $inbound['accidents_in'] = 0;
                            $inbound['complaints_in'] = 0;

                            $outbound['ridership_out'] = 0;
                            $outbound['prev_ridership_out'] = 0;
                            $outbound['increase_ridership_out'] = 0;
                            $outbound['farebox_out'] = 0;
                            $outbound['prev_farebox_out'] = 0;
                            $outbound['increase_farebox_out'] = 0;
                            $outbound['average_fare_out'] = 0;
                            $outbound['trip_planned_out'] = 0;
                            $outbound['trip_made_out'] = 0;
                            $outbound['trip_missed_out'] = 0;
                            $outbound['km_planned_out'] = 0;
                            $outbound['km_served_out'] = 0;
                            $outbound['km_served_gps_out'] = 0;
                            $outbound['early_departure_out'] = 0;
                            $outbound['late_departure_out'] = 0;
                            $outbound['early_end_out'] = 0;
                            $outbound['late_end_out'] = 0;
                            $outbound['breakdown_out'] = 0;
                            $outbound['bus_used_out'] = 0;
                            $outbound['accidents_out'] = 0;
                            $outbound['complaints_out'] = 0;

                            $inbound_data[$route_name_in] = $inbound;
                            $outbound_data[$route_name_out] = $outbound;

                            $total['total_ridership'] = 0;
                            $total['total_prev_ridership'] = 0;
                            $total['total_increase_ridership'] = 0;
                            $total['total_farebox'] = 0;
                            $total['total_prev_farebox'] = 0;
                            $total['total_increase_farebox'] = 0;
                            $total['total_average_fare'] = 0;
                            $total['total_trip_planned'] = 0;
                            $total['total_trip_made'] = 0;
                            $total['total_trip_missed'] = 0;
                            $total['total_km_planned'] = 0;;
                            $total['total_km_served'] = 0;
                            $total['total_km_served_gps'] = 0;
                            $total['total_early_departure'] = 0;
                            $total['total_late_departure'] = 0;
                            $total['total_early_end'] = 0;
                            $total['total_late_end'] = 0;
                            $total['total_breakdown'] = 0;
                            $total['total_bus_used'] = 0;
                            $total['total_accidents'] = 0;
                            $total['total_complaints'] = 0;

                            $content['outbound_data'] = $outbound_data;
                            $content['inbound_data'] = $inbound_data;
                            $content['total'] = $total;
                            $data[$chosenRoute->route_number] = $content;

                            $grandRidership += 0;
                            $grandPrevRidership += 0;
                            $grandIncreaseRidership += 0;
                            $grandFarebox += 0;
                            $grandPrevFarebox += 0;
                            $grandIncreaseFarebox += 0;
                            $grandTripPlanned += 0;
                            $grandTripMade += 0;
                            $grandTripMissed += 0;
                            $grandKMPlanned += 0;
                            $grandKMServed += 0;
                            $grandKMGPS += 0;
                            $grandEarlyDeparture += 0;
                            $grandLateDeparture += 0;
                            $grandEarlyEnd += 0;
                            $grandLateEnd += 0;
                            $grandBreakdown += 0;
                            $grandBusUsed += 0;
                            $grandAccident += 0;
                            $grandComplaint += 0;
                        }
                        $grand['grand_ridership'] = $grandRidership;
                        $grand['grand_prev_ridership'] =  $grandPrevRidership;

                        $percentAllRoutes = 100;
                        if($percentAllRoutes==$grandIncreaseRidership){
                            $grandIncreaseRidershipFormat = 100;
                        }else{
                            $increaseRidershipFormat = ($grandIncreaseRidership / $percentAllRoutes) * 100;
                            $grandIncreaseRidershipFormat = number_format((float)$increaseRidershipFormat, 2, '.', '');
                        }
                        $grand['grand_increase_ridership'] = $grandIncreaseRidershipFormat;

                        $grand['grand_farebox'] = $grandFarebox;
                        $grand['grand_prev_farebox'] = $grandPrevFarebox;

                        if($percentAllRoutes==$grandIncreaseFarebox){
                            $grandIncreaseFareboxFormat = 100;
                        }else{
                            $increaseFareboxFormat = ($grandIncreaseFarebox / $percentAllRoutes) * 100;
                            $grandIncreaseFareboxFormat = number_format((float)$increaseFareboxFormat, 2, '.', '');
                        }
                        $grand['grand_increase_farebox'] = $grandIncreaseFareboxFormat;

                        if($grandRidership!=0){
                            $averageFareGrand =  $grandFarebox / $grandRidership;
                            $grandAverageFare = number_format((float)$averageFareGrand, 2, '.', '');
                        }
                        $grand['grand_average_fare'] = $grandAverageFare;

                        $grand['grand_trip_planned'] = $grandTripPlanned ;
                        $grand['grand_trip_made'] = $grandTripMade;
                        $grand['grand_trip_missed'] = $grandTripMissed;
                        $grand['grand_km_planned'] = $grandKMPlanned;;
                        $grand['grand_km_served'] = $grandKMServed;
                        $grand['grand_km_served_gps'] = $grandKMGPS;
                        $grand['grand_early_departure'] = $grandEarlyDeparture;
                        $grand['grand_late_departure'] = $grandLateDeparture;
                        $grand['grand_early_end'] = $grandEarlyEnd;
                        $grand['grand_late_end'] = $grandLateEnd;
                        $grand['grand_breakdown'] = $grandBreakdown;
                        $grand['grand_bus_used'] = $grandBusUsed;
                        $grand['grand_accidents'] = $grandAccident;
                        $grand['grand_complaints'] = $grandComplaint;

                        $data['grand'] = $grand;
                        $summary->add($data);
                    }
                }
            }
            return Excel::download(new SPADSummary($summary, $all_dates, $validatedData['dateFrom'], $validatedData['dateTo'], $networkArea), 'Summary_Report_SPAD_'.Carbon::now()->format('YmdHis').'.xlsx');
        }else{
            $this->dispatchBrowserEvent('company-required');
        }
    }

    public function printServiceGroup()
    {
        $out = new ConsoleOutput();
        $out->writeln("YOU ARE IN printServiceGroup()");

        $validatedData = Validator::make($this->state,[
            'dateFrom' => ['required', 'date'],
            'dateTo' => ['required', 'date'],
            'route_id' => ['required'],
        ])->validate();

        $startDate = new Carbon($validatedData['dateFrom']);
        $endDate = new Carbon($validatedData['dateTo']);
        $all_dates = array();

        while ($startDate->lte($endDate)){
            $all_dates[] = $startDate->toDateString();
            $startDate->addDay();
        }

        $serviceGroup = collect();
        $totalScheduledTrip=0;
        $totalTripMade=0;
        $totalSumPassenger=0;
        $totalAdult=0;
        $totalConcession=0;
        if($this->selectedCompany){
            if($this->selectedCompany=='All'){
                $networkArea = 'ALL';
                if(!empty($validatedData['route_id'])) {
                    //ServiceGroup all routes for all company
                    if($validatedData['route_id']=='All'){
                        $allRoutes = Route::orderBy('route_number')->get();
            
                        foreach($allRoutes as $allRoute){
                            foreach ($all_dates as $all_date) {
                                $firstDate = new Carbon($all_date);
                                $lastDate = new Carbon($all_date . '23:59:59');
            
                                //Number of Scheduled Trips
                                $scheduledTrip = 0;
                                $schedules = RouteSchedulerDetail::whereBetween('schedule_date', [$firstDate,$lastDate])->get();
                                foreach($schedules as $schedule){
                                    if($schedule->RouteScheduleMSTR->route_id == $allRoute->id){
                                        $scheduledTrip++;
                                    }
                                }
                                $totalScheduledTrip += $scheduledTrip;
            
                                $allTrips = TripDetail::where('route_id', $allRoute->id)
                                    ->whereBetween('start_trip', [$firstDate,$lastDate])
                                    ->get();
            
                                $tripMade = 0;
                                foreach ($allTrips as $allTrip){
                                    //Number of Trips Made
                                    $tripMade++;
            
                                    //Passengers Boarding Count
                                    $adult = $allTrip->total_adult;
                                    $totalAdult += $adult;
            
                                    $concession = $allTrip->total_concession;
                                    $totalConcession += $concession;
            
                                    $sumPassenger = $adult + $concession;
                                    $totalSumPassenger += $sumPassenger;
                                }
                                $totalTripMade += $tripMade;
                            }
                        }
                        $data['num_scheduled_trip'] = $totalScheduledTrip;
                        $data['num_trip_made'] = $totalTripMade;
                        $data['count_passenger_board'] = $totalSumPassenger;
                        $data['num_adult'] = $totalAdult;
                        $data['num_concession'] = $totalConcession;
            
                        $serviceGroup->add($data);
                    }
                }
            }else{
                $selectedCompany = Company::where('id', $this->selectedCompany)->first();
                $networkArea = $selectedCompany->company_name;

                if(!empty($validatedData['route_id'])) {
                    //ServiceGroup all route for specific company
                    if($validatedData['route_id']=='All'){
                        $routeByCompanies = Route::where('company_id', $this->selectedCompany)->orderBy('route_number')->get();
        
                        foreach($routeByCompanies as $routeByCompany){
                            foreach ($all_dates as $all_date) {
                                $firstDate = new Carbon($all_date);
                                $lastDate = new Carbon($all_date . '23:59:59');
        
                                //Number of Scheduled Trips
                                $scheduledTrip = 0;
                                $schedules = RouteSchedulerDetail::whereBetween('schedule_date', [$firstDate,$lastDate])->get();
                                foreach($schedules as $schedule){
                                    if($schedule->RouteScheduleMSTR->route_id == $routeByCompany->id){
                                        $scheduledTrip++;
                                    }
                                }
                                $totalScheduledTrip += $scheduledTrip;
        
                                $allTrips = TripDetail::where('route_id', $routeByCompany->id)
                                    ->whereBetween('start_trip', [$firstDate,$lastDate])
                                    ->get();
        
                                $tripMade = 0;
                                foreach ($allTrips as $allTrip){
                                    //Number of Trips Made
                                    $tripMade++;
        
                                    //Passengers Boarding Count
                                    $adult = $allTrip->total_adult;
                                    $totalAdult += $adult;
                                    
                                    $concession = $allTrip->total_concession;
                                    $totalConcession += $concession;
        
                                    $sumPassenger = $adult + $concession;
                                    $totalSumPassenger += $sumPassenger;
                                }
                                $totalTripMade += $tripMade;
                            }
                        }
                        $data['num_scheduled_trip'] = $totalScheduledTrip;
                        $data['num_trip_made'] = $totalTripMade;
                        $data['count_passenger_board'] = $totalSumPassenger;
                        $data['num_adult'] = $totalAdult;
                        $data['num_concession'] = $totalConcession;
        
                        $serviceGroup->add($data);
                    }
                    //ServiceGroup certain route for specific company
                    else{
                        $selectedRoute = Route::where('id', $validatedData['route_id'])->first();
        
                        foreach ($all_dates as $all_date) {
                            $firstDate = new Carbon($all_date);
                            $lastDate = new Carbon($all_date . '23:59:59');
        
                            //Number of Scheduled Trips
                            $scheduledTrip = 0;
                            $schedules = RouteSchedulerDetail::whereBetween('schedule_date', [$firstDate,$lastDate])->get();
                            foreach($schedules as $schedule){
                                if($schedule->RouteScheduleMSTR->route_id == $selectedRoute->id){
                                    $scheduledTrip++;
                                }
                            }
                            $totalScheduledTrip += $scheduledTrip;
        
                            $allTrips = TripDetail::where('route_id', $selectedRoute->id)
                                ->whereBetween('start_trip', [$firstDate,$lastDate])
                                ->get();
        
                            $tripMade = 0;
                            foreach ($allTrips as $allTrip){
                                //Number of Trips Made
                                $tripMade++;
        
                                //Passengers Boarding Count
                                $adult = $allTrip->total_adult;
                                $totalAdult += $adult;
        
                                $concession = $allTrip->total_concession;
                                $totalConcession += $concession;
        
                                $sumPassenger = $adult + $concession;
                                $totalSumPassenger += $sumPassenger;
                            }
                            $totalTripMade += $tripMade;
                        }
        
                        $data['num_scheduled_trip'] = $totalScheduledTrip;
                        $data['num_trip_made'] = $totalTripMade;
                        $data['count_passenger_board'] = $totalSumPassenger;
                        $data['num_adult'] = $totalAdult;
                        $data['num_concession'] = $totalConcession;
        
                        $serviceGroup->add($data);
                    }
                }
            }
            return Excel::download(new SPADServiceGroup($networkArea,$serviceGroup, $validatedData['dateFrom'], $validatedData['dateTo']), 'Service_Group_Report_SPAD_'.Carbon::now()->format('YmdHis').'.xlsx');
        }else{
            $this->dispatchBrowserEvent('company-required');
        }
    }

    //FAST
    public function printRoute(){
        $out = new ConsoleOutput();
        $out->writeln("YOU ARE IN printRoute()");

        $validatedData = Validator::make($this->state,[
            'dateFrom' => ['required', 'date'],
            'dateTo' => ['required', 'date'],
            'route_id' => ['required'],
        ])->validate();

        $dateFrom = new Carbon($validatedData['dateFrom']);
        $dateTo = new Carbon($validatedData['dateTo'] . '23:59:59');

        $prevStart = Carbon::create($validatedData['dateFrom'])->startOfMonth()->subMonthsNoOverflow()->toDateString();
        $prevEnd = Carbon::create($validatedData['dateTo'])->subMonthsNoOverflow()->endOfMonth()->toDateString();

        $previousStartMonth = new Carbon($prevStart);
        $previousEndMonth = new Carbon($prevEnd . '23:59:59');

        $startDate = new Carbon($validatedData['dateFrom']);
        $endDate = new Carbon($validatedData['dateTo']);
        $all_dates = array();

        while ($startDate->lte($endDate)){
            $all_dates[] = $startDate->toDateString();
            $startDate->addDay();
        }

        if($this->selectedCompany){
            if($this->selectedCompany=='All'){
                $networkArea = 'ALL';
                if(!empty($validatedData['route_id'])) {
                    //Route all route all company
                    if($validatedData['route_id']=='All') {
                        $getAllRoutes = Route::where('status', 1)->orderBy('route_number')->get();
                        $allTrips = [];

                        foreach($getAllRoutes as $allRoute){
                            $out->writeln("All Route: " . $allRoute->route_number);

                            $tripOutbound = DB::select("SELECT route.route_number, route.route_name, trip_details.trip_code,
                            (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                            SUM(trip_details.total_mileage) as km_served,
                            SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                            SUM(total_adult) as total_adult, SUM(total_concession) as total_concession,
                            SUM(total_adult) + SUM(total_concession) AS ridership
                            FROM trip_details
                            JOIN mybas.route ON route.id = trip_details.route_id
                            WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND trip_details.route_id = " . $allRoute->id . "
                            AND trip_details.trip_code = 0
                            GROUP BY route.id;");

                            $noTripArr = [];
                            if(!$tripOutbound){
                                $out->writeln("In tripOutbound < 0");
                                $noTrip = new \stdClass;
                                $noTrip->route_number = $allRoute->route_number;
                                $noTrip->route_name = $allRoute->route_name;
                                $noTrip->trip_code = 0;
                                $noTrip->trip_served = 0;
                                $noTrip->km_served = 0.00;
                                $noTrip->farebox = 0.00;
                                $noTrip->total_adult = 0;
                                $noTrip->total_concession = 0;
                                $noTrip->ridership = 0;

                                $noTripArr[] = $noTrip;
                                $allTrips = array_merge($allTrips, $noTripArr);
                            }else{
                                $out->writeln("In tripPerRoute > 0");
                                $allTrips = array_merge($allTrips, $tripOutbound);
                            }

                            $tripInbound = DB::select("SELECT route.route_number, route.route_name as route_name_in, trip_details.trip_code,
                            (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                            SUM(trip_details.total_mileage) as km_served,
                            SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                            SUM(total_adult) as total_adult, SUM(total_concession) as total_concession,
                            SUM(total_adult) + SUM(total_concession) AS ridership
                            FROM trip_details
                            JOIN mybas.route ON route.id = trip_details.route_id
                            WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND trip_details.route_id = " . $allRoute->id . "
                            AND trip_details.trip_code = 1
                            GROUP BY route.id;");

                            $noTripArr = [];
                            if(!$tripInbound){
                                $out->writeln("In tripInbound < 0");
                                $noTrip = new \stdClass;
                                $noTrip->route_number = $allRoute->route_number;
                                $noTrip->route_name_in = $allRoute->route_name;
                                $noTrip->trip_code = 1;
                                $noTrip->trip_served = 0;
                                $noTrip->km_served = 0.00;
                                $noTrip->farebox = 0.00;
                                $noTrip->total_adult = 0;
                                $noTrip->total_concession = 0;
                                $noTrip->ridership = 0;

                                $noTripArr[] = $noTrip;
                                $allTrips = array_merge($allTrips, $noTripArr);
                            }else{
                                $out->writeln("In tripPerRoute > 0");
                                $allTrips = array_merge($allTrips, $tripInbound);
                            }

                            $totPerRoute = DB::select("SELECT route.route_number, 
                            (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                            SUM(trip_details.total_mileage) as km_served,
                            SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                            SUM(total_adult) as total_adult, SUM(total_concession) as total_concession,
                            SUM(total_adult) + SUM(total_concession) AS ridership
                            FROM trip_details
                            JOIN mybas.route ON route.id = trip_details.route_id
                            WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND trip_details.route_id = " . $allRoute->id . "
                            GROUP BY route.id;");

                            $noTripArr = [];
                            if(!$totPerRoute){
                                $out->writeln("In tripInbound < 0");
                                $noTrip = new \stdClass;
                                $noTrip->route_number = $allRoute->route_number;
                                $noTrip->trip_served = 0;
                                $noTrip->km_served = 0.00;
                                $noTrip->farebox = 0.00;
                                $noTrip->total_adult = 0;
                                $noTrip->total_concession = 0;
                                $noTrip->ridership = 0;

                                $noTripArr[] = $noTrip;
                                $allTrips = array_merge($allTrips, $noTripArr);
                            }else{
                                $out->writeln("In tripPerRoute > 0");
                                $allTrips = array_merge($allTrips, $totPerRoute);
                            }
                        }

                        $totGrand = DB::select("SELECT (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                        SUM(trip_details.total_mileage) as km_served,
                        SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                        SUM(total_adult) as total_adult, SUM(total_concession) as total_concession,
                        SUM(total_adult) + SUM(total_concession) AS ridership
                        FROM trip_details
                        JOIN mybas.route ON route.id = trip_details.route_id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "';");

                        $noTripArr = [];
                        if(!$totGrand){
                            $out->writeln("In tripInbound < 0");
                            $noTrip = new \stdClass;
                            $noTrip->trip_served = 0;
                            $noTrip->km_served = 0.00;
                            $noTrip->farebox = 0.00;
                            $noTrip->total_adult = 0;
                            $noTrip->total_concession = 0;
                            $noTrip->ridership = 0;

                            $noTripArr[] = $noTrip;
                            $allTrips = array_merge($allTrips, $noTripArr);
                        }else{
                            $out->writeln("In tripPerRoute > 0");
                            $allTrips = array_merge($allTrips, $totGrand);
                        }

                        //Trip Planned By Trip Code
                        $tripPlanned = DB::select("SELECT route.route_number, route.route_name, route_scheduler_mstr.trip_code,
                        count(route_scheduler_details.id) as trip_planned, 
                        count(route_scheduler_details.id) * route.distance as km_planned
                        FROM mybas.route
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE route_scheduler_details.schedule_date BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND route.status = 1
                        GROUP BY route_number, route_scheduler_mstr.trip_code
                        ORDER BY route_number, route_scheduler_mstr.trip_code;");

                        $tripPlannedRoute = DB::select("SELECT route.route_number, 
                        count(route_scheduler_details.id) as trip_planned, 
                        count(route_scheduler_details.id) * route.distance as km_planned
                        FROM mybas.route
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE route_scheduler_details.schedule_date BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND route.status = 1
                        GROUP BY route_number
                        ORDER BY route_number;");

                        $tripPlannedGrand = DB::select("SELECT
                        count(route_scheduler_details.id) as trip_planned, 
                        count(route_scheduler_details.id) * route.distance as km_planned
                        FROM mybas.route
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE route_scheduler_details.schedule_date BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND route.status = 1;");

                        $lastKey = array_key_last($allTrips);
                        $count = 0;
                        foreach($allTrips as $key => $allTrip){
                            $out->writeln("New Loop: " . $key);
                            $found = false;

                            if(property_exists($allTrip, 'route_name') || property_exists($allTrip, 'route_name_in')){
                                $out->writeln("ROUTE: " .  $allTrip->route_number . " TRIP CODE: " .  $allTrip->trip_code);
                                if($allTrip->trip_code==1){
                                    $out->writeln("Edit route name inbound");
                                    $allTrip->route_name = implode(" - ", array_reverse(explode("-", $allTrip->route_name_in)));
                                }
                                foreach($tripPlanned as $key2 => $tripPlan){
                                    if($tripPlan->route_number == $allTrip->route_number){
                                        if($tripPlan->trip_code == $allTrip->trip_code){
                                            $allTrip->trip_planned = $tripPlan->trip_planned;
                                            $allTrip->km_planned = $tripPlan->km_planned;

                                            $found = true;
                                            break ;
                                        }
                                    }
                                }
                                if(!$found){
                                    $allTrip->trip_planned = 0;
                                    $allTrip->km_planned = 0;
                                }

                                //Previous highest ridership and sales
                                $prevDataSQL = DB::select("SELECT
                                SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                                SUM(total_adult) + SUM(total_concession) AS ridership
                                FROM trip_details
                                JOIN mybas.route ON route.id = trip_details.route_id
                                WHERE trip_details.start_trip BETWEEN '" . $previousStartMonth . "' AND '" . $previousEndMonth . "'
                                AND route.route_number = '" . $allTrip->route_number . "'
                                AND trip_details.trip_code = '" . $allTrip->trip_code . "'
                                GROUP BY route.id;");

                                if(count($prevDataSQL)>0){
                                    foreach($prevDataSQL as $prevKey => $prevData){
                                        $allTrip->prev_ridership = $prevData->ridership;
                                        //Increment ridership inbound collection (%)
                                        if($prevData->ridership==0){
                                            if($allTrip->ridership==0){
                                                $allTrip->increase_ridership = 0;
                                            }else{
                                                $allTrip->increase_ridership = 100;
                                            }
                                        }else{
                                            if($allTrip->ridership==0){
                                                $allTrip->increase_ridership = -100;
                                            }else{
                                                $increaseRidership = (($allTrip->ridership - $prevData->ridership) / $prevData->ridership) * 100;
                                                $allTrip->increase_ridership = number_format((float)$increaseRidership, 2, '.', '');
                                            }
                                        }

                                        $allTrip->prev_farebox = $prevData->farebox;
                                        //Increment farebox inbound collection (%)
                                        if($prevData->farebox==0){
                                            if($allTrip->farebox==0){
                                                $allTrip->increase_farebox = 0;
                                            }else{
                                                $allTrip->increase_farebox = 100;
                                            }
                                        }else{
                                            if($allTrip->farebox==0){
                                                $allTrip->increase_farebox = -100;
                                            }else{
                                                $increaseSales = (($allTrip->farebox - $prevData->farebox) / $prevData->farebox) * 100;
                                                $allTrip->increase_farebox = number_format((float)$increaseSales, 2, '.', '');
                                            }
                                        }
                                    }
                                }else{
                                    $allTrip->prev_ridership = 0;
                                    if($allTrip->ridership==0){
                                        $allTrip->increase_ridership = 0;
                                    }else{
                                        $allTrip->increase_ridership = 100;
                                    }

                                    $allTrip->prev_farebox = 0.00;
                                    if($allTrip->farebox==0){
                                        $allTrip->increase_farebox = 0;
                                    }else{
                                        $allTrip->increase_farebox = 100;
                                    }
                                }
                            }elseif(!property_exists($allTrip, 'route_name') && property_exists($allTrip, 'route_number')){
                                $out->writeln("TOTAL ROUTE: " .  $allTrip->route_number );
                                foreach($tripPlannedRoute as $key3 => $tripPlan){
                                    if($tripPlan->route_number == $allTrip->route_number){
                                        $allTrip->trip_planned = $tripPlan->trip_planned;
                                        $allTrip->km_planned = $tripPlan->km_planned;

                                        $found = true;
                                        break ;
                                    }
                                }
                                if(!$found){
                                    $allTrip->trip_planned = 0;
                                    $allTrip->km_planned = 0;
                                }

                                //Previous highest ridership and sales
                                $prevDataSQL = DB::select("SELECT
                                SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                                SUM(total_adult) + SUM(total_concession) AS ridership
                                FROM trip_details
                                JOIN mybas.route ON route.id = trip_details.route_id
                                WHERE trip_details.start_trip BETWEEN '" . $previousStartMonth . "' AND '" . $previousEndMonth . "'
                                AND route.route_number = '" . $allTrip->route_number . "'
                                GROUP BY route.id;");

                                if(count($prevDataSQL)>0){
                                    foreach($prevDataSQL as $prevKey => $prevData){
                                        $allTrip->prev_ridership = $prevData->ridership;
                                        //Increment ridership inbound collection (%)
                                        if($prevData->ridership==0){
                                            if($allTrip->ridership==0){
                                                $allTrip->increase_ridership = 0;
                                            }else{
                                                $allTrip->increase_ridership = 100;
                                            }
                                        }else{
                                            if($allTrip->ridership==0){
                                                $allTrip->increase_ridership = -100;
                                            }else{
                                                $increaseRidership = (($allTrip->ridership - $prevData->ridership) / $prevData->ridership) * 100;
                                                $allTrip->increase_ridership = number_format((float)$increaseRidership, 2, '.', '');
                                            }
                                        }

                                        $allTrip->prev_farebox = $prevData->farebox;
                                        //Increment farebox inbound collection (%)
                                        if($prevData->farebox==0){
                                            if($allTrip->farebox==0){
                                                $allTrip->increase_farebox = 0;
                                            }else{
                                                $allTrip->increase_farebox = 100;
                                            }
                                        }else{
                                            if($allTrip->farebox==0){
                                                $allTrip->increase_farebox = -100;
                                            }else{
                                                $increaseSales = (($allTrip->farebox - $prevData->farebox) / $prevData->farebox) * 100;
                                                $allTrip->increase_farebox = number_format((float)$increaseSales, 2, '.', '');
                                            }
                                        }
                                    }
                                }else{
                                    $allTrip->prev_ridership = 0;
                                    if($allTrip->ridership==0){
                                        $allTrip->increase_ridership = 0;
                                    }else{
                                        $allTrip->increase_ridership = 100;
                                    }

                                    $allTrip->prev_farebox = 0.00;
                                    if($allTrip->farebox==0){
                                        $allTrip->increase_farebox = 0;
                                    }else{
                                        $allTrip->increase_farebox = 100;
                                    }
                                }
                            }else{
                                $out->writeln("IN GRAND");
                                foreach($tripPlannedGrand as $key4 => $tripPlan){
                                    $allTrip->trip_planned = $tripPlan->trip_planned;
                                    $allTrip->km_planned = $tripPlan->km_planned;

                                    $found = true;
                                    break ;
                                }
                                if(!$found){
                                    $allTrip->trip_planned = 0;
                                    $allTrip->km_planned = 0;
                                }

                                //Previous highest ridership and sales
                                $prevDataSQL = DB::select("SELECT
                                SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                                SUM(total_adult) + SUM(total_concession) AS ridership
                                FROM trip_details
                                JOIN mybas.route ON route.id = trip_details.route_id
                                WHERE trip_details.start_trip BETWEEN '" . $previousStartMonth . "' AND '" . $previousEndMonth . "'
                                AND route.status = 1;");

                                if(count($prevDataSQL)>0){
                                    foreach($prevDataSQL as $prevKey => $prevData){
                                        $allTrip->prev_ridership = $prevData->ridership;
                                        //Increment ridership inbound collection (%)
                                        if($prevData->ridership==0){
                                            if($allTrip->ridership==0){
                                                $allTrip->increase_ridership = 0;
                                            }else{
                                                $allTrip->increase_ridership = 100;
                                            }
                                        }else{
                                            if($allTrip->ridership==0){
                                                $allTrip->increase_ridership = -100;
                                            }else{
                                                $increaseRidership = (($allTrip->ridership - $prevData->ridership) / $prevData->ridership) * 100;
                                                $allTrip->increase_ridership = number_format((float)$increaseRidership, 2, '.', '');
                                            }
                                        }

                                        $allTrip->prev_farebox = $prevData->farebox;
                                        //Increment farebox inbound collection (%)
                                        if($prevData->farebox==0){
                                            if($allTrip->farebox==0){
                                                $allTrip->increase_farebox = 0;
                                            }else{
                                                $allTrip->increase_farebox = 100;
                                            }
                                        }else{
                                            if($allTrip->farebox==0){
                                                $allTrip->increase_farebox = -100;
                                            }else{
                                                $increaseSales = (($allTrip->farebox - $prevData->farebox) / $prevData->farebox) * 100;
                                                $allTrip->increase_farebox = number_format((float)$increaseSales, 2, '.', '');
                                            }
                                        }
                                    }
                                }else{
                                    $allTrip->prev_ridership = 0;
                                    if($allTrip->ridership==0){
                                        $allTrip->increase_ridership = 0;
                                    }else{
                                        $allTrip->increase_ridership = 100;
                                    }

                                    $allTrip->prev_farebox = 0.00;
                                    if($allTrip->farebox==0){
                                        $allTrip->increase_farebox = 0;
                                    }else{
                                        $allTrip->increase_farebox = 100;
                                    }
                                }    
                            }
                        }
                    }
                }
            }
            else{
                $selectedCompany = Company::where('id', $this->selectedCompany)->first();
                $networkArea = $selectedCompany->company_name;
                if(!empty($validatedData['route_id'])) {
                    if($validatedData['route_id']=='All'){
                        $getAllRoutes = Route::where('status', 1)->where('company_id', $selectedCompany->id)
                        ->orderBy('route_number')->get();
                        $allTrips = [];

                        foreach($getAllRoutes as $allRoute){
                            $out->writeln("All Route: " . $allRoute->route_number);

                            $tripOutbound = DB::select("SELECT route.route_number, route.route_name, trip_details.trip_code,
                            (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                            SUM(trip_details.total_mileage) as km_served,
                            SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                            SUM(total_adult) as total_adult, SUM(total_concession) as total_concession,
                            SUM(total_adult) + SUM(total_concession) AS ridership
                            FROM trip_details
                            JOIN mybas.route ON route.id = trip_details.route_id
                            WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND trip_details.route_id = " . $allRoute->id . "
                            AND trip_details.trip_code = 0
                            GROUP BY route.id;");

                            $noTripArr = [];
                            if(!$tripOutbound){
                                $out->writeln("In tripOutbound < 0");
                                $noTrip = new \stdClass;
                                $noTrip->route_number = $allRoute->route_number;
                                $noTrip->route_name = $allRoute->route_name;
                                $noTrip->trip_code = 0;
                                $noTrip->trip_served = 0;
                                $noTrip->km_served = 0.00;
                                $noTrip->farebox = 0.00;
                                $noTrip->total_adult = 0;
                                $noTrip->total_concession = 0;
                                $noTrip->ridership = 0;

                                $noTripArr[] = $noTrip;
                                $allTrips = array_merge($allTrips, $noTripArr);
                            }else{
                                $out->writeln("In tripPerRoute > 0");
                                $allTrips = array_merge($allTrips, $tripOutbound);
                            }

                            $tripInbound = DB::select("SELECT route.route_number, route.route_name as route_name_in, trip_details.trip_code,
                            (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                            SUM(trip_details.total_mileage) as km_served,
                            SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                            SUM(total_adult) as total_adult, SUM(total_concession) as total_concession,
                            SUM(total_adult) + SUM(total_concession) AS ridership
                            FROM trip_details
                            JOIN mybas.route ON route.id = trip_details.route_id
                            WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND trip_details.route_id = " . $allRoute->id . "
                            AND trip_details.trip_code = 1
                            GROUP BY route.id;");

                            $noTripArr = [];
                            if(!$tripInbound){
                                $out->writeln("In tripInbound < 0");
                                $noTrip = new \stdClass;
                                $noTrip->route_number = $allRoute->route_number;
                                $noTrip->route_name_in = $allRoute->route_name;
                                $noTrip->trip_code = 1;
                                $noTrip->trip_served = 0;
                                $noTrip->km_served = 0.00;
                                $noTrip->farebox = 0.00;
                                $noTrip->total_adult = 0;
                                $noTrip->total_concession = 0;
                                $noTrip->ridership = 0;

                                $noTripArr[] = $noTrip;
                                $allTrips = array_merge($allTrips, $noTripArr);
                            }else{
                                $out->writeln("In tripPerRoute > 0");
                                $allTrips = array_merge($allTrips, $tripInbound);
                            }

                            $totPerRoute = DB::select("SELECT route.route_number, 
                            (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                            SUM(trip_details.total_mileage) as km_served,
                            SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                            SUM(total_adult) as total_adult, SUM(total_concession) as total_concession,
                            SUM(total_adult) + SUM(total_concession) AS ridership
                            FROM trip_details
                            JOIN mybas.route ON route.id = trip_details.route_id
                            WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND trip_details.route_id = " . $allRoute->id . "
                            GROUP BY route.id;");

                            $noTripArr = [];
                            if(!$totPerRoute){
                                $out->writeln("In tripInbound < 0");
                                $noTrip = new \stdClass;
                                $noTrip->route_number = $allRoute->route_number;
                                $noTrip->trip_served = 0;
                                $noTrip->km_served = 0.00;
                                $noTrip->farebox = 0.00;
                                $noTrip->total_adult = 0;
                                $noTrip->total_concession = 0;
                                $noTrip->ridership = 0;

                                $noTripArr[] = $noTrip;
                                $allTrips = array_merge($allTrips, $noTripArr);
                            }else{
                                $out->writeln("In tripPerRoute > 0");
                                $allTrips = array_merge($allTrips, $totPerRoute);
                            }
                        }

                        $totGrand = DB::select("SELECT (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                        SUM(trip_details.total_mileage) as km_served,
                        SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                        SUM(total_adult) as total_adult, SUM(total_concession) as total_concession,
                        SUM(total_adult) + SUM(total_concession) AS ridership
                        FROM trip_details
                        JOIN mybas.route ON route.id = trip_details.route_id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND route.company_id = " . $selectedCompany->id . ";");

                        $noTripArr = [];
                        if(!$totGrand){
                            $out->writeln("In tripInbound < 0");
                            $noTrip = new \stdClass;
                            $noTrip->trip_served = 0;
                            $noTrip->km_served = 0.00;
                            $noTrip->farebox = 0.00;
                            $noTrip->total_adult = 0;
                            $noTrip->total_concession = 0;
                            $noTrip->ridership = 0;

                            $noTripArr[] = $noTrip;
                            $allTrips = array_merge($allTrips, $noTripArr);
                        }else{
                            $out->writeln("In tripPerRoute > 0");
                            $allTrips = array_merge($allTrips, $totGrand);
                        }

                        //Trip Planned By Trip Code
                        $tripPlanned = DB::select("SELECT route.route_number, route.route_name, route_scheduler_mstr.trip_code,
                        count(route_scheduler_details.id) as trip_planned, 
                        SUM(route.distance) as km_planned
                        FROM mybas.route
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE route_scheduler_details.schedule_date BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND route.status = 1
                        AND route.company_id = " . $selectedCompany->id . "
                        GROUP BY route_number, route_scheduler_mstr.trip_code
                        ORDER BY route_number, route_scheduler_mstr.trip_code;");

                        $tripPlannedRoute = DB::select("SELECT route.route_number, 
                        count(route_scheduler_details.id) as trip_planned, 
                        SUM(route.distance) as km_planned
                        FROM mybas.route
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE route_scheduler_details.schedule_date BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND route.status = 1
                        AND route.company_id = " . $selectedCompany->id . "
                        GROUP BY route_number
                        ORDER BY route_number;");

                        $tripPlannedGrand = DB::select("SELECT
                        count(route_scheduler_details.id) as trip_planned, 
                        SUM(route.distance) as km_planned
                        FROM mybas.route
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE route_scheduler_details.schedule_date BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND route.status = 1
                        AND route.company_id = " . $selectedCompany->id . ";");

                        $lastKey = array_key_last($allTrips);
                        $count = 0;
                        foreach($allTrips as $key => $allTrip){
                            $out->writeln("New Loop: " . $key);
                            $found = false;

                            if(property_exists($allTrip, 'route_name') || property_exists($allTrip, 'route_name_in')){
                                $out->writeln("ROUTE: " .  $allTrip->route_number . " TRIP CODE: " .  $allTrip->trip_code);
                                if($allTrip->trip_code==1){
                                    $out->writeln("Edit route name inbound");
                                    $allTrip->route_name = implode(" - ", array_reverse(explode("-", $allTrip->route_name_in)));
                                }
                                foreach($tripPlanned as $key2 => $tripPlan){
                                    if($tripPlan->route_number == $allTrip->route_number){
                                        if($tripPlan->trip_code == $allTrip->trip_code){
                                            $allTrip->trip_planned = $tripPlan->trip_planned;
                                            $allTrip->km_planned = $tripPlan->km_planned;

                                            $found = true;
                                            break ;
                                        }
                                    }
                                }
                                if(!$found){
                                    $allTrip->trip_planned = 0;
                                    $allTrip->km_planned = 0;
                                }

                                //Previous highest ridership and sales
                                $prevDataSQL = DB::select("SELECT
                                SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                                SUM(total_adult) + SUM(total_concession) AS ridership
                                FROM trip_details
                                JOIN mybas.route ON route.id = trip_details.route_id
                                WHERE trip_details.start_trip BETWEEN '" . $previousStartMonth . "' AND '" . $previousEndMonth . "'
                                AND route.route_number = '" . $allTrip->route_number . "'
                                AND trip_details.trip_code = '" . $allTrip->trip_code . "'
                                GROUP BY route.id;");

                                if(count($prevDataSQL)>0){
                                    foreach($prevDataSQL as $prevKey => $prevData){
                                        $allTrip->prev_ridership = $prevData->ridership;
                                        //Increment ridership inbound collection (%)
                                        if($prevData->ridership==0){
                                            if($allTrip->ridership==0){
                                                $allTrip->increase_ridership = 0;
                                            }else{
                                                $allTrip->increase_ridership = 100;
                                            }
                                        }else{
                                            if($allTrip->ridership==0){
                                                $allTrip->increase_ridership = -100;
                                            }else{
                                                $increaseRidership = (($allTrip->ridership - $prevData->ridership) / $prevData->ridership) * 100;
                                                $allTrip->increase_ridership = number_format((float)$increaseRidership, 2, '.', '');
                                            }
                                        }

                                        $allTrip->prev_farebox = $prevData->farebox;
                                        //Increment farebox inbound collection (%)
                                        if($prevData->farebox==0){
                                            if($allTrip->farebox==0){
                                                $allTrip->increase_farebox = 0;
                                            }else{
                                                $allTrip->increase_farebox = 100;
                                            }
                                        }else{
                                            if($allTrip->farebox==0){
                                                $allTrip->increase_farebox = -100;
                                            }else{
                                                $increaseSales = (($allTrip->farebox - $prevData->farebox) / $prevData->farebox) * 100;
                                                $allTrip->increase_farebox = number_format((float)$increaseSales, 2, '.', '');
                                            }
                                        }
                                    }
                                }else{
                                    $allTrip->prev_ridership = 0;
                                    if($allTrip->ridership==0){
                                        $allTrip->increase_ridership = 0;
                                    }else{
                                        $allTrip->increase_ridership = 100;
                                    }

                                    $allTrip->prev_farebox = 0.00;
                                    if($allTrip->farebox==0){
                                        $allTrip->increase_farebox = 0;
                                    }else{
                                        $allTrip->increase_farebox = 100;
                                    }
                                }
                            }elseif(!property_exists($allTrip, 'route_name') && property_exists($allTrip, 'route_number')){
                                $out->writeln("TOTAL ROUTE: " .  $allTrip->route_number );
                                foreach($tripPlannedRoute as $key3 => $tripPlan){
                                    if($tripPlan->route_number == $allTrip->route_number){
                                        $allTrip->trip_planned = $tripPlan->trip_planned;
                                        $allTrip->km_planned = $tripPlan->km_planned;

                                        $found = true;
                                        break ;
                                    }
                                }
                                if(!$found){
                                    $allTrip->trip_planned = 0;
                                    $allTrip->km_planned = 0;
                                }

                                //Previous highest ridership and sales
                                $prevDataSQL = DB::select("SELECT
                                SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                                SUM(total_adult) + SUM(total_concession) AS ridership
                                FROM trip_details
                                JOIN mybas.route ON route.id = trip_details.route_id
                                WHERE trip_details.start_trip BETWEEN '" . $previousStartMonth . "' AND '" . $previousEndMonth . "'
                                AND route.route_number = '" . $allTrip->route_number . "'
                                GROUP BY route.id;");

                                if(count($prevDataSQL)>0){
                                    foreach($prevDataSQL as $prevKey => $prevData){
                                        $allTrip->prev_ridership = $prevData->ridership;
                                        //Increment ridership inbound collection (%)
                                        if($prevData->ridership==0){
                                            if($allTrip->ridership==0){
                                                $allTrip->increase_ridership = 0;
                                            }else{
                                                $allTrip->increase_ridership = 100;
                                            }
                                        }else{
                                            if($allTrip->ridership==0){
                                                $allTrip->increase_ridership = -100;
                                            }else{
                                                $increaseRidership = (($allTrip->ridership - $prevData->ridership) / $prevData->ridership) * 100;
                                                $allTrip->increase_ridership = number_format((float)$increaseRidership, 2, '.', '');
                                            }
                                        }

                                        $allTrip->prev_farebox = $prevData->farebox;
                                        //Increment farebox inbound collection (%)
                                        if($prevData->farebox==0){
                                            if($allTrip->farebox==0){
                                                $allTrip->increase_farebox = 0;
                                            }else{
                                                $allTrip->increase_farebox = 100;
                                            }
                                        }else{
                                            if($allTrip->farebox==0){
                                                $allTrip->increase_farebox = -100;
                                            }else{
                                                $increaseSales = (($allTrip->farebox - $prevData->farebox) / $prevData->farebox) * 100;
                                                $allTrip->increase_farebox = number_format((float)$increaseSales, 2, '.', '');
                                            }
                                        }
                                    }
                                }else{
                                    $allTrip->prev_ridership = 0;
                                    if($allTrip->ridership==0){
                                        $allTrip->increase_ridership = 0;
                                    }else{
                                        $allTrip->increase_ridership = 100;
                                    }

                                    $allTrip->prev_farebox = 0.00;
                                    if($allTrip->farebox==0){
                                        $allTrip->increase_farebox = 0;
                                    }else{
                                        $allTrip->increase_farebox = 100;
                                    }
                                }
                            }else{
                                $out->writeln("IN GRAND");
                                foreach($tripPlannedGrand as $key4 => $tripPlan){
                                    $allTrip->trip_planned = $tripPlan->trip_planned;
                                    $allTrip->km_planned = $tripPlan->km_planned;

                                    $found = true;
                                    break ;
                                }
                                if(!$found){
                                    $allTrip->trip_planned = 0;
                                    $allTrip->km_planned = 0;
                                }

                                //Previous highest ridership and sales
                                $prevDataSQL = DB::select("SELECT
                                SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                                SUM(total_adult) + SUM(total_concession) AS ridership
                                FROM trip_details
                                JOIN mybas.route ON route.id = trip_details.route_id
                                WHERE trip_details.start_trip BETWEEN '" . $previousStartMonth . "' AND '" . $previousEndMonth . "'
                                AND route.status = 1
                                AND route.company_id = " . $selectedCompany->id . ";");

                                if(count($prevDataSQL)>0){
                                    foreach($prevDataSQL as $prevKey => $prevData){
                                        $allTrip->prev_ridership = $prevData->ridership;
                                        //Increment ridership inbound collection (%)
                                        if($prevData->ridership==0){
                                            if($allTrip->ridership==0){
                                                $allTrip->increase_ridership = 0;
                                            }else{
                                                $allTrip->increase_ridership = 100;
                                            }
                                        }else{
                                            if($allTrip->ridership==0){
                                                $allTrip->increase_ridership = -100;
                                            }else{
                                                $increaseRidership = (($allTrip->ridership - $prevData->ridership) / $prevData->ridership) * 100;
                                                $allTrip->increase_ridership = number_format((float)$increaseRidership, 2, '.', '');
                                            }
                                        }

                                        $allTrip->prev_farebox = $prevData->farebox;
                                        //Increment farebox inbound collection (%)
                                        if($prevData->farebox==0){
                                            if($allTrip->farebox==0){
                                                $allTrip->increase_farebox = 0;
                                            }else{
                                                $allTrip->increase_farebox = 100;
                                            }
                                        }else{
                                            if($allTrip->farebox==0){
                                                $allTrip->increase_farebox = -100;
                                            }else{
                                                $increaseSales = (($allTrip->farebox - $prevData->farebox) / $prevData->farebox) * 100;
                                                $allTrip->increase_farebox = number_format((float)$increaseSales, 2, '.', '');
                                            }
                                        }
                                    }
                                }else{
                                    $allTrip->prev_ridership = 0;
                                    if($allTrip->ridership==0){
                                        $allTrip->increase_ridership = 0;
                                    }else{
                                        $allTrip->increase_ridership = 100;
                                    }

                                    $allTrip->prev_farebox = 0.00;
                                    if($allTrip->farebox==0){
                                        $allTrip->increase_farebox = 0;
                                    }else{
                                        $allTrip->increase_farebox = 100;
                                    }
                                }    
                            }
                        }
                    }
                    else{
                        $allRoute = Route::where('id', $validatedData['route_id'])->first();
                        $allTrips = [];
                        $out->writeln("One Route: " . $allRoute->id);

                        $tripOutbound = DB::select("SELECT route.route_number, route.route_name, trip_details.trip_code,
                        (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                        SUM(trip_details.total_mileage) as km_served,
                        SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                        SUM(total_adult) as total_adult, SUM(total_concession) as total_concession,
                        SUM(total_adult) + SUM(total_concession) AS ridership
                        FROM trip_details
                        JOIN mybas.route ON route.id = trip_details.route_id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND trip_details.route_id = " . $allRoute->id . "
                        AND trip_details.trip_code = 0
                        GROUP BY route.id;");

                        $noTripArr = [];
                        if(!$tripOutbound){
                            $out->writeln("In tripOutbound < 0");
                            $noTrip = new \stdClass;
                            $noTrip->route_number = $allRoute->route_number;
                            $noTrip->route_name = $allRoute->route_name;
                            $noTrip->trip_code = 0;
                            $noTrip->trip_served = 0;
                            $noTrip->km_served = 0.00;
                            $noTrip->farebox = 0.00;
                            $noTrip->total_adult = 0;
                            $noTrip->total_concession = 0;
                            $noTrip->ridership = 0;

                            $noTripArr[] = $noTrip;
                            $allTrips = array_merge($allTrips, $noTripArr);
                        }else{
                            $out->writeln("In tripOutbound > 0");
                            $allTrips = array_merge($allTrips, $tripOutbound);
                        }

                        $tripInbound = DB::select("SELECT route.route_number, route.route_name as route_name_in, trip_details.trip_code,
                        (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                        SUM(trip_details.total_mileage) as km_served,
                        SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                        SUM(total_adult) as total_adult, SUM(total_concession) as total_concession,
                        SUM(total_adult) + SUM(total_concession) AS ridership
                        FROM trip_details
                        JOIN mybas.route ON route.id = trip_details.route_id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND trip_details.route_id = " . $allRoute->id . "
                        AND trip_details.trip_code = 1
                        GROUP BY route.id;");

                        $noTripArr = [];
                        if(!$tripInbound){
                            $out->writeln("In tripInbound < 0");
                            $noTrip = new \stdClass;
                            $noTrip->route_number = $allRoute->route_number;
                            $noTrip->route_name_in = $allRoute->route_name;
                            $noTrip->trip_code = 1;
                            $noTrip->trip_served = 0;
                            $noTrip->km_served = 0.00;
                            $noTrip->farebox = 0.00;
                            $noTrip->total_adult = 0;
                            $noTrip->total_concession = 0;
                            $noTrip->ridership = 0;

                            $noTripArr[] = $noTrip;
                            $allTrips = array_merge($allTrips, $noTripArr);
                        }else{
                            $out->writeln("In tripInbound > 0");
                            $allTrips = array_merge($allTrips, $tripInbound);
                        }

                        $totPerRoute = DB::select("SELECT route.route_number, 
                        (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                        SUM(trip_details.total_mileage) as km_served,
                        SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                        SUM(total_adult) as total_adult, SUM(total_concession) as total_concession,
                        SUM(total_adult) + SUM(total_concession) AS ridership
                        FROM trip_details
                        JOIN mybas.route ON route.id = trip_details.route_id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND trip_details.route_id = " . $allRoute->id . "
                        GROUP BY route.id;");

                        $noTripArr = [];
                        if(!$totPerRoute){
                            $noTrip = new \stdClass;
                            $noTrip->route_number = $allRoute->route_number;
                            $noTrip->trip_served = 0;
                            $noTrip->km_served = 0.00;
                            $noTrip->farebox = 0.00;
                            $noTrip->total_adult = 0;
                            $noTrip->total_concession = 0;
                            $noTrip->ridership = 0;

                            $noTripArr[] = $noTrip;
                            $allTrips = array_merge($allTrips, $noTripArr);
                        }else{
                            $allTrips = array_merge($allTrips, $totPerRoute);
                        }
                    
                        $totGrand = DB::select("SELECT (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                        IFNULL((SUM(trip_details.total_mileage)),0.00) as km_served,
                        IFNULL((SUM(total_adult_amount) + SUM(total_concession_amount)),0.00) AS farebox, 
                        IFNULL((SUM(total_adult)),0) as total_adult, IFNULL((SUM(total_concession)),0) as total_concession,
                        IFNULL((SUM(total_adult) + SUM(total_concession)),0) AS ridership
                        FROM trip_details
                        JOIN mybas.route ON route.id = trip_details.route_id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND route.id = " . $allRoute->id . ";");

                        $noTripArr = [];
                        if(!$totGrand){
                            $noTrip = new \stdClass;
                            $noTrip->trip_served = 0;
                            $noTrip->km_served = 0.00;
                            $noTrip->farebox = 0.00;
                            $noTrip->total_adult = 0;
                            $noTrip->total_concession = 0;
                            $noTrip->ridership = 0;

                            $noTripArr[] = $noTrip;
                            $allTrips = array_merge($allTrips, $noTripArr);
                        }else{
                            $allTrips = array_merge($allTrips, $totGrand);
                        }

                        dd($allTrips);

                        //Trip Planned By Trip Code
                        $tripPlanned = DB::select("SELECT route.route_number, route.route_name, route_scheduler_mstr.trip_code,
                        count(route_scheduler_details.id) as trip_planned, 
                        count(route_scheduler_details.id) * route.distance as km_planned
                        FROM mybas.route
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE route_scheduler_details.schedule_date BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND route.status = 1
                        AND route.id = " . $allRoute->id . "
                        GROUP BY route_number, route_scheduler_mstr.trip_code
                        ORDER BY route_number, route_scheduler_mstr.trip_code;");

                        $tripPlannedRoute = DB::select("SELECT route.route_number, 
                        count(route_scheduler_details.id) as trip_planned, 
                        count(route_scheduler_details.id) * route.distance as km_planned
                        FROM mybas.route
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE route_scheduler_details.schedule_date BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND route.status = 1
                        AND route.id = " . $allRoute->id . "
                        GROUP BY route_number
                        ORDER BY route_number;");

                        $tripPlannedGrand = DB::select("SELECT
                        count(route_scheduler_details.id) as trip_planned, 
                        count(route_scheduler_details.id) * route.distance as km_planned
                        FROM mybas.route
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE route_scheduler_details.schedule_date BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND route.status = 1
                        AND route.id = " . $allRoute->id . ";");

                        $lastKey = array_key_last($allTrips);
                        $count = 0;
                        foreach($allTrips as $key => $allTrip){
                            $out->writeln("New Loop: " . $key);
                            $found = false;

                            if(property_exists($allTrip, 'route_name') || property_exists($allTrip, 'route_name_in')){
                                $out->writeln("ROUTE: " .  $allTrip->route_number . " TRIP CODE: " .  $allTrip->trip_code);
                                if($allTrip->trip_code==1){
                                    $out->writeln("Edit route name inbound");
                                    $allTrip->route_name = implode(" - ", array_reverse(explode("-", $allTrip->route_name_in)));
                                }
                                foreach($tripPlanned as $key2 => $tripPlan){
                                    if($tripPlan->route_number == $allTrip->route_number){
                                        if($tripPlan->trip_code == $allTrip->trip_code){
                                            $allTrip->trip_planned = $tripPlan->trip_planned;
                                            $allTrip->km_planned = $tripPlan->km_planned;

                                            $found = true;
                                            break ;
                                        }
                                    }
                                }
                                if(!$found){
                                    $allTrip->trip_planned = 0;
                                    $allTrip->km_planned = 0;
                                }

                                //Previous highest ridership and sales
                                $prevDataSQL = DB::select("SELECT
                                SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                                SUM(total_adult) + SUM(total_concession) AS ridership
                                FROM trip_details
                                JOIN mybas.route ON route.id = trip_details.route_id
                                WHERE trip_details.start_trip BETWEEN '" . $previousStartMonth . "' AND '" . $previousEndMonth . "'
                                AND route.route_number = '" . $allTrip->route_number . "'
                                AND trip_details.trip_code = '" . $allTrip->trip_code . "'
                                GROUP BY route.id;");

                                if(count($prevDataSQL)>0){
                                    foreach($prevDataSQL as $prevKey => $prevData){
                                        $allTrip->prev_ridership = $prevData->ridership;
                                        //Increment ridership inbound collection (%)
                                        if($prevData->ridership==0){
                                            if($allTrip->ridership==0){
                                                $allTrip->increase_ridership = 0;
                                            }else{
                                                $allTrip->increase_ridership = 100;
                                            }
                                        }else{
                                            if($allTrip->ridership==0){
                                                $allTrip->increase_ridership = -100;
                                            }else{
                                                $increaseRidership = (($allTrip->ridership - $prevData->ridership) / $prevData->ridership) * 100;
                                                $allTrip->increase_ridership = number_format((float)$increaseRidership, 2, '.', '');
                                            }
                                        }

                                        $allTrip->prev_farebox = $prevData->farebox;
                                        //Increment farebox inbound collection (%)
                                        if($prevData->farebox==0){
                                            if($allTrip->farebox==0){
                                                $allTrip->increase_farebox = 0;
                                            }else{
                                                $allTrip->increase_farebox = 100;
                                            }
                                        }else{
                                            if($allTrip->farebox==0){
                                                $allTrip->increase_farebox = -100;
                                            }else{
                                                $increaseSales = (($allTrip->farebox - $prevData->farebox) / $prevData->farebox) * 100;
                                                $allTrip->increase_farebox = number_format((float)$increaseSales, 2, '.', '');
                                            }
                                        }
                                    }
                                }else{
                                    $allTrip->prev_ridership = 0;
                                    if($allTrip->ridership==0){
                                        $allTrip->increase_ridership = 0;
                                    }else{
                                        $allTrip->increase_ridership = 100;
                                    }

                                    $allTrip->prev_farebox = 0.00;
                                    if($allTrip->farebox==0){
                                        $allTrip->increase_farebox = 0;
                                    }else{
                                        $allTrip->increase_farebox = 100;
                                    }
                                }
                            }elseif(!property_exists($allTrip, 'route_name') && property_exists($allTrip, 'route_number')){
                                $out->writeln("TOTAL ROUTE: " .  $allTrip->route_number );
                                foreach($tripPlannedRoute as $key3 => $tripPlan){
                                    if($tripPlan->route_number == $allTrip->route_number){
                                        $allTrip->trip_planned = $tripPlan->trip_planned;
                                        $allTrip->km_planned = $tripPlan->km_planned;

                                        $found = true;
                                        break ;
                                    }
                                }
                                if(!$found){
                                    $allTrip->trip_planned = 0;
                                    $allTrip->km_planned = 0;
                                }

                                //Previous highest ridership and sales
                                $prevDataSQL = DB::select("SELECT
                                SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                                SUM(total_adult) + SUM(total_concession) AS ridership
                                FROM trip_details
                                JOIN mybas.route ON route.id = trip_details.route_id
                                WHERE trip_details.start_trip BETWEEN '" . $previousStartMonth . "' AND '" . $previousEndMonth . "'
                                AND route.route_number = '" . $allTrip->route_number . "'
                                GROUP BY route.id;");

                                if(count($prevDataSQL)>0){
                                    foreach($prevDataSQL as $prevKey => $prevData){
                                        $allTrip->prev_ridership = $prevData->ridership;
                                        //Increment ridership inbound collection (%)
                                        if($prevData->ridership==0){
                                            if($allTrip->ridership==0){
                                                $allTrip->increase_ridership = 0;
                                            }else{
                                                $allTrip->increase_ridership = 100;
                                            }
                                        }else{
                                            if($allTrip->ridership==0){
                                                $allTrip->increase_ridership = -100;
                                            }else{
                                                $increaseRidership = (($allTrip->ridership - $prevData->ridership) / $prevData->ridership) * 100;
                                                $allTrip->increase_ridership = number_format((float)$increaseRidership, 2, '.', '');
                                            }
                                        }

                                        $allTrip->prev_farebox = $prevData->farebox;
                                        //Increment farebox inbound collection (%)
                                        if($prevData->farebox==0){
                                            if($allTrip->farebox==0){
                                                $allTrip->increase_farebox = 0;
                                            }else{
                                                $allTrip->increase_farebox = 100;
                                            }
                                        }else{
                                            if($allTrip->farebox==0){
                                                $allTrip->increase_farebox = -100;
                                            }else{
                                                $increaseSales = (($allTrip->farebox - $prevData->farebox) / $prevData->farebox) * 100;
                                                $allTrip->increase_farebox = number_format((float)$increaseSales, 2, '.', '');
                                            }
                                        }
                                    }
                                }else{
                                    $allTrip->prev_ridership = 0;
                                    if($allTrip->ridership==0){
                                        $allTrip->increase_ridership = 0;
                                    }else{
                                        $allTrip->increase_ridership = 100;
                                    }

                                    $allTrip->prev_farebox = 0.00;
                                    if($allTrip->farebox==0){
                                        $allTrip->increase_farebox = 0;
                                    }else{
                                        $allTrip->increase_farebox = 100;
                                    }
                                }
                            }else{
                                $out->writeln("IN GRAND");
                                foreach($tripPlannedGrand as $key4 => $tripPlan){
                                    $allTrip->trip_planned = $tripPlan->trip_planned;
                                    $allTrip->km_planned = $tripPlan->km_planned;

                                    $found = true;
                                    break ;
                                }
                                if(!$found){
                                    $allTrip->trip_planned = 0;
                                    $allTrip->km_planned = 0;
                                }

                                //Previous highest ridership and sales
                                $prevDataSQL = DB::select("SELECT
                                SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                                SUM(total_adult) + SUM(total_concession) AS ridership
                                FROM trip_details
                                JOIN mybas.route ON route.id = trip_details.route_id
                                WHERE trip_details.start_trip BETWEEN '" . $previousStartMonth . "' AND '" . $previousEndMonth . "'
                                AND route.status = 1
                                AND route.id = " . $allRoute->id . ";");

                                if(count($prevDataSQL)>0){
                                    foreach($prevDataSQL as $prevKey => $prevData){
                                        $allTrip->prev_ridership = $prevData->ridership;
                                        //Increment ridership inbound collection (%)
                                        if($prevData->ridership==0){
                                            if($allTrip->ridership==0){
                                                $allTrip->increase_ridership = 0;
                                            }else{
                                                $allTrip->increase_ridership = 100;
                                            }
                                        }else{
                                            if($allTrip->ridership==0){
                                                $allTrip->increase_ridership = -100;
                                            }else{
                                                $increaseRidership = (($allTrip->ridership - $prevData->ridership) / $prevData->ridership) * 100;
                                                $allTrip->increase_ridership = number_format((float)$increaseRidership, 2, '.', '');
                                            }
                                        }

                                        $allTrip->prev_farebox = $prevData->farebox;
                                        //Increment farebox inbound collection (%)
                                        if($prevData->farebox==0){
                                            if($allTrip->farebox==0){
                                                $allTrip->increase_farebox = 0;
                                            }else{
                                                $allTrip->increase_farebox = 100;
                                            }
                                        }else{
                                            if($allTrip->farebox==0){
                                                $allTrip->increase_farebox = -100;
                                            }else{
                                                $increaseSales = (($allTrip->farebox - $prevData->farebox) / $prevData->farebox) * 100;
                                                $allTrip->increase_farebox = number_format((float)$increaseSales, 2, '.', '');
                                            }
                                        }
                                    }
                                }else{
                                    $allTrip->prev_ridership = 0;
                                    if($allTrip->ridership==0){
                                        $allTrip->increase_ridership = 0;
                                    }else{
                                        $allTrip->increase_ridership = 100;
                                    }

                                    $allTrip->prev_farebox = 0.00;
                                    if($allTrip->farebox==0){
                                        $allTrip->increase_farebox = 0;
                                    }else{
                                        $allTrip->increase_farebox = 100;
                                    }
                                }    
                            }
                        }
                    }
                }
            }
            return Excel::download(new SPADRoute($allTrips, $networkArea, $validatedData['dateFrom'], $validatedData['dateTo']), 'Route_Report_SPAD_'.Carbon::now()->format('YmdHis').'.xlsx');
        }else{
            $this->dispatchBrowserEvent('company-required');
        }
    }

    public function printRouteOld()
    {
        $out = new ConsoleOutput();
        $out->writeln("YOU ARE IN printRoute()");

        $validatedData = Validator::make($this->state,[
            'dateFrom' => ['required', 'date'],
            'dateTo' => ['required', 'date'],
            'route_id' => ['required'],
        ])->validate();

        $dateFrom = new Carbon($validatedData['dateFrom']);
        $dateTo = new Carbon($validatedData['dateTo'] . '23:59:59');

        $prevStart = Carbon::create($validatedData['dateFrom'])->startOfMonth()->subMonthsNoOverflow()->toDateString();
        $prevEnd = Carbon::create($validatedData['dateTo'])->subMonthsNoOverflow()->endOfMonth()->toDateString();

        $previousStartMonth = new Carbon($prevStart);
        $previousEndMonth = new Carbon($prevEnd . '23:59:59');

        $startDate = new Carbon($validatedData['dateFrom']);
        $endDate = new Carbon($validatedData['dateTo']);
        $all_dates = array();

        while ($startDate->lte($endDate)){
            $all_dates[] = $startDate->toDateString();
            $startDate->addDay();
        }

        $routeSPAD = collect();
        $grandKMPlanned = 0;
        $grandKMServed = 0;
        $grandKMServedGPS = 0;
        $grandScheduledTrip = 0;
        $grandTripMade = 0;
        $grandPassenger = 0;
        $grandAdult = 0;
        $grandConcession = 0;
        $grandTotalOn = 0;
        $grandPrevPax = 0;
        $grandPrevPaxIncrease = 0;
        $grandPrevSales = 0;
        $grandPrevSalesIncrease = 0;
        $allRoutePaxIncrease = 0;
        $allRouteSalesIncrease = 0;
        if($this->selectedCompany){
            if($this->selectedCompany=='All'){
                $networkArea = 'ALL';
                if(!empty($validatedData['route_id'])) {
                    //Route all route all company
                    if($validatedData['route_id']=='All') {
                        $allRoutes = Route::orderBy('route_number')->get();
            
                        foreach ($allRoutes as $allRoute) {
                            //Scheduled Trips
                            //KM Planned In & Out
                            $schedules = RouteSchedulerDetail::whereBetween('schedule_date', [$dateFrom, $dateTo])->get();
                            $tripPlanned = 0;
                            $servicePlannedIn = 0;
                            $servicePlannedOut = 0;
                            foreach ($schedules as $schedule) {
                                if ($schedule->RouteScheduleMSTR->route_id == $allRoute->id) {
                                    $tripPlanned++;
                                    $servicePlannedIn += $schedule->RouteScheduleMSTR->Route->inbound_distance;
                                    $servicePlannedOut += $schedule->RouteScheduleMSTR->Route->outbound_distance;
                                }
                            }
            
                            //Inbound Trip
                            $allInboundTrips = TripDetail::where('route_id', $allRoute->id)
                                ->whereBetween('start_trip', [$dateFrom, $dateTo])
                                ->where('trip_code', 1)
                                ->get();
            
                            $tripMadeIn = 0;
                            $kmServedIn = 0;
                            $kmServedGPSIn = 0;
                            $totalAdultIn = 0;
                            $totalConcessionIn = 0;
                            $totalRidershipIn = 0;
                            $totalSalesIn = 0;
                            $routeNameIn = $allRoute->route_name;
            
                            if (count($allInboundTrips) > 0) {
                                foreach ($allInboundTrips as $allInboundTrip) {
                                    $tripMadeIn++;
                                    $kmServedIn += $allInboundTrip->Route->inbound_distance;
                                    $kmServedGPSIn += $allInboundTrip->Route->inbound_distance;
            
                                    $adult = $allInboundTrip->total_adult;
                                    $concession = $allInboundTrip->total_concession;
                                    $sum = $adult + $concession;
            
                                    $adultSales = $allInboundTrip->total_adult_amount;
                                    $concessionSales = $allInboundTrip->total_concession_amount;
                                    $sumSales = $adultSales + $concessionSales;
            
                                    //Check tickets if sumRidership==0 || sumSales==0 
                                    $checkTickets = TicketSalesTransaction::where('trip_number', $allInboundTrip->trip_number)->get();
                                    if($sum==0 || $sumSales==0){
                                        if(count($checkTickets)>0){
                                            $adult = 0;
                                            $concession = 0;
                                            $sum = 0;
                                            $sumSales = 0;
                                            foreach($checkTickets as $checkTicket){
                                                if($checkTicket->passenger_type==0){
                                                    $adult++;
                                                }
                                                elseif($checkTicket->passenger_type==1){
                                                    $concession++;
                                                }
                                                $sumSales += $checkTicket->actual_amount;
                                            }
                                            $sum = $adult + $concession;
                                        }
                                    }
            
                                    $totalAdultIn += $adult;
                                    $totalConcessionIn += $concession;
                                    $totalRidershipIn += $sum;
                                    $totalSalesIn += $sumSales;
                                }
                            }
            
                            //Previous Month Ridership Inbound collection
                            $prevTripsIn = TripDetail::whereBetween('start_trip', [$previousStartMonth, $previousEndMonth])
                                ->where('route_id', $allRoute->id)
                                ->where('trip_code', 1)
                                ->get();
            
                            $prevRidershipIn = 0;
                            $prevSalesIn = 0;
            
                            if (count($prevTripsIn) > 0) {
                                foreach ($prevTripsIn as $prevTripIn) {
                                    $adult = $prevTripIn->total_adult;
                                    $concession = $prevTripIn->total_concession;
                                    $sumRidership = $adult + $concession;
                                    $prevRidershipIn += $sumRidership;
            
                                    $adultSales = $prevTripIn->total_adult_amount;
                                    $concessionSales = $prevTripIn->total_concession_amount;
                                    $sumSales = $adultSales + $concessionSales;
                                    $prevSalesIn += $sumSales;
                                }
                                //Increment ridership inbound collection (%)
                                if($prevRidershipIn==0){
                                    if($totalRidershipIn==0){
                                        $increaseRidershipFormatIn = 0;
                                    }else{
                                        $increaseRidershipFormatIn = 100;
                                    }
                                }else{
                                    if($totalRidershipIn==0){
                                        $increaseRidershipFormatIn = -100;
                                    }else{
                                        $increaseRidershipIn = (($totalRidershipIn - $prevRidershipIn) / $prevRidershipIn) * 100;
                                        $increaseRidershipFormatIn = number_format((float)$increaseRidershipIn, 2, '.', '');
                                    }
                                }
            
                                //Increment farebox inbound collection (%)
                                if($prevSalesIn==0){
                                    if($totalSalesIn==0){
                                        $increaseSalesFormatIn = 0;
                                    }else{
                                        $increaseSalesFormatIn = 100;
                                    }
                                }else{
                                    if($totalSalesIn==0){
                                        $increaseSalesFormatIn = -100;
                                    }else{
                                        $increaseSalesIn = (($totalSalesIn - $prevSalesIn) / $prevSalesIn) * 100;
                                        $increaseSalesFormatIn = number_format((float)$increaseSalesIn, 2, '.', '');
                                    }
                                }
                            } else {
                                $increaseRidershipFormatIn = 100;
                                $increaseSalesFormatIn = 100;
                            }
                            $inbound['route_name'] = $routeNameIn;
                            $inbound['num_km_planned'] = $servicePlannedIn;
                            $inbound['num_km_served'] = $kmServedIn;
                            $inbound['num_km_served_gps'] = $kmServedGPSIn;
                            $inbound['num_scheduled_trip'] = $tripPlanned;
                            $inbound['num_trip_made'] = $tripMadeIn;
                            $inbound['count_passenger_board'] = $totalRidershipIn;
                            $inbound['num_adult'] = $totalAdultIn;
                            $inbound['num_concession'] = $totalConcessionIn;
                            $inbound['total_on'] = $totalRidershipIn;
                            $inbound['total_pax'] = $prevRidershipIn;
                            $inbound['total_pax_increase'] = $increaseRidershipFormatIn;
                            $inbound['total_sales'] = $prevSalesIn;
                            $inbound['total_sales_increase'] = $increaseSalesFormatIn;
            
                            //Outbound Trip
                            $allOutboundTrips = TripDetail::where('route_id', $allRoute->id)
                                ->whereBetween('start_trip', [$dateFrom, $dateTo])
                                ->where('trip_code', 0)
                                ->get();
            
                            $tripMadeOut = 0;
                            $kmServedOut = 0;
                            $kmServedGPSOut = 0;
                            $totalAdultOut = 0;
                            $totalConcessionOut = 0;
                            $totalRidershipOut = 0;
                            $totalSalesOut = 0;
                            $routeNameOut = implode(" - ", array_reverse(explode(" - ", $routeNameIn)));
            
                            if (count($allOutboundTrips) > 0) {
                                foreach ($allOutboundTrips as $allOutboundTrip) {
                                    $tripMadeOut++;
                                    $kmServedOut += $allOutboundTrip->Route->outbound_distance;
                                    $kmServedGPSOut += $allOutboundTrip->Route->outbound_distance;
            
                                    $adult = $allOutboundTrip->total_adult;
                                    $concession = $allOutboundTrip->total_concession;
                                    $sumRidership = $adult + $concession;
            
                                    $adultSales = $allOutboundTrip->total_adult_amount;
                                    $concessionSales = $allOutboundTrip->total_concession_amount;
                                    $sumSales = $adultSales + $concessionSales;
            
                                    //Check tickets if sumRidership==0 || sumSales==0 
                                    $checkTickets = TicketSalesTransaction::where('trip_number', $allOutboundTrip->trip_number)->get();
                                    if($sumRidership==0 || $sumSales==0){
                                        if(count($checkTickets)>0){
                                            $adult = 0;
                                            $concession = 0;
                                            $sumRidership = 0;
                                            $sumSales = 0;
                                            foreach($checkTickets as $checkTicket){
                                                if($checkTicket->passenger_type==0){
                                                    $adult++;
                                                }
                                                elseif($checkTicket->passenger_type==1){
                                                    $concession++;
                                                }
                                                $sumSales += $checkTicket->actual_amount;
                                            }
                                            $sumRidership = $adult + $concession;
                                        }
                                    }
            
                                    $totalAdultOut += $adult;
                                    $totalConcessionOut += $concession;
                                    $totalRidershipOut += $sumRidership;
                                    $totalSalesOut += $sumSales;
                                }
                            }
            
                            //Previous Month Ridership Outbound collection
                            $prevTripsOut = TripDetail::whereBetween('start_trip', [$previousStartMonth, $previousEndMonth])
                                ->where('route_id', $allRoute->id)
                                ->where('trip_code', 0)
                                ->get();
            
                            $prevRidershipOut = 0;
                            $prevSalesOut = 0;
                            if (count($prevTripsOut) > 0) {
                                foreach ($prevTripsOut as $prevTripOut) {
                                    $adult = $prevTripOut->total_adult;
                                    $concession = $prevTripOut->total_concession;
                                    $sumRidership = $adult + $concession;
                                    $prevRidershipOut += $sumRidership;
            
                                    $adultSales = $prevTripOut->total_adult_amount;
                                    $concessionSales = $prevTripOut->total_concession_amount;
                                    $sumSales = $adultSales + $concessionSales;
                                    $prevSalesOut += $sumSales;
                                }
                                //Increment ridership outbound collection (%)
                                if($prevRidershipOut==0){
                                    if($totalRidershipOut==0){
                                        $increaseRidershipFormatOut = 0;
                                    }else{
                                        $increaseRidershipFormatOut  = 100;
                                    }
                                }else{
                                    if($totalRidershipOut==0){
                                        $increaseRidershipFormatOut = -100;
                                    }else{
                                        $increaseRidershipOut = (($totalRidershipOut - $prevRidershipOut) / $prevRidershipOut) * 100;
                                        $increaseRidershipFormatOut = number_format((float)$increaseRidershipOut, 2, '.', '');
                                    }
                                }
            
                                //Increment farebox outbound collection (%)
                                if($prevSalesOut==0){
                                    if($totalSalesOut==0){
                                        $increaseSalesFormatOut = 0;
                                    }else{
                                        $increaseSalesFormatOut = 100;
                                    }
                                }else{
                                    if($totalSalesOut==0){
                                        $increaseSalesFormatOut = -100;
                                    }else{
                                        $increaseSalesOut = (($totalSalesOut - $prevSalesOut) / $prevSalesOut) * 100;
                                        $increaseSalesFormatOut = number_format((float)$increaseSalesOut, 2, '.', '');
                                    }
                                }
                            } else {
                                $increaseRidershipFormatOut = 100;
                                $increaseSalesFormatOut = 100;
                            }
            
                            $outbound['route_name'] = $routeNameOut;
                            $outbound['num_km_planned'] = $servicePlannedOut;
                            $outbound['num_km_served'] = $kmServedOut;
                            $outbound['num_km_served_gps'] = $kmServedGPSOut;
                            $outbound['num_scheduled_trip'] = $tripPlanned;
                            $outbound['num_trip_made'] = $tripMadeOut;
                            $outbound['count_passenger_board'] = $totalRidershipOut;
                            $outbound['num_adult'] = $totalAdultOut;
                            $outbound['num_concession'] = $totalConcessionOut;
                            $outbound['total_on'] = $totalRidershipOut;
                            $outbound['total_pax'] = $prevRidershipOut;
                            $outbound['total_pax_increase'] = $increaseRidershipFormatOut;
                            $outbound['total_sales'] = $prevSalesOut;
                            $outbound['total_sales_increase'] = $increaseSalesFormatOut;
            
                            $total['tot_num_km_planned'] = $inbound['num_km_planned'] + $outbound['num_km_planned'];
                            $total['tot_num_km_served'] = $inbound['num_km_served'] + $outbound['num_km_served'];
                            $total['tot_num_km_served_gps'] = $inbound['num_km_served_gps'] + $outbound['num_km_served_gps'];
                            $total['tot_num_scheduled_trip'] = $inbound['num_scheduled_trip'] + $outbound['num_scheduled_trip'];
                            $total['tot_num_trip_made'] = $inbound['num_trip_made'] + $outbound['num_trip_made'];
                            $total['tot_count_passenger_board'] = $inbound['count_passenger_board'] + $outbound['count_passenger_board'];
                            $total['tot_num_adult'] = $inbound['num_adult'] + $outbound['num_adult'];
                            $total['tot_num_concession'] = $inbound['num_concession'] + $outbound['num_concession'];
                            $total['tot_total_on'] = $inbound['total_on'] + $outbound['total_on'];
                            $total['tot_total_pax'] = $inbound['total_pax'] + $outbound['total_pax'];
            
                            //total_pax_increase
                            $sumtotalPaxIncrease = $inbound['total_pax_increase'] + $outbound['total_pax_increase'];
                            $calcPaxIncrease = ($sumtotalPaxIncrease/200)*100;
                            $calcPaxIncreaseFormat = round($calcPaxIncrease, 2);
                            $total['tot_total_pax_increase'] = $calcPaxIncreaseFormat;
            
                            $total['tot_total_sales'] = $inbound['total_sales'] + $outbound['total_sales'];
            
                            //total_sales_increase
                            $sumtotalSalesIncrease =  $inbound['total_sales_increase'] + $outbound['total_sales_increase'];
                            $calcSalesIncrease = ($sumtotalSalesIncrease/200)*100;
                            $calcSalesIncreaseFormat = round($calcSalesIncrease, 2);
                            $total['tot_total_sales_increase'] = $calcSalesIncreaseFormat;
            
                            $grandKMPlanned += $total['tot_num_km_planned'];
                            $grandKMServed += $total['tot_num_km_served'];
                            $grandKMServedGPS += $total['tot_num_km_served_gps'];
                            $grandScheduledTrip += $total['tot_num_scheduled_trip'];
                            $grandTripMade += $total['tot_num_trip_made'];
                            $grandPassenger += $total['tot_count_passenger_board'];
                            $grandAdult += $total['tot_num_adult'];
                            $grandConcession += $total['tot_num_concession'];
                            $grandTotalOn += $total['tot_total_on'];
                            $grandPrevPax += $total['tot_total_pax'];
                            $grandPrevPaxIncrease += $total['tot_total_pax_increase'];
                            $grandPrevSales += $total['tot_total_sales'];
                            $grandPrevSalesIncrease += $total['tot_total_sales_increase'];
                            $allRoutePaxIncrease += 100;
                            $allRouteSalesIncrease += 100;
            
                            $perRoute['inbound'] = $inbound;
                            $perRoute['outbound'] = $outbound;
                            $perRoute['total'] = $total;
                            $data[$allRoute->route_number] = $perRoute;
                        }
                        $grand['grand_num_km_planned'] = $grandKMPlanned;
                        $grand['grand_num_km_served'] = $grandKMServed;
                        $grand['grand_num_km_served_gps'] = $grandKMServedGPS;
                        $grand['grand_num_scheduled_trip'] = $grandScheduledTrip;
                        $grand['grand_num_trip_made'] = $grandTripMade;
                        $grand['grand_count_passenger_board'] = $grandPassenger;
                        $grand['grand_num_adult'] = $grandAdult;
                        $grand['grand_num_concession'] = $grandConcession;
                        $grand['grand_total_on'] = $grandTotalOn;
                        $grand['grand_total_pax'] =  $grandPrevPax;
            
                        //grand_pax_increase
                        $calcGrandPaxIncrease = ($grandPrevPaxIncrease/$allRoutePaxIncrease)*100;
                        $calcGrandPaxIncreaseFormat = number_format((float)$calcGrandPaxIncrease, 2, '.', '');
                        $grand['grand_total_pax_increase'] = $calcGrandPaxIncreaseFormat;
            
                        $grand['grand_total_sales'] = $grandPrevSales;
            
                        //grand_sales_increase
                        $calcGrandSalesIncrease = ($grandPrevSalesIncrease/$allRouteSalesIncrease)*100;
                        $calcGrandSalesIncreaseFormat = number_format((float)$calcGrandSalesIncrease, 2, '.', '');
                        $grand['grand_total_sales_increase'] = $calcGrandSalesIncreaseFormat;
            
                        $data['grand'] = $grand;
                        $routeSPAD->add($data);
                    }
                }
            }else{
                $selectedCompany = Company::where('id', $this->selectedCompany)->first();
                $networkArea = $selectedCompany->company_name;

                if(!empty($validatedData['route_id'])) {
                    //Route all route specific company
                    if($validatedData['route_id']=='All'){
                        $routeByCompanies = Route::where('company_id', $this->selectedCompany)->orderBy('route_number')->get();
        
                        foreach ($routeByCompanies as $routeByCompany) {
                            //Scheduled Trips
                            //KM Planned In & Out
                            $schedules = RouteSchedulerDetail::whereBetween('schedule_date', [$dateFrom, $dateTo])->get();
                            $tripPlanned = 0;
                            $servicePlannedIn = 0;
                            $servicePlannedOut = 0;
                            foreach ($schedules as $schedule) {
                                if ($schedule->RouteScheduleMSTR->route_id == $routeByCompany->id) {
                                    $tripPlanned++;
                                    $servicePlannedIn += $schedule->RouteScheduleMSTR->Route->inbound_distance;
                                    $servicePlannedOut += $schedule->RouteScheduleMSTR->Route->outbound_distance;
                                }
                            }
        
                            //Inbound Trip
                            $allInboundTrips = TripDetail::where('route_id', $routeByCompany->id)
                                ->whereBetween('start_trip', [$dateFrom, $dateTo])
                                ->where('trip_code', 1)
                                ->get();
        
                            $tripMadeIn = 0;
                            $kmServedIn = 0;
                            $kmServedGPSIn = 0;
                            $totalAdultIn = 0;
                            $totalConcessionIn = 0;
                            $totalRidershipIn = 0;
                            $totalSalesIn = 0;
                            $routeNameIn = $routeByCompany->route_name;
                            if (count($allInboundTrips) > 0) {
                                foreach ($allInboundTrips as $allInboundTrip) {
                                    $tripMadeIn++;
                                    $kmServedIn += $allInboundTrip->Route->inbound_distance;
                                    $kmServedGPSIn += $allInboundTrip->Route->inbound_distance;
        
                                    $adult = $allInboundTrip->total_adult;
                                    $concession = $allInboundTrip->total_concession;
                                    $sum = $adult + $concession;
        
                                    $adultSales = $allInboundTrip->total_adult_amount;
                                    $concessionSales = $allInboundTrip->total_concession_amount;
                                    $sumSales = $adultSales + $concessionSales;
        
                                    //Check tickets if sumRidership==0 || sumSales==0 
                                    $checkTickets = TicketSalesTransaction::where('trip_number', $allInboundTrip->trip_number)->get();
                                    if($sum==0 || $sumSales==0){
                                        if(count($checkTickets)>0){
                                            $adult = 0;
                                            $concession = 0;
                                            $sum = 0;
                                            $sumSales = 0;
                                            foreach($checkTickets as $checkTicket){
                                                if($checkTicket->passenger_type==0){
                                                    $adult++;
                                                }
                                                elseif($checkTicket->passenger_type==1){
                                                    $concession++;
                                                }
                                                $sumSales += $checkTicket->actual_amount;
                                            }
                                            $sum = $adult + $concession;
                                        }
                                    }
        
                                    $totalAdultIn += $adult;
                                    $totalConcessionIn += $concession;
                                    $totalRidershipIn += $sum;
                                    $totalSalesIn += $sumSales;
                                }
                            }
        
                            //Previous Month Ridership Inbound collection
                            $prevTripsIn = TripDetail::whereBetween('start_trip', [$previousStartMonth, $previousEndMonth])
                                ->where('route_id', $routeByCompany->id)
                                ->where('trip_code', 1)
                                ->get();
        
                            $prevRidershipIn = 0;
                            $prevSalesIn = 0;
        
                            if (count($prevTripsIn) > 0) {
                                foreach ($prevTripsIn as $prevTripIn) {
                                    $adult = $prevTripIn->total_adult;
                                    $concession = $prevTripIn->total_concession;
                                    $sumRidership = $adult + $concession;
                                    $prevRidershipIn += $sumRidership;
        
                                    $adultSales = $prevTripIn->total_adult_amount;
                                    $concessionSales = $prevTripIn->total_concession_amount;
                                    $sumSales = $adultSales + $concessionSales;
                                    $prevSalesIn += $sumSales;
                                }
                                //Increment ridership inbound collection (%)
                                if($prevRidershipIn==0){
                                    if($totalRidershipIn==0){
                                        $increaseRidershipFormatIn = 0;
                                    }else{
                                        $increaseRidershipFormatIn = 100;
                                    }
                                }else{
                                    if($totalRidershipIn==0){
                                        $increaseRidershipFormatIn = -100;
                                    }else{
                                        $increaseRidershipIn = (($totalRidershipIn - $prevRidershipIn) / $prevRidershipIn) * 100;
                                        $increaseRidershipFormatIn = number_format((float)$increaseRidershipIn, 2, '.', '');
                                    }
                                }
        
                                //Increment farebox inbound collection (%)
                                if($prevSalesIn==0){
                                    if($totalSalesIn==0){
                                        $increaseSalesFormatIn = 0;
                                    }else{
                                        $increaseSalesFormatIn = 100;
                                    }
                                }else{
                                    if($totalSalesIn==0){
                                        $increaseSalesFormatIn = -100;
                                    }else{
                                        $increaseSalesIn = (($totalSalesIn - $prevSalesIn) / $prevSalesIn) * 100;
                                        $increaseSalesFormatIn = number_format((float)$increaseSalesIn, 2, '.', '');
                                    }
                                }
                            }else{
                                $increaseRidershipFormatIn = 100;
                                $increaseSalesFormatIn = 100;
                            }
                            $inbound['route_name'] = $routeNameIn;
                            $inbound['num_km_planned'] = $servicePlannedIn;
                            $inbound['num_km_served'] = $kmServedIn;
                            $inbound['num_km_served_gps'] = $kmServedGPSIn;
                            $inbound['num_scheduled_trip'] = $tripPlanned;
                            $inbound['num_trip_made'] = $tripMadeIn;
                            $inbound['count_passenger_board'] = $totalRidershipIn;
                            $inbound['num_adult'] = $totalAdultIn;
                            $inbound['num_concession'] = $totalConcessionIn;
                            $inbound['total_on'] = $totalRidershipIn;
                            $inbound['total_pax'] = $prevRidershipIn;
                            $inbound['total_pax_increase'] = $increaseRidershipFormatIn;
                            $inbound['total_sales'] = $prevSalesIn;
                            $inbound['total_sales_increase'] = $increaseSalesFormatIn;
        
                            //Outbound Trip
                            $allOutboundTrips = TripDetail::where('route_id', $routeByCompany->id)
                                ->whereBetween('start_trip', [$dateFrom, $dateTo])
                                ->where('trip_code', 0)
                                ->get();
        
                            $tripMadeOut = 0;
                            $kmServedOut = 0;
                            $kmServedGPSOut = 0;
                            $totalAdultOut = 0;
                            $totalConcessionOut = 0;
                            $totalRidershipOut = 0;
                            $totalSalesOut = 0;
                            $routeNameOut = implode(" - ", array_reverse(explode(" - ", $routeNameIn)));
                            if (count($allOutboundTrips) > 0) {
                                foreach ($allOutboundTrips as $allOutboundTrip) {
                                    $tripMadeOut++;
                                    $kmServedOut += $allOutboundTrip->Route->outbound_distance;
                                    $kmServedGPSOut += $allOutboundTrip->Route->outbound_distance;
        
                                    $adult = $allOutboundTrip->total_adult;
                                    $concession = $allOutboundTrip->total_concession;
                                    $sumRidership = $adult + $concession;
        
                                    $adultSales = $allOutboundTrip->total_adult_amount;
                                    $concessionSales = $allOutboundTrip->total_concession_amount;
                                    $sumSales = $adultSales + $concessionSales;
        
                                    //Check tickets if sumRidership==0 || sumSales==0 
                                    $checkTickets = TicketSalesTransaction::where('trip_number', $allOutboundTrip->trip_number)->get();
                                    if($sumRidership==0 || $sumSales==0){
                                        if(count($checkTickets)>0){
                                            $adult = 0;
                                            $concession = 0;
                                            $sumRidership = 0;
                                            $sumSales = 0;
                                            foreach($checkTickets as $checkTicket){
                                                if($checkTicket->passenger_type==0){
                                                    $adult++;
                                                }
                                                elseif($checkTicket->passenger_type==1){
                                                    $concession++;
                                                }
                                                $sumSales += $checkTicket->actual_amount;
                                            }
                                            $sumRidership = $adult + $concession;
                                        }
                                    }
        
                                    $totalAdultOut += $adult;
                                    $totalConcessionOut += $concession;
                                    $totalRidershipOut += $sumRidership;
                                    $totalSalesOut += $sumSales;
                                }
                            }
        
                            //Previous Month Ridership Outbound collection
                            $prevTripsOut = TripDetail::whereBetween('start_trip', [$previousStartMonth, $previousEndMonth])
                                ->where('route_id', $routeByCompany->id)
                                ->where('trip_code', 0)
                                ->get();
        
                            $prevRidershipOut = 0;
                            $prevSalesOut = 0;
                            if (count($prevTripsOut) > 0) {
                                foreach ($prevTripsOut as $prevTripOut) {
                                    $adult = $prevTripOut->total_adult;
                                    $concession = $prevTripOut->total_concession;
                                    $sumRidership = $adult + $concession;
                                    $prevRidershipOut += $sumRidership;
        
                                    $adultSales = $prevTripOut->total_adult_amount;
                                    $concessionSales = $prevTripOut->total_concession_amount;
                                    $sumSales = $adultSales + $concessionSales;
                                    $prevSalesOut += $sumSales;
                                }
                                //Increment ridership outbound collection (%)
                                if($prevRidershipOut==0){
                                    if($totalRidershipOut==0){
                                        $increaseRidershipFormatOut = 0;
                                    }else{
                                        $increaseRidershipFormatOut = 100;
                                    }
                                }else{
                                    if($totalRidershipOut==0){
                                        $increaseRidershipFormatOut = -100;
                                    }else{
                                        $increaseRidershipOut = (($totalRidershipOut - $prevRidershipOut) / $prevRidershipOut) * 100;
                                        $increaseRidershipFormatOut = number_format((float)$increaseRidershipOut, 2, '.', '');
                                    }
                                }
        
                                //Increment farebox outbound collection (%)
                                if($prevSalesOut==0){
                                    if($totalSalesOut==0){
                                        $increaseSalesFormatOut = 0;
                                    }else{
                                        $increaseSalesFormatOut = 100;
                                    }
                                }else{
                                    if($totalSalesOut==0){
                                        $increaseSalesFormatOut = -100;
                                    }else{
                                        $increaseSalesOut = (($totalSalesOut - $prevSalesOut) / $prevSalesOut) * 100;
                                        $increaseSalesFormatOut = number_format((float)$increaseSalesOut, 2, '.', '');
                                    }
                                }
                            } else {
                                $increaseRidershipFormatOut = 100;
                                $increaseSalesFormatOut = 100;
                            }
        
                            $outbound['route_name'] = $routeNameOut;
                            $outbound['num_km_planned'] = $servicePlannedOut;
                            $outbound['num_km_served'] = $kmServedOut;
                            $outbound['num_km_served_gps'] = $kmServedGPSOut;
                            $outbound['num_scheduled_trip'] = $tripPlanned;
                            $outbound['num_trip_made'] = $tripMadeOut;
                            $outbound['count_passenger_board'] = $totalRidershipOut;
                            $outbound['num_adult'] = $totalAdultOut;
                            $outbound['num_concession'] = $totalConcessionOut;
                            $outbound['total_on'] = $totalRidershipOut;
                            $outbound['total_pax'] = $prevRidershipOut;
                            $outbound['total_pax_increase'] = $increaseRidershipFormatOut;
                            $outbound['total_sales'] = $prevSalesOut;
                            $outbound['total_sales_increase'] = $increaseSalesFormatOut;
        
                            $total['tot_num_km_planned'] = $inbound['num_km_planned'] + $outbound['num_km_planned'];
                            $total['tot_num_km_served'] = $inbound['num_km_served'] + $outbound['num_km_served'];
                            $total['tot_num_km_served_gps'] = $inbound['num_km_served_gps'] + $outbound['num_km_served_gps'];
                            $total['tot_num_scheduled_trip'] = $inbound['num_scheduled_trip'] + $outbound['num_scheduled_trip'];
                            $total['tot_num_trip_made'] = $inbound['num_trip_made'] + $outbound['num_trip_made'];
                            $total['tot_count_passenger_board'] = $inbound['count_passenger_board'] + $outbound['count_passenger_board'];
                            $total['tot_num_adult'] = $inbound['num_adult'] + $outbound['num_adult'];
                            $total['tot_num_concession'] = $inbound['num_concession'] + $outbound['num_concession'];
                            $total['tot_total_on'] = $inbound['total_on'] + $outbound['total_on'];
                            $total['tot_total_pax'] = $inbound['total_pax'] + $outbound['total_pax'];
        
                            //total_pax_increase
                            $sumtotalPaxIncrease = $inbound['total_pax_increase'] + $outbound['total_pax_increase'];
                            $calcPaxIncrease = ($sumtotalPaxIncrease/200)*100;
                            $calcPaxIncreaseFormat = round($calcPaxIncrease, 2);
                            $total['tot_total_pax_increase'] = $calcPaxIncreaseFormat;
        
                            $total['tot_total_sales'] = $inbound['total_sales'] + $outbound['total_sales'];
        
                            //total_sales_increase
                            $sumtotalSalesIncrease =  $inbound['total_sales_increase'] + $outbound['total_sales_increase'];
                            $calcSalesIncrease = ($sumtotalSalesIncrease/200)*100;
                            $calcSalesIncreaseFormat = round($calcSalesIncrease, 2);
                            $total['tot_total_sales_increase'] = $calcSalesIncreaseFormat;
        
                            $grandKMPlanned += $total['tot_num_km_planned'];
                            $grandKMServed += $total['tot_num_km_served'];
                            $grandKMServedGPS += $total['tot_num_km_served_gps'];
                            $grandScheduledTrip += $total['tot_num_scheduled_trip'];
                            $grandTripMade += $total['tot_num_trip_made'];
                            $grandPassenger += $total['tot_count_passenger_board'];
                            $grandAdult += $total['tot_num_adult'];
                            $grandConcession += $total['tot_num_concession'];
                            $grandTotalOn += $total['tot_total_on'];
                            $grandPrevPax += $total['tot_total_pax'];
                            $grandPrevPaxIncrease += $total['tot_total_pax_increase'];
                            $grandPrevSales += $total['tot_total_sales'];
                            $grandPrevSalesIncrease += $total['tot_total_sales_increase'];
                            $allRoutePaxIncrease += 100;
                            $allRouteSalesIncrease += 100;
        
                            $perRoute['inbound'] = $inbound;
                            $perRoute['outbound'] = $outbound;
                            $perRoute['total'] = $total;
                            $data[$routeByCompany->route_number] = $perRoute;
                        }
                        $grand['grand_num_km_planned'] = $grandKMPlanned;
                        $grand['grand_num_km_served'] = $grandKMServed;
                        $grand['grand_num_km_served_gps'] = $grandKMServedGPS;
                        $grand['grand_num_scheduled_trip'] = $grandScheduledTrip;
                        $grand['grand_num_trip_made'] = $grandTripMade;
                        $grand['grand_count_passenger_board'] = $grandPassenger;
                        $grand['grand_num_adult'] = $grandAdult;
                        $grand['grand_num_concession'] = $grandConcession;
                        $grand['grand_total_on'] = $grandTotalOn;
                        $grand['grand_total_pax'] =  $grandPrevPax;
        
                        //grand_pax_increase
                        $calcGrandPaxIncrease = ($grandPrevPaxIncrease/$allRoutePaxIncrease)*100;
                        $calcGrandPaxIncreaseFormat = number_format((float)$calcGrandPaxIncrease, 2, '.', '');
                        $grand['grand_total_pax_increase'] = $calcGrandPaxIncreaseFormat;
        
                        $grand['grand_total_sales'] = $grandPrevSales;
        
                        //grand_sales_increase
                        $calcGrandSalesIncrease = ($grandPrevSalesIncrease/$allRouteSalesIncrease)*100;
                        $calcGrandSalesIncreaseFormat = number_format((float)$calcGrandSalesIncrease, 2, '.', '');
                        $grand['grand_total_sales_increase'] = $calcGrandSalesIncreaseFormat;
        
                        $data['grand'] = $grand;
                        $routeSPAD->add($data);
                    }
                    //Route specific route specific company
                    else{
                        $selectedRoute = Route::where('id', $validatedData['route_id'])->first();
        
                        //Scheduled Trips
                        //KM Planned In & Out
                        $schedules = RouteSchedulerDetail::whereBetween('schedule_date', [$dateFrom,$dateTo])->get();
                        $tripPlanned = 0;
                        $servicePlannedIn = 0;
                        $servicePlannedOut = 0;
                        foreach ($schedules as $schedule){
                            if($schedule->RouteScheduleMSTR->route_id == $validatedData['route_id']){
                                $tripPlanned++;
                                $servicePlannedIn += $schedule->RouteScheduleMSTR->Route->inbound_distance;
                                $servicePlannedOut += $schedule->RouteScheduleMSTR->Route->outbound_distance;
                            }
                        }
        
                        //Inbound Trip
                        $allInboundTrips = TripDetail::where('route_id', $selectedRoute->id)
                            ->whereBetween('start_trip', [$dateFrom,$dateTo])
                            ->where('trip_code',1)
                            ->get();
        
                        $tripMadeIn = 0;
                        $kmServedIn = 0;
                        $kmServedGPSIn = 0;
                        $totalAdultIn = 0;
                        $totalConcessionIn = 0;
                        $totalRidershipIn = 0;
                        $totalSalesIn = 0;
                        $routeNameIn = $selectedRoute->route_name;
                        if(count($allInboundTrips)>0) {
                            foreach ($allInboundTrips as $allInboundTrip) {
                                $tripMadeIn++;
                                $kmServedIn += $allInboundTrip->Route->inbound_distance;
                                $kmServedGPSIn += $allInboundTrip->Route->inbound_distance;
        
                                $adult = $allInboundTrip->total_adult;
                                $concession = $allInboundTrip->total_concession;
                                $sum = $adult + $concession;
        
                                $adultSales = $allInboundTrip->total_adult_amount;
                                $concessionSales = $allInboundTrip->total_concession_amount;
                                $sumSales = $adultSales + $concessionSales;
        
                                //Check tickets if sumRidership==0 || sumSales==0 
                                $checkTickets = TicketSalesTransaction::where('trip_number', $allInboundTrip->trip_number)->get();
                                if($sum==0 || $sumSales==0){
                                    if(count($checkTickets)>0){
                                        $adult = 0;
                                        $concession = 0;
                                        $sum = 0;
                                        $sumSales = 0;
                                        foreach($checkTickets as $checkTicket){
                                            if($checkTicket->passenger_type==0){
                                                $adult++;
                                            }
                                            elseif($checkTicket->passenger_type==1){
                                                $concession++;
                                            }
                                            $sumSales += $checkTicket->actual_amount;
                                        }
                                        $sum = $adult + $concession;
                                    }
                                }
        
                                $totalAdultIn += $adult;
                                $totalConcessionIn += $concession;
                                $totalRidershipIn += $sum;
                                $totalSalesIn += $sumSales;
                            }
                        }
        
                        //Previous Month Ridership Farebox Inbound collection
                        $prevTripsIn = TripDetail::whereBetween('start_trip', [$previousStartMonth, $previousEndMonth])
                            ->where('route_id', $selectedRoute->id)
                            ->where('trip_code',1)
                            ->get();
        
                        $prevRidershipIn = 0;
                        $prevSalesIn = 0;
        
                        if(count($prevTripsIn)>0) {
                            foreach ($prevTripsIn as $prevTripIn) {
                                $adult = $prevTripIn->total_adult;
                                $concession = $prevTripIn->total_concession;
                                $sumRidership = $adult + $concession;
                                $prevRidershipIn += $sumRidership;
        
                                $adultSales = $prevTripIn->total_adult_amount;
                                $concessionSales = $prevTripIn->total_concession_amount;
                                $sumSales = $adultSales + $concessionSales;
                                $prevSalesIn += $sumSales;
                            }
                            //Increment ridership outbound collection (%)
                            if($prevRidershipIn==0){
                                if($totalRidershipIn==0){
                                    $increaseRidershipFormatIn = 0;
                                }else{
                                    $increaseRidershipFormatIn = 100;
                                }
                            }else{
                                if($totalRidershipIn==0){
                                    $increaseRidershipFormatIn = -100;
                                }else{
                                    $increaseRidershipIn = (($totalRidershipIn - $prevRidershipIn) / $prevRidershipIn) * 100;
                                    $increaseRidershipFormatIn = number_format((float)$increaseRidershipIn, 2, '.', '');
                                }
                            }
        
                            //Increment farebox inbound collection (%)
                            if($prevSalesIn==0){
                                if($totalSalesIn==0){
                                    $increaseSalesFormatIn = 0;
                                }else{
                                    $increaseSalesFormatIn = 100;
                                }
                            }else{
                                if($totalSalesIn==0){
                                    $increaseSalesFormatIn = -100;
                                }else{
                                    $increaseSalesIn = (($totalSalesIn - $prevSalesIn) / $prevSalesIn) * 100;
                                    $increaseSalesFormatIn = number_format((float)$increaseSalesIn, 2, '.', '');
                                }
                            }
                        }else {
                            $increaseRidershipFormatIn = 100;
                            $increaseSalesFormatIn = 100;
                        }
                        $inbound['route_name'] = $routeNameIn;
                        $inbound['num_km_planned'] = $servicePlannedIn;
                        $inbound['num_km_served'] = $kmServedIn;
                        $inbound['num_km_served_gps'] = $kmServedGPSIn;
                        $inbound['num_scheduled_trip'] = $tripPlanned;
                        $inbound['num_trip_made'] = $tripMadeIn;
                        $inbound['count_passenger_board'] = $totalRidershipIn;
                        $inbound['num_adult'] = $totalAdultIn;
                        $inbound['num_concession'] = $totalConcessionIn;
                        $inbound['total_on'] = $totalRidershipIn;
                        $inbound['total_pax'] = $prevRidershipIn;
                        $inbound['total_pax_increase'] = $increaseRidershipFormatIn;
                        $inbound['total_sales'] = $prevSalesIn;
                        $inbound['total_sales_increase'] = $increaseSalesFormatIn;
        
                        //Outbound Trip
                        $allOutboundTrips = TripDetail::where('route_id', $selectedRoute->id)
                            ->whereBetween('start_trip', [$dateFrom,$dateTo])
                            ->where('trip_code',0)
                            ->get();
        
                        $tripMadeOut = 0;
                        $kmServedOut = 0;
                        $kmServedGPSOut = 0;
                        $totalAdultOut = 0;
                        $totalConcessionOut = 0;
                        $totalRidershipOut = 0;
                        $totalSalesOut = 0;
                        $routeNameOut = implode(" - ", array_reverse(explode(" - ", $routeNameIn)));
                        if(count($allOutboundTrips)>0) {
                            foreach ($allOutboundTrips as $allOutboundTrip) {
                                $tripMadeOut++;
                                $kmServedOut += $allOutboundTrip->Route->outbound_distance;
                                $kmServedGPSOut += $allOutboundTrip->Route->outbound_distance;
        
                                $adult = $allOutboundTrip->total_adult;
                                $concession = $allOutboundTrip->total_concession;
                                $sumRidership = $adult + $concession;
        
                                $adultSales = $allOutboundTrip->total_adult_amount;
                                $concessionSales = $allOutboundTrip->total_concession_amount;
                                $sumSales = $adultSales + $concessionSales;
        
                                //Check tickets if sumRidership==0 || sumSales==0 
                                $checkTickets = TicketSalesTransaction::where('trip_number', $allOutboundTrip->trip_number)->get();
                                if($sumRidership==0 || $sumSales==0){
                                    if(count($checkTickets)>0){
                                        $adult = 0;
                                        $concession = 0;
                                        $sumRidership = 0;
                                        $sumSales = 0;
                                        foreach($checkTickets as $checkTicket){
                                            if($checkTicket->passenger_type==0){
                                                $adult++;
                                            }
                                            elseif($checkTicket->passenger_type==1){
                                                $concession++;
                                            }
                                            $sumSales += $checkTicket->actual_amount;
                                        }
                                        $sumRidership = $adult + $concession;
                                    }
                                }
        
                                $totalAdultOut += $adult;
                                $totalConcessionOut += $concession;
                                $totalRidershipOut += $sumRidership;
                                $totalSalesOut += $sumSales;
                            }
                        }
        
                        //Previous Month Ridership Farebox Outbound collection
                        $prevTripsOut = TripDetail::whereBetween('start_trip', [$previousStartMonth, $previousEndMonth])
                            ->where('route_id', $selectedRoute->id)
                            ->where('trip_code',0)
                            ->get();
        
                        $prevRidershipOut = 0;
                        $prevSalesOut = 0;
                        if(count($prevTripsOut)>0) {
                            foreach ($prevTripsOut as $prevTripOut) {
                                $adult = $prevTripOut->total_adult;
                                $concession = $prevTripOut->total_concession;
                                $sumRidership = $adult + $concession;
                                $prevRidershipOut += $sumRidership;
        
                                $adultSales = $prevTripOut->total_adult_amount;
                                $concessionSales = $prevTripOut->total_concession_amount;
                                $sumSales = $adultSales + $concessionSales;
                                $prevSalesOut += $sumSales;
                            }
        
                            //Increment ridership outbound collection (%)
                            if($prevRidershipOut==0){
                                if($totalRidershipOut==0){
                                    $increaseRidershipFormatOut = 0;
                                }else{
                                    $increaseRidershipFormatOut = 100;
                                }
                            }else{
                                if($totalRidershipOut==0){
                                    $increaseRidershipFormatOut = -100;
                                }else{
                                    $increaseRidershipOut = (($totalRidershipOut - $prevRidershipOut) / $prevRidershipOut) * 100;
                                    $increaseRidershipFormatOut = number_format((float)$increaseRidershipOut, 2, '.', '');
                                }
                            }
        
                            //Increment farebox outbound collection (%)
                            if($prevSalesOut==0){
                                if($totalSalesOut==0){
                                    $increaseSalesFormatOut = 0;
                                }else{
                                    $increaseSalesFormatOut = 100;
                                }
                            }else{
                                if($totalSalesOut==0){
                                    $increaseSalesFormatOut = -100;
                                }else{
                                    $increaseSalesOut = (($totalSalesOut - $prevSalesOut) / $prevSalesOut) * 100;
                                    $increaseSalesFormatOut = number_format((float)$increaseSalesOut, 2, '.', '');
                                }
                            }
                        }else{
                            $increaseRidershipFormatOut = 100;
                            $increaseSalesFormatOut  = 100;
                        }
        
                        $outbound['route_name'] = $routeNameOut;
                        $outbound['num_km_planned'] = $servicePlannedOut;
                        $outbound['num_km_served'] = $kmServedOut;
                        $outbound['num_km_served_gps'] = $kmServedGPSOut;
                        $outbound['num_scheduled_trip'] = $tripPlanned;
                        $outbound['num_trip_made'] = $tripMadeOut;
                        $outbound['count_passenger_board'] = $totalRidershipOut;
                        $outbound['num_adult'] = $totalAdultOut;
                        $outbound['num_concession'] = $totalConcessionOut;
                        $outbound['total_on'] = $totalRidershipOut;
                        $outbound['total_pax'] = $prevRidershipOut;
                        $outbound['total_pax_increase'] = $increaseRidershipFormatOut;
                        $outbound['total_sales'] = $prevSalesOut;
                        $outbound['total_sales_increase'] = $increaseSalesFormatOut;
        
                        $total['tot_num_km_planned'] = $inbound['num_km_planned'] + $outbound['num_km_planned'];
                        $total['tot_num_km_served'] = $inbound['num_km_served'] + $outbound['num_km_served'];
                        $total['tot_num_km_served_gps'] = $inbound['num_km_served_gps'] + $outbound['num_km_served_gps'];
                        $total['tot_num_scheduled_trip'] = $inbound['num_scheduled_trip'] + $outbound['num_scheduled_trip'];
                        $total['tot_num_trip_made'] = $inbound['num_trip_made'] + $outbound['num_trip_made'];
                        $total['tot_count_passenger_board'] = $inbound['count_passenger_board'] + $outbound['count_passenger_board'];
                        $total['tot_num_adult'] = $inbound['num_adult'] + $outbound['num_adult'];
                        $total['tot_num_concession'] = $inbound['num_concession'] + $outbound['num_concession'];
                        $total['tot_total_on'] = $inbound['total_on'] + $outbound['total_on'];
                        $total['tot_total_pax'] = $inbound['total_pax']+ $outbound['total_pax'];
        
                        //total_pax_increase
                        $sumtotalPaxIncrease = $inbound['total_pax_increase'] + $outbound['total_pax_increase'];
                        $calcPaxIncrease = ($sumtotalPaxIncrease/200)*100;
                        $calcPaxIncreaseFormat = round($calcPaxIncrease, 2);
                        $total['tot_total_pax_increase'] = $calcPaxIncreaseFormat;
        
                        $total['tot_total_sales'] = $inbound['total_sales'] + $outbound['total_sales'];
        
                        //total_sales_increase
                        $sumtotalSalesIncrease =  $inbound['total_sales_increase'] + $outbound['total_sales_increase'];
                        $calcSalesIncrease = ($sumtotalSalesIncrease/200)*100;
                        $calcSalesIncreaseFormat = round($calcSalesIncrease, 2);
                        $total['tot_total_sales_increase'] = $calcSalesIncrease;
        
                        $grand['grand_num_km_planned'] = $total['tot_num_km_planned'];
                        $grand['grand_num_km_served'] = $total['tot_num_km_served'];
                        $grand['grand_num_km_served_gps'] = $total['tot_num_km_served_gps'];
                        $grand['grand_num_scheduled_trip'] = $total['tot_num_scheduled_trip'];
                        $grand['grand_num_trip_made'] = $total['tot_num_trip_made'];
                        $grand['grand_count_passenger_board'] = $total['tot_count_passenger_board'];
                        $grand['grand_num_adult'] = $total['tot_num_adult'];
                        $grand['grand_num_concession'] = $total['tot_num_concession'];
                        $grand['grand_total_on'] = $total['tot_total_on'];
                        $grand['grand_total_pax'] = $total['tot_total_pax'];
                        $grand['grand_total_pax_increase'] = $calcPaxIncrease;
                        $grand['grand_total_sales'] = $total['tot_total_sales'];
                        $grand['grand_total_sales_increase'] = $calcSalesIncrease;
        
                        $perRoute['inbound'] = $inbound;
                        $perRoute['outbound'] = $outbound;
                        $perRoute['total'] = $total;
                        $data[$selectedRoute->route_number] = $perRoute;
                        $data['grand'] = $grand;
        
                        $routeSPAD->add($data);
                    }
                }
            }
            return Excel::download(new SPADRoute($networkArea, $routeSPAD, $validatedData['dateFrom'], $validatedData['dateTo']), 'Route_Report_SPAD_'.Carbon::now()->format('YmdHis').'.xlsx');
        }else{
            $this->dispatchBrowserEvent('company-required');
        }
    }

    //FAST
    public function printTripFast(){
        $out = new ConsoleOutput();
        $out->writeln("YOU ARE IN printTrip()");

        $validatedData = Validator::make($this->state,[
            'dateFrom' => ['required', 'date'],
            'dateTo' => ['required', 'date'],
            'route_id' => ['required'],
        ])->validate();

        $dateFrom = new Carbon($validatedData['dateFrom']);
        $dateTo = new Carbon($validatedData['dateTo'] . '23:59:59');

        $startDate = new Carbon($validatedData['dateFrom']);
        $endDate = new Carbon($validatedData['dateTo']);
        $all_dates = array();

        while ($startDate->lte($endDate)){
            $all_dates[] = $startDate->toDateString();
            $startDate->addDay();
        }

        if($this->selectedCompany){
            if($this->selectedCompany=='All'){
                $networkArea = 'ALL';
                if(!empty($validatedData['route_id'])) {
                    //Route all route all company
                    if($validatedData['route_id']=='All') {
                        $getAllRoutes = Route::where('status', 1)->orderBy('route_number')->get();
                        $allTrips = [];
                        $totOutArr = [];
                        $totInArr = [];
                        $totDateArr = [];
                        $totRouteArr = [];
                        $totGrandArr = [];

                        foreach($getAllRoutes as $allRoute){
                            $tripPerRoute = DB::select("SELECT trip_details.trip_code, route.id, route.route_number, 
                            (case when (trip_details.trip_code = 1) THEN (
                                SELECT stage_name FROM stage WHERE route_id = route.id order by stage_order DESC LIMIT 1) 
                                ELSE (
                                SELECT stage_name FROM stage WHERE route_id = route.id order by stage_order ASC LIMIT 1) 
                                END) as start_point,
                            (case when (trip_details.trip_code = 1) THEN CONCAT(SUBSTRING_INDEX(SUBSTRING_INDEX(route_name, '-', 2), '-', -1)
                            , ' - ', SUBSTRING_INDEX(SUBSTRING_INDEX(route_name, '-', 2), '-', 1)) ELSE route.route_name END) as route_name,
                            trip_details.trip_number, 
                            trip_details.id as no_of_trip, CONCAT('T', trip_details.id) as trip_no,
                            bus.bus_registration_number, driver_id, cast(trip_details.start_trip as date) as service_date, 
                            route_scheduler_mstr.schedule_start_time as service_start, 
                            cast(trip_details.start_trip as TIME) as actual_start, 
                            (case when ((total_adult_amount + total_concession_amount)> 0.00) THEN (
                                SELECT cast(ticket_sales_transaction.sales_date as TIME) 
                                FROM ticket_sales_transaction 
                                WHERE trip_number = trip_details.trip_number 
                                order by sales_date ASC LIMIT 1) 
                                ELSE 'No Sales' END) as sales_start,
                            route_scheduler_mstr.schedule_end_time as service_end, 
                            cast(trip_details.end_trip as TIME) as actual_end,
                            (case when ((total_adult_amount + total_concession_amount)> 0.00) THEN (
                                SELECT cast(ticket_sales_transaction.sales_date as TIME) 
                                FROM ticket_sales_transaction 
                                WHERE trip_number = trip_details.trip_number 
                                order by sales_date DESC LIMIT 1) 
                                ELSE 'No Sales' END) as sales_end,
                            total_adult_amount + total_concession_amount AS farebox, 
                            total_adult + total_concession AS ridership, total_adult, total_concession
                            FROM trip_details
                            JOIN mybas.route ON route.id = trip_details.route_id
                            JOIN mybas.bus ON bus.id = trip_details.bus_id 
                            JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.id = trip_details.route_schedule_mstr_id
                            WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND trip_details.route_id = " . $allRoute->id . "
                            ORDER BY service_date, trip_code;");

                            $totOutbound = DB::select("SELECT trip_details.trip_code, route.id, route.route_name, 
                            cast(trip_details.start_trip as date) as service_date,
                            IFNULL((SUM(trip_details.total_adult_amount) + SUM(trip_details.total_concession_amount)), 0.00) AS farebox,
                            IFNULL((SUM(trip_details.total_adult) + SUM(trip_details.total_concession)), 0) AS ridership, 
                            IFNULL(SUM(total_adult),0) as total_adult, IFNULL(SUM(total_concession),0) as total_concession
                            FROM trip_details
                            JOIN mybas.route ON route.id = trip_details.route_id
                            WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND trip_details.route_id = " . $allRoute->id . "
                            AND trip_details.trip_code = 0
                            GROUP BY service_date;");

                            $totInbound = DB::select("SELECT trip_details.trip_code, route.id, 
                            CONCAT(SUBSTRING_INDEX(SUBSTRING_INDEX(route.route_name, '-', 2), '-', -1), ' - ', SUBSTRING_INDEX(SUBSTRING_INDEX(route.route_name, '-', 2), '-', 1)) as route_name,
                            cast(trip_details.start_trip as date) as service_date,
                            IFNULL((SUM(trip_details.total_adult_amount) + SUM(trip_details.total_concession_amount)), 0.00) AS farebox,
                            IFNULL((SUM(trip_details.total_adult) + SUM(trip_details.total_concession)), 0) AS ridership, 
                            IFNULL(SUM(total_adult),0) as total_adult, IFNULL(SUM(total_concession),0) as total_concession
                            FROM trip_details
                            JOIN mybas.route ON route.id = trip_details.route_id
                            WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND trip_details.route_id = " . $allRoute->id . "
                            AND trip_details.trip_code = 1
                            GROUP BY service_date;");

                            $totPerDate = DB::select("SELECT route.id, route.route_name, 
                            cast(trip_details.start_trip as date) as service_date,
                            IFNULL((SUM(trip_details.total_adult_amount) + SUM(trip_details.total_concession_amount)), 0.00) AS farebox,
                            IFNULL((SUM(trip_details.total_adult) + SUM(trip_details.total_concession)), 0) AS ridership, 
                            IFNULL(SUM(total_adult),0) as total_adult, IFNULL(SUM(total_concession),0) as total_concession
                            FROM trip_details
                            JOIN mybas.route ON route.id = trip_details.route_id
                            WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND trip_details.route_id = " . $allRoute->id . "
                            GROUP BY service_date;");

                            if($tripPerRoute && $totOutbound && $totInbound && $totPerDate){
                                $out->writeln("In totPerDate && totInbound && tripInbound && totOutbound && tripOutbound");
                                $allTrips = array_merge($allTrips, $tripPerRoute);
                                $totOutArr = array_merge($totOutArr, $totOutbound);
                                $totInArr = array_merge($totInArr, $totInbound);
                                $totDateArr = array_merge($totDateArr, $totPerDate);
                            }
                        }

                        $totPerRoute = DB::select("SELECT route.id, route.route_number, route.route_name,
                        IFNULL((SUM(trip_details.total_adult_amount) + SUM(trip_details.total_concession_amount)), 0.00) AS farebox,
                        IFNULL((SUM(trip_details.total_adult) + SUM(trip_details.total_concession)), 0) AS ridership, 
                        IFNULL(SUM(total_adult),0) as total_adult, IFNULL(SUM(total_concession),0) as total_concession
                        FROM trip_details
                        JOIN mybas.route ON route.id = trip_details.route_id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND route.status = 1
                        GROUP BY route.id
                        ORDER BY route.route_number;");

                        if($totPerRoute){
                            $out->writeln("In totPerRoute");
                            $totRouteArr = array_merge($totRouteArr, $totPerRoute);
                            
                        }

                        // foreach($getAllRoutes as $allRoute){
                        //     foreach($all_dates as $all_date){
                        //         $startDay = new Carbon($all_date);
                        //         $endDay = new Carbon($all_date . '23:59:59');

                        //         $out->writeln("All Route: " . $allRoute->route_number . " Service Date: " . $all_date);

                        //         $tripOutbound = DB::select("SELECT trip_details.trip_code, route.id, route.route_number, 
                        //         (SELECT stage_name FROM stage WHERE route_id = route.id order by stage_order ASC LIMIT 1) as start_point,
                        //         route.route_name, trip_details.trip_number, trip_details.id as no_of_trip, 
                        //         CONCAT('T', trip_details.id) as trip_no, bus.bus_registration_number, driver_id, 
                        //         cast(trip_details.start_trip as date) as service_date, 
                        //         route_scheduler_mstr.schedule_start_time as service_start, 
                        //         cast(trip_details.start_trip as TIME) as actual_start, 
                        //         (case when ((total_adult_amount + total_concession_amount)> 0.00) THEN (
                        //             SELECT cast(ticket_sales_transaction.sales_date as TIME) 
                        //             FROM ticket_sales_transaction 
                        //             WHERE trip_number = trip_details.trip_number 
                        //             order by sales_date ASC LIMIT 1) 
                        //             ELSE 'No Sales' END) as sales_start,
                        //         route_scheduler_mstr.schedule_end_time as service_end, 
                        //         cast(trip_details.end_trip as TIME) as actual_end,
                        //         (case when ((total_adult_amount + total_concession_amount)> 0.00) THEN (
                        //             SELECT cast(ticket_sales_transaction.sales_date as TIME) 
                        //             FROM ticket_sales_transaction 
                        //             WHERE trip_number = trip_details.trip_number 
                        //             order by sales_date DESC LIMIT 1) 
                        //             ELSE 'No Sales' END) as sales_end,
                        //         total_adult_amount + total_concession_amount AS farebox, 
                        //         total_adult + total_concession AS ridership, total_adult, total_concession
                        //         FROM trip_details
                        //         JOIN mybas.route ON route.id = trip_details.route_id
                        //         JOIN mybas.bus ON bus.id = trip_details.bus_id 
                        //         JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.id = trip_details.route_schedule_mstr_id
                        //         WHERE trip_details.start_trip BETWEEN '" . $startDay . "' AND '" . $endDay . "'
                        //         AND trip_details.route_id = " . $allRoute->id . "
                        //         AND trip_details.trip_code = 0
                        //         ORDER BY service_date, trip_code;");

                        //         $totOutbound = DB::select("SELECT trip_details.trip_code, route.route_name as route_name_code,
                        //         IFNULL((SUM(trip_details.total_adult_amount) + SUM(trip_details.total_concession_amount)), 0.00) AS farebox,
                        //         IFNULL((SUM(trip_details.total_adult) + SUM(trip_details.total_concession)), 0) AS ridership, 
                        //         IFNULL(SUM(total_adult),0) as total_adult, IFNULL(SUM(total_concession),0) as total_concession
                        //         FROM trip_details
                        //         JOIN mybas.route ON route.id = trip_details.route_id
                        //         WHERE trip_details.start_trip BETWEEN '" . $startDay . "' AND '" . $endDay . "'
                        //         AND trip_details.route_id =  " . $allRoute->id . "
                        //         AND trip_details.trip_code = 0
                        //         GROUP BY route.id;");

                        //         $tripInbound = DB::select("SELECT trip_details.trip_code, route.id, route.route_number, 
                        //         (SELECT stage_name FROM stage WHERE route_id = route.id order by stage_order DESC LIMIT 1) as start_point,
                        //         CONCAT(SUBSTRING_INDEX(SUBSTRING_INDEX(route_name, '-', 2), '-', -1), ' - ', SUBSTRING_INDEX(SUBSTRING_INDEX(route_name, '-', 2), '-', 1)) as route_name,
                        //         trip_details.trip_number, 
                        //         trip_details.id as no_of_trip, CONCAT('T', trip_details.id) as trip_no,
                        //         bus.bus_registration_number, driver_id, cast(trip_details.start_trip as date) as service_date, 
                        //         route_scheduler_mstr.schedule_start_time as service_start, 
                        //         cast(trip_details.start_trip as TIME) as actual_start, 
                        //         (case when ((total_adult_amount + total_concession_amount)> 0.00) THEN (
                        //             SELECT cast(ticket_sales_transaction.sales_date as TIME) 
                        //             FROM ticket_sales_transaction 
                        //             WHERE trip_number = trip_details.trip_number 
                        //             order by sales_date ASC LIMIT 1) 
                        //             ELSE 'No Sales' END) as sales_start,
                        //         route_scheduler_mstr.schedule_end_time as service_end, 
                        //         cast(trip_details.end_trip as TIME) as actual_end,
                        //         (case when ((total_adult_amount + total_concession_amount)> 0.00) THEN (
                        //             SELECT cast(ticket_sales_transaction.sales_date as TIME) 
                        //             FROM ticket_sales_transaction 
                        //             WHERE trip_number = trip_details.trip_number 
                        //             order by sales_date DESC LIMIT 1) 
                        //             ELSE 'No Sales' END) as sales_end,
                        //         total_adult_amount + total_concession_amount AS farebox, 
                        //         total_adult + total_concession AS ridership, total_adult, total_concession
                        //         FROM trip_details
                        //         JOIN mybas.route ON route.id = trip_details.route_id
                        //         JOIN mybas.bus ON bus.id = trip_details.bus_id 
                        //         JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.id = trip_details.route_schedule_mstr_id
                        //         WHERE trip_details.start_trip BETWEEN '" . $startDay . "' AND '" . $endDay . "'
                        //         AND trip_details.route_id = " . $allRoute->id . "
                        //         AND trip_details.trip_code = 1
                        //         ORDER BY service_date, trip_code;");

                        //         $totInbound = DB::select("SELECT trip_details.trip_code, CONCAT(SUBSTRING_INDEX(SUBSTRING_INDEX(route_name, '-', 2), '-', -1), ' - ', SUBSTRING_INDEX(SUBSTRING_INDEX(route_name, '-', 2), '-', 1)) as route_name_code,
                        //         IFNULL((SUM(trip_details.total_adult_amount) + SUM(trip_details.total_concession_amount)), 0.00) AS farebox,
                        //         IFNULL((SUM(trip_details.total_adult) + SUM(trip_details.total_concession)), 0) AS ridership, 
                        //         IFNULL(SUM(total_adult),0) as total_adult, IFNULL(SUM(total_concession),0) as total_concession
                        //         FROM trip_details
                        //         JOIN mybas.route ON route.id = trip_details.route_id
                        //         WHERE trip_details.start_trip BETWEEN '" . $startDay . "' AND '" . $endDay . "'
                        //         AND trip_details.route_id = " . $allRoute->id . "
                        //         AND trip_details.trip_code = 1
                        //         GROUP BY route.id;");

                        //         $totPerDate = DB::select("SELECT route.route_number as route_number_date, cast(trip_details.start_trip as date) as service_date,
                        //         IFNULL((SUM(trip_details.total_adult_amount) + SUM(trip_details.total_concession_amount)), 0.00) AS farebox,
                        //         IFNULL((SUM(trip_details.total_adult) + SUM(trip_details.total_concession)), 0) AS ridership, 
                        //         IFNULL(SUM(total_adult),0) as total_adult, IFNULL(SUM(total_concession),0) as total_concession
                        //         FROM trip_details
                        //         JOIN mybas.route ON route.id = trip_details.route_id
                        //         WHERE trip_details.start_trip BETWEEN '" . $startDay . "' AND '" . $endDay . "'
                        //         AND trip_details.route_id = " . $allRoute->id . "
                        //         GROUP BY trip_details.route_id;");

                        //         if($totPerDate && $totInbound && $tripInbound && $totOutbound && $tripOutbound){
                        //             $out->writeln("In totPerDate && totInbound && tripInbound && totOutbound && tripOutbound");
                        //             $allTrips = array_merge($allTrips, $tripOutbound, $totOutbound, $tripInbound, $totInbound, $totPerDate);
                        //         }
                                
                        //     }
                        //     $totPerRoute = DB::select("SELECT route.route_number as route_number_route,
                        //     IFNULL((SUM(trip_details.total_adult_amount) + SUM(trip_details.total_concession_amount)), 0.00) AS farebox,
                        //     IFNULL((SUM(trip_details.total_adult) + SUM(trip_details.total_concession)), 0) AS ridership, 
                        //     IFNULL(SUM(total_adult),0) as total_adult, IFNULL(SUM(total_concession),0) as total_concession
                        //     FROM trip_details
                        //     JOIN mybas.route ON route.id = trip_details.route_id
                        //     WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        //     AND trip_details.route_id = " . $allRoute->id . "
                        //     GROUP BY trip_details.route_id;");

                        //     if($totPerRoute){
                        //         $out->writeln("In totPerRoute > 0");
                        //         $allTrips = array_merge($allTrips, $totPerRoute);
                        //     }
                        // }
                        $grandTot = DB::select("SELECT
                        IFNULL((SUM(trip_details.total_adult_amount) + SUM(trip_details.total_concession_amount)), 0.00) AS farebox_grand,
                        IFNULL((SUM(trip_details.total_adult) + SUM(trip_details.total_concession)), 0) AS ridership, 
                        IFNULL(SUM(total_adult),0) as total_adult, IFNULL(SUM(total_concession),0) as total_concession
                        FROM trip_details
                        JOIN mybas.route ON route.id = trip_details.route_id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND route.status = 1;");

                        if($grandTot){
                            $out->writeln("In grandTot > 0");
                            $totGrandArr = array_merge($totGrandArr, $grandTot);
                        }

                        //dd($allTrips);
                    }
                }
            }
            else{
                $companyDetails = Company::where('id', $this->selectedCompany)->first();
                $networkArea = $companyDetails->company_name;
                if(!empty($validatedData['route_id'])) {
                    //Route all route all company
                    if($validatedData['route_id']=='All') {

                    }
                    else{

                    }
                }
            }
            $out->writeln(Carbon::now() . "Go to excel");
            return Excel::download(new SPADTrip($allTrips, $totOutArr, $totInArr, $totDateArr, $totRouteArr, $totGrandArr,
            $validatedData['dateFrom'], $validatedData['dateTo'], $networkArea), 'Trip_Report_SPAD_'.Carbon::now()->format('YmdHis').'.xlsx');
        }else{
            $this->dispatchBrowserEvent('company-required');
        }
    }

    public function printTrip()
    {
        $out = new ConsoleOutput();
        $out->writeln("YOU ARE IN printTrip()");

        $validatedData = Validator::make($this->state,[
            'dateFrom' => ['required', 'date'],
            'dateTo' => ['required', 'date'],
            'route_id' => ['required'],
        ])->validate();

        $startDate = new Carbon($validatedData['dateFrom']);
        $endDate = new Carbon($validatedData['dateTo']);
        $all_dates = array();
        while ($startDate->lte($endDate)){
            $all_dates[] = $startDate->toDateString();
            $startDate->addDay();
        }

        $tripSPAD = collect();
        $grandPassengerCount = 0;
        $grandSalesAmount  = 0;
        $grandAdult  = 0;
        $grandConcession  = 0;
        $perRoute = [];
        if($this->selectedCompany){
            if($this->selectedCompany=='All'){
                $networkArea = 'All';
                if(!empty($validatedData['route_id'])) {
                    //Trip all route all company
                    if($validatedData['route_id']=='All'){
                        $allRoutes = Route::orderBy('route_number')->get();

                        foreach ($allRoutes as $allRoute){
                            $perRoutePassengerCount = 0;
                            $perRouteSalesAmount = 0;
                            $perRouteAdult = 0;
                            $perRouteConcession = 0;
                            $perDate = [];
            
                            foreach ($all_dates as $all_date) {
                                $existOutTrip = false;
                                $existInTrip = false;
                                $firstDate = new Carbon($all_date);
                                $lastDate = new Carbon($all_date . '23:59:59');
            
                                //Inbound Trip
                                $allInboundTrips = TripDetail::where('route_id', $allRoute->id)
                                    ->whereBetween('start_trip', [$firstDate, $lastDate])
                                    ->where('trip_code', 1)
                                    ->get();
            
                                $routeNameIn = $allRoute->route_name;
            
                                $inbound = [];
                                $inboundPassenger = 0;
                                $inboundSales = 0;
                                $inboundAdult = 0;
                                $inboundConcession = 0;
                                if (count($allInboundTrips) > 0) {
                                    $existInTrip = true;
                                    foreach ($allInboundTrips as $allInboundTrip) {
                                        $tripIn['trip_no'] = 'T' . $allInboundTrip->id;

                                        //Check bus_id
                                        if($allInboundTrip->bus_id!=NULL) {
                                            $tripIn['bus_no'] = $allInboundTrip->Bus->bus_registration_number;
                                        }
                                        else{
                                            $tripIn['bus_no']  = "No Data";
                                        }
            
                                        //Check driver_id
                                        if($allInboundTrip->driver_id != NULL) {
                                            $tripIn['driver_id'] = $allInboundTrip->BusDriver->id_number;
                                        }else{
                                            $tripIn['driver_id'] = "No Data";
                                        }
            
                                        $tripIn['service_date'] = $all_date;
            
                                        $firstStageIn = Stage::where('route_id', $allRoute->id)->first();
                                        $tripIn['start_point'] = $firstStageIn->stage_name;
            
                                        //Check route_schedule_mstr_id
                                        if($allInboundTrip->route_schedule_mstr_id != NULL) {
                                            $tripIn['service_start'] = Carbon::create($allInboundTrip->RouteScheduleMSTR->schedule_start_time)->format('H:i');
                                        }else{
                                            $tripIn['service_start'] = "No Data";
                                        }
            
                                        $tripIn['actual_start'] = date("H:i", strtotime($allInboundTrip->start_trip));
            
                                        //Check sales
                                        $firstTicket = TicketSalesTransaction::where('trip_id', $allInboundTrip->id)
                                            ->orderby('sales_date')
                                            ->first();
                                        if($firstTicket){
                                            $tripIn['sales_start'] = date("H:i", strtotime($firstTicket->sales_date));
                                        }else{
                                            $tripIn['sales_start'] = "No Sales";
                                        }
            
                                        //Check route_schedule_mstr_id
                                        if($allInboundTrip->route_schedule_mstr_id != NULL) {
                                            $tripIn['service_end'] = Carbon::create($allInboundTrip->RouteScheduleMSTR->schedule_end_time)->format('H:i');
                                        }else{
                                            $tripIn['service_end'] = "No Data";
                                        }
            
                                        $tripIn['actual_end'] = date("H:i", strtotime($allInboundTrip->end_trip));
            
                                        //Check sales
                                        $lastTicket = TicketSalesTransaction::where('trip_id', $allInboundTrip->id)
                                            ->orderby('sales_date', 'DESC')
                                            ->first();
                                        if($lastTicket){
                                            $tripIn['sales_end'] = date("H:i", strtotime($lastTicket->sales_date));
                                        }else{
                                            $tripIn['sales_end'] = "No Sales";
                                        }
            
                                        $adult = $allInboundTrip->total_adult;
                                        $concession = $allInboundTrip->total_concession;
                                        $passengerIn = $adult + $concession;
            
                                        $adultFarebox = $allInboundTrip->total_adult_amount;
                                        $concessionFarebox = $allInboundTrip->total_concession_amount;
                                        $fareboxIn = $adultFarebox + $concessionFarebox;
            
                                        //Check tickets
                                        if($fareboxIn==0 || $passengerIn==0){
                                            $allTicketPerTrips = TicketSalesTransaction::where('trip_id', $allInboundTrip->id)->get();
                                            if(count($allTicketPerTrips)>0){
                                                $adult = 0;
                                                $concession = 0;
                                                $passengerIn = 0;
                                                $fareboxIn = 0;
                                                foreach($allTicketPerTrips as $allTicketPerTrip){
                                                    $fareboxIn += $allTicketPerTrip->actual_amount;
                                                    if($allTicketPerTrip->passenger_type==0){
                                                        $adult++;
                                                    }else{
                                                        $concession++;
                                                    }
                                                }
                                                $passengerIn = $adult + $concession;
                                            }
                                        }
                                        $tripIn['passenger_count'] = $passengerIn;
                                        $tripIn['sales_amount'] = $fareboxIn;
                                        $tripIn['total_on'] = $passengerIn;
                                        $tripIn['adult'] = $adult;
                                        $tripIn['concession'] = $concession;
            
                                        $inbound[$allInboundTrip->id] = $tripIn;
            
                                        $inboundPassenger += $tripIn['passenger_count'];
                                        $inboundSales += $tripIn['sales_amount'];
                                        $inboundAdult += $tripIn['adult'];
                                        $inboundConcession += $tripIn['concession'];
                                    }
                                    $totalInbound['passenger_count'] = $inboundPassenger;
                                    $totalInbound['sales_amount'] = $inboundSales;
                                    $totalInbound['total_on'] = $inboundPassenger;
                                    $totalInbound['adult'] = $inboundAdult;
                                    $totalInbound['concession'] = $inboundConcession;
            
                                    $inbound['total'] = $totalInbound;
                                }
            
                                //Outbound Trip
                                $allOutboundTrips = TripDetail::where('route_id', $allRoute->id)
                                    ->whereBetween('start_trip', [$firstDate, $lastDate])
                                    ->where('trip_code', 0)
                                    ->get();
            
                                $routeNameOut = implode(" - ", array_reverse(explode(" - ", $routeNameIn)));
            
                                $outbound = [];
                                $outboundPassenger = 0;
                                $outboundSales  = 0;
                                $outboundAdult  = 0;
                                $outboundConcession  = 0;
                                if (count($allOutboundTrips) > 0) {
                                    $existOutTrip = true;
                                    foreach ($allOutboundTrips as $allOutboundTrip) {
                                        $tripOut['trip_no'] = 'T' . $allOutboundTrip->id;

                                        //Check bus_id
                                        if($allOutboundTrip->bus_id!=NULL) {
                                            $tripOut['bus_no'] = $allOutboundTrip->Bus->bus_registration_number;
                                        }
                                        else{
                                            $tripOut['bus_no'] = "No Data";
                                        }
            
                                        //Check driver_id
                                        if($allOutboundTrip->driver_id!=NULL) {
                                            $tripOut['driver_id'] = $allOutboundTrip->BusDriver->driver_number;
                                        }else{
                                            $tripOut['driver_id'] = "No Data";
                                        }
            
                                        $tripOut['service_date'] = $all_date;
                                        $firstStageOut = Stage::where('route_id',$allRoute->id)->orderBy('stage_order', 'DESC')->first();
                                        $tripOut['start_point'] = $firstStageOut->stage_name;
            
                                        //Check route_schedule_mstr_id
                                        if($allOutboundTrip->route_schedule_mstr_id!=NULL){
                                            $tripOut['service_start'] = Carbon::create($allOutboundTrip->RouteScheduleMSTR->schedule_start_time)->format('H:i');
                                        }else{
                                            $tripOut['service_start'] = "No Data";
                                        }
            
                                        $tripOut['actual_start'] = date("H:i", strtotime($allOutboundTrip->start_trip));
            
                                        //Check sales
                                        $firstTicket = TicketSalesTransaction::where('trip_id', $allOutboundTrip->id)
                                            ->orderby('sales_date')
                                            ->first();
                                        if($firstTicket){
                                            $tripOut['sales_start'] = date("H:i", strtotime($firstTicket->sales_date));
                                        }else{
                                            $tripOut['sales_start'] = "No Sales";
                                        }
            
                                        //Check route_schedule_mstr_id
                                        if($allOutboundTrip->route_schedule_mstr_id!=NULL){
                                            $tripOut['service_end'] = Carbon::create($allOutboundTrip->RouteScheduleMSTR->schedule_end_time)->format('H:i');
                                        }else{
                                            $tripOut['service_end'] = "No Data";
                                        }
            
                                        $tripOut['actual_end'] = date("H:i", strtotime($allOutboundTrip->end_trip));
            
                                        //Check sales
                                        $lastTicket = TicketSalesTransaction::where('trip_id', $allOutboundTrip->id)
                                            ->orderby('sales_date', 'DESC')
                                            ->first();
                                        if($lastTicket){
                                            $tripOut['sales_end'] = date("H:i", strtotime($lastTicket->sales_date));
                                        }else{
                                            $tripOut['sales_end'] = "No Sales";
                                        }
            
                                        $adult = $allOutboundTrip->total_adult;
                                        $concession = $allOutboundTrip->total_concession;
                                        $passengerOut = $adult + $concession;
            
                                        $adultFarebox = $allOutboundTrip->total_adult_amount;
                                        $concessionFarebox = $allOutboundTrip->total_concession_amount;
                                        $fareboxOut = $adultFarebox + $concessionFarebox;
            
                                        //Check tickets
                                        if($fareboxOut==0 || $passengerOut==0){
                                            $allTicketPerTrips = TicketSalesTransaction::where('trip_id',  $allOutboundTrip->id)->get();
                                            if(count($allTicketPerTrips)>0){
                                                foreach($allTicketPerTrips as $allTicketPerTrip){
                                                    $fareboxOut += $allTicketPerTrip->actual_amount;
                                                    if($allTicketPerTrip->passenger_type==0){
                                                        $adult++;
                                                    }else{
                                                        $concession++;
                                                    }
                                                }
                                                $passengerOut = count($allTicketPerTrips);
                                            }
                                        }
                                        $tripOut['passenger_count'] = $passengerOut;
                                        $tripOut['sales_amount'] = $fareboxOut;
                                        $tripOut['total_on'] = $passengerOut;
                                        $tripOut['adult'] = $adult;
                                        $tripOut['concession'] = $concession;
                                        $outbound[$allOutboundTrip->id] = $tripOut;
            
                                        $outboundPassenger += $tripOut['passenger_count'];
                                        $outboundSales += $tripOut['sales_amount'];
                                        $outboundAdult += $tripOut['adult'];
                                        $outboundConcession += $tripOut['concession'];
                                    }
                                    $totalOutbound['passenger_count'] = $outboundPassenger;
                                    $totalOutbound['sales_amount'] = $outboundSales;
                                    $totalOutbound['total_on'] = $outboundPassenger;
                                    $totalOutbound['adult'] = $outboundAdult;
                                    $totalOutbound['concession'] = $outboundConcession;
            
                                    $outbound['total'] = $totalOutbound;
                                }
            
                                //$out->writeln("existInTrip: " . $existInTrip . " existOutTrip: " . $existOutTrip);
                                $route_data = [];
                                $sumPassengerCount = 0;
                                $sumSalesAmount = 0;
                                $sumAdult = 0;
                                $sumConcession = 0;
                                if ($existInTrip == true && $existOutTrip == true) {
                                    //$out->writeln("YOU ARE IN HERE existInTrip == true && existOutTrip == true");
                                    $sumPassengerCount = $outboundPassenger + $inboundPassenger;
                                    $sumSalesAmount = $outboundSales + $inboundSales;
                                    $sumAdult = $outboundAdult + $inboundAdult;
                                    $sumConcession = $outboundConcession + $inboundConcession;
            
                                    $totalPerDate['passenger_count'] = $sumPassengerCount;
                                    $totalPerDate['sales_amount'] = $sumSalesAmount;
                                    $totalPerDate['total_on'] = $sumPassengerCount;
                                    $totalPerDate['adult'] = $sumAdult;
                                    $totalPerDate['concession'] = $sumConcession;
            
                                    $route_data[$routeNameIn] = $inbound;
                                    $route_data[$routeNameOut] = $outbound;
                                    $route_data['total_per_date'] = $totalPerDate;
                                    $perDate[$all_date] = $route_data;
            
                                } elseif ($existInTrip == false && $existOutTrip == true) {
                                    //$out->writeln("YOU ARE IN HERE existInTrip == false && existOutTrip == true");
                                    $sumPassengerCount = $outboundPassenger;
                                    $sumSalesAmount = $outboundSales;
                                    $sumAdult = $outboundAdult;
                                    $sumConcession = $outboundConcession;
            
                                    $totalPerDate['passenger_count'] = $sumPassengerCount;
                                    $totalPerDate['sales_amount'] = $sumSalesAmount;
                                    $totalPerDate['total_on'] = $sumPassengerCount;
                                    $totalPerDate['adult'] = $sumAdult;
                                    $totalPerDate['concession'] = $sumConcession;
            
                                    $route_data[$routeNameIn] = [];
                                    $route_data[$routeNameOut] = $outbound;
                                    $route_data['total_per_date'] = $totalPerDate;
                                    $perDate[$all_date] = $route_data;
            
                                } elseif ($existInTrip == true && $existOutTrip == false) {
                                    //$out->writeln("YOU ARE IN HERE existInTrip == true && existOutTrip == false");
                                    $sumPassengerCount =  $inboundPassenger;
                                    $sumSalesAmount = $inboundSales;
                                    $sumAdult = $inboundAdult;
                                    $sumConcession = $inboundConcession;
            
                                    $totalPerDate['passenger_count'] = $sumPassengerCount;
                                    $totalPerDate['sales_amount'] = $sumSalesAmount;
                                    $totalPerDate['total_on'] = $sumPassengerCount;
                                    $totalPerDate['adult'] = $sumAdult;
                                    $totalPerDate['concession'] = $sumConcession;
            
                                    $route_data[$routeNameIn] = $inbound;
                                    $route_data[$routeNameOut] = [];
                                    $route_data['total_per_date'] = $totalPerDate;
                                    $perDate[$all_date] = $route_data;
                                }else{
                                    //$out->writeln("YOU ARE IN HERE existInTrip == false && existOutTrip == false");
                                    $perDate[$all_date] = [];
                                }
                                $perRoutePassengerCount += $sumPassengerCount;
                                $perRouteSalesAmount += $sumSalesAmount;
                                $perRouteAdult += $sumAdult;
                                $perRouteConcession += $sumConcession;
                            }
                            $totalPerRoute['passenger_count'] = $perRoutePassengerCount;
                            $totalPerRoute['sales_amount'] = $perRouteSalesAmount;
                            $totalPerRoute['total_on'] = $perRoutePassengerCount;
                            $totalPerRoute['adult'] = $perRouteAdult;
                            $totalPerRoute['concession'] = $perRouteConcession;
            
                            $perDate['total_per_route'] = $totalPerRoute;
            
                            $perRoute[$allRoute->route_number] = $perDate;
            
                            $grandPassengerCount += $perRoutePassengerCount;
                            $grandSalesAmount += $perRouteSalesAmount;
                            $grandAdult += $perRouteAdult;
                            $grandConcession += $perRouteConcession;
                        }
            
                        $grand['passenger_count'] = $grandPassengerCount;
                        $grand['sales_amount'] = $grandSalesAmount;
                        $grand['total_on'] = $grandPassengerCount;
                        $grand['adult'] = $grandAdult;
                        $grand['concession'] = $grandConcession;
            
                        $data['allRoute'] = $perRoute;
                        $data['grand'] = $grand;
            
                        $tripSPAD->add($data);
                    }
                }
            }
            else{
                $companyDetails = Company::where('id', $this->selectedCompany)->first();
                $networkArea = $companyDetails->company_name;

                if(!empty($validatedData['route_id'])) {
                    //Trip all route specific company
                    if($validatedData['route_id']=='All'){
                        $routeByCompanies = Route::where('company_id', $this->selectedCompany)->orderBy('route_number')->get();
        
                        foreach ($routeByCompanies as $routeByCompany){
                            $perRoutePassengerCount = 0;
                            $perRouteSalesAmount = 0;
                            $perRouteAdult = 0;
                            $perRouteConcession = 0;
                            $perDate = [];
        
                            foreach ($all_dates as $all_date) {
                                $existOutTrip = false;
                                $existInTrip = false;
                                $firstDate = new Carbon($all_date);
                                $lastDate = new Carbon($all_date . '23:59:59');
        
                                //Inbound Trip
                                $allInboundTrips = TripDetail::where('route_id', $routeByCompany->id)
                                    ->whereBetween('start_trip', [$firstDate, $lastDate])
                                    ->where('trip_code', 1)
                                    ->get();
        
                                $routeNameIn = $routeByCompany->route_name;
        
                                $inbound = [];
                                $inboundPassenger = 0;
                                $inboundSales = 0;
                                $inboundAdult = 0;
                                $inboundConcession = 0;
                                if (count($allInboundTrips) > 0) {
                                    $existInTrip = true;
                                    foreach ($allInboundTrips as $allInboundTrip) {
                                        $tripIn['trip_no'] = 'T' . $allInboundTrip->id;

                                        //Check bus_id
                                        if($allInboundTrip->bus_id!=NULL) {
                                            $tripIn['bus_no'] = $allInboundTrip->Bus->bus_registration_number;
                                        }
                                        else{
                                            $tripIn['bus_no']  = "No Data";
                                        }
        
                                        //Check driver_id
                                        if($allInboundTrip->driver_id != NULL) {
                                            $tripIn['driver_id'] = $allInboundTrip->BusDriver->driver_number;
                                        }else{
                                            $tripIn['driver_id'] = "No Data";
                                        }
        
                                        $tripIn['service_date'] = $all_date;
        
                                        $firstStageIn = Stage::where('route_id', $routeByCompany->id)->first();
                                        $tripIn['start_point'] = $firstStageIn->stage_name;
        
                                        //Check route_schedule_mstr_id
                                        if($allInboundTrip->route_schedule_mstr_id != NULL) {
                                            $tripIn['service_start'] = Carbon::create($allInboundTrip->RouteScheduleMSTR->schedule_start_time)->format('H:i');
                                        }else{
                                            $tripIn['service_start'] = "No Data";
                                        }
        
                                        $tripIn['actual_start'] = date("H:i", strtotime($allInboundTrip->start_trip));
        
                                        //Check sales
                                        $firstTicket = TicketSalesTransaction::where('trip_id', $allInboundTrip->id)
                                            ->orderby('sales_date')
                                            ->first();
                                        if($firstTicket){
                                            $tripIn['sales_start'] = date("H:i", strtotime($firstTicket->sales_date));
                                        }else{
                                            $tripIn['sales_start'] = "No Sales";
                                        }
        
                                        //Check route_schedule_mstr_id
                                        if($allInboundTrip->route_schedule_mstr_id != NULL) {
                                            $tripIn['service_end'] = Carbon::create($allInboundTrip->RouteScheduleMSTR->schedule_end_time)->format('H:i');
                                        }else{
                                            $tripIn['service_end'] = "No Data";
                                        }
        
                                        $tripIn['actual_end'] = date("H:i", strtotime($allInboundTrip->end_trip));
        
                                        //Check sales
                                        $lastTicket = TicketSalesTransaction::where('trip_id', $allInboundTrip->id)
                                            ->orderby('sales_date', 'DESC')
                                            ->first();
                                        if($lastTicket){
                                            $tripIn['sales_end'] = date("H:i", strtotime($lastTicket->sales_date));
                                        }else{
                                            $tripIn['sales_end'] = "No Sales";
                                        }
        
                                        $adult = $allInboundTrip->total_adult;
                                        $concession = $allInboundTrip->total_concession;
                                        $passengerIn = $adult + $concession;
        
                                        $adultFarebox = $allInboundTrip->total_adult_amount;
                                        $concessionFarebox = $allInboundTrip->total_concession_amount;
                                        $fareboxIn = $adultFarebox + $concessionFarebox;
        
                                        $out->writeln("fareboxIn before: " . $fareboxIn);
                                        //Check tickets
                                        if($fareboxIn==0 || $passengerIn==0){
                                            $allTicketPerTrips = TicketSalesTransaction::where('trip_id', $allInboundTrip->id)->get();
                                            if(count($allTicketPerTrips)>0){
                                                $adult = 0;
                                                $concession = 0;
                                                $passengerIn = 0;
                                                $fareboxIn = 0;
                                                foreach($allTicketPerTrips as $allTicketPerTrip){
                                                    $fareboxIn += $allTicketPerTrip->actual_amount;
                                                    if($allTicketPerTrip->passenger_type==0){
                                                        $adult++;
                                                    }else{
                                                        $concession++;
                                                    }
                                                }
                                                $passengerIn = $adult + $concession;
                                            }
                                        }
                                        $tripIn['passenger_count'] = $passengerIn;
                                        $tripIn['sales_amount'] = $fareboxIn;
                                        $tripIn['total_on'] = $passengerIn;
                                        $tripIn['adult'] = $adult;
                                        $tripIn['concession'] = $concession;
        
                                        $inbound[$allInboundTrip->id] = $tripIn;
        
                                        $inboundPassenger += $tripIn['passenger_count'];
                                        $inboundSales += $tripIn['sales_amount'];
                                        $inboundAdult += $tripIn['adult'];
                                        $inboundConcession += $tripIn['concession'];
                                    }
                                    $totalInbound['passenger_count'] = $inboundPassenger;
                                    $totalInbound['sales_amount'] = $inboundSales;
                                    $totalInbound['total_on'] = $inboundPassenger;
                                    $totalInbound['adult'] = $inboundAdult;
                                    $totalInbound['concession'] = $inboundConcession;
        
                                    $inbound['total'] = $totalInbound;
                                }
        
                                //Outbound Trip
                                $allOutboundTrips = TripDetail::where('route_id', $routeByCompany->id)
                                    ->whereBetween('start_trip', [$firstDate, $lastDate])
                                    ->where('trip_code', 0)
                                    ->get();
        
                                $routeNameOut = implode(" - ", array_reverse(explode(" - ", $routeNameIn)));
        
                                $outbound = [];
                                $outboundPassenger = 0;
                                $outboundSales  = 0;
                                $outboundAdult  = 0;
                                $outboundConcession  = 0;
                                if (count($allOutboundTrips) > 0) {
                                    $existOutTrip = true;
                                    foreach ($allOutboundTrips as $allOutboundTrip) {
                                        $tripOut['trip_no'] = 'T' .  $allOutboundTrip->id;

                                        //Check bus_id
                                        if($allOutboundTrip->bus_id!=NULL) {
                                            $tripOut['bus_no'] = $allOutboundTrip->Bus->bus_registration_number;
                                        }
                                        else{
                                            $tripOut['bus_no'] = "No Data";
                                        }

                                        //Check driver_id
                                        if($allOutboundTrip->driver_id!=NULL) {
                                            $tripOut['driver_id'] = $allOutboundTrip->BusDriver->driver_number;
                                        }else{
                                            $tripOut['driver_id'] = "No Data";
                                        }
        
                                        $tripOut['service_date'] = $all_date;
                                        $firstStageOut = Stage::where('route_id',$routeByCompany->id)->orderBy('stage_order', 'DESC')->first();
                                        $tripOut['start_point'] = $firstStageOut->stage_name;
        
                                        //Check route_schedule_mstr_id
                                        if($allOutboundTrip->route_schedule_mstr_id!=NULL){
                                            $tripOut['service_start'] = Carbon::create($allOutboundTrip->RouteScheduleMSTR->schedule_start_time)->format('H:i');
                                        }else{
                                            $tripOut['service_start'] = "No Data";
                                        }
        
                                        $tripOut['actual_start'] = date("H:i", strtotime($allOutboundTrip->start_trip));
        
                                        //Check sales
                                        $firstTicket = TicketSalesTransaction::where('trip_id', $allOutboundTrip->id)
                                            ->orderby('sales_date')
                                            ->first();
                                        if($firstTicket){
                                            $tripOut['sales_start'] = date("H:i", strtotime($firstTicket->sales_date));
                                        }else{
                                            $tripOut['sales_start'] = "No Sales";
                                        }
        
                                        //Check route_schedule_mstr_id
                                        if($allOutboundTrip->route_schedule_mstr_id!=NULL){
                                            $tripOut['service_end'] = Carbon::create($allOutboundTrip->RouteScheduleMSTR->schedule_end_time)->format('H:i');
                                        }else{
                                            $tripOut['service_end'] = "No Data";
                                        }
        
                                        $tripOut['actual_end'] = date("H:i", strtotime($allOutboundTrip->end_trip));
        
                                        //Check sales
                                        $lastTicket = TicketSalesTransaction::where('trip_id', $allOutboundTrip->id)
                                            ->orderby('sales_date', 'DESC')
                                            ->first();
                                        if($lastTicket){
                                            $tripOut['sales_end'] = date("H:i", strtotime($lastTicket->sales_date));
                                        }else{
                                            $tripOut['sales_end'] = "No Sales";
                                        }
        
                                        $adult = $allOutboundTrip->total_adult;
                                        $concession = $allOutboundTrip->total_concession;
                                        $passengerOut = $adult + $concession;
        
                                        $adultFarebox = $allOutboundTrip->total_adult_amount;
                                        $concessionFarebox = $allOutboundTrip->total_concession_amount;
                                        $fareboxOut = $adultFarebox + $concessionFarebox;
        
                                        //Check tickets
                                        if($fareboxOut==0 || $passengerOut==0){
                                            $allTicketPerTrips = TicketSalesTransaction::where('trip_id', $allOutboundTrip->id)->get();
                                            if(count($allTicketPerTrips)>0){
                                                $adult = 0;
                                                $concession = 0;
                                                $passengerOut = 0;
                                                $fareboxOut = 0;
                                                foreach($allTicketPerTrips as $allTicketPerTrip){
                                                    $fareboxOut += $allTicketPerTrip->actual_amount;
                                                    if($allTicketPerTrip->passenger_type==0){
                                                        $adult++;
                                                    }else{
                                                        $concession++;
                                                    }
                                                }
                                                $passengerOut = $adult + $concession;
                                            }
                                        }
        
                                        $tripOut['passenger_count'] = $passengerOut;
                                        $tripOut['sales_amount'] = $fareboxOut;
                                        $tripOut['total_on'] = $passengerOut;
                                        $tripOut['adult'] = $adult;
                                        $tripOut['concession'] = $concession;
                                        $outbound[$allOutboundTrip->id] = $tripOut;
        
                                        $outboundPassenger += $tripOut['passenger_count'];
                                        $outboundSales += $tripOut['sales_amount'];
                                        $outboundAdult += $tripOut['adult'];
                                        $outboundConcession += $tripOut['concession'];
                                    }
                                    $totalOutbound['passenger_count'] = $outboundPassenger;
                                    $totalOutbound['sales_amount'] = $outboundSales;
                                    $totalOutbound['total_on'] = $outboundPassenger;
                                    $totalOutbound['adult'] = $outboundAdult;
                                    $totalOutbound['concession'] = $outboundConcession;
        
                                    $outbound['total'] = $totalOutbound;
                                }
        
                                $route_data = [];
                                $sumPassengerCount = 0;
                                $sumSalesAmount = 0;
                                $sumAdult = 0;
                                $sumConcession = 0;
                                if ($existInTrip == true && $existOutTrip == true) {
                                    //$out->writeln("YOU ARE IN HERE existInTrip == true && existOutTrip == true");
                                    $sumPassengerCount = $outboundPassenger + $inboundPassenger;
                                    $sumSalesAmount = $outboundSales + $inboundSales;
                                    $sumAdult = $outboundAdult +$inboundAdult;
                                    $sumConcession = $outboundConcession + $inboundConcession;
        
                                    $totalPerDate['passenger_count'] = $sumPassengerCount;
                                    $totalPerDate['sales_amount'] = $sumSalesAmount;
                                    $totalPerDate['total_on'] = $sumPassengerCount;
                                    $totalPerDate['adult'] = $sumAdult;
                                    $totalPerDate['concession'] = $sumConcession;
        
                                    $route_data[$routeNameIn] = $inbound;
                                    $route_data[$routeNameOut] = $outbound;
                                    $route_data['total_per_date'] = $totalPerDate;
                                    $perDate[$all_date] = $route_data;
        
                                } elseif ($existInTrip == false && $existOutTrip == true) {
                                   // $out->writeln("YOU ARE IN HERE existInTrip == false && existOutTrip == true");
                                    $sumPassengerCount = $outboundPassenger;
                                    $sumSalesAmount = $outboundSales;
                                    $sumAdult = $outboundAdult;
                                    $sumConcession = $outboundConcession;
        
                                    $totalPerDate['passenger_count'] = $sumPassengerCount;
                                    $totalPerDate['sales_amount'] = $sumSalesAmount;
                                    $totalPerDate['total_on'] = $sumPassengerCount;
                                    $totalPerDate['adult'] = $sumAdult;
                                    $totalPerDate['concession'] = $sumConcession;
        
                                    $route_data[$routeNameIn] = [];
                                    $route_data[$routeNameOut] = $outbound;
                                    $route_data['total_per_date'] = $totalPerDate;
                                    $perDate[$all_date] = $route_data;
        
                                } elseif ($existInTrip == true && $existOutTrip == false) {
                                    //$out->writeln("YOU ARE IN HERE existInTrip == true && existOutTrip == false");
                                    $sumPassengerCount =  $inboundPassenger;
                                    $sumSalesAmount = $inboundSales;
                                    $sumAdult = $inboundAdult;
                                    $sumConcession = $inboundConcession;
        
                                    $totalPerDate['passenger_count'] = $sumPassengerCount;
                                    $totalPerDate['sales_amount'] = $sumSalesAmount;
                                    $totalPerDate['total_on'] = $sumPassengerCount;
                                    $totalPerDate['adult'] = $sumAdult;
                                    $totalPerDate['concession'] = $sumConcession;
        
                                    $route_data[$routeNameIn] = $inbound;
                                    $route_data[$routeNameOut] = [];
                                    $route_data['total_per_date'] = $totalPerDate;
                                    $perDate[$all_date] = $route_data;
                                }else{
                                    //$out->writeln("YOU ARE IN HERE existInTrip == false && existOutTrip == false");
                                    $perDate[$all_date] = [];
                                }
                                $perRoutePassengerCount += $sumPassengerCount;
                                $perRouteSalesAmount += $sumSalesAmount;
                                $perRouteAdult += $sumAdult;
                                $perRouteConcession += $sumConcession;
                            }
                            $totalPerRoute['passenger_count'] = $perRoutePassengerCount;
                            $totalPerRoute['sales_amount'] = $perRouteSalesAmount;
                            $totalPerRoute['total_on'] = $perRoutePassengerCount;
                            $totalPerRoute['adult'] = $perRouteAdult;
                            $totalPerRoute['concession'] = $perRouteConcession;
        
                            $perDate['total_per_route'] = $totalPerRoute;
        
                            $perRoute[$routeByCompany->route_number] = $perDate;
        
                            $grandPassengerCount += $perRoutePassengerCount;
                            $grandSalesAmount += $perRouteSalesAmount;
                            $grandAdult += $perRouteAdult;
                            $grandConcession += $perRouteConcession;
                        }
                        $grand['passenger_count'] = $grandPassengerCount;
                        $grand['sales_amount'] = $grandSalesAmount;
                        $grand['total_on'] = $grandPassengerCount;
                        $grand['adult'] = $grandAdult;
                        $grand['concession'] = $grandConcession;
        
                        $data['allRoute'] = $perRoute;
                        $data['grand'] = $grand;
        
                        $tripSPAD->add($data);
                    }
                    //Trip specific route specific company
                    else{
                        $selectedRoute = Route::where('id', $validatedData['route_id'])->first();
                        $perRoutePassengerCount = 0;
                        $perRouteSalesAmount = 0;
                        $perRouteAdult = 0;
                        $perRouteConcession = 0;
                        $perDate = [];

                        foreach ($all_dates as $all_date) {
                            $existOutTrip = false;
                            $existInTrip = false;
                            $firstDate = new Carbon($all_date);
                            $lastDate = new Carbon($all_date . '23:59:59');

                            //Inbound Trip
                            $allInboundTrips = TripDetail::where('route_id', $selectedRoute->id)
                                ->whereBetween('start_trip', [$firstDate, $lastDate])
                                ->where('trip_code', 1)
                                ->get();

                            $routeNameIn = $selectedRoute->route_name;

                            $inbound = [];
                            $inboundPassenger = 0;
                            $inboundSales = 0;
                            $inboundAdult = 0;
                            $inboundConcession = 0;
                            if (count($allInboundTrips) > 0) {
                                $existInTrip = true;
                                foreach ($allInboundTrips as $allInboundTrip) {
                                    $tripIn['trip_no'] = 'T' . $allInboundTrip->id;

                                    //Check bus_id
                                    if($allInboundTrip->bus_id!=NULL) {
                                        $tripIn['bus_no'] = $allInboundTrip->Bus->bus_registration_number;
                                    }
                                    else{
                                        $tripIn['bus_no'] = "No Data";
                                    }

                                    //Check driver_id
                                    if($allInboundTrip->driver_id != NULL) {
                                        $tripIn['driver_id'] = $allInboundTrip->BusDriver->driver_number;
                                    }else{
                                        $tripIn['driver_id'] = "No Data";
                                    }

                                    $tripIn['service_date'] = $all_date;

                                    $firstStageIn = Stage::where('route_id', $selectedRoute->id)->first();
                                    $tripIn['start_point'] = $firstStageIn->stage_name;

                                    //Check route_schedule_mstr_id
                                    if($allInboundTrip->route_schedule_mstr_id != NULL) {
                                        $tripIn['service_start'] = Carbon::create($allInboundTrip->RouteScheduleMSTR->schedule_start_time)->format('H:i');
                                    }else{
                                        $tripIn['service_start'] = "No Data";
                                    }

                                    $tripIn['actual_start'] = date("H:i", strtotime($allInboundTrip->start_trip));

                                    //Check sales
                                    $firstTicket = TicketSalesTransaction::where('trip_id', $allInboundTrip->id)
                                        ->orderby('sales_date')
                                        ->first();
                                    if($firstTicket){
                                        $tripIn['sales_start'] = date("H:i", strtotime($firstTicket->sales_date));
                                    }else{
                                        $tripIn['sales_start'] = "No Sales";
                                    }

                                    //Check route_schedule_mstr_id
                                    if($allInboundTrip->route_schedule_mstr_id != NULL) {
                                        $tripIn['service_end'] = Carbon::create($allInboundTrip->RouteScheduleMSTR->schedule_end_time)->format('H:i');
                                    }else{
                                        $tripIn['service_end'] = "No Data";
                                    }

                                    $tripIn['actual_end'] = date("H:i", strtotime($allInboundTrip->end_trip));

                                    //Check sales
                                    $lastTicket = TicketSalesTransaction::where('trip_id', $allInboundTrip->id)
                                        ->orderby('sales_date', 'DESC')
                                        ->first();
                                    if($lastTicket){
                                        $tripIn['sales_end'] = date("H:i", strtotime($lastTicket->sales_date));
                                    }else{
                                        $tripIn['sales_end'] = "No Sales";
                                    }

                                    $adult = $allInboundTrip->total_adult;
                                    $concession = $allInboundTrip->total_concession;
                                    $passengerIn = $adult + $concession;

                                    $adultFarebox = $allInboundTrip->total_adult_amount;
                                    $concessionFarebox = $allInboundTrip->total_concession_amount;
                                    $fareboxIn = $adultFarebox + $concessionFarebox;

                                    //Check tickets
                                    if($fareboxIn==0 || $passengerIn==0){
                                        $allTicketPerTrips = TicketSalesTransaction::where('trip_id', $allInboundTrip->id)->get();
                                        if(count($allTicketPerTrips)>0){
                                            $adult = 0;
                                            $concession = 0;
                                            $passengerIn = 0;
                                            $fareboxIn = 0;
                                            foreach($allTicketPerTrips as $allTicketPerTrip){
                                                $fareboxIn += $allTicketPerTrip->actual_amount;
                                                if($allTicketPerTrip->passenger_type==0){
                                                    $adult++;
                                                }else{
                                                    $concession++;
                                                }
                                            }
                                            $passengerIn = $adult + $concession;
                                        }
                                    }

                                    $tripIn['passenger_count'] = $passengerIn;
                                    $tripIn['sales_amount'] = $fareboxIn;
                                    $tripIn['total_on'] = $passengerIn;
                                    $tripIn['adult'] = $adult;
                                    $tripIn['concession'] =$concession;

                                    $inbound[$allInboundTrip->id] = $tripIn;

                                    $inboundPassenger += $tripIn['passenger_count'];
                                    $inboundSales += $tripIn['sales_amount'];
                                    $inboundAdult += $tripIn['adult'];
                                    $inboundConcession += $tripIn['concession'];
                                }
                                $totalInbound['passenger_count'] = $inboundPassenger;
                                $totalInbound['sales_amount'] = $inboundSales;
                                $totalInbound['total_on'] = $inboundPassenger;
                                $totalInbound['adult'] = $inboundAdult;
                                $totalInbound['concession'] = $inboundConcession;

                                $inbound['total'] = $totalInbound;
                            }

                            //Outbound Trip
                            $allOutboundTrips = TripDetail::where('route_id', $selectedRoute->id)
                                ->whereBetween('start_trip', [$firstDate, $lastDate])
                                ->where('trip_code', 0)
                                ->get();

                            $routeNameOut = implode(" - ", array_reverse(explode(" - ", $routeNameIn)));

                            $outbound = [];
                            $outboundPassenger = 0;
                            $outboundSales  = 0;
                            $outboundAdult  = 0;
                            $outboundConcession  = 0;
                            if (count($allOutboundTrips) > 0) {
                                $existOutTrip = true;
                                foreach ($allOutboundTrips as $allOutboundTrip) {
                                    $tripOut['trip_no'] = 'T' . $allOutboundTrip->id;

                                    //Check bus_id
                                    if($allOutboundTrip->bus_id!=NULL) {
                                        $tripOut['bus_no'] = $allOutboundTrip->Bus->bus_registration_number;
                                    }
                                    else{
                                        $tripOut['bus_no'] = "No Data";
                                    }

                                    //Check driver_id
                                    if($allOutboundTrip->driver_id!=NULL) {
                                        $tripOut['driver_id'] = $allOutboundTrip->BusDriver->driver_number;
                                    }else{
                                        $tripOut['driver_id'] = "No Data";
                                    }

                                    $tripOut['service_date'] = $all_date;
                                    $firstStageOut = Stage::where('route_id',$selectedRoute->id)->orderBy('stage_order', 'DESC')->first();
                                    $tripOut['start_point'] = $firstStageOut->stage_name;

                                    //Check route_schedule_mstr_id
                                    if($allOutboundTrip->route_schedule_mstr_id!=NULL){
                                        $tripOut['service_start'] = Carbon::create($allOutboundTrip->RouteScheduleMSTR->schedule_start_time)->format('H:i');
                                    }else{
                                        $tripOut['service_start'] = "No Data";
                                    }

                                    $tripOut['actual_start'] = date("H:i", strtotime($allOutboundTrip->start_trip));

                                    //Check sales
                                    $firstTicket = TicketSalesTransaction::where('trip_id', $allOutboundTrip->id)
                                        ->orderby('sales_date')
                                        ->first();
                                    if($firstTicket){
                                        $tripOut['sales_start'] = date("H:i", strtotime($firstTicket->sales_date));
                                    }else{
                                        $tripOut['sales_start'] = "No Sales";
                                    }

                                    //Check route_schedule_mstr_id
                                    if($allOutboundTrip->route_schedule_mstr_id!=NULL){
                                        $tripOut['service_end'] = Carbon::create($allOutboundTrip->RouteScheduleMSTR->schedule_end_time)->format('H:i');
                                    }else{
                                        $tripOut['service_end'] = "No Data";
                                    }

                                    $tripOut['actual_end'] = date("H:i", strtotime($allOutboundTrip->end_trip));

                                    //Check sales
                                    $lastTicket = TicketSalesTransaction::where('trip_id', $allOutboundTrip->id)
                                        ->orderby('sales_date', 'DESC')
                                        ->first();
                                    if($lastTicket){
                                        $tripOut['sales_end'] = date("H:i", strtotime($lastTicket->sales_date));
                                    }else{
                                        $tripOut['sales_end'] = "No Sales";
                                    }

                                    $adult = $allOutboundTrip->total_adult;
                                    $concession = $allOutboundTrip->total_concession;
                                    $passengerOut = $adult + $concession;

                                    $adultFarebox = $allOutboundTrip->total_adult_amount;
                                    $concessionFarebox = $allOutboundTrip->total_concession_amount;
                                    $fareboxOut = $adultFarebox + $concessionFarebox;

                                    //Check tickets
                                    if($fareboxOut==0 || $passengerOut==0){
                                        $allTicketPerTrips = TicketSalesTransaction::where('trip_id', $allOutboundTrip->id)->get();
                                        if(count($allTicketPerTrips)>0){
                                            $adult = 0;
                                            $concession = 0;
                                            $passengerOut = 0;
                                            $fareboxOut = 0;
                                            foreach($allTicketPerTrips as $allTicketPerTrip){
                                                $fareboxOut += $allTicketPerTrip->actual_amount;
                                                if($allTicketPerTrip->passenger_type==0){
                                                    $adult++;
                                                }else{
                                                    $concession++;
                                                }
                                            }
                                            $passengerOut = $adult + $concession;
                                        }
                                    }
                                    $tripOut['passenger_count'] = $passengerOut;
                                    $tripOut['sales_amount'] = $fareboxOut;
                                    $tripOut['total_on'] = $passengerOut;
                                    $tripOut['adult'] = $adult;
                                    $tripOut['concession'] = $concession;

                                    $outbound[$allOutboundTrip->id] = $tripOut;

                                    $outboundPassenger += $tripOut['passenger_count'];
                                    $outboundSales += $tripOut['sales_amount'];
                                    $outboundAdult += $tripOut['adult'];
                                    $outboundConcession += $tripOut['concession'];
                                }
                                $totalOutbound['passenger_count'] = $outboundPassenger;
                                $totalOutbound['sales_amount'] = $outboundSales;
                                $totalOutbound['total_on'] = $outboundPassenger;
                                $totalOutbound['adult'] = $outboundAdult;
                                $totalOutbound['concession'] = $outboundConcession;

                                $outbound['total'] = $totalOutbound;
                            }

                            $route_data = [];
                            $sumPassengerCount = 0;
                            $sumSalesAmount = 0;
                            $sumAdult = 0;
                            $sumConcession = 0;
                            if ($existInTrip == true && $existOutTrip == true) {
                                //$out->writeln("YOU ARE IN HERE existInTrip == true && existOutTrip == true");
                                $sumPassengerCount = $outboundPassenger + $inboundPassenger;
                                $sumSalesAmount = $outboundSales + $inboundSales;
                                $sumAdult = $outboundAdult +$inboundAdult;
                                $sumConcession = $outboundConcession + $inboundConcession;

                                $totalPerDate['passenger_count'] = $sumPassengerCount;
                                $totalPerDate['sales_amount'] = $sumSalesAmount;
                                $totalPerDate['total_on'] = $sumPassengerCount;
                                $totalPerDate['adult'] = $sumAdult;
                                $totalPerDate['concession'] = $sumConcession;

                                $route_data[$routeNameIn] = $inbound;
                                $route_data[$routeNameOut] = $outbound;
                                $route_data['total_per_date'] = $totalPerDate;
                                $perDate[$all_date] = $route_data;

                            } elseif ($existInTrip == false && $existOutTrip == true) {
                                //$out->writeln("YOU ARE IN HERE existInTrip == false && existOutTrip == true");
                                $sumPassengerCount = $outboundPassenger;
                                $sumSalesAmount = $outboundSales;
                                $sumAdult = $outboundAdult;
                                $sumConcession = $outboundConcession;

                                $totalPerDate['passenger_count'] = $sumPassengerCount;
                                $totalPerDate['sales_amount'] = $sumSalesAmount;
                                $totalPerDate['total_on'] = $sumPassengerCount;
                                $totalPerDate['adult'] = $sumAdult;
                                $totalPerDate['concession'] = $sumConcession;

                                $route_data[$routeNameIn] = [];
                                $route_data[$routeNameOut] = $outbound;
                                $route_data['total_per_date'] = $totalPerDate;
                                $perDate[$all_date] = $route_data;

                            } elseif ($existInTrip == true && $existOutTrip == false) {
                                //$out->writeln("YOU ARE IN HERE existInTrip == true && existOutTrip == false");
                                $sumPassengerCount =  $inboundPassenger;
                                $sumSalesAmount = $inboundSales;
                                $sumAdult = $inboundAdult;
                                $sumConcession = $inboundConcession;

                                $totalPerDate['passenger_count'] = $sumPassengerCount;
                                $totalPerDate['sales_amount'] = $sumSalesAmount;
                                $totalPerDate['total_on'] = $sumPassengerCount;
                                $totalPerDate['adult'] = $sumAdult;
                                $totalPerDate['concession'] = $sumConcession;

                                $route_data[$routeNameIn] = $inbound;
                                $route_data[$routeNameOut] = [];
                                $route_data['total_per_date'] = $totalPerDate;
                                $perDate[$all_date] = $route_data;
                            }else{
                                //$out->writeln("YOU ARE IN HERE existInTrip == false && existOutTrip == false");
                                $perDate[$all_date] = [];
                            }
                            $perRoutePassengerCount += $sumPassengerCount;
                            $perRouteSalesAmount += $sumSalesAmount;
                            $perRouteAdult += $sumAdult;
                            $perRouteConcession += $sumConcession;
                        }
                        $totalPerRoute['passenger_count'] = $perRoutePassengerCount;
                        $totalPerRoute['sales_amount'] = $perRouteSalesAmount;
                        $totalPerRoute['total_on'] = $perRoutePassengerCount;
                        $totalPerRoute['adult'] = $perRouteAdult;
                        $totalPerRoute['concession'] = $perRouteConcession;

                        $perDate['total_per_route'] = $totalPerRoute;

                        $perRoute[$selectedRoute->route_number] = $perDate;

                        $grand['passenger_count'] = $perRoutePassengerCount;
                        $grand['sales_amount'] = $perRouteSalesAmount;
                        $grand['total_on'] = $perRoutePassengerCount;
                        $grand['adult'] = $perRouteAdult;
                        $grand['concession'] = $perRouteConcession;

                        $data['allRoute'] = $perRoute;
                        $data['grand'] = $grand;

                        $tripSPAD->add($data);
                    }
                }
            }
            //return Excel::download(new SPADTrip($tripSPAD, $validatedData['dateFrom'], $validatedData['dateTo'], $networkArea), 'Trip_Report_SPAD_'.Carbon::now()->format('YmdHis').'.xlsx');
        }else{
            $this->dispatchBrowserEvent('company-required');
        }
    }

    public function printTopBoardings()
    {
        $out = new ConsoleOutput();
        $out->writeln("YOU ARE IN printTopBoarding()");

        $validatedData = Validator::make($this->state,[
            'dateFrom' => ['required', 'date'],
            'dateTo' => ['required', 'date'],
            'route_id' => ['required'],
        ])->validate();

        $dateFrom = new Carbon($validatedData['dateFrom']);
        $dateTo = new Carbon($validatedData['dateTo'] . '23:59:59');

        $topBoardingSPAD = collect();
        $grandTotalOnIn = 0;
        $grandAdultIn = 0;
        $grandConcessionIn = 0;
        $grandTotalOnOut = 0;
        $grandAdultOut = 0;
        $grandConcessionOut = 0;
        $perRoute = [];
        if($this->selectedCompany){
            if($this->selectedCompany=='All'){
                $networkArea = 'All';
                if(!empty($validatedData['route_id'])) {
                    //Top Boarding all route all company
                    if($validatedData['route_id']=='All'){
                        $allRoutes = Route::orderBy('route_number')->get();
                        
                        foreach($allRoutes as $allRoute) {
                            $allStages = Stage::where('route_id', $allRoute->id)->get();
                            $totalTotalOnIn = 0;
                            $totalAdultIn = 0;
                            $totalConcessionIn = 0;
                            $totalTotalOnOut = 0;
                            $totalAdultOut = 0;
                            $totalConcessionOut = 0;
                            $perStage = [];
            
                            if (count($allStages) > 0) {
                                foreach ($allStages as $allStage) {
                                    $trip_data = [];
            
                                    //Inbound Trip
                                    $allInboundTrips = TripDetail::where('route_id', $allRoute->id)
                                        ->whereBetween('start_trip', [$dateFrom, $dateTo])
                                        ->where('trip_code', 1)
                                        ->get();
            
                                    $countIn = 0;
                                    $adultIn = 0;
                                    $concessionIn = 0;
                                    if (count($allInboundTrips) > 0) {
                                        foreach ($allInboundTrips as $allInboundTrip) {
                                            $ticketInTrips = TicketSalesTransaction::where('trip_id', $allInboundTrip->id)
                                                ->where('fromstage_stage_id', $allStage->id)
                                                ->get();
            
                                            if (count($ticketInTrips) > 0) {
                                                foreach ($ticketInTrips as $ticketInTrip) {
                                                    $countIn++;
                                                    if ($ticketInTrip->passenger_type == 0) {
                                                        $adultIn++;
                                                    } elseif ($ticketInTrip->passenger_type == 1) {
                                                        $concessionIn++;
                                                    }
                                                }
                                            }
                                        }
                                    }
            
                                    //Outbound Trip
                                    $allOutboundTrips = TripDetail::where('route_id', $allRoute->id)
                                        ->whereBetween('start_trip', [$dateFrom, $dateTo])
                                        ->where('trip_code', 0)
                                        ->get();
            
                                    $countOut = 0;
                                    $adultOut = 0;
                                    $concessionOut = 0;
                                    if (count($allInboundTrips) > 0) {
                                        foreach ($allOutboundTrips as $allOutboundTrip) {
                                            $ticketOutTrips = TicketSalesTransaction::where('trip_id', $allOutboundTrip->id)
                                                ->where('fromstage_stage_id', $allStage->id)
                                                ->get();
            
                                            if (count($ticketOutTrips) > 0) {
                                                foreach ($ticketOutTrips as $ticketOutTrip) {
                                                    $countOut++;
                                                    if ($ticketOutTrip->passenger_type == 0) {
                                                        $adultOut++;
                                                    } elseif ($ticketOutTrip->passenger_type == 1) {
                                                        $concessionOut++;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    $trip_data['total_on_in'] = $countIn;
                                    $trip_data['adult_in'] = $adultIn;
                                    $trip_data['concession_in'] = $concessionIn;
                                    $trip_data['total_on_out'] = $countOut;
                                    $trip_data['adult_out'] = $adultOut;
                                    $trip_data['concession_out'] = $concessionOut;
            
                                    $perStage[$allStage->stage_order . '. ' . $allStage->stage_name] = $trip_data;
            
                                    $totalTotalOnIn += $countIn;
                                    $totalAdultIn += $adultIn;
                                    $totalConcessionIn += $concessionIn;
                                    $totalTotalOnOut += $countOut;
                                    $totalAdultOut += $adultOut;
                                    $totalConcessionOut += $concessionOut;
                                }
                            }
            
                            if ($totalTotalOnIn == 0 && $totalAdultIn == 0 && $totalConcessionIn == 0 && $totalTotalOnOut == 0 && $totalAdultOut == 0 && $totalConcessionOut == 0) {
                                $perRoute[$allRoute->route_number] = [];
                            } else{
                                $total_in = [];
                                foreach ($perStage as $key => $row) {
                                    //$out->writeln("You are in loop array multisort");
                                    $total_in[$key] = $row['total_on_in'];
                                }
                                array_multisort($total_in, SORT_DESC, $perStage);
            
                                $total['total_on_in'] = $totalTotalOnIn;
                                $total['adult_in'] = $totalAdultIn;
                                $total['concession_in'] = $totalConcessionIn;
                                $total['total_on_out'] = $totalTotalOnOut;
                                $total['adult_out'] = $totalAdultOut;
                                $total['concession_out'] = $totalConcessionOut;
            
                                $perStage['total_per_route'] = $total;
                                $perRoute[$allRoute->route_number] = $perStage;
                            }
            
                            $grandTotalOnIn += $totalTotalOnIn;
                            $grandAdultIn += $totalAdultIn;
                            $grandConcessionIn += $totalConcessionIn;
                            $grandTotalOnOut += $totalTotalOnOut;
                            $grandAdultOut += $totalAdultOut;
                            $grandConcessionOut += $totalConcessionOut;
                        }
                        $grand['total_on_in'] = $grandTotalOnIn;
                        $grand['adult_in'] = $grandAdultIn;
                        $grand['concession_in'] = $grandConcessionIn;
                        $grand['total_on_out'] = $grandTotalOnOut;
                        $grand['adult_out'] = $grandAdultOut;
                        $grand['concession_out'] = $grandConcessionOut;
            
                        $data['allRoute'] = $perRoute;
                        $data['grand'] = $grand;
                        $topBoardingSPAD->add($data);
                    }
                }
            }else{
                $selectedCompany = Company::where('id', $this->selectedCompany)->first();
                $networkArea = $selectedCompany->company_name;
                if(!empty($validatedData['route_id'])) {
                    //Top Boarding all route specific company
                    if($validatedData['route_id']=='All'){
                        $routeByCompanies = Route::where('company_id', $this->selectedCompany)->orderBy('route_number')->get();
        
                        foreach ($routeByCompanies as $routeByCompany) {
                            $out->writeln("allRoute: " . $routeByCompany->route_number);
                            $allStages = Stage::where('route_id', $routeByCompany->id)->get();
                            $totalTotalOnIn = 0;
                            $totalAdultIn = 0;
                            $totalConcessionIn = 0;
                            $totalTotalOnOut = 0;
                            $totalAdultOut = 0;
                            $totalConcessionOut = 0;
                            $perStage = [];
        
                            if (count($allStages) > 0) {
                                foreach ($allStages as $allStage) {
                                    $trip_data = [];
        
                                    //Inbound Trip
                                    $allInboundTrips = TripDetail::where('route_id', $routeByCompany->id)
                                        ->whereBetween('start_trip', [$dateFrom, $dateTo])
                                        ->where('trip_code', 1)
                                        ->get();
        
                                    $countIn = 0;
                                    $adultIn = 0;
                                    $concessionIn = 0;
                                    if (count($allInboundTrips) > 0) {
                                        foreach ($allInboundTrips as $allInboundTrip) {
                                            $ticketInTrips = TicketSalesTransaction::where('trip_id', $allInboundTrip->id)
                                                ->where('fromstage_stage_id', $allStage->id)
                                                ->get();
        
                                            if (count($ticketInTrips) > 0) {
                                                foreach ($ticketInTrips as $ticketInTrip) {
                                                    $countIn++;
                                                    if ($ticketInTrip->passenger_type == 0) {
                                                        $adultIn++;
                                                    } elseif ($ticketInTrip->passenger_type == 1) {
                                                        $concessionIn++;
                                                    }
                                                }
                                            }
                                        }
                                    }
        
                                    //Outbound Trip
                                    $allOutboundTrips = TripDetail::where('route_id', $routeByCompany->id)
                                        ->whereBetween('start_trip', [$dateFrom, $dateTo])
                                        ->where('trip_code', 0)
                                        ->get();
        
                                    $countOut = 0;
                                    $adultOut = 0;
                                    $concessionOut = 0;
                                    if (count($allInboundTrips) > 0) {
                                        foreach ($allOutboundTrips as $allOutboundTrip) {
                                            $ticketOutTrips = TicketSalesTransaction::where('trip_id', $allOutboundTrip->id)
                                                ->where('fromstage_stage_id', $allStage->id)
                                                ->get();
        
                                            if (count($ticketOutTrips) > 0) {
                                                foreach ($ticketOutTrips as $ticketOutTrip) {
                                                    $countOut++;
                                                    if ($ticketOutTrip->passenger_type == 0) {
                                                        $adultOut++;
                                                    } elseif ($ticketOutTrip->passenger_type == 1) {
                                                        $concessionOut++;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    $trip_data['total_on_in'] = $countIn;
                                    $trip_data['adult_in'] = $adultIn;
                                    $trip_data['concession_in'] = $concessionIn;
                                    $trip_data['total_on_out'] = $countOut;
                                    $trip_data['adult_out'] = $adultOut;
                                    $trip_data['concession_out'] = $concessionOut;
        
                                    $perStage[$allStage->stage_order . '. ' . $allStage->stage_name] = $trip_data;
        
                                    $totalTotalOnIn += $countIn;
                                    $totalAdultIn += $adultIn;
                                    $totalConcessionIn += $concessionIn;
                                    $totalTotalOnOut += $countOut;
                                    $totalAdultOut += $adultOut;
                                    $totalConcessionOut += $concessionOut;
                                }
                            }
        
                            if ($totalTotalOnIn == 0 && $totalAdultIn == 0 && $totalConcessionIn == 0 && $totalTotalOnOut == 0 && $totalAdultOut == 0 && $totalConcessionOut == 0) {
                                $perRoute[$routeByCompany->route_number] = [];
                            } else {
                                $total_in = [];
                                foreach ($perStage as $key => $row) {
                                    //$out->writeln("You are in loop array multisort");
                                    $total_in[$key] = $row['total_on_in'];
                                }
                                array_multisort($total_in, SORT_DESC, $perStage);
        
                                $total['total_on_in'] = $totalTotalOnIn;
                                $total['adult_in'] = $totalAdultIn;
                                $total['concession_in'] = $totalConcessionIn;
                                $total['total_on_out'] = $totalTotalOnOut;
                                $total['adult_out'] = $totalAdultOut;
                                $total['concession_out'] = $totalConcessionOut;
        
                                $perStage['total_per_route'] = $total;
                                $perRoute[$routeByCompany->route_number] = $perStage;
                            }
        
                            $grandTotalOnIn += $totalTotalOnIn;
                            $grandAdultIn += $totalAdultIn;
                            $grandConcessionIn += $totalConcessionIn;
                            $grandTotalOnOut += $totalTotalOnOut;
                            $grandAdultOut += $totalAdultOut;
                            $grandConcessionOut += $totalConcessionOut;
                        }
                        $grand['total_on_in'] = $grandTotalOnIn;
                        $grand['adult_in'] = $grandAdultIn;
                        $grand['concession_in'] = $grandConcessionIn;
                        $grand['total_on_out'] = $grandTotalOnOut;
                        $grand['adult_out'] = $grandAdultOut;
                        $grand['concession_out'] = $grandConcessionOut;
        
                        $data['allRoute'] = $perRoute;
                        $data['grand'] = $grand;
                        $topBoardingSPAD->add($data);
                    }
                    //Top Boarding specific route specific company
                    else{
                        $validatedRoute = Route::where('id', $validatedData['route_id'])->first();
                        $allStages = Stage::where('route_id', $validatedRoute->id)->get();
                        $totalTotalOnIn = 0;
                        $totalAdultIn = 0;
                        $totalConcessionIn = 0;
                        $totalTotalOnOut = 0;
                        $totalAdultOut = 0;
                        $totalConcessionOut = 0;
                        $perStage = [];
        
                        if (count($allStages) > 0) {
                            foreach ($allStages as $allStage) {
                                $trip_data = [];
        
                                //Inbound Trip
                                $allInboundTrips = TripDetail::where('route_id', $validatedRoute->id)
                                    ->whereBetween('start_trip', [$dateFrom, $dateTo])
                                    ->where('trip_code', 1)
                                    ->get();
        
                                $countIn = 0;
                                $adultIn = 0;
                                $concessionIn = 0;
                                if (count($allInboundTrips) > 0) {
                                    foreach ($allInboundTrips as $allInboundTrip) {
                                        $ticketInTrips = TicketSalesTransaction::where('trip_id', $allInboundTrip->id)
                                            ->where('fromstage_stage_id', $allStage->id)
                                            ->get();
        
                                        if (count($ticketInTrips) > 0) {
                                            foreach ($ticketInTrips as $ticketInTrip) {
                                                $countIn++;
                                                if ($ticketInTrip->passenger_type == 0) {
                                                    $adultIn++;
                                                } elseif ($ticketInTrip->passenger_type == 1) {
                                                    $concessionIn++;
                                                }
                                            }
                                        }
                                    }
                                }
        
                                //Outbound Trip
                                $allOutboundTrips = TripDetail::where('route_id', $validatedRoute->id)
                                    ->whereBetween('start_trip', [$dateFrom, $dateTo])
                                    ->where('trip_code', 0)
                                    ->get();
        
                                $countOut = 0;
                                $adultOut = 0;
                                $concessionOut = 0;
                                if (count($allInboundTrips) > 0) {
                                    foreach ($allOutboundTrips as $allOutboundTrip) {
                                        $ticketOutTrips = TicketSalesTransaction::where('trip_id', $allOutboundTrip->id)
                                            ->where('fromstage_stage_id', $allStage->id)
                                            ->get();
        
                                        if (count($ticketOutTrips) > 0) {
                                            foreach ($ticketOutTrips as $ticketOutTrip) {
                                                $countOut++;
                                                if ($ticketOutTrip->passenger_type == 0) {
                                                    $adultOut++;
                                                } elseif ($ticketOutTrip->passenger_type == 1) {
                                                    $concessionOut++;
                                                }
                                            }
                                        }
                                    }
                                }
                                $trip_data['total_on_in'] = $countIn;
                                $trip_data['adult_in'] = $adultIn;
                                $trip_data['concession_in'] = $concessionIn;
                                $trip_data['total_on_out'] = $countOut;
                                $trip_data['adult_out'] = $adultOut;
                                $trip_data['concession_out'] = $concessionOut;
        
                                $perStage[$allStage->stage_order . '. ' . $allStage->stage_name] = $trip_data;
        
                                $totalTotalOnIn += $countIn;
                                $totalAdultIn += $adultIn;
                                $totalConcessionIn += $concessionIn;
                                $totalTotalOnOut += $countOut;
                                $totalAdultOut += $adultOut;
                                $totalConcessionOut += $concessionOut;
                            }
                        }
        
                        if ($totalTotalOnIn == 0 && $totalAdultIn == 0 && $totalConcessionIn == 0 && $totalTotalOnOut == 0 && $totalAdultOut == 0 && $totalConcessionOut == 0) {
                            $perRoute[$validatedRoute->route_number] = [];
                        } else {
                            $total_in = [];
                            foreach ($perStage as $key => $row) {
                                //$out->writeln("You are in loop array multisort");
                                $total_in[$key] = $row['total_on_in'];
                            }
                            array_multisort($total_in, SORT_DESC, $perStage);
        
                            $total['total_on_in'] = $totalTotalOnIn;
                            $total['adult_in'] = $totalAdultIn;
                            $total['concession_in'] = $totalConcessionIn;
                            $total['total_on_out'] = $totalTotalOnOut;
                            $total['adult_out'] = $totalAdultOut;
                            $total['concession_out'] = $totalConcessionOut;
        
                            $perStage['total_per_route'] = $total;
                            $perRoute[$validatedRoute->route_number] = $perStage;
                        }
        
                        $grandTotalOnIn = $totalTotalOnIn;
                        $grandAdultIn = $totalAdultIn;
                        $grandConcessionIn = $totalConcessionIn;
                        $grandTotalOnOut = $totalTotalOnOut;
                        $grandAdultOut = $totalAdultOut;
                        $grandConcessionOut = $totalConcessionOut;
        
                        $grand['total_on_in'] = $grandTotalOnIn;
                        $grand['adult_in'] = $grandAdultIn;
                        $grand['concession_in'] = $grandConcessionIn;
                        $grand['total_on_out'] = $grandTotalOnOut;
                        $grand['adult_out'] = $grandAdultOut;
                        $grand['concession_out'] = $grandConcessionOut;
        
                        $data['allRoute'] = $perRoute;
                        $data['grand'] = $grand;
                        $topBoardingSPAD->add($data);
                    }
                }
            }
            return Excel::download(new SPADTopBoarding($topBoardingSPAD, $validatedData['dateFrom'], $validatedData['dateTo'], $networkArea), 'Top_Boarding_Report_SPAD_'.Carbon::now()->format('YmdHis').'.xlsx');
        }else{
            $this->dispatchBrowserEvent('company-required');
        }
    }

    public function printTopAlighting()
    {
        $out = new ConsoleOutput();
        $out->writeln("YOU ARE IN printTopAlighting()");

        $validatedData = Validator::make($this->state,[
            'dateFrom' => ['required', 'date'],
            'dateTo' => ['required', 'date'],
            'route_id' => ['required'],
        ])->validate();

        $dateFrom = new Carbon($validatedData['dateFrom']);
        $dateTo = new Carbon($validatedData['dateTo'] . '23:59:59');

        $topAlightingSPAD = collect();
        $grandTotalOffIn = 0;
        $grandAdultIn = 0;
        $grandConcessionIn = 0;
        $grandTotalOffOut = 0;
        $grandAdultOut = 0;
        $grandConcessionOut = 0;
        $perRoute = [];
        if($this->selectedCompany){
            if($this->selectedCompany=='All'){
                $networkArea = 'All';
                if(!empty($validatedData['route_id'])) {
                    //Top Alighting all route all company
                    if($validatedData['route_id']=='All'){
                        $allRoutes = Route::orderBy('route_number')->get();
            
                        foreach($allRoutes as $allRoute) {
                            $allStages = Stage::where('route_id', $allRoute->id)->get();
                            $totalTotalOffIn = 0;
                            $totalAdultIn = 0;
                            $totalConcessionIn = 0;
                            $totalTotalOffOut = 0;
                            $totalAdultOut = 0;
                            $totalConcessionOut = 0;
                            $perStage = [];
            
                            if (count($allStages) > 0) {
                                foreach ($allStages as $allStage) {
                                    $trip_data = [];
            
                                    //Inbound Trip
                                    $allInboundTrips = TripDetail::where('route_id', $allRoute->id)
                                        ->whereBetween('start_trip', [$dateFrom, $dateTo])
                                        ->where('trip_code', 1)
                                        ->get();
            
                                    $countIn = 0;
                                    $adultIn = 0;
                                    $concessionIn = 0;
                                    if (count($allInboundTrips) > 0) {
                                        foreach ($allInboundTrips as $allInboundTrip) {
                                            $ticketInTrips = TicketSalesTransaction::where('trip_id', $allInboundTrip->id)
                                                ->where('tostage_stage_id', $allStage->id)
                                                ->get();
            
                                            if (count($ticketInTrips) > 0) {
                                                foreach ($ticketInTrips as $ticketInTrip) {
                                                    $countIn++;
                                                    if ($ticketInTrip->passenger_type == 0) {
                                                        $adultIn++;
                                                    } elseif ($ticketInTrip->passenger_type == 1) {
                                                        $concessionIn++;
                                                    }
                                                }
                                            }
                                        }
                                    }
            
                                    //Outbound Trip
                                    $allOutboundTrips = TripDetail::where('route_id', $allRoute->id)
                                        ->whereBetween('start_trip', [$dateFrom, $dateTo])
                                        ->where('trip_code', 0)
                                        ->get();
            
                                    $countOut = 0;
                                    $adultOut = 0;
                                    $concessionOut = 0;
                                    if (count($allInboundTrips) > 0) {
                                        foreach ($allOutboundTrips as $allOutboundTrip) {
                                            $ticketOutTrips = TicketSalesTransaction::where('trip_id', $allOutboundTrip->id)
                                                ->where('tostage_stage_id', $allStage->id)
                                                ->get();
            
                                            if (count($ticketOutTrips) > 0) {
                                                foreach ($ticketOutTrips as $ticketOutTrip) {
                                                    $countOut++;
                                                    if ($ticketOutTrip->passenger_type == 0) {
                                                        $adultOut++;
                                                    } elseif ($ticketOutTrip->passenger_type == 1) {
                                                        $concessionOut++;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    $trip_data['total_off_in'] = $countIn;
                                    $trip_data['adult_in'] = $adultIn;
                                    $trip_data['concession_in'] = $concessionIn;
                                    $trip_data['total_off_out'] = $countOut;
                                    $trip_data['adult_out'] = $adultOut;
                                    $trip_data['concession_out'] = $concessionOut;
            
                                    $perStage[$allStage->stage_order . '. ' . $allStage->stage_name] = $trip_data;
            
                                    $totalTotalOffIn += $countIn;
                                    $totalAdultIn += $adultIn;
                                    $totalConcessionIn += $concessionIn;
                                    $totalTotalOffOut += $countOut;
                                    $totalAdultOut += $adultOut;
                                    $totalConcessionOut += $concessionOut;
                                }
                            }
            
                            if ($totalTotalOffIn == 0 && $totalAdultIn == 0 && $totalConcessionIn == 0 && $totalTotalOffOut == 0 && $totalAdultOut == 0 && $totalConcessionOut == 0) {
                                $perRoute[$allRoute->route_number] = [];
                            } else{
                                $total_in = [];
                                foreach ($perStage as $key => $row) {
                                    //$out->writeln("You are in loop array multisort");
                                    $total_in[$key] = $row['total_off_in'];
                                }
                                array_multisort($total_in, SORT_DESC, $perStage);
            
                                $total['total_off_in'] = $totalTotalOffIn;
                                $total['adult_in'] = $totalAdultIn;
                                $total['concession_in'] = $totalConcessionIn;
                                $total['total_off_out'] = $totalTotalOffOut;
                                $total['adult_out'] = $totalAdultOut;
                                $total['concession_out'] = $totalConcessionOut;
            
                                $perStage['total_per_route'] = $total;
                                $perRoute[$allRoute->route_number] = $perStage;
                            }
            
                            $grandTotalOffIn += $totalTotalOffIn;
                            $grandAdultIn += $totalAdultIn;
                            $grandConcessionIn += $totalConcessionIn;
                            $grandTotalOffOut += $totalTotalOffOut;
                            $grandAdultOut += $totalAdultOut;
                            $grandConcessionOut += $totalConcessionOut;
                        }
                        $grand['total_off_in'] = $grandTotalOffIn;
                        $grand['adult_in'] = $grandAdultIn;
                        $grand['concession_in'] = $grandConcessionIn;
                        $grand['total_off_out'] = $grandTotalOffOut;
                        $grand['adult_out'] = $grandAdultOut;
                        $grand['concession_out'] = $grandConcessionOut;
            
            
                        $data['allRoute'] = $perRoute;
                        $data['grand'] = $grand;
                        $topAlightingSPAD->add($data);
                    }
                }
            }else{
                $companyDetails = Company::where('id', $this->selectedCompany)->first();
                $networkArea = $companyDetails->company_name;

                if(!empty($validatedData['route_id'])) {
                    //Top Alighting all route specific company
                    if($validatedData['route_id']=='All'){
                        $routeByCompanies = Route::where('company_id', $this->selectedCompany)->orderBy('route_number')->get();
        
                        foreach ($routeByCompanies as $routeByCompany) {
                            $allStages = Stage::where('route_id', $routeByCompany->id)->get();
                            $totalTotalOffIn = 0;
                            $totalAdultIn = 0;
                            $totalConcessionIn = 0;
                            $totalTotalOffOut = 0;
                            $totalAdultOut = 0;
                            $totalConcessionOut = 0;
                            $perStage = [];
        
                            if (count($allStages) > 0) {
                                foreach ($allStages as $allStage) {
                                    $trip_data = [];
        
                                    //Inbound Trip
                                    $allInboundTrips = TripDetail::where('route_id', $routeByCompany->id)
                                        ->whereBetween('start_trip', [$dateFrom, $dateTo])
                                        ->where('trip_code', 1)
                                        ->get();
        
                                    $countIn = 0;
                                    $adultIn = 0;
                                    $concessionIn = 0;
                                    if (count($allInboundTrips) > 0) {
                                        foreach ($allInboundTrips as $allInboundTrip) {
                                            $ticketInTrips = TicketSalesTransaction::where('trip_id', $allInboundTrip->id)
                                                ->where('tostage_stage_id', $allStage->id)
                                                ->get();
        
                                            if (count($ticketInTrips) > 0) {
                                                foreach ($ticketInTrips as $ticketInTrip) {
                                                    $countIn++;
                                                    if ($ticketInTrip->passenger_type == 0) {
                                                        $adultIn++;
                                                    } elseif ($ticketInTrip->passenger_type == 1) {
                                                        $concessionIn++;
                                                    }
                                                }
                                            }
                                        }
                                    }
        
                                    //Outbound Trip
                                    $allOutboundTrips = TripDetail::where('route_id', $routeByCompany->id)
                                        ->whereBetween('start_trip', [$dateFrom, $dateTo])
                                        ->where('trip_code', 0)
                                        ->get();
        
                                    $countOut = 0;
                                    $adultOut = 0;
                                    $concessionOut = 0;
                                    if (count($allInboundTrips) > 0) {
                                        foreach ($allOutboundTrips as $allOutboundTrip) {
                                            $ticketOutTrips = TicketSalesTransaction::where('trip_id', $allOutboundTrip->id)
                                                ->where('tostage_stage_id', $allStage->id)
                                                ->get();
        
                                            if (count($ticketOutTrips) > 0) {
                                                foreach ($ticketOutTrips as $ticketOutTrip) {
                                                    $countOut++;
                                                    if ($ticketOutTrip->passenger_type == 0) {
                                                        $adultOut++;
                                                    } elseif ($ticketOutTrip->passenger_type == 1) {
                                                        $concessionOut++;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    $trip_data['total_off_in'] = $countIn;
                                    $trip_data['adult_in'] = $adultIn;
                                    $trip_data['concession_in'] = $concessionIn;
                                    $trip_data['total_off_out'] = $countOut;
                                    $trip_data['adult_out'] = $adultOut;
                                    $trip_data['concession_out'] = $concessionOut;
        
                                    $perStage[$allStage->stage_order . '. ' . $allStage->stage_name] = $trip_data;
        
                                    $totalTotalOffIn += $countIn;
                                    $totalAdultIn += $adultIn;
                                    $totalConcessionIn += $concessionIn;
                                    $totalTotalOffOut += $countOut;
                                    $totalAdultOut += $adultOut;
                                    $totalConcessionOut += $concessionOut;
                                }
                            }
        
                            if ($totalTotalOffIn == 0 && $totalAdultIn == 0 && $totalConcessionIn == 0 && $totalTotalOffOut == 0 && $totalAdultOut == 0 && $totalConcessionOut == 0) {
                                $perRoute[$routeByCompany->route_number] = [];
                            } else {
                                $total_in = [];
                                foreach ($perStage as $key => $row) {
                                    $total_in[$key] = $row['total_off_in'];
                                }
                                array_multisort($total_in, SORT_DESC, $perStage);
        
                                $total['total_off_in'] = $totalTotalOffIn;
                                $total['adult_in'] = $totalAdultIn;
                                $total['concession_in'] = $totalConcessionIn;
                                $total['total_off_out'] = $totalTotalOffOut;
                                $total['adult_out'] = $totalAdultOut;
                                $total['concession_out'] = $totalConcessionOut;
        
                                $perStage['total_per_route'] = $total;
                                $perRoute[$routeByCompany->route_number] = $perStage;
                            }
        
                            $grandTotalOffIn += $totalTotalOffIn;
                            $grandAdultIn += $totalAdultIn;
                            $grandConcessionIn += $totalConcessionIn;
                            $grandTotalOffOut += $totalTotalOffOut;
                            $grandAdultOut += $totalAdultOut;
                            $grandConcessionOut += $totalConcessionOut;
                        }
                        $grand['total_off_in'] = $grandTotalOffIn;
                        $grand['adult_in'] = $grandAdultIn;
                        $grand['concession_in'] = $grandConcessionIn;
                        $grand['total_off_out'] = $grandTotalOffOut;
                        $grand['adult_out'] = $grandAdultOut;
                        $grand['concession_out'] = $grandConcessionOut;
        
                        $data['allRoute'] = $perRoute;
                        $data['grand'] = $grand;
                        $topAlightingSPAD->add($data);
                    }
                    //Top Alighting specific route specific company
                    else{
                        $validatedRoute = Route::where('id', $validatedData['route_id'])->first();
                        $allStages = Stage::where('route_id', $validatedRoute->id)->get();
                        $totalTotalOffIn = 0;
                        $totalAdultIn = 0;
                        $totalConcessionIn = 0;
                        $totalTotalOffOut = 0;
                        $totalAdultOut = 0;
                        $totalConcessionOut = 0;
                        $perStage = [];
        
                        if (count($allStages) > 0) {
                            foreach ($allStages as $allStage) {
                                $trip_data = [];
        
                                //Inbound Trip
                                $allInboundTrips = TripDetail::where('route_id', $validatedRoute->id)
                                    ->whereBetween('start_trip', [$dateFrom, $dateTo])
                                    ->where('trip_code', 1)
                                    ->get();
        
                                $countIn = 0;
                                $adultIn = 0;
                                $concessionIn = 0;
                                if (count($allInboundTrips) > 0) {
                                    foreach ($allInboundTrips as $allInboundTrip) {
                                        $ticketInTrips = TicketSalesTransaction::where('trip_id', $allInboundTrip->id)
                                            ->where('tostage_stage_id',  $allStage->id)
                                            ->get();
        
                                        if (count($ticketInTrips) > 0) {
                                            foreach ($ticketInTrips as $ticketInTrip) {
                                                $countIn++;
                                                if ($ticketInTrip->passenger_type == 0) {
                                                    $adultIn++;
                                                } elseif ($ticketInTrip->passenger_type == 1) {
                                                    $concessionIn++;
                                                }
                                            }
                                        }
                                    }
                                }
        
                                //Outbound Trip
                                $allOutboundTrips = TripDetail::where('route_id', $validatedRoute->id)
                                    ->whereBetween('start_trip', [$dateFrom, $dateTo])
                                    ->where('trip_code', 0)
                                    ->get();
        
                                $countOut = 0;
                                $adultOut = 0;
                                $concessionOut = 0;
                                if (count($allInboundTrips) > 0) {
                                    foreach ($allOutboundTrips as $allOutboundTrip) {
                                        $ticketOutTrips = TicketSalesTransaction::where('trip_id', $allOutboundTrip->id)
                                            ->where('tostage_stage_id',  $allStage->id)
                                            ->get();
        
                                        if (count($ticketOutTrips) > 0) {
                                            foreach ($ticketOutTrips as $ticketOutTrip) {
                                                $countOut++;
                                                if ($ticketOutTrip->passenger_type == 0) {
                                                    $adultOut++;
                                                } elseif ($ticketOutTrip->passenger_type == 1) {
                                                    $concessionOut++;
                                                }
                                            }
                                        }
                                    }
                                }
                                $trip_data['total_off_in'] = $countIn;
                                $trip_data['adult_in'] = $adultIn;
                                $trip_data['concession_in'] = $concessionIn;
                                $trip_data['total_off_out'] = $countOut;
                                $trip_data['adult_out'] = $adultOut;
                                $trip_data['concession_out'] = $concessionOut;
        
                                $perStage[$allStage->stage_order . '. ' . $allStage->stage_name] = $trip_data;
        
                                $totalTotalOffIn += $countIn;
                                $totalAdultIn += $adultIn;
                                $totalConcessionIn += $concessionIn;
                                $totalTotalOffOut += $countOut;
                                $totalAdultOut += $adultOut;
                                $totalConcessionOut += $concessionOut;
                            }
                        }
        
                        if ($totalTotalOffIn == 0 && $totalAdultIn == 0 && $totalConcessionIn == 0 && $totalTotalOffOut == 0 && $totalAdultOut == 0 && $totalConcessionOut == 0) {
                            $perRoute[$validatedRoute->route_number] = [];
                        } else {
                            $total_in = [];
                            foreach ($perStage as $key => $row) {
                                $total_in[$key] = $row['total_off_in'];
                            }
                            array_multisort($total_in, SORT_DESC, $perStage);
        
                            $total['total_off_in'] = $totalTotalOffIn;
                            $total['adult_in'] = $totalAdultIn;
                            $total['concession_in'] = $totalConcessionIn;
                            $total['total_off_out'] = $totalTotalOffOut;
                            $total['adult_out'] = $totalAdultOut;
                            $total['concession_out'] = $totalConcessionOut;
        
                            $perStage['total_per_route'] = $total;
                            $perRoute[$validatedRoute->route_number] = $perStage;
                        }
        
                        $grandTotalOffIn = $totalTotalOffIn;
                        $grandAdultIn = $totalAdultIn;
                        $grandConcessionIn = $totalConcessionIn;
                        $grandTotalOffOut = $totalTotalOffOut;
                        $grandAdultOut = $totalAdultOut;
                        $grandConcessionOut = $totalConcessionOut;
        
                        $grand['total_off_in'] = $grandTotalOffIn;
                        $grand['adult_in'] = $grandAdultIn;
                        $grand['concession_in'] = $grandConcessionIn;
                        $grand['total_off_out'] = $grandTotalOffOut;
                        $grand['adult_out'] = $grandAdultOut;
                        $grand['concession_out'] = $grandConcessionOut;
        
                        $data['allRoute'] = $perRoute;
                        $data['grand'] = $grand;
                        $topAlightingSPAD->add($data);
                    }
                }
            }
            return Excel::download(new SPADTopAlighting($topAlightingSPAD, $validatedData['dateFrom'], $validatedData['dateTo'], $networkArea), 'Top_Alighting_Report_SPAD_'.Carbon::now()->format('YmdHis').'.xlsx');
        }else{
            $this->dispatchBrowserEvent('company-required');
        }
    }

    public function printBusTransfer()
    {
        $out = new ConsoleOutput();
        $out->writeln("YOU ARE IN printBusTransfer()");

        $validatedData = Validator::make($this->state,[
            'dateFrom' => ['required', 'date'],
            'dateTo' => ['required', 'date'],
            'route_id' => ['required'],
        ])->validate();

        $startDate = new Carbon($validatedData['dateFrom']);
        $endDate = new Carbon($validatedData['dateTo']);
        $all_dates = array();
        while ($startDate->lte($endDate)){
            $all_dates[] = $startDate->toDateString();
            $startDate->addDay();
        }

        $SPADBusTransfer = collect();
        if($this->selectedCompany){
            if($this->selectedCompany=='All'){
                $networkArea = 'All';
                if(!empty($validatedData['route_id'])) {
                    //BusTransfer all route all company
                    if($validatedData['route_id']=='All'){

                    }
                }
            }else{
                $companyDetails = Company::where('id', $this->selectedCompany)->first();
                $networkArea = $companyDetails->company_name;

                if(!empty($validatedData['route_id'])) {
                    //BusTransfer all route all company
                    if($validatedData['route_id']=='All'){

                    }else{

                    }
                }
            }
            return Excel::download(new SPADBusTransfer($SPADBusTransfer, $validatedData['dateFrom'], $validatedData['dateTo'], $networkArea), 'Bus_Transfer_Report_SPAD_'.Carbon::now()->format('YmdHis').'.xlsx');
        }else{
            $this->dispatchBrowserEvent('company-required');
        }
    }

    public function printTransferPoint()
    {
        //
    }

    public function printPenalty(){
        //
    }

    public function printSalesDetails()
    {
        $out = new ConsoleOutput();
        $out->writeln("YOU ARE IN  printSalesDetails()");

        $validatedData = Validator::make($this->state, [
            'dateFrom' => ['required', 'date'],
            'dateTo' => ['required', 'date'],
            'route_id' => ['required'],
        ])->validate();

        $dateFrom = new Carbon($validatedData['dateFrom']);
        $dateTo = new Carbon($validatedData['dateTo'] . '23:59:59');

        $startDate = new Carbon($validatedData['dateFrom']);
        $endDate = new Carbon($validatedData['dateTo']);
        $all_dates = array();

        while ($startDate->lte($endDate)) {
            $all_dates[] = $startDate->toDateString();
            $startDate->addDay();
        }

        $salesDetails = collect();
        $countTicket = 0;
        $sales = [];
        if ($this->selectedCompany){
            if($this->selectedCompany=='All'){
                $networkArea = 'All';
                if(!empty($validatedData['route_id'])) {
                    //printSalesDetails() all route for all company
                    if($validatedData['route_id']=='All'){
                        $allTickets = TicketSalesTransaction::whereBetween('sales_date', [$dateFrom , $dateTo])
                            ->orderBy('sales_date')
                            ->get();

                        if (count($allTickets) > 0) {
                            foreach ($allTickets as $allTicket) {
                                $countTicket++;
            
                                $salesTime = new Carbon($allTicket->sales_date);
                                $perTicket['sales_date'] = $salesTime->toDateString();
            
                                $perTicket['sales_time'] = $salesTime->toTimeString();
            
                                $perTicket['ticket_no'] = $allTicket->ticket_number;
            
                                if ($allTicket->fromstage_stage_id != NULL) {
                                    $perTicket['from'] = $allTicket->fromstage->stage_name;
                                } else {
                                    $perTicket['from'] = "NO DATA";
                                }
                                if ($allTicket->tostage_stage_id != NULL) {
                                    $perTicket['to'] = $allTicket->tostage->stage_name;
                                } else {
                                    $perTicket['to'] = "NO DATA";
                                }
            
                                if ($allTicket->pasenger_type == 0) {
                                    $passType = 'ADULT';
                                } elseif ($allTicket->pasenger_type == 1) {
                                    $passType = 'CONCESSION';
                                }
                                $perTicket['passenger_type'] = $passType;
            
                                $perTicket['price'] = $allTicket->actual_amount;
            
                                if($allTicket->TripDetail->bus_id!=NULL){
                                    $perTicket['bus_no'] = $allTicket->TripDetail->Bus->bus_registration_number;
                                }else{
                                    $perTicket['bus_no'] = "NO DATA";
                                }
            
                                if ($allTicket->TripDetail->trip_code == 1) {
                                    $IBOB = 'IB';
                                } elseif ($allTicket->TripDetail->trip_code == 0) {
                                    $IBOB = 'OB';
                                }
                                $perTicket['IBOB'] = $IBOB;
            
                                if($allTicket->TripDetail->route_id!=NULL){
                                    $perTicket['route_no'] = $allTicket->TripDetail->Route->route_number;
            
                                    $lastStage = Stage::where('route_id', $allTicket->TripDetail->route_id)
                                        ->orderBy('stage_order', 'DESC')
                                        ->first();
                                    if($lastStage){
                                        $perTicket['route_destination'] = $lastStage->stage_name;
                                    }else{
                                        $perTicket['route_destination'] =  "NO DATA";
                                    }
                                    
                                    $perTicket['route_name'] = $allTicket->TripDetail->Route->route_name;
                                }else{
                                    $perTicket['route_no'] =  "NO DATA";
                                    $perTicket['route_destination'] =  "NO DATA";
                                    $perTicket['route_name'] =  "NO DATA";
                                }
                            
                                $tripTime = new Carbon($allTicket->TripDetail->start_trip);
                                $perTicket['trip_time'] = $tripTime->toTimeString();
            
                                $perTicket['trip_no'] = 'T'. $allTicket->trip_id;
            
                                if ($allTicket->TripDetail->driver_id != NULL) {
                                    $perTicket['driver_id'] = $allTicket->TripDetail->BusDriver->driver_number;
                                    $perTicket['driver_name'] = $allTicket->TripDetail->BusDriver->driver_name;
                                }
                                else{
                                    $perTicket['driver_id'] = "NO DATA";
                                    $perTicket['driver_name'] = "NO DATA";
                                }
            
                                if($allTicket->fare_type == 1) {
                                    $payment = 'CARD';
                                }elseif($allTicket->fare_type == 2){
                                    $payment = 'TOUCH N GO';
                                }else{
                                    $payment = 'CASH';
                                }
                                $perTicket['payment'] = $payment;
            
                                $sales[$countTicket] = $perTicket;
                            }
                        }
                        $salesDetails->add($sales);
                    }
                }
            }else{
                $companyDetails = Company::where('id', $this->selectedCompany)->first();
                $networkArea = $companyDetails->company_name;
                if(!empty($validatedData['route_id'])) {
                    //printSalesDetails() all route for specific company
                    if($validatedData['route_id']=='All'){
                        $routeByCompanies = Route::where('company_id', $companyDetails->id)->orderBy('route_number')->get();
        
                        foreach($routeByCompanies as $routeByCompany){
                            $allTrips = TripDetail::whereBetween('start_trip', [$dateFrom , $dateTo])
                                ->where('route_id',$routeByCompany->id)
                                ->get();
        
                            if(count($allTrips) > 0) {
                                foreach ($allTrips as $allTrip) {
                                    $allTickets = TicketSalesTransaction::where('trip_id', $allTrip->id)
                                        ->orderBy('sales_date')
                                        ->get();
        
                                    if (count($allTickets) > 0) {
                                        foreach ($allTickets as $allTicket) {
                                            $countTicket++;
        
                                            $salesTime = new Carbon($allTicket->sales_date);
                                            $perTicket['sales_date'] = $salesTime->toDateString();
        
                                            $perTicket['sales_time'] = $salesTime->toTimeString();
        
                                            $perTicket['ticket_no'] = $allTicket->ticket_number;
        
                                            if($allTicket->fromstage_stage_id != NULL) {
                                                $perTicket['from'] = $allTicket->fromstage->stage_name;
                                            }
                                            else{
                                                $perTicket['from'] = "NO DATA";
                                            }
                                            if($allTicket->tostage_stage_id != NULL) {
                                                $perTicket['to'] = $allTicket->tostage->stage_name;
                                            }else{
                                                $perTicket['to'] = "NO DATA";
                                            }
        
                                            if ($allTicket->pasenger_type == 0) {
                                                $passType = 'ADULT';
                                            } elseif ($allTicket->pasenger_type == 1) {
                                                $passType = 'CONCESSION';
                                            }
                                            $perTicket['passenger_type'] = $passType;
        
                                            $perTicket['price'] = $allTicket->actual_amount;
        
                                            if($allTrip->bus_id != NULL) {
                                                $perTicket['bus_no'] = $allTrip->Bus->bus_registration_number;
                                            }else{
                                                $perTicket['bus_no'] = "NO DATA";
                                            }
        
                                            if ($allTrip->trip_code == 1) {
                                                $IBOB = 'IB';
                                            } elseif ($allTrip->trip_code == 0) {
                                                $IBOB = 'OB';
                                            }
                                            $perTicket['IBOB'] = $IBOB;
        
                                            $perTicket['route_no'] = $routeByCompany->route_number;
        
                                            $lastStage = Stage::where('route_id', $allTrip->route_id)
                                                ->orderBy('stage_order', 'DESC')
                                                ->first();
                                            if($lastStage){
                                                $perTicket['route_destination'] = $lastStage->stage_name;
                                            }else{
                                                $perTicket['route_destination'] = "NO DATA";
                                            }
        
                                            $perTicket['route_name'] = $routeByCompany->route_name;
        
                                            $tripTime = new Carbon($allTrip->start_trip);
                                            $perTicket['trip_time'] = $tripTime->toTimeString();
        
                                            $perTicket['trip_no'] = 'T'. $allTrip->id;
        
                                            if ($allTrip->driver_id != NULL) {
                                                $perTicket['driver_id'] = $allTrip->BusDriver->driver_number;
                                                $perTicket['driver_name'] = $allTrip->BusDriver->driver_name;
                                            }
                                            else{
                                                $perTicket['driver_id'] = "NO DATA";
                                                $perTicket['driver_name'] = "NO DATA";
                                            }
        
                                            if ($allTicket->fare_type == 1) {
                                                $payment = 'CARD';
                                            } elseif ($allTicket->fare_type == 2) {
                                                $payment = 'TOUCH N GO';
                                            }else{
                                                $payment = 'CASH';
                                            }
                                            $perTicket['payment'] = $payment;
        
                                            $sales[$countTicket] = $perTicket;
                                        }
                                    }
                                }
                            }
                        }
                        $salesDetails->add($sales);
                    }
                    //printSalesDetails() certain route for specific company
                    else{
                        $selectedRoute = Route::where('id', $validatedData['route_id'])->first();
        
                        $allTrips = TripDetail::whereBetween('start_trip', [$dateFrom , $dateTo])
                            ->where('route_id',$selectedRoute->id)
                            ->get();
        
                        if(count($allTrips) > 0) {
                            foreach ($allTrips as $allTrip) {
                                $allTickets = TicketSalesTransaction::where('trip_id', $allTrip->id)
                                    ->orderBy('sales_date')
                                    ->get();
        
                                if (count($allTickets) > 0) {
                                    foreach ($allTickets as $allTicket) {
                                        $countTicket++;
        
                                        $salesTime = new Carbon($allTicket->sales_date);
                                        $perTicket['sales_date'] = $salesTime->toDateString();
        
                                        $perTicket['sales_time'] = $salesTime->toTimeString();
        
                                        $perTicket['ticket_no'] = $allTicket->ticket_number;
        
                                        if($allTicket->fromstage_stage_id != NULL) {
                                            $perTicket['from'] = $allTicket->fromstage->stage_name;
                                        }
                                        else{
                                            $perTicket['from'] = "NO DATA";
                                        }
                                        if($allTicket->tostage_stage_id != NULL) {
                                            $perTicket['to'] = $allTicket->tostage->stage_name;
                                        }else{
                                            $perTicket['to'] = "NO DATA";
                                        }
        
                                        if ($allTicket->pasenger_type == 0) {
                                            $passType = 'ADULT';
                                        } elseif ($allTicket->pasenger_type == 1) {
                                            $passType = 'CONCESSION';
                                        }
                                        $perTicket['passenger_type'] = $passType;
        
                                        $perTicket['price'] = $allTicket->actual_amount;
        
                                        if($allTrip->bus_id != NULL) {
                                            $perTicket['bus_no'] = $allTrip->Bus->bus_registration_number;
                                        }else{
                                            $perTicket['bus_no'] = "NO DATA";
                                        }
        
                                        if ($allTrip->trip_code == 1) {
                                            $IBOB = 'IB';
                                        } elseif ($allTrip->trip_code == 0) {
                                            $IBOB = 'OB';
                                        }
                                        $perTicket['IBOB'] = $IBOB;
        
                                        $perTicket['route_no'] = $selectedRoute->route_number;
        
                                        $lastStage = Stage::where('route_id', $allTrip->route_id)
                                            ->orderBy('stage_order', 'DESC')
                                            ->first();
                                        if($lastStage){
                                            $perTicket['route_destination'] = $lastStage->stage_name;
                                        }else{
                                            $perTicket['route_destination'] = "NO DATA";
                                        }
        
                                        $perTicket['route_name'] = $selectedRoute->route_name;
        
                                        $tripTime = new Carbon($allTrip->start_trip);
                                        $perTicket['trip_time'] = $tripTime->toTimeString();
        
                                        $perTicket['trip_no'] ='T'.$allTrip->id;
        
                                        if ($allTrip->driver_id != NULL) {
                                            $perTicket['driver_id'] = $allTrip->BusDriver->driver_number;
                                            $perTicket['driver_name'] = $allTrip->BusDriver->driver_name;
                                        }
                                        else{
                                            $perTicket['driver_id'] = "NO DATA";
                                            $perTicket['driver_name'] = "NO DATA";
                                        }
        
                                        if ($allTicket->fare_type == 1) {
                                            $payment = 'CARD';
                                        } elseif ($allTicket->fare_type == 2) {
                                            $payment = 'TOUCH N GO';
                                        }else{
                                            $payment = 'CASH';
                                        }
                                        $perTicket['payment'] = $payment;
        
                                        $sales[$countTicket] = $perTicket;
                                    }
                                }
                            }
                        }
                        $salesDetails->add($sales);
                    }
                }
            }
            return Excel::download(new SPADSalesDetails($salesDetails, $validatedData['dateFrom'], $validatedData['dateTo'], $networkArea), 'Sales_Details_Report_SPAD_'.Carbon::now()->format('YmdHis').'.xlsx');
        }else{
            $this->dispatchBrowserEvent('company-required');
        }
    }

    public function printClaimDetailsFast(){
        $out = new ConsoleOutput();
        $out->writeln("YOU ARE IN printClaimDetails()");

        $validatedData = Validator::make($this->state,[
            'dateFrom' => ['required', 'date'],
            'dateTo' => ['required', 'date'],
            'route_id' => ['required'],
        ])->validate();

        $dateFrom = new Carbon($validatedData['dateFrom']);
        $dateTo = new Carbon($validatedData['dateTo'] . '23:59:59');
        $startDate = new Carbon($validatedData['dateFrom']);
        $endDate = new Carbon($validatedData['dateTo']);
        $all_dates = array();

        while ($startDate->lte($endDate)){
            $all_dates[] = $startDate->toDateString();
            $startDate->addDay();
        }

        if ($this->selectedCompany){
            if($this->selectedCompany=='All'){
                $networkArea = 'All';
                //ClaimDetails all routes for all company
                if($validatedData['route_id']=='All'){
                   
                    //All Trip IB/OB
                    $allTrips = DB::select("SELECT trip_details.id, trip_details.trip_code, cast(trip_details.start_trip as DATE) as service_date, route.company_id,
                    route.route_number, route.route_name, trip_details.trip_number, stage.stage_name, bus.bus_registration_number, bus.bus_age, bus_driver.driver_number, COUNT(stage.id) as bus_stop_travel, 
                    (case when (trip_details.trip_code = 1) THEN route.inbound_distance ELSE route.outbound_distance END) as distance, 
                    (case when (route.company_id = 29) THEN 3.42 * distance ELSE 1.33 * distance END) as travel_claim,
                    trip_details.total_mileage, (case when (route.company_id = 29) THEN 3.42 * trip_details.total_mileage 
                    ELSE 1.33 * trip_details.total_mileage END) as travel_gps_claim, route_scheduler_mstr.schedule_start_time as service_start, 
                    cast(trip_details.start_trip as TIME) as actual_start, route_scheduler_mstr.schedule_end_time as service_end, 
                    cast(trip_details.end_trip as TIME) as actual_end, total_adult_amount + total_concession_amount AS farebox, 
                    total_adult + total_concession AS ridership, total_adult, total_concession
                    FROM mybas.trip_details
                    JOIN mybas.route ON route.id = trip_details.route_id
                    JOIN mybas.stage ON stage.route_id = route.id 
                    JOIN mybas.bus ON bus.id = trip_details.bus_id 
                    JOIN mybas.bus_driver ON bus_driver.id = trip_details.driver_id
                    JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.id = trip_details.route_schedule_mstr_id
                    WHERE start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                    AND route.status = 1
                    GROUP BY trip_details.id
                    ORDER BY route.route_number, service_date, trip_details.trip_code, trip_details.id;");

                    $lastKey = array_key_last($allTrips);
                    $totalBusStop = 0;
                    $pastRouteNo = "";
                    $pastCode = "";
                    $pastDate = "";
                    $count = 0;
                    $totalPerTripCode = [];
                    $totalPerDate = [];
                    //dd($allTrips);
                    foreach($allTrips as $key => $allTrip){
                        $out->writeln("New loop: " . $allTrip->id);
                        $out->writeln("Past date: " . $pastDate . " | Past Trip Code: " . $pastCode . " | Past Route No: " . $pastRouteNo);

                        //Enter total per date per trip_code
                        if($allTrip->service_date != $pastDate || $allTrip->trip_code != $pastCode || $allTrip->route_number != $pastRouteNo
                        && $pastDate != NULL && $pastCode != NULL && $pastRouteNo != NULL){
                            $out->writeln("Inside Splice Total Trip Code Loop: " . $key . " - " . $allTrip->route_number . " - " . $allTrip->service_date . " - " . $allTrip->trip_code);
                            $out->writeln("up count: " . $count);

                            if($count==0){
                                array_splice($allTrips, $key, 0, $totalPerTripCode);
                            }else{
                                $newKey = $key + $count - 1;
                                $out->writeln("newKey: " . $newKey);
                                array_splice($allTrips, $newKey, 0, $totalPerTripCode);
                            }
                            $count++;
                            $out->writeln("low count: " . $count);
                        }

                        //Enter total per date
                        if(($allTrip->route_number == $pastRouteNo || $allTrip->route_number != $pastRouteNo) &&
                        $allTrip->service_date != $pastDate && $pastDate != NULL){
                            //dd($totalPerDate);
                            $out->writeln("Inside Splice Total Date Loop: " . $key . " - " . $allTrip->route_number . " - " . $allTrip->service_date . " - " . $allTrip->trip_code);
                            $out->writeln("up count: " . $count);

                            if($count==0){
                                array_splice($allTrips, $key, 0, $totalPerTripCode);
                            }else{
                                $newKey = $key + $count - 1;
                                $out->writeln("newKey: " . $newKey);
                                array_splice($allTrips, $newKey, 0, $totalPerDate);
                            }
                            $count++;
                            $out->writeln("low count: " . $count);
                        }

                        //Add punctuality
                        $diff = strtotime($allTrip->service_start) - strtotime($allTrip->actual_start);
                        if ($diff > 5 || $diff < -5) {
                            $allTrip->punctuality = "NOT PUNCTUAL";
                        } else {
                            $allTrip->punctuality = "ONTIME";
                        }

                        //Add IB/OB
                        if($allTrip->trip_code == 0){
                            $allTrip->trip_code_name = "OB";
                        }else{
                            $allTrip->trip_code_name = "IB";
                        }

                        //Add claim
                        if($allTrip->company_id == 29){
                            $allTrip->claim = 3.42;
                        }else{
                            $allTrip->claim = 1.33;
                        }

                        $salesTimeSQL = DB::select("SELECT cast(MIN(ticket_sales_transaction.sales_date) as TIME) as sales_start, 
                        CAST(MAX(ticket_sales_transaction.sales_date) AS TIME) as sales_end
                        FROM mybas.ticket_sales_transaction
                        JOIN mybas.trip_details ON trip_details.trip_number = ticket_sales_transaction.trip_number
                        WHERE trip_details.trip_number = '" . $allTrip->trip_number . "';");

                        foreach($salesTimeSQL as $key2 => $salesTime){
                            $out->writeln("Inside sales loop" );
                            if($salesTime->sales_start==NULL){
                                $out->writeln("No Sales");
                                $allTrip->sales_start = "No Sales";
                                $allTrip->sales_end = "No Sales";
                            }else{
                                $out->writeln("With Sales");
                                $allTrip->sales_start = $salesTime->sales_start;
                                $allTrip->sales_end = $salesTime->sales_start;
                            }
                        }
                        $out->writeln("Out sales loop");

                        //TOTAL PER TRIP CODE 
                        $startDate = new Carbon($allTrip->service_date);
                        $endDate = new Carbon($allTrip->service_date . '23:59:59');

                        $totalPerTripCode = DB::select("SELECT trip_details.trip_code, route.route_number, 
                        route.route_name, cast(trip_details.start_trip as DATE) as service_date,
                        SUM(route.inbound_distance) as distance, 
                        SUM(trip_details.total_mileage) as travel_gps, 
                        (case when (route.company_id = 29) THEN 3.42 * SUM(route.inbound_distance) 
                        ELSE 1.33 * SUM(route.inbound_distance) END) as travel_claim, trip_details.total_mileage, 
                        (case when (route.company_id = 29) THEN 3.42 * SUM(trip_details.total_mileage)
                        ELSE 1.33 * SUM(trip_details.total_mileage) END) as travel_gps_claim, 
                        SUM(total_adult) as total_adult, SUM(total_concession) as total_concession, 
                        SUM(total_adult) + SUM(total_concession) as ridership, 
                        SUM(total_adult_amount) + SUM(total_concession_amount) as farebox
                        FROM mybas.trip_details
                        JOIN mybas.route ON route.id = trip_details.route_id
                        WHERE trip_details.start_trip BETWEEN '" . $startDate . "' AND '" . $endDate . "'
                        AND trip_details.trip_code = " . $allTrip->trip_code . "
                        AND route.route_number = '" . $allTrip->route_number . "';");

                        foreach($totalPerTripCode as $key3 => $perTripCode){
                            $out->writeln("Inside total per trip code loop" );

                            $totalBusStop = DB::select("SELECT COUNT(stage.id) as bus_stop_travel
                            FROM mybas.trip_details
                            JOIN mybas.route ON route.id = trip_details.route_id
                            JOIN mybas.stage ON stage.route_id = route.id
                            WHERE trip_details.start_trip BETWEEN '" . $startDate . "' AND '" . $endDate . "'
                            AND trip_details.trip_code = " . $allTrip->trip_code . "
                            AND route.route_number = '" . $allTrip->route_number . "';");

                            foreach($totalBusStop as $key4 => $busStop){
                                $out->writeln("Inside total bus stop per trip code loop" );
                                $perTripCode->bus_stop_travel = $busStop->bus_stop_travel;
                            }
                        }

                        //TOTAL PER TRIP DATE
                        $totalPerDate = DB::select("SELECT cast(trip_details.start_trip as DATE) as service_date,
                        route.route_number, SUM(route.inbound_distance) as distance, SUM(trip_details.total_mileage) as travel_gps, 
                        (case when (route.company_id = 29) THEN 3.42 * SUM(route.inbound_distance) 
                        ELSE 1.33 * SUM(route.inbound_distance) END) as travel_claim, 
                        (case when (route.company_id = 29) THEN 3.42 * SUM(trip_details.total_mileage)
                        ELSE 1.33 * SUM(trip_details.total_mileage) END) as travel_gps_claim, 
                        SUM(total_adult) as total_adult, SUM(total_concession) as total_concession, 
                        SUM(total_adult) + SUM(total_concession) as ridership, 
                        SUM(total_adult_amount) + SUM(total_concession_amount) as farebox
                        FROM mybas.trip_details
                        JOIN mybas.route ON route.id = trip_details.route_id
                        WHERE trip_details.start_trip BETWEEN '" . $startDate . "' AND '" . $endDate . "'
                        AND route.route_number = '" . $allTrip->route_number . "';");

                        foreach($totalPerDate as $key5 => $perDate){
                            $out->writeln("Inside total per date loop" );

                            $totalBusStopPerDate = DB::select("SELECT COUNT(stage.id) as bus_stop_travel
                            FROM mybas.trip_details
                            JOIN mybas.route ON route.id = trip_details.route_id
                            JOIN mybas.stage ON stage.route_id = route.id
                            WHERE trip_details.start_trip BETWEEN '" . $startDate . "' AND '" . $endDate . "'
                            AND route.route_number = '" . $allTrip->route_number . "';");

                            foreach($totalBusStopPerDate as $key6 => $busStopPerDate){
                                $out->writeln("Inside total bus stop per date loop" );
                                $perDate->bus_stop_travel = $busStopPerDate->bus_stop_travel;
                            }
                        }
                        $pastRouteNo = $allTrip->route_number;
                        $pastDate = $allTrip->service_date;
                        $pastCode = $allTrip->trip_code;

                        if($lastKey==$key){
                            //Grand Total
                            $grandTotal = DB::select("SELECT SUM(route.inbound_distance) as distance, 
                            SUM(trip_details.total_mileage) as travel_gps, 
                            (case when (route.company_id = 29) THEN 3.42 * SUM(route.inbound_distance) 
                            ELSE 1.33 * SUM(route.inbound_distance) END) as travel_claim, trip_details.total_mileage, 
                            (case when (route.company_id = 29) THEN 3.42 * SUM(trip_details.total_mileage)
                            ELSE 1.33 * SUM(trip_details.total_mileage) END) as travel_gps_claim, 
                            SUM(total_adult) as total_adult, SUM(total_concession) as total_concession, 
                            SUM(total_adult) + SUM(total_concession) as ridership, 
                            SUM(total_adult_amount) + SUM(total_concession_amount) as farebox
                            FROM mybas.trip_details
                            JOIN mybas.route ON route.id = trip_details.route_id
                            WHERE trip_details.start_trip BETWEEN '" . $dateFrom. "' AND '" . $dateTo . "'");

                            foreach($grandTotal as $key7 => $grand){
                                $out->writeln("Inside grand total loop" );

                                $grandTotalBus = DB::select("SELECT COUNT(stage.id) as bus_stop_travel
                                FROM mybas.trip_details
                                JOIN mybas.route ON route.id = trip_details.route_id
                                JOIN mybas.stage ON stage.route_id = route.id
                                WHERE trip_details.start_trip BETWEEN '" . $dateFrom. "' AND '" . $dateTo . "'");

                                foreach($grandTotalBus as $key8 => $grandBus){
                                    $out->writeln("Inside total bus stop grand loop" );
                                    $grand->bus_stop_travel = $grandBus->bus_stop_travel;
                                }
                            }

                            $newKey = $key + $count;
                            $out->writeln("last newKey: " . $newKey);
                            array_splice($allTrips, $newKey, 0, $grandTotal);
                            array_splice($allTrips, $newKey, 0, $totalPerDate);
                            array_splice($allTrips, $newKey, 0,  $totalPerTripCode);
                        }
                    }
                    $out->writeln("Out loop");
                }
            }
            else{
                $companyDetails = Company::where('id', $this->selectedCompany)->first();
                $networkArea = $companyDetails->company_name;

                //ClaimDetails all routes for specific company
                if($validatedData['route_id']=='All'){
                    //All Trip IB/OB
                    $allTrips = DB::select("SELECT trip_details.id, trip_details.trip_code, cast(trip_details.start_trip as DATE) as service_date, route.company_id,
                    route.route_number, route.route_name, trip_details.trip_number, stage.stage_name, bus.bus_registration_number, bus.bus_age, bus_driver.driver_number, COUNT(stage.id) as bus_stop_travel, 
                    (case when (trip_details.trip_code = 1) THEN route.inbound_distance ELSE route.outbound_distance END) as distance, 
                    (case when (route.company_id = 29) THEN 3.42 * distance ELSE 1.33 * distance END) as travel_claim,
                    trip_details.total_mileage, (case when (route.company_id = 29) THEN 3.42 * trip_details.total_mileage 
                    ELSE 1.33 * trip_details.total_mileage END) as travel_gps_claim, route_scheduler_mstr.schedule_start_time as service_start, 
                    cast(trip_details.start_trip as TIME) as actual_start, route_scheduler_mstr.schedule_end_time as service_end, 
                    cast(trip_details.end_trip as TIME) as actual_end, total_adult_amount + total_concession_amount AS farebox, 
                    total_adult + total_concession AS ridership, total_adult, total_concession
                    FROM mybas.trip_details
                    JOIN mybas.route ON route.id = trip_details.route_id
                    JOIN mybas.stage ON stage.route_id = route.id 
                    JOIN mybas.bus ON bus.id = trip_details.bus_id 
                    JOIN mybas.bus_driver ON bus_driver.id = trip_details.driver_id
                    JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.id = trip_details.route_schedule_mstr_id
                    WHERE start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                    AND route.status = 1
                    AND route.company_id = " . $companyDetails->id. "
                    GROUP BY trip_details.id
                    ORDER BY route.route_number, service_date, trip_details.trip_code, trip_details.id;");

                    $lastKey = array_key_last($allTrips);
                    $totalBusStop = 0;
                    $pastRouteNo = "";
                    $pastCode = "";
                    $pastDate = "";
                    $count = 0;
                    $totalPerTripCode = [];
                    $totalPerDate = [];
                    foreach($allTrips as $key => $allTrip){
                        $out->writeln("New loop: " . $allTrip->id);
                        $out->writeln("Past date: " . $pastDate . " | Past Trip Code: " . $pastCode . " | Past Route No: " . $pastRouteNo);

                        //Enter total per date per trip_code
                        if($allTrip->service_date != $pastDate || $allTrip->trip_code != $pastCode || $allTrip->route_number != $pastRouteNo
                        && $pastDate != NULL && $pastCode != NULL && $pastRouteNo != NULL){
                            $out->writeln("Inside Splice Total Trip Code Loop: " . $key . " - " . $allTrip->route_number . " - " . $allTrip->service_date . " - " . $allTrip->trip_code);
                            $out->writeln("up count: " . $count);

                            if($count==0){
                                array_splice($allTrips, $key, 0, $totalPerTripCode);
                            }else{
                                $newKey = $key + $count - 1;
                                $out->writeln("newKey: " . $newKey);
                                array_splice($allTrips, $newKey, 0, $totalPerTripCode);
                            }
                            $count++;
                            $out->writeln("low count: " . $count);
                        }

                        //Enter total per date
                        if(($allTrip->route_number == $pastRouteNo || $allTrip->route_number != $pastRouteNo) &&
                        $allTrip->service_date != $pastDate && $pastDate != NULL){
                            //dd($totalPerDate);
                            $out->writeln("Inside Splice Total Date Loop: " . $key . " - " . $allTrip->route_number . " - " . $allTrip->service_date . " - " . $allTrip->trip_code);
                            $out->writeln("up count: " . $count);

                            if($count==0){
                                array_splice($allTrips, $key, 0, $totalPerTripCode);
                            }else{
                                $newKey = $key + $count - 1;
                                $out->writeln("newKey: " . $newKey);
                                array_splice($allTrips, $newKey, 0, $totalPerDate);
                            }
                            $count++;
                            $out->writeln("low count: " . $count);
                        }

                        //Add punctuality
                        $diff = strtotime($allTrip->service_start) - strtotime($allTrip->actual_start);
                        if ($diff > 5 || $diff < -5) {
                            $allTrip->punctuality = "NOT PUNCTUAL";
                        } else {
                            $allTrip->punctuality = "ONTIME";
                        }

                        //Add IB/OB
                        if($allTrip->trip_code == 0){
                            $allTrip->trip_code_name = "OB";
                        }else{
                            $allTrip->trip_code_name = "IB";
                        }

                        //Add claim
                        if($allTrip->company_id == 29){
                            $allTrip->claim = 3.42;
                        }else{
                            $allTrip->claim = 1.33;
                        }

                        $salesTimeSQL = DB::select("SELECT cast(MIN(ticket_sales_transaction.sales_date) as TIME) as sales_start, 
                        CAST(MAX(ticket_sales_transaction.sales_date) AS TIME) as sales_end
                        FROM mybas.ticket_sales_transaction
                        JOIN mybas.trip_details ON trip_details.trip_number = ticket_sales_transaction.trip_number
                        WHERE trip_details.trip_number = '" . $allTrip->trip_number . "';");

                        foreach($salesTimeSQL as $key2 => $salesTime){
                            $out->writeln("Inside sales loop" );
                            if($salesTime->sales_start==NULL){
                                $out->writeln("No Sales");
                                $allTrip->sales_start = "No Sales";
                                $allTrip->sales_end = "No Sales";
                            }else{
                                $out->writeln("With Sales");
                                $allTrip->sales_start = $salesTime->sales_start;
                                $allTrip->sales_end = $salesTime->sales_start;
                            }
                        }
                        $out->writeln("Out sales loop");

                        //TOTAL PER TRIP CODE 
                        $startDate = new Carbon($allTrip->service_date);
                        $endDate = new Carbon($allTrip->service_date . '23:59:59');

                        $totalPerTripCode = DB::select("SELECT trip_details.trip_code, route.route_number, 
                        route.route_name, cast(trip_details.start_trip as DATE) as service_date,
                        SUM(route.inbound_distance) as distance, 
                        SUM(trip_details.total_mileage) as travel_gps, 
                        (case when (route.company_id = 29) THEN 3.42 * SUM(route.inbound_distance) 
                        ELSE 1.33 * SUM(route.inbound_distance) END) as travel_claim, trip_details.total_mileage, 
                        (case when (route.company_id = 29) THEN 3.42 * SUM(trip_details.total_mileage)
                        ELSE 1.33 * SUM(trip_details.total_mileage) END) as travel_gps_claim, 
                        SUM(total_adult) as total_adult, SUM(total_concession) as total_concession, 
                        SUM(total_adult) + SUM(total_concession) as ridership, 
                        SUM(total_adult_amount) + SUM(total_concession_amount) as farebox
                        FROM mybas.trip_details
                        JOIN mybas.route ON route.id = trip_details.route_id
                        WHERE trip_details.start_trip BETWEEN '" . $startDate . "' AND '" . $endDate . "'
                        AND trip_details.trip_code = " . $allTrip->trip_code . "
                        AND route.route_number = '" . $allTrip->route_number . "';");

                        foreach($totalPerTripCode as $key3 => $perTripCode){
                            $out->writeln("Inside total per trip code loop" );

                            $totalBusStop = DB::select("SELECT COUNT(stage.id) as bus_stop_travel
                            FROM mybas.trip_details
                            JOIN mybas.route ON route.id = trip_details.route_id
                            JOIN mybas.stage ON stage.route_id = route.id
                            WHERE trip_details.start_trip BETWEEN '" . $startDate . "' AND '" . $endDate . "'
                            AND trip_details.trip_code = " . $allTrip->trip_code . "
                            AND route.route_number = '" . $allTrip->route_number . "';");

                            foreach($totalBusStop as $key4 => $busStop){
                                $out->writeln("Inside total bus stop per trip code loop" );
                                $perTripCode->bus_stop_travel = $busStop->bus_stop_travel;
                            }
                        }

                        //TOTAL PER TRIP DATE
                        $totalPerDate = DB::select("SELECT cast(trip_details.start_trip as DATE) as service_date,
                        route.route_number, SUM(route.inbound_distance) as distance, SUM(trip_details.total_mileage) as travel_gps, 
                        (case when (route.company_id = 29) THEN 3.42 * SUM(route.inbound_distance) 
                        ELSE 1.33 * SUM(route.inbound_distance) END) as travel_claim, 
                        (case when (route.company_id = 29) THEN 3.42 * SUM(trip_details.total_mileage)
                        ELSE 1.33 * SUM(trip_details.total_mileage) END) as travel_gps_claim, 
                        SUM(total_adult) as total_adult, SUM(total_concession) as total_concession, 
                        SUM(total_adult) + SUM(total_concession) as ridership, 
                        SUM(total_adult_amount) + SUM(total_concession_amount) as farebox
                        FROM mybas.trip_details
                        JOIN mybas.route ON route.id = trip_details.route_id
                        WHERE trip_details.start_trip BETWEEN '" . $startDate . "' AND '" . $endDate . "'
                        AND route.route_number = '" . $allTrip->route_number . "';");

                        foreach($totalPerDate as $key5 => $perDate){
                            $out->writeln("Inside total per date loop" );

                            $totalBusStopPerDate = DB::select("SELECT COUNT(stage.id) as bus_stop_travel
                            FROM mybas.trip_details
                            JOIN mybas.route ON route.id = trip_details.route_id
                            JOIN mybas.stage ON stage.route_id = route.id
                            WHERE trip_details.start_trip BETWEEN '" . $startDate . "' AND '" . $endDate . "'
                            AND route.route_number = '" . $allTrip->route_number . "';");

                            foreach($totalBusStopPerDate as $key6 => $busStopPerDate){
                                $out->writeln("Inside total bus stop per date loop" );
                                $perDate->bus_stop_travel = $busStopPerDate->bus_stop_travel;
                            }
                        }
                        $pastRouteNo = $allTrip->route_number;
                        $pastDate = $allTrip->service_date;
                        $pastCode = $allTrip->trip_code;

                        if($lastKey==$key){
                            //Grand Total
                            $grandTotal = DB::select("SELECT SUM(route.inbound_distance) as distance, 
                            SUM(trip_details.total_mileage) as travel_gps, 
                            (case when (route.company_id = 29) THEN 3.42 * SUM(route.inbound_distance) 
                            ELSE 1.33 * SUM(route.inbound_distance) END) as travel_claim, trip_details.total_mileage, 
                            (case when (route.company_id = 29) THEN 3.42 * SUM(trip_details.total_mileage)
                            ELSE 1.33 * SUM(trip_details.total_mileage) END) as travel_gps_claim, 
                            SUM(total_adult) as total_adult, SUM(total_concession) as total_concession, 
                            SUM(total_adult) + SUM(total_concession) as ridership, 
                            SUM(total_adult_amount) + SUM(total_concession_amount) as farebox
                            FROM mybas.trip_details
                            JOIN mybas.route ON route.id = trip_details.route_id
                            WHERE trip_details.start_trip BETWEEN '" . $dateFrom. "' AND '" . $dateTo . "'");

                            foreach($grandTotal as $key7 => $grand){
                                $out->writeln("Inside grand total loop" );

                                $grandTotalBus = DB::select("SELECT COUNT(stage.id) as bus_stop_travel
                                FROM mybas.trip_details
                                JOIN mybas.route ON route.id = trip_details.route_id
                                JOIN mybas.stage ON stage.route_id = route.id
                                WHERE trip_details.start_trip BETWEEN '" . $dateFrom. "' AND '" . $dateTo . "'");

                                foreach($grandTotalBus as $key8 => $grandBus){
                                    $out->writeln("Inside total bus stop grand loop" );
                                    $grand->bus_stop_travel = $grandBus->bus_stop_travel;
                                }
                            }

                            $newKey = $key + $count;
                            $out->writeln("last newKey: " . $newKey);
                            array_splice($allTrips, $newKey, 0, $grandTotal);
                            array_splice($allTrips, $newKey, 0, $totalPerDate);
                            array_splice($allTrips, $newKey, 0,  $totalPerTripCode);
                        }
                    }
                    $out->writeln("Out loop");
                }
                //ClaimDetails specific routes for specific company
                else{
                    //All Trip IB/OB
                    $allTrips = DB::select("SELECT trip_details.id, trip_details.trip_code, cast(trip_details.start_trip as DATE) as service_date, route.company_id,
                    route.route_number, route.route_name, trip_details.trip_number, stage.stage_name, bus.bus_registration_number, bus.bus_age, bus_driver.driver_number, COUNT(stage.id) as bus_stop_travel, 
                    (case when (trip_details.trip_code = 1) THEN route.inbound_distance ELSE route.outbound_distance END) as distance, 
                    (case when (route.company_id = 29) THEN 3.42 * distance ELSE 1.33 * distance END) as travel_claim,
                    trip_details.total_mileage, (case when (route.company_id = 29) THEN 3.42 * trip_details.total_mileage 
                    ELSE 1.33 * trip_details.total_mileage END) as travel_gps_claim, route_scheduler_mstr.schedule_start_time as service_start, 
                    cast(trip_details.start_trip as TIME) as actual_start, route_scheduler_mstr.schedule_end_time as service_end, 
                    cast(trip_details.end_trip as TIME) as actual_end, total_adult_amount + total_concession_amount AS farebox, 
                    total_adult + total_concession AS ridership, total_adult, total_concession
                    FROM mybas.trip_details
                    JOIN mybas.route ON route.id = trip_details.route_id
                    JOIN mybas.stage ON stage.route_id = route.id 
                    JOIN mybas.bus ON bus.id = trip_details.bus_id 
                    JOIN mybas.bus_driver ON bus_driver.id = trip_details.driver_id
                    JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.id = trip_details.route_schedule_mstr_id
                    WHERE start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                    AND route.status = 1
                    AND route.id = " . $validatedData['route_id'] . "
                    GROUP BY trip_details.id
                    ORDER BY route.route_number, service_date, trip_details.trip_code, trip_details.id;");

                    $lastKey = array_key_last($allTrips);
                    $totalBusStop = 0;
                    $pastRouteNo = "";
                    $pastCode = "";
                    $pastDate = "";
                    $count = 0;
                    $totalPerTripCode = [];
                    $totalPerDate = [];
                    foreach($allTrips as $key => $allTrip){
                        $out->writeln("New loop: " . $allTrip->id);
                        $out->writeln("Past date: " . $pastDate . " | Past Trip Code: " . $pastCode . " | Past Route No: " . $pastRouteNo);

                        //Enter total per date per trip_code
                        if($allTrip->service_date != $pastDate || $allTrip->trip_code != $pastCode || $allTrip->route_number != $pastRouteNo
                        && $pastDate != NULL && $pastCode != NULL && $pastRouteNo != NULL){
                            $out->writeln("Inside Splice Total Trip Code Loop: " . $key . " - " . $allTrip->route_number . " - " . $allTrip->service_date . " - " . $allTrip->trip_code);
                            $out->writeln("up count: " . $count);

                            if($count==0){
                                array_splice($allTrips, $key, 0, $totalPerTripCode);
                            }else{
                                $newKey = $key + $count - 1;
                                $out->writeln("newKey: " . $newKey);
                                array_splice($allTrips, $newKey, 0, $totalPerTripCode);
                            }
                            $count++;
                            $out->writeln("low count: " . $count);
                        }

                        //Enter total per date
                        if(($allTrip->route_number == $pastRouteNo || $allTrip->route_number != $pastRouteNo) &&
                        $allTrip->service_date != $pastDate && $pastDate != NULL){
                            //dd($totalPerDate);
                            $out->writeln("Inside Splice Total Date Loop: " . $key . " - " . $allTrip->route_number . " - " . $allTrip->service_date . " - " . $allTrip->trip_code);
                            $out->writeln("up count: " . $count);

                            if($count==0){
                                array_splice($allTrips, $key, 0, $totalPerTripCode);
                            }else{
                                $newKey = $key + $count - 1;
                                $out->writeln("newKey: " . $newKey);
                                array_splice($allTrips, $newKey, 0, $totalPerDate);
                            }
                            $count++;
                            $out->writeln("low count: " . $count);
                        }

                        //Add punctuality
                        $diff = strtotime($allTrip->service_start) - strtotime($allTrip->actual_start);
                        if ($diff > 5 || $diff < -5) {
                            $allTrip->punctuality = "NOT PUNCTUAL";
                        } else {
                            $allTrip->punctuality = "ONTIME";
                        }

                        //Add IB/OB
                        if($allTrip->trip_code == 0){
                            $allTrip->trip_code_name = "OB";
                        }else{
                            $allTrip->trip_code_name = "IB";
                        }

                        //Add claim
                        if($allTrip->company_id == 29){
                            $allTrip->claim = 3.42;
                        }else{
                            $allTrip->claim = 1.33;
                        }
                        
                        $salesTimeSQL = DB::select("SELECT cast(MIN(ticket_sales_transaction.sales_date) as TIME) as sales_start, 
                        CAST(MAX(ticket_sales_transaction.sales_date) AS TIME) as sales_end
                        FROM mybas.ticket_sales_transaction
                        JOIN mybas.trip_details ON trip_details.trip_number = ticket_sales_transaction.trip_number
                        WHERE trip_details.trip_number = '" . $allTrip->trip_number . "';");

                        foreach($salesTimeSQL as $key2 => $salesTime){
                            $out->writeln("Inside sales loop" );
                            if($salesTime->sales_start==NULL){
                                $out->writeln("No Sales");
                                $allTrip->sales_start = "No Sales";
                                $allTrip->sales_end = "No Sales";
                            }else{
                                $out->writeln("With Sales");
                                $allTrip->sales_start = $salesTime->sales_start;
                                $allTrip->sales_end = $salesTime->sales_start;
                            }
                        }
                        $out->writeln("Out sales loop");

                        //TOTAL PER TRIP CODE 
                        $startDate = new Carbon($allTrip->service_date);
                        $endDate = new Carbon($allTrip->service_date . '23:59:59');

                        $totalPerTripCode = DB::select("SELECT trip_details.trip_code, route.route_number, 
                        route.route_name, cast(trip_details.start_trip as DATE) as service_date,
                        SUM(route.inbound_distance) as distance, 
                        SUM(trip_details.total_mileage) as travel_gps, 
                        (case when (route.company_id = 29) THEN 3.42 * SUM(route.inbound_distance) 
                        ELSE 1.33 * SUM(route.inbound_distance) END) as travel_claim, trip_details.total_mileage, 
                        (case when (route.company_id = 29) THEN 3.42 * SUM(trip_details.total_mileage)
                        ELSE 1.33 * SUM(trip_details.total_mileage) END) as travel_gps_claim, 
                        SUM(total_adult) as total_adult, SUM(total_concession) as total_concession, 
                        SUM(total_adult) + SUM(total_concession) as ridership, 
                        SUM(total_adult_amount) + SUM(total_concession_amount) as farebox
                        FROM mybas.trip_details
                        JOIN mybas.route ON route.id = trip_details.route_id
                        WHERE trip_details.start_trip BETWEEN '" . $startDate . "' AND '" . $endDate . "'
                        AND trip_details.trip_code = " . $allTrip->trip_code . "
                        AND route.route_number = '" . $allTrip->route_number . "';");

                        foreach($totalPerTripCode as $key3 => $perTripCode){
                            $out->writeln("Inside total per trip code loop" );

                            $totalBusStop = DB::select("SELECT COUNT(stage.id) as bus_stop_travel
                            FROM mybas.trip_details
                            JOIN mybas.route ON route.id = trip_details.route_id
                            JOIN mybas.stage ON stage.route_id = route.id
                            WHERE trip_details.start_trip BETWEEN '" . $startDate . "' AND '" . $endDate . "'
                            AND trip_details.trip_code = " . $allTrip->trip_code . "
                            AND route.route_number = '" . $allTrip->route_number . "';");

                            foreach($totalBusStop as $key4 => $busStop){
                                $out->writeln("Inside total bus stop per trip code loop" );
                                $perTripCode->bus_stop_travel = $busStop->bus_stop_travel;
                            }
                        }

                        //TOTAL PER TRIP DATE
                        $totalPerDate = DB::select("SELECT cast(trip_details.start_trip as DATE) as service_date,
                        route.route_number, SUM(route.inbound_distance) as distance, SUM(trip_details.total_mileage) as travel_gps, 
                        (case when (route.company_id = 29) THEN 3.42 * SUM(route.inbound_distance) 
                        ELSE 1.33 * SUM(route.inbound_distance) END) as travel_claim, 
                        (case when (route.company_id = 29) THEN 3.42 * SUM(trip_details.total_mileage)
                        ELSE 1.33 * SUM(trip_details.total_mileage) END) as travel_gps_claim, 
                        SUM(total_adult) as total_adult, SUM(total_concession) as total_concession, 
                        SUM(total_adult) + SUM(total_concession) as ridership, 
                        SUM(total_adult_amount) + SUM(total_concession_amount) as farebox
                        FROM mybas.trip_details
                        JOIN mybas.route ON route.id = trip_details.route_id
                        WHERE trip_details.start_trip BETWEEN '" . $startDate . "' AND '" . $endDate . "'
                        AND route.route_number = '" . $allTrip->route_number . "';");

                        foreach($totalPerDate as $key5 => $perDate){
                            $out->writeln("Inside total per date loop" );

                            $totalBusStopPerDate = DB::select("SELECT COUNT(stage.id) as bus_stop_travel
                            FROM mybas.trip_details
                            JOIN mybas.route ON route.id = trip_details.route_id
                            JOIN mybas.stage ON stage.route_id = route.id
                            WHERE trip_details.start_trip BETWEEN '" . $startDate . "' AND '" . $endDate . "'
                            AND route.route_number = '" . $allTrip->route_number . "';");

                            foreach($totalBusStopPerDate as $key6 => $busStopPerDate){
                                $out->writeln("Inside total bus stop per date loop" );
                                $perDate->bus_stop_travel = $busStopPerDate->bus_stop_travel;
                            }
                        }
                        $pastRouteNo = $allTrip->route_number;
                        $pastDate = $allTrip->service_date;
                        $pastCode = $allTrip->trip_code;

                        if($lastKey==$key){
                            //Grand Total
                            $grandTotal = DB::select("SELECT SUM(route.inbound_distance) as distance, 
                            SUM(trip_details.total_mileage) as travel_gps, 
                            (case when (route.company_id = 29) THEN 3.42 * SUM(route.inbound_distance) 
                            ELSE 1.33 * SUM(route.inbound_distance) END) as travel_claim, trip_details.total_mileage, 
                            (case when (route.company_id = 29) THEN 3.42 * SUM(trip_details.total_mileage)
                            ELSE 1.33 * SUM(trip_details.total_mileage) END) as travel_gps_claim, 
                            SUM(total_adult) as total_adult, SUM(total_concession) as total_concession, 
                            SUM(total_adult) + SUM(total_concession) as ridership, 
                            SUM(total_adult_amount) + SUM(total_concession_amount) as farebox
                            FROM mybas.trip_details
                            JOIN mybas.route ON route.id = trip_details.route_id
                            WHERE trip_details.start_trip BETWEEN '" . $dateFrom. "' AND '" . $dateTo . "'");

                            foreach($grandTotal as $key7 => $grand){
                                $out->writeln("Inside grand total loop" );

                                $grandTotalBus = DB::select("SELECT COUNT(stage.id) as bus_stop_travel
                                FROM mybas.trip_details
                                JOIN mybas.route ON route.id = trip_details.route_id
                                JOIN mybas.stage ON stage.route_id = route.id
                                WHERE trip_details.start_trip BETWEEN '" . $dateFrom. "' AND '" . $dateTo . "'");

                                foreach($grandTotalBus as $key8 => $grandBus){
                                    $out->writeln("Inside total bus stop grand loop" );
                                    $grand->bus_stop_travel = $grandBus->bus_stop_travel;
                                }
                            }

                            $newKey = $key + $count;
                            $out->writeln("last newKey: " . $newKey);
                            array_splice($allTrips, $newKey, 0, $grandTotal);
                            array_splice($allTrips, $newKey, 0, $totalPerDate);
                            array_splice($allTrips, $newKey, 0,  $totalPerTripCode);
                        }
                    }
                    $out->writeln("Out loop");
                }
            }
            $out->writeln(Carbon::now() . "Go to excel");
            return Excel::download(new SPADClaimDetails($allTrips, $validatedData['dateFrom'], $validatedData['dateTo'], $networkArea), 'ClaimDetails_Report_SPAD_'.Carbon::now()->format('YmdHis').'.xlsx');
        }else{
            $this->dispatchBrowserEvent('company-required');
        }
    }

    public function printClaimDetailsFastOld(){
        $out = new ConsoleOutput();
        $out->writeln("YOU ARE IN printClaimDetails()");

        $validatedData = Validator::make($this->state,[
            'dateFrom' => ['required', 'date'],
            'dateTo' => ['required', 'date'],
            'route_id' => ['required'],
        ])->validate();

        
        $startDate = new Carbon($validatedData['dateFrom']);
        $endDate = new Carbon($validatedData['dateTo']);
        $all_dates = array();

        while ($startDate->lte($endDate)){
            $all_dates[] = $startDate->toDateString();
            $startDate->addDay();
        }

        $claimDetails = collect();
        if ($this->selectedCompany){
            if($this->selectedCompany=='All'){
                $networkArea = 'All';
                //ClaimDetails all routes for all company
                if($validatedData['route_id']=='All'){
                    $grandBusStop = 0;
                    $grandTravel = 0;
                    $grandClaim = 0;
                    $grandTravelGPS = 0;
                    $grandClaimGPS = 0;
                    $grandCountPassenger = 0;
                    $grandSales= 0;
                    $grandAdult = 0;
                    $grandConcession = 0;
                    $allRoutes = Route::where('status',1)->orderBy('route_number')->get();

                    foreach($allRoutes as $allRoute){
                        if($allRoute->company_id==29){
                            $charge = 3.42;
                        }else{
                            $charge = 1.33;
                        }

                        foreach($all_dates as $all_date){
                            $dateFrom = new Carbon($all_date);
                            $dateTo = new Carbon($all_date . '23:59:59');
                            
                            $out->writeln(Carbon::now() . "Before processing Inbound Trip...");

                            //Inbound
                            $stagePerRoute = Stage::where('route_id', $allRoute->id)->orderBy('stage_order', 'DESC')->first();
                            $startPointIn = $stagePerRoute->stage_name;

                            $tripInbound = DB::select("SELECT trip_details.id, route.route_number, trip_details.trip_code, cast(trip_details.start_trip as date) as service_date, trip_details.trip_number, bus.bus_registration_number, bus.bus_age, bus_driver.driver_number,
                                                    COUNT(stage.id) as bus_stop_travel, route.inbound_distance as distance, " . $charge . " * route.inbound_distance AS travel_claim, 
                                                    trip_details.total_mileage, " . $charge . " * trip_details.total_mileage AS travel_gps_claim,
                                                    route_scheduler_mstr.schedule_start_time as service_start, cast(trip_details.start_trip as TIME) as actual_start, 
                                                    route_scheduler_mstr.schedule_end_time as service_end, cast(trip_details.end_trip as TIME) as actual_end,
                                                    total_adult_amount + total_concession_amount AS farebox, total_adult + total_concession AS ridership,
                                                    total_adult, total_concession
                                                    FROM mybas.trip_details
                                                    JOIN mybas.route ON route.id = trip_details.route_id
                                                    JOIN mybas.stage ON stage.route_id = route.id 
                                                    JOIN mybas.bus ON bus.id = trip_details.bus_id 
                                                    JOIN mybas.bus_driver ON bus_driver.id = trip_details.driver_id
                                                    JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.id = trip_details.route_schedule_mstr_id
                                                    WHERE start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                                                    AND route.id = " . $allRoute->id . "
                                                    AND trip_details.trip_code = 1
                                                    GROUP BY trip_details.id
                                                    ORDER BY route.route_number, service_date, trip_details.trip_code, trip_details.id;");
                            

                            $salesInbound = DB::select("SELECT trip_details.id, cast(MIN(ticket_sales_transaction.sales_date) as TIME) as sales_start, 
                                                        CAST(MAX(ticket_sales_transaction.sales_date) AS TIME) as sales_end
                                                        FROM mybas.trip_details
                                                        JOIN mybas.ticket_sales_transaction ON ticket_sales_transaction.trip_number = trip_details.trip_number
                                                        JOIN mybas.route ON route.id = trip_details.route_id
                                                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                                                        AND route.id = " . $allRoute->id . "
                                                        AND trip_details.trip_code = 1
                                                        GROUP BY trip_details.id
                                                        ORDER BY route.route_number, trip_details.id;");
                            $totIn = [];
                            $totalBusStopIn = 0;
                            $totalTravelIn = 0;
                            $totalClaimIn = 0;
                            $totalTravelGPSIn = 0;
                            $totalClaimGPSIn = 0;
                            $totalCountPassengerIn = 0;
                            $totalSalesIn = 0;
                            $totalAdultIn = 0;
                            $totalConcessionIn = 0;
                            foreach($tripInbound as $key => $tripIn){
                                $totalBusStopIn += $tripIn->bus_stop_travel;
                                $totalTravelIn += $tripIn->distance;
                                $totalClaimIn += $tripIn->travel_claim;
                                $totalTravelGPSIn += $tripIn->total_mileage;
                                $totalClaimGPSIn += $tripIn->travel_gps_claim;
                                $totalCountPassengerIn += $tripIn->ridership;
                                $totalSalesIn += $tripIn->farebox;
                                $totalAdultIn += $tripIn->total_adult;
                                $totalConcessionIn += $tripIn->total_concession;

                                $tripIn->route_name = implode(" - ", array_reverse(explode("-", $allRoute->route_name)));
                                $tripIn->stage_name = $startPointIn;
                                $found=false;
                                foreach($salesInbound as $key2 => $salesIn){
                                    if($salesIn->id == $tripIn->id){
                                        $tripIn->sales_start = $salesIn->sales_start;
                                        $tripIn->sales_end = $salesIn->sales_end;
                                        $found = true;

                                        break ;
                                    }
                                }
                                if(!$found){
                                    $tripIn->sales_start = "No Sales";
                                    $tripIn->sales_end = "No Sales";
                                }
                            }

                            $totIn['total_bus_stop'] = $totalBusStopIn;
                            $totIn['total_travel'] = $totalTravelIn;
                            $totIn['total_claim'] = $totalClaimIn;
                            $totIn['total_travel_gps'] = $totalTravelGPSIn;
                            $totIn['total_claim_gps'] = $totalClaimGPSIn;
                            $totIn['total_count_passenger'] = $totalCountPassengerIn;
                            $totIn['total_sales'] = $totalSalesIn;
                            $totIn['total_adult'] = $totalAdultIn;
                            $totIn['total_concession'] = $totalConcessionIn;
                            //$allTripIn['total_inbound'] = $totIn;
                            array_push($tripInbound, $totIn);

                            $out->writeln(Carbon::now() . "After processing Inbound Trip...");
                            $out->writeln(Carbon::now() . "Before processing Outbound Trip...");

                            //Outbound
                            $tripOutbound = DB::select("SELECT trip_details.id, route.route_number, route.route_name, trip_details.trip_code, cast(trip_details.start_trip as date) as service_date, trip_details.trip_number, stage.stage_name, bus.bus_registration_number, bus.bus_age, bus_driver.driver_number,
                                                    COUNT(stage.id) as bus_stop_travel, route.outbound_distance as distance, " . $charge . "  * route.inbound_distance AS travel_claim, 
                                                    trip_details.total_mileage," . $charge . "  * trip_details.total_mileage AS travel_gps_claim,
                                                    route_scheduler_mstr.schedule_start_time as service_start, cast(trip_details.start_trip as TIME) as actual_start, 
                                                    route_scheduler_mstr.schedule_end_time as service_end, cast(trip_details.end_trip as TIME) as actual_end,
                                                    total_adult_amount + total_concession_amount AS farebox, total_adult + total_concession AS ridership,
                                                    total_adult, total_concession
                                                    FROM mybas.trip_details
                                                    JOIN mybas.route ON route.id = trip_details.route_id
                                                    JOIN mybas.stage ON stage.route_id = route.id 
                                                    JOIN mybas.bus ON bus.id = trip_details.bus_id 
                                                    JOIN mybas.bus_driver ON bus_driver.id = trip_details.driver_id
                                                    JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.id = trip_details.route_schedule_mstr_id
                                                    WHERE start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                                                    AND route.id = " . $allRoute->id . "
                                                    AND trip_details.trip_code = 0
                                                    GROUP BY trip_details.id
                                                    ORDER BY route.route_number, service_date, trip_details.trip_code, trip_details.id;");
                        
                            $salesOutbound = DB::select("SELECT trip_details.id, cast(MIN(ticket_sales_transaction.sales_date) as TIME) as sales_start, 
                                                        CAST(MAX(ticket_sales_transaction.sales_date) AS TIME) as sales_end
                                                        FROM mybas.trip_details
                                                        JOIN mybas.ticket_sales_transaction ON ticket_sales_transaction.trip_number = trip_details.trip_number
                                                        JOIN mybas.route ON route.id = trip_details.route_id
                                                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                                                        AND route.id = " . $allRoute->id . "
                                                        AND trip_details.trip_code = 0
                                                        GROUP BY trip_details.id
                                                        ORDER BY route.route_number, trip_details.id;");

                            $totOut = [];
                            $totalBusStopOut = 0;
                            $totalTravelOut = 0;
                            $totalClaimOut = 0;
                            $totalTravelGPSOut = 0;
                            $totalClaimGPSOut = 0;
                            $totalCountPassengerOut = 0;
                            $totalSalesOut = 0;
                            $totalAdultOut = 0;
                            $totalConcessionOut = 0;
                            foreach($tripOutbound as $key => $tripOut){
                                $totalBusStopOut += $tripOut->bus_stop_travel;
                                $totalTravelOut += $tripOut->distance;
                                $totalClaimOut += $tripOut->travel_claim;
                                $totalTravelGPSOut += $tripOut->total_mileage;
                                $totalClaimGPSOut += $tripOut->travel_gps_claim;
                                $totalCountPassengerOut += $tripOut->ridership;
                                $totalSalesOut += $tripOut->farebox;
                                $totalAdultOut += $tripOut->total_adult;
                                $totalConcessionOut += $tripOut->total_concession;
                                $found=false;
                                foreach($salesOutbound as $key2 => $salesOut){
                                    if($salesOut->id == $tripOut->id){
                                        $tripOut->sales_start = $salesOut->sales_start;
                                        $tripOut->sales_end = $salesOut->sales_end;
                                        $found = true;

                                        break ;
                                    }
                                }
                                if(!$found){
                                    $tripOut->sales_start = "No Sales";
                                    $tripOut->sales_end = "No Sales";
                                }
                            }
                            $totOut['total_bus_stop'] = $totalBusStopOut;
                            $totOut['total_travel'] = $totalTravelOut;
                            $totOut['total_claim'] = $totalClaimOut;
                            $totOut['total_travel_gps'] = $totalTravelGPSOut;
                            $totOut['total_claim_gps'] = $totalClaimGPSOut;
                            $totOut['total_count_passenger'] = $totalCountPassengerOut;
                            $totOut['total_sales'] = $totalSalesOut;
                            $totOut['total_adult'] = $totalAdultOut;
                            $totOut['total_concession'] = $totalConcessionOut;
                            //$allTripOut['total_outbound'] = $totOut;
                            array_push($tripOutbound, $totOut);

                            $out->writeln(Carbon::now() . "After processing Outbound Trip...");

                            $totalBusStop = $totalBusStopIn + $totalBusStopOut;
                            $totalTravel = $totalTravelIn + $totalTravelOut;
                            $totalClaim = $totalClaimIn + $totalClaimOut;
                            $totalTravelGPS = $totalTravelGPSIn + $totalTravelGPSOut;
                            $totalClaimGPS = $totalClaimGPSIn + $totalClaimGPSOut;
                            $totalCountPassenger = $totalCountPassengerIn + $totalCountPassengerOut;
                            $totalSales = $totalSalesIn + $totalSalesOut;
                            $totalAdult = $totalAdultIn + $totalAdultOut;
                            $totalConcession = $totalConcessionIn + $totalConcessionOut;

                            $allTripPerDate['inbound'] = $tripInbound;
                            $allTripPerDate['outbound'] = $tripOutbound;
                            $totalPerDate['total_bus_stop'] = $totalBusStop;
                            $totalPerDate['total_travel'] = $totalTravel;
                            $totalPerDate['total_claim'] = $totalClaim;
                            $totalPerDate['total_travel_gps'] = $totalTravelGPS;
                            $totalPerDate['total_claim_gps'] = $totalClaimGPS;
                            $totalPerDate['total_count_passenger'] = $totalCountPassenger;
                            $totalPerDate['total_sales'] = $totalSales;
                            $totalPerDate['total_adult'] = $totalAdult;
                            $totalPerDate['total_concession'] = $totalConcession;
                            $allTripPerDate['total_per_date'] = $totalPerDate;
                            $perDate[$all_date] = $allTripPerDate;

                            $grandBusStop += $totalBusStop;
                            $grandTravel +=  $totalTravel;
                            $grandClaim += $totalClaim;
                            $grandTravelGPS += $totalTravelGPS;
                            $grandClaimGPS += $totalClaimGPS;
                            $grandCountPassenger += $totalCountPassenger;
                            $grandSales += $totalSales;
                            $grandAdult += $totalAdult;
                            $grandConcession += $totalConcession;
                        }
                        $perRoute[$allRoute->route_number] = $perDate;
                        $out->writeln(Carbon::now() . "Completed for Route " . $allRoute->route_number);

                    }
                    $all['total_bus_stop'] = $grandBusStop;
                    $all['total_travel'] = $grandTravel;
                    $all['total_claim'] = $grandClaim;
                    $all['total_travel_gps'] = $grandTravelGPS;
                    $all['total_claim_gps'] = $grandClaimGPS;
                    $all['total_count_passenger'] = $grandCountPassenger;
                    $all['total_sales'] = $grandSales;
                    $all['total_adult'] = $grandAdult;
                    $all['total_concession'] = $grandConcession;
                    $grand['allRoute'] = $perRoute;
                    $grand['grand'] = $all;
                    $claimDetails->add($grand);
                    $out->writeln(Carbon::now() . "DONE ALL ROUTE ");
                }
            }
            else{
                $companyDetails = Company::where('id', $this->selectedCompany)->first();
                $networkArea = $companyDetails->company_name;
                if($companyDetails->id==29){
                    $charge = 3.42;
                }else{
                    $charge = 1.33;
                }

                //ClaimDetails all routes for specific company
                if($validatedData['route_id']=='All'){

                }
                //ClaimDetails specific routes for specific company
                else{

                }
            }
            $out->writeln(Carbon::now() . "Go to excel");
            return Excel::download(new SPADClaimDetails($claimDetails, $validatedData['dateFrom'], $validatedData['dateTo'], $networkArea), 'ClaimDetails_Report_SPAD_'.Carbon::now()->format('YmdHis').'.xlsx');
        }else{
            $this->dispatchBrowserEvent('company-required');
        }
    }

    public function printClaimDetails()
    {
        $out = new ConsoleOutput();
        $out->writeln("YOU ARE IN printClaimDetails())");

        $validatedData = Validator::make($this->state,[
            'dateFrom' => ['required', 'date'],
            'dateTo' => ['required', 'date'],
            'route_id' => ['required'],
        ])->validate();

        $startDate = new Carbon($validatedData['dateFrom']);
        $endDate = new Carbon($validatedData['dateTo']);
        $all_dates = array();

        while ($startDate->lte($endDate)){
            $all_dates[] = $startDate->toDateString();
            $startDate->addDay();
        }

        $claimDetails = collect();
        $grandBusStop = 0;
        $grandTravel = 0;
        $grandClaim = 0;
        $grandTravelGPS = 0;
        $grandClaimGPS = 0;
        $grandCountPassenger = 0;
        $grandSale = 0;
        $grandTotal = 0;
        $grandTotalAdult = 0;
        $grandTotalConcession = 0;
        if ($this->selectedCompany){
            if($this->selectedCompany=='All'){
                $networkArea = 'All';
                if(!empty($validatedData['route_id'])) {
                    //ClaimDetails all routes for all company
                    if($validatedData['route_id']=='All'){
                        $allRoutes = Route::where('status',1)->orderBy('route_number')->get();

                        foreach($allRoutes as $allRoute) {
                            foreach($all_dates as $all_date) {
                                $out->writeln($all_date . ' - ' . $allRoute->route_number);
                                $totalBusStopIn = 0;
                                $totalTravelIn = 0;
                                $totalClaimIn = 0;
                                $totalTravelGPSIn = 0;
                                $totalClaimGPSIn = 0;
                                $totalCountPassengerIn = 0;
                                $totalSalesIn = 0;
                                $totalTotalIn = 0;
                                $totalAdultIn = 0;
                                $totalConcessionIn = 0;
                                $allTripIn = [];
                                $allInbound = [];
                                $existInTrip = false;
                                $existOutTrip = false;
                                $firstDate = new Carbon($all_date);
                                $lastDate = new Carbon($all_date . '23:59:59');
            
                                //Inbound
                                $allTripInbounds = TripDetail::where('route_id', $allRoute->id)
                                    ->whereBetween('start_trip', [$firstDate,$lastDate])
                                    ->where('trip_code', 1)
                                    ->get();
            
                                $routeNameIn = implode(" - ", array_reverse(explode(" - ", $allRoute->route_name)));
                                if (count($allTripInbounds) > 0) {
                                    $existInTrip = true;
                                    $countIn = 0;
            
                                    foreach ($allTripInbounds as $allTripInbound) {
                                        $inbound['trip_type'] = "IB";
                                        $firstStage = Stage::where('route_id', $allTripInbound->route_id)->orderby('stage_order', 'DESC')->first();
                                        $inbound['start_point'] = $firstStage->stage_name;
                                        $inbound['trip_no'] = "T" . $allTripInbound->id;
                                        $inbound['rph_no'] = $allTripInbound->trip_number;
                                        
                                        if($allTripInbound->bus_id != NULL){
                                            $inbound['bus_plate_no'] = $allTripInbound->Bus->bus_registration_number;
                                            $inbound['bus_age'] = $allTripInbound->Bus->bus_age;
                                            //$inbound['bus_age'] = Carbon::parse($allTripInbound->Bus->bus_manufacturing_date)->diff(Carbon::now())->y;
                                        }else{
                                            $inbound['bus_plate_no'] = "No Data";
                                            $inbound['bus_age'] = "No Data";
                                        }
            
                                        if($allRoute->company_id==29){
                                            $charge = 3.42;
                                        }else{
                                            $charge = 1.33;
                                        }
                                        $inbound['charge_km'] = $charge;
            
                                        if($allTripInbound->driver_id != NULL){
                                            $inbound['driver_id'] = $allTripInbound->BusDriver->driver_number;
                                        }else{
                                            $inbound['driver_id'] = "No Data";
                                        }
            
                                        //$busStop = BusStand::where('route_id', $allTripInbound->route_id)->count();
                                        $busStop = Stage::where('route_id', $allTripInbound->route_id)->count();
                                        $inbound['bus_stop_travel'] = $busStop;
                                        $totalBusStopIn += $busStop;
            
                                        $travel = $allTripInbound->Route->inbound_distance;
                                        $inbound['travel'] = $travel;
                                        $totalTravelIn += $travel;
            
                                        $claim = $charge * $travel;
                                        $inbound['claim'] = $claim;
                                        $totalClaimIn += $claim;
            
                                        $travelGPS = $allTripInbound->total_mileage;
                                        $inbound['travel_gps'] = $travelGPS;
                                        $totalTravelGPSIn += $travelGPS;
            
                                        $claimGPS = $charge * $travelGPS;
                                        $inbound['claim_gps'] = $claimGPS;
                                        $totalClaimGPSIn += $claimGPS;

                                        $inbound['travel_BOP'] = $travel;
                                        $inbound['claim_BOP'] = $claim;
            
                                        if($allTripInbound->route_schedule_mstr_id!=NULL){
                                            $inbound['service_start'] = Carbon::create($allTripInbound->RouteScheduleMSTR->schedule_start_time)->format('H:i');
                                            $inbound['service_end'] = Carbon::create($allTripInbound->RouteScheduleMSTR->schedule_end_time)->format('H:i');
                                        }else{
                                            $inbound['service_start'] = "No Data";
                                            $inbound['service_end'] = "No Data";
                                        }
                                        $inbound['start_point_time'] = $inbound['service_start'];
            
                                        $inbound['actual_start'] = date("H:i", strtotime($allTripInbound->start_trip));
                                        $inbound['actual_end'] = date("H:i", strtotime($allTripInbound->end_trip));
            
                                        //Check 1st sales
                                        $firstSales = TicketSalesTransaction::where('trip_number', $allTripInbound->trip_number)
                                            ->orderby('sales_date')
                                            ->first();
                                        if($firstSales){
                                            $inbound['sales_start'] = date("H:i", strtotime($firstSales->sales_date));
                                        }else{
                                            $inbound['sales_start'] = "No Sales";
                                        }
            
                                        //Check last sales
                                        $lastSales = TicketSalesTransaction::where('trip_number', $allTripInbound->trip_number)
                                            ->orderby('sales_date', 'DESC')
                                            ->first();
                                        if($lastSales){
                                            $inbound['sales_end'] = date("H:i", strtotime($lastSales->sales_date));
                                        }else{
                                            $inbound['sales_end'] = "No Sales";
                                        }
            
                                        if($inbound['service_start']!="No Data"){
                                            $diff = ((strtotime($inbound['service_start']) - strtotime($inbound['actual_start']))/60);
                                            if ($diff > 5 || $diff < -5) {
                                                $inbound['punctuality'] = "NOT PUNCTUAL";
                                            }else {
                                                $inbound['punctuality'] = "ONTIME";
                                            }
                                        }else{
                                            $inbound['punctuality'] = "No Data";
                                        }

                                        //Status
                                        //Check GPS
                                        $checkGPS = VehiclePosition::where('trip_id', $allTripInbound->trip_number)->first();
                                        if($checkGPS){
                                            //Check actual start & end
                                            if($inbound['actual_start']!="No Data" && $inbound['actual_end']!="No Data"){
                                                $diff = ((strtotime($inbound['actual_end']) - strtotime($inbound['actual_start']))/60);
                                                if ($diff < 5) {
                                                    $inbound['status'] = "Incomplete";
                                                    $inbound['status_desc'] = "Duplicate Trip";
                                                }else {
                                                    $inbound['status'] = "Complete";
                                                    $inbound['status_desc'] = " - ";
                                                }
                                            }else {
                                                $inbound['status'] = "Incomplete";
                                                $inbound['status_desc'] = "Outside Schedule";
                                            }
                                        }else{
                                            $inbound['status'] = "Incomplete";
                                            $inbound['status_desc'] = "No GPS Tracking";
                                        }
            
                                        $adult = $allTripInbound->total_adult;
                                        $concession = $allTripInbound->total_concession;
                                        $countPassenger = $adult + $concession;
                                        $sales = $allTripInbound->total_adult_amount + $allTripInbound->total_concession_amount;
                                        //Check tickets
                                        if($countPassenger==0 || $sales==0){
                                            $allTicketPerTrips = TicketSalesTransaction::where('trip_number', $allTripInbound->trip_number)->get();
                                            if(count($allTicketPerTrips)>0){
                                                $adult = 0;
                                                $concession = 0;
                                                $countPassenger = 0;
                                                $sales = 0;
                                                foreach($allTicketPerTrips as $allTicketPerTrip){
                                                    $sales += $allTicketPerTrip->actual_amount;
                                                    if($allTicketPerTrip->passenger_type==0){
                                                        $adult++;
                                                    }else{
                                                        $concession++;
                                                    }
                                                }
                                                $countPassenger = $adult + $concession;
                                            }
                                        }
                                        $inbound['pass_count'] = $countPassenger;
                                        $totalCountPassengerIn += $countPassenger;
            
                                        $inbound['total_sales'] = $sales;
                                        $totalSalesIn += $sales;
            
                                        $inbound['total_on'] = $countPassenger;
                                        $totalTotalIn += $countPassenger;
            
                                        $inbound['adult'] = $adult;
                                        $totalAdultIn += $adult;
            
                                        $inbound['concession'] = $concession;
                                        $totalConcessionIn += $concession;
            
                                        $allInbound[$countIn] = $inbound;
                                        $countIn++;
                                    }
                                    $allTripIn[$routeNameIn] = $allInbound;
                                    $totIn['total_bus_stop_in'] = $totalBusStopIn;
                                    $totIn['total_travel_in'] = $totalTravelIn;
                                    $totIn['total_claim_in'] = $totalClaimIn;
                                    $totIn['total_travel_gps_in'] = $totalTravelGPSIn;
                                    $totIn['total_claim_gps_in'] = $totalClaimGPSIn;
                                    $totIn['total_count_passenger_in'] = $totalCountPassengerIn;
                                    $totIn['total_sales_in'] = $totalSalesIn;
                                    $totIn['total_total_in'] = $totalTotalIn;
                                    $totIn['total_adult_in'] = $totalAdultIn;
                                    $totIn['total_concession_in'] = $totalConcessionIn;
                                    $allTripIn['total_inbound'] = $totIn;
                                }
            
                                $totalBusStopOut = 0;
                                $totalTravelOut = 0;
                                $totalClaimOut = 0;
                                $totalTravelGPSOut = 0;
                                $totalClaimGPSOut = 0;
                                $totalCountPassengerOut = 0;
                                $totalSalesOut = 0;
                                $totalTotalOut = 0;
                                $totalAdultOut = 0;
                                $totalConcessionOut = 0;
                                $allTripOut = [];
                                $allOutbound = [];
                                //Outbound
                                $allTripOutbounds = TripDetail::where('route_id', $allRoute->id)
                                    ->whereBetween('start_trip', [$firstDate,$lastDate])
                                    ->where('trip_code', 0)
                                    ->get();
            
                                $routeNameOut = $allRoute->route_name;
                                if (count($allTripOutbounds) > 0) {
                                    $existOutTrip = true;
                                    $countOut = 0;
            
                                    foreach ($allTripOutbounds as $allTripOutbound) {
                                        $outbound['trip_type'] = "OB";
                                        $firstStage = Stage::where('route_id', $allTripOutbound->route_id)->orderby('stage_order')->first();
                                        $outbound['start_point'] = $firstStage->stage_name;
                                        $outbound['trip_no'] = "T" . $allTripOutbound->id;
                                        $outbound['rph_no'] = $allTripOutbound->trip_number;
            
                                        if($allTripOutbound->bus_id != NULL){
                                            $outbound['bus_plate_no'] = $allTripOutbound->Bus->bus_registration_number;
                                            $outbound['bus_age'] = $allTripOutbound->Bus->bus_age;
                                            //$inbound['bus_age'] = Carbon::parse($allTripOutbound->Bus->bus_manufacturing_date)->diff(Carbon::now())->y;
                                        }else{
                                            $outbound['bus_plate_no']  = "No Data";
                                            $outbound['bus_age'] = "No Data";
                                        }
            
                                        if($allRoute->company_id==29){
                                            $charge = 3.42;
                                        }else{
                                            $charge = 1.33;
                                        }
                                        $outbound['charge_km'] = $charge;
            
                                        if($allTripOutbound->driver_id != NULL){
                                            $outbound['driver_id'] = $allTripOutbound->BusDriver->driver_number;
                                        }else{
                                            $outbound['driver_id'] = "No Data";
                                        }
            
                                        //$busStop = BusStand::where('route_id', $allTripOutbound->route_id)->count();
                                        $busStop = Stage::where('route_id', $allTripOutbound->route_id)->count();
                                        $outbound['bus_stop_travel'] = $busStop;
                                        $totalBusStopOut += $busStop;
            
                                        $travel = $allTripOutbound->Route->inbound_distance;
                                        $outbound['travel'] = $travel;
                                        $totalTravelOut += $travel;
            
                                        $claim = $charge * $travel;
                                        $outbound['claim'] = $claim;
                                        $totalClaimOut += $claim;
            
                                        $travelGPS = $allTripOutbound->total_mileage;
                                        $outbound['travel_gps'] = $travelGPS;
                                        $totalTravelGPSOut += $travelGPS;
            
                                        $claimGPS = $charge * $travelGPS;
                                        $outbound['claim_gps'] = $claimGPS;
                                        $totalClaimGPSOut += $claimGPS;
            
                                        $outbound['status'] = "Complete";
                                        $outbound['travel_BOP'] = $travel;
                                        $outbound['claim_BOP'] = $claim;
            
                                        if($allTripOutbound->route_schedule_mstr_id!=NULL){
                                            $outbound['service_start'] = Carbon::create($allTripOutbound->RouteScheduleMSTR->schedule_start_time)->format('H:i');
                                            $outbound['service_end'] = Carbon::create($allTripOutbound->RouteScheduleMSTR->schedule_end_time)->format('H:i');
                                        }else{
                                            $outbound['service_start'] = "No Data";
                                            $outbound['service_end'] = "No Data";
                                        }
                                        $outbound['start_point_time'] = $outbound['service_start'];
            
                                        $outbound['actual_start'] = date("H:i", strtotime($allTripOutbound->start_trip));
                                        $outbound['actual_end'] = date("H:i", strtotime($allTripOutbound->end_trip));
            
                                        //Check 1st sales
                                        $firstSales = TicketSalesTransaction::where('trip_number', $allTripOutbound->trip_number)
                                            ->orderby('sales_date')
                                            ->first();
                                        if($firstSales){
                                            $outbound['sales_start'] = date("H:i", strtotime($firstSales->sales_date));
                                        }else{
                                            $outbound['sales_start'] = "No Sales";
                                        }
            
                                        //Check last sales
                                        $lastSales = TicketSalesTransaction::where('trip_number', $allTripOutbound->trip_number)
                                            ->orderby('sales_date', 'DESC')
                                            ->first();
                                        if($lastSales){
                                            $outbound['sales_end'] = date("H:i", strtotime($lastSales->sales_date));
                                        }else{
                                            $outbound['sales_end'] = "No Sales";
                                        }
            
                                        if($outbound['service_start']!="No Data"){
                                            $diff = ((strtotime($outbound['service_start']) - strtotime($outbound['actual_start']))/60);
                                            if ($diff > 5 || $diff < -5) {
                                                $outbound['punctuality'] = "NOT PUNCTUAL";
                                            } else {
                                                $outbound['punctuality'] = "ONTIME";
                                            }
                                        }else{
                                            $outbound['punctuality'] = "No Data";
                                        }

                                        //Status
                                        //Check GPS
                                        $checkGPS = VehiclePosition::where('trip_id', $allTripOutbound->trip_number)->first();
                                        if($checkGPS){
                                            //Check actual start & end
                                            if($outbound['actual_start']!="No Data" && $outbound['actual_end']!="No Data"){
                                                $diff = ((strtotime($outbound['actual_end']) - strtotime($outbound['actual_start']))/60);
                                                if ($diff < 5) {
                                                    $outbound['status'] = "Incomplete";
                                                    $outbound['status_desc'] = "Duplicate Trip";
                                                }else {
                                                    $outbound['status'] = "Complete";
                                                    $outbound['status_desc'] = " - ";
                                                }
                                            }else {
                                                $outbound['status'] = "Incomplete";
                                                $outbound['status_desc'] = "Outside Schedule";
                                            }
                                        }else{
                                            $outbound['status'] = "Incomplete";
                                            $outbound['status_desc'] = "No GPS Tracking";
                                        }
            
                                        $adult = $allTripOutbound->total_adult;
                                        $concession = $allTripOutbound->total_concession;
                                        $countPassenger = $adult + $concession;
                                        $sales = $allTripOutbound->total_adult_amount + $allTripOutbound->total_concession_amount;
                                        //Check tickets
                                        if($countPassenger==0 || $sales==0){
                                            $allTicketPerTrips = TicketSalesTransaction::where('trip_number', $allTripOutbound->trip_number)->get();
                                            if(count($allTicketPerTrips)>0){
                                                $adult = 0;
                                                $concession = 0;
                                                $countPassenger = 0;
                                                $sales = 0;
                                                foreach($allTicketPerTrips as $allTicketPerTrip){
                                                    $sales += $allTicketPerTrip->actual_amount;
                                                    if($allTicketPerTrip->passenger_type==0){
                                                        $adult++;
                                                    }else{
                                                        $concession++;
                                                    }
                                                }
                                                $countPassenger = $adult + $concession;
                                            }
                                        }
                                        $outbound['pass_count'] = $countPassenger;
                                        $totalCountPassengerOut += $countPassenger;
            
                                        $outbound['total_sales'] = $sales;
                                        $totalSalesOut += $sales;
            
                                        $outbound['total_on'] = $countPassenger;
                                        $totalTotalOut += $countPassenger;
                                        
                                        $outbound['adult'] = $adult;
                                        $totalAdultOut += $adult;
                                        
                                        $outbound['concession'] = $concession;
                                        $totalConcessionOut += $concession;
            
                                        $allOutbound[$countOut] = $outbound;
                                        $countOut++;
                                    }
                                    $allTripOut[$routeNameOut] = $allOutbound;
                                    $totOut['total_bus_stop_out'] = $totalBusStopOut;
                                    $totOut['total_travel_out'] = $totalTravelOut;
                                    $totOut['total_claim_out'] = $totalClaimOut;
                                    $totOut['total_travel_gps_out'] = $totalTravelGPSOut;
                                    $totOut['total_claim_gps_out'] = $totalClaimGPSOut;
                                    $totOut['total_count_passenger_out'] = $totalCountPassengerOut;
                                    $totOut['total_sales_out'] = $totalSalesOut;
                                    $totOut['total_total_out'] = $totalTotalOut;
                                    $totOut['total_adult_out'] = $totalAdultOut;
                                    $totOut['total_concession_out'] = $totalConcessionOut;
                                    $allTripOut['total_outbound'] = $totOut;
                                }
            
                                $totalBusStopDate = 0;
                                $totalTravelDate = 0;
                                $totalClaimDate = 0;
                                $totalTravelGPSDate = 0;
                                $totalClaimGPSDate = 0;
                                $totalCountPassengerDate = 0;
                                $totalSalesDate = 0;
                                $totalTotalDate = 0;
                                $totalAdultDate = 0;
                                $totalConcessionDate = 0;
                                $data_perDate = [];
                                if ($existInTrip == true && $existOutTrip == true) {
                                    $totalBusStopDate = $totalBusStopIn + $totalBusStopOut;
                                    $totalTravelDate = $totalTravelIn + $totalTravelOut;
                                    $totalClaimDate = $totalClaimIn + $totalClaimOut;
                                    $totalTravelGPSDate = $totalTravelGPSIn + $totalTravelGPSOut;
                                    $totalClaimGPSDate = $totalClaimGPSIn + $totalClaimGPSOut;
                                    $totalCountPassengerDate = $totalCountPassengerIn + $totalCountPassengerOut;
                                    $totalSalesDate = $totalSalesIn + $totalSalesOut;
                                    $totalTotalDate = $totalTotalIn + $totalTotalOut;
                                    $totalAdultDate = $totalAdultIn + $totalAdultOut;
                                    $totalConcessionDate = $totalConcessionIn + $totalConcessionOut;
            
                                    $perDate['total_bus_stop_date'] = $totalBusStopDate;
                                    $perDate['total_travel_date'] = $totalTravelDate;
                                    $perDate['total_claim_date'] = $totalClaimDate;
                                    $perDate['total_travel_gps_date'] = $totalTravelGPSDate;
                                    $perDate['total_claim_gps_date'] = $totalClaimGPSDate;
                                    $perDate['total_count_passenger_date'] = $totalCountPassengerDate;
                                    $perDate['total_sales_date'] = $totalSalesDate;
                                    $perDate['total_total_date'] = $totalTotalDate;
                                    $perDate['total_adult_date'] = $totalAdultDate;
                                    $perDate['total_concession_date'] = $totalConcessionDate;
            
                                    $data_perDate['inbound_data'] = $allTripIn;
                                    $data_perDate['outbound_data'] = $allTripOut;
                                    $data_perDate['total_per_date'] = $perDate;
            
                                    $allDate[$all_date] = $data_perDate;
                                    $allData['data'] = $allDate;
                                    $allData['route_name'] = $allRoute->route_name;
                                    $route[$allRoute->route_number] = $allData;
                                    $data['allRoute'] = $route;
                                } elseif ($existInTrip == true && $existOutTrip == false) {
                                    $totalBusStopDate = $totalBusStopIn;
                                    $totalTravelDate = $totalTravelIn;
                                    $totalClaimDate = $totalClaimIn;
                                    $totalTravelGPSDate = $totalTravelGPSIn;
                                    $totalClaimGPSDate = $totalClaimGPSIn;
                                    $totalCountPassengerDate = $totalCountPassengerIn;
                                    $totalSalesDate = $totalSalesIn;
                                    $totalTotalDate = $totalTotalIn;
                                    $totalAdultDate = $totalAdultIn;
                                    $totalConcessionDate = $totalConcessionIn;
            
                                    $perDate['total_bus_stop_date'] = $totalBusStopDate;
                                    $perDate['total_travel_date'] = $totalTravelDate;
                                    $perDate['total_claim_date'] = $totalClaimDate;
                                    $perDate['total_travel_gps_date'] = $totalTravelGPSDate;
                                    $perDate['total_claim_gps_date'] = $totalClaimGPSDate;
                                    $perDate['total_count_passenger_date'] = $totalCountPassengerDate;
                                    $perDate['total_sales_date'] = $totalSalesDate;
                                    $perDate['total_total_date'] = $totalTotalDate;
                                    $perDate['total_adult_date'] = $totalAdultDate;
                                    $perDate['total_concession_date'] = $totalConcessionDate;
            
                                    $data_perDate['inbound_data'] = $allTripIn;
                                    $data_perDate['total_per_date'] = $perDate;
            
                                    $allDate[$all_date] = $data_perDate;
                                    $allData['route_name'] = $allRoute->route_name;
                                    $allData['data'] = $allDate;
                                    $route[$allRoute->route_number] = $allData;
                                    $data['allRoute'] = $route;
                                } elseif ($existInTrip == false && $existOutTrip == true) {
                                    $totalBusStopDate = $totalBusStopOut;
                                    $totalTravelDate = $totalTravelOut;
                                    $totalClaimDate = $totalClaimOut;
                                    $totalTravelGPSDate = $totalTravelGPSOut;
                                    $totalClaimGPSDate = $totalClaimGPSOut;
                                    $totalCountPassengerDate = $totalCountPassengerOut;
                                    $totalSalesDate = $totalSalesOut;
                                    $totalTotalDate = $totalTotalOut;
                                    $totalAdultDate = $totalAdultOut;
                                    $totalConcessionDate = $totalConcessionOut;
            
                                    $perDate['total_bus_stop_date'] = $totalBusStopDate;
                                    $perDate['total_travel_date'] = $totalTravelDate;
                                    $perDate['total_claim_date'] = $totalClaimDate;
                                    $perDate['total_travel_gps_date'] = $totalTravelGPSDate;
                                    $perDate['total_claim_gps_date'] = $totalClaimGPSDate;
                                    $perDate['total_count_passenger_date'] = $totalCountPassengerDate;
                                    $perDate['total_sales_date'] = $totalSalesDate;
                                    $perDate['total_total_date'] = $totalTotalDate;
                                    $perDate['total_adult_date'] = $totalAdultDate;
                                    $perDate['total_concession_date'] = $totalConcessionDate;
            
                                    $data_perDate['outbound_data'] = $allTripOut;
                                    $data_perDate['total_per_date'] = $perDate;
            
                                    $allDate[$all_date] = $data_perDate;
                                    $allData['route_name'] = $allRoute->route_name;
                                    $allData['data'] = $allDate;
                                    $route[$allRoute->route_number] = $allData;
                                    $data['allRoute'] = $route;
                                } else {
                                    $data_perDate['inbound_data'] = [];
                                    $data_perDate['outbound_data'] = [];
                                    $data_perDate['total_per_date'] = [];
            
                                    $allDate[$all_date] = $data_perDate;
                                    $allData['route_name'] = $allRoute->route_name;
                                    $allData['data'] = $allDate;
                                    $route[$allRoute->route_number] = $allData;
                                    $data['allRoute'] = $route;
                                }
            
                                $grandBusStop += $totalBusStopDate;
                                $grandTravel += $totalTravelDate;
                                $grandClaim += $totalClaimDate;
                                $grandTravelGPS += $totalTravelGPSDate;
                                $grandClaimGPS += $totalClaimGPSDate;
                                $grandCountPassenger += $totalCountPassengerDate;
                                $grandSale += $totalSalesDate;
                                $grandTotal += $totalTotalDate;
                                $grandTotalAdult+= $totalAdultDate;
                                $grandTotalConcession += $totalConcessionDate;
                            }
                        }
            
                        $grand['grand_bus_stop'] = $grandBusStop;
                        $grand['grand_travel'] = $grandTravel;
                        $grand['grand_claim'] = $grandClaim;
                        $grand['grand_travel_gps'] = $grandTravelGPS;
                        $grand['grand_claim_gps'] = $grandClaimGPS;
                        $grand['grand_count_passenger'] = $grandCountPassenger;
                        $grand['grand_sales'] = $grandSale;
                        $grand['grand_total'] = $grandTotal;
                        $grand['grand_adult'] = $grandTotalAdult;
                        $grand['grand_concession'] = $grandTotalConcession;
            
                        $data['grand'] = $grand;
                        $claimDetails->add($data);
                    }
                }
            }else{
                $companyDetails = Company::where('id', $this->selectedCompany)->first();
                $networkArea = $companyDetails->company_name;
                if($companyDetails->id==29){
                    $charge = 3.42;
                }else{
                    $charge = 1.33;
                }

                if(!empty($validatedData['route_id'])) {
                    //ClaimDetails all routes for specific company
                    if($validatedData['route_id']=='All'){
                        $allRouteCompanies = Route::where('company_id',$companyDetails->id)->where('status',1)->orderBy('route_number')->get();
            
                        foreach($allRouteCompanies as $allRouteCompany) {
                            foreach($all_dates as $all_date) {
                                $totalBusStopIn = 0;
                                $totalTravelIn = 0;
                                $totalClaimIn = 0;
                                $totalTravelGPSIn = 0;
                                $totalClaimGPSIn = 0;
                                $totalCountPassengerIn = 0;
                                $totalSalesIn = 0;
                                $totalTotalIn = 0;
                                $totalAdultIn = 0;
                                $totalConcessionIn = 0;
                                $allTripIn = [];
                                $allInbound = [];
                                $existInTrip = false;
                                $existOutTrip = false;
                                $firstDate = new Carbon($all_date);
                                $lastDate = new Carbon($all_date . '23:59:59');
            
                                //Inbound
                                $allTripInbounds = TripDetail::where('route_id', $allRouteCompany->id)
                                    ->whereBetween('start_trip', [$firstDate,$lastDate])
                                    ->where('trip_code', 1)
                                    ->get();
                                $routeNameIn = implode(" - ", array_reverse(explode(" - ", $allRouteCompany->route_name)));
                                if (count($allTripInbounds) > 0) {
                                    $existInTrip = true;
                                    $countIn = 0;
            
                                    foreach ($allTripInbounds as $allTripInbound) {
                                        $inbound['trip_type'] = "IB";
                                        $firstStage = Stage::where('route_id', $allTripInbound->route_id)->orderby('stage_order','DESC')->first();
                                        $inbound['start_point'] = $firstStage->stage_name;
                                        $inbound['trip_no'] = "T" . $allTripInbound->id;
                                        $inbound['rph_no'] = $allTripInbound->trip_number;
                                        
                                        if($allTripInbound->bus_id != NULL){
                                            $inbound['bus_plate_no'] = $allTripInbound->Bus->bus_registration_number;
                                            $inbound['bus_age'] = $allTripInbound->Bus->bus_age;
                                            //$inbound['bus_age'] = Carbon::parse($allTripInbound->Bus->bus_manufacturing_date)->diff(Carbon::now())->y;
                                        }else{
                                            $inbound['bus_plate_no'] = "No Data";
                                            $inbound['bus_age'] = "No Data";
                                        }
            
                                        $inbound['charge_km'] = $charge;
            
                                        if($allTripInbound->driver_id != NULL){
                                            $inbound['driver_id'] = $allTripInbound->BusDriver->driver_number;
                                        }else{
                                            $inbound['driver_id'] = "No Data";
                                        }
            
                                        //$busStop = BusStand::where('route_id', $allTripInbound->route_id)->count();
                                        $busStop = Stage::where('route_id', $allTripInbound->route_id)->count();
                                        $inbound['bus_stop_travel'] = $busStop;
                                        $totalBusStopIn += $busStop;
            
                                        $travel = $allTripInbound->Route->inbound_distance;
                                        $inbound['travel'] = $travel;
                                        $totalTravelIn += $travel;
            
                                        $claim = $charge * $travel;
                                        $inbound['claim'] = $claim;
                                        $totalClaimIn += $claim;
            
                                        $travelGPS = $allTripInbound->total_mileage;
                                        $inbound['travel_gps'] = $travelGPS;
                                        $totalTravelGPSIn += $travelGPS;
            
                                        $claimGPS = $charge * $travelGPS;
                                        $inbound['claim_gps'] = $claimGPS;
                                        $totalClaimGPSIn += $claimGPS;
            
                                        $inbound['status'] = "Complete";
                                        $inbound['travel_BOP'] = $travel;
                                        $inbound['claim_BOP'] = $claim;
            
                                        if($allTripInbound->route_schedule_mstr_id!=NULL){
                                            $inbound['service_start'] = Carbon::create($allTripInbound->RouteScheduleMSTR->schedule_start_time)->format('H:i');
                                            $inbound['service_end'] = Carbon::create($allTripInbound->RouteScheduleMSTR->schedule_end_time)->format('H:i');
                                        }else{
                                            $inbound['service_start'] = "No Data";
                                            $inbound['service_end'] = "No Data";
                                        }
                                        $inbound['start_point_time'] = $inbound['service_start'];
            
                                        $inbound['actual_start'] = date("H:i", strtotime($allTripInbound->start_trip));
                                        $inbound['actual_end'] = date("H:i", strtotime($allTripInbound->end_trip));
            
                                        //Check 1st sales
                                        $firstSales = TicketSalesTransaction::where('trip_number', $allTripInbound->trip_number)
                                            ->orderby('sales_date')
                                            ->first();
                                        if($firstSales){
                                            $inbound['sales_start'] = date("H:i", strtotime($firstSales->sales_date));
                                        }else{
                                            $inbound['sales_start'] = "No Sales";
                                        }
            
                                        //Check last sales
                                        $lastSales = TicketSalesTransaction::where('trip_number', $allTripInbound->trip_number)
                                            ->orderby('sales_date', 'DESC')
                                            ->first();
                                        if($lastSales){
                                            $inbound['sales_end'] = date("H:i", strtotime($lastSales->sales_date));
                                        }else{
                                            $inbound['sales_end'] = "No Sales";
                                        }
            
                                        if($inbound['service_start']!="No Data"){
                                            $diff = ((strtotime($inbound['service_start']) - strtotime($inbound['actual_start']))/60);
                                            if ($diff > 5 || $diff < -5) {
                                                $inbound['punctuality'] = "NOT PUNCTUAL";
                                            }else {
                                                $inbound['punctuality'] = "ONTIME";
                                            }
                                        }else{
                                            $inbound['punctuality'] = "No Data";
                                        }

                                        //Status
                                        //Check GPS
                                        $checkGPS = VehiclePosition::where('trip_id', $allTripInbound->trip_number)->first();
                                        if($checkGPS){
                                            //Check actual start & end
                                            if($inbound['actual_start']!="No Data" && $inbound['actual_end']!="No Data"){
                                                $diff = ((strtotime($inbound['actual_end']) - strtotime($inbound['actual_start']))/60);
                                                if ($diff < 5) {
                                                    $inbound['status'] = "Incomplete";
                                                    $inbound['status_desc'] = "Duplicate Trip";
                                                }else {
                                                    $inbound['status'] = "Complete";
                                                    $inbound['status_desc'] = " - ";
                                                }
                                            }else {
                                                $inbound['status'] = "Incomplete";
                                                $inbound['status_desc'] = "Outside Schedule";
                                            }
                                        }else{
                                            $inbound['status'] = "Incomplete";
                                            $inbound['status_desc'] = "No GPS Tracking";
                                        }
        
                                        $adult = $allTripInbound->total_adult;
                                        $concession = $allTripInbound->total_concession;
                                        $countPassenger = $adult + $concession;
                                        $sales = $allTripInbound->total_adult_amount + $allTripInbound->total_concession_amount;
                                        //Check tickets
                                        if($countPassenger==0 || $sales==0){
                                            $allTicketPerTrips = TicketSalesTransaction::where('trip_number', $allTripInbound->trip_number)->get();
                                            if(count($allTicketPerTrips)>0){
                                                $adult = 0;
                                                $concession = 0;
                                                $countPassenger = 0;
                                                $sales = 0;
                                                foreach($allTicketPerTrips as $allTicketPerTrip){
                                                    $sales += $allTicketPerTrip->actual_amount;
                                                    if($allTicketPerTrip->passenger_type==0){
                                                        $adult++;
                                                    }else{
                                                        $concession++;
                                                    }
                                                }
                                                $countPassenger = $adult + $concession;
                                            }
                                        }
                                        $inbound['pass_count'] = $countPassenger;
                                        $totalCountPassengerIn += $countPassenger;
            
                                        $inbound['total_sales'] = $sales;
                                        $totalSalesIn += $sales;
            
                                        $inbound['total_on'] = $countPassenger;
                                        $totalTotalIn += $countPassenger;
            
                                        $inbound['adult'] = $adult;
                                        $totalAdultIn += $adult;
            
                                        $inbound['concession'] = $concession;
                                        $totalConcessionIn += $concession;
            
                                        $allInbound[$countIn] = $inbound;
                                        $countIn++;
                                    }
                                    $allTripIn[$routeNameIn] = $allInbound;
                                    $totIn['total_bus_stop_in'] = $totalBusStopIn;
                                    $totIn['total_travel_in'] = $totalTravelIn;
                                    $totIn['total_claim_in'] = $totalClaimIn;
                                    $totIn['total_travel_gps_in'] = $totalTravelGPSIn;
                                    $totIn['total_claim_gps_in'] = $totalClaimGPSIn;
                                    $totIn['total_count_passenger_in'] = $totalCountPassengerIn;
                                    $totIn['total_sales_in'] = $totalSalesIn;
                                    $totIn['total_total_in'] = $totalTotalIn;
                                    $totIn['total_adult_in'] = $totalAdultIn;
                                    $totIn['total_concession_in'] = $totalConcessionIn;
                                    $allTripIn['total_inbound'] = $totIn;
                                }
            
                                $totalBusStopOut = 0;
                                $totalTravelOut = 0;
                                $totalClaimOut = 0;
                                $totalTravelGPSOut = 0;
                                $totalClaimGPSOut = 0;
                                $totalCountPassengerOut = 0;
                                $totalSalesOut = 0;
                                $totalTotalOut = 0;
                                $totalAdultOut = 0;
                                $totalConcessionOut = 0;
                                $allTripOut = [];
                                $allOutbound = [];
                                //Outbound
                                $allTripOutbounds = TripDetail::where('route_id', $allRouteCompany->id)
                                    ->whereBetween('start_trip', [$firstDate,$lastDate])
                                    ->where('trip_code', 0)
                                    ->get();
        
                                $routeNameOut = $allRouteCompany->route_name;
                                if (count($allTripOutbounds) > 0) {
                                    $existOutTrip = true;
                                    $countOut = 0;
            
                                    foreach ($allTripOutbounds as $allTripOutbound) {
                                        $outbound['trip_type'] = "OB";
                                        $firstStage = Stage::where('route_id', $allTripOutbound->route_id)->orderby('stage_order')->first();
                                        $outbound['start_point'] = $firstStage->stage_name;
                                        $outbound['trip_no'] = "T" . $allTripOutbound->id;
                                        $outbound['rph_no'] = $allTripOutbound->trip_number;
            
                                        if($allTripOutbound->bus_id != NULL){
                                            $outbound['bus_plate_no'] = $allTripOutbound->Bus->bus_registration_number;
                                            $outbound['bus_age'] = $allTripOutbound->Bus->bus_age;
                                            //$inbound['bus_age'] = Carbon::parse($allTripOutbound->Bus->bus_manufacturing_date)->diff(Carbon::now())->y;
                                        }else{
                                            $outbound['bus_plate_no']  = "No Data";
                                            $outbound['bus_age'] = "No Data";
                                        }
            
                                        $outbound['charge_km'] = $charge;
            
                                        if($allTripOutbound->driver_id != NULL){
                                            $outbound['driver_id'] = $allTripOutbound->BusDriver->driver_number;
                                        }else{
                                            $outbound['driver_id'] = "No Data";
                                        }
            
                                        //$busStop = BusStand::where('route_id', $allTripOutbound->route_id)->count();
                                        $busStop = Stage::where('route_id', $allTripOutbound->route_id)->count();
                                        $outbound['bus_stop_travel'] = $busStop;
                                        $totalBusStopOut += $busStop;
            
                                        $travel = $allTripOutbound->Route->inbound_distance;
                                        $outbound['travel'] = $travel;
                                        $totalTravelOut += $travel;
            
                                        $claim = $charge * $travel;
                                        $outbound['claim'] = $claim;
                                        $totalClaimOut += $claim;
            
                                        $travelGPS = $allTripOutbound->total_mileage;
                                        $outbound['travel_gps'] = $travelGPS;
                                        $totalTravelGPSOut += $travelGPS;
            
                                        $claimGPS = $charge * $travelGPS;
                                        $outbound['claim_gps'] = $claimGPS;
                                        $totalClaimGPSOut += $claimGPS;
            
                                        $outbound['status'] = "Complete";
                                        $outbound['travel_BOP'] = $travel;
                                        $outbound['claim_BOP'] = $claim;
            
                                        if($allTripOutbound->route_schedule_mstr_id!=NULL){
                                            $outbound['service_start'] = Carbon::create($allTripOutbound->RouteScheduleMSTR->schedule_start_time)->format('H:i');
                                            $outbound['service_end'] = Carbon::create($allTripOutbound->RouteScheduleMSTR->schedule_end_time)->format('H:i');
                                        }else{
                                            $outbound['service_start'] = "No Data";
                                            $outbound['service_end'] = "No Data";
                                        }
                                        $outbound['start_point_time'] = $outbound['service_start'];
            
                                        $outbound['actual_start'] = date("H:i", strtotime($allTripOutbound->start_trip));
                                        $outbound['actual_end'] = date("H:i", strtotime($allTripOutbound->end_trip));
            
                                        //Check 1st sales
                                        $firstSales = TicketSalesTransaction::where('trip_number', $allTripOutbound->trip_number)
                                            ->orderby('sales_date')
                                            ->first();
                                        if($firstSales){
                                            $outbound['sales_start'] = date("H:i", strtotime($firstSales->sales_date));
                                        }else{
                                            $outbound['sales_start'] = "No Sales";
                                        }
            
                                        //Check last sales
                                        $lastSales = TicketSalesTransaction::where('trip_number', $allTripOutbound->trip_number)
                                            ->orderby('sales_date', 'DESC')
                                            ->first();
                                        if($lastSales){
                                            $outbound['sales_end'] = date("H:i", strtotime($lastSales->sales_date));
                                        }else{
                                            $outbound['sales_end'] = "No Sales";
                                        }
            
                                        if($outbound['service_start']!="No Data"){
                                            $diff = ((strtotime($outbound['service_start']) - strtotime($outbound['actual_start']))/60);
                                            if ($diff > 5 || $diff < -5) {
                                                $outbound['punctuality'] = "NOT PUNCTUAL";
                                            } else {
                                                $outbound['punctuality'] = "ONTIME";
                                            }
                                        }else{
                                            $outbound['punctuality'] = "No Data";
                                        }
        
                                        //Status
                                        //Check GPS
                                        $checkGPS = VehiclePosition::where('trip_id', $allTripOutbound->trip_number)->first();
                                        if($checkGPS){
                                            //Check actual start & end
                                            if($outbound['actual_start']!="No Data" && $outbound['actual_end']!="No Data"){
                                                $diff = ((strtotime($outbound['actual_end']) - strtotime($outbound['actual_start']))/60);
                                                if ($diff < 5) {
                                                    $outbound['status'] = "Incomplete";
                                                    $outbound['status_desc'] = "Duplicate Trip";
                                                }else {
                                                    $outbound['status'] = "Complete";
                                                    $outbound['status_desc'] = " - ";
                                                }
                                            }else {
                                                $outbound['status'] = "Incomplete";
                                                $outbound['status_desc'] = "Outside Schedule";
                                            }
                                        }else{
                                            $outbound['status'] = "Incomplete";
                                            $outbound['status_desc'] = "No GPS Tracking";
                                        }

                                        $adult = $allTripOutbound->total_adult;
                                        $concession = $allTripOutbound->total_concession;
                                        $countPassenger = $adult + $concession;
                                        $sales = $allTripOutbound->total_adult_amount + $allTripOutbound->total_concession_amount;
                                        //Check tickets
                                        if($countPassenger==0 || $sales==0){
                                            $allTicketPerTrips = TicketSalesTransaction::where('trip_number', $allTripOutbound->trip_number)->get();
                                            if(count($allTicketPerTrips)>0){
                                                $adult = 0;
                                                $concession = 0;
                                                $countPassenger = 0;
                                                $sales = 0;
                                                foreach($allTicketPerTrips as $allTicketPerTrip){
                                                    $sales += $allTicketPerTrip->actual_amount;
                                                    if($allTicketPerTrip->passenger_type==0){
                                                        $adult++;
                                                    }else{
                                                        $concession++;
                                                    }
                                                }
                                                $countPassenger = $adult + $concession;
                                            }
                                        }
                                        $outbound['pass_count'] = $countPassenger;
                                        $totalCountPassengerOut += $countPassenger;
            
                                        $outbound['total_sales'] = $sales;
                                        $totalSalesOut += $sales;
            
                                        $outbound['total_on'] = $countPassenger;
                                        $totalTotalOut += $countPassenger;
                                        
                                        $outbound['adult'] = $adult;
                                        $totalAdultOut += $adult;
                                        
                                        $outbound['concession'] = $concession;
                                        $totalConcessionOut += $concession;
            
                                        $allOutbound[$countOut] = $outbound;
                                        $countOut++;
                                    }
                                    $allTripOut[$routeNameOut] = $allOutbound;
                                    $totOut['total_bus_stop_out'] = $totalBusStopOut;
                                    $totOut['total_travel_out'] = $totalTravelOut;
                                    $totOut['total_claim_out'] = $totalClaimOut;
                                    $totOut['total_travel_gps_out'] = $totalTravelGPSOut;
                                    $totOut['total_claim_gps_out'] = $totalClaimGPSOut;
                                    $totOut['total_count_passenger_out'] = $totalCountPassengerOut;
                                    $totOut['total_sales_out'] = $totalSalesOut;
                                    $totOut['total_total_out'] = $totalTotalOut;
                                    $totOut['total_adult_out'] = $totalAdultOut;
                                    $totOut['total_concession_out'] = $totalConcessionOut;
                                    $allTripOut['total_outbound'] = $totOut;
                                }
            
                                $totalBusStopDate = 0;
                                $totalTravelDate = 0;
                                $totalClaimDate = 0;
                                $totalTravelGPSDate = 0;
                                $totalClaimGPSDate = 0;
                                $totalCountPassengerDate = 0;
                                $totalSalesDate = 0;
                                $totalTotalDate = 0;
                                $totalAdultDate = 0;
                                $totalConcessionDate = 0;
                                $data_perDate = [];
                                if ($existInTrip == true && $existOutTrip == true) {
                                    $totalBusStopDate = $totalBusStopIn + $totalBusStopOut;
                                    $totalTravelDate = $totalTravelIn + $totalTravelOut;
                                    $totalClaimDate = $totalClaimIn + $totalClaimOut;
                                    $totalTravelGPSDate = $totalTravelGPSIn + $totalTravelGPSOut;
                                    $totalClaimGPSDate = $totalClaimGPSIn + $totalClaimGPSOut;
                                    $totalCountPassengerDate = $totalCountPassengerIn + $totalCountPassengerOut;
                                    $totalSalesDate = $totalSalesIn + $totalSalesOut;
                                    $totalTotalDate = $totalTotalIn + $totalTotalOut;
                                    $totalAdultDate = $totalAdultIn + $totalAdultOut;
                                    $totalConcessionDate = $totalConcessionIn + $totalConcessionOut;
            
                                    $perDate['total_bus_stop_date'] = $totalBusStopDate;
                                    $perDate['total_travel_date'] = $totalTravelDate;
                                    $perDate['total_claim_date'] = $totalClaimDate;
                                    $perDate['total_travel_gps_date'] = $totalTravelGPSDate;
                                    $perDate['total_claim_gps_date'] = $totalClaimGPSDate;
                                    $perDate['total_count_passenger_date'] = $totalCountPassengerDate;
                                    $perDate['total_sales_date'] = $totalSalesDate;
                                    $perDate['total_total_date'] = $totalTotalDate;
                                    $perDate['total_adult_date'] = $totalAdultDate;
                                    $perDate['total_concession_date'] = $totalConcessionDate;
            
                                    $data_perDate['inbound_data'] = $allTripIn;
                                    $data_perDate['outbound_data'] = $allTripOut;
                                    $data_perDate['total_per_date'] = $perDate;
            
                                    $allDate[$all_date] = $data_perDate;
                                    $allData['data'] = $allDate;
                                    $allData['route_name'] = $allRouteCompany->route_name;
                                    $route[$allRouteCompany->route_number] = $allData;
                                    $data['allRoute'] = $route;
        
                                } elseif ($existInTrip == true && $existOutTrip == false) {
                                    $totalBusStopDate = $totalBusStopIn;
                                    $totalTravelDate = $totalTravelIn;
                                    $totalClaimDate = $totalClaimIn;
                                    $totalTravelGPSDate = $totalTravelGPSIn;
                                    $totalClaimGPSDate = $totalClaimGPSIn;
                                    $totalCountPassengerDate = $totalCountPassengerIn;
                                    $totalSalesDate = $totalSalesIn;
                                    $totalTotalDate = $totalTotalIn;
                                    $totalAdultDate = $totalAdultIn;
                                    $totalConcessionDate = $totalConcessionIn;
            
                                    $perDate['total_bus_stop_date'] = $totalBusStopDate;
                                    $perDate['total_travel_date'] = $totalTravelDate;
                                    $perDate['total_claim_date'] = $totalClaimDate;
                                    $perDate['total_travel_gps_date'] = $totalTravelGPSDate;
                                    $perDate['total_claim_gps_date'] = $totalClaimGPSDate;
                                    $perDate['total_count_passenger_date'] = $totalCountPassengerDate;
                                    $perDate['total_sales_date'] = $totalSalesDate;
                                    $perDate['total_total_date'] = $totalTotalDate;
                                    $perDate['total_adult_date'] = $totalAdultDate;
                                    $perDate['total_concession_date'] = $totalConcessionDate;
            
                                    $data_perDate['inbound_data'] = $allTripIn;
                                    $data_perDate['total_per_date'] = $perDate;
            
                                    $allDate[$all_date] = $data_perDate;
                                    $allData['route_name'] = $allRouteCompany->route_name;
                                    $allData['data'] = $allDate;
                                    $route[$allRouteCompany->route_number] = $allData;
                                    $data['allRoute'] = $route;
        
                                } elseif ($existInTrip == false && $existOutTrip == true) {
                                    $totalBusStopDate = $totalBusStopOut;
                                    $totalTravelDate = $totalTravelOut;
                                    $totalClaimDate = $totalClaimOut;
                                    $totalTravelGPSDate = $totalTravelGPSOut;
                                    $totalClaimGPSDate = $totalClaimGPSOut;
                                    $totalCountPassengerDate = $totalCountPassengerOut;
                                    $totalSalesDate = $totalSalesOut;
                                    $totalTotalDate = $totalTotalOut;
                                    $totalAdultDate = $totalAdultOut;
                                    $totalConcessionDate = $totalConcessionOut;
            
                                    $perDate['total_bus_stop_date'] = $totalBusStopDate;
                                    $perDate['total_travel_date'] = $totalTravelDate;
                                    $perDate['total_claim_date'] = $totalClaimDate;
                                    $perDate['total_travel_gps_date'] = $totalTravelGPSDate;
                                    $perDate['total_claim_gps_date'] = $totalClaimGPSDate;
                                    $perDate['total_count_passenger_date'] = $totalCountPassengerDate;
                                    $perDate['total_sales_date'] = $totalSalesDate;
                                    $perDate['total_total_date'] = $totalTotalDate;
                                    $perDate['total_adult_date'] = $totalAdultDate;
                                    $perDate['total_concession_date'] = $totalConcessionDate;
            
                                    $data_perDate['outbound_data'] = $allTripOut;
                                    $data_perDate['total_per_date'] = $perDate;
            
                                    $allDate[$all_date] = $data_perDate;
                                    $allData['route_name'] = $allRouteCompany->route_name;
                                    $allData['data'] = $allDate;
                                    $route[$allRouteCompany->route_number] = $allData;
                                    $data['allRoute'] = $route;
        
                                } else {
                                    $data_perDate['inbound_data'] = [];
                                    $data_perDate['outbound_data'] = [];
                                    $data_perDate['total_per_date'] = [];
            
                                    $allDate[$all_date] = $data_perDate;
                                    $allData['route_name'] = $allRouteCompany->route_name;
                                    $allData['data'] = $allDate;
                                    $route[$allRouteCompany->route_number] = $allData;
                                    $data['allRoute'] = $route;
                                }
            
                                $grandBusStop += $totalBusStopDate;
                                $grandTravel += $totalTravelDate;
                                $grandClaim += $totalClaimDate;
                                $grandTravelGPS += $totalTravelGPSDate;
                                $grandClaimGPS += $totalClaimGPSDate;
                                $grandCountPassenger += $totalCountPassengerDate;
                                $grandSale += $totalSalesDate;
                                $grandTotal += $totalTotalDate;
                                $grandTotalAdult+= $totalAdultDate;
                                $grandTotalConcession += $totalConcessionDate;
                            }
                        }
            
                        $grand['grand_bus_stop'] = $grandBusStop;
                        $grand['grand_travel'] = $grandTravel;
                        $grand['grand_claim'] = $grandClaim;
                        $grand['grand_travel_gps'] = $grandTravelGPS;
                        $grand['grand_claim_gps'] = $grandClaimGPS;
                        $grand['grand_count_passenger'] = $grandCountPassenger;
                        $grand['grand_sales'] = $grandSale;
                        $grand['grand_total'] = $grandTotal;
                        $grand['grand_adult'] = $grandTotalAdult;
                        $grand['grand_concession'] = $grandTotalConcession;
            
                        $data['grand'] = $grand;
                        $claimDetails->add($data);
                    }
                    //ClaimDetails specific routes for specific company
                    else{
                        $selectedRoute = Route::where('id', $this->state['route_id'])->first();
        
                        if($selectedRoute){
                            foreach($all_dates as $all_date) {
                                $totalBusStopIn = 0;
                                $totalTravelIn = 0;
                                $totalClaimIn = 0;
                                $totalTravelGPSIn = 0;
                                $totalClaimGPSIn = 0;
                                $totalCountPassengerIn = 0;
                                $totalSalesIn = 0;
                                $totalTotalIn = 0;
                                $totalAdultIn = 0;
                                $totalConcessionIn = 0;
                                $allTripIn = [];
                                $allInbound = [];
                                $existInTrip = false;
                                $existOutTrip = false;
                                $firstDate = new Carbon($all_date);
                                $lastDate = new Carbon($all_date . '23:59:59');
            
                                //Inbound
                                $allTripInbounds = TripDetail::where('route_id', $selectedRoute->id)
                                    ->whereBetween('start_trip', [$firstDate,$lastDate])
                                    ->where('trip_code', 1)
                                    ->get();
                                $routeNameIn = implode(" - ", array_reverse(explode(" - ", $selectedRoute->route_name)));
                                if (count($allTripInbounds) > 0) {
                                    $existInTrip = true;
                                    $countIn = 0;
            
                                    foreach ($allTripInbounds as $allTripInbound) {
                                        $inbound['trip_type'] = "IB";
                                        $firstStage = Stage::where('route_id', $allTripInbound->route_id)->orderby('stage_order', 'DESC')->first();
                                        $inbound['start_point'] = $firstStage->stage_name;
                                        $inbound['trip_no'] = "T" . $allTripInbound->id;
                                        $inbound['rph_no'] = $allTripInbound->trip_number;
                                        
                                        if($allTripInbound->bus_id != NULL){
                                            $inbound['bus_plate_no'] = $allTripInbound->Bus->bus_registration_number;
                                            $inbound['bus_age'] = $allTripInbound->Bus->bus_age;
                                            //$inbound['bus_age'] = Carbon::parse($allTripInbound->Bus->bus_manufacturing_date)->diff(Carbon::now())->y;
                                        }else{
                                            $inbound['bus_plate_no'] = "No Data";
                                            $inbound['bus_age'] = "No Data";
                                        }
            
                                        $inbound['charge_km'] = $charge;
            
                                        if($allTripInbound->driver_id != NULL){
                                            $inbound['driver_id'] = $allTripInbound->BusDriver->driver_number;
                                        }else{
                                            $inbound['driver_id'] = "No Data";
                                        }
            
                                        //$busStop = BusStand::where('route_id', $allTripInbound->route_id)->count();
                                        $busStop = Stage::where('route_id', $allTripInbound->route_id)->count();
                                        $inbound['bus_stop_travel'] = $busStop;
                                        $totalBusStopIn += $busStop;
            
                                        $travel = $allTripInbound->Route->inbound_distance;
                                        $inbound['travel'] = $travel;
                                        $totalTravelIn += $travel;
            
                                        $claim = $charge * $travel;
                                        $inbound['claim'] = $claim;
                                        $totalClaimIn += $claim;
            
                                        $travelGPS = $allTripInbound->total_mileage;
                                        $inbound['travel_gps'] = $travelGPS;
                                        $totalTravelGPSIn += $travelGPS;
            
                                        $claimGPS = $charge * $travelGPS;
                                        $inbound['claim_gps'] = $claimGPS;
                                        $totalClaimGPSIn += $claimGPS;
            
                                        $inbound['status'] = "Complete";
                                        $inbound['travel_BOP'] = $travel;
                                        $inbound['claim_BOP'] = $claim;
            
                                        if($allTripInbound->route_schedule_mstr_id!=NULL){
                                            $inbound['service_start'] = Carbon::create($allTripInbound->RouteScheduleMSTR->schedule_start_time)->format('H:i');
                                            $inbound['service_end'] = Carbon::create($allTripInbound->RouteScheduleMSTR->schedule_end_time)->format('H:i');
                                        }else{
                                            $inbound['service_start'] = "No Data";
                                            $inbound['service_end'] = "No Data";
                                        }
                                        $inbound['start_point_time'] = $inbound['service_start'];
            
                                        $inbound['actual_start'] = date("H:i", strtotime($allTripInbound->start_trip));
                                        $inbound['actual_end'] = date("H:i", strtotime($allTripInbound->end_trip));
            
                                        //Check 1st sales
                                        $firstSales = TicketSalesTransaction::where('trip_number', $allTripInbound->trip_number)
                                            ->orderby('sales_date')
                                            ->first();
                                        if($firstSales){
                                            $inbound['sales_start'] = date("H:i", strtotime($firstSales->sales_date));
                                        }else{
                                            $inbound['sales_start'] = "No Sales";
                                        }
            
                                        //Check last sales
                                        $lastSales = TicketSalesTransaction::where('trip_number', $allTripInbound->trip_number)
                                            ->orderby('sales_date', 'DESC')
                                            ->first();
                                        if($lastSales){
                                            $inbound['sales_end'] = date("H:i", strtotime($lastSales->sales_date));
                                        }else{
                                            $inbound['sales_end'] = "No Sales";
                                        }
            
                                        if($inbound['service_start']!="No Data"){
                                            $diff = ((strtotime($inbound['service_start']) - strtotime($inbound['actual_start']))/60);
                                            if ($diff > 5 || $diff < -5) {
                                                $inbound['punctuality'] = "NOT PUNCTUAL";
                                            }else {
                                                $inbound['punctuality'] = "ONTIME";
                                            }
                                        }else{
                                            $inbound['punctuality'] = "No Data";
                                        }
        
                                        //Status
                                        //Check GPS
                                        $checkGPS = VehiclePosition::where('trip_id', $allTripInbound->trip_number)->first();
                                        if($checkGPS){
                                            //Check actual start & end
                                            if($inbound['actual_start']!="No Data" && $inbound['actual_end']!="No Data"){
                                                $diff = ((strtotime($inbound['actual_end']) - strtotime($inbound['actual_start']))/60);
                                                if ($diff < 5) {
                                                    $inbound['status'] = "Incomplete";
                                                    $inbound['status_desc'] = "Duplicate Trip";
                                                }else {
                                                    $inbound['status'] = "Complete";
                                                    $inbound['status_desc'] = " - ";
                                                }
                                            }else {
                                                $inbound['status'] = "Incomplete";
                                                $inbound['status_desc'] = "Outside Schedule";
                                            }
                                        }else{
                                            $inbound['status'] = "Incomplete";
                                            $inbound['status_desc'] = "No GPS Tracking";
                                        }
                                        
                                        $adult = $allTripInbound->total_adult;
                                        $concession = $allTripInbound->total_concession;
                                        $countPassenger = $adult + $concession;
                                        $sales = $allTripInbound->total_adult_amount + $allTripInbound->total_concession_amount;
                                        //Check tickets
                                        if($countPassenger==0 || $sales==0){
                                            $allTicketPerTrips = TicketSalesTransaction::where('trip_number', $allTripInbound->trip_number)->get();
                                            if(count($allTicketPerTrips)>0){
                                                $adult = 0;
                                                $concession = 0;
                                                $countPassenger = 0;
                                                $sales = 0;
                                                foreach($allTicketPerTrips as $allTicketPerTrip){
                                                    $sales += $allTicketPerTrip->actual_amount;
                                                    if($allTicketPerTrip->passenger_type==0){
                                                        $adult++;
                                                    }else{
                                                        $concession++;
                                                    }
                                                }
                                                $countPassenger = $adult + $concession;
                                            }
                                        }
                                        $inbound['pass_count'] = $countPassenger;
                                        $totalCountPassengerIn += $countPassenger;
            
                                        $inbound['total_sales'] = $sales;
                                        $totalSalesIn += $sales;
            
                                        $inbound['total_on'] = $countPassenger;
                                        $totalTotalIn += $countPassenger;
            
                                        $inbound['adult'] = $adult;
                                        $totalAdultIn += $adult;
            
                                        $inbound['concession'] = $concession;
                                        $totalConcessionIn += $concession;
            
                                        $allInbound[$countIn] = $inbound;
                                        $countIn++;
                                    }
                                    $allTripIn[$routeNameIn] = $allInbound;
                                    $totIn['total_bus_stop_in'] = $totalBusStopIn;
                                    $totIn['total_travel_in'] = $totalTravelIn;
                                    $totIn['total_claim_in'] = $totalClaimIn;
                                    $totIn['total_travel_gps_in'] = $totalTravelGPSIn;
                                    $totIn['total_claim_gps_in'] = $totalClaimGPSIn;
                                    $totIn['total_count_passenger_in'] = $totalCountPassengerIn;
                                    $totIn['total_sales_in'] = $totalSalesIn;
                                    $totIn['total_total_in'] = $totalTotalIn;
                                    $totIn['total_adult_in'] = $totalAdultIn;
                                    $totIn['total_concession_in'] = $totalConcessionIn;
                                    $allTripIn['total_inbound'] = $totIn;
                                }
            
                                $totalBusStopOut = 0;
                                $totalTravelOut = 0;
                                $totalClaimOut = 0;
                                $totalTravelGPSOut = 0;
                                $totalClaimGPSOut = 0;
                                $totalCountPassengerOut = 0;
                                $totalSalesOut = 0;
                                $totalTotalOut = 0;
                                $totalAdultOut = 0;
                                $totalConcessionOut = 0;
                                $allTripOut = [];
                                $allOutbound = [];
                                //Outbound
                                $allTripOutbounds = TripDetail::where('route_id', $selectedRoute->id)
                                    ->whereBetween('start_trip', [$firstDate,$lastDate])
                                    ->where('trip_code', 0)
                                    ->get();
                                $routeNameOut = $selectedRoute->route_name;
                                if (count($allTripOutbounds) > 0) {
                                    $existOutTrip = true;
                                    $countOut = 0;
            
                                    foreach ($allTripOutbounds as $allTripOutbound) {
                                        $outbound['trip_type'] = "OB";
                                        $firstStage = Stage::where('route_id', $allTripOutbound->route_id)->orderby('stage_order')->first();
                                        $outbound['start_point'] = $firstStage->stage_name;
                                        $outbound['trip_no'] = "T" . $allTripOutbound->id;
                                        $outbound['rph_no'] = $allTripOutbound->trip_number;
            
                                        if($allTripOutbound->bus_id != NULL){
                                            $outbound['bus_plate_no'] = $allTripOutbound->Bus->bus_registration_number;
                                            $outbound['bus_age'] = $allTripOutbound->Bus->bus_age;
                                            //$inbound['bus_age'] = Carbon::parse($allTripOutbound->Bus->bus_manufacturing_date)->diff(Carbon::now())->y;
                                        }else{
                                            $outbound['bus_plate_no']  = "No Data";
                                            $outbound['bus_age'] = "No Data";
                                        }
            
                                        $outbound['charge_km'] = $charge;
            
                                        if($allTripOutbound->driver_id != NULL){
                                            $outbound['driver_id'] = $allTripOutbound->BusDriver->driver_number;
                                        }else{
                                            $outbound['driver_id'] = "No Data";
                                        }
            
                                        //$busStop = BusStand::where('route_id', $allTripOutbound->route_id)->count();
                                        $busStop = Stage::where('route_id', $allTripOutbound->route_id)->count();
                                        $outbound['bus_stop_travel'] = $busStop;
                                        $totalBusStopOut += $busStop;
            
                                        $travel = $allTripOutbound->Route->inbound_distance;
                                        $outbound['travel'] = $travel;
                                        $totalTravelOut += $travel;
            
                                        $claim = $charge * $travel;
                                        $outbound['claim'] = $claim;
                                        $totalClaimOut += $claim;
            
                                        $travelGPS = $allTripOutbound->total_mileage;
                                        $outbound['travel_gps'] = $travelGPS;
                                        $totalTravelGPSOut += $travelGPS;
            
                                        $claimGPS = $charge * $travelGPS;
                                        $outbound['claim_gps'] = $claimGPS;
                                        $totalClaimGPSOut += $claimGPS;
            
                                        $outbound['status'] = "Complete";
                                        $outbound['travel_BOP'] = $travel;
                                        $outbound['claim_BOP'] = $claim;
            
                                        if($allTripOutbound->route_schedule_mstr_id!=NULL){
                                            $outbound['service_start'] = Carbon::create($allTripOutbound->RouteScheduleMSTR->schedule_start_time)->format('H:i');
                                            $outbound['service_end'] = Carbon::create($allTripOutbound->RouteScheduleMSTR->schedule_end_time)->format('H:i');
                                        }else{
                                            $outbound['service_start'] = "No Data";
                                            $outbound['service_end'] = "No Data";
                                        }
                                        $outbound['start_point_time'] = $outbound['service_start'];
            
                                        $outbound['actual_start'] = date("H:i", strtotime($allTripOutbound->start_trip));
                                        $outbound['actual_end'] = date("H:i", strtotime($allTripOutbound->end_trip));
            
                                        //Check 1st sales
                                        $firstSales = TicketSalesTransaction::where('trip_number',$allTripOutbound->trip_number)
                                            ->orderby('sales_date')
                                            ->first();
                                        if($firstSales){
                                            $outbound['sales_start'] = date("H:i", strtotime($firstSales->sales_date));
                                        }else{
                                            $outbound['sales_start'] = "No Sales";
                                        }
            
                                        //Check last sales
                                        $lastSales = TicketSalesTransaction::where('trip_number',$allTripOutbound->trip_number)
                                            ->orderby('sales_date', 'DESC')
                                            ->first();
                                        if($lastSales){
                                            $outbound['sales_end'] = date("H:i", strtotime($lastSales->sales_date));
                                        }else{
                                            $outbound['sales_end'] = "No Sales";
                                        }
            
                                        if($outbound['service_start']!="No Data"){
                                            $diff = ((strtotime($outbound['service_start']) - strtotime($outbound['actual_start']))/60);
                                            if ($diff > 5 || $diff < -5) {
                                                $outbound['punctuality'] = "NOT PUNCTUAL";
                                            } else {
                                                $outbound['punctuality'] = "ONTIME";
                                            }
                                        }else{
                                            $outbound['punctuality'] = "No Data";
                                        }

                                        //Status
                                        //Check GPS
                                        $checkGPS = VehiclePosition::where('trip_id', $allTripOutbound->trip_number)->first();
                                        if($checkGPS){
                                            //Check actual start & end
                                            if($outbound['actual_start']!="No Data" && $outbound['actual_end']!="No Data"){
                                                $diff = ((strtotime($outbound['actual_end']) - strtotime($outbound['actual_start']))/60);
                                                if ($diff < 5) {
                                                    $outbound['status'] = "Incomplete";
                                                    $outbound['status_desc'] = "Duplicate Trip";
                                                }else {
                                                    $outbound['status'] = "Complete";
                                                    $outbound['status_desc'] = " - ";
                                                }
                                            }else {
                                                $outbound['status'] = "Incomplete";
                                                $outbound['status_desc'] = "Outside Schedule";
                                            }
                                        }else{
                                            $outbound['status'] = "Incomplete";
                                            $outbound['status_desc'] = "No GPS Tracking";
                                        }
        
                                        $adult = $allTripOutbound->total_adult;
                                        $concession = $allTripOutbound->total_concession;
                                        $countPassenger = $adult + $concession;
                                        $sales = $allTripOutbound->total_adult_amount + $allTripOutbound->total_concession_amount;
                                        //Check tickets
                                        if($countPassenger==0 || $sales==0){
                                            $allTicketPerTrips = TicketSalesTransaction::where('trip_number',$allTripOutbound->trip_number)->get();
                                            if(count($allTicketPerTrips)>0){
                                                $adult = 0;
                                                $concession = 0;
                                                $countPassenger = 0;
                                                $sales = 0;
                                                foreach($allTicketPerTrips as $allTicketPerTrip){
                                                    $sales += $allTicketPerTrip->actual_amount;
                                                    if($allTicketPerTrip->passenger_type==0){
                                                        $adult++;
                                                    }else{
                                                        $concession++;
                                                    }
                                                }
                                                $countPassenger = $adult + $concession;
                                            }
                                        }
                                        $outbound['pass_count'] = $countPassenger;
                                        $totalCountPassengerOut += $countPassenger;
            
                                        $outbound['total_sales'] = $sales;
                                        $totalSalesOut += $sales;
            
                                        $outbound['total_on'] = $countPassenger;
                                        $totalTotalOut += $countPassenger;
                                        
                                        $outbound['adult'] = $adult;
                                        $totalAdultOut += $adult;
                                        
                                        $outbound['concession'] = $concession;
                                        $totalConcessionOut += $concession;
            
                                        $allOutbound[$countOut] = $outbound;
                                        $countOut++;
                                    }
                                    $allTripOut[$routeNameOut] = $allOutbound;
                                    $totOut['total_bus_stop_out'] = $totalBusStopOut;
                                    $totOut['total_travel_out'] = $totalTravelOut;
                                    $totOut['total_claim_out'] = $totalClaimOut;
                                    $totOut['total_travel_gps_out'] = $totalTravelGPSOut;
                                    $totOut['total_claim_gps_out'] = $totalClaimGPSOut;
                                    $totOut['total_count_passenger_out'] = $totalCountPassengerOut;
                                    $totOut['total_sales_out'] = $totalSalesOut;
                                    $totOut['total_total_out'] = $totalTotalOut;
                                    $totOut['total_adult_out'] = $totalAdultOut;
                                    $totOut['total_concession_out'] = $totalConcessionOut;
                                    $allTripOut['total_outbound'] = $totOut;
                                }
            
                                $totalBusStopDate = 0;
                                $totalTravelDate = 0;
                                $totalClaimDate = 0;
                                $totalTravelGPSDate = 0;
                                $totalClaimGPSDate = 0;
                                $totalCountPassengerDate = 0;
                                $totalSalesDate = 0;
                                $totalTotalDate = 0;
                                $totalAdultDate = 0;
                                $totalConcessionDate = 0;
                                $data_perDate = [];
                                if ($existInTrip == true && $existOutTrip == true) {
                                    $totalBusStopDate = $totalBusStopIn + $totalBusStopOut;
                                    $totalTravelDate = $totalTravelIn + $totalTravelOut;
                                    $totalClaimDate = $totalClaimIn + $totalClaimOut;
                                    $totalTravelGPSDate = $totalTravelGPSIn + $totalTravelGPSOut;
                                    $totalClaimGPSDate = $totalClaimGPSIn + $totalClaimGPSOut;
                                    $totalCountPassengerDate = $totalCountPassengerIn + $totalCountPassengerOut;
                                    $totalSalesDate = $totalSalesIn + $totalSalesOut;
                                    $totalTotalDate = $totalTotalIn + $totalTotalOut;
                                    $totalAdultDate = $totalAdultIn + $totalAdultOut;
                                    $totalConcessionDate = $totalConcessionIn + $totalConcessionOut;
            
                                    $perDate['total_bus_stop_date'] = $totalBusStopDate;
                                    $perDate['total_travel_date'] = $totalTravelDate;
                                    $perDate['total_claim_date'] = $totalClaimDate;
                                    $perDate['total_travel_gps_date'] = $totalTravelGPSDate;
                                    $perDate['total_claim_gps_date'] = $totalClaimGPSDate;
                                    $perDate['total_count_passenger_date'] = $totalCountPassengerDate;
                                    $perDate['total_sales_date'] = $totalSalesDate;
                                    $perDate['total_total_date'] = $totalTotalDate;
                                    $perDate['total_adult_date'] = $totalAdultDate;
                                    $perDate['total_concession_date'] = $totalConcessionDate;
            
                                    $data_perDate['inbound_data'] = $allTripIn;
                                    $data_perDate['outbound_data'] = $allTripOut;
                                    $data_perDate['total_per_date'] = $perDate;
            
                                    $allDate[$all_date] = $data_perDate;
                                    $allData['data'] = $allDate;
                                    $allData['route_name'] = $selectedRoute->route_name;
                                    $route[$selectedRoute->route_number] = $allData;
                                    $data['allRoute'] = $route;
                                } elseif ($existInTrip == true && $existOutTrip == false) {
                                    $totalBusStopDate = $totalBusStopIn;
                                    $totalTravelDate = $totalTravelIn;
                                    $totalClaimDate = $totalClaimIn;
                                    $totalTravelGPSDate = $totalTravelGPSIn;
                                    $totalClaimGPSDate = $totalClaimGPSIn;
                                    $totalCountPassengerDate = $totalCountPassengerIn;
                                    $totalSalesDate = $totalSalesIn;
                                    $totalTotalDate = $totalTotalIn;
                                    $totalAdultDate = $totalAdultIn;
                                    $totalConcessionDate = $totalConcessionIn;
            
                                    $perDate['total_bus_stop_date'] = $totalBusStopDate;
                                    $perDate['total_travel_date'] = $totalTravelDate;
                                    $perDate['total_claim_date'] = $totalClaimDate;
                                    $perDate['total_travel_gps_date'] = $totalTravelGPSDate;
                                    $perDate['total_claim_gps_date'] = $totalClaimGPSDate;
                                    $perDate['total_count_passenger_date'] = $totalCountPassengerDate;
                                    $perDate['total_sales_date'] = $totalSalesDate;
                                    $perDate['total_total_date'] = $totalTotalDate;
                                    $perDate['total_adult_date'] = $totalAdultDate;
                                    $perDate['total_concession_date'] = $totalConcessionDate;
            
                                    $data_perDate['inbound_data'] = $allTripIn;
                                    $data_perDate['total_per_date'] = $perDate;
            
                                    $allDate[$all_date] = $data_perDate;
                                    $allData['route_name'] = $selectedRoute->route_name;
                                    $allData['data'] = $allDate;
                                    $route[$selectedRoute->route_number] = $allData;
                                    $data['allRoute'] = $route;
                                } elseif ($existInTrip == false && $existOutTrip == true) {
                                    $totalBusStopDate = $totalBusStopOut;
                                    $totalTravelDate = $totalTravelOut;
                                    $totalClaimDate = $totalClaimOut;
                                    $totalTravelGPSDate = $totalTravelGPSOut;
                                    $totalClaimGPSDate = $totalClaimGPSOut;
                                    $totalCountPassengerDate = $totalCountPassengerOut;
                                    $totalSalesDate = $totalSalesOut;
                                    $totalTotalDate = $totalTotalOut;
                                    $totalAdultDate = $totalAdultOut;
                                    $totalConcessionDate = $totalConcessionOut;
            
                                    $perDate['total_bus_stop_date'] = $totalBusStopDate;
                                    $perDate['total_travel_date'] = $totalTravelDate;
                                    $perDate['total_claim_date'] = $totalClaimDate;
                                    $perDate['total_travel_gps_date'] = $totalTravelGPSDate;
                                    $perDate['total_claim_gps_date'] = $totalClaimGPSDate;
                                    $perDate['total_count_passenger_date'] = $totalCountPassengerDate;
                                    $perDate['total_sales_date'] = $totalSalesDate;
                                    $perDate['total_total_date'] = $totalTotalDate;
                                    $perDate['total_adult_date'] = $totalAdultDate;
                                    $perDate['total_concession_date'] = $totalConcessionDate;
            
                                    $data_perDate['outbound_data'] = $allTripOut;
                                    $data_perDate['total_per_date'] = $perDate;
            
                                    $allDate[$all_date] = $data_perDate;
                                    $allData['route_name'] = $selectedRoute->route_name;
                                    $allData['data'] = $allDate;
                                    $route[$selectedRoute->route_number] = $allData;
                                    $data['allRoute'] = $route;
                                } else {
                                    $data_perDate['inbound_data'] = [];
                                    $data_perDate['outbound_data'] = [];
                                    $data_perDate['total_per_date'] = [];
            
                                    $allDate[$all_date] = $data_perDate;
                                    $allData['route_name'] = $selectedRoute->route_name;
                                    $allData['data'] = $allDate;
                                    $route[$selectedRoute->route_number] = $allData;
                                    $data['allRoute'] = $route;
                                }
            
                                $grandBusStop += $totalBusStopDate;
                                $grandTravel += $totalTravelDate;
                                $grandClaim += $totalClaimDate;
                                $grandTravelGPS += $totalTravelGPSDate;
                                $grandClaimGPS += $totalClaimGPSDate;
                                $grandCountPassenger += $totalCountPassengerDate;
                                $grandSale += $totalSalesDate;
                                $grandTotal += $totalTotalDate;
                                $grandTotalAdult+= $totalAdultDate;
                                $grandTotalConcession += $totalConcessionDate;
                            }
                        }
            
                        $grand['grand_bus_stop'] = $grandBusStop;
                        $grand['grand_travel'] = $grandTravel;
                        $grand['grand_claim'] = $grandClaim;
                        $grand['grand_travel_gps'] = $grandTravelGPS;
                        $grand['grand_claim_gps'] = $grandClaimGPS;
                        $grand['grand_count_passenger'] = $grandCountPassenger;
                        $grand['grand_sales'] = $grandSale;
                        $grand['grand_total'] = $grandTotal;
                        $grand['grand_adult'] = $grandTotalAdult;
                        $grand['grand_concession'] = $grandTotalConcession;
            
                        $data['grand'] = $grand;
                        $claimDetails->add($data);
                    }
                }
            }
            return Excel::download(new SPADClaimDetails($claimDetails, $validatedData['dateFrom'], $validatedData['dateTo'], $networkArea), 'ClaimDetails_Report_SPAD_'.Carbon::now()->format('YmdHis').'.xlsx');
        }else{
            $this->dispatchBrowserEvent('company-required');
        }
    }

    public function printClaimDetailGPS()
    {
        $out = new ConsoleOutput();
        $out->writeln("YOU ARE IN printClaimDetails())");

        $validatedData = Validator::make($this->state,[
            'dateFrom' => ['required', 'date'],
            'dateTo' => ['required', 'date'],
            'route_id' => ['required'],
        ])->validate();

        if ($this->selectedCompany){
            $this->dispatchBrowserEvent('new-tab-gps',['dateFrom' => $validatedData['dateFrom'] , 'dateTo' => $validatedData['dateTo'] , 'routeID' => $validatedData['route_id'], 'companyID' => $this->selectedCompany]);

            //Redirect::to(route('viewClaimDetails', ['dateFrom' => $validatedData['dateFrom'] , 'dateTo' => $validatedData['dateTo'] , 'routeID' => $validatedData['route_id'], 'companyID' => $this->selectedCompany]));
            //return redirect()->route('viewClaimDetails', ['dateFrom' => $validatedData['dateFrom'] , 'dateTo' => $validatedData['dateTo'] , 'routeID' => $validatedData['route_id'], 'companyID' => $this->selectedCompany]);
        }else{
            $this->dispatchBrowserEvent('company-required');
        }
    }

    public function printClaimDetailGPSOld(){
        $out = new ConsoleOutput();
        $out->writeln("YOU ARE IN printClaimDetailGPS()");

        $validatedData = Validator::make($this->state,[
            'dateFrom' => ['required', 'date'],
            'dateTo' => ['required', 'date'],
            'route_id' => ['required'],
        ])->validate();

        $startDate = new Carbon($validatedData['dateFrom']);
        $endDate = new Carbon($validatedData['dateTo']);
        $all_dates = array();

        while ($startDate->lte($endDate)){
            $all_dates[] = $startDate->toDateString();
            $startDate->addDay();
        }

        $claimDetailGPSSPAD = collect();
        $companyArr = [];
        if ($this->selectedCompany){
            if($this->selectedCompany=='All'){
                $networkArea = 'All';
                if(!empty($validatedData['route_id'])) {
                    //Claim Details GPS all route all company
                    if($validatedData['route_id']=='All'){
                        $allCompanies = Company::all();
                        foreach($allCompanies as $allCompany){
                            $allRoutes = Route::where('company_id', $allCompany->id)->get();

                            $routeArr = [];
                            foreach ($allRoutes as $allRoute){
                                $routeNo = $allRoute->route_number;
                                $routeNameIn = $allRoute->route_name;

                                $allDate = [];
                                foreach ($all_dates as $all_date) {
                                    $firstDate = new Carbon($all_date);
                                    $lastDate = new Carbon($all_date . '23:59:59');

                                    $tripPerDates = TripDetail::where('route_id', $allRoute->id)
                                        ->whereBetween('start_trip', [$firstDate,$lastDate])
                                        ->get();

                                    $allTrip = [];
                                    if (count($tripPerDates) > 0) {
                                        foreach ($tripPerDates as $tripPerDate) {
                                            if ($tripPerDate->trip_code == 1) {
                                                $title = 'T' . $tripPerDate->id . ' - ' . $routeNo . '  ' . $routeNameIn . ' - IB - ' . $tripPerDate->start_trip;
                                            } else {
                                                $routeNameOut = implode(" - ", array_reverse(explode(" - ", $routeNameIn)));
                                                $title = 'T' . $tripPerDate->id . ' - ' . $routeNo . '  ' . $routeNameOut . ' - OB - ' . $tripPerDate->start_trip;
                                            }

                                            $vehiclePositions = VehiclePosition::where('trip_id', $tripPerDate->trip_number)->get();
                                            $i=1;
                                            $allGPS = [];
                                            $prevTime = 0;
                                            if (count($vehiclePositions) > 0) {
                                                foreach ($vehiclePositions as $vehiclePosition) {
                                                    $gps['bus_no'] = $vehiclePosition->Bus->bus_registration_number;
                                                    $gps['creation_date'] = $vehiclePosition->date_time;
                                                    $gps['speed'] = round($vehiclePosition->speed, 2);
                                                    $gps['longitude'] = $vehiclePosition->longitude;
                                                    $gps['latitude'] = $vehiclePosition->latitude;
                                                    $gps['pmhs_status'] = $vehiclePosition->phms_id;
                                                    $gps['pmhs_upload_date'] = $vehiclePosition->date_time;
                                                    if($i==1){
                                                        $gps['duration'] = 0;
                                                    }else{
                                                        $duration = strtotime($vehiclePosition->date_time) - $prevTime;
                                                        $gps['duration'] = $duration;
                                                    }
                                                    $prevTime = strtotime($vehiclePosition->date_time);

                                                    $allGPS[$i++] = $gps;
                                                }
                                            }
                                            $allTrip[$title] = $allGPS;
                                        }
                                    }
                                    $allDate[$all_date] = $allTrip;
                                }
                                $routeArr[$allRoute->route_name] = $allDate;
                            }
                            $companyArr[$allCompany->company_name] = $routeArr;
                        }
                        $claimDetailGPSSPAD->add($companyArr);
                    }
                }
            }else{
                $selectedCompany = Company::where('id', $this->selectedCompany)->first();
                $networkArea = $selectedCompany->company_name;

                if(!empty($validatedData['route_id'])) {
                     //Claim Details GPS all route specific company
                    if($validatedData['route_id']=='All'){
                        $allRoutes = Route::where('company_id', $selectedCompany->id)->get();

                        $routeArr = [];
                        foreach ($allRoutes as $allRoute){
                            $routeNo = $allRoute->route_number;
                            $routeNameIn = $allRoute->route_name;
        
                            $allDate = [];
                            foreach ($all_dates as $all_date) {
                                $firstDate = new Carbon($all_date);
                                $lastDate = new Carbon($all_date . '23:59:59');
        
                                $tripPerDates = TripDetail::where('route_id', $allRoute->id)
                                    ->whereBetween('start_trip', [$firstDate,$lastDate])
                                    ->get();
        
                                $allTrip = [];
                                if (count($tripPerDates) > 0) {
                                    foreach ($tripPerDates as $tripPerDate) {
                                        if ($tripPerDate->trip_code == 1) {
                                            $title = 'T' . $tripPerDate->id . ' - ' . $routeNo . '  ' . $routeNameIn . ' - IB - ' . $tripPerDate->start_trip;
                                        } else {
                                            $routeNameOut = implode(" - ", array_reverse(explode(" - ", $routeNameIn)));
                                            $title = 'T' . $tripPerDate->id . ' - ' . $routeNo . '  ' . $routeNameOut . ' - OB - ' . $tripPerDate->start_trip;
                                        }
        
                                        $vehiclePositions = VehiclePosition::where('trip_id', $tripPerDate->trip_number)->get();
                                        $i=1;
                                        $allGPS = [];
                                        $prevTime = 0;
                                        if (count($vehiclePositions) > 0) {
                                            foreach ($vehiclePositions as $vehiclePosition) {
                                                $gps['bus_no'] = $vehiclePosition->Bus->bus_registration_number;
                                                $gps['creation_date'] = $vehiclePosition->date_time;
                                                $gps['speed'] = round($vehiclePosition->speed, 2);
                                                $gps['longitude'] = $vehiclePosition->longitude;
                                                $gps['latitude'] = $vehiclePosition->latitude;
                                                $gps['pmhs_status'] = $vehiclePosition->phms_id;
                                                $gps['pmhs_upload_date'] = $vehiclePosition->date_time;
                                                if($i==1){
                                                    $gps['duration'] = 0;
                                                }else{
                                                    $duration = strtotime($vehiclePosition->date_time) - $prevTime;
                                                    $gps['duration'] = $duration;
                                                }
                                                $prevTime = strtotime($vehiclePosition->date_time);
        
                                                $allGPS[$i++] = $gps;
                                            }
                                        }
                                        $allTrip[$title] = $allGPS;
                                    }
                                }
                                $allDate[$all_date] = $allTrip;
                            }
                            $routeArr[$allRoute->route_name] = $allDate;
                        }
                        $companyArr[$selectedCompany->company_name] = $routeArr;
                        $claimDetailGPSSPAD->add($companyArr);
                    }
                    //Claim Details GPS specific route specific company
                    else{
                        $selectedRoute = Route::where('id', $validatedData['route_id'])->first();
                        $routeNo = $selectedRoute->route_number;
                        $routeNameIn = $selectedRoute->route_name;

                        $routeArr = [];
                        $allDate = [];
                        foreach ($all_dates as $all_date) {
                            $firstDate = new Carbon($all_date);
                            $lastDate = new Carbon($all_date . '23:59:59');

                            $tripPerDates = TripDetail::where('route_id', $selectedRoute->id)
                                ->whereBetween('start_trip', [$firstDate,$lastDate])
                                ->get();

                            $allTrip = [];
                            if (count($tripPerDates) > 0) {
                                foreach ($tripPerDates as $tripPerDate) {
                                    if ($tripPerDate->trip_code == 1) {
                                        $title = 'T' . $tripPerDate->id . ' - ' . $routeNo . '  ' . $routeNameIn . ' - IB - ' . $tripPerDate->start_trip;
                                    } else {
                                        $routeNameOut = implode(" - ", array_reverse(explode(" - ", $routeNameIn)));
                                        $title = 'T' . $tripPerDate->id . ' - ' . $routeNo . '  ' . $routeNameOut . ' - OB - ' . $tripPerDate->start_trip;
                                    }
                                    
                                    $vehiclePositions = VehiclePosition::where('trip_id', $tripPerDate->trip_number)->get();
                                    $i=1;
                                    $allGPS = [];
                                    $prevTime = 0;
                                    if (count($vehiclePositions) > 0) {
                                        foreach ($vehiclePositions as $vehiclePosition) {
                                            $gps['bus_no'] = $vehiclePosition->Bus->bus_registration_number;
                                            $gps['creation_date'] = $vehiclePosition->date_time;
                                            $gps['speed'] = round($vehiclePosition->speed, 2);
                                            $gps['longitude'] = $vehiclePosition->longitude;
                                            $gps['latitude'] = $vehiclePosition->latitude;
                                            $gps['pmhs_status'] = $vehiclePosition->phms_id;
                                            $gps['pmhs_upload_date'] = $vehiclePosition->date_time;
                                            if($i==1){
                                                $gps['duration'] = 0;
                                            }else{
                                                $duration = strtotime($vehiclePosition->date_time) - $prevTime;
                                                $gps['duration'] = $duration;
                                            }
                                            $prevTime = strtotime($vehiclePosition->date_time);

                                            $allGPS[$i++] = $gps;
                                        }
                                    }
                                    $allTrip[$title] = $allGPS;
                                }
                            }
                            $allDate[$all_date] = $allTrip;
                        }
                        $routeArr[$selectedRoute->route_name] = $allDate;
                        $companyArr[$selectedCompany->company_name] = $routeArr;
                        $claimDetailGPSSPAD->add($companyArr);
                    }
                }
            }
            return Excel::download(new SPADClaimDetailsGPS($networkArea, $claimDetailGPSSPAD, $validatedData['dateFrom'], $validatedData['dateTo']), 'ClaimDetailsGPS_Report_SPAD_'.Carbon::now()->format('YmdHis').'.xlsx');
        }else{
            $this->dispatchBrowserEvent('company-required');
        }
    }

    //FAST
    public function printClaimSummary(){
        $out = new ConsoleOutput();
        $out->writeln("YOU ARE IN printDailySummary()");

        $validatedData = Validator::make($this->state,[
            'dateFrom' => ['required', 'date'],
            'dateTo' => ['required', 'date'],
            'route_id' => ['required'],
        ])->validate();

        $dateFrom = new Carbon($validatedData['dateFrom']);
        $dateTo = new Carbon($validatedData['dateTo'] . " 23:59:59");
        $startDate = new Carbon($validatedData['dateFrom']);
        $endDate = new Carbon($validatedData['dateTo'] . " 23:59:59");
        $all_dates = array();
        
        while ($startDate->lte($endDate)) {
            $all_dates[] = $startDate->toDateString();
            $startDate->addDay();
        }

        if ($this->selectedCompany){
            if($this->selectedCompany=='All'){
                $networkArea = 'All';
                //Claim Summary all route all company
                if($validatedData['route_id']=='All'){

                    $allTrips = DB::select("SELECT trip_details.trip_code, route.route_number, 
                    (case when (trip_details.trip_code = 1) THEN CONCAT(SUBSTRING_INDEX(SUBSTRING_INDEX(route_name, '-', 2), '-', -1)
                    , ' - ', SUBSTRING_INDEX(SUBSTRING_INDEX(route_name, '-', 2), '-', 1)) ELSE route.route_name END) as route_name,
                    cast(trip_details.start_trip as date) as service_date,
                    (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                    SUM(trip_details.total_mileage) as km_served,
                    ROUND((case when (route.company_id = 29) THEN 3.42 * SUM(trip_details.total_mileage)
                    ELSE 1.33 * SUM(trip_details.total_mileage) END),2) as travel_claim
                    FROM mybas.trip_details
                    JOIN mybas.route ON route.id = trip_details.route_id
                    WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                    AND route.status = 1
                    GROUP BY route_number, service_date, route.id, trip_details.trip_code
                    ORDER BY route_number, service_date, trip_code;");

                    $plannedTrips = DB::select("SELECT route_scheduler_mstr.trip_code, route.route_number, route.route_name, cast(route_scheduler_details.schedule_date as date) as planned_date,
                    count(route_scheduler_details.id) as trip_planned, 
                    count(route_scheduler_details.id) * route.distance as km_planned
                    FROM mybas.route
                    JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                    JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                    WHERE route_scheduler_details.schedule_date BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                    AND route.status = 1
                    GROUP BY planned_date, route_number, route_scheduler_mstr.trip_code
                    ORDER BY route_number, planned_date;");

                    $lastKey = array_key_last($allTrips);
                    $pastRoute = "";
                    $pastDate = "";
                    $count = 0;
                    $totServedRoute = [];
                    $totPlannedRoute = [];
                    $totServedDate = [];
                    $totPlannedDate = [];
                    foreach($allTrips as $key => $allTrip){
                        $found = false;

                        //Enter total per date
                        if($allTrip->service_date!= $pastDate && $pastDate != NULL){
                            $out->writeln("Inside Splice Total Date Loop: " . $key . " - " . $allTrip->route_number . " - " . $allTrip->service_date . " ");
                            $out->writeln("up count: " . $count);

                            if($count==0){
                                array_splice($allTrips, $key, 0, $totServedDate);
                            }else{
                                $newKey = $key + $count;
                                $out->writeln("newKey: " . $newKey);
                                array_splice($allTrips, $newKey, 0, $totServedDate);
                            }
                            $count++;
                            $out->writeln("low count: " . $count);
                        }

                        //Enter total per route
                        if($allTrip->route_number!= $pastRoute && $pastRoute != NULL){
                            $out->writeln("Inside Splice Total Route Loop: " . $key . " - " . $allTrip->route_number . " - " . $allTrip->service_date . " ");
                            $out->writeln("up count: " . $count);

                            if($count==0){
                                array_splice($allTrips, $key, 0, $totServedRoute);
                            }else{
                                $newKey = $key + $count;
                                $out->writeln("newKey: " . $newKey);
                                array_splice($allTrips, $newKey, 0, $totServedRoute);
                            }
                            $count++;
                            $out->writeln("low count: " . $count);
                        }

                        foreach($plannedTrips as $key2 => $tripPlan){
                            if($tripPlan->route_number == $allTrip->route_number && 
                            $tripPlan->planned_date == $allTrip->service_date && 
                            $tripPlan->trip_code == $allTrip->trip_code){
                            
                                $allTrip->trip_planned = $tripPlan->trip_planned;
                                $allTrip->km_planned = $tripPlan->km_planned;

                                $found = true;
                                break ;
                            
                            }
                        }
                        if(!$found){
                            $allTrip->trip_planned = 0;
                            $allTrip->km_planned = 0;
                            $allTrip->missed_trip = 0;
                        }

                        $serviceDateFrom = new Carbon($allTrip->service_date);
                        $serviceDateTo = new Carbon($allTrip->service_date . " 23:59:59");

                        $totServedDate = DB::select("SELECT route.route_number, cast(trip_details.start_trip as date) as service_date,
                        (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                        SUM(trip_details.total_mileage) as km_served,
                        ROUND((case when (route.company_id = 29) THEN 3.42 * SUM(trip_details.total_mileage)
                        ELSE 1.33 * SUM(trip_details.total_mileage) END),2) as travel_claim
                        FROM mybas.trip_details
                        JOIN mybas.route ON route.id = trip_details.route_id
                        WHERE trip_details.start_trip BETWEEN '" . $serviceDateFrom . "' AND '" . $serviceDateTo . "'
                        AND route.route_number = '" . $allTrip->route_number . "'
                        GROUP BY route_number
                        ORDER BY route_number;");

                        $totPlannedDate = DB::select("SELECT route.route_number, cast(route_scheduler_details.schedule_date as date) as planned_date,
                        count(route_scheduler_details.id) as trip_planned, 
                        count(route_scheduler_details.id) * route.distance as km_planned
                        FROM mybas.route
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE route_scheduler_details.schedule_date BETWEEN '" . $serviceDateFrom . "' AND '" . $serviceDateTo . "'
                        AND route.route_number = '" . $allTrip->route_number . "'
                        GROUP BY planned_date, route_number
                        ORDER BY route_number, planned_date;");

                        $foundDate = false;
                        if($totServedDate){
                            foreach($totServedDate as $key3 => $totalTripServe){
                                
                                foreach($totPlannedDate as $key4 => $totalTripPlan){
                                    $totalTripServe->trip_planned = $totalTripPlan->trip_planned;
                                    $totalTripServe->km_planned = $totalTripPlan->km_planned;

                                    $foundDate = true;
                                    break ;
                                }
                                if(!$foundDate){
                                    $totalTripServe->trip_planned = 0;
                                    $totalTripServe->km_planned = 0;
                                }
                            }
                        }else{
                            $noTrip = new \stdClass;
                            $noTrip->route_number = $allTrip->route_number;
                            $noTrip->service_date = $allTrip->service_date;
                            $noTrip->trip_served = 0;
                            $noTrip->km_served = 0.00;
                            $noTrip->travel_claim = 0.00;
                            
                            foreach($totPlannedDate as $key5 => $totalTripPlan){
                                $noTrip->trip_planned = $totalTripPlan->trip_planned;
                                $noTrip->km_planned = $totalTripPlan->km_planned;

                                $foundDate = true;
                                break ;
                            }
                            if(!$foundDate){
                                $noTrip->trip_planned = 0;
                                $noTrip->km_planned = 0;
                            }
                            $totServedDate[] = $noTrip;
                        }

                        $totServedRoute = DB::select("SELECT route.route_number,
                        (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                        SUM(trip_details.total_mileage) as km_served,
                        ROUND((case when (route.company_id = 29) THEN 3.42 * SUM(trip_details.total_mileage)
                        ELSE 1.33 * SUM(trip_details.total_mileage) END),2) as travel_claim
                        FROM mybas.trip_details
                        JOIN mybas.route ON route.id = trip_details.route_id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND route.route_number = '" . $allTrip->route_number . "'
                        GROUP BY route_number
                        ORDER BY route_number;");

                        $totPlannedRoute = DB::select("SELECT route.route_number, 
                        count(route_scheduler_details.id) as trip_planned, 
                        count(route_scheduler_details.id) * route.distance as km_planned
                        FROM mybas.route
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE route_scheduler_details.schedule_date BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND route.route_number = '" . $allTrip->route_number . "'
                        GROUP BY route_number
                        ORDER BY route_number;");

                        $foundRoute = false;
                        if($totServedRoute){
                            foreach($totServedRoute as $key6 => $totalTripServe){
                                
                                foreach($totPlannedRoute as $key7 => $totalTripPlan){
                                    $totalTripServe->trip_planned = $totalTripPlan->trip_planned;
                                    $totalTripServe->km_planned = $totalTripPlan->km_planned;

                                    $foundRoute = true;
                                    break ;
                                }
                                if(!$foundRoute){
                                    $totalTripServe->trip_planned = 0;
                                    $totalTripServe->km_planned = 0;
                                }
                            }
                        }else{
                            $noTrip = new \stdClass;
                            $noTrip->route_number = $allTrip->route_number;
                            $noTrip->service_date = $allTrip->service_date;
                            $noTrip->trip_served = 0;
                            $noTrip->km_served = 0.00;
                            $noTrip->travel_claim = 0.00;
                            
                            foreach($totPlannedRoute as $key8 => $totalTripPlan){
                                $noTrip->trip_planned = $totalTripPlan->trip_planned;
                                $noTrip->km_planned = $totalTripPlan->km_planned;

                                $foundRoute = true;
                                break ;
                            }
                            if(!$foundRoute){
                                $noTrip->trip_planned = 0;
                                $noTrip->km_planned = 0;
                            }
                            $totServedRoute[] = $noTrip;
                        }

                        $pastRoute = $allTrip->route_number;
                        $pastDate = $allTrip->service_date;

                        if($lastKey==$key){
                            $grandTotServed = DB::select("SELECT 
                            (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                            SUM(trip_details.total_mileage) as km_served,
                            ROUND((case when (route.company_id = 29) THEN 3.42 * SUM(trip_details.total_mileage)
                            ELSE 1.33 * SUM(trip_details.total_mileage) END),2) as travel_claim
                            FROM mybas.trip_details
                            JOIN mybas.route ON route.id = trip_details.route_id
                            WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND route.status = 1;");

                            $grandTotPlanned = DB::select("SELECT 
                            count(route_scheduler_details.id) as trip_planned, 
                            count(route_scheduler_details.id) * route.distance as km_planned
                            FROM mybas.route
                            JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                            JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                            WHERE route_scheduler_details.schedule_date BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND route.status = 1;");

                            foreach($grandTotServed as $grandKey => $grandServed){
                                $foundRoute = false;
                                foreach($grandTotPlanned as $key9 => $grandPlanned){
                                    $grandServed->trip_planned = $grandPlanned->trip_planned;
                                    $grandServed->km_planned = $grandPlanned->km_planned;
                                }
                            }

                            $newKey = $key + $count+1;
                            $out->writeln("last newKey: " . $newKey);
                            array_splice($allTrips, $newKey, 0, $grandTotServed);
                            array_splice($allTrips, $newKey, 0, $totServedRoute);
                            array_splice($allTrips, $newKey, 0, $totServedDate);
                        }
                    }

                }
            }else{
                $companyDetails = Company::where('id', $this->selectedCompany)->first();
                $networkArea = $companyDetails->company_name;
                if($validatedData['route_id']=='All'){

                    $allTrips = DB::select("SELECT trip_details.trip_code, route.route_number, 
                    (case when (trip_details.trip_code = 1) THEN CONCAT(SUBSTRING_INDEX(SUBSTRING_INDEX(route_name, '-', 2), '-', -1)
                    , ' - ', SUBSTRING_INDEX(SUBSTRING_INDEX(route_name, '-', 2), '-', 1)) ELSE route.route_name END) as route_name,
                    cast(trip_details.start_trip as date) as service_date,
                    (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                    SUM(trip_details.total_mileage) as km_served,
                    ROUND((case when (route.company_id = 29) THEN 3.42 * SUM(trip_details.total_mileage)
                    ELSE 1.33 * SUM(trip_details.total_mileage) END),2) as travel_claim
                    FROM mybas.trip_details
                    JOIN mybas.route ON route.id = trip_details.route_id
                    WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                    AND route.status = 1
                    AND route.company_id = '" . $companyDetails->id . "'
                    GROUP BY route_number, service_date, route.id, trip_details.trip_code
                    ORDER BY route_number, service_date, trip_code;");

                    $plannedTrips = DB::select("SELECT route_scheduler_mstr.trip_code, route.route_number, route.route_name, cast(route_scheduler_details.schedule_date as date) as planned_date,
                    count(route_scheduler_details.id) as trip_planned, 
                    count(route_scheduler_details.id) * route.distance as km_planned
                    FROM mybas.route
                    JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                    JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                    WHERE route_scheduler_details.schedule_date BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                    AND route.status = 1
                    AND route.company_id = '" . $companyDetails->id . "'
                    GROUP BY planned_date, route_number, route_scheduler_mstr.trip_code
                    ORDER BY route_number, planned_date;");

                    $lastKey = array_key_last($allTrips);
                    $pastRoute = "";
                    $pastDate = "";
                    $count = 0;
                    $totServedRoute = [];
                    $totPlannedRoute = [];
                    $totServedDate = [];
                    $totPlannedDate = [];
                    foreach($allTrips as $key => $allTrip){
                        $found = false;

                        //Enter total per date
                        if($allTrip->service_date!= $pastDate && $pastDate != NULL){
                            $out->writeln("Inside Splice Total Date Loop: " . $key . " - " . $allTrip->route_number . " - " . $allTrip->service_date . " ");
                            $out->writeln("up count: " . $count);

                            if($count==0){
                                array_splice($allTrips, $key, 0, $totServedDate);
                            }else{
                                $newKey = $key + $count;
                                $out->writeln("newKey: " . $newKey);
                                array_splice($allTrips, $newKey, 0, $totServedDate);
                            }
                            $count++;
                            $out->writeln("low count: " . $count);
                        }

                        //Enter total per route
                        if($allTrip->route_number!= $pastRoute && $pastRoute != NULL){
                            $out->writeln("Inside Splice Total Route Loop: " . $key . " - " . $allTrip->route_number . " - " . $allTrip->service_date . " ");
                            $out->writeln("up count: " . $count);

                            if($count==0){
                                array_splice($allTrips, $key, 0, $totServedRoute);
                            }else{
                                $newKey = $key + $count;
                                $out->writeln("newKey: " . $newKey);
                                array_splice($allTrips, $newKey, 0, $totServedRoute);
                            }
                            $count++;
                            $out->writeln("low count: " . $count);
                        }

                        foreach($plannedTrips as $key2 => $tripPlan){
                            if($tripPlan->route_number == $allTrip->route_number && 
                            $tripPlan->planned_date == $allTrip->service_date && 
                            $tripPlan->trip_code == $allTrip->trip_code){
                            
                                $allTrip->trip_planned = $tripPlan->trip_planned;
                                $allTrip->km_planned = $tripPlan->km_planned;

                                $found = true;
                                break ;
                            
                            }
                        }
                        if(!$found){
                            $allTrip->trip_planned = 0;
                            $allTrip->km_planned = 0;
                            $allTrip->missed_trip = 0;
                        }

                        $serviceDateFrom = new Carbon($allTrip->service_date);
                        $serviceDateTo = new Carbon($allTrip->service_date . " 23:59:59");

                        $totServedDate = DB::select("SELECT route.route_number, cast(trip_details.start_trip as date) as service_date,
                        (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                        SUM(trip_details.total_mileage) as km_served,
                        ROUND((case when (route.company_id = 29) THEN 3.42 * SUM(trip_details.total_mileage)
                        ELSE 1.33 * SUM(trip_details.total_mileage) END),2) as travel_claim
                        FROM mybas.trip_details
                        JOIN mybas.route ON route.id = trip_details.route_id
                        WHERE trip_details.start_trip BETWEEN '" . $serviceDateFrom . "' AND '" . $serviceDateTo . "'
                        AND route.route_number = '" . $allTrip->route_number . "'
                        GROUP BY route_number
                        ORDER BY route_number;");

                        $totPlannedDate = DB::select("SELECT route.route_number, cast(route_scheduler_details.schedule_date as date) as planned_date,
                        count(route_scheduler_details.id) as trip_planned, 
                        count(route_scheduler_details.id) * route.distance as km_planned
                        FROM mybas.route
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE route_scheduler_details.schedule_date BETWEEN '" . $serviceDateFrom . "' AND '" . $serviceDateTo . "'
                        AND route.route_number = '" . $allTrip->route_number . "'
                        GROUP BY planned_date, route_number
                        ORDER BY route_number, planned_date;");

                        $foundDate = false;
                        if($totServedDate){
                            foreach($totServedDate as $key3 => $totalTripServe){
                                
                                foreach($totPlannedDate as $key4 => $totalTripPlan){
                                    $totalTripServe->trip_planned = $totalTripPlan->trip_planned;
                                    $totalTripServe->km_planned = $totalTripPlan->km_planned;

                                    $foundDate = true;
                                    break ;
                                }
                                if(!$foundDate){
                                    $totalTripServe->trip_planned = 0;
                                    $totalTripServe->km_planned = 0;
                                }
                            }
                        }else{
                            $noTrip = new \stdClass;
                            $noTrip->route_number = $allTrip->route_number;
                            $noTrip->service_date = $allTrip->service_date;
                            $noTrip->trip_served = 0;
                            $noTrip->km_served = 0.00;
                            $noTrip->travel_claim = 0.00;
                            
                            foreach($totPlannedDate as $key5 => $totalTripPlan){
                                $noTrip->trip_planned = $totalTripPlan->trip_planned;
                                $noTrip->km_planned = $totalTripPlan->km_planned;

                                $foundDate = true;
                                break ;
                            }
                            if(!$foundDate){
                                $noTrip->trip_planned = 0;
                                $noTrip->km_planned = 0;
                            }
                            $totServedDate[] = $noTrip;
                        }

                        $totServedRoute = DB::select("SELECT route.route_number,
                        (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                        SUM(trip_details.total_mileage) as km_served,
                        ROUND((case when (route.company_id = 29) THEN 3.42 * SUM(trip_details.total_mileage)
                        ELSE 1.33 * SUM(trip_details.total_mileage) END),2) as travel_claim
                        FROM mybas.trip_details
                        JOIN mybas.route ON route.id = trip_details.route_id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND route.route_number = '" . $allTrip->route_number . "'
                        GROUP BY route_number
                        ORDER BY route_number;");

                        $totPlannedRoute = DB::select("SELECT route.route_number, 
                        count(route_scheduler_details.id) as trip_planned, 
                        count(route_scheduler_details.id) * route.distance as km_planned
                        FROM mybas.route
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE route_scheduler_details.schedule_date BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND route.route_number = '" . $allTrip->route_number . "'
                        GROUP BY route_number
                        ORDER BY route_number;");

                        $foundRoute = false;
                        if($totServedRoute){
                            foreach($totServedRoute as $key6 => $totalTripServe){
                                
                                foreach($totPlannedRoute as $key7 => $totalTripPlan){
                                    $totalTripServe->trip_planned = $totalTripPlan->trip_planned;
                                    $totalTripServe->km_planned = $totalTripPlan->km_planned;

                                    $foundRoute = true;
                                    break ;
                                }
                                if(!$foundRoute){
                                    $totalTripServe->trip_planned = 0;
                                    $totalTripServe->km_planned = 0;
                                }
                            }
                        }else{
                            $noTrip = new \stdClass;
                            $noTrip->route_number = $allTrip->route_number;
                            $noTrip->service_date = $allTrip->service_date;
                            $noTrip->trip_served = 0;
                            $noTrip->km_served = 0.00;
                            $noTrip->travel_claim = 0.00;
                            
                            foreach($totPlannedRoute as $key8 => $totalTripPlan){
                                $noTrip->trip_planned = $totalTripPlan->trip_planned;
                                $noTrip->km_planned = $totalTripPlan->km_planned;

                                $foundRoute = true;
                                break ;
                            }
                            if(!$foundRoute){
                                $noTrip->trip_planned = 0;
                                $noTrip->km_planned = 0;
                            }
                            $totServedRoute[] = $noTrip;
                        }

                        $pastRoute = $allTrip->route_number;
                        $pastDate = $allTrip->service_date;

                        if($lastKey==$key){
                            $grandTotServed = DB::select("SELECT 
                            (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                            SUM(trip_details.total_mileage) as km_served,
                            ROUND((case when (route.company_id = 29) THEN 3.42 * SUM(trip_details.total_mileage)
                            ELSE 1.33 * SUM(trip_details.total_mileage) END),2) as travel_claim
                            FROM mybas.trip_details
                            JOIN mybas.route ON route.id = trip_details.route_id
                            WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND route.status = 1
                            AND route.company_id = '" . $companyDetails->id . "';");

                            $grandTotPlanned = DB::select("SELECT 
                            count(route_scheduler_details.id) as trip_planned, 
                            count(route_scheduler_details.id) * route.distance as km_planned
                            FROM mybas.route
                            JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                            JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                            WHERE route_scheduler_details.schedule_date BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND route.status = 1
                            AND route.company_id = '" . $companyDetails->id . "';");

                            foreach($grandTotServed as $grandKey => $grandServed){
                                $foundRoute = false;
                                foreach($grandTotPlanned as $key9 => $grandPlanned){
                                    $grandServed->trip_planned = $grandPlanned->trip_planned;
                                    $grandServed->km_planned = $grandPlanned->km_planned;
                                }
                            }

                            $newKey = $key + $count+1;
                            $out->writeln("last newKey: " . $newKey);
                            array_splice($allTrips, $newKey, 0, $grandTotServed);
                            array_splice($allTrips, $newKey, 0, $totServedRoute);
                            array_splice($allTrips, $newKey, 0, $totServedDate);
                        }
                    }

                }
                else{

                    $allTrips = DB::select("SELECT trip_details.trip_code, route.route_number, 
                    (case when (trip_details.trip_code = 1) THEN CONCAT(SUBSTRING_INDEX(SUBSTRING_INDEX(route_name, '-', 2), '-', -1)
                    , ' - ', SUBSTRING_INDEX(SUBSTRING_INDEX(route_name, '-', 2), '-', 1)) ELSE route.route_name END) as route_name,
                    cast(trip_details.start_trip as date) as service_date,
                    (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                    SUM(trip_details.total_mileage) as km_served,
                    ROUND((case when (route.company_id = 29) THEN 3.42 * SUM(trip_details.total_mileage)
                    ELSE 1.33 * SUM(trip_details.total_mileage) END),2) as travel_claim
                    FROM mybas.trip_details
                    JOIN mybas.route ON route.id = trip_details.route_id
                    WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                    AND route.status = 1
                    AND route.id = '" . $validatedData['route_id'] . "'
                    GROUP BY route_number, service_date, route.id, trip_details.trip_code
                    ORDER BY route_number, service_date, trip_code;");

                    $plannedTrips = DB::select("SELECT route_scheduler_mstr.trip_code, route.route_number, route.route_name, cast(route_scheduler_details.schedule_date as date) as planned_date,
                    count(route_scheduler_details.id) as trip_planned, 
                    count(route_scheduler_details.id) * route.distance as km_planned
                    FROM mybas.route
                    JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                    JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                    WHERE route_scheduler_details.schedule_date BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                    AND route.status = 1
                    AND route.id = '" . $validatedData['route_id'] . "'
                    GROUP BY planned_date, route_number, route_scheduler_mstr.trip_code
                    ORDER BY route_number, planned_date;");

                    $lastKey = array_key_last($allTrips);
                    $pastRoute = "";
                    $pastDate = "";
                    $count = 0;
                    $totServedRoute = [];
                    $totPlannedRoute = [];
                    $totServedDate = [];
                    $totPlannedDate = [];
                    foreach($allTrips as $key => $allTrip){
                        $found = false;

                        //Enter total per date
                        if($allTrip->service_date!= $pastDate && $pastDate != NULL){
                            $out->writeln("Inside Splice Total Date Loop: " . $key . " - " . $allTrip->route_number . " - " . $allTrip->service_date . " ");
                            $out->writeln("up count: " . $count);

                            if($count==0){
                                array_splice($allTrips, $key, 0, $totServedDate);
                            }else{
                                $newKey = $key + $count;
                                $out->writeln("newKey: " . $newKey);
                                array_splice($allTrips, $newKey, 0, $totServedDate);
                            }
                            $count++;
                            $out->writeln("low count: " . $count);
                        }

                        //Enter total per route
                        if($allTrip->route_number!= $pastRoute && $pastRoute != NULL){
                            $out->writeln("Inside Splice Total Route Loop: " . $key . " - " . $allTrip->route_number . " - " . $allTrip->service_date . " ");
                            $out->writeln("up count: " . $count);

                            if($count==0){
                                array_splice($allTrips, $key, 0, $totServedRoute);
                            }else{
                                $newKey = $key + $count;
                                $out->writeln("newKey: " . $newKey);
                                array_splice($allTrips, $newKey, 0, $totServedRoute);
                            }
                            $count++;
                            $out->writeln("low count: " . $count);
                        }

                        foreach($plannedTrips as $key2 => $tripPlan){
                            if($tripPlan->route_number == $allTrip->route_number && 
                            $tripPlan->planned_date == $allTrip->service_date && 
                            $tripPlan->trip_code == $allTrip->trip_code){
                            
                                $allTrip->trip_planned = $tripPlan->trip_planned;
                                $allTrip->km_planned = $tripPlan->km_planned;

                                $found = true;
                                break ;
                            
                            }
                        }
                        if(!$found){
                            $allTrip->trip_planned = 0;
                            $allTrip->km_planned = 0;
                            $allTrip->missed_trip = 0;
                        }

                        $serviceDateFrom = new Carbon($allTrip->service_date);
                        $serviceDateTo = new Carbon($allTrip->service_date . " 23:59:59");

                        $totServedDate = DB::select("SELECT route.route_number, cast(trip_details.start_trip as date) as service_date,
                        (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                        SUM(trip_details.total_mileage) as km_served,
                        ROUND((case when (route.company_id = 29) THEN 3.42 * SUM(trip_details.total_mileage)
                        ELSE 1.33 * SUM(trip_details.total_mileage) END),2) as travel_claim
                        FROM mybas.trip_details
                        JOIN mybas.route ON route.id = trip_details.route_id
                        WHERE trip_details.start_trip BETWEEN '" . $serviceDateFrom . "' AND '" . $serviceDateTo . "'
                        AND route.route_number = '" . $allTrip->route_number . "'
                        GROUP BY route_number
                        ORDER BY route_number;");

                        $totPlannedDate = DB::select("SELECT route.route_number, cast(route_scheduler_details.schedule_date as date) as planned_date,
                        count(route_scheduler_details.id) as trip_planned, 
                        count(route_scheduler_details.id) * route.distance as km_planned
                        FROM mybas.route
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE route_scheduler_details.schedule_date BETWEEN '" . $serviceDateFrom . "' AND '" . $serviceDateTo . "'
                        AND route.route_number = '" . $allTrip->route_number . "'
                        GROUP BY planned_date, route_number
                        ORDER BY route_number, planned_date;");

                        $foundDate = false;
                        if($totServedDate){
                            foreach($totServedDate as $key3 => $totalTripServe){
                                
                                foreach($totPlannedDate as $key4 => $totalTripPlan){
                                    $totalTripServe->trip_planned = $totalTripPlan->trip_planned;
                                    $totalTripServe->km_planned = $totalTripPlan->km_planned;

                                    $foundDate = true;
                                    break ;
                                }
                                if(!$foundDate){
                                    $totalTripServe->trip_planned = 0;
                                    $totalTripServe->km_planned = 0;
                                }
                            }
                        }else{
                            $noTrip = new \stdClass;
                            $noTrip->route_number = $allTrip->route_number;
                            $noTrip->service_date = $allTrip->service_date;
                            $noTrip->trip_served = 0;
                            $noTrip->km_served = 0.00;
                            $noTrip->travel_claim = 0.00;
                            
                            foreach($totPlannedDate as $key5 => $totalTripPlan){
                                $noTrip->trip_planned = $totalTripPlan->trip_planned;
                                $noTrip->km_planned = $totalTripPlan->km_planned;

                                $foundDate = true;
                                break ;
                            }
                            if(!$foundDate){
                                $noTrip->trip_planned = 0;
                                $noTrip->km_planned = 0;
                            }
                            $totServedDate[] = $noTrip;
                        }

                        $totServedRoute = DB::select("SELECT route.route_number,
                        (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                        SUM(trip_details.total_mileage) as km_served,
                        ROUND((case when (route.company_id = 29) THEN 3.42 * SUM(trip_details.total_mileage)
                        ELSE 1.33 * SUM(trip_details.total_mileage) END),2) as travel_claim
                        FROM mybas.trip_details
                        JOIN mybas.route ON route.id = trip_details.route_id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND route.route_number = '" . $allTrip->route_number . "'
                        GROUP BY route_number
                        ORDER BY route_number;");

                        $totPlannedRoute = DB::select("SELECT route.route_number, 
                        count(route_scheduler_details.id) as trip_planned, 
                        count(route_scheduler_details.id) * route.distance as km_planned
                        FROM mybas.route
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE route_scheduler_details.schedule_date BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND route.route_number = '" . $allTrip->route_number . "'
                        GROUP BY route_number
                        ORDER BY route_number;");

                        $foundRoute = false;
                        if($totServedRoute){
                            foreach($totServedRoute as $key6 => $totalTripServe){
                                
                                foreach($totPlannedRoute as $key7 => $totalTripPlan){
                                    $totalTripServe->trip_planned = $totalTripPlan->trip_planned;
                                    $totalTripServe->km_planned = $totalTripPlan->km_planned;

                                    $foundRoute = true;
                                    break ;
                                }
                                if(!$foundRoute){
                                    $totalTripServe->trip_planned = 0;
                                    $totalTripServe->km_planned = 0;
                                }
                            }
                        }else{
                            $noTrip = new \stdClass;
                            $noTrip->route_number = $allTrip->route_number;
                            $noTrip->service_date = $allTrip->service_date;
                            $noTrip->trip_served = 0;
                            $noTrip->km_served = 0.00;
                            $noTrip->travel_claim = 0.00;
                            
                            foreach($totPlannedRoute as $key8 => $totalTripPlan){
                                $noTrip->trip_planned = $totalTripPlan->trip_planned;
                                $noTrip->km_planned = $totalTripPlan->km_planned;

                                $foundRoute = true;
                                break ;
                            }
                            if(!$foundRoute){
                                $noTrip->trip_planned = 0;
                                $noTrip->km_planned = 0;
                            }
                            $totServedRoute[] = $noTrip;
                        }

                        $pastRoute = $allTrip->route_number;
                        $pastDate = $allTrip->service_date;

                        if($lastKey==$key){
                            $grandTotServed = DB::select("SELECT 
                            (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                            SUM(trip_details.total_mileage) as km_served,
                            ROUND((case when (route.company_id = 29) THEN 3.42 * SUM(trip_details.total_mileage)
                            ELSE 1.33 * SUM(trip_details.total_mileage) END),2) as travel_claim
                            FROM mybas.trip_details
                            JOIN mybas.route ON route.id = trip_details.route_id
                            WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND route.status = 1
                            AND route.id = '" . $validatedData['route_id'] . "';");

                            $grandTotPlanned = DB::select("SELECT 
                            count(route_scheduler_details.id) as trip_planned, 
                            count(route_scheduler_details.id) * route.distance as km_planned
                            FROM mybas.route
                            JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                            JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                            WHERE route_scheduler_details.schedule_date BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND route.status = 1
                            AND route.id = '" . $validatedData['route_id'] . "';");

                            foreach($grandTotServed as $grandKey => $grandServed){
                                $foundRoute = false;
                                foreach($grandTotPlanned as $key9 => $grandPlanned){
                                    $grandServed->trip_planned = $grandPlanned->trip_planned;
                                    $grandServed->km_planned = $grandPlanned->km_planned;
                                }
                            }

                            $newKey = $key + $count+1;
                            $out->writeln("last newKey: " . $newKey);
                            array_splice($allTrips, $newKey, 0, $grandTotServed);
                            array_splice($allTrips, $newKey, 0, $totServedRoute);
                            array_splice($allTrips, $newKey, 0, $totServedDate);
                        }
                    }

                }
            }
            return Excel::download(new SPADClaimSummary($allTrips, $validatedData['dateFrom'], $validatedData['dateTo'], $networkArea), 'Claim_Summary_Report_SPAD_'.Carbon::now()->format('YmdHis').'.xlsx');
        }else{
            $this->dispatchBrowserEvent('company-required');
        }
    }

    public function printClaimSummaryOld()
    {
        $out = new ConsoleOutput();
        $out->writeln("YOU ARE IN  printClaimSummary()");

        $validatedData = Validator::make($this->state,[
            'dateFrom' => ['required', 'date'],
            'dateTo' => ['required', 'date'],
            'route_id' => ['required'],
        ])->validate();

        $startDate = new Carbon($validatedData['dateFrom']);
        $endDate = new Carbon($validatedData['dateTo']);
        $all_dates = array();

        while ($startDate->lte($endDate)){
            $all_dates[] = $startDate->toDateString();
            $startDate->addDay();
        }

        $claimSummary = collect();
        $grandTripPlanned= 0;
        $grandTripMade = 0;
        $grandServicePlanned = 0;
        $grandServiceServed = 0;
        $grandClaim = 0;
        $grandTravelGPS = 0;
        $grandClaimGPS = 0;
        if ($this->selectedCompany){
            if($this->selectedCompany=='All'){
                $networkArea = 'All';
                if(!empty($validatedData['route_id'])) {
                    //ClaimSummary all routes for all company
                    if($validatedData['route_id']=='All'){
                        $allRoutes = Route::orderBy('route_number')->get();
            
                        foreach($allRoutes as $allRoute) {
                            $route_name_in = $allRoute->route_name;
                            $route_name_out = implode(" - ", array_reverse(explode(" - ", $route_name_in)));
                            $routeTripPlanned = 0;
                            $routeTripMade = 0;
                            $routeServicePlanned = 0;
                            $routeServiceServed = 0;
                            $routeClaim = 0;
                            $routeTravelGPS = 0;
                            $routeClaimGPS = 0;

                            if($allRoute->company_id==29){
                                $charge = 3.42;
                            }else{
                                $charge = 1.33;
                            }
            
                            foreach ($all_dates as $all_date) {
                                $tripPlannedIn = 0;
                                $tripPlannedOut = 0;
                                $tripMadeIn = 0;
                                $tripMadeOut = 0;
                                $servicePlannedIn = 0;
                                $servicePlannedOut = 0;
                                $serviceServedIn = 0;
                                $serviceServedOut = 0;
                                $travelGPSIn = 0;
                                $travelGPSOut = 0;
                                $existInTrip = false;
                                $existOutTrip = false;
            
                                $firstDate = new Carbon($all_date);
                                $lastDate = new Carbon($all_date . '23:59:59');
            
                                //Trip Planned
                                $schedules = RouteSchedulerDetail::whereBetween('schedule_date', [$firstDate, $lastDate])->get();
                                if (count($schedules) > 0) {
                                    foreach ($schedules as $schedule) {
                                        if ($schedule->RouteScheduleMSTR->route_id == $allRoute->id) {
                                            if ($schedule->RouteScheduleMSTR->trip_code == 0){
                                                $tripPlannedOut++;
                                                $servicePlannedOut += $schedule->RouteScheduleMSTR->Route->outbound_distance;
                                            }elseif ($schedule->RouteScheduleMSTR->trip_code == 1){
                                                $tripPlannedIn++;
                                                $servicePlannedIn += $schedule->RouteScheduleMSTR->Route->inbound_distance;
                                            }
                                        }
                                    }
                                }
            
                                //Inbound
                                $allTripInbounds = TripDetail::where('route_id', $allRoute->id)
                                    ->whereBetween('start_trip', [$firstDate, $lastDate])
                                    ->where('trip_code', 1)
                                    ->get();
            
                                if (count($allTripInbounds) > 0) {
                                    $existInTrip = true;
            
                                    foreach ($allTripInbounds as $allTripInbound) {
                                        $tripMadeIn++;
            
                                        //Service Served (KM)
                                        $travelIn = $allTripInbound->Route->inbound_distance;
                                        $serviceServedIn += $travelIn;
            
                                        //Travel GPS
                                        $travelGPS = $allTripInbound->total_mileage;
                                        $travelGPSIn += $travelGPS;
                                    }

                                    //Total Claim In
                                    $claimIn = $serviceServedIn * $charge;
                                    $claimInFormat = round($claimIn,1);
            
                                    //Total Claim GPS In
                                    $claimGPSIn = $travelGPSIn * $charge;
                                    $claimGPSInFormat = round($claimGPSIn,1);
            
                                    $inbound['route_name'] = $route_name_in;
                                    $inbound['trip_planned_in'] = $tripPlannedIn;
                                    $inbound['trip_made_in'] = $tripMadeIn;
                                    $inbound['service_planned_in'] = $servicePlannedIn;
                                    $inbound['service_served_in'] = $serviceServedIn;
                                    $inbound['claim_in'] = $claimInFormat;
                                    $inbound['travel_gps_in'] = $travelGPSIn;
                                    $inbound['claim_gps_in'] = $claimGPSInFormat;
                                }
            
                                //Outbound
                                $allTripOutbounds = TripDetail::where('route_id', $allRoute->id)
                                    ->whereBetween('start_trip', [$firstDate, $lastDate])
                                    ->where('trip_code', 0)
                                    ->get();
            
                                if (count($allTripOutbounds) > 0) {
                                    $existOutTrip = true;
            
                                    foreach ($allTripOutbounds as $allTripOutbound) {
                                        $tripMadeOut++;
            
                                        //Service Served (KM)
                                        $travelOut = $allTripOutbound->Route->outbound_distance;
                                        $serviceServedOut += $travelOut;
            
                                        //Travel GPS
                                        $travelGPS = $allTripOutbound->total_mileage;
                                        $travelGPSOut += $travelGPS;
                                    }
            
                                    //Total Claim Out
                                    $claimOut = $serviceServedOut * $charge;
                                    $claimOutFormat = round($claimOut,1);
            
                                    //Total Claim GPS Out
                                    $claimGPSOut = $travelGPSOut * $charge;
                                    $claimGPSOutFormat = round($claimGPSOut,1);
            
                                    $outbound['route_name'] = $route_name_out;
                                    $outbound['trip_planned_out'] = $tripPlannedOut;
                                    $outbound['trip_made_out'] = $tripMadeOut;
                                    $outbound['service_planned_out'] = $servicePlannedOut;
                                    $outbound['service_served_out'] = $serviceServedOut;
                                    $outbound['claim_out'] = $claimOutFormat;
                                    $outbound['travel_gps_out'] = $travelGPSOut;
                                    $outbound['claim_gps_out'] = $claimGPSOutFormat;
                                }
            
                                if ($existInTrip == true && $existOutTrip == true) {
                                    $totalTripPlanned = $inbound['trip_planned_in'] + $outbound['trip_planned_out'];
                                    $totalTripMade = $inbound['trip_made_in'] + $outbound['trip_made_out'];
                                    $totalServicePlanned = $inbound['service_planned_in'] + $outbound['service_planned_out'];
                                    $totalServiceServed = $inbound['service_served_in'] + $outbound['service_served_out'];
                                    $totalClaim = $inbound['claim_in'] + $outbound['claim_out'];
                                    $totalTravelGPS = $inbound['travel_gps_in'] + $outbound['travel_gps_out'];
                                    $totalClaimGPS = $inbound['claim_gps_in'] + $outbound['claim_gps_out'];
            
                                    $perDate['total_trip_planned'] = $totalTripPlanned;
                                    $perDate['total_trip_made'] = $totalTripMade;
                                    $perDate['total_service_planned'] = $totalServicePlanned;
                                    $perDate['total_service_served'] = $totalServiceServed;
                                    $perDate['total_claim'] = $totalClaim;
                                    $perDate['total_travel_gps'] = $totalTravelGPS;
                                    $perDate['total_claim_gps'] = $totalClaimGPS;
            
                                    $data_perDate['inbound_data'] = $inbound;
                                    $data_perDate['outbound_data'] = $outbound;
                                    $data_perDate['total_per_date'] = $perDate;
            
                                    $allDate[$all_date] = $data_perDate;
            
                                } elseif ($existInTrip == true && $existOutTrip == false) {
                                    $totalTripPlanned = $inbound['trip_planned_in'];
                                    $totalTripMade = $inbound['trip_made_in'];
                                    $totalServicePlanned = $inbound['service_planned_in'];
                                    $totalServiceServed = $inbound['service_served_in'];
                                    $totalClaim = $inbound['claim_in'];
                                    $totalTravelGPS = $inbound['travel_gps_in'];
                                    $totalClaimGPS = $inbound['claim_gps_in'];
            
                                    $perDate['total_trip_planned'] = $totalTripPlanned;
                                    $perDate['total_trip_made'] = $totalTripMade;
                                    $perDate['total_service_planned'] = $totalServicePlanned;
                                    $perDate['total_service_served'] = $totalServiceServed;
                                    $perDate['total_claim'] = $totalClaim;
                                    $perDate['total_travel_gps'] = $totalTravelGPS;
                                    $perDate['total_claim_gps'] = $totalClaimGPS;
            
                                    $data_perDate['inbound_data'] = $inbound;
                                    $data_perDate['outbound_data'] = [];
                                    $data_perDate['total_per_date'] = $perDate;
            
                                    $allDate[$all_date] = $data_perDate;
            
                                } elseif ($existInTrip == false && $existOutTrip == true) {
                                    $totalTripPlanned = $outbound['trip_planned_out'];
                                    $totalTripMade = $outbound['trip_made_out'];
                                    $totalServicePlanned = $outbound['service_planned_out'];
                                    $totalServiceServed = $outbound['service_served_out'];
                                    $totalClaim = $outbound['claim_out'];
                                    $totalTravelGPS = $outbound['travel_gps_out'];
                                    $totalClaimGPS = $outbound['claim_gps_out'];
            
                                    $perDate['total_trip_planned'] = $totalTripPlanned;
                                    $perDate['total_trip_made'] = $totalTripMade;
                                    $perDate['total_service_planned'] = $totalServicePlanned;
                                    $perDate['total_service_served'] = $totalServiceServed;
                                    $perDate['total_claim'] = $totalClaim;
                                    $perDate['total_travel_gps'] = $totalTravelGPS;
                                    $perDate['total_claim_gps'] = $totalClaimGPS;
            
                                    $data_perDate['inbound_data'] = [];
                                    $data_perDate['outbound_data'] = $outbound;
                                    $data_perDate['total_per_date'] = $perDate;
            
                                    $allDate[$all_date] = $data_perDate;
                                } else {
                                    $totalTripPlanned = 0;
                                    $totalTripMade = 0;
                                    $totalServicePlanned = 0;
                                    $totalServiceServed = 0;
                                    $totalClaim = 0;
                                    $totalTravelGPS = 0;
                                    $totalClaimGPS = 0;
            
                                    $data_perDate['inbound_data'] = [];
                                    $data_perDate['outbound_data'] = [];
                                    $data_perDate['total_per_date'] = [];
            
                                    $allDate[$all_date] = $data_perDate;
                                }
                                $routeTripPlanned += $totalTripPlanned;
                                $routeTripMade += $totalTripMade;
                                $routeServicePlanned += $totalServicePlanned;
                                $routeServiceServed += $totalServiceServed;
                                $routeClaim += $totalClaim;
                                $routeTravelGPS += $totalTravelGPS;
                                $routeClaimGPS += $totalClaimGPS;
                            }
                            if($routeTripPlanned==0 && $routeTripMade == 0 & $routeServicePlanned ==0 && $routeServiceServed == 0 && 
                                $routeClaim==0 && $routeTravelGPS==0 && $routeClaimGPS == 0){
                                $allDate['total_per_route'] = [];
                            }else{
                                $perRoute['route_trip_planned'] = $routeTripPlanned;
                                $perRoute['route_trip_made'] = $routeTripMade;
                                $perRoute['route_service_planned'] = $routeServicePlanned;
                                $perRoute['route_service_served'] = $routeServiceServed;
                                $perRoute['route_claim'] = $routeClaim;
                                $perRoute['route_travel_gps'] = $routeTravelGPS;
                                $perRoute['route_claim_gps'] = $routeClaimGPS;
                
                                $allDate['total_per_route'] = $perRoute;
                            }
                            $route[$allRoute->route_number] = $allDate;
                            $data['allRoute'] = $route;
            
                            $grandTripPlanned += $routeTripPlanned;
                            $grandTripMade += $routeTripMade;
                            $grandServicePlanned += $routeServicePlanned;
                            $grandServiceServed += $routeServiceServed;
                            $grandClaim += $routeClaim;
                            $grandTravelGPS += $routeTravelGPS;
                            $grandClaimGPS += $routeClaimGPS;
            
                        }
                        $grand['grand_trip_planned'] = $grandTripPlanned;
                        $grand['grand_trip_made'] = $grandTripMade;
                        $grand['grand_service_planned'] = $grandServicePlanned;
                        $grand['grand_service_served'] = $grandServiceServed;
                        $grand['grand_claim'] = $grandClaim;
                        $grand['grand_travel_gps'] = $grandTravelGPS;
                        $grand['grand_claim_gps'] = $grandClaimGPS;
            
                        $data['grand'] = $grand;
                        $claimSummary->add($data);
                    }
                }
            }else{
                $companyDetails = Company::where('id', $this->selectedCompany)->first();
                $networkArea = $companyDetails->company_name;
                if($companyDetails->id==29){
                    $charge = 3.42;
                }else{
                    $charge = 1.33;
                }
                if(!empty($validatedData['route_id'])) {
                    //ClaimSummary all routes for specific company
                    if($validatedData['route_id']=='All'){
                        $allRoutes = Route::where('company_id',  $companyDetails->id)->orderBy('route_number')->get();
        
                        foreach($allRoutes as $allRoute) {
                            $route_name_in = $allRoute->route_name;
                            $route_name_out = implode(" - ", array_reverse(explode(" - ", $route_name_in)));
                            $routeTripPlanned = 0;
                            $routeTripMade = 0;
                            $routeServicePlanned = 0;
                            $routeServiceServed = 0;
                            $routeClaim = 0;
                            $routeTravelGPS = 0;
                            $routeClaimGPS = 0;
        
                            foreach ($all_dates as $all_date) {
                                $tripPlannedIn = 0;
                                $tripPlannedOut = 0;
                                $tripMadeIn = 0;
                                $tripMadeOut = 0;
                                $servicePlannedIn = 0;
                                $servicePlannedOut = 0;
                                $serviceServedIn = 0;
                                $serviceServedOut = 0;
                                $travelGPSIn = 0;
                                $travelGPSOut = 0;
                                $existInTrip = false;
                                $existOutTrip = false;
        
                                $firstDate = new Carbon($all_date);
                                $lastDate = new Carbon($all_date . '23:59:59');
        
                                //Trip Planned
                                $schedules = RouteSchedulerDetail::whereBetween('schedule_date', [$firstDate, $lastDate])->get();
                                if(count($schedules)>0) {
                                    foreach ($schedules as $schedule) {
                                        if ($schedule->RouteScheduleMSTR->route_id == $allRoute->id) {
                                            if ($schedule->RouteScheduleMSTR->trip_code == 0){
                                                $tripPlannedOut++;
                                                $servicePlannedOut += $schedule->RouteScheduleMSTR->Route->outbound_distance;
                                            }elseif ($schedule->RouteScheduleMSTR->trip_code == 1){
                                                $tripPlannedIn++;
                                                $servicePlannedIn += $schedule->RouteScheduleMSTR->Route->inbound_distance;
                                            }
                                        }
                                    }
                                }
        
                                //Inbound
                                $allTripInbounds = TripDetail::where('route_id', $allRoute->id)
                                    ->whereBetween('start_trip', [$firstDate, $lastDate])
                                    ->where('trip_code', 1)
                                    ->get();
        
                                if (count($allTripInbounds) > 0) {
                                    $existInTrip = true;
        
                                    foreach ($allTripInbounds as $allTripInbound) {
                                        $tripMadeIn++;
                                        //Service Served (KM)
                                        $travelIn = $allTripInbound->Route->inbound_distance;
                                        $serviceServedIn += $travelIn;
        
                                        //Travel GPS
                                        $travelGPS = $allTripInbound->total_mileage;
                                        $travelGPSIn += $travelGPS;
                                    }
        
                                    //Total Claim In
                                    $claimIn = $serviceServedIn * $charge;
                                    $claimInFormat = round($claimIn,1);
        
                                    //Total Claim GPS In
                                    $claimGPSIn = $travelGPSIn * $charge;
                                    $claimGPSInFormat = round($claimGPSIn,1);
        
                                    $inbound['route_name'] = $route_name_in;
                                    $inbound['trip_planned_in'] = $tripPlannedIn;
                                    $inbound['trip_made_in'] = $tripMadeIn;
                                    $inbound['service_planned_in'] = $servicePlannedIn;
                                    $inbound['service_served_in'] = $serviceServedIn;
                                    $inbound['claim_in'] = $claimInFormat;
                                    $inbound['travel_gps_in'] = $travelGPSIn;
                                    $inbound['claim_gps_in'] = $claimGPSInFormat;
                                }
        
                                //Outbound
                                $allTripOutbounds = TripDetail::where('route_id', $allRoute->id)
                                    ->whereBetween('start_trip', [$firstDate, $lastDate])
                                    ->where('trip_code', 0)
                                    ->get();
        
                                if (count($allTripOutbounds) > 0) {
                                    $existOutTrip = true;
        
                                    foreach ($allTripOutbounds as $allTripOutbound) {
                                        $tripMadeOut++;
                                        //Service Served (KM)
                                        $travelOut = $allTripOutbound->Route->outbound_distance;
                                        $serviceServedOut += $travelOut;
        
                                        //Travel GPS
                                        $travelGPS = $allTripOutbound->total_mileage;
                                        $travelGPSOut += $travelGPS;
                                    }
        
                                    //Total Claim Out
                                    $claimOut = $serviceServedOut * $charge;
                                    $claimOutFormat = round($claimOut,1);
        
                                    //Total Claim GPS Out
                                    $claimGPSOut = $travelGPSOut * $charge;
                                    $claimGPSOutFormat = round($claimGPSOut,1);
        
                                    $outbound['route_name'] = $route_name_out;
                                    $outbound['trip_planned_out'] = $tripPlannedOut;
                                    $outbound['trip_made_out'] = $tripMadeOut;
                                    $outbound['service_planned_out'] = $servicePlannedOut;
                                    $outbound['service_served_out'] = $serviceServedOut;
                                    $outbound['claim_out'] = $claimOutFormat;
                                    $outbound['travel_gps_out'] = $travelGPSOut;
                                    $outbound['claim_gps_out'] = $claimGPSOutFormat;
                                }
        
                                if ($existInTrip == true && $existOutTrip == true) {
                                    $totalTripPlanned = $inbound['trip_planned_in'] + $outbound['trip_planned_out'];
                                    $totalTripMade = $inbound['trip_made_in'] + $outbound['trip_made_out'];
                                    $totalServicePlanned = $inbound['service_planned_in'] + $outbound['service_planned_out'];
                                    $totalServiceServed = $inbound['service_served_in'] + $outbound['service_served_out'];
                                    $totalClaim = $inbound['claim_in'] + $outbound['claim_out'];
                                    $totalTravelGPS = $inbound['travel_gps_in'] + $outbound['travel_gps_out'];
                                    $totalClaimGPS = $inbound['claim_gps_in'] + $outbound['claim_gps_out'];
        
                                    $perDate['total_trip_planned'] = $totalTripPlanned;
                                    $perDate['total_trip_made'] = $totalTripMade;
                                    $perDate['total_service_planned'] = $totalServicePlanned;
                                    $perDate['total_service_served'] = $totalServiceServed;
                                    $perDate['total_claim'] = $totalClaim;
                                    $perDate['total_travel_gps'] = $totalTravelGPS;
                                    $perDate['total_claim_gps'] = $totalClaimGPS;
        
                                    $data_perDate['inbound_data'] = $inbound;
                                    $data_perDate['outbound_data'] = $outbound;
                                    $data_perDate['total_per_date'] = $perDate;
        
                                    $allDate[$all_date] = $data_perDate;
        
                                } elseif ($existInTrip == true && $existOutTrip == false) {
                                    $totalTripPlanned = $inbound['trip_planned_in'];
                                    $totalTripMade = $inbound['trip_made_in'];
                                    $totalServicePlanned = $inbound['service_planned_in'];
                                    $totalServiceServed = $inbound['service_served_in'];
                                    $totalClaim = $inbound['claim_in'];
                                    $totalTravelGPS = $inbound['travel_gps_in'];
                                    $totalClaimGPS = $inbound['claim_gps_in'];
        
                                    $perDate['total_trip_planned'] = $totalTripPlanned;
                                    $perDate['total_trip_made'] = $totalTripMade;
                                    $perDate['total_service_planned'] = $totalServicePlanned;
                                    $perDate['total_service_served'] = $totalServiceServed;
                                    $perDate['total_claim'] = $totalClaim;
                                    $perDate['total_travel_gps'] = $totalTravelGPS;
                                    $perDate['total_claim_gps'] = $totalClaimGPS;
        
                                    $data_perDate['inbound_data'] = $inbound;
                                    $data_perDate['outbound_data'] = [];
                                    $data_perDate['total_per_date'] = $perDate;
        
                                    $allDate[$all_date] = $data_perDate;
        
                                } elseif ($existInTrip == false && $existOutTrip == true) {
                                    $totalTripPlanned = $outbound['trip_planned_out'];
                                    $totalTripMade = $outbound['trip_made_out'];
                                    $totalServicePlanned = $outbound['service_planned_out'];
                                    $totalServiceServed = $outbound['service_served_out'];
                                    $totalClaim = $outbound['claim_out'];
                                    $totalTravelGPS = $outbound['travel_gps_out'];
                                    $totalClaimGPS = $outbound['claim_gps_out'];
        
                                    $perDate['total_trip_planned'] = $totalTripPlanned;
                                    $perDate['total_trip_made'] = $totalTripMade;
                                    $perDate['total_service_planned'] = $totalServicePlanned;
                                    $perDate['total_service_served'] = $totalServiceServed;
                                    $perDate['total_claim'] = $totalClaim;
                                    $perDate['total_travel_gps'] = $totalTravelGPS;
                                    $perDate['total_claim_gps'] = $totalClaimGPS;
        
                                    $data_perDate['inbound_data'] = [];
                                    $data_perDate['outbound_data'] = $outbound;
                                    $data_perDate['total_per_date'] = $perDate;
        
                                    $allDate[$all_date] = $data_perDate;
                                } else {
                                    $totalTripPlanned = 0;
                                    $totalTripMade = 0;
                                    $totalServicePlanned = 0;
                                    $totalServiceServed = 0;
                                    $totalClaim = 0;
                                    $totalTravelGPS = 0;
                                    $totalClaimGPS = 0;
        
                                    $data_perDate['inbound_data'] = [];
                                    $data_perDate['outbound_data'] = [];
                                    $data_perDate['total_per_date'] = [];
        
                                    $allDate[$all_date] = $data_perDate;
                                }
                                $routeTripPlanned += $totalTripPlanned;
                                $routeTripMade += $totalTripMade;
                                $routeServicePlanned += $totalServicePlanned;
                                $routeServiceServed += $totalServiceServed;
                                $routeClaim += $totalClaim;
                                $routeTravelGPS += $totalTravelGPS;
                                $routeClaimGPS += $totalClaimGPS;
                            }
        
                            if($routeTripPlanned==0 && $routeTripMade == 0 & $routeServicePlanned ==0 && $routeServiceServed == 0 && 
                                $routeClaim==0 && $routeTravelGPS==0 && $routeClaimGPS == 0){
                                $allDate['total_per_route'] = [];
                            }else{
                                $perRoute['route_trip_planned'] = $routeTripPlanned;
                                $perRoute['route_trip_made'] = $routeTripMade;
                                $perRoute['route_service_planned'] = $routeServicePlanned;
                                $perRoute['route_service_served'] = $routeServiceServed;
                                $perRoute['route_claim'] = $routeClaim;
                                $perRoute['route_travel_gps'] = $routeTravelGPS;
                                $perRoute['route_claim_gps'] = $routeClaimGPS;
                
                                $allDate['total_per_route'] = $perRoute;
                            }
                            $route[$allRoute->route_number] = $allDate;
                            $data['allRoute'] = $route;
        
                            $grandTripPlanned += $routeTripPlanned;
                            $grandTripMade += $routeTripMade;
                            $grandServicePlanned += $routeServicePlanned;
                            $grandServiceServed += $routeServiceServed;
                            $grandClaim += $routeClaim;
                            $grandTravelGPS += $routeTravelGPS;
                            $grandClaimGPS += $routeClaimGPS;
        
                        }
                        $grand['grand_trip_planned'] = $grandTripPlanned;
                        $grand['grand_trip_made'] = $grandTripMade;
                        $grand['grand_service_planned'] = $grandServicePlanned;
                        $grand['grand_service_served'] = $grandServiceServed;
                        $grand['grand_claim'] = $grandClaim;
                        $grand['grand_travel_gps'] = $grandTravelGPS;
                        $grand['grand_claim_gps'] = $grandClaimGPS;
        
                        $data['grand'] = $grand;
                        $claimSummary->add($data);
                    }
                    //ClaimSummary specific routes for specific company
                    else{
                        $selectedRoute = Route::where('id', $validatedData['route_id'])->first();
                        $route_name_in = $selectedRoute->route_name;
                        $route_name_out = implode(" - ", array_reverse(explode(" - ", $route_name_in)));
        
                        foreach ($all_dates as $all_date) {
                            $tripPlannedIn = 0;
                            $tripPlannedOut = 0;
                            $tripMadeIn = 0;
                            $tripMadeOut = 0;
                            $servicePlannedIn = 0;
                            $servicePlannedOut = 0;
                            $serviceServedIn = 0;
                            $serviceServedOut = 0;
                            $travelGPSIn = 0;
                            $travelGPSOut = 0;
                            $existInTrip = false;
                            $existOutTrip = false;
        
                            $firstDate = new Carbon($all_date);
                            $lastDate = new Carbon($all_date .'23:59:59');
        
                            //Trip Planned
                            $schedules = RouteSchedulerDetail::whereBetween('schedule_date', [$firstDate,$lastDate])->get();
                            if(count($schedules)>0) {
                                foreach ($schedules as $schedule) {
                                    if ($schedule->RouteScheduleMSTR->route_id == $selectedRoute->id) {
                                        if ($schedule->RouteScheduleMSTR->trip_code == 0){
                                            $tripPlannedOut++;
                                            $servicePlannedOut += $schedule->RouteScheduleMSTR->Route->outbound_distance;
                                        }elseif ($schedule->RouteScheduleMSTR->trip_code == 1){
                                            $tripPlannedIn++;
                                            $servicePlannedIn += $schedule->RouteScheduleMSTR->Route->inbound_distance;
                                        }
                                    }
                                }
                            }
        
                            //Inbound
                            $allTripInbounds = TripDetail::where('route_id', $selectedRoute->id)
                                ->whereBetween('start_trip', [$firstDate,$lastDate])
                                ->where('trip_code', 1)
                                ->get();
        
                            if (count($allTripInbounds) > 0) {
                                $existInTrip = true;
        
                                foreach ($allTripInbounds as $allTripInbound) {
                                    $tripMadeIn++;
        
                                    //Service Served (KM)
                                    $travelIn = $allTripInbound->Route->inbound_distance;
                                    $serviceServedIn += $travelIn;
        
                                    //Travel GPS
                                    $travelGPS = $allTripInbound->total_mileage;
                                    $travelGPSIn += $travelGPS;
                                }

                                //Total Claim In
                                $claimIn = $serviceServedIn * $charge;
                                $claimInFormat = round($claimIn,1);
        
                                //Total Claim GPS In
                                $claimGPSIn = $travelGPSIn * $charge;
                                $claimGPSInFormat = round($claimGPSIn,1);
        
                                $inbound['route_name'] = $route_name_in;
                                $inbound['trip_planned_in'] = $tripPlannedIn;
                                $inbound['trip_made_in'] = $tripMadeIn;
                                $inbound['service_planned_in'] = $servicePlannedIn;
                                $inbound['service_served_in'] = $serviceServedIn;
                                $inbound['claim_in'] = $claimInFormat;
                                $inbound['travel_gps_in'] = $travelGPSIn;
                                $inbound['claim_gps_in'] = $claimGPSInFormat;
                            }
        
                            //Outbound
                            $allTripOutbounds = TripDetail::where('route_id', $selectedRoute->id)
                                ->whereBetween('start_trip', [$firstDate,$lastDate])
                                ->where('trip_code', 0)
                                ->get();
        
                            if (count($allTripOutbounds) > 0) {
                                $existOutTrip = true;
        
                                foreach ($allTripOutbounds as $allTripOutbound) {
                                    $tripMadeOut++;
        
                                    //Service Served (KM)
                                    $travelOut = $allTripOutbound->Route->outbound_distance;
                                    $serviceServedOut += $travelOut;
        
                                    //Travel GPS
                                    $travelGPS = $allTripOutbound->total_mileage;
                                    $travelGPSOut += $travelGPS;
                                }
                                
                                //Total Claim Out
                                $claimOut = $serviceServedOut * $charge;
                                $claimOutFormat = round($claimOut,1);
        
                                //Total Claim GPS Out
                                $claimGPSOut = $travelGPSOut * $charge;
                                $claimGPSOutFormat = round($claimGPSOut,1);
        
                                $outbound['route_name'] = $route_name_out;
                                $outbound['trip_planned_out'] = $tripPlannedOut;
                                $outbound['trip_made_out'] = $tripMadeOut;
                                $outbound['service_planned_out'] = $servicePlannedOut;
                                $outbound['service_served_out'] = $serviceServedOut;
                                $outbound['claim_out'] = $claimOutFormat;
                                $outbound['travel_gps_out'] = $travelGPSOut;
                                $outbound['claim_gps_out'] = $claimGPSOutFormat;
                            }
        
                            if ($existInTrip == true && $existOutTrip == true) {
                                $totalTripPlanned = $inbound['trip_planned_in'] + $outbound['trip_planned_out'];
                                $totalTripMade =  $inbound['trip_made_in'] + $outbound['trip_made_out'];
                                $totalServicePlanned = $inbound['service_planned_in'] + $outbound['service_planned_out'];
                                $totalServiceServed = $inbound['service_served_in'] + $outbound['service_served_out'];
                                $totalClaim = $inbound['claim_in'] + $outbound['claim_out'];
                                $totalTravelGPS = $inbound['travel_gps_in'] + $outbound['travel_gps_out'];
                                $totalClaimGPS = $inbound['claim_gps_in'] + $outbound['claim_gps_out'];
        
                                $perDate['total_trip_planned'] = $totalTripPlanned;
                                $perDate['total_trip_made'] =  $totalTripMade;
                                $perDate['total_service_planned'] = $totalServicePlanned;
                                $perDate['total_service_served'] = $totalServiceServed;
                                $perDate['total_claim'] = $totalClaim;
                                $perDate['total_travel_gps'] = $totalTravelGPS;
                                $perDate['total_claim_gps'] = $totalClaimGPS;
        
                                $data_perDate['inbound_data'] = $inbound;
                                $data_perDate['outbound_data'] = $outbound;
                                $data_perDate['total_per_date'] = $perDate;
        
                                $allDate[$all_date] = $data_perDate;
        
                            } elseif ($existInTrip == true && $existOutTrip == false) {
                                $totalTripPlanned = $inbound['trip_planned_in'];
                                $totalTripMade =  $inbound['trip_made_in'];
                                $totalServicePlanned = $inbound['service_planned_in'];
                                $totalServiceServed = $inbound['service_served_in'];
                                $totalClaim = $inbound['claim_in'];
                                $totalTravelGPS = $inbound['travel_gps_in'];
                                $totalClaimGPS = $inbound['claim_gps_in'];
        
                                $perDate['total_trip_planned'] = $totalTripPlanned;
                                $perDate['total_trip_made'] =  $totalTripMade;
                                $perDate['total_service_planned'] = $totalServicePlanned;
                                $perDate['total_service_served'] = $totalServiceServed;
                                $perDate['total_claim'] =$totalClaim;
                                $perDate['total_travel_gps'] = $totalTravelGPS;
                                $perDate['total_claim_gps'] = $totalClaimGPS;
        
                                $data_perDate['inbound_data'] = $inbound;
                                $data_perDate['outbound_data'] = [];
                                $data_perDate['total_per_date'] = $perDate;
        
                                $allDate[$all_date] = $data_perDate;
        
                            } elseif ($existInTrip == false && $existOutTrip == true) {
                                $totalTripPlanned = $outbound['trip_planned_out'];
                                $totalTripMade =  $outbound['trip_made_out'];
                                $totalServicePlanned = $outbound['service_planned_out'];
                                $totalServiceServed = $outbound['service_served_out'];
                                $totalClaim =  $outbound['claim_out'];
                                $totalTravelGPS = $outbound['travel_gps_out'];
                                $totalClaimGPS = $outbound['claim_gps_out'];
        
                                $perDate['total_trip_planned'] =$totalTripPlanned;
                                $perDate['total_trip_made'] =  $totalTripMade;
                                $perDate['total_service_planned'] =  $totalServicePlanned;
                                $perDate['total_service_served'] = $totalServiceServed;
                                $perDate['total_claim'] =  $totalClaim;
                                $perDate['total_travel_gps'] = $totalTravelGPS;
                                $perDate['total_claim_gps'] = $totalClaimGPS;
        
                                $data_perDate['inbound_data'] = [];
                                $data_perDate['outbound_data'] = $outbound;
                                $data_perDate['total_per_date'] = $perDate;
        
                                $allDate[$all_date] = $data_perDate;
                            } else {
                                $totalTripPlanned = 0;
                                $totalTripMade = 0;
                                $totalServicePlanned = 0;
                                $totalServiceServed = 0;
                                $totalClaim = 0;
                                $totalTravelGPS = 0;
                                $totalClaimGPS = 0;
        
                                $data_perDate['inbound_data'] = [];
                                $data_perDate['outbound_data'] = [];
                                $data_perDate['total_per_date'] = [];
        
                                $allDate[$all_date] = $data_perDate;
                            }
        
                            $grandTripPlanned +=  $totalTripPlanned;
                            $grandTripMade += $totalTripMade;
                            $grandServicePlanned += $totalServicePlanned;
                            $grandServiceServed += $totalServiceServed;
                            $grandClaim += $totalClaim;
                            $grandTravelGPS += $totalTravelGPS;
                            $grandClaimGPS += $totalClaimGPS;
                        }
                        if($grandTripPlanned==0 && $grandTripMade == 0 & $grandServicePlanned ==0 && $grandServiceServed == 0 && 
                            $grandClaim==0 && $grandTravelGPS==0 && $grandClaimGPS == 0){
                            $allDate['total_per_route'] = [];
                        }else{
                            $perRoute['route_trip_planned'] = $grandTripPlanned;
                            $perRoute['route_trip_made'] = $grandTripMade;
                            $perRoute['route_service_planned'] = $grandServicePlanned;
                            $perRoute['route_service_served'] = $grandServiceServed;
                            $perRoute['route_claim'] = $grandClaim;;
                            $perRoute['route_travel_gps'] = $grandTravelGPS;
                            $perRoute['route_claim_gps'] = $grandClaimGPS;
            
                            $allDate['total_per_route'] = $perRoute;
                        }
                        $route[$selectedRoute->route_number] = $allDate;
                        $data['allRoute'] = $route;
        
                        $grand['grand_trip_planned'] = $grandTripPlanned;
                        $grand['grand_trip_made'] = $grandTripMade;
                        $grand['grand_service_planned'] = $grandServicePlanned;
                        $grand['grand_service_served'] = $grandServiceServed;
                        $grand['grand_claim'] = $grandClaim;
                        $grand['grand_travel_gps'] = $grandTravelGPS;
                        $grand['grand_claim_gps'] = $grandClaimGPS;
        
                        $data['grand'] = $grand;
                        $claimSummary->add($data);
                    }
                }
            }
            return Excel::download(new SPADClaimSummary($all_dates, $claimSummary, $validatedData['dateFrom'], $validatedData['dateTo'], $networkArea), 'ClaimSummary_Report_SPAD_'.Carbon::now()->format('YmdHis').'.xlsx');
        }else{
            $this->dispatchBrowserEvent('company-required');
        }
    }

    public function printSummaryRouteOld()
    {  
        $out = new ConsoleOutput();
        $out->writeln("YOU ARE IN printSummaryRoute()");

        $validatedData = Validator::make($this->state,[
            'dateFrom' => ['required', 'date'],
            'dateTo' => ['required', 'date'],
            'route_id' => ['required'],
        ])->validate();

        $startDate = new Carbon($validatedData['dateFrom']);
        $endDate = new Carbon($validatedData['dateTo']);
        $all_dates = array();

        while ($startDate->lte($endDate)) {
            $all_dates[] = $startDate->toDateString();
            $startDate->addDay();
        }

        $summaryByRoute = collect();
        $grandTripPlanned = 0;
        $grandKMPlanned = 0;
        $grandKMServed = 0;
        $grandTripServed = 0;
        $grandMissedTrip = 0;
        $grandEarlyLate = 0;
        $grandBreakdown = 0;
        $grandAccidents = 0;
        $grandRidershipCount = 0;
        $grandRidershipTicket = 0;
        $grandFarebox = 0;
        $data_perCompany = [];
        if ($this->selectedCompany){
            if($this->selectedCompany=='All'){
                $networkArea = 'All';
                if(!empty($validatedData['route_id'])) {
                     //Summary By Route all route all company
                    if($validatedData['route_id']=='All'){
                        $allCompanies = Company::all();
            
                        foreach($allCompanies as $allCompany){
                            $routePerCompanies = Route::where('company_id', $allCompany->id)->orderBy('route_number')->get();
                            $companyTripPlanned = 0;
                            $companyKMPlanned = 0;
                            $companyKMServed = 0;
                            $companyTripServed = 0;
                            $companyMissedTrip = 0;
                            $companyEarlyLate = 0;
                            $companyBreakdown = 0;
                            $companyAccidents = 0;
                            $companyRidershipCount = 0;
                            $companyRidershipTicket = 0;
                            $companyFarebox = 0;
                            $data_perRoute = [];
            
                            if(count($routePerCompanies)>0){
                                foreach($routePerCompanies as $routePerCompany){
                                    $routeTripPlanned = 0;
                                    $routeKMPlanned = 0;
                                    $routeKMServed = 0;
                                    $routeTripServed = 0;
                                    $routeMissedTrip = 0;
                                    $routeEarlyLate = 0;
                                    $routeBreakdown = 0;
                                    $routeAccidents = 0;
                                    $routeRidershipCount = 0;
                                    $routeRidershipTicket = 0;
                                    $routeFarebox = 0;
                                    $data_perDate = [];
            
                                    foreach ($all_dates as $all_date) {
                                        $totalKMServed = 0;
                                        $totalFarebox = 0;
                                        $totalRidershipCount = 0;
                                        $totalRidershipTicket = 0;
                                        $earlyLateCount = 0;
                                        $totalTripPlanned = 0;
                                        $tripPlannedOut = 0; 
                                        $tripPlannedIn = 0;
                                        $kmInbound = 0;
                                        $kmOutbound = 0;
                                        $tripServedIn = 0;
                                        $tripServedOut = 0;
                                        $firstDate = new Carbon($all_date);
                                        $lastDate = new Carbon($all_date .'23:59:59');
                                        $isWeekday = false;
                                        $isWeekend = false;

                                        $isWeekday = $firstDate->isWeekday();
                                        $isWeekend =  $firstDate->isWeekend();

                                        if($isWeekday){
                                            $isFriday = $firstDate->format('l');
                                            if($isFriday=='Friday'){
                                                $copies = RouteSchedulerMSTR::whereIn('trip_type', [1,3,5,7,12,13])
                                                ->where('status', 1)
                                                ->where('route_id', $routePerCompany->id)
                                                ->count();
                                            }else{
                                                $copies = RouteSchedulerMSTR::whereIn('trip_type', [1,3,5,4,6,9,10])
                                                ->where('status', 1)
                                                ->where('route_id', $routePerCompany->id)
                                                ->count();
                                            }
                                        }
                                        if($isWeekend){
                                            $isSunday = $firstDate->format('l');
                                            if($isSunday=='Sunday'){
                                                $copies = RouteSchedulerMSTR::whereIn('trip_type', [2,3,4,10,11,13])
                                                ->where('route_id', $routePerCompany->id)
                                                ->where('status', 1)
                                                ->count();
                                            }else{
                                                $copies = RouteSchedulerMSTR::whereIn('trip_type', [2,3,4,5,8,9,12,13])
                                                ->where('status', 1)
                                                ->where('route_id', $routePerCompany->id)
                                                ->count();
                                            }
                                            
                                        }
                                        $totalTripPlanned = $copies;
                                        $totalKMPlanned = $routePerCompany->inbound_distance * $copies;

                                        $schedules = RouteSchedulerDetail::whereBetween('schedule_date', [$firstDate, $lastDate])->get();
                    
                                        // if (count($schedules) > 0) {
                                        //     foreach ($schedules as $schedule) {
                                        //         if ($schedule->RouteScheduleMSTR->route_id == $routePerCompany->id) {
                                        //             if ($schedule->RouteScheduleMSTR->trip_code == 0){
                                        //                 $tripPlannedOut++;
                                        //                 $kmInbound += $schedule->RouteScheduleMSTR->Route->outbound_distance;
                                        //             }elseif ($schedule->RouteScheduleMSTR->trip_code == 1){
                                        //                 $tripPlannedIn++;
                                        //                 $kmOutbound += $schedule->RouteScheduleMSTR->Route->inbound_distance;
                                        //             }
                                        //         }
                                        //     }
                                        // }
                                        // $totalTripPlanned = $tripPlannedOut + $tripPlannedIn;
                                        // $totalKMPlanned = $kmInbound + $kmOutbound;
                    
                                        $allTrips = TripDetail::where('route_id', $routePerCompany->id)
                                            ->whereBetween('start_trip', [$firstDate, $lastDate])
                                            ->get();
                    
                                        if (count($allTrips) > 0) {
                                            foreach ($allTrips as $allTrip) {
                                                //Total KM Service Served
                                                if($allTrip->trip_code==0){
                                                    $tripServedOut++;
                                                    $kmServed = $allTrip->Route->outbound_distance;
                                                }else{
                                                    $tripServedIn++;
                                                    $kmServed = $allTrip->Route->inbound_distance;
                                                }
                                                $totalKMServed += $kmServed;
                    
                                                //Early-Late
                                                if (count($schedules) > 0) {
                                                    foreach ($schedules as $schedule) {
                                                        if ($schedule->RouteScheduleMSTR->route_id == $routePerCompany->id) {
                                                            if ($schedule->RouteScheduleMSTR->id == $allTrip->route_schedule_mstr_id) {
                                                                $diff = strtotime($schedule->schedule_start_time) - strtotime($allTrip->start_trip);
                                                                if ($diff > 5 || $diff < -5) {
                                                                    $earlyLateCount++;
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                    
                                                //Ridership Based On Count
                                                $ridershipCount = $allTrip->total_adult + $allTrip->total_concession;
                                                $totalRidershipCount += $ridershipCount;
                    
                                                //Ridership Based On Ticket Sales
                                                $ridershipTicket = TicketSalesTransaction::where('trip_number', $allTrip->trip_number)->count();
                                                $totalRidershipTicket += $ridershipTicket;
                    
                                                //Farebox Collection
                                                $farebox = $allTrip->total_adult_amount + $allTrip->total_concession_amount;
                                                if($farebox==0){
                                                    $checkTickets = TicketSalesTransaction::where('trip_number', $allTrip->trip_number)->get();
                                                    if(count($checkTickets)>0){
                                                        foreach($checkTickets as $checkTicket){
                                                            $farebox += $checkTicket->actual_amount;
                                                        }
                                                    }
                                                }
                                                $totalFarebox += $farebox;
                                            }
                                        }
                    
                                        //Total Trip Served
                                        $totalTripServed = count($allTrips);
                    
                                        //Total Missed Trip
                                        $diffIn = $tripPlannedIn - $tripServedIn;
                                        $diffOut = $tripPlannedOut - $tripServedOut;
                                        if($diffIn>0){
                                            if($diffOut>0){
                                                $totalMissedTrip = $diffIn + $diffOut;
                                            }else{
                                                $totalMissedTrip = $diffIn;
                                            }
                                        }else{
                                            if($diffOut>0){
                                                $totalMissedTrip = $diffOut;
                                            }else{
                                                $totalMissedTrip = 0;
                                            }
                                        }
                    
                                        /**Total Breakdown & Total Accidents need to revise**/
                                        $totalBreakdown = 0;
                                        $totalAccidents = 0;
                    
                                        if ($firstDate->isWeekDay()) {
                                            $trip_perDate['day'] = "WEEKDAY";
                                        } elseif ($firstDate->isWeekend()) {
                                            $trip_perDate['day'] = "WEEKEND";
                                        }
            
                                        //total per date
                                        $trip_perDate['total_trip_planned'] = $totalTripPlanned;
                                        $trip_perDate['total_km_planned'] = $totalKMPlanned;
                                        $trip_perDate['total_trip_served'] = $totalTripServed;
                                        $trip_perDate['total_km_served'] = $totalKMServed;
                                        $trip_perDate['total_missed_trip'] = $totalMissedTrip;
                                        $trip_perDate['total_early_late'] = $earlyLateCount;
                                        $trip_perDate['total_breakdown'] = $totalBreakdown;
                                        $trip_perDate['total_accidents'] = $totalAccidents;
                                        $trip_perDate['total_ridership_count'] = $totalRidershipCount;
                                        $trip_perDate['total_ridership_tickets'] = $totalRidershipTicket;
                                        $trip_perDate['total_farebox'] = $totalFarebox;
                    
                                        $data_perDate[$all_date] = $trip_perDate;
            
                                        $routeTripPlanned += $trip_perDate['total_trip_planned'];
                                        $routeKMPlanned += $trip_perDate['total_km_planned'];
                                        $routeKMServed += $trip_perDate['total_km_served'];
                                        $routeTripServed += $trip_perDate['total_trip_served'];
                                        $routeMissedTrip += $trip_perDate['total_missed_trip'];
                                        $routeEarlyLate += $trip_perDate['total_early_late'];
                                        $routeBreakdown += $trip_perDate['total_breakdown'];
                                        $routeAccidents += $trip_perDate['total_accidents'];
                                        $routeRidershipCount += $trip_perDate['total_ridership_count'];
                                        $routeRidershipTicket += $trip_perDate['total_ridership_tickets'];
                                        $routeFarebox += $trip_perDate['total_farebox'];
                                    }
            
                                    //total per route
                                    $trip_perRoute['total_trip_planned'] = $routeTripPlanned;
                                    $trip_perRoute['total_km_planned'] = $routeKMPlanned;
                                    $trip_perRoute['total_trip_served'] = $routeTripServed;
                                    $trip_perRoute['total_km_served'] = $routeKMServed;
                                    $trip_perRoute['total_missed_trip'] = $routeMissedTrip;
                                    $trip_perRoute['total_early_late'] = $routeEarlyLate;
                                    $trip_perRoute['total_breakdown'] = $routeBreakdown;
                                    $trip_perRoute['total_accidents'] = $routeAccidents;
                                    $trip_perRoute['total_ridership_count'] = $routeRidershipCount;
                                    $trip_perRoute['total_ridership_tickets'] = $routeRidershipTicket;
                                    $trip_perRoute['total_farebox'] = $routeFarebox;
            
                                    $data_perDate['total_per_route'] = $trip_perRoute;
                                    $data_perRoute[$routePerCompany->route_number . ' - ' . $routePerCompany->route_name] = $data_perDate;
            
                                    $companyTripPlanned += $trip_perRoute['total_trip_planned'];
                                    $companyKMPlanned += $trip_perRoute['total_km_planned'];
                                    $companyKMServed += $trip_perRoute['total_km_served'];
                                    $companyTripServed += $trip_perRoute['total_trip_served'];
                                    $companyMissedTrip += $trip_perRoute['total_missed_trip'];
                                    $companyEarlyLate += $trip_perRoute['total_early_late'];
                                    $companyBreakdown += $trip_perRoute['total_breakdown'];
                                    $companyAccidents += $trip_perRoute['total_accidents'];
                                    $companyRidershipCount += $trip_perRoute['total_ridership_count'];
                                    $companyRidershipTicket += $trip_perRoute['total_ridership_tickets'];
                                    $companyFarebox += $trip_perRoute['total_farebox'];
                                }
                            }
            
                            //total per company
                            $trip_perCompany['total_trip_planned'] = $companyTripPlanned;
                            $trip_perCompany['total_km_planned'] = $companyKMPlanned;
                            $trip_perCompany['total_trip_served'] = $companyTripServed;
                            $trip_perCompany['total_km_served'] = $companyKMServed;
                            $trip_perCompany['total_missed_trip'] = $companyMissedTrip;
                            $trip_perCompany['total_early_late'] = $companyEarlyLate;
                            $trip_perCompany['total_breakdown'] = $companyBreakdown;
                            $trip_perCompany['total_accidents'] = $companyAccidents;
                            $trip_perCompany['total_ridership_count'] =$companyRidershipCount;
                            $trip_perCompany['total_ridership_tickets'] = $companyRidershipTicket;
                            $trip_perCompany['total_farebox'] = $companyFarebox;
            
                            $data_perRoute['total_per_company'] = $trip_perCompany;
                            $data_perCompany[$allCompany->company_name] = $data_perRoute;
            
                            $grandTripPlanned += $trip_perCompany['total_trip_planned'];
                            $grandKMPlanned += $trip_perCompany['total_km_planned'];
                            $grandKMServed += $trip_perCompany['total_km_served'];
                            $grandTripServed += $trip_perCompany['total_trip_served'];
                            $grandMissedTrip += $trip_perCompany['total_missed_trip'];
                            $grandEarlyLate += $trip_perCompany['total_early_late'];
                            $grandBreakdown += $trip_perCompany['total_breakdown'];
                            $grandAccidents += $trip_perCompany['total_accidents'];
                            $grandRidershipCount += $trip_perCompany['total_ridership_count'];
                            $grandRidershipTicket += $trip_perCompany['total_ridership_tickets'];
                            $grandFarebox += $trip_perCompany['total_farebox'];
                        }
                        $grand['grand_trip_planned'] = $grandTripPlanned;
                        $grand['grand_km_planned'] = $grandKMPlanned;
                        $grand['grand_trip_served'] = $grandTripServed;
                        $grand['grand_km_served'] = $grandKMServed;
                        $grand['grand_missed_trip'] = $grandMissedTrip;
                        $grand['grand_early_late'] = $grandEarlyLate;
                        $grand['grand_breakdown'] = $grandBreakdown;
                        $grand['grand_accidents'] = $grandAccidents;
                        $grand['grand_ridership_count'] = $grandRidershipCount;
                        $grand['grand_ridership_tickets'] = $grandRidershipTicket;
                        $grand['grand_farebox'] = $grandFarebox;
            
                        $data_grand['all_company'] = $data_perCompany;
                        $data_grand['grand'] = $grand;
                        $summaryByRoute->add($data_grand);
                    }
                }
            }else{
                $companyDetails = Company::where('id', $this->selectedCompany)->first();
                $networkArea = $companyDetails->company_name;
                if(!empty($validatedData['route_id'])) {
                    //Summary By Route all route specific company
                    if($validatedData['route_id']=='All'){
                        $routePerCompanies = Route::where('company_id', $companyDetails->id)->orderBy('route_number')->get();
                        $companyTripPlanned = 0;
                        $companyKMPlanned = 0;
                        $companyKMServed = 0;
                        $companyTripServed = 0;
                        $companyMissedTrip = 0;
                        $companyEarlyLate = 0;
                        $companyBreakdown = 0;
                        $companyAccidents = 0;
                        $companyRidershipCount = 0;
                        $companyRidershipTicket = 0;
                        $companyFarebox = 0;

                        if(count($routePerCompanies)>0){
                            foreach($routePerCompanies as $routePerCompany){
                                $routeTripPlanned = 0;
                                $routeKMPlanned = 0;
                                $routeKMServed = 0;
                                $routeTripServed = 0;
                                $routeMissedTrip = 0;
                                $routeEarlyLate = 0;
                                $routeBreakdown = 0;
                                $routeAccidents = 0;
                                $routeRidershipCount = 0;
                                $routeRidershipTicket = 0;
                                $routeFarebox = 0;
        
                                foreach ($all_dates as $all_date) {
                                    $totalKMServed = 0;
                                    $totalFarebox = 0;
                                    $totalRidershipCount = 0;
                                    $totalRidershipTicket = 0;
                                    $earlyLateCount = 0;
                                    $totalTripPlanned = 0;
                                    $tripPlannedOut = 0; 
                                    $tripPlannedIn = 0;
                                    $kmInbound = 0;
                                    $kmOutbound = 0;
                                    $tripServedIn = 0;
                                    $tripServedOut = 0;
                                    $firstDate = new Carbon($all_date);
                                    $lastDate = new Carbon($all_date .'23:59:59');
                                    $isWeekday = false;
                                    $isWeekend = false;

                                    $isWeekday = $firstDate->isWeekday();
                                    $isWeekend =  $firstDate->isWeekend();

                                    if($isWeekday){
                                        $isFriday = $firstDate->format('l');
                                        if($isFriday=='Friday'){
                                            $copies = RouteSchedulerMSTR::whereIn('trip_type', [1,3,5,7,12,13])
                                            ->where('status', 1)
                                            ->where('route_id', $routePerCompany->id)
                                            ->count();
                                        }else{
                                            $copies = RouteSchedulerMSTR::whereIn('trip_type', [1,3,5,4,6,9,10])
                                            ->where('status', 1)
                                            ->where('route_id', $routePerCompany->id)
                                            ->count();
                                        }
                                    }
                                    if($isWeekend){
                                        $isSunday = $firstDate->format('l');
                                        if($isSunday=='Sunday'){
                                            $copies = RouteSchedulerMSTR::whereIn('trip_type', [2,3,4,10,11,13])
                                            ->where('route_id', $routePerCompany->id)
                                            ->where('status', 1)
                                            ->count();
                                        }else{
                                            $copies = RouteSchedulerMSTR::whereIn('trip_type', [2,3,4,5,8,9,12,13])
                                            ->where('status', 1)
                                            ->where('route_id', $routePerCompany->id)
                                            ->count();
                                        }
                                        
                                    }
                                    $totalTripPlanned = $copies;
                                    $totalKMPlanned = $routePerCompany->inbound_distance * $copies;

                                    $schedules = RouteSchedulerDetail::whereBetween('schedule_date', [$firstDate, $lastDate])->get();
                
                                    // if (count($schedules) > 0) {
                                    //     foreach ($schedules as $schedule) {
                                    //         if ($schedule->RouteScheduleMSTR->route_id == $routePerCompany->id) {
                                    //             if ($schedule->RouteScheduleMSTR->trip_code == 0){
                                    //                 $tripPlannedOut++;
                                    //                 $kmInbound += $schedule->RouteScheduleMSTR->Route->outbound_distance;
                                    //             }elseif ($schedule->RouteScheduleMSTR->trip_code == 1){
                                    //                 $tripPlannedIn++;
                                    //                 $kmOutbound += $schedule->RouteScheduleMSTR->Route->inbound_distance;
                                    //             }
                                    //         }
                                    //     }
                                    // }
                                    // $totalTripPlanned = $tripPlannedOut + $tripPlannedIn;
                                    // $totalKMPlanned = $kmInbound + $kmOutbound;
                
                                    $allTrips = TripDetail::where('route_id', $routePerCompany->id)
                                        ->whereBetween('start_trip', [$firstDate, $lastDate])
                                        ->get();
                
                                    if (count($allTrips) > 0) {
                                        foreach ($allTrips as $allTrip) {
                                            //Total KM Service Served
                                            if($allTrip->trip_code==0){
                                                $tripServedOut++;
                                                $kmServed = $allTrip->Route->outbound_distance;
                                            }else{
                                                $tripServedIn++;
                                                $kmServed = $allTrip->Route->inbound_distance;
                                            }
                                            $totalKMServed += $kmServed;
                
                                            //Early-Late
                                            if (count($schedules) > 0) {
                                                foreach ($schedules as $schedule) {
                                                    if ($schedule->RouteScheduleMSTR->route_id == $routePerCompany->id) {
                                                        if ($schedule->RouteScheduleMSTR->id == $allTrip->route_schedule_mstr_id) {
                                                            $diff = strtotime($schedule->schedule_start_time) - strtotime($allTrip->start_trip);
                                                            if ($diff > 5 || $diff < -5) {
                                                                $earlyLateCount++;
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                
                                            //Ridership Based On Count
                                            $ridershipCount = $allTrip->total_adult + $allTrip->total_concession;
                                            $totalRidershipCount += $ridershipCount;
                
                                            //Ridership Based On Ticket Sales
                                            $ridershipTicket = TicketSalesTransaction::where('trip_number', $allTrip->trip_number)->count();
                                            $totalRidershipTicket += $ridershipTicket;
                
                                            //Farebox Collection
                                            $farebox = $allTrip->total_adult_amount + $allTrip->total_concession_amount;
                                            if($farebox==0){
                                                $checkTickets = TicketSalesTransaction::where('trip_number', $allTrip->trip_number)->get();
                                                if(count($checkTickets)>0){
                                                    foreach($checkTickets as $checkTicket){
                                                        $farebox += $checkTicket->actual_amount;
                                                    }
                                                }
                                            }
                                            $totalFarebox += $farebox;
                                        }
                                    }
                
                                    //Total Trip Served
                                    $totalTripServed = count($allTrips);
                
                                    //Total Missed Trip
                                    $diffIn = $tripPlannedIn - $tripServedIn;
                                    $diffOut = $tripPlannedOut - $tripServedOut;
                                    if($diffIn>0){
                                        if($diffOut>0){
                                            $totalMissedTrip = $diffIn + $diffOut;
                                        }else{
                                            $totalMissedTrip = $diffIn;
                                        }
                                    }else{
                                        if($diffOut>0){
                                            $totalMissedTrip = $diffOut;
                                        }else{
                                            $totalMissedTrip = 0;
                                        }
                                    }
                
                                    /**Total Breakdown & Total Accidents need to revise**/
                                    $totalBreakdown = 0;
                                    $totalAccidents = 0;
                
                                    if ($firstDate->isWeekDay()) {
                                        $trip_perDate['day'] = "WEEKDAY";
                                    } elseif ($firstDate->isWeekend()) {
                                        $trip_perDate['day'] = "WEEKEND";
                                    }
        
                                    //total per date
                                    $trip_perDate['total_trip_planned'] = $totalTripPlanned;
                                    $trip_perDate['total_km_planned'] = $totalKMPlanned;
                                    $trip_perDate['total_trip_served'] = $totalTripServed;
                                    $trip_perDate['total_km_served'] = $totalKMServed;
                                    $trip_perDate['total_missed_trip'] = $totalMissedTrip;
                                    $trip_perDate['total_early_late'] = $earlyLateCount;
                                    $trip_perDate['total_breakdown'] = $totalBreakdown;
                                    $trip_perDate['total_accidents'] = $totalAccidents;
                                    $trip_perDate['total_ridership_count'] = $totalRidershipCount;
                                    $trip_perDate['total_ridership_tickets'] = $totalRidershipTicket;
                                    $trip_perDate['total_farebox'] = $totalFarebox;
                
                                    $data_perDate[$all_date] = $trip_perDate;
        
                                    $routeTripPlanned += $trip_perDate['total_trip_planned'];
                                    $routeKMPlanned += $trip_perDate['total_km_planned'];
                                    $routeKMServed += $trip_perDate['total_km_served'];
                                    $routeTripServed += $trip_perDate['total_trip_served'];
                                    $routeMissedTrip += $trip_perDate['total_missed_trip'];
                                    $routeEarlyLate += $trip_perDate['total_early_late'];
                                    $routeBreakdown += $trip_perDate['total_breakdown'];
                                    $routeAccidents += $trip_perDate['total_accidents'];
                                    $routeRidershipCount += $trip_perDate['total_ridership_count'];
                                    $routeRidershipTicket += $trip_perDate['total_ridership_tickets'];
                                    $routeFarebox += $trip_perDate['total_farebox'];
                                }
        
                                //total per route
                                $trip_perRoute['total_trip_planned'] = $routeTripPlanned;
                                $trip_perRoute['total_km_planned'] = $routeKMPlanned;
                                $trip_perRoute['total_trip_served'] = $routeTripServed;
                                $trip_perRoute['total_km_served'] = $routeKMServed;
                                $trip_perRoute['total_missed_trip'] = $routeMissedTrip;
                                $trip_perRoute['total_early_late'] = $routeEarlyLate;
                                $trip_perRoute['total_breakdown'] = $routeBreakdown;
                                $trip_perRoute['total_accidents'] = $routeAccidents;
                                $trip_perRoute['total_ridership_count'] = $routeRidershipCount;
                                $trip_perRoute['total_ridership_tickets'] = $routeRidershipTicket;
                                $trip_perRoute['total_farebox'] = $routeFarebox;
        
                                $data_perDate['total_per_route'] = $trip_perRoute;
                                $data_perRoute[$routePerCompany->route_number . ' - ' . $routePerCompany->route_name] = $data_perDate;
        
                                $companyTripPlanned += $trip_perRoute['total_trip_planned'];
                                $companyKMPlanned += $trip_perRoute['total_km_planned'];
                                $companyKMServed += $trip_perRoute['total_km_served'];
                                $companyTripServed += $trip_perRoute['total_trip_served'];
                                $companyMissedTrip += $trip_perRoute['total_missed_trip'];
                                $companyEarlyLate += $trip_perRoute['total_early_late'];
                                $companyBreakdown += $trip_perRoute['total_breakdown'];
                                $companyAccidents += $trip_perRoute['total_accidents'];
                                $companyRidershipCount += $trip_perRoute['total_ridership_count'];
                                $companyRidershipTicket += $trip_perRoute['total_ridership_tickets'];
                                $companyFarebox += $trip_perRoute['total_farebox'];
                            }
                        }
        
                        //total per company
                        $trip_perCompany['total_trip_planned'] = $companyTripPlanned;
                        $trip_perCompany['total_km_planned'] = $companyKMPlanned;
                        $trip_perCompany['total_trip_served'] = $companyTripServed;
                        $trip_perCompany['total_km_served'] = $companyKMServed;
                        $trip_perCompany['total_missed_trip'] = $companyMissedTrip;
                        $trip_perCompany['total_early_late'] = $companyEarlyLate;
                        $trip_perCompany['total_breakdown'] = $companyBreakdown;
                        $trip_perCompany['total_accidents'] = $companyAccidents;
                        $trip_perCompany['total_ridership_count'] =$companyRidershipCount;
                        $trip_perCompany['total_ridership_tickets'] = $companyRidershipTicket;
                        $trip_perCompany['total_farebox'] = $companyFarebox;
        
                        $data_perRoute['total_per_company'] = $trip_perCompany;
                        $data_perCompany[$companyDetails->company_name] = $data_perRoute;
        
                        $data_grand['all_company'] = $data_perCompany;
                        $data_grand['grand'] = $trip_perCompany;
                        $summaryByRoute->add($data_grand);
                    }
                    //Summary By Route specific route specific company
                    else{
                        $selectedRoute = Route::where('id', $validatedData['route_id'])->first();
                        $routeTripPlanned = 0;
                        $routeKMPlanned = 0;
                        $routeKMServed = 0;
                        $routeTripServed = 0;
                        $routeMissedTrip = 0;
                        $routeEarlyLate = 0;
                        $routeBreakdown = 0;
                        $routeAccidents = 0;
                        $routeRidershipCount = 0;
                        $routeRidershipTicket = 0;
                        $routeFarebox = 0;
        
                        foreach ($all_dates as $all_date) {
                            $totalKMServed = 0;
                            $totalFarebox = 0;
                            $totalRidershipCount = 0;
                            $totalRidershipTicket = 0;
                            $earlyLateCount = 0;
                            $totalTripPlanned = 0;
                            $tripPlannedOut = 0; 
                            $tripPlannedIn = 0;
                            $kmInbound = 0;
                            $kmOutbound = 0;
                            $tripServedIn = 0;
                            $tripServedOut = 0;
                            $firstDate = new Carbon($all_date);
                            $lastDate = new Carbon($all_date .'23:59:59');
                            $isWeekday = false;
                            $isWeekend = false;

                            $isWeekday = $firstDate->isWeekday();
                            $isWeekend =  $firstDate->isWeekend();

                            if($isWeekday){
                                $isFriday = $firstDate->format('l');
                                if($isFriday=='Friday'){
                                    $copies = RouteSchedulerMSTR::whereIn('trip_type', [1,3,5,7,12,13])
                                    ->where('status', 1)
                                    ->where('route_id', $selectedRoute->id)
                                    ->count();
                                }else{
                                    $copies = RouteSchedulerMSTR::whereIn('trip_type', [1,3,5,4,6,9,10])
                                    ->where('status', 1)
                                    ->where('route_id', $selectedRoute->id)
                                    ->count();
                                }
                            }
                            if($isWeekend){
                                $isSunday = $firstDate->format('l');
                                if($isSunday=='Sunday'){
                                    $copies = RouteSchedulerMSTR::whereIn('trip_type', [2,3,4,10,11,13])
                                    ->where('route_id', $selectedRoute->id)
                                    ->where('status', 1)
                                    ->count();
                                }else{
                                    $copies = RouteSchedulerMSTR::whereIn('trip_type', [2,3,4,5,8,9,12,13])
                                    ->where('status', 1)
                                    ->where('route_id', $selectedRoute->id)
                                    ->count();
                                }
                                
                            }
                            $totalTripPlanned = $copies;
                            $totalKMPlanned = $selectedRoute->inbound_distance * $copies;

                            $schedules = RouteSchedulerDetail::whereBetween('schedule_date', [$firstDate, $lastDate])->get();
        
                            // if (count($schedules) > 0) {
                            //     foreach ($schedules as $schedule) {
                            //         if ($schedule->RouteScheduleMSTR->route_id == $selectedRoute->id) {
                            //             if ($schedule->RouteScheduleMSTR->trip_code == 0){
                            //                 $tripPlannedOut++;
                            //                 $kmInbound += $schedule->RouteScheduleMSTR->Route->outbound_distance;
                            //             }elseif ($schedule->RouteScheduleMSTR->trip_code == 1){
                            //                 $tripPlannedIn++;
                            //                 $kmOutbound += $schedule->RouteScheduleMSTR->Route->inbound_distance;
                            //             }
                            //         }
                            //     }
                            // }
                            // $totalTripPlanned = $tripPlannedOut + $tripPlannedIn;
                            // $totalKMPlanned = $kmInbound + $kmOutbound;
        
                            $allTrips = TripDetail::where('route_id', $selectedRoute->id)
                                ->whereBetween('start_trip', [$firstDate, $lastDate])
                                ->get();
        
                            if (count($allTrips) > 0) {
                                foreach ($allTrips as $allTrip) {
                                    //Total KM Service Served
                                    if($allTrip->trip_code==0){
                                        $tripServedOut++;
                                        $kmServed = $allTrip->Route->outbound_distance;
                                    }else{
                                        $tripServedIn++;
                                        $kmServed = $allTrip->Route->inbound_distance;
                                    }
                                    $totalKMServed += $kmServed;
        
                                    //Early-Late
                                    if (count($schedules) > 0) {
                                        foreach ($schedules as $schedule) {
                                            if ($schedule->RouteScheduleMSTR->route_id == $selectedRoute->id) {
                                                if ($schedule->RouteScheduleMSTR->id == $allTrip->route_schedule_mstr_id) {
                                                    $diff = strtotime($schedule->schedule_start_time) - strtotime($allTrip->start_trip);
                                                    if ($diff > 5 || $diff < -5) {
                                                        $earlyLateCount++;
                                                    }
                                                }
                                            }
                                        }
                                    }
        
                                    //Ridership Based On Count
                                    $ridershipCount = $allTrip->total_adult + $allTrip->total_concession;
                                    $totalRidershipCount += $ridershipCount;
        
                                    //Ridership Based On Ticket Sales
                                    $ridershipTicket = TicketSalesTransaction::where('trip_number', $allTrip->trip_number)->count();
                                    $totalRidershipTicket += $ridershipTicket;
        
                                    //Farebox Collection
                                    $farebox = $allTrip->total_adult_amount + $allTrip->total_concession_amount;
                                    if($farebox==0){
                                        $checkTickets = TicketSalesTransaction::where('trip_number', $allTrip->trip_number)->get();
                                        if(count($checkTickets)>0){
                                            foreach($checkTickets as $checkTicket){
                                                $farebox += $checkTicket->actual_amount;
                                            }
                                        }
                                    }
                                    $totalFarebox += $farebox;
                                }
                            }
        
                            //Total Trip Served
                            $totalTripServed = count($allTrips);
        
                            //Total Missed Trip
                            $diffIn = $tripPlannedIn - $tripServedIn;
                            $diffOut = $tripPlannedOut - $tripServedOut;
                            if($diffIn>0){
                                if($diffOut>0){
                                    $totalMissedTrip = $diffIn + $diffOut;
                                }else{
                                    $totalMissedTrip = $diffIn;
                                }
                            }else{
                                if($diffOut>0){
                                    $totalMissedTrip = $diffOut;
                                }else{
                                    $totalMissedTrip = 0;
                                }
                            }
        
                            /**Total Breakdown & Total Accidents need to revise**/
                            $totalBreakdown = 0;
                            $totalAccidents = 0;
        
                            if ($firstDate->isWeekDay()) {
                                $trip_perDate['day'] = "WEEKDAY";
                            } elseif ($firstDate->isWeekend()) {
                                $trip_perDate['day'] = "WEEKEND";
                            }
        
                            //total per date
                            $trip_perDate['total_trip_planned'] = $totalTripPlanned;
                            $trip_perDate['total_km_planned'] = $totalKMPlanned;
                            $trip_perDate['total_trip_served'] = $totalTripServed;
                            $trip_perDate['total_km_served'] = $totalKMServed;
                            $trip_perDate['total_missed_trip'] = $totalMissedTrip;
                            $trip_perDate['total_early_late'] = $earlyLateCount;
                            $trip_perDate['total_breakdown'] = $totalBreakdown;
                            $trip_perDate['total_accidents'] = $totalAccidents;
                            $trip_perDate['total_ridership_count'] = $totalRidershipCount;
                            $trip_perDate['total_ridership_tickets'] = $totalRidershipTicket;
                            $trip_perDate['total_farebox'] = $totalFarebox;
        
                            $data_perDate[$all_date] = $trip_perDate;
        
                            $routeTripPlanned += $trip_perDate['total_trip_planned'];
                            $routeKMPlanned += $trip_perDate['total_km_planned'];
                            $routeKMServed += $trip_perDate['total_km_served'];
                            $routeTripServed += $trip_perDate['total_trip_served'];
                            $routeMissedTrip += $trip_perDate['total_missed_trip'];
                            $routeEarlyLate += $trip_perDate['total_early_late'];
                            $routeBreakdown += $trip_perDate['total_breakdown'];
                            $routeAccidents += $trip_perDate['total_accidents'];
                            $routeRidershipCount += $trip_perDate['total_ridership_count'];
                            $routeRidershipTicket += $trip_perDate['total_ridership_tickets'];
                            $routeFarebox += $trip_perDate['total_farebox'];
                        }
        
                        //total per route
                        $trip_perRoute['total_trip_planned'] = $routeTripPlanned;
                        $trip_perRoute['total_km_planned'] = $routeKMPlanned;
                        $trip_perRoute['total_trip_served'] = $routeTripServed;
                        $trip_perRoute['total_km_served'] = $routeKMServed;
                        $trip_perRoute['total_missed_trip'] = $routeMissedTrip;
                        $trip_perRoute['total_early_late'] = $routeEarlyLate;
                        $trip_perRoute['total_breakdown'] = $routeBreakdown;
                        $trip_perRoute['total_accidents'] = $routeAccidents;
                        $trip_perRoute['total_ridership_count'] = $routeRidershipCount;
                        $trip_perRoute['total_ridership_tickets'] = $routeRidershipTicket;
                        $trip_perRoute['total_farebox'] = $routeFarebox;
        
                        $data_perDate['total_per_route'] = $trip_perRoute;
                        $data_perRoute[$selectedRoute->route_number . ' - ' . $selectedRoute->route_name] = $data_perDate;
        
                        $data_perRoute['total_per_company'] = $trip_perRoute;
                        $data_perCompany[$companyDetails->company_name] = $data_perRoute;
        
                        $data_grand['all_company'] = $data_perCompany;
                        $data_grand['grand'] = $trip_perRoute;
                        $summaryByRoute->add($data_grand);
                    }
                }
            }
            return Excel::download(new SPADSummaryByRoute($summaryByRoute, $validatedData['dateFrom'], $validatedData['dateTo'], $networkArea), 'Summary_By_Route_Report_SPAD_'.Carbon::now()->format('YmdHis').'.xlsx');
        }else{
            $this->dispatchBrowserEvent('company-required');
        }
    }

    //FAST
    public function printSummaryRoute(){
        $out = new ConsoleOutput();
        $out->writeln("YOU ARE IN printDailySummary()");

        $validatedData = Validator::make($this->state,[
            'dateFrom' => ['required', 'date'],
            'dateTo' => ['required', 'date'],
            'route_id' => ['required'],
        ])->validate();

        $dateFrom = new Carbon($validatedData['dateFrom']);
        $dateTo = new Carbon($validatedData['dateTo'] . " 23:59:59");
        $startDayNo = $dateFrom->format('d');
        $endDayNo = $dateTo->format('d');
        $startDate = new Carbon($validatedData['dateFrom']);
        $endDate = new Carbon($validatedData['dateTo'] . " 23:59:59");
        $all_dates = array();
        
        while ($startDate->lte($endDate)) {
            $all_dates[] = $startDate->toDateString();
            $startDate->addDay();
        }

        if ($this->selectedCompany){
            if($this->selectedCompany=='All'){
                $networkArea = 'All';
                //Daily Summary all route all company
                if($validatedData['route_id']=='All'){

                    $getAllRoutes = Route::where('status', 1)->orderBy('company_id')->orderBy('route_number')->get();
                    $allTrips = [];

                    foreach($getAllRoutes as $allRoute){
                        $out->writeln("All Route: " . $allRoute->route_number);
                        $tripPerRoute = DB::select("WITH RECURSIVE n_dte (n) AS (
                            SELECT " . $startDayNo . "
                            UNION ALL
                            SELECT n + 1
                            FROM n_dte
                            WHERE n < " . $endDayNo . "
                            ),
                            all_mnth_days AS (
                            SELECT route.id as route_id, route.route_number, route.route_name, route.company_id,
                            DATE_ADD(MIN(trip_details.start_trip), INTERVAL - DAY(MIN(trip_details.start_trip)) + 1 DAY) AS mnth_first_day,
                            n,
                            CAST(DATE_ADD(DATE_ADD(MIN(trip_details.start_trip), INTERVAL - DAY(MIN(trip_details.start_trip)) + 1 DAY), INTERVAL n - 1 DAY) AS DATE) AS all_days_in_mnth
                            FROM mybas.trip_details
                            JOIN n_dte
                            JOIN mybas.route ON route.id = trip_details.route_id
                            WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND route.id = '". $allRoute->id . "'
                            group by n
                            ORDER BY n ASC)
                            
                            SELECT
                            amd.all_days_in_mnth AS service_date, amd.route_id, amd.route_number, amd.route_name, amd.company_id, 
                            (case when (count(ie.id) IS NULL) THEN 0 ELSE count(ie.id) END) as trip_served,
                            (case when (SUM(ie.total_mileage) IS NULL) THEN 0 ELSE SUM(ie.total_mileage) END) as km_served,
                            (case when (SUM(ie.total_adult_amount) + SUM(ie.total_concession_amount) IS NULL) THEN 0 
                            ELSE SUM(ie.total_adult_amount) + SUM(ie.total_concession_amount) END) AS farebox, 
                            (case when (SUM(ie.total_adult) + SUM(ie.total_concession) IS NULL) THEN 0 
                            ELSE SUM(ie.total_adult) + SUM(ie.total_concession) END) AS ridership
                            FROM all_mnth_days AS amd
                            LEFT JOIN trip_details AS ie ON CAST(ie.start_trip AS DATE) = amd.all_days_in_mnth
                            AND ie.route_id = amd.route_id
                            GROUP BY service_date;");

                        $noTripArr = [];
                        if(!$tripPerRoute){
                            $out->writeln("In tripPerRoute < 0");
                            foreach($all_dates as $all_date){
                                $noTrip = new \stdClass;
                                $noTrip->service_date = $all_date;
                                $noTrip->route_id = $allRoute->id;
                                $noTrip->route_number = $allRoute->route_number;
                                $noTrip->route_name = $allRoute->route_name;
                                $noTrip->company_id = $allRoute->company_id;
                                $noTrip->trip_served = 0;
                                $noTrip->km_served = 0.00;
                                $noTrip->farebox = 0.00;
                                $noTrip->ridership = 0;

                                $noTripArr[] = $noTrip;
                            }
                            $allTrips = array_merge($allTrips, $noTripArr);
                        }else{
                            $out->writeln("In tripPerRoute > 0");
                            $allTrips = array_merge($allTrips, $tripPerRoute);
                        }
                        //$allTrips = array_merge($allTrips, $tripPerRoute);
                        //$allTrips[$routeNo] = $tripPerRoute;
                    }

                    //Trip Planned
                    $tripPlanned = DB::select("SELECT route.route_number, route.route_name, cast(route_scheduler_details.schedule_date as date) as planned_date,
                    count(route_scheduler_details.id) as trip_planned, 
                    count(route_scheduler_details.id) * route.distance as km_planned
                    FROM mybas.route
                    JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                    JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                    WHERE route_scheduler_details.schedule_date BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                    AND route.status = 1
                    GROUP BY planned_date, route_number
                    ORDER BY route_number;");

                    $lastKey = array_key_last($allTrips);
                    $pastNo = "";
                    $pastCompany = "";
                    $count = 0;
                    $countMissedTrip = 0;
                    $countMissedTripPerRoute = 0;
                    $countMissedTripGrand = 0;
                    $currTotServedPerRoute = [];
                    $currTotPlannedPerRoute = [];
                    $currTotServedPerCompany = [];
                    $currTotPlannedPerCompany = [];
                    foreach($allTrips as $key => $allTrip){
                        $out->writeln("New Loop: " . $key . " - " . $allTrip->route_number . " - " . $allTrip->service_date . " ");
                        $startDay = new Carbon($allTrip->service_date);
                        $endDay = new Carbon($allTrip->service_date . '23:59:59');
                        if ($startDay->isWeekDay()) {
                            $allTrip->day = "WEEKDAY";
                        } elseif ($startDay->isWeekend()) {
                            $allTrip->day = "WEEKEND";
                        }
                        $found = false;

                        //Enter total per route
                        if($allTrip->route_number!= $pastNo && $pastNo != NULL){
                            $out->writeln("Inside Splice Total Route Loop: " . $key . " - " . $allTrip->route_number . " - " . $allTrip->service_date . " ");
                            $out->writeln("up count: " . $count);

                            if($count==0){
                                array_splice($allTrips, $key, 0, $currTotServedPerRoute);
                            }else{
                                $newKey = $key + $count;
                                $out->writeln("newKey: " . $newKey);
                                array_splice($allTrips, $newKey, 0, $currTotServedPerRoute);
                            }
                            $count++;
                            $countMissedTripPerRoute = 0;
                            $out->writeln("low count: " . $count);
                        }

                        //Enter total per company
                        if($allTrip->company_id != $pastCompany && $pastCompany != NULL){
                            $out->writeln("Inside Splice Total Company Loop: " . $key . " - " . $allTrip->route_number . " - " . $allTrip->service_date . " ");
                            $out->writeln("up count: " . $count);

                            if($count==0){
                                array_splice($allTrips, $key, 0, $currTotServedPerCompany);
                            }else{
                                $newKey = $key + $count;
                                $out->writeln("newKey: " . $newKey);
                                array_splice($allTrips, $newKey, 0, $currTotServedPerCompany);
                            }
                            $count++;
                            $countMissedTrip = 0;
                            $out->writeln("low count: " . $count);
                        }
                        foreach($tripPlanned as $key2 => $tripPlan){
                            if($tripPlan->route_number == $allTrip->route_number){
                                if($tripPlan->planned_date == $allTrip->service_date){
                                    $allTrip->trip_planned = $tripPlan->trip_planned;
                                    $allTrip->km_planned = $tripPlan->km_planned;

                                    //Total Missed Trip
                                    $diff= $tripPlan->trip_planned - $allTrip->trip_served;
                                    if($diff>0){
                                        $allTrip->missed_trip = $diff;
                                        $countMissedTrip += $diff;
                                        $countMissedTripPerRoute += $diff;
                                        $countMissedTripGrand += $diff;
                                    }else{
                                        $allTrip->missed_trip = 0;
                                    }

                                    $found = true;
                                    break ;
                                }
                            }
                        }
                        if(!$found){
                            $allTrip->trip_planned = 0;
                            $allTrip->km_planned = 0;
                            $allTrip->missed_trip = 0;
                        }
                        
                        //Early Late
                        $earlyLateCount = DB::select("SELECT count(trip_details.id) as countEarlyLate
                        FROM trip_details
                        WHERE trip_details.id IN ( 
                        SELECT trip_details.id
                        FROM mybas.trip_details
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.id = trip_details.route_schedule_mstr_id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE trip_details.start_trip BETWEEN '" . $startDay . "' AND '" . $endDay . "'
                        AND trip_details.route_id =  " . $allTrip->route_id . "
                        AND (TIMEDIFF(route_scheduler_mstr.schedule_start_time, cast(trip_details.start_trip as TIME)) < '-00:05:00'
                        OR TIMEDIFF(route_scheduler_mstr.schedule_start_time, cast(trip_details.start_trip as TIME)) > '00:05:00')
                        GROUP BY trip_details.id);");

                        foreach($earlyLateCount as $key3 => $earlyLate){
                            $allTrip->earlyLate = $earlyLate->countEarlyLate;
                        }

                        $currTotServedPerRoute = DB::select("SELECT route.route_number, route.route_name, company.company_name, count(trip_details.id) as trip_served, 
                        SUM(trip_details.total_mileage) as km_served,
                        SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                        SUM(total_adult) + SUM(total_concession) AS ridership
                        FROM mybas.trip_details
                        JOIN mybas.route ON route.id = trip_details.route_id
                        JOIN mybas.company ON company.id = route.company_id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND route.route_number = '" . $allTrip->route_number . "'
                        GROUP BY route_number
                        ORDER BY route.company_id, route_number;");

                        $currTotPlannedPerRoute = DB::select("SELECT route.route_number, route.route_name, cast(route_scheduler_details.schedule_date as date) as planned_date,
                        count(route_scheduler_details.id) as trip_planned, 
                        count(route_scheduler_details.id) * route.distance as km_planned
                        FROM mybas.route
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE route_scheduler_details.schedule_date BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND route.route_number = '" . $allTrip->route_number . "'
                        GROUP BY route.route_number
                        ORDER BY route.route_number;");

                        $found = false;
                        if($currTotServedPerRoute){
                            foreach($currTotServedPerRoute as $key4 => $totalTripServe){
                                //Early Late Per Route
                                $earlyLateCountPerRoute = DB::select("SELECT count(trip_details.id) as countEarlyLate
                                FROM trip_details
                                WHERE trip_details.id IN ( 
                                SELECT trip_details.id
                                FROM mybas.trip_details
                                JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.id = trip_details.route_schedule_mstr_id
                                JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                                WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                                AND trip_details.route_id =  " . $allTrip->route_id . "
                                AND (TIMEDIFF(route_scheduler_mstr.schedule_start_time, cast(trip_details.start_trip as TIME)) < '-00:05:00'
                                OR TIMEDIFF(route_scheduler_mstr.schedule_start_time, cast(trip_details.start_trip as TIME)) > '00:05:00')
                                GROUP BY trip_details.id);");

                                foreach($earlyLateCountPerRoute as $key5 => $earlyLatePerRoute){
                                    $totalTripServe->earlyLate = $earlyLatePerRoute->countEarlyLate;
                                }

                                foreach($currTotPlannedPerRoute as $key6 => $totalTripPlan){
                                    $totalTripServe->trip_planned = $totalTripPlan->trip_planned;
                                    $totalTripServe->km_planned = $totalTripPlan->km_planned;

                                    //Total Missed Trip Ver 2
                                    $totalTripServe->missed_trip = $countMissedTripPerRoute;

                                    $found = true;
                                    break ;
                                }
                                if(!$found){
                                    $totalTripServe->trip_planned = 0;
                                    $totalTripServe->km_planned = 0;
                                    $totalTripServe->missed_trip = 0;
                                }
                            }
                        }else{
                            $noTrip = new \stdClass;
                            $noTrip->route_number = $allTrip->route_number;
                            $noTrip->route_name = $allTrip->route_name;
                            $noTrip->company_id = $allTrip->company_id;
                            $noTrip->trip_served = 0;
                            $noTrip->km_served = 0.00;
                            $noTrip->farebox = 0.00;
                            $noTrip->ridership = 0;
                            $noTrip->earlyLate = 0;
                            
                            foreach($currTotPlannedPerRoute as $key6 => $totalTripPlan){
                                $noTrip->trip_planned = $totalTripPlan->trip_planned;
                                $noTrip->km_planned = $totalTripPlan->km_planned;

                                //Total Missed Trip Ver 2
                                $noTrip->missed_trip = $countMissedTripPerRoute;

                                $found = true;
                                break ;
                            }
                            if(!$found){
                                $noTrip->trip_planned = 0;
                                $noTrip->km_planned = 0;
                                $noTrip->missed_trip = 0;
                            }
                            $currTotServedPerRoute[] = $noTrip;
                        }
                        $pastNo = $allTrip->route_number;

                        $currTotServedPerCompany = DB::select("SELECT company.company_name, count(trip_details.id) as trip_served, 
                        SUM(trip_details.total_mileage) as km_served,
                        SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                        SUM(total_adult) + SUM(total_concession) AS ridership
                        FROM mybas.trip_details
                        JOIN mybas.route ON route.id = trip_details.route_id
                        JOIN mybas.company ON company.id = route.company_id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND route.company_id = " . $allTrip->company_id . "
                        AND route.status = 1;");

                        $currTotPlannedPerCompany = DB::select("SELECT company.company_name, count(route_scheduler_details.id) as trip_planned, 
                        count(route_scheduler_details.id) * route.distance as km_planned
                        FROM mybas.route
                        JOIN mybas.company ON company.id = route.company_id
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE route_scheduler_details.schedule_date BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND route.company_id = " . $allTrip->company_id . "
                        AND route.status = 1;");

                        $found = false;
                        foreach($currTotServedPerCompany as $key7 => $companyTripServe){
                            //Early Late Per Company
                            $earlyLateCountPerCompany = DB::select("SELECT count(trip_details.id) as countEarlyLate
                            FROM trip_details
                            WHERE trip_details.id IN ( 
                            SELECT trip_details.id
                            FROM mybas.trip_details
                            JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.id = trip_details.route_schedule_mstr_id
                            JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                            WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND trip_details.route_id IN (SELECT id FROM mybas.route WHERE company_id = " . $allTrip->company_id . ")
                            AND (TIMEDIFF(route_scheduler_mstr.schedule_start_time, cast(trip_details.start_trip as TIME)) < '-00:05:00'
                            OR TIMEDIFF(route_scheduler_mstr.schedule_start_time, cast(trip_details.start_trip as TIME)) > '00:05:00')
                            GROUP BY trip_details.id);");

                            foreach($earlyLateCountPerCompany  as $key5 => $earlyLatePerCompany){
                                $companyTripServe->earlyLate = $earlyLatePerCompany->countEarlyLate;
                            }

                            foreach($currTotPlannedPerCompany as $key8 => $companyTripPlan){
                                $companyTripServe->trip_planned = $companyTripPlan->trip_planned;
                                $companyTripServe->km_planned = $companyTripPlan->km_planned;

                                //Total Missed Trip Ver 2
                                $companyTripServe->missed_trip = $countMissedTrip;

                                $found = true;
                                break ;
                            }
                            if(!$found){
                                $companyTripServe->trip_planned = 0;
                                $companyTripServe->km_planned = 0;
                                $companyTripServe->missed_trip = 0;
                            }
                        }
                        $pastCompany = $allTrip->company_id;

                        if($lastKey==$key){
                            $grandTotServed = DB::select("SELECT count(trip_details.id) as trip_served, 
                            SUM(trip_details.total_mileage) as km_served,
                            SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                            SUM(total_adult) + SUM(total_concession) AS ridership
                            FROM mybas.trip_details
                            JOIN mybas.route ON route.id = trip_details.route_id
                            WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND route.status = 1;");

                            $grandTotPlanned = DB::select("SELECT count(route_scheduler_details.id) as trip_planned, 
                            count(route_scheduler_details.id) * route.distance as km_planned
                            FROM mybas.route
                            JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                            JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                            WHERE route_scheduler_details.schedule_date BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND route.status = 1;");

                            foreach($grandTotServed as $grandInKey => $grandServed){
                                $out->writeln("In grand total loop");
                                //Early Late
                                $grandTotEarlyLate = DB::select("SELECT count(trip_details.id) as countEarlyLate
                                FROM trip_details
                                WHERE trip_details.id IN ( 
                                SELECT trip_details.id
                                FROM mybas.trip_details
                                JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.id = trip_details.route_schedule_mstr_id
                                JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                                WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                                AND (TIMEDIFF(route_scheduler_mstr.schedule_start_time, cast(trip_details.start_trip as TIME)) < '-00:05:00'
                                OR TIMEDIFF(route_scheduler_mstr.schedule_start_time, cast(trip_details.start_trip as TIME)) > '00:05:00'));");

                                foreach($grandTotEarlyLate as $grandEarlyLateKey => $grandEarlyLate){
                                    $grandServed->earlyLate = $grandEarlyLate->countEarlyLate;
                                }

                                foreach($grandTotPlanned as $grandPlanKey => $grandPlanned){
                                    $grandServed->trip_planned = $grandPlanned->trip_planned;
                                    $grandServed->km_planned = $grandPlanned->km_planned;
                                    $grandServed->missed_trip = $countMissedTripGrand;
                                }
                            }

                            $newKey = $key + $count+1;
                            $out->writeln("last newKey: " . $newKey);
                            array_splice($allTrips, $newKey, 0, $grandTotServed);
                            array_splice($allTrips, $newKey, 0, $currTotServedPerCompany);
                            array_splice($allTrips, $newKey, 0, $currTotServedPerRoute);
                        }
                    }
                }
            }else{
                $companyDetails = Company::where('id', $this->selectedCompany)->first();
                $networkArea = $companyDetails->company_name;
                //Daily Summary all route specific company
                if($validatedData['route_id']=='All'){

                    $getAllRoutes = Route::where('status', 1)
                        ->where('company_id', $companyDetails->id)
                        ->orderBy('company_id')
                        ->orderBy('route_number')
                        ->get();
                    $allTrips = [];

                    foreach($getAllRoutes as $allRoute){
                        $out->writeln("All Route: " . $allRoute->route_number);
                        $tripPerRoute = DB::select("WITH RECURSIVE n_dte (n) AS (
                            SELECT  " . $startDayNo . "
                            UNION ALL
                            SELECT n + 1
                            FROM n_dte
                            WHERE n < " . $endDayNo . "
                            ),
                            all_mnth_days AS (
                            SELECT route.id as route_id, route.route_number, route.route_name, route.company_id,
                            DATE_ADD(MIN(trip_details.start_trip), INTERVAL - DAY(MIN(trip_details.start_trip)) + 1 DAY) AS mnth_first_day,
                            n,
                            CAST(DATE_ADD(DATE_ADD(MIN(trip_details.start_trip), INTERVAL - DAY(MIN(trip_details.start_trip)) + 1 DAY), INTERVAL n - 1 DAY) AS DATE) AS all_days_in_mnth
                            FROM mybas.trip_details
                            JOIN n_dte
                            JOIN mybas.route ON route.id = trip_details.route_id
                            WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND route.id = '". $allRoute->id . "'
                            group by n
                            ORDER BY n ASC)
                            
                            SELECT
                            amd.all_days_in_mnth AS service_date, amd.route_id, amd.route_number, amd.route_name, amd.company_id, 
                            (case when (count(ie.id) IS NULL) THEN 0 ELSE count(ie.id) END) as trip_served,
                            (case when (SUM(ie.total_mileage) IS NULL) THEN 0 ELSE SUM(ie.total_mileage) END) as km_served,
                            (case when (SUM(ie.total_adult_amount) + SUM(ie.total_concession_amount) IS NULL) THEN 0 
                            ELSE SUM(ie.total_adult_amount) + SUM(ie.total_concession_amount) END) AS farebox, 
                            (case when (SUM(ie.total_adult) + SUM(ie.total_concession) IS NULL) THEN 0 
                            ELSE SUM(ie.total_adult) + SUM(ie.total_concession) END) AS ridership
                            FROM all_mnth_days AS amd
                            LEFT JOIN trip_details AS ie ON CAST(ie.start_trip AS DATE) = amd.all_days_in_mnth
                            AND ie.route_id = amd.route_id
                            GROUP BY service_date;");

                        $noTripArr = [];
                        if(!$tripPerRoute){
                            $out->writeln("In tripPerRoute < 0");
                            foreach($all_dates as $all_date){
                                $noTrip = new \stdClass;
                                $noTrip->service_date = $all_date;
                                $noTrip->route_id = $allRoute->id;
                                $noTrip->route_number = $allRoute->route_number;
                                $noTrip->route_name = $allRoute->route_name;
                                $noTrip->company_id = $allRoute->company_id;
                                $noTrip->trip_served = 0;
                                $noTrip->km_served = 0.00;
                                $noTrip->farebox = 0.00;
                                $noTrip->ridership = 0;

                                $noTripArr[] = $noTrip;
                            }
                            $allTrips = array_merge($allTrips, $noTripArr);
                        }else{
                            $out->writeln("In tripPerRoute > 0");
                            $allTrips = array_merge($allTrips, $tripPerRoute);
                        }
                        //$allTrips = array_merge($allTrips, $tripPerRoute);
                        //$allTrips[$routeNo] = $tripPerRoute;
                    }

                    //Trip Planned
                    $tripPlanned = DB::select("SELECT route.route_number, route.route_name, cast(route_scheduler_details.schedule_date as date) as planned_date,
                    count(route_scheduler_details.id) as trip_planned, 
                    count(route_scheduler_details.id) * route.distance as km_planned
                    FROM mybas.route
                    JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                    JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                    WHERE route_scheduler_details.schedule_date BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                    AND route.status = 1
                    GROUP BY planned_date, route_number
                    ORDER BY route_number;");

                    $lastKey = array_key_last($allTrips);
                    $pastNo = "";
                    $pastCompany = "";
                    $count = 0;
                    $countMissedTrip = 0;
                    $countMissedTripPerRoute = 0;
                    $countMissedTripGrand = 0;
                    $currTotServedPerRoute = [];
                    $currTotPlannedPerRoute = [];
                    $currTotServedPerCompany = [];
                    $currTotPlannedPerCompany = [];
                    foreach($allTrips as $key => $allTrip){
                        $out->writeln("New Loop: " . $key . " - " . $allTrip->route_number . " - " . $allTrip->service_date . " ");
                        $startDay = new Carbon($allTrip->service_date);
                        $endDay = new Carbon($allTrip->service_date . '23:59:59');
                        if ($startDay->isWeekDay()) {
                            $allTrip->day = "WEEKDAY";
                        } elseif ($startDay->isWeekend()) {
                            $allTrip->day = "WEEKEND";
                        }
                        $found = false;

                        //Enter total per route
                        if($allTrip->route_number!= $pastNo && $pastNo != NULL){
                            $out->writeln("Inside Splice Total Route Loop: " . $key . " - " . $allTrip->route_number . " - " . $allTrip->service_date . " ");
                            $out->writeln("up count: " . $count);

                            if($count==0){
                                array_splice($allTrips, $key, 0, $currTotServedPerRoute);
                            }else{
                                $newKey = $key + $count;
                                $out->writeln("newKey: " . $newKey);
                                array_splice($allTrips, $newKey, 0, $currTotServedPerRoute);
                            }
                            $count++;
                            $countMissedTripPerRoute = 0;
                            $out->writeln("low count: " . $count);
                        }

                        //Enter total per company
                        if($allTrip->company_id != $pastCompany && $pastCompany != NULL){
                            $out->writeln("Inside Splice Total Company Loop: " . $key . " - " . $allTrip->route_number . " - " . $allTrip->service_date . " ");
                            $out->writeln("up count: " . $count);

                            if($count==0){
                                array_splice($allTrips, $key, 0, $currTotServedPerCompany);
                            }else{
                                $newKey = $key + $count;
                                $out->writeln("newKey: " . $newKey);
                                array_splice($allTrips, $newKey, 0, $currTotServedPerCompany);
                            }
                            $count++;
                            $countMissedTrip = 0;
                            $out->writeln("low count: " . $count);
                        }
                        foreach($tripPlanned as $key2 => $tripPlan){
                            if($tripPlan->route_number == $allTrip->route_number){
                                if($tripPlan->planned_date == $allTrip->service_date){
                                    $allTrip->trip_planned = $tripPlan->trip_planned;
                                    $allTrip->km_planned = $tripPlan->km_planned;

                                    //Total Missed Trip
                                    $diff= $tripPlan->trip_planned - $allTrip->trip_served;
                                    if($diff>0){
                                        $allTrip->missed_trip = $diff;
                                        $countMissedTrip += $diff;
                                        $countMissedTripPerRoute += $diff;
                                        $countMissedTripGrand += $diff;
                                    }else{
                                        $allTrip->missed_trip = 0;
                                    }

                                    $found = true;
                                    break ;
                                }
                            }
                        }
                        if(!$found){
                            $allTrip->trip_planned = 0;
                            $allTrip->km_planned = 0;
                            $allTrip->missed_trip = 0;
                        }
                        
                        //Early Late
                        $earlyLateCount = DB::select("SELECT count(trip_details.id) as countEarlyLate
                        FROM trip_details
                        WHERE trip_details.id IN ( 
                        SELECT trip_details.id
                        FROM mybas.trip_details
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.id = trip_details.route_schedule_mstr_id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE trip_details.start_trip BETWEEN '" . $startDay . "' AND '" . $endDay . "'
                        AND trip_details.route_id =  " . $allTrip->route_id . "
                        AND (TIMEDIFF(route_scheduler_mstr.schedule_start_time, cast(trip_details.start_trip as TIME)) < '-00:05:00'
                        OR TIMEDIFF(route_scheduler_mstr.schedule_start_time, cast(trip_details.start_trip as TIME)) > '00:05:00')
                        GROUP BY trip_details.id);");

                        foreach($earlyLateCount as $key3 => $earlyLate){
                            $allTrip->earlyLate = $earlyLate->countEarlyLate;
                        }

                        $currTotServedPerRoute = DB::select("SELECT route.route_number, route.route_name, company.company_name, count(trip_details.id) as trip_served, 
                        SUM(trip_details.total_mileage) as km_served,
                        SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                        SUM(total_adult) + SUM(total_concession) AS ridership
                        FROM mybas.trip_details
                        JOIN mybas.route ON route.id = trip_details.route_id
                        JOIN mybas.company ON company.id = route.company_id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND route.route_number = '" . $allTrip->route_number . "'
                        GROUP BY route_number
                        ORDER BY route.company_id, route_number;");

                        $currTotPlannedPerRoute = DB::select("SELECT route.route_number, route.route_name, cast(route_scheduler_details.schedule_date as date) as planned_date,
                        count(route_scheduler_details.id) as trip_planned, 
                        count(route_scheduler_details.id) * route.distance as km_planned
                        FROM mybas.route
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE route_scheduler_details.schedule_date BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND route.route_number = '" . $allTrip->route_number . "'
                        GROUP BY route.route_number
                        ORDER BY route.route_number;");

                        $found = false;
                        if($currTotServedPerRoute){
                            foreach($currTotServedPerRoute as $key4 => $totalTripServe){
                                //Early Late Per Route
                                $earlyLateCountPerRoute = DB::select("SELECT count(trip_details.id) as countEarlyLate
                                FROM trip_details
                                WHERE trip_details.id IN ( 
                                SELECT trip_details.id
                                FROM mybas.trip_details
                                JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.id = trip_details.route_schedule_mstr_id
                                JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                                WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                                AND trip_details.route_id =  " . $allTrip->route_id . "
                                AND (TIMEDIFF(route_scheduler_mstr.schedule_start_time, cast(trip_details.start_trip as TIME)) < '-00:05:00'
                                OR TIMEDIFF(route_scheduler_mstr.schedule_start_time, cast(trip_details.start_trip as TIME)) > '00:05:00')
                                GROUP BY trip_details.id);");

                                foreach($earlyLateCountPerRoute as $key5 => $earlyLatePerRoute){
                                    $totalTripServe->earlyLate = $earlyLatePerRoute->countEarlyLate;
                                }

                                foreach($currTotPlannedPerRoute as $key6 => $totalTripPlan){
                                    $totalTripServe->trip_planned = $totalTripPlan->trip_planned;
                                    $totalTripServe->km_planned = $totalTripPlan->km_planned;

                                    //Total Missed Trip Ver 2
                                    $totalTripServe->missed_trip = $countMissedTripPerRoute;

                                    $found = true;
                                    break ;
                                }
                                if(!$found){
                                    $totalTripServe->trip_planned = 0;
                                    $totalTripServe->km_planned = 0;
                                    $totalTripServe->missed_trip = 0;
                                }
                            }
                        }else{
                            $noTrip = new \stdClass;
                            $noTrip->route_number = $allTrip->route_number;
                            $noTrip->route_name = $allTrip->route_name;
                            $noTrip->company_id = $allTrip->company_id;
                            $noTrip->trip_served = 0;
                            $noTrip->km_served = 0.00;
                            $noTrip->farebox = 0.00;
                            $noTrip->ridership = 0;
                            $noTrip->earlyLate = 0;
                            
                            foreach($currTotPlannedPerRoute as $key6 => $totalTripPlan){
                                $noTrip->trip_planned = $totalTripPlan->trip_planned;
                                $noTrip->km_planned = $totalTripPlan->km_planned;

                                //Total Missed Trip Ver 2
                                $noTrip->missed_trip = $countMissedTripPerRoute;

                                $found = true;
                                break ;
                            }
                            if(!$found){
                                $noTrip->trip_planned = 0;
                                $noTrip->km_planned = 0;
                                $noTrip->missed_trip = 0;
                            }
                            $currTotServedPerRoute[] = $noTrip;
                        }
                        $pastNo = $allTrip->route_number;

                        $currTotServedPerCompany = DB::select("SELECT company.company_name, count(trip_details.id) as trip_served, 
                        SUM(trip_details.total_mileage) as km_served,
                        SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                        SUM(total_adult) + SUM(total_concession) AS ridership
                        FROM mybas.trip_details
                        JOIN mybas.route ON route.id = trip_details.route_id
                        JOIN mybas.company ON company.id = route.company_id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND route.company_id = " . $allTrip->company_id . "
                        AND route.status = 1;");

                        $currTotPlannedPerCompany = DB::select("SELECT company.company_name, count(route_scheduler_details.id) as trip_planned, 
                        count(route_scheduler_details.id) * route.distance as km_planned
                        FROM mybas.route
                        JOIN mybas.company ON company.id = route.company_id
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE route_scheduler_details.schedule_date BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND route.company_id = " . $allTrip->company_id . "
                        AND route.status = 1;");

                        $found = false;
                        foreach($currTotServedPerCompany as $key7 => $companyTripServe){
                            //Early Late Per Company
                            $earlyLateCountPerCompany = DB::select("SELECT count(trip_details.id) as countEarlyLate
                            FROM trip_details
                            WHERE trip_details.id IN ( 
                            SELECT trip_details.id
                            FROM mybas.trip_details
                            JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.id = trip_details.route_schedule_mstr_id
                            JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                            WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND trip_details.route_id IN (SELECT id FROM mybas.route WHERE company_id = " . $allTrip->company_id . ")
                            AND (TIMEDIFF(route_scheduler_mstr.schedule_start_time, cast(trip_details.start_trip as TIME)) < '-00:05:00'
                            OR TIMEDIFF(route_scheduler_mstr.schedule_start_time, cast(trip_details.start_trip as TIME)) > '00:05:00')
                            GROUP BY trip_details.id);");

                            foreach($earlyLateCountPerCompany  as $key5 => $earlyLatePerCompany){
                                $companyTripServe->earlyLate = $earlyLatePerCompany->countEarlyLate;
                            }

                            foreach($currTotPlannedPerCompany as $key8 => $companyTripPlan){
                                $companyTripServe->trip_planned = $companyTripPlan->trip_planned;
                                $companyTripServe->km_planned = $companyTripPlan->km_planned;

                                //Total Missed Trip Ver 2
                                $companyTripServe->missed_trip = $countMissedTrip;

                                $found = true;
                                break ;
                            }
                            if(!$found){
                                $companyTripServe->trip_planned = 0;
                                $companyTripServe->km_planned = 0;
                                $companyTripServe->missed_trip = 0;
                            }
                        }
                        $pastCompany = $allTrip->company_id;

                        if($lastKey==$key){
                            $grandTotServed = DB::select("SELECT count(trip_details.id) as trip_served, 
                            SUM(trip_details.total_mileage) as km_served,
                            SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                            SUM(total_adult) + SUM(total_concession) AS ridership
                            FROM mybas.trip_details
                            JOIN mybas.route ON route.id = trip_details.route_id
                            WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND route.company_id = " . $allTrip->company_id . "
                            AND route.status = 1;");

                            $grandTotPlanned = DB::select("SELECT count(route_scheduler_details.id) as trip_planned, 
                            count(route_scheduler_details.id) * route.distance as km_planned
                            FROM mybas.route
                            JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                            JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                            WHERE route_scheduler_details.schedule_date BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND route.company_id = " . $allTrip->company_id . "
                            AND route.status = 1;");

                            foreach($grandTotServed as $grandInKey => $grandServed){
                                $out->writeln("In grand total loop");
                                //Early Late
                                $grandTotEarlyLate = DB::select("SELECT count(trip_details.id) as countEarlyLate
                                FROM trip_details
                                WHERE trip_details.id IN ( 
                                SELECT trip_details.id
                                FROM mybas.trip_details
                                JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.id = trip_details.route_schedule_mstr_id
                                JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                                WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                                AND trip_details.route_id IN (SELECT id FROM mybas.route WHERE company_id = " . $allTrip->company_id . ")
                                AND (TIMEDIFF(route_scheduler_mstr.schedule_start_time, cast(trip_details.start_trip as TIME)) < '-00:05:00'
                                OR TIMEDIFF(route_scheduler_mstr.schedule_start_time, cast(trip_details.start_trip as TIME)) > '00:05:00'));");

                                foreach($grandTotEarlyLate as $grandEarlyLateKey => $grandEarlyLate){
                                    $grandServed->earlyLate = $grandEarlyLate->countEarlyLate;
                                }

                                foreach($grandTotPlanned as $grandPlanKey => $grandPlanned){
                                    $grandServed->trip_planned = $grandPlanned->trip_planned;
                                    $grandServed->km_planned = $grandPlanned->km_planned;
                                    $grandServed->missed_trip = $countMissedTripGrand;
                                }
                            }

                            $newKey = $key + $count+1;
                            $out->writeln("last newKey: " . $newKey);
                            array_splice($allTrips, $newKey, 0, $grandTotServed);
                            array_splice($allTrips, $newKey, 0, $currTotServedPerCompany);
                            array_splice($allTrips, $newKey, 0, $currTotServedPerRoute);
                        }
                    }
                }
                //Daily Summary specific route specific company
                else{
                    $allRoute = Route::where('id', $validatedData['route_id'])->first();
                    $allTrips = [];

                    if($allRoute){
                        $out->writeln("All Route: " . $allRoute->route_number);
                        $tripPerRoute = DB::select("WITH RECURSIVE n_dte (n) AS (
                            SELECT " . $startDayNo . "
                            UNION ALL
                            SELECT n + 1
                            FROM n_dte
                            WHERE n < " . $endDayNo . "
                            ),
                            all_mnth_days AS (
                            SELECT route.id as route_id, route.route_number, route.route_name, route.company_id,
                            DATE_ADD(MIN(trip_details.start_trip), INTERVAL - DAY(MIN(trip_details.start_trip)) + 1 DAY) AS mnth_first_day,
                            n,
                            CAST(DATE_ADD(DATE_ADD(MIN(trip_details.start_trip), INTERVAL - DAY(MIN(trip_details.start_trip)) + 1 DAY), INTERVAL n - 1 DAY) AS DATE) AS all_days_in_mnth
                            FROM mybas.trip_details
                            JOIN n_dte
                            JOIN mybas.route ON route.id = trip_details.route_id
                            WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND route.id = '". $allRoute->id . "'
                            group by n
                            ORDER BY n ASC)
                            
                            SELECT
                            amd.all_days_in_mnth AS service_date, amd.route_id, amd.route_number, amd.route_name, amd.company_id, 
                            (case when (count(ie.id) IS NULL) THEN 0 ELSE count(ie.id) END) as trip_served,
                            (case when (SUM(ie.total_mileage) IS NULL) THEN 0 ELSE SUM(ie.total_mileage) END) as km_served,
                            (case when (SUM(ie.total_adult_amount) + SUM(ie.total_concession_amount) IS NULL) THEN 0 
                            ELSE SUM(ie.total_adult_amount) + SUM(ie.total_concession_amount) END) AS farebox, 
                            (case when (SUM(ie.total_adult) + SUM(ie.total_concession) IS NULL) THEN 0 
                            ELSE SUM(ie.total_adult) + SUM(ie.total_concession) END) AS ridership
                            FROM all_mnth_days AS amd
                            LEFT JOIN trip_details AS ie ON CAST(ie.start_trip AS DATE) = amd.all_days_in_mnth
                            AND ie.route_id = amd.route_id
                            GROUP BY service_date;");

                        $noTripArr = [];
                        if(!$tripPerRoute){
                            $out->writeln("In tripPerRoute < 0");
                            foreach($all_dates as $all_date){
                                $noTrip = new \stdClass;
                                $noTrip->service_date = $all_date;
                                $noTrip->route_id = $allRoute->id;
                                $noTrip->route_number = $allRoute->route_number;
                                $noTrip->route_name = $allRoute->route_name;
                                $noTrip->company_id = $allRoute->company_id;
                                $noTrip->trip_served = 0;
                                $noTrip->km_served = 0.00;
                                $noTrip->farebox = 0.00;
                                $noTrip->ridership = 0;

                                $noTripArr[] = $noTrip;
                            }
                            $allTrips = array_merge($allTrips, $noTripArr);
                        }else{
                            $out->writeln("In tripPerRoute > 0");
                            $allTrips = array_merge($allTrips, $tripPerRoute);
                        }
                        //$allTrips = array_merge($allTrips, $tripPerRoute);
                        //$allTrips[$routeNo] = $tripPerRoute;
                    }

                    //Trip Planned
                    $tripPlanned = DB::select("SELECT route.route_number, route.route_name, cast(route_scheduler_details.schedule_date as date) as planned_date,
                    count(route_scheduler_details.id) as trip_planned, 
                    count(route_scheduler_details.id) * route.distance as km_planned
                    FROM mybas.route
                    JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                    JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                    WHERE route_scheduler_details.schedule_date BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                    AND route.status = 1
                    GROUP BY planned_date, route_number
                    ORDER BY route_number;");

                    $lastKey = array_key_last($allTrips);
                    $pastNo = "";
                    $pastCompany = "";
                    $count = 0;
                    $countMissedTrip = 0;
                    $countMissedTripPerRoute = 0;
                    $currTotServedPerRoute = [];
                    $currTotPlannedPerRoute = [];
                    $currTotServedPerCompany = [];
                    $currTotPlannedPerCompany = [];
                    foreach($allTrips as $key => $allTrip){
                        $out->writeln("New Loop: " . $key . " - " . $allTrip->route_number . " - " . $allTrip->service_date . " ");
                        $startDay = new Carbon($allTrip->service_date);
                        $endDay = new Carbon($allTrip->service_date . '23:59:59');
                        if ($startDay->isWeekDay()) {
                            $allTrip->day = "WEEKDAY";
                        } elseif ($startDay->isWeekend()) {
                            $allTrip->day = "WEEKEND";
                        }
                        $found = false;

                        foreach($tripPlanned as $key2 => $tripPlan){
                            if($tripPlan->route_number == $allTrip->route_number){
                                if($tripPlan->planned_date == $allTrip->service_date){
                                    $allTrip->trip_planned = $tripPlan->trip_planned;
                                    $allTrip->km_planned = $tripPlan->km_planned;

                                    //Total Missed Trip
                                    $diff= $tripPlan->trip_planned - $allTrip->trip_served;
                                    if($diff>0){
                                        $allTrip->missed_trip = $diff;
                                        $countMissedTrip += $diff;
                                        $countMissedTripPerRoute += $diff;
                                    }else{
                                        $allTrip->missed_trip = 0;
                                    }

                                    $found = true;
                                    break ;
                                }
                            }
                        }
                        if(!$found){
                            $allTrip->trip_planned = 0;
                            $allTrip->km_planned = 0;
                            $allTrip->missed_trip = 0;
                        }
                        
                        //Early Late
                        $earlyLateCount = DB::select("SELECT count(trip_details.id) as countEarlyLate
                        FROM trip_details
                        WHERE trip_details.id IN ( 
                        SELECT trip_details.id
                        FROM mybas.trip_details
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.id = trip_details.route_schedule_mstr_id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE trip_details.start_trip BETWEEN '" . $startDay . "' AND '" . $endDay . "'
                        AND trip_details.route_id =  " . $allTrip->route_id . "
                        AND (TIMEDIFF(route_scheduler_mstr.schedule_start_time, cast(trip_details.start_trip as TIME)) < '-00:05:00'
                        OR TIMEDIFF(route_scheduler_mstr.schedule_start_time, cast(trip_details.start_trip as TIME)) > '00:05:00')
                        GROUP BY trip_details.id);");

                        foreach($earlyLateCount as $key3 => $earlyLate){
                            $allTrip->earlyLate = $earlyLate->countEarlyLate;
                        }

                        if($lastKey==$key){
                            $currTotServedPerRoute = DB::select("SELECT route.route_number, route.route_name, company.company_name, count(trip_details.id) as trip_served, 
                            SUM(trip_details.total_mileage) as km_served,
                            SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                            SUM(total_adult) + SUM(total_concession) AS ridership
                            FROM mybas.trip_details
                            JOIN mybas.route ON route.id = trip_details.route_id
                            JOIN mybas.company ON company.id = route.company_id
                            WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND route.route_number = '" . $allTrip->route_number . "'
                            GROUP BY route_number
                            ORDER BY route.company_id, route_number;");

                            $currTotPlannedPerRoute = DB::select("SELECT route.route_number, route.route_name, cast(route_scheduler_details.schedule_date as date) as planned_date,
                            count(route_scheduler_details.id) as trip_planned, 
                            count(route_scheduler_details.id) * route.distance as km_planned
                            FROM mybas.route
                            JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                            JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                            WHERE route_scheduler_details.schedule_date BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND route.route_number = '" . $allTrip->route_number . "'
                            GROUP BY route.route_number
                            ORDER BY route.route_number;");

                            $found = false;
                            if($currTotServedPerRoute){
                                foreach($currTotServedPerRoute as $key4 => $totalTripServe){
                                    $companyTotal = new \stdClass;
                                    $grandTotal = new \stdClass;

                                    $companyTotal->company_name = $totalTripServe->company_name;
                                    $companyTotal->trip_served = $totalTripServe->trip_served;
                                    $companyTotal->km_served = $totalTripServe->km_served;
                                    $companyTotal->farebox = $totalTripServe->farebox;
                                    $companyTotal->ridership = $totalTripServe->ridership;

                                    $grandTotal->trip_served = $totalTripServe->trip_served;
                                    $grandTotal->km_served = $totalTripServe->km_served;
                                    $grandTotal->farebox = $totalTripServe->farebox;
                                    $grandTotal->ridership = $totalTripServe->ridership;

                                    //Early Late Per Route
                                    $earlyLateCountPerRoute = DB::select("SELECT count(trip_details.id) as countEarlyLate
                                    FROM trip_details
                                    WHERE trip_details.id IN ( 
                                    SELECT trip_details.id
                                    FROM mybas.trip_details
                                    JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.id = trip_details.route_schedule_mstr_id
                                    JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                                    WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                                    AND trip_details.route_id =  " . $allTrip->route_id . "
                                    AND (TIMEDIFF(route_scheduler_mstr.schedule_start_time, cast(trip_details.start_trip as TIME)) < '-00:05:00'
                                    OR TIMEDIFF(route_scheduler_mstr.schedule_start_time, cast(trip_details.start_trip as TIME)) > '00:05:00')
                                    GROUP BY trip_details.id);");

                                    foreach($earlyLateCountPerRoute as $key5 => $earlyLatePerRoute){
                                        $totalTripServe->earlyLate = $earlyLatePerRoute->countEarlyLate;
                                        $companyTotal->earlyLate = $earlyLatePerRoute->countEarlyLate;
                                        $grandTotal->earlyLate = $earlyLatePerRoute->countEarlyLate;
                                    }

                                    foreach($currTotPlannedPerRoute as $key6 => $totalTripPlan){
                                        $totalTripServe->trip_planned = $totalTripPlan->trip_planned;
                                        $companyTotal->trip_planned = $totalTripPlan->trip_planned;
                                        $grandTotal->trip_planned = $totalTripPlan->trip_planned;
                                        $totalTripServe->km_planned = $totalTripPlan->km_planned;
                                        $companyTotal->km_planned = $totalTripPlan->km_planned;
                                        $grandTotal->km_planned = $totalTripPlan->km_planned;
                                        //Total Missed Trip Ver 2
                                        $totalTripServe->missed_trip = $countMissedTripPerRoute;
                                        $companyTotal->missed_trip = $countMissedTripPerRoute;
                                        $grandTotal->missed_trip = $countMissedTripPerRoute;

                                        $found = true;
                                        break ;
                                    }
                                    if(!$found){
                                        $totalTripServe->trip_planned = 0;
                                        $totalTripServe->km_planned = 0;
                                        $totalTripServe->missed_trip = 0;

                                        $companyTotal->trip_planned = 0;
                                        $companyTotal->km_planned = 0;
                                        $companyTotal->missed_trip = 0;

                                        $grandTotal->trip_planned = 0;
                                        $grandTotal->km_planned = 0;
                                        $grandTotal->missed_trip = 0;
                                    }
                                }
                                $currTotServedPerCompany[] = $companyTotal;
                                $currTotServedPerGrand[] = $grandTotal;
                            }else{
                                $noTrip = new \stdClass;
                                $noTrip->route_number = $allTrip->route_number;
                                $noTrip->route_name = $allTrip->route_name;
                                $noTrip->company_id = $allTrip->company_id;
                                $noTrip->trip_served = 0;
                                $noTrip->km_served = 0.00;
                                $noTrip->farebox = 0.00;
                                $noTrip->ridership = 0;
                                $noTrip->earlyLate = 0;

                                $companyTotal = new \stdClass;
                                $companyTotal->company_id = $allTrip->company_name;
                                $companyTotal->trip_served = 0;
                                $companyTotal->km_served = 0.00;
                                $companyTotal->farebox = 0.00;
                                $companyTotal->ridership = 0;
                                $companyTotal->earlyLate = 0;

                                $grandTotal = new \stdClass;
                                $grandTotal->trip_served = 0;
                                $grandTotal->km_served = 0.00;
                                $grandTotal->farebox = 0.00;
                                $grandTotal->ridership = 0;
                                $grandTotal->earlyLate = 0;
                                
                                foreach($currTotPlannedPerRoute as $key6 => $totalTripPlan){
                                    $noTrip->trip_planned = $totalTripPlan->trip_planned;
                                    $noTrip->km_planned = $totalTripPlan->km_planned;
                                    $companyTotal->trip_planned = $totalTripPlan->trip_planned;
                                    $companyTotal->km_planned = $totalTripPlan->km_planned;
                                    $grandTotal->trip_planned = $totalTripPlan->trip_planned;
                                    $grandTotal->km_planned = $totalTripPlan->km_planned;

                                    //Total Missed Trip Ver 2
                                    $noTrip->missed_trip = $countMissedTripPerRoute;
                                    $companyTotal->missed_trip = $countMissedTripPerRoute;
                                    $grandTotal->missed_trip = $countMissedTripPerRoute;

                                    $found = true;
                                    break ;
                                }
                                if(!$found){
                                    $noTrip->trip_planned = 0;
                                    $noTrip->km_planned = 0;
                                    $noTrip->missed_trip = 0;

                                    $companyTotal->trip_planned = 0;
                                    $companyTotal->km_planned = 0;
                                    $companyTotal->missed_trip = 0;

                                    $grandTotal->trip_planned = 0;
                                    $grandTotal->km_planned = 0;
                                    $grandTotal->missed_trip = 0;
                                }
                                $currTotServedPerRoute[] = $noTrip;
                                $currTotServedPerCompany[] = $companyTotal;
                                $currTotServedPerGrand[] = $grandTotal;
                            }

                            $newKey = $key + $count+1;
                            $out->writeln("last newKey: " . $newKey);
                            array_splice($allTrips, $newKey, 0, $currTotServedPerGrand);
                            array_splice($allTrips, $newKey, 0, $currTotServedPerCompany);
                            array_splice($allTrips, $newKey, 0, $currTotServedPerRoute);
                        }
                    }
                }
            }
            return Excel::download(new SPADSummaryByRoute($allTrips, $validatedData['dateFrom'], $validatedData['dateTo'], $networkArea), 'Summary_By_Route_Report_SPAD_'.Carbon::now()->format('YmdHis').'.xlsx');
        }else{
            $this->dispatchBrowserEvent('company-required');
        }
    }

    public function printSummaryNetworkOld()
    {
        $out = new ConsoleOutput();
        $out->writeln("YOU ARE INprintSummaryNetwork()");

        $validatedData = Validator::make($this->state,[
            'dateFrom' => ['required', 'date'],
            'dateTo' => ['required', 'date'],
            'route_id' => ['required'],
        ])->validate();

        $dateFrom = new Carbon($validatedData['dateFrom']);
        $dateTo = new Carbon($validatedData['dateTo'] . '23:59:59');

        $summaryByNetwork = collect();
        $grandKMPlanned = 0;
        $grandKMServed = 0;
        $grandClaim = 0;
        $grandTripPlanned = 0;
        $grandTripServed = 0;
        $grandBusDeployed = 0;
        $grandMissedTrip = 0;
        $grandEarlyLate = 0;
        $grandBreakdown = 0;
        $grandAccidents = 0;
        $grandRidership = 0;
        $grandFarebox = 0;
        $grandTng = 0;
        if ($this->selectedCompany){
            if($this->selectedCompany=='All'){
                $networkArea = 'All';
                if(!empty($validatedData['route_id'])) {
                    //Summary By Network all route all company
                    if($validatedData['route_id']=='All'){
                        $allRoutes = Route::orderBy('route_number')->get();
            
                        foreach($allRoutes as $allRoute) {
                            $totalKMServed = 0;
                            $totalFarebox = 0;
                            $totalTng = 0;
                            $totalRidership = 0;
                            $earlyLateCount = 0;
                            $totalTripPlanned = 0;
                            $tripPlannedIn = 0;
                            $tripPlannedOut = 0;
                            $kmInbound = 0;
                            $kmOutbound = 0;
            
                            $schedules = RouteSchedulerDetail::whereBetween('schedule_date', [$dateFrom, $dateTo])->get();
                            if (count($schedules) > 0) {
                                foreach ($schedules as $schedule) {
                                    if ($schedule->RouteScheduleMSTR->route_id == $allRoute->id) {
                                        $totalTripPlanned++;
                                        if ($schedule->RouteScheduleMSTR->trip_code == 1) {
                                            $tripPlannedIn++;
                                            $kmInbound += $allRoute->inbound_distance;
                                        }else{
                                            $tripPlannedOut++;
                                            $kmOutbound += $allRoute->outbound_distance;
                                        }
                                    }
                                }
                            }
                            $totalKMPlanned = $kmInbound + $kmOutbound;
                            
                            $allTrips = TripDetail::where('route_id', $allRoute->id)
                                ->whereBetween('start_trip', [$dateFrom, $dateTo])
                                ->get();
            
                            $tripServed = 0;
                            $tripServedIn = 0;
                            $tripServedOut = 0;
                            if (count($allTrips) > 0) {
                                foreach ($allTrips as $allTrip) {
                                    $tripServed++;
            
                                    //Total KM Service Served
                                    if($allTrip->trip_code==0){
                                        $kmServed = $allTrip->Route->outbound_distance;
                                        $tripServedOut++;
                                    }
                                    elseif($allTrip->trip_code==1){
                                        $kmServed = $allTrip->Route->inbound_distance;
                                        $tripServedIn++;
                                    }
                                    $totalKMServed += $kmServed;
                                    
                                    //Early-Late
                                    if ($allTrip->route_schedule_mstr_id != NULL) {
                                        $diff = strtotime($allTrip->routeScheduleMSTR->schedule_start_time) - strtotime($allTrip->start_trip);
                                        if ($diff > 5 || $diff < -5) {
                                            $earlyLateCount++;
                                        }
                                    }
            
                                    //Ridership
                                    $ridership = $allTrip->total_adult + $allTrip->total_concession;
                                    if($ridership==0){
                                        $ridership = TicketSalesTransaction::where('trip_id', $allTrip->id)->count();
                                    }
                                    $totalRidership += $ridership;
                                    
                                    //Farebox && TnG Collection 
                                    $farebox = 0;
                                    $tng = 0;
                                    $ticketsPerTrips = TicketSalesTransaction::where('trip_id', $allTrip->id)->get();
                                    if(count($ticketsPerTrips)>0){
                                        foreach($ticketsPerTrips as $ticketsPerTrip){
                                            if($ticketsPerTrip->fare_type==0){
                                                $farebox += $ticketsPerTrip->actual_amount;
                                            }elseif($ticketsPerTrip->fare_type==2){
                                                $tng += $ticketsPerTrip->actual_amount;
                                            }
                                        }
                                    }
                                    $totalFarebox += $farebox;
                                    $totalTng += $tng;
                                }
                            }
            
                            //Total No Bus Deployed
                            $totalBusDeployed = TripDetail::where('route_id', $allRoute->id)
                                ->whereBetween('start_trip', [$dateFrom, $dateTo])
                                ->distinct('bus_id')
                                ->count();
            
                            //Total Trip Served
                            $totalTripServed = $tripServed;
            
                            //Total Missed Trip
                            $diffIn = $tripPlannedIn - $tripServedIn;
                            $diffOut = $tripPlannedOut - $tripServedOut;
                            if($diffIn>0){
                                if($diffOut>0){
                                    $totalMissedTrip = $diffIn + $diffOut;
                                }else{
                                    $totalMissedTrip = $diffIn;
                                }
                            }else{
                                if($diffOut>0){
                                    $totalMissedTrip = $diffOut;
                                }else{
                                    $totalMissedTrip = 0;
                                }
                            }
            
                            if($allRoute->company_id==29){
                                $charge = 3.42;
                            }else{
                                $charge = 1.33;
                            }
                            //Total Claim = KM/day * 1.33
                            $claim = $charge * $totalKMServed;
                            $totalClaim = round($claim,0);
            
                            /**Total Breakdown & Total Accidents need to revise**/
                            $totalBreakdown = 0;
                            $totalAccidents = 0;
            
                            $perRoute['total_km_planned'] = $totalKMPlanned;
                            $perRoute['total_km_served'] = $totalKMServed;
                            $perRoute['total_claim'] = $totalClaim;
                            $perRoute['total_trip_planned'] = $totalTripPlanned;
                            $perRoute['total_trip_served'] = $totalTripServed;
                            $perRoute['total_bus_deployed'] = $totalBusDeployed;
                            $perRoute['total_missed_trip'] = $totalMissedTrip;
                            $perRoute['total_early_late'] = $earlyLateCount;
                            $perRoute['total_breakdown'] = $totalBreakdown;
                            $perRoute['total_accidents'] = $totalAccidents;
                            $perRoute['total_ridership'] = $totalRidership;
                            $perRoute['total_farebox'] = $totalFarebox;
                            $perRoute['total_tng'] = $totalTng;
            
                            $data[$allRoute->route_number] = $perRoute;
            
                            $grandKMPlanned += $perRoute['total_km_planned'];
                            $grandKMServed += $perRoute['total_km_served'];
                            $grandClaim += $perRoute['total_claim'];
                            $grandTripPlanned += $perRoute['total_trip_planned'];
                            $grandTripServed += $perRoute['total_trip_served'];
                            $grandBusDeployed += $perRoute['total_bus_deployed'];
                            $grandMissedTrip += $perRoute['total_missed_trip'];
                            $grandEarlyLate += $perRoute['total_early_late'];
                            $grandBreakdown += $perRoute['total_breakdown'];
                            $grandAccidents += $perRoute['total_accidents'];
                            $grandRidership += $perRoute['total_ridership'];
                            $grandFarebox += $perRoute['total_farebox'];
                            $grandTng += $perRoute['total_tng'];
                        }
                        $grand['grand_km_planned'] = $grandKMPlanned;
                        $grand['grand_km_served'] = $grandKMServed;
                        $grand['grand_claim'] = $grandClaim;
                        $grand['grand_trip_planned'] = $grandTripPlanned;
                        $grand['grand_trip_served'] = $grandTripServed;
                        $grand['grand_bus_deployed'] = $grandBusDeployed;
                        $grand['grand_missed_trip'] = $grandMissedTrip;
                        $grand['grand_early_late'] = $grandEarlyLate;
                        $grand['grand_breakdown'] = $grandBreakdown;
                        $grand['grand_accidents'] = $grandAccidents;
                        $grand['grand_ridership'] = $grandRidership;
                        $grand['grand_farebox'] = $grandFarebox;
                        $grand['grand_tng'] = $grandTng;
            
                        $data['grand'] = $grand;
                        $summaryByNetwork->add($data);
                    }
                }
            }else{
                $companyDetails = Company::where('id', $this->selectedCompany)->first();
                $networkArea = $companyDetails->company_name;
                if($companyDetails->id==29){
                    $charge = 3.42;
                }else{
                    $charge = 1.33;
                }
                if(!empty($validatedData['route_id'])) {
                    //Summary By Network all route specific company
                    if($validatedData['route_id']=='All'){
                        $routeByCompanies = Route::where('company_id', $companyDetails->id)->orderBy('route_number')->get();
        
                        foreach($routeByCompanies as $routeByCompany) {
                            $totalKMServed = 0;
                            $totalFarebox = 0;
                            $totalTng = 0;
                            $totalRidership = 0;
                            $earlyLateCount = 0;
                            $totalTripPlanned = 0;
                            $kmInbound = 0;
                            $kmOutbound = 0;
                            $tripPlannedOut = 0;
                            $tripPlannedIn = 0;
        
                            $schedules = RouteSchedulerDetail::whereBetween('schedule_date', [$dateFrom, $dateTo])->get();
                            if (count($schedules) > 0) {
                                foreach ($schedules as $schedule) {
                                    if ($schedule->RouteScheduleMSTR->route_id == $routeByCompany->id) {
                                        $totalTripPlanned++;
                                        if ($schedule->RouteScheduleMSTR->trip_code == 1) {
                                            $tripPlannedIn++;
                                            $kmInbound += $routeByCompany->inbound_distance;
                                        }else{
                                            $tripPlannedOut++;
                                            $kmOutbound += $routeByCompany->outbound_distance;
                                        }
                                    }
                                }
                            }
                            $totalKMPlanned = $kmInbound + $kmOutbound;
        
                            $allTrips = TripDetail::where('route_id', $routeByCompany->id)
                                ->whereBetween('start_trip', [$dateFrom, $dateTo])
                                ->get();
        
                            $tripServed = 0;
                            $tripServedIn = 0;
                            $tripServedOut = 0;
                            if (count($allTrips) > 0) {
                                foreach ($allTrips as $allTrip) {
                                    $tripServed++;
        
                                   //Total KM Service Served
                                    if($allTrip->trip_code==0){
                                        $kmServed = $allTrip->Route->outbound_distance;
                                        $tripServedOut++;
                                    }
                                    elseif($allTrip->trip_code==1){
                                        $kmServed = $allTrip->Route->inbound_distance;
                                        $tripServedIn++;
                                    }
                                    $totalKMServed += $kmServed;
        
                                    //Early-Late
                                    if ($allTrip->route_schedule_mstr_id != NULL) {
                                        $diff = strtotime($allTrip->routeScheduleMSTR->schedule_start_time) - strtotime($allTrip->start_trip);
                                        if ($diff > 5 || $diff < -5) {
                                            $earlyLateCount++;
                                        }
                                    }
        
                                    //Ridership
                                    $ridership = $allTrip->total_adult + $allTrip->total_concession;
                                    if($ridership==0){
                                        $ridership = TicketSalesTransaction::where('trip_id', $allTrip->id)->count();
                                    }
                                    $totalRidership += $ridership;
        
                                    //Farebox && TnG Collection 
                                    $farebox = 0;
                                    $tng = 0;
                                    $ticketsPerTrips = TicketSalesTransaction::where('trip_id', $allTrip->id)->get();
                                    if(count($ticketsPerTrips)>0){
                                        foreach($ticketsPerTrips as $ticketsPerTrip){
                                            if($ticketsPerTrip->fare_type==0){
                                                $farebox += $ticketsPerTrip->actual_amount;
                                            }elseif($ticketsPerTrip->fare_type==2){
                                                $tng += $ticketsPerTrip->actual_amount;
                                            }
                                        }
                                    }
                                    $totalFarebox += $farebox;
                                    $totalTng += $tng;
                                }
                            }
        
                            //Total No Bus Deployed
                            $totalBusDeployed = TripDetail::where('route_id', $routeByCompany->id)
                                ->whereBetween('start_trip', [$dateFrom, $dateTo])
                                ->distinct('bus_id')
                                ->count();
        
                            //Total Trip Served
                            $totalTripServed = $tripServed;
        
                            //Total Missed Trip
                            $diffIn = $tripPlannedIn - $tripServedIn;
                            $diffOut = $tripPlannedOut - $tripServedOut;
                            if($diffIn>0){
                                if($diffOut>0){
                                    $totalMissedTrip = $diffIn + $diffOut;
                                }else{
                                    $totalMissedTrip = $diffIn;
                                }
                            }else{
                                if($diffOut>0){
                                    $totalMissedTrip = $diffOut;
                                }else{
                                    $totalMissedTrip = 0;
                                }
                            }
        
                            //Total Claim = KM/day * 1.33
                            $claim = $charge * $totalKMServed;
                            $totalClaim = round($claim,0);
        
                            /**Total Breakdown & Total Accidents need to revise**/
                            $totalBreakdown = 0;
                            $totalAccidents = 0;
        
                            $perRoute['total_km_planned'] = $totalKMPlanned;
                            $perRoute['total_km_served'] = $totalKMServed;
                            $perRoute['total_claim'] = $totalClaim;
                            $perRoute['total_trip_planned'] = $totalTripPlanned;
                            $perRoute['total_trip_served'] = $totalTripServed;
                            $perRoute['total_bus_deployed'] = $totalBusDeployed;
                            $perRoute['total_missed_trip'] = $totalMissedTrip;
                            $perRoute['total_early_late'] = $earlyLateCount;
                            $perRoute['total_breakdown'] = $totalBreakdown;
                            $perRoute['total_accidents'] = $totalAccidents;
                            $perRoute['total_ridership'] = $totalRidership;
                            $perRoute['total_farebox'] = $totalFarebox;
                            $perRoute['total_tng'] = $totalTng;
        
                            $data[$routeByCompany->route_number] = $perRoute;
        
                            $grandKMPlanned += $perRoute['total_km_planned'];
                            $grandKMServed += $perRoute['total_km_served'];
                            $grandClaim += $perRoute['total_claim'];
                            $grandTripPlanned += $perRoute['total_trip_planned'];
                            $grandTripServed += $perRoute['total_trip_served'];
                            $grandBusDeployed += $perRoute['total_bus_deployed'];
                            $grandMissedTrip += $perRoute['total_missed_trip'];
                            $grandEarlyLate += $perRoute['total_early_late'];
                            $grandBreakdown += $perRoute['total_breakdown'];
                            $grandAccidents += $perRoute['total_accidents'];
                            $grandRidership += $perRoute['total_ridership'];
                            $grandFarebox += $perRoute['total_farebox'];
                            $grandTng += $perRoute['total_tng'];
                        }
                        $grand['grand_km_planned'] = $grandKMPlanned;
                        $grand['grand_km_served'] = $grandKMServed;
                        $grand['grand_claim'] = $grandClaim;
                        $grand['grand_trip_planned'] = $grandTripPlanned;
                        $grand['grand_trip_served'] = $grandTripServed;
                        $grand['grand_bus_deployed'] = $grandBusDeployed;
                        $grand['grand_missed_trip'] = $grandMissedTrip;
                        $grand['grand_early_late'] = $grandEarlyLate;
                        $grand['grand_breakdown'] = $grandBreakdown;
                        $grand['grand_accidents'] = $grandAccidents;
                        $grand['grand_ridership'] = $grandRidership;
                        $grand['grand_farebox'] = $grandFarebox;
                        $grand['grand_tng'] = $grandTng;
        
                        $data['grand'] = $grand;
                        $summaryByNetwork->add($data);
                    }
                    //Summary By Network specific route specific company
                    else{
                        $selectedRoute = Route::where('id', $validatedData['route_id'])->first();
                        $totalKMServed = 0;
                        $totalFarebox = 0;
                        $totalTng = 0;
                        $totalRidership = 0;
                        $earlyLateCount = 0;
                        $totalTripPlanned = 0;
                        $tripPlannedIn = 0;
                        $tripPlannedOut = 0;
                        $kmInbound = 0;
                        $kmOutbound = 0;
                        $schedules = RouteSchedulerDetail::whereBetween('schedule_date', [$dateFrom, $dateTo])->get();
                        if (count($schedules) > 0) {
                            foreach ($schedules as $schedule) {
                                if ($schedule->RouteScheduleMSTR->route_id == $selectedRoute->id) {
                                    $totalTripPlanned++;
                                    if ($schedule->RouteScheduleMSTR->trip_code == 1) {
                                        $tripPlannedIn++;
                                        $kmInbound += $selectedRoute->inbound_distance;
                                    }else{
                                        $tripPlannedOut++;
                                        $kmOutbound += $selectedRoute->outbound_distance;
                                    }
                                }
                            }
                        }
                        $totalKMPlanned = $kmInbound + $kmOutbound;
        
                        $allTrips = TripDetail::where('route_id', $selectedRoute->id)
                            ->whereBetween('start_trip', [$dateFrom, $dateTo])
                            ->get();
        
                        $tripServed = 0;
                        $tripServedIn = 0;
                        $tripServedOut = 0;
                        if (count($allTrips) > 0) {
                            foreach ($allTrips as $allTrip) {
                                $tripServed++;
                                
                                 //Total KM Service Served
                                 if($allTrip->trip_code==0){
                                    $kmServed = $allTrip->Route->outbound_distance;
                                    $tripServedOut++;
                                }
                                elseif($allTrip->trip_code==1){
                                    $kmServed = $allTrip->Route->inbound_distance;
                                    $tripServedIn++;
                                }
                                $totalKMServed += $kmServed;
        
                                //Early-Late
                                if ($allTrip->route_schedule_mstr_id != NULL) {
                                    $diff = strtotime($allTrip->routeScheduleMSTR->schedule_start_time) - strtotime($allTrip->start_trip);
                                    if ($diff > 5 || $diff < -5) {
                                        $earlyLateCount++;
                                    }
                                }
        
                                //Ridership
                                $ridership = $ridership = $allTrip->total_adult + $allTrip->total_concession;
                                if($ridership==0){
                                    $ridership = TicketSalesTransaction::where('trip_id', $allTrip->id)->count();
                                }
                                $totalRidership += $ridership;
        
                                //Farebox && TnG Collection 
                                $farebox = 0;
                                $tng = 0;
                                $ticketsPerTrips = TicketSalesTransaction::where('trip_id', $allTrip->id)->get();
                                if(count($ticketsPerTrips)>0){
                                    foreach($ticketsPerTrips as $ticketsPerTrip){
                                        if($ticketsPerTrip->fare_type==0){
                                            $farebox += $ticketsPerTrip->actual_amount;
                                        }elseif($ticketsPerTrip->fare_type==2){
                                            $tng += $ticketsPerTrip->actual_amount;
                                        }
                                    }
                                }
                                $totalFarebox += $farebox;
                                $totalTng += $tng;
                            }
                        }
        
                        //Total No Bus Deployed
                        $totalBusDeployed = TripDetail::where('route_id', $selectedRoute->id)
                            ->whereBetween('start_trip', [$dateFrom, $dateTo])
                            ->distinct('bus_id')
                            ->count();
        
                        //Total Trip Served
                        $totalTripServed = $tripServed;
        
                        //Total Missed Trip
                        $diffIn = $tripPlannedIn - $tripServedIn;
                        $diffOut = $tripPlannedOut - $tripServedOut;
                        if($diffIn>0){
                            if($diffOut>0){
                                $totalMissedTrip = $diffIn + $diffOut;
                            }else{
                                $totalMissedTrip = $diffIn;
                            }
                        }else{
                            if($diffOut>0){
                                $totalMissedTrip = $diffOut;
                            }else{
                                $totalMissedTrip = 0;
                            }
                        }
        
                        //Total Claim = KM/day * 1.33
                        $claim = $charge * $totalKMServed;
                        $totalClaim = round($claim,0);
        
                        /**Total Breakdown & Total Accidents need to revise**/
                        $totalBreakdown = 0;
                        $totalAccidents = 0;
        
                        $perRoute['total_km_planned'] = $totalKMPlanned;
                        $perRoute['total_km_served'] = $totalKMServed;
                        $perRoute['total_claim'] = $totalClaim;
                        $perRoute['total_trip_planned'] = $totalTripPlanned;
                        $perRoute['total_trip_served'] = $totalTripServed;
                        $perRoute['total_bus_deployed'] = $totalBusDeployed;
                        $perRoute['total_missed_trip'] = $totalMissedTrip;
                        $perRoute['total_early_late'] = $earlyLateCount;
                        $perRoute['total_breakdown'] = $totalBreakdown;
                        $perRoute['total_accidents'] = $totalAccidents;
                        $perRoute['total_ridership'] = $totalRidership;
                        $perRoute['total_farebox'] = $totalFarebox;
                        $perRoute['total_tng'] = $totalTng;
        
                        $data[$selectedRoute->route_number] = $perRoute;
        
                        $grandKMPlanned += $perRoute['total_km_planned'];
                        $grandKMServed += $perRoute['total_km_served'];
                        $grandClaim += $perRoute['total_claim'];
                        $grandTripPlanned += $perRoute['total_trip_planned'];
                        $grandTripServed += $perRoute['total_trip_served'];
                        $grandBusDeployed += $perRoute['total_bus_deployed'];
                        $grandMissedTrip += $perRoute['total_missed_trip'];
                        $grandEarlyLate += $perRoute['total_early_late'];
                        $grandBreakdown += $perRoute['total_breakdown'];
                        $grandAccidents += $perRoute['total_accidents'];
                        $grandRidership += $perRoute['total_ridership'];
                        $grandFarebox += $perRoute['total_farebox'];
                        $grandTng += $perRoute['total_tng'];
        
                        $grand['grand_km_planned'] = $grandKMPlanned;
                        $grand['grand_km_served'] = $grandKMServed;
                        $grand['grand_claim'] = $grandClaim;
                        $grand['grand_trip_planned'] = $grandTripPlanned;
                        $grand['grand_trip_served'] = $grandTripServed;
                        $grand['grand_bus_deployed'] = $grandBusDeployed;
                        $grand['grand_missed_trip'] = $grandMissedTrip;
                        $grand['grand_early_late'] = $grandEarlyLate;
                        $grand['grand_breakdown'] = $grandBreakdown;
                        $grand['grand_accidents'] = $grandAccidents;
                        $grand['grand_ridership'] = $grandRidership;
                        $grand['grand_farebox'] = $grandFarebox;
                        $grand['grand_tng'] = $grandTng;
        
                        $data['grand'] = $grand;
                        $summaryByNetwork->add($data);
                    }
                }
            }
            return Excel::download(new SPADSummaryByNetwork($summaryByNetwork, $validatedData['dateFrom'], $validatedData['dateTo'], $networkArea), 'Summary_By_Network_Report_SPAD_'.Carbon::now()->format('YmdHis').'.xlsx');
        }else{
            $this->dispatchBrowserEvent('company-required');
        }
    }

    //FAST
    public function printSummaryNetwork(){
        $out = new ConsoleOutput();
        $out->writeln("YOU ARE IN printSummaryNetworkFast()");

        $validatedData = Validator::make($this->state,[
            'dateFrom' => ['required', 'date'],
            'dateTo' => ['required', 'date'],
            'route_id' => ['required'],
        ])->validate();

        $dateFrom = new Carbon($validatedData['dateFrom']);
        $dateTo = new Carbon($validatedData['dateTo'] . " 23:59:59");
        $startDate = new Carbon($validatedData['dateFrom']);
        $endDate = new Carbon($validatedData['dateTo'] . " 23:59:59");
        $all_dates = array();
        
        while ($startDate->lte($endDate)) {
            $all_dates[] = $startDate->toDateString();
            $startDate->addDay();
        }

        if ($this->selectedCompany){
            if($this->selectedCompany=='All'){
                $networkArea = 'ALL';
                //Summary By Network all route all company
                if($validatedData['route_id']=='All'){
                    $getAllRoutes = Route::where('status', 1)->orderBy('company_id')->orderBy('route_number')->get();
                    $allTrips = [];

                    foreach($getAllRoutes as $allRoute){
                        $out->writeln("All Route: " . $allRoute->route_number);

                        $tripPerRoute = DB::select("SELECT IFNULL(route.id, " .  $allRoute->id . ") as route_id, 
                        IFNULL(route.route_number, '" . $allRoute->route_number . "') as route_number, COUNT(DISTINCT(trip_details.bus_id)) as bus_deployed, 
                        (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                        IFNULL(SUM(trip_details.total_mileage),0.00) as km_served,
                        IFNULL((case when (route.company_id = 29) THEN 3.42 * SUM(trip_details.total_mileage) ELSE 1.33 *  SUM(trip_details.total_mileage) END), 0.00) as travel_claim,
                        IFNULL((SUM(trip_details.total_adult) + SUM(trip_details.total_concession)), 0) AS ridership
                        FROM mybas.trip_details
                        JOIN mybas.route ON route.id = trip_details.route_id
                        JOIN mybas.bus ON bus.id = trip_details.bus_id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        and trip_details.route_id = " . $allRoute->id . ";");

                        $out->writeln("In tripPerRoute > 0");
                        $allTrips = array_merge($allTrips, $tripPerRoute);
                    }
                    //dd($allTrips);

                    //Trip Planned
                    $tripPlanned = DB::select("SELECT route.route_number,
                    count(route_scheduler_details.id) as trip_planned, 
                    count(route_scheduler_details.id) * route.distance as km_planned
                    FROM mybas.route
                    JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                    JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                    WHERE route_scheduler_details.schedule_date BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                    AND route.status = 1
                    GROUP BY route_number
                    ORDER BY route_number;");

                    $lastKey = array_key_last($allTrips);
                    $count = 0;
                    $countMissedTripGrand = 0;
                    foreach($allTrips as $key => $allTrip){
                        $out->writeln("New Loop: " . $key . " - " . $allTrip->route_number);
                        $found = false;

                        foreach($tripPlanned as $key2 => $tripPlan){
                            if($tripPlan->route_number == $allTrip->route_number){
                                $allTrip->trip_planned = $tripPlan->trip_planned;
                                $allTrip->km_planned = $tripPlan->km_planned;

                                //Total Missed Trip
                                $diff= $tripPlan->trip_planned - $allTrip->trip_served;
                                if($diff>0){
                                    $allTrip->missed_trip = $diff;
                                    $countMissedTripGrand += $diff;
                                }else{
                                    $allTrip->missed_trip = 0;
                                }

                                $found = true;
                                break ;
                            }
                        }
                        if(!$found){
                            $allTrip->trip_planned = 0;
                            $allTrip->km_planned = 0;
                            $allTrip->missed_trip = 0;
                        }
                        
                        //Cash
                        $fareTypeCash = DB::select("SELECT IFNULL(SUM(tc.actual_amount), 0.00) as cash
                        FROM mybas.trip_details
                        JOIN mybas.ticket_sales_transaction as tc ON tc.trip_id = trip_details.id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND trip_details.route_id = " . $allTrip->route_id . "
                        AND tc.fare_type = 0;");

                        foreach($fareTypeCash as $key3 => $cashSum){
                            $allTrip->cash_collection = $cashSum->cash;
                        }

                        //TNG
                        $fareTypeTNG = DB::select("SELECT IFNULL(SUM(tc.actual_amount), 0.00) as tng
                        FROM mybas.trip_details
                        JOIN mybas.ticket_sales_transaction as tc ON tc.trip_id = trip_details.id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND trip_details.route_id = " . $allTrip->route_id . "
                        AND tc.fare_type = 1;");

                        foreach($fareTypeTNG as $key4 => $tngSum){
                            $allTrip->tng_collection = $tngSum->tng;
                        }

                        //Early Late
                        $earlyLateCount = DB::select("SELECT count(trip_details.id) as countEarlyLate
                        FROM trip_details
                        WHERE trip_details.id IN ( 
                        SELECT trip_details.id
                        FROM mybas.trip_details
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.id = trip_details.route_schedule_mstr_id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND trip_details.route_id =  " . $allTrip->route_id . "
                        AND (TIMEDIFF(route_scheduler_mstr.schedule_start_time, cast(trip_details.start_trip as TIME)) < '-00:05:00'
                        OR TIMEDIFF(route_scheduler_mstr.schedule_start_time, cast(trip_details.start_trip as TIME)) > '00:05:00')
                        GROUP BY trip_details.id);");

                        foreach($earlyLateCount as $key5 => $earlyLate){
                            $allTrip->earlyLate = $earlyLate->countEarlyLate;
                        }

                        if($lastKey==$key){
                            $grandTotServed = DB::select("SELECT COUNT(DISTINCT(trip_details.bus_id)) as bus_deployed, 
                            (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                            SUM(trip_details.total_mileage) as km_served,
                            (case when (route.company_id = 29) THEN 3.42 * SUM(trip_details.total_mileage) ELSE 1.33 *  SUM(trip_details.total_mileage) END) as travel_claim,
                            SUM(trip_details.total_adult) + SUM(trip_details.total_concession) AS ridership
                            FROM mybas.trip_details
                            JOIN mybas.route ON route.id = trip_details.route_id
                            JOIN mybas.bus ON bus.id = trip_details.bus_id
                            WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND route.status=1;");

                            $grandTotPlanned = DB::select("SELECT count(route_scheduler_details.id) as trip_planned, 
                            count(route_scheduler_details.id) * route.distance as km_planned
                            FROM mybas.route
                            JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                            JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                            WHERE route_scheduler_details.schedule_date BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND route.status = 1;");

                            foreach($grandTotServed as $grandInKey => $grandServed){
                                $out->writeln("In grand total loop");

                                //Cash
                                $fareTypeCash = DB::select("SELECT IFNULL(SUM(tc.actual_amount), 0.00) as cash
                                FROM mybas.trip_details
                                JOIN mybas.ticket_sales_transaction as tc ON tc.trip_id = trip_details.id
                                WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                                AND tc.fare_type = 0;");

                                foreach($fareTypeCash as $key3 => $cashSum){
                                    $grandServed->cash_collection = $cashSum->cash;
                                }

                                //TNG
                                $fareTypeTNG = DB::select("SELECT IFNULL(SUM(tc.actual_amount), 0.00) as tng
                                FROM mybas.trip_details
                                JOIN mybas.ticket_sales_transaction as tc ON tc.trip_id = trip_details.id
                                WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                                AND tc.fare_type = 1;");

                                foreach($fareTypeTNG as $key4 => $tngSum){
                                    $grandServed->tng_collection = $tngSum->tng;
                                }

                                //Early Late
                                $grandTotEarlyLate = DB::select("SELECT count(trip_details.id) as countEarlyLate
                                FROM trip_details
                                WHERE trip_details.id IN ( 
                                SELECT trip_details.id
                                FROM mybas.trip_details
                                JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.id = trip_details.route_schedule_mstr_id
                                JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                                WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                                AND (TIMEDIFF(route_scheduler_mstr.schedule_start_time, cast(trip_details.start_trip as TIME)) < '-00:05:00'
                                OR TIMEDIFF(route_scheduler_mstr.schedule_start_time, cast(trip_details.start_trip as TIME)) > '00:05:00'));");

                                foreach($grandTotEarlyLate as $grandEarlyLateKey => $grandEarlyLate){
                                    $grandServed->earlyLate = $grandEarlyLate->countEarlyLate;
                                }

                                foreach($grandTotPlanned as $grandPlanKey => $grandPlanned){
                                    $grandServed->trip_planned = $grandPlanned->trip_planned;
                                    $grandServed->km_planned = $grandPlanned->km_planned;
                                    $grandServed->missed_trip = $countMissedTripGrand;
                                }
                            }

                            $newKey = $key + $count+1;
                            $out->writeln("last newKey: " . $newKey);
                            array_splice($allTrips, $newKey, 0, $grandTotServed);
                        }
                    }
                }
            }else{
                $companyDetails = Company::where('id', $this->selectedCompany)->first();
                $networkArea = $companyDetails->company_name;
                //Summary By Network all route specific company
                if($validatedData['route_id']=='All'){
                    $getAllRoutes = Route::where('status', 1)->where('company_id',$companyDetails->id)
                    ->orderBy('company_id')->orderBy('route_number')->get();
                    $allTrips = [];

                    foreach($getAllRoutes as $allRoute){
                        $out->writeln("All Route: " . $allRoute->route_number);

                        $tripPerRoute = DB::select("SELECT IFNULL(route.id, " .  $allRoute->id . ") as route_id, 
                        IFNULL(route.route_number, '" . $allRoute->route_number . "') as route_number, COUNT(DISTINCT(trip_details.bus_id)) as bus_deployed, 
                        (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                        IFNULL(SUM(trip_details.total_mileage),0.00) as km_served,
                        IFNULL((case when (route.company_id = 29) THEN 3.42 * SUM(trip_details.total_mileage) ELSE 1.33 *  SUM(trip_details.total_mileage) END), 0.00) as travel_claim,
                        IFNULL((SUM(trip_details.total_adult) + SUM(trip_details.total_concession)), 0) AS ridership
                        FROM mybas.trip_details
                        JOIN mybas.route ON route.id = trip_details.route_id
                        JOIN mybas.bus ON bus.id = trip_details.bus_id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        and trip_details.route_id = " . $allRoute->id . ";");

                        $out->writeln("In tripPerRoute > 0");
                        $allTrips = array_merge($allTrips, $tripPerRoute);
                    }
                    //dd($allTrips);

                    //Trip Planned
                    $tripPlanned = DB::select("SELECT route.route_number,
                    count(route_scheduler_details.id) as trip_planned, 
                    count(route_scheduler_details.id) * route.distance as km_planned
                    FROM mybas.route
                    JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                    JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                    WHERE route_scheduler_details.schedule_date BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                    AND route.status = 1
                    AND route.company_id = " . $companyDetails->id . "
                    GROUP BY route_number
                    ORDER BY route_number;");

                    $lastKey = array_key_last($allTrips);
                    $count = 0;
                    $countMissedTripGrand = 0;
                    foreach($allTrips as $key => $allTrip){
                        $out->writeln("New Loop: " . $key . " - " . $allTrip->route_number);
                        $found = false;

                        foreach($tripPlanned as $key2 => $tripPlan){
                            if($tripPlan->route_number == $allTrip->route_number){
                                $allTrip->trip_planned = $tripPlan->trip_planned;
                                $allTrip->km_planned = $tripPlan->km_planned;

                                //Total Missed Trip
                                $diff= $tripPlan->trip_planned - $allTrip->trip_served;
                                if($diff>0){
                                    $allTrip->missed_trip = $diff;
                                    $countMissedTripGrand += $diff;
                                }else{
                                    $allTrip->missed_trip = 0;
                                }

                                $found = true;
                                break ;
                            }
                        }
                        if(!$found){
                            $allTrip->trip_planned = 0;
                            $allTrip->km_planned = 0;
                            $allTrip->missed_trip = 0;
                        }
                        
                        //Cash
                        $fareTypeCash = DB::select("SELECT IFNULL(SUM(tc.actual_amount), 0.00) as cash
                        FROM mybas.trip_details
                        JOIN mybas.ticket_sales_transaction as tc ON tc.trip_id = trip_details.id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        and trip_details.route_id = " . $allTrip->route_id . "
                        AND tc.fare_type = 0;");

                        foreach($fareTypeCash as $key3 => $cashSum){
                            $allTrip->cash_collection = $cashSum->cash;
                        }

                        //TNG
                        $fareTypeTNG = DB::select("SELECT IFNULL(SUM(tc.actual_amount), 0.00) as tng
                        FROM mybas.trip_details
                        JOIN mybas.ticket_sales_transaction as tc ON tc.trip_id = trip_details.id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        and trip_details.route_id = " . $allTrip->route_id . "
                        AND tc.fare_type = 1;");

                        foreach($fareTypeTNG as $key4 => $tngSum){
                            $allTrip->tng_collection = $tngSum->tng;
                        }

                        //Early Late
                        $earlyLateCount = DB::select("SELECT count(trip_details.id) as countEarlyLate
                        FROM trip_details
                        WHERE trip_details.id IN ( 
                        SELECT trip_details.id
                        FROM mybas.trip_details
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.id = trip_details.route_schedule_mstr_id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND trip_details.route_id =  " . $allTrip->route_id . "
                        AND (TIMEDIFF(route_scheduler_mstr.schedule_start_time, cast(trip_details.start_trip as TIME)) < '-00:05:00'
                        OR TIMEDIFF(route_scheduler_mstr.schedule_start_time, cast(trip_details.start_trip as TIME)) > '00:05:00')
                        GROUP BY trip_details.id);");

                        foreach($earlyLateCount as $key5 => $earlyLate){
                            $allTrip->earlyLate = $earlyLate->countEarlyLate;
                        }

                        if($lastKey==$key){
                            $grandTotServed = DB::select("SELECT COUNT(DISTINCT(trip_details.bus_id)) as bus_deployed, 
                            (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                            SUM(trip_details.total_mileage) as km_served,
                            (case when (route.company_id = 29) THEN 3.42 * SUM(trip_details.total_mileage) ELSE 1.33 *  SUM(trip_details.total_mileage) END) as travel_claim,
                            SUM(trip_details.total_adult) + SUM(trip_details.total_concession) AS ridership
                            FROM mybas.trip_details
                            JOIN mybas.route ON route.id = trip_details.route_id
                            JOIN mybas.bus ON bus.id = trip_details.bus_id
                            WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND route.status=1
                            AND route.company_id=" . $companyDetails->id . ";");

                            $grandTotPlanned = DB::select("SELECT count(route_scheduler_details.id) as trip_planned, 
                            count(route_scheduler_details.id) * route.distance as km_planned
                            FROM mybas.route
                            JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                            JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                            WHERE route_scheduler_details.schedule_date BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                            AND route.status = 1
                            AND route.company_id=" . $companyDetails->id . ";");

                            foreach($grandTotServed as $grandInKey => $grandServed){
                                $out->writeln("In grand total loop");

                                //Cash
                                $fareTypeCash = DB::select("SELECT IFNULL(SUM(tc.actual_amount), 0.00) as cash
                                FROM mybas.trip_details
                                JOIN mybas.ticket_sales_transaction as tc ON tc.trip_id = trip_details.id
                                JOIN mybas.route ON route.id = trip_details.route_id
                                WHERE trip_details.start_trip BETWEEN '2022-07-01 00:00:00' AND '2022-07-31 23:59:59'
                                AND tc.fare_type = 0
                                AND route.company_id =" . $companyDetails->id . ";");

                                foreach($fareTypeCash as $key3 => $cashSum){
                                    $grandServed->cash_collection = $cashSum->cash;
                                }

                                //TNG
                                $fareTypeTNG = DB::select("SELECT IFNULL(SUM(tc.actual_amount), 0.00) as tng
                                FROM mybas.trip_details
                                JOIN mybas.ticket_sales_transaction as tc ON tc.trip_id = trip_details.id
                                JOIN mybas.route ON route.id = trip_details.route_id
                                WHERE trip_details.start_trip BETWEEN '2022-07-01 00:00:00' AND '2022-07-31 23:59:59'
                                AND tc.fare_type = 1
                                AND route.company_id =" . $companyDetails->id . ";");

                                foreach($fareTypeTNG as $key4 => $tngSum){
                                    $grandServed->tng_collection = $tngSum->tng;
                                }

                                //Early Late
                                $grandTotEarlyLate = DB::select("SELECT count(trip_details.id) as countEarlyLate
                                FROM trip_details
                                WHERE trip_details.id IN ( 
                                SELECT trip_details.id
                                FROM mybas.trip_details
                                JOIN mybas.route ON route.id = trip_details.route_id
                                JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.id = trip_details.route_schedule_mstr_id
                                JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                                WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                                AND route.company_id =" . $companyDetails->id . "
                                AND (TIMEDIFF(route_scheduler_mstr.schedule_start_time, cast(trip_details.start_trip as TIME)) < '-00:05:00'
                                OR TIMEDIFF(route_scheduler_mstr.schedule_start_time, cast(trip_details.start_trip as TIME)) > '00:05:00'));");

                                foreach($grandTotEarlyLate as $grandEarlyLateKey => $grandEarlyLate){
                                    $grandServed->earlyLate = $grandEarlyLate->countEarlyLate;
                                }

                                foreach($grandTotPlanned as $grandPlanKey => $grandPlanned){
                                    $grandServed->trip_planned = $grandPlanned->trip_planned;
                                    $grandServed->km_planned = $grandPlanned->km_planned;
                                    $grandServed->missed_trip = $countMissedTripGrand;
                                }
                            }

                            $newKey = $key + $count+1;
                            $out->writeln("last newKey: " . $newKey);
                            array_splice($allTrips, $newKey, 0, $grandTotServed);
                        }
                    }
                }
                //Summary By Network specific route specific company
                else{
                    $allRoute = Route::where('status', 1)->where('id',$validatedData['route_id'])
                    ->orderBy('company_id')->orderBy('route_number')->first();
                    $allTrips = [];

                    if($allRoute){
                        $out->writeln("All Route: " . $allRoute->route_number);

                        $tripPerRoute = DB::select("SELECT IFNULL(route.id, " .  $allRoute->id . ") as route_id, 
                        IFNULL(route.route_number, '" . $allRoute->route_number . "') as route_number, COUNT(DISTINCT(trip_details.bus_id)) as bus_deployed, 
                        (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                        IFNULL(SUM(trip_details.total_mileage),0.00) as km_served,
                        IFNULL((case when (route.company_id = 29) THEN 3.42 * SUM(trip_details.total_mileage) ELSE 1.33 *  SUM(trip_details.total_mileage) END), 0.00) as travel_claim,
                        IFNULL((SUM(trip_details.total_adult) + SUM(trip_details.total_concession)), 0) AS ridership
                        FROM mybas.trip_details
                        JOIN mybas.route ON route.id = trip_details.route_id
                        JOIN mybas.bus ON bus.id = trip_details.bus_id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        and trip_details.route_id = " . $allRoute->id . ";");

                        $out->writeln("In tripPerRoute > 0");
                        $allTrips = array_merge($allTrips, $tripPerRoute);
                    }
                    //dd($allTrips);

                    //Trip Planned
                    $tripPlanned = DB::select("SELECT route.route_number,
                    count(route_scheduler_details.id) as trip_planned, 
                    count(route_scheduler_details.id) * route.distance as km_planned
                    FROM mybas.route
                    JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                    JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                    WHERE route_scheduler_details.schedule_date BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                    AND route.status = 1
                    AND route.id = " . $validatedData['route_id'] . "
                    GROUP BY route_number
                    ORDER BY route_number;");

                    $lastKey = array_key_last($allTrips);
                    $count = 0;
                    $countMissedTripGrand = 0;
                    foreach($allTrips as $key => $allTrip){
                        $out->writeln("New Loop: " . $key . " - " . $allTrip->route_number);
                        $found = false;

                        foreach($tripPlanned as $key2 => $tripPlan){
                            if($tripPlan->route_number == $allTrip->route_number){
                                $allTrip->trip_planned = $tripPlan->trip_planned;
                                $allTrip->km_planned = $tripPlan->km_planned;

                                //Total Missed Trip
                                $diff= $tripPlan->trip_planned - $allTrip->trip_served;
                                if($diff>0){
                                    $allTrip->missed_trip = $diff;
                                    $countMissedTripGrand += $diff;
                                }else{
                                    $allTrip->missed_trip = 0;
                                }

                                $found = true;
                                break ;
                            }
                        }
                        if(!$found){
                            $allTrip->trip_planned = 0;
                            $allTrip->km_planned = 0;
                            $allTrip->missed_trip = 0;
                        }
                        
                        //Cash
                        $fareTypeCash = DB::select("SELECT IFNULL(SUM(tc.actual_amount), 0.00) as cash
                        FROM mybas.trip_details
                        JOIN mybas.ticket_sales_transaction as tc ON tc.trip_id = trip_details.id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        and trip_details.route_id = " . $allTrip->route_id . "
                        AND tc.fare_type = 0;");

                        foreach($fareTypeCash as $key3 => $cashSum){
                            $allTrip->cash_collection = $cashSum->cash;
                        }

                        //TNG
                        $fareTypeTNG = DB::select("SELECT IFNULL(SUM(tc.actual_amount), 0.00) as tng
                        FROM mybas.trip_details
                        JOIN mybas.ticket_sales_transaction as tc ON tc.trip_id = trip_details.id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        and trip_details.route_id = " . $allTrip->route_id . "
                        AND tc.fare_type = 1;");

                        foreach($fareTypeTNG as $key4 => $tngSum){
                            $allTrip->tng_collection = $tngSum->tng;
                        }

                        //Early Late
                        $earlyLateCount = DB::select("SELECT count(trip_details.id) as countEarlyLate
                        FROM trip_details
                        WHERE trip_details.id IN ( 
                        SELECT trip_details.id
                        FROM mybas.trip_details
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.id = trip_details.route_schedule_mstr_id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND trip_details.route_id =  " . $allTrip->route_id . "
                        AND (TIMEDIFF(route_scheduler_mstr.schedule_start_time, cast(trip_details.start_trip as TIME)) < '-00:05:00'
                        OR TIMEDIFF(route_scheduler_mstr.schedule_start_time, cast(trip_details.start_trip as TIME)) > '00:05:00')
                        GROUP BY trip_details.id);");

                        foreach($earlyLateCount as $key5 => $earlyLate){
                            $allTrip->earlyLate = $earlyLate->countEarlyLate;
                        }

                        if($lastKey==$key){
                            $grandTotal = new \stdClass;

                            $grandTotal->bus_deployed = $allTrip->bus_deployed;
                            $grandTotal->trip_served = $allTrip->trip_served;
                            $grandTotal->km_served = $allTrip->km_served;
                            $grandTotal->travel_claim = $allTrip->travel_claim;
                            $grandTotal->ridership = $allTrip->ridership;
                            $grandTotal->cash_collection = $allTrip->cash_collection;
                            $grandTotal->tng_collection = $allTrip->tng_collection;
                            $grandTotal->earlyLate = $allTrip->earlyLate;
                            $grandTotal->trip_planned = $allTrip->trip_planned;
                            $grandTotal->km_planned = $allTrip->km_planned;
                            $grandTotal->missed_trip = $allTrip->missed_trip;

                            $grandTotServed[] = $grandTotal;

                            $newKey = $key + $count+1;
                            $out->writeln("last newKey: " . $newKey);
                            array_splice($allTrips, $newKey, 0, $grandTotServed);
                        }
                    }
                }
            }
            return Excel::download(new SPADSummaryByNetwork($allTrips, $validatedData['dateFrom'], $validatedData['dateTo'], $networkArea), 'Summary_By_Network_Report_SPAD_'.Carbon::now()->format('YmdHis').'.xlsx');
        }else{
            $this->dispatchBrowserEvent('company-required');
        }
    }

    //FAST
    public function printISBSFFailed()
    {
        $out = new ConsoleOutput();
        $out->writeln("YOU ARE IN printISBSF()");

        $validatedData = Validator::make($this->state,[
            'dateFrom' => ['required', 'date'],
            'dateTo' => ['required', 'date'],
            'route_id' => ['required'],
        ])->validate();

        $dateFrom = new Carbon($validatedData['dateFrom']);
        $dateTo = new Carbon($validatedData['dateTo'] . " 23:59:59");

        $startDate = new Carbon($validatedData['dateFrom']);
        $endDate = new Carbon($validatedData['dateTo'] . " 23:59:59");
        $all_dates = array();
        $days = array();

        while ($startDate->lte($endDate)){
            $all_dates[] = $startDate->toDateString();
            $days[] = $startDate->day;
            $startDate->addDay();
        }

        $isbsfSPAD = collect();
        $colspan = count($all_dates) + 3;
        $monthName = $dateFrom->format('M Y');
        if ($this->selectedCompany){
            if($this->selectedCompany=='All'){
                $networkArea = 'All';
                //ISBSF all route all company
                if($validatedData['route_id']=='All'){

                    $allRoutes = Route::where('status', 1)->orderBy('route_number')->get();
                    $allTrips = [];
                    foreach($allRoutes as $key => $allRoute){

                        //Completed Trip IBOB
                        $servedTrips = DB::select("SELECT  trip_code, route.route_number, route.route_name, cast(trip_details.start_trip as date) as service_date,
                        (case when (count(trip_details.id) = 0) THEN 0 ELSE count(trip_details.id) END) as trip_served, 
                        SUM(trip_details.total_mileage) as km_served,
                        SUM(total_adult_amount) + SUM(total_concession_amount) AS farebox, 
                        SUM(total_adult) + SUM(total_concession) AS ridership
                        FROM mybas.trip_details
                        JOIN mybas.route ON route.id = trip_details.route_id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND route.id = " . $allRoute->id . "
                        GROUP BY route_number, service_date, trip_code
                        ORDER BY route_number, service_date, trip_code; ");

                        //Planned Trip
                        $plannedTrips = DB::select("SELECT route.route_number, route.route_name,
                        cast(route_scheduler_details.schedule_date as date) as planned_date,
                        count(route_scheduler_details.id) as trip_planned
                        FROM mybas.route
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.route_id = route.id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE route_scheduler_details.schedule_date BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND route.id = " . $allRoute->id . "
                        GROUP BY route_number, planned_date
                        ORDER BY route_number, planned_date;");

                        //Bus Deployed
                        $deployedBuses = DB::select("SELECT route.route_number, route.route_name, cast(trip_details.start_trip as date) as service_date,
                        COUNT(DISTINCT(trip_details.bus_id)) as bus_deployed
                        FROM mybas.trip_details
                        JOIN mybas.route ON route.id = trip_details.route_id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND route.id = " . $allRoute->id . "
                        GROUP BY route_number, service_date
                        ORDER BY route_number, service_date;");

                        //Trip Ontime
                        $ontimeTrips = DB::select("SELECT count(trip_details.id) as countOntime
                        FROM trip_details
                        WHERE trip_details.id IN ( 
                        SELECT trip_details.id
                        FROM mybas.trip_details
                        JOIN mybas.route_scheduler_mstr ON route_scheduler_mstr.id = trip_details.route_schedule_mstr_id
                        JOIN mybas.route_scheduler_details ON route_scheduler_details.route_scheduler_mstr_id = route_scheduler_mstr.id
                        WHERE trip_details.start_trip BETWEEN '" . $dateFrom . "' AND '" . $dateTo . "'
                        AND trip_details.route_id = " . $allRoute->id . "
                        AND TIMEDIFF(route_scheduler_mstr.schedule_start_time, cast(trip_details.start_trip as TIME)) > '-00:05:00'
                        AND TIMEDIFF(route_scheduler_mstr.schedule_start_time, cast(trip_details.start_trip as TIME)) < '00:05:00'
                        GROUP BY trip_details.id);");

                        $planned_trip = new \stdClass;
                        $trip_ib = new \stdClass;
                        $trip_ob = new \stdClass;
                        $total_trip = new \stdClass;
                        $trip_compliance = new \stdClass;
                        $planned_trip = new \stdClass;
                        $off_route = new \stdClass;
                        $route_compliance = new \stdClass;
                        $km_ib = new \stdClass;
                        $km_ob = new \stdClass;
                        $tot_km_ib = new \stdClass;
                        $tot_km_ob = new \stdClass;
                        $tot_km = new \stdClass;
                        $currDate = "";
                        $i=0;
                        $totTripPlanned = 0;
                        $routeArr = [];
                        $plannedTripArr = [];

                        $route = new \stdClass;
                        $route->route_name = $allRoute->route_number . " " . $allRoute->route_name;
                        $routeArr[] = $route;
                        $allTrips = array_merge($allTrips, $routeArr);
                        
                        foreach($plannedTrips as $key => $plannedTrip){
                            $name = "planned_trip_" . $i;
                            $planned_trip->$name = $plannedTrip->trip_planned;
                            $i++;
                            $totTripPlanned += $plannedTrip->trip_planned;
                        }
                        $name = "planned_trip_" . $i;
                        $planned_trip->$name = $totTripPlanned;
                        $plannedTripArr[] = $planned_trip;
                        $allTrips = array_merge($allTrips, $plannedTripArr);

                        $i=0;
                        $o=0;
                        $c=0;
                        $kmi=0;
                        $kmo=0;
                        $totTripInbound = 0;
                        $totTripOutbound = 0;
                        $totTripCompleted = 0;
                        $totKMInbound = 0;
                        $totKMOutbound = 0;
                        $totalKMInbound = 0;
                        $totalKMOutbound = 0;
                        $totKMCompleted =0;
                        $inboundTripArr = [];
                        $outboundTripArr = [];
                        $completedTripArr = [];
                        $nameCompleted = "completed_trip_" . $c;
                        $kmCompleted = "completed_km_" . $c;
                        $nameIB = "inbound_trip_" . $i;
                        $nameKMI = "inbound_km_" . $i;
                        $totKMI = "tot_inbound_km_" . $i;
                        $nameOB = "outbound_trip_" . $o;
                        $nameKMO = "inbound_km_" . $o;
                        $totKMO = "tot_inbound_km_" . $o;
                        $lastKey = array_key_last($servedTrips);
                        $pastDate = NULL;
                        foreach($servedTrips as $key => $servedTrip){
                            if($servedTrip->service_date != $pastDate && $pastDate != NULL){
                                $completed_trip->$nameCompleted = $pastTripIB + $pastTripOB;
                                $totTripCompleted += $completed_trip->$nameCompleted;

                                $tot_km->$kmCompleted = $pastKMIB + $pastKMOB;
                                $totKMCompleted += $tot_km->$kmCompleted;
                                $c++;
                            }

                            if($servedTrip->trip_code == 1 ){
                                $inbound_trip->$nameIB = $servedTrip->trip_served;
                                $totTripInbound += $servedTrip->trip_served;

                                $km_ib->$nameKMI = $allRoute->inbound_distance;
                                $totKMInbound += $allRoute->inbound_distance;

                                $tot_km_ib->$totKMI = $servedTrip->trip_served * $allRoute->inbound_distance;
                                $totalKMInbound += $servedTrip->trip_served * $allRoute->inbound_distance;

                                $i++;
                                $pastTripIB = $servedTrip->trip_served;
                                $pastKMIB = $tot_km_ib->$totKMI;
                            }

                            if($servedTrip->trip_code == 0){
                                $outbound_trip->$nameOB = $servedTrip->trip_served;
                                $totTripOutbound += $servedTrip->trip_served;

                                $km_ob->$nameKMO = $allRoute->outbound_distance;
                                $totKMOutbound += $allRoute->outbound_distance;

                                $tot_km_ob->$totKMO = $servedTrip->trip_served * $allRoute->outbound_distance;
                                $totalKMOutbound += $servedTrip->trip_served * $allRoute->outbound_distance;
                               
                                $o++;
                                $pastTripOB = $servedTrip->trip_served;
                                $pastKMOB = $tot_km_ob->$totKMI;
                            }
                            $pastDate = $servedTrip->service_date;

                            if($lastKey==$key){
                                $completed_trip->$nameCompleted = $pastTripIB + $pastTripOB;
                                $totTripCompleted += $completed_trip->$nameCompleted;

                                $tot_km->$kmCompleted = $pastKMIB + $pastKMOB;
                                $totKMCompleted += $tot_km->$kmCompleted;
                                $c++;
                            }
                        }
                        $inbound_trip->$nameIB = $totTripInbound;
                        $inboundTripArr[] = $inbound_trip;
                        $allTrips = array_merge($allTrips, $inboundTripArr);

                        $km_ib->$nameKMI = $totKMInbound;
                        $inboundKMArr[] = $km_ib;
                        $allTrips = array_merge($allTrips, $inboundKMArr);

                        $tot_km_ib->$totKMI = $totalKMInbound;
                        $totInboundKMArr[] = $tot_km_ib;
                        $allTrips = array_merge($allTrips, $totInboundKMArr);

                        $outbound_trip->$nameOB = $totTripOutbound;
                        $outboundTripArr[] = $outbound_trip;
                        $allTrips = array_merge($allTrips, $outboundTripArr);

                        $km_ob->$nameKMO = $totKMOutbound;
                        $outboundKMArr[] = $km_ob;
                        $allTrips = array_merge($allTrips, $outboundKMArr);

                        $tot_km_ob->$totKMO = $totalKMOutbound;
                        $totOutboundKMArr[] = $tot_km_ob;
                        $allTrips = array_merge($allTrips, $totOutboundKMArr);

                        $completed_trip->$nameCompleted = $totTripCompleted;
                        $tripCompletedArr[] = $completed_trip;
                        $allTrips = array_merge($allTrips, $tripCompletedArr);

                        $tot_km->$kmCompleted = $totKMCompleted;
                        $kmCompletedArr[] = $tot_km;
                        $allTrips = array_merge($allTrips, $kmCompletedArr);
                        dd($allTrips);
                    }
                    dd($allTrips);
                }
            }
            else{
                $companyDetails = Company::where('id', $this->selectedCompany)->first();
                $networkArea = $companyDetails->company_name;

                //ISBSF all route all company
                if($validatedData['route_id']=='All'){

                }
                else{

                }
            }
            return Excel::download(new SPADIsbsf($isbsfSPAD, $validatedData['dateFrom'], $validatedData['dateTo'], $colspan, $all_dates, $monthName, $days, $networkArea), 'ISBSF_Report_SPAD_'.Carbon::now()->format('YmdHis').'.xlsx');
        }else{
            $this->dispatchBrowserEvent('company-required');
        }

    }

    public function printISBSF()
    {
        $out = new ConsoleOutput();
        $out->writeln("YOU ARE IN printISBSF()");

        $validatedData = Validator::make($this->state,[
            'dateFrom' => ['required', 'date'],
            'dateTo' => ['required', 'date'],
            'route_id' => ['required'],
        ])->validate();

        $dateFrom = new Carbon($validatedData['dateFrom']);

        $startDate = new Carbon($validatedData['dateFrom']);
        $endDate = new Carbon($validatedData['dateTo']);
        $all_dates = array();
        $days = array();

        while ($startDate->lte($endDate)){
            $all_dates[] = $startDate->toDateString();
            $days[] = $startDate->day;
            $startDate->addDay();
        }

        $isbsfSPAD = collect();
        $colspan = count($all_dates) + 3;
        $monthName = $dateFrom->format('M Y');
        if ($this->selectedCompany){
            if($this->selectedCompany=='All'){
                $networkArea = 'All';
                if(!empty($validatedData['route_id'])) {
                    //ISBSF all route all company
                    if($validatedData['route_id']=='All'){
                        $allRoutes = Route::orderBy('route_number')->get();
                        $i = 0;
            
                        foreach ($allRoutes as $allRoute) {
                            $finalPlannedTrip=0;
                            $finalCompletedIn=0;
                            $finalCompletedOut=0;
                            $finalTotalCompletedTrip=0;
                            $finalOffRoute=0;
                            $finalInboundDistance=0;
                            $finalOutboundDistance=0;
                            $finalTotalDistanceIn=0;
                            $finalTotalDistanceOut=0;
                            $finalTotalDistance=0;
                            $finalTripOnTime=0;
                            $finalTotalTripBreakdown=0;
                            $finalNumBus=0;
                            $finalFarebox=0;
                            $finalRidership=0;
                            $sumTripCompliance=0;
                            $sumRouteCompliance=0;
                            $sumPunctuality=0;
                            $sumRealibility=0;
            
                            $routeName = $allRoute->route_number . ' ' . $allRoute->route_name;
            
                            foreach ($all_dates as $all_date) {
                                $firstDate = new Carbon($all_date);
                                $lastDate = new Carbon($all_date .'23:59:59');
            
                                //Planned Trip
                                $plannedTrip = 0;
                                $schedules = RouteSchedulerDetail::whereBetween('schedule_date', [$firstDate,$lastDate])->get();
                                if (count($schedules) > 0) {
                                    foreach ($schedules as $schedule) {
                                        if ($schedule->RouteScheduleMSTR->route_id == $allRoute->id) {
                                            $plannedTrip++;
                                        }
                                    }
                                }
                                $plannedTripArr[$all_date] = $plannedTrip;
                                $finalPlannedTrip += $plannedTrip;
            
                                $allTrips = TripDetail::where('route_id',  $allRoute->id)
                                    ->whereBetween('start_trip', [$firstDate,$lastDate])
                                    ->get();
            
                                $ontimeCount = 0;
                                $farebox =0;
                                $ridership =0;
                                $completedOut =0;
                                $completedIn =0;
                                if(count($allTrips)>0) {
                                    foreach ($allTrips as $allTrip) {
                                        //Trip On Time
                                        if($allTrip->route_schedule_mstr_id!=NULL){
                                            $diff = strtotime($allTrip->RouteScheduleMSTR->schedule_start_time) - strtotime($allTrip->start_trip);
                                            if ($diff < 5 || $diff > -5) {
                                                $ontimeCount++;
                                            }
                                        }
                                        //Farebox
                                        $adultFarebox = $allTrip->total_adult_amount;
                                        $concessionFarebox = $allTrip->total_concession_amount;
                                        $sumFarebox = $adultFarebox + $concessionFarebox;
                                        $farebox += $sumFarebox;
                                        //Ridership
                                        $adultRidership = $allTrip->total_adult;
                                        $concessionRidership = $allTrip->total_concession;
                                        $sumRidership = $adultRidership + $concessionRidership;
                                        $ridership += $sumRidership;
            
                                        //Completed Trip Out & In
                                        if($allTrip->trip_code==0){
                                            $completedOut++;
                                        }elseif($allTrip->trip_code==1){
                                            $completedIn++;
                                        }
                                    }
                                }
                                $totalTripOnTimeArr[$all_date] = $ontimeCount;
                                $finalTripOnTime += $ontimeCount;
            
                                $fareboxArr[$all_date] = $farebox;
                                $finalFarebox += $farebox;
            
                                $ridershipArr[$all_date] = $ridership;
                                $finalRidership += $ridership;
            
                                $completedOutArr[$all_date] = $completedOut;
                                $finalCompletedOut += $completedOut;
            
                                $completedInArr[$all_date] = $completedIn;
                                $finalCompletedIn += $completedIn;
            
                                //Total Completed Trip
                                $totalCompletedTrip = $completedOut + $completedIn;
                                $totalCompletedTripArr[$all_date] = $totalCompletedTrip;
                                $finalTotalCompletedTrip += $totalCompletedTrip;
            
                                //Trip Compliance
                                if($plannedTrip==0){
                                    $tripCompliance = 0;
                                }else{
                                    $tripCompliance = round((($totalCompletedTrip/$plannedTrip) * 100),1);
                                }
                                $tripComplianceArr[$all_date] = $tripCompliance;
                                $sumTripCompliance += $tripCompliance;
            
                                /**Need to recalculate Off Route**/
                                $offRoute = 0;
                                $totalOffRouteArr[$all_date] = $offRoute;
                                $finalOffRoute += $offRoute;
            
                                //KM 1 Way Outbound
                                $outboundDistance = $allRoute->outbound_distance;
                                $outboundDistanceArr[$all_date] = $outboundDistance;
                                $finalOutboundDistance += $outboundDistance;
            
                                //KM 1 Way Inbound
                                $inboundDistance = $allRoute->inbound_distance;
                                $inboundDistanceArr[$all_date] = $inboundDistance;
                                $finalInboundDistance += $inboundDistance;
            
                                //Total KM Outbound
                                $totalDistanceOut = $outboundDistance * $completedOut;
                                $totalDistanceOutArr[$all_date] = $totalDistanceOut;
                                $finalTotalDistanceOut += $totalDistanceOut;
            
                                //Total KM Inbound
                                $totalDistanceIn = $inboundDistance * $completedIn;
                                $totalDistanceInArr[$all_date] = $totalDistanceIn;
                                $finalTotalDistanceIn += $totalDistanceIn;
            
                                //Total KM
                                $totalDistance = $totalDistanceIn + $totalDistanceOut;
                                $totalDistanceArr[$all_date] = $totalDistance;
                                $finalTotalDistance += $totalDistance;
            
                                /**Need to recalculate Total Trip Breakdown**/
                                $totalTripBreakdown = 0;
                                $totalTripBreakdownArr[$all_date] = $totalTripBreakdown;
                                $finalTotalTripBreakdown += $totalTripBreakdown;
            
                                //Punctuality Adherence
                                //Realibility Breakdown
                                //Route Compliance
                                if($totalCompletedTrip==0){
                                    $punctuality = 0;
                                    $realibility = 0;
                                    $routeCompliance = 0;
                                }else{
                                    $punctuality = round((($ontimeCount / $totalCompletedTrip) * 100),1);
                                    $realibility =  round(((($totalCompletedTrip - $totalTripBreakdown) / $totalCompletedTrip) * 100),1);
                                    $routeCompliance = round(((($totalCompletedTrip - $offRoute) / $totalCompletedTrip) * 100),1);
                                }
                                $punctualityArr[$all_date] = $punctuality;
                                $sumPunctuality += $punctuality;
                                $realibilityArr[$all_date] = $realibility;
                                $sumRealibility += $realibility;
                                $routeComplianceArr[$all_date] = $routeCompliance;
                                $sumRouteCompliance += $routeCompliance;
            
                                //Number of Bus
                                $numBus = TripDetail::whereBetween('start_trip',[$firstDate,$lastDate])
                                    ->where('route_id', $allRoute->id)
                                    ->distinct('bus_id')
                                    ->count();
                                $numBusArr[$all_date] = $numBus;
                                $finalNumBus += $numBus;
                            }
                            $finalTripCompliance = round((($sumTripCompliance/(count($all_dates)*100))*100),1);
                            $finalRouteCompliance = round((($sumRouteCompliance/(count($all_dates)*100))*100),1);
                            $finalPunctuality = round((($sumPunctuality/(count($all_dates)*100))*100),1);
                            $finalRealibility = round((($sumRealibility/(count($all_dates)*100))*100),1);
            
                            // $tripComplianceFormat = number_format((float)$finalTripCompliance, 1, '.', '');
                            // $routeComplianceFormat = number_format((float)$finalRouteCompliance, 1, '.', '');
                            // $punctualityFormat = number_format((float)$finalPunctuality, 1, '.', '');
                            // $realibilityFormat = number_format((float)$finalRealibility, 1, '.', '');
            
                            $plannedTripArr['final_total'] = $finalPlannedTrip;
                            $completedInArr['final_total'] = $finalCompletedIn;
                            $completedOutArr['final_total'] = $finalCompletedOut;
                            $totalCompletedTripArr['final_total'] = $finalTotalCompletedTrip;
                            $tripComplianceArr['final_total'] = $finalTripCompliance;
                            $totalOffRouteArr['final_total'] = $finalOffRoute;
                            $routeComplianceArr['final_total'] = $finalRouteCompliance;
                            $inboundDistanceArr['final_total'] = $finalInboundDistance;
                            $outboundDistanceArr['final_total'] = $finalOutboundDistance;
                            $totalDistanceInArr['final_total'] = $finalTotalDistanceIn;
                            $totalDistanceOutArr['final_total'] = $finalTotalDistanceOut;
                            $totalDistanceArr['final_total'] = $finalTotalDistance;
                            $totalTripOnTimeArr['final_total'] = $finalTripOnTime;
                            $punctualityArr['final_total'] = $finalPunctuality;
                            $totalTripBreakdownArr['final_total'] = $finalTotalTripBreakdown;
                            $realibilityArr['final_total'] = $finalRealibility;
                            $numBusArr['final_total'] = $finalNumBus;
                            $fareboxArr['final_total'] = $finalFarebox;
                            $ridershipArr['final_total'] = $finalRidership;
            
                            $content['planned_trip'] = $plannedTripArr;
                            $content['completed_trip_in'] = $completedInArr;
                            $content['completed_trip_out'] = $completedOutArr;
                            $content['total_completed_trip'] = $totalCompletedTripArr;
                            $content['trip_compliance'] = $tripComplianceArr;
                            $content['total_off_route'] = $totalOffRouteArr;
                            $content['route_compliance'] = $routeComplianceArr;
                            $content['distance_in'] = $inboundDistanceArr;
                            $content['distance_out'] = $outboundDistanceArr;
                            $content['total_distance_in'] = $totalDistanceInArr;
                            $content['total_distance_out'] = $totalDistanceOutArr;
                            $content['total_distance'] = $totalDistanceArr;
                            $content['total_trip_on_time'] = $totalTripOnTimeArr;
                            $content['punctuality'] = $punctualityArr;
                            $content['total_trip_breakdown'] = $totalTripBreakdownArr;
                            $content['realibility'] = $realibilityArr;
                            $content['num_of_bus'] = $numBusArr;
                            $content['farebox'] = $fareboxArr;
                            $content['ridership'] = $ridershipArr;
            
                            $data[$routeName] = $content;
                        }
                        $isbsfSPAD->add($data);
                    }
                }
            }else{
                $companyDetails = Company::where('id', $this->selectedCompany)->first();
                $networkArea = $companyDetails->company_name;

                if(!empty($validatedData['route_id'])) {
                    //ISBSF all route specific company
                    if($validatedData['route_id']=='All'){
                        $routeByCompanies = Route::where('company_id', $this->selectedCompany)->orderBy('route_number')->get();
        
                        foreach ($routeByCompanies as $routeByCompany) {
                            $routeName = $routeByCompany->route_number . ' ' . $routeByCompany->route_name;
                            $finalPlannedTrip=0;
                            $finalCompletedIn=0;
                            $finalCompletedOut=0;
                            $finalTotalCompletedTrip=0;
                            $finalOffRoute=0;
                            $finalInboundDistance=0;
                            $finalOutboundDistance=0;
                            $finalTotalDistanceIn=0;
                            $finalTotalDistanceOut=0;
                            $finalTotalDistance=0;
                            $finalTripOnTime=0;
                            $finalTotalTripBreakdown=0;
                            $finalNumBus=0;
                            $finalFarebox=0;
                            $finalRidership=0;
                            $sumTripCompliance=0;
                            $sumRouteCompliance=0;
                            $sumPunctuality=0;
                            $sumRealibility=0;
        
                            foreach ($all_dates as $all_date) {
                                $firstDate = new Carbon($all_date);
                                $lastDate = new Carbon($all_date . '23:59:59');
        
                                //Planned Trip
                                $plannedTrip = 0;
                                $schedules = RouteSchedulerDetail::whereBetween('schedule_date', [$firstDate,$lastDate])->get();
                                if (count($schedules) > 0) {
                                    foreach ($schedules as $schedule) {
                                        if ($schedule->RouteScheduleMSTR->route_id == $routeByCompany->id) {
                                            $plannedTrip++;
                                        }
                                    }
                                }
                                $plannedTripArr[$all_date] = $plannedTrip;
                                $finalPlannedTrip += $plannedTrip;
        
                                $allTrips = TripDetail::where('route_id',  $routeByCompany->id)
                                    ->whereBetween('start_trip',[$firstDate,$lastDate])
                                    ->get();
        
                                $ontimeCount = 0;
                                $farebox =0;
                                $ridership =0;
                                $completedOut = 0;
                                $completedIn = 0;
                                if(count($allTrips)>0) {
                                    foreach ($allTrips as $allTrip) {
                                        //Trip On Time
                                        if($allTrip->route_schedule_mstr_id!=NULL){
                                            $diff = strtotime($allTrip->RouteScheduleMSTR->schedule_start_time) - strtotime($allTrip->start_trip);
                                            if ($diff < 5 || $diff > -5) {
                                                $ontimeCount++;
                                            }
                                        }
                                        //Farebox
                                        $adultFarebox = $allTrip->total_adult_amount;
                                        $concessionFarebox = $allTrip->total_concession_amount;
                                        $sumFarebox = $adultFarebox + $concessionFarebox;
                                        $farebox += $sumFarebox;
                                        //Ridership
                                        $adultRidership = $allTrip->total_adult;
                                        $concessionRidership = $allTrip->total_concession;
                                        $sumRidership = $adultRidership + $concessionRidership;
                                        $ridership += $sumRidership;
        
                                        //Completed Trip Out & In
                                        if($allTrip->trip_code==0){
                                            $completedOut++;
                                        }elseif($allTrip->trip_code==1){
                                            $completedIn++;
                                        }
                                    }
                                }
                                $totalTripOnTimeArr[$all_date] = $ontimeCount;
                                $finalTripOnTime += $ontimeCount;
                                $fareboxArr[$all_date] = $farebox;
                                $finalFarebox += $farebox;
                                $ridershipArr[$all_date] = $ridership;
                                $finalRidership += $ridership;
                                $completedOutArr[$all_date] = $completedOut;
                                $finalCompletedOut += $completedOut;
                                $completedInArr[$all_date] = $completedIn;
                                $finalCompletedIn += $completedIn;
        
                                //Total Completed Trip
                                $totalCompletedTrip = $completedOut + $completedIn;
                                $totalCompletedTripArr[$all_date] = $totalCompletedTrip;
                                $finalTotalCompletedTrip += $totalCompletedTrip;
        
                                //Trip Compliance
                                if($plannedTrip==0){
                                    $tripCompliance = 0;
                                }else{
                                    $tripCompliance = round((($totalCompletedTrip/$plannedTrip) * 100),1);
                                }
                                $tripComplianceArr[$all_date] = $tripCompliance;
                                $sumTripCompliance += $tripCompliance;
        
                                /**Need to recalculate Off Route**/
                                $offRoute = 0;
                                $totalOffRouteArr[$all_date] = $offRoute;
                                $finalOffRoute += $offRoute;
        
                                //KM 1 Way Outbound
                                $outboundDistance = $routeByCompany->outbound_distance;
                                $outboundDistanceArr[$all_date] = $outboundDistance;
                                $finalOutboundDistance += $outboundDistance;
        
                                //KM 1 Way Inbound
                                $inboundDistance = $routeByCompany->inbound_distance;
                                $inboundDistanceArr[$all_date] = $inboundDistance;
                                $finalInboundDistance += $inboundDistance;
        
                                //Total KM Outbound
                                $totalDistanceOut = $outboundDistance * $completedOut;
                                $totalDistanceOutArr[$all_date] = $totalDistanceOut;
                                $finalTotalDistanceOut += $totalDistanceOut;
            
                                //Total KM Inbound
                                $totalDistanceIn = $inboundDistance * $completedIn;
                                $totalDistanceInArr[$all_date] = $totalDistanceIn;
                                $finalTotalDistanceIn += $totalDistanceIn;
        
                                //Total KM
                                $totalDistance = $totalDistanceIn + $totalDistanceOut;
                                $totalDistanceArr[$all_date] = $totalDistance;
                                $finalTotalDistance += $totalDistance;
        
                                /**Need to recalculate Total Trip Breakdown**/
                                $totalTripBreakdown = 0;
                                $totalTripBreakdownArr[$all_date] = $totalTripBreakdown;
                                $finalTotalTripBreakdown += $totalTripBreakdown;
        
                                //Punctuality Adherence
                                //Realibility Breakdown
                                //Route Compliance
                                if($totalCompletedTrip==0){
                                    $punctuality = 0;
                                    $realibility = 0;
                                    $routeCompliance = 0;
                                }else{
                                    $punctuality = round((($ontimeCount / $totalCompletedTrip) * 100),1);
                                    $realibility = round(((($totalCompletedTrip - $totalTripBreakdown) / $totalCompletedTrip) * 100),1);
                                    $routeCompliance = round(((($totalCompletedTrip - $offRoute) / $totalCompletedTrip) * 100),1);
                                }
                                $punctualityArr[$all_date] = $punctuality;
                                $sumPunctuality += $punctuality;
                                $realibilityArr[$all_date] = $realibility;
                                $sumRealibility += $realibility;
                                $routeComplianceArr[$all_date] = $routeCompliance;
                                $sumRouteCompliance += $routeCompliance;
        
                                //Number of Bus
                                $numBus = TripDetail::whereBetween('start_trip',[$firstDate,$lastDate])
                                    ->where('route_id',  $routeByCompany->id)
                                    ->distinct('bus_id')
                                    ->count();
                                $numBusArr[$all_date] = $numBus;
                                $finalNumBus += $numBus;
                            }
                            $finalTripCompliance = round((($sumTripCompliance/(count($all_dates)*100))*100),1);
                            $finalRouteCompliance = round((($sumRouteCompliance/(count($all_dates)*100))*100),1);
                            $finalPunctuality = round((($sumPunctuality/(count($all_dates)*100))*100),1);
                            $finalRealibility = round((($sumRealibility/(count($all_dates)*100))*100),1);
        
                            // $tripComplianceFormat = number_format((float)$finalTripCompliance, 1, '.', '');
                            // $routeComplianceFormat = number_format((float)$finalRouteCompliance, 1, '.', '');
                            // $punctualityFormat = number_format((float)$finalPunctuality, 1, '.', '');
                            // $realibilityFormat = number_format((float)$finalRealibility, 1, '.', '');
        
                            $plannedTripArr['final_total'] = $finalPlannedTrip;
                            $completedInArr['final_total'] = $finalCompletedIn;
                            $completedOutArr['final_total'] = $finalCompletedOut;
                            $totalCompletedTripArr['final_total'] = $finalTotalCompletedTrip;
                            $tripComplianceArr['final_total'] = $finalTripCompliance;
                            $totalOffRouteArr['final_total'] = $finalOffRoute;
                            $routeComplianceArr['final_total'] = $finalRouteCompliance;
                            $inboundDistanceArr['final_total'] = $finalInboundDistance;
                            $outboundDistanceArr['final_total'] = $finalOutboundDistance;
                            $totalDistanceInArr['final_total'] = $finalTotalDistanceIn;
                            $totalDistanceOutArr['final_total'] = $finalTotalDistanceOut;
                            $totalDistanceArr['final_total'] = $finalTotalDistance;
                            $totalTripOnTimeArr['final_total'] = $finalTripOnTime;
                            $punctualityArr['final_total'] = $finalPunctuality;
                            $totalTripBreakdownArr['final_total'] = $finalTotalTripBreakdown;
                            $realibilityArr['final_total'] = $finalRealibility;
                            $numBusArr['final_total'] = $finalNumBus;
                            $fareboxArr['final_total'] = $finalFarebox;
                            $ridershipArr['final_total'] = $finalRidership;
        
                            $content['planned_trip'] = $plannedTripArr;
                            $content['completed_trip_in'] = $completedInArr;
                            $content['completed_trip_out'] = $completedOutArr;
                            $content['total_completed_trip'] = $totalCompletedTripArr;
                            $content['trip_compliance'] = $tripComplianceArr;
                            $content['total_off_route'] = $totalOffRouteArr;
                            $content['route_compliance'] = $routeComplianceArr;
                            $content['distance_in'] = $inboundDistanceArr;
                            $content['distance_out'] = $outboundDistanceArr;
                            $content['total_distance_in'] = $totalDistanceInArr;
                            $content['total_distance_out'] = $totalDistanceOutArr;
                            $content['total_distance'] = $totalDistanceArr;
                            $content['total_trip_on_time'] = $totalTripOnTimeArr;
                            $content['punctuality'] = $punctualityArr;
                            $content['total_trip_breakdown'] = $totalTripBreakdownArr;
                            $content['realibility'] = $realibilityArr;
                            $content['num_of_bus'] = $numBusArr;
                            $content['farebox'] = $fareboxArr;
                            $content['ridership'] = $ridershipArr;
        
                            $data[$routeName] = $content;
                        }
                        $isbsfSPAD->add($data);
                    }
                    //ISBSF specific route specific company
                    else{
                        $finalPlannedTrip=0;
                        $finalCompletedIn=0;
                        $finalCompletedOut=0;
                        $finalTotalCompletedTrip=0;
                        $finalOffRoute=0;
                        $finalInboundDistance=0;
                        $finalOutboundDistance=0;
                        $finalTotalDistanceIn=0;
                        $finalTotalDistanceOut=0;
                        $finalTotalDistance=0;
                        $finalTripOnTime=0;
                        $finalTotalTripBreakdown=0;
                        $finalNumBus=0;
                        $finalFarebox=0;
                        $finalRidership=0;
                        $sumTripCompliance=0;
                        $sumRouteCompliance=0;
                        $sumPunctuality=0;
                        $sumRealibility=0;
        
                        $validatedRoute = Route::where('id', $validatedData['route_id'])->first();
                        $routeName = $validatedRoute->route_number . ' ' . $validatedRoute->route_name;
        
                        foreach ($all_dates as $all_date) {
                            $firstDate = new Carbon($all_date);
                            $lastDate = new Carbon($all_date . '23:59:59');
        
                            //Planned Trip
                            //Total Trip On Time
                            $plannedTrip = 0;
                            $schedules = RouteSchedulerDetail::whereBetween('schedule_date', [$firstDate,$lastDate])->get();
                            if (count($schedules) > 0) {
                                foreach ($schedules as $schedule) {
                                    if ($schedule->RouteScheduleMSTR->route_id == $validatedRoute->id) {
                                        $plannedTrip++;
                                    }
                                }
                            }
                            $plannedTripArr[$all_date] = $plannedTrip;
                            $finalPlannedTrip += $plannedTrip;
        
                            $allTrips = TripDetail::where('route_id',  $validatedRoute->id)
                                ->whereBetween('start_trip', [$firstDate,$lastDate])
                                ->get();
        
                            $ontimeCount = 0;
                            $farebox =0;
                            $ridership =0;
                            $completedOut =0;
                            $completedIn =0;
                            if(count($allTrips)>0){
                                foreach ($allTrips as $allTrip){
                                    //Trip On Time
                                    if($allTrip->route_schedule_mstr_id!=NULL){
                                        $diff = strtotime($allTrip->RouteScheduleMSTR->schedule_start_time) - strtotime($allTrip->start_trip);
                                        if ($diff < 5 || $diff > -5) {
                                            $ontimeCount++;
                                        }
                                    }
                                    //Farebox
                                    $adultFarebox = $allTrip->total_adult_amount;
                                    $concessionFarebox = $allTrip->total_concession_amount;
                                    $sumFarebox = $adultFarebox + $concessionFarebox;
                                    $farebox += $sumFarebox;
                                    //Ridership
                                    $adultRidership = $allTrip->total_adult;
                                    $concessionRidership = $allTrip->total_concession;
                                    $sumRidership = $adultRidership + $concessionRidership;
                                    $ridership += $sumRidership;
                                    //Completed Trip Out & In
                                    if($allTrip->trip_code==0){
                                        $completedOut++;
                                    }elseif($allTrip->trip_code==1){
                                        $completedIn++;
                                    }
                                }
                            }
                            $totalTripOnTimeArr[$all_date] = $ontimeCount;
                            $finalTripOnTime += $ontimeCount;
                            $fareboxArr[$all_date] = $farebox;
                            $finalFarebox += $farebox;
                            $ridershipArr[$all_date] = $ridership;
                            $finalRidership += $ridership;
                            $completedOutArr[$all_date] = $completedOut;
                            $finalCompletedOut += $completedOut;
                            $completedInArr[$all_date] = $completedIn;
                            $finalCompletedIn += $completedIn;
        
                            //Total Completed Trip
                            $totalCompletedTrip = $completedOut + $completedIn;
                            $totalCompletedTripArr[$all_date] = $totalCompletedTrip;
                            $finalTotalCompletedTrip += $totalCompletedTrip;
        
                            //Trip Compliance
                            if($plannedTrip==0){
                                $tripCompliance = 0;
                            }else{
                                $tripCompliance = round((($totalCompletedTrip/$plannedTrip) * 100),1);
                            }
                            $tripComplianceArr[$all_date] = $tripCompliance;
                            $sumTripCompliance += $tripCompliance;
        
                            /**Need to recalculate Off Route**/
                            $offRoute = 0;
                            $totalOffRouteArr[$all_date] = $offRoute;
                            $finalOffRoute += $offRoute;
        
                            //KM 1 Way Outbound
                            $outboundDistance = $validatedRoute->outbound_distance;
                            $outboundDistanceArr[$all_date] = $outboundDistance;
                            $finalOutboundDistance += $outboundDistance;
        
                            //KM 1 Way Inbound
                            $inboundDistance = $validatedRoute->inbound_distance;
                            $inboundDistanceArr[$all_date] = $inboundDistance;
                            $finalInboundDistance += $inboundDistance;
        
                            //Total KM Outbound
                            $totalDistanceOut = $outboundDistance * $completedOut;
                            $totalDistanceOutArr[$all_date] = $totalDistanceOut;
                            $finalTotalDistanceOut += $totalDistanceOut;
        
                            //Total KM Inbound
                            $totalDistanceIn = $inboundDistance * $completedIn;
                            $totalDistanceInArr[$all_date] = $totalDistanceIn;
                            $finalTotalDistanceIn += $totalDistanceIn;
        
                            //Total KM
                            $totalDistance = $totalDistanceIn + $totalDistanceOut;
                            $totalDistanceArr[$all_date] = $totalDistance;
                            $finalTotalDistance += $totalDistance;
        
                            /**Need to recalculate Total Trip Breakdown**/
                            $totalTripBreakdown = 0;
                            $totalTripBreakdownArr[$all_date] = $totalTripBreakdown;
                            $finalTotalTripBreakdown += $totalTripBreakdown;
        
                            //Punctuality Adherence
                            //Realibility Breakdown
                            //Route Compliance
                            if($totalCompletedTrip==0){
                                $punctuality = 0;
                                $realibility = 0;
                                $routeCompliance = 0;
                            }else{
                                $punctuality = round((($ontimeCount / $totalCompletedTrip) * 100),1);
                                $realibility = round(((($totalCompletedTrip - $totalTripBreakdown) / $totalCompletedTrip) * 100),1);
                                $routeCompliance = round(((($totalCompletedTrip - $offRoute) / $totalCompletedTrip) * 100),1);
        
                            }
                            $punctualityArr[$all_date] = $punctuality;
                            $sumPunctuality += $punctuality;
                            $realibilityArr[$all_date] = $realibility;
                            $sumRealibility += $realibility;
                            $routeComplianceArr[$all_date] = $routeCompliance;
                            $sumRouteCompliance += $routeCompliance;
        
                            //Number of Bus
                            $numBus = TripDetail::whereBetween('start_trip',[$firstDate,$lastDate])
                                ->where('route_id',  $validatedRoute->id)
                                ->distinct('bus_id')
                                ->count();
                            $numBusArr[$all_date] = $numBus;
                            $finalNumBus += $numBus;
                        }
                        $finalTripCompliance = round((($sumTripCompliance/(count($all_dates)*100))*100),1);
                        $finalRouteCompliance = round((($sumRouteCompliance/(count($all_dates)*100))*100),1);
                        $finalPunctuality = round((($sumPunctuality/(count($all_dates)*100))*100),1);
                        $finalRealibility = round((($sumRealibility/(count($all_dates)*100))*100),1);
        
                        // $tripComplianceFormat = number_format((float)$finalTripCompliance, 1, '.', '');
                        // $routeComplianceFormat = number_format((float)$finalRouteCompliance, 1, '.', '');
                        // $punctualityFormat = number_format((float)$finalPunctuality, 1, '.', '');
                        // $realibilityFormat = number_format((float)$finalRealibility, 1, '.', '');
        
                        $plannedTripArr['final_total'] = $finalPlannedTrip;
                        $completedInArr['final_total'] = $finalCompletedIn;
                        $completedOutArr['final_total'] = $finalCompletedOut;
                        $totalCompletedTripArr['final_total'] = $finalTotalCompletedTrip;
                        $tripComplianceArr['final_total'] = $finalTripCompliance;
                        $totalOffRouteArr['final_total'] = $finalOffRoute;
                        $routeComplianceArr['final_total'] = $finalRouteCompliance;
                        $inboundDistanceArr['final_total'] = $finalInboundDistance;
                        $outboundDistanceArr['final_total'] = $finalOutboundDistance;
                        $totalDistanceInArr['final_total'] = $finalTotalDistanceIn;
                        $totalDistanceOutArr['final_total'] = $finalTotalDistanceOut;
                        $totalDistanceArr['final_total'] = $finalTotalDistance;
                        $totalTripOnTimeArr['final_total'] = $finalTripOnTime;
                        $punctualityArr['final_total'] = $finalPunctuality;
                        $totalTripBreakdownArr['final_total'] = $finalTotalTripBreakdown;
                        $realibilityArr['final_total'] = $finalRealibility;
                        $numBusArr['final_total'] = $finalNumBus;
                        $fareboxArr['final_total'] = $finalFarebox;
                        $ridershipArr['final_total'] = $finalRidership;
        
                        $content['planned_trip'] = $plannedTripArr;
                        $content['completed_trip_in'] = $completedInArr;
                        $content['completed_trip_out'] = $completedOutArr;
                        $content['total_completed_trip'] = $totalCompletedTripArr;
                        $content['trip_compliance'] = $tripComplianceArr;
                        $content['total_off_route'] = $totalOffRouteArr;
                        $content['route_compliance'] = $routeComplianceArr;
                        $content['distance_in'] = $inboundDistanceArr;
                        $content['distance_out'] = $outboundDistanceArr;
                        $content['total_distance_in'] = $totalDistanceInArr;
                        $content['total_distance_out'] = $totalDistanceOutArr;
                        $content['total_distance'] = $totalDistanceArr;
                        $content['total_trip_on_time'] = $totalTripOnTimeArr;
                        $content['punctuality'] = $punctualityArr;
                        $content['total_trip_breakdown'] = $totalTripBreakdownArr;
                        $content['realibility'] = $realibilityArr;
                        $content['num_of_bus'] = $numBusArr;
                        $content['farebox'] = $fareboxArr;
                        $content['ridership'] = $ridershipArr;
        
                        $data[$routeName] = $content;
                        //$data[$i++] = $route;
        
                        $isbsfSPAD->add($data);
                    } 
                }
            }
            return Excel::download(new SPADIsbsf($isbsfSPAD, $validatedData['dateFrom'], $validatedData['dateTo'], $colspan, $all_dates,$monthName, $days, $networkArea), 'ISBSF_Report_SPAD_'.Carbon::now()->format('YmdHis').'.xlsx');
        }else{
            $this->dispatchBrowserEvent('company-required');
        }
    }


    public function printTripMissed()
    {
        $out = new ConsoleOutput();
        $out->writeln("YOU ARE IN  printTripMissed()");

        $validatedData = Validator::make($this->state,[
            'dateFrom' => ['required', 'date'],
            'dateTo' => ['required', 'date'],
            'route_id' => ['required'],
        ])->validate();

        $startDate = new Carbon($validatedData['dateFrom']);
        $endDate = new Carbon($validatedData['dateTo']);
        $all_dates = array();

        while ($startDate->lte($endDate)){
            $all_dates[] = $startDate->toDateString();
            $startDate->addDay();
        }

        $tripMissed = collect();
        $grandTripMissedIn = 0;
        $grandTripMissedOut  = 0;
        if ($this->selectedCompany){
            if($this->selectedCompany=='All'){
                $networkArea = 'All';
                if(!empty($validatedData['route_id'])) {
                   //TripMissed all route for all company
                    if($validatedData['route_id']=='All'){
                        $allRoutes = Route::orderBy('route_number')->get();
            
                        foreach($allRoutes as $allRoute){
                            $routeNameIn = $allRoute->route_name;
                            $routeNameOut = implode(" - ",array_reverse(explode(" - ", $routeNameIn)));
                            $totalTripMissedIn = 0;
                            $totalTripMissedOut = 0;
                            $trip_data = [];

                            if($allRoute->company_id==29){
                                $charge = 3.42;
                            }else{
                                $charge = 1.33;
                            }
            
                            foreach($all_dates as $all_date) {
                                $firstDate = new Carbon($all_date);
                                $lastDate = new Carbon($all_date . '23:59:59');
                                $countTripMissedIn = 0;
                                $countTripMissedOut = 0;
                                $tripIn = [];
                                $tripOut = [];
            
                                //Trip Planned
                                $tripPlanned = RouteSchedulerDetail::whereBetween('schedule_date', [$firstDate, $lastDate])->get();
            
                                //Inbound
                                $allInboundTrips = TripDetail::where('route_id', $allRoute->id)
                                    ->whereBetween('start_trip', [$firstDate, $lastDate])
                                    ->where('trip_code', 1)
                                    ->get();
            
                                //Outbound
                                $allOutboundTrips = TripDetail::where('route_id', $allRoute->id)
                                    ->whereBetween('start_trip', [$firstDate, $lastDate])
                                    ->where('trip_code', 0)
                                    ->get();

                                if(count($tripPlanned) > 0){
                                    foreach ($tripPlanned as $tripPlan) {
                                        if ($tripPlan->RouteScheduleMSTR->route_id == $allRoute->id) {
                                            $tripServedIn = false;
                                            $tripServedOut = false;
            
                                            if(count($allInboundTrips) > 0){
                                                foreach ($allInboundTrips as $allInboundTrip) {
                                                    if ($tripPlan->RouteScheduleMSTR->id == $allInboundTrip->route_schedule_mstr_id) {
                                                        $tripServedIn = true;
                                                    }
                                                }
                                            }

                                            if ($tripServedIn == false) {
                                                $countTripMissedIn++;
                                                $notServedIn['route_name'] = $routeNameIn;
                                                $notServedIn['trip_no'] = 'T' . $countTripMissedIn;
                                                if($tripPlan->route_schedule_mstr_id != NULL){
                                                    $notServedIn['trip_time'] = $tripPlan->RouteScheduleMSTR->schedule_start_time;
                                                    $notServedIn['bus_reg_no'] = $tripPlan->RouteScheduleMSTR->Bus->bus_registration_number;
                                                    $notServedIn['bus_age'] = $tripPlan->RouteScheduleMSTR->Bus->bus_age;
                                                }else{
                                                    $notServedIn['trip_time'] = 'NO DATA';
                                                    $notServedIn['bus_reg_no'] = 'NO DATA';
                                                    $notServedIn['bus_age'] = 'NO DATA';
                                                }
                                                $notServedIn['km_rate'] = $charge;
                                                $tripIn[$countTripMissedIn] = $notServedIn;
                                            }
            
                                            if(count($allOutboundTrips) > 0){
                                                foreach ($allOutboundTrips as $allOutboundTrip) {
                                                    if ($tripPlan->RouteScheduleMSTR->id == $allOutboundTrip->route_schedule_mstr_id) {
                                                        $tripServedOut = true;
                                                    }
                                                }
                                            }

                                            if ($tripServedOut == false) {
                                                $countTripMissedOut++;
                                                $notServedOut['route_name'] = $routeNameOut;
                                                $notServedOut['trip_no'] = 'T' . $countTripMissedOut;
                                                if($tripPlan->route_schedule_mstr_id != NULL){
                                                    $notServedOut['trip_time'] = $tripPlan->RouteScheduleMSTR->schedule_start_time;
                                                    $notServedOut['bus_reg_no'] = $tripPlan->RouteScheduleMSTR->Bus->bus_registration_number;
                                                    $notServedOut['bus_age'] = $tripPlan->RouteScheduleMSTR->Bus->bus_age;
                                                }else{
                                                    $notServedOut['trip_time'] = 'NO DATA';
                                                    $notServedOut['bus_reg_no'] = 'NO DATA';
                                                    $notServedOut['bus_age'] = 'NO DATA';
                                                }
                                                $notServedOut['km_rate'] = $charge;
                                                $tripOut[$countTripMissedOut] = $notServedOut;
                                            }
                                        }
                                    }
                                    $inbound['allTripIn'] = $tripIn;
                                    $inbound['total_per_inbound'] = $countTripMissedIn;
            
                                    $outbound['allTripOut'] = $tripOut;
                                    $outbound['total_per_outbound'] = $countTripMissedOut;
                                }
            
                                if($countTripMissedIn!=0 && $countTripMissedOut!=0){
                                    $trip_data[$routeNameIn] = $inbound;
                                    $trip_data[$routeNameOut] = $outbound;
                                    $trip_data['total_per_date'] = $countTripMissedIn + $countTripMissedOut;
                                }elseif($countTripMissedIn>0 && $countTripMissedOut==0){
                                    $trip_data[$routeNameIn] = $inbound;
                                    $trip_data[$routeNameOut] = [];
                                    $trip_data['total_per_date'] = $countTripMissedIn;
                                }elseif($countTripMissedIn==0 && $countTripMissedOut>0){
                                    $trip_data[$routeNameIn] = [];
                                    $trip_data[$routeNameOut] = $outbound;
                                    $trip_data['total_per_date'] = $countTripMissedOut;
                                }else {
                                    $trip_data[$routeNameIn] = [];
                                    $trip_data[$routeNameOut] = [];
                                    $trip_data['total_per_date'] = 0;
                                }
            
                                $tripPerDate[$all_date] = $trip_data;
            
                                $totalTripMissedIn += $countTripMissedIn;
                                $totalTripMissedOut += $countTripMissedOut;
                            }
                            $sumTotal = $totalTripMissedIn + $totalTripMissedOut;
                            if($sumTotal==0){
                                $perDate = [];
                            }else{
                                $perDate['allDate'] = $tripPerDate;
                                $perDate['total_per_route'] = $sumTotal;
                            }
            
                            $route[$allRoute->route_number] = $perDate;
            
                            $grandTripMissedIn += $totalTripMissedIn;
                            $grandTripMissedOut += $totalTripMissedOut;
                        }
                        $sumGrand = $grandTripMissedIn + $grandTripMissedOut;
                        if($sumGrand==0){
                            $grand = [];
                        }else{
                            $grand['allRoute'] = $route;
                            $grand['grand'] = $sumGrand;
                        }
            
                        $tripMissed->add($grand);
                    }
                }
            }else{
                $companyDetails = Company::where('id', $this->selectedCompany)->first();
                $networkArea = $companyDetails->company_name;
                if($companyDetails->id==29){
                    $charge = 3.42;
                }else{
                    $charge = 1.33;
                }
                if(!empty($validatedData['route_id'])) {
                    //TripMissed all route for specific company
                    if($validatedData['route_id']=='All'){
                        $routeByCompanies = Route::where('company_id', $companyDetails->id)->orderBy('route_number')->get();
        
                        foreach($routeByCompanies as $routeByCompany){
                            $routeNameIn = $routeByCompany->route_name;
                            $routeNameOut = implode(" - ",array_reverse(explode(" - ", $routeNameIn)));
                            $totalTripMissedIn = 0;
                            $totalTripMissedOut = 0;
                            $trip_data = [];
        
                            foreach($all_dates as $all_date){
                                $firstDate = new Carbon($all_date);
                                $lastDate = new Carbon($all_date . '23:59:59');
                                $countTripMissedIn = 0;
                                $countTripMissedOut = 0;
        
                                //Trip Planned
                                $tripPlanned = RouteSchedulerDetail::whereBetween('schedule_date', [$firstDate,$lastDate])->get();
        
                                //Inbound
                                $allInboundTrips = TripDetail::where('route_id',$routeByCompany->id)
                                    ->whereBetween('start_trip', [$firstDate,$lastDate])
                                    ->where('trip_code',1)
                                    ->get();
        
                                //Outbound
                                $allOutboundTrips = TripDetail::where('route_id',$routeByCompany->id)
                                    ->whereBetween('start_trip', [$firstDate,$lastDate])
                                    ->where('trip_code',0)
                                    ->get();
    
                                if(count($tripPlanned)>0) {
                                    foreach ($tripPlanned as $tripPlan) {
                                        $out->writeln("YOU ARE IN triPlanned loop" . $validatedData['dateFrom']);
                                        if ($tripPlan->RouteScheduleMSTR->route_id == $routeByCompany->id) {
                                            $tripServedIn = false;
                                            $tripServedOut = false;
        
                                            if(count($allInboundTrips)>0) {
                                                foreach ($allInboundTrips as $allInboundTrip) {
                                                    if ($tripPlan->RouteScheduleMSTR->id == $allInboundTrip->route_schedule_mstr_id) {
                                                        $tripServedIn = true;
                                                    }
                                                }
                                            }
                                            if ($tripServedIn == false) {
                                                $countTripMissedIn++;
                                                $notServedIn['route_name'] = $routeNameIn;
                                                $notServedIn['trip_no'] = 'T' . $countTripMissedIn;
                                                if($tripPlan->route_schedule_mstr_id != NULL){
                                                    $notServedIn['trip_time'] = $tripPlan->RouteScheduleMSTR->schedule_start_time;
                                                    $notServedIn['bus_reg_no'] = $tripPlan->RouteScheduleMSTR->Bus->bus_registration_number;
                                                    $notServedIn['bus_age'] = $tripPlan->RouteScheduleMSTR->Bus->bus_age;
                                                }else{
                                                    $notServedIn['trip_time'] = 'NO DATA';
                                                    $notServedIn['bus_reg_no'] = 'NO DATA';
                                                    $notServedIn['bus_age'] = 'NO DATA';
                                                }
                                                $notServedIn['km_rate'] = $charge;
        
                                                $tripIn[$countTripMissedIn] = $notServedIn;
                                            }
        
                                            if(count($allOutboundTrips)>0) {
                                                foreach ($allOutboundTrips as $allOutboundTrip) {
                                                    if ($tripPlan->RouteScheduleMSTR->id == $allOutboundTrip->route_schedule_mstr_id) {
                                                        $tripServedOut = true;
                                                    }
                                                }
                                            }
                                            if ($tripServedOut == false) {
                                                $countTripMissedOut++;
                                                $notServedOut['route_name'] = $routeNameOut;
                                                $notServedOut['trip_no'] = 'T' . $countTripMissedOut;
                                                if($tripPlan->route_schedule_mstr_id != NULL){
                                                    $notServedOut['trip_time'] = $tripPlan->RouteScheduleMSTR->schedule_start_time;
                                                    $notServedOut['bus_reg_no'] = $tripPlan->RouteScheduleMSTR->Bus->bus_registration_number;
                                                    $notServedOut['bus_age'] = $tripPlan->RouteScheduleMSTR->Bus->bus_age;
                                                }else{
                                                    $notServedOut['trip_time'] = 'NO DATA';
                                                    $notServedOut['bus_reg_no'] = 'NO DATA';
                                                    $notServedOut['bus_age'] = 'NO DATA';
                                                }
                                                $notServedOut['km_rate'] = $charge;
        
                                                $tripOut[$countTripMissedOut] = $notServedOut;
                                            }
                                        }
                                    }
        
                                    $inbound['allTripIn'] = $tripIn;
                                    $inbound['total_per_inbound'] = $countTripMissedIn;
        
                                    $outbound['allTripOut'] = $tripOut;
                                    $outbound['total_per_outbound'] = $countTripMissedOut;
                                }
        
                                if($countTripMissedIn!=0 && $countTripMissedOut!=0){
                                    $trip_data[$routeNameIn] = $inbound;
                                    $trip_data[$routeNameOut] = $outbound;
                                    $trip_data['total_per_date'] = $countTripMissedIn + $countTripMissedOut;
                                }elseif($countTripMissedIn>0 && $countTripMissedOut==0){
                                    $trip_data[$routeNameIn] = $inbound;
                                    $trip_data[$routeNameOut] = [];
                                    $trip_data['total_per_date'] = $countTripMissedIn;
                                }elseif($countTripMissedIn==0 && $countTripMissedOut>0){
                                    $trip_data[$routeNameIn] = [];
                                    $trip_data[$routeNameOut] = $outbound;
                                    $trip_data['total_per_date'] = $countTripMissedOut;
                                }else {
                                    $trip_data[$routeNameIn] = [];
                                    $trip_data[$routeNameOut] = [];
                                    $trip_data['total_per_date'] = 0;
                                }
        
                                $tripPerDate[$all_date] = $trip_data;
        
                                $totalTripMissedIn += $countTripMissedIn;
                                $totalTripMissedOut += $countTripMissedOut;
                            }
                            $sumTotal = $totalTripMissedIn + $totalTripMissedOut;
                            if($sumTotal==0){
                                $perDate = [];
                            }else{
                                $perDate['allDate'] = $tripPerDate;
                                $perDate['total_per_route'] = $sumTotal;
                            }
        
                            $route[$routeByCompany->route_number] = $perDate;
        
                            $grandTripMissedIn += $totalTripMissedIn;
                            $grandTripMissedOut += $totalTripMissedOut;
                        }
                        $sumGrand = $grandTripMissedIn + $grandTripMissedOut;
                        if($sumGrand==0){
                            $grand = [];
                        }else{
                            $grand['allRoute'] = $route;
                            $grand['grand'] = $sumGrand;
                        }
        
                        $tripMissed->add($grand);
                    }
                    //TripMissed certain route for specific company
                    else{
                        $selectedRoute = Route::where('id', $validatedData['route_id'])->first();
                        $routeNameIn = $selectedRoute->route_name;
                        $routeNameOut = implode(" - ",array_reverse(explode(" - ", $routeNameIn)));
                        $totalTripMissedIn = 0;
                        $totalTripMissedOut = 0;
                        $trip_data = [];
        
                        foreach($all_dates as $all_date){
                            $firstDate = new Carbon($all_date);
                            $lastDate = new Carbon($all_date .'23:59:59');
                            $countTripMissedIn = 0;
                            $countTripMissedOut = 0;
        
                            //Trip Planned
                            $tripPlanned = RouteSchedulerDetail::whereBetween('schedule_date', [$firstDate,$lastDate])->get();
        
                            //Inbound
                            $allInboundTrips = TripDetail::where('route_id',$selectedRoute->id)
                                ->whereBetween('start_trip', [$firstDate,$lastDate])
                                ->where('trip_code',1)
                                ->get();
        
                            //Outbound
                            $allOutboundTrips = TripDetail::where('route_id',$selectedRoute->id)
                                ->whereBetween('start_trip', [$firstDate,$lastDate])
                                ->where('trip_code',0)
                                ->get();
        
                            if(count($tripPlanned)>0) {
                                foreach ($tripPlanned as $tripPlan) {
                                    $out->writeln("YOU ARE IN triPlanned loop" . $validatedData['dateFrom']);
                                    if ($tripPlan->RouteScheduleMSTR->route_id == $selectedRoute->id) {
                                        $tripServedIn = false;
                                        $tripServedOut = false;
        
                                        if(count($allInboundTrips)>0) {
                                            foreach ($allInboundTrips as $allInboundTrip) {
                                                if ($tripPlan->RouteScheduleMSTR->id == $allInboundTrip->route_schedule_mstr_id) {
                                                    $tripServedIn = true;
                                                }
                                            }
                                        }
                                        if ($tripServedIn == false) {
                                            $countTripMissedIn++;
                                            $notServedIn['route_name'] = $routeNameIn;
                                            $notServedIn['trip_no'] = 'T' . $countTripMissedIn;
                                            if($tripPlan->route_schedule_mstr_id != NULL){
                                                $notServedIn['trip_time'] = $tripPlan->RouteScheduleMSTR->schedule_start_time;
                                                $notServedIn['bus_reg_no'] = $tripPlan->RouteScheduleMSTR->Bus->bus_registration_number;
                                                $notServedIn['bus_age'] = $tripPlan->RouteScheduleMSTR->Bus->bus_age;
                                            }else{
                                                $notServedIn['trip_time'] = 'NO DATA';
                                                $notServedIn['bus_reg_no'] = 'NO DATA';
                                                $notServedIn['bus_age'] = 'NO DATA';
                                            }
                                            $notServedIn['km_rate'] = $charge;
                                            $tripIn[$countTripMissedIn] = $notServedIn;
                                        }
        
                                        if(count($allOutboundTrips)>0) {
                                            foreach ($allOutboundTrips as $allOutboundTrip) {
                                                if ($tripPlan->RouteScheduleMSTR->id == $allOutboundTrip->route_schedule_mstr_id) {
                                                    $tripServedOut = true;
                                                }
                                            }
                                        }
                                        if ($tripServedOut == false) {
                                            $countTripMissedOut++;
                                            $notServedOut['route_name'] = $routeNameOut;
                                            $notServedOut['trip_no'] = 'T' . $countTripMissedOut;
                                            if($tripPlan->route_schedule_mstr_id != NULL){
                                                $notServedOut['trip_time'] = $tripPlan->RouteScheduleMSTR->schedule_start_time;
                                                $notServedOut['bus_reg_no'] = $tripPlan->RouteScheduleMSTR->Bus->bus_registration_number;
                                                $notServedOut['bus_age'] = $tripPlan->RouteScheduleMSTR->Bus->bus_age;
                                            }else{
                                                $notServedOut['trip_time'] = 'NO DATA';
                                                $notServedOut['bus_reg_no'] = 'NO DATA';
                                                $notServedOut['bus_age'] = 'NO DATA';
                                            }
                                            $notServedOut['km_rate'] = $charge;
                                            $tripOut[$countTripMissedOut] = $notServedOut;
                                        }
                                    }
                                }
                                $inbound['allTripIn'] = $tripIn;
                                $inbound['total_per_inbound'] = $countTripMissedIn;
        
                                $outbound['allTripOut'] = $tripOut;
                                $outbound['total_per_outbound'] = $countTripMissedOut;
                            }
        
                            if($countTripMissedIn!=0 && $countTripMissedOut!=0){
                                $trip_data[$routeNameIn] = $inbound;
                                $trip_data[$routeNameOut] = $outbound;
                                $trip_data['total_per_date'] = $countTripMissedIn + $countTripMissedOut;
                            }elseif($countTripMissedIn>0 && $countTripMissedOut==0){
                                $trip_data[$routeNameIn] = $inbound;
                                $trip_data[$routeNameOut] = [];
                                $trip_data['total_per_date'] = $countTripMissedIn;
                            }elseif($countTripMissedIn==0 && $countTripMissedOut>0){
                                $trip_data[$routeNameIn] = [];
                                $trip_data[$routeNameOut] = $outbound;
                                $trip_data['total_per_date'] = $countTripMissedOut;
                            }else {
                                $trip_data[$routeNameIn] = [];
                                $trip_data[$routeNameOut] = [];
                                $trip_data['total_per_date'] = 0;
                            }
        
                            $tripPerDate[$all_date] = $trip_data;
        
                            $totalTripMissedIn += $countTripMissedIn;
                            $totalTripMissedOut += $countTripMissedOut;
                        }
                        $sumTotal = $totalTripMissedIn + $totalTripMissedOut;
                        if($sumTotal==0){
                            $perDate = [];
                            $sumGrand = 0;
                        }else{
                            $perDate['allDate'] = $tripPerDate;
                            $perDate['total_per_route'] = $sumTotal;
                            $sumGrand = $sumTotal;
        
                        }
                        $route[$selectedRoute->route_number] = $perDate;
                        $grand['allRoute'] = $route;
                        $grand['grand'] = $sumGrand;
        
                        $tripMissed->add($grand);
        
                    }
                }
            }
            return Excel::download(new SPADTripMissed($tripMissed, $validatedData['dateFrom'], $validatedData['dateTo'], $networkArea), 'Trip_Missed_Report_SPAD_'.Carbon::now()->format('YmdHis').'.xlsx');
        }else{
            $this->dispatchBrowserEvent('company-required');
        }
    }

    public function printTripPlanned()
    {
        $out = new ConsoleOutput();
        $out->writeln("YOU ARE IN printTripPlanned()");

        $validatedData = Validator::make($this->state,[
            'dateFrom' => ['required', 'date'],
            'dateTo' => ['required', 'date'],
            'route_id' => ['required'],
        ])->validate();

        $startDate = new Carbon($validatedData['dateFrom']);
        $endDate = new Carbon($validatedData['dateTo']);
        $all_dates = array();

        while ($startDate->lte($endDate)){
            $all_dates[] = $startDate->toDateString();
            $startDate->addDay();
        }

        $tripPlanned = collect();
        $grandTripPlannedIn = 0;
        $grandTripPlannedOut = 0;
        if ($this->selectedCompany){
            if($this->selectedCompany=='All'){
                $networkArea = 'All';
                if(!empty($validatedData['route_id'])) {
                    //TripPlanned all route for all company
                    if($validatedData['route_id']=='All'){
                        $allRoutes = Route::orderBy('route_number')->get();
            
                        foreach($allRoutes as $allRoute){
                            $routeNameIn = implode(" - ",array_reverse(explode("-", $allRoute->route_name)));
                            $routeNameOut = $allRoute->route_name;
                            $totalTripPlannedIn = 0;
                            $totalTripPlannedOut = 0;
                            $trip_data = [];
                            if($allRoute->company_id==29){
                                $charge = 3.42;
                            }else{
                                $charge = 1.33;
                            }
            
                            foreach($all_dates as $all_date) {
                                $firstDate = new Carbon($all_date);
                                $lastDate = new Carbon($all_date . '23:59:59');
                                $countTripPlannedIn = 0;
                                $countTripPlannedOut = 0;
                                $tripIn = [];
                                $tripOut = [];

                                //Trip Planned
                                $schedules = RouteSchedulerDetail::whereBetween('schedule_date', [$firstDate, $lastDate])->get();
            
                                //Inbound
                                $allInboundTrips = TripDetail::where('route_id', $allRoute->id)
                                    ->whereBetween('start_trip', [$firstDate, $lastDate])
                                    ->where('trip_code', 1)
                                    ->get();
            
                                //Outbound
                                $allOutboundTrips = TripDetail::where('route_id', $allRoute->id)
                                    ->whereBetween('start_trip', [$firstDate, $lastDate])
                                    ->where('trip_code', 0)
                                    ->get();

                                if (count($schedules) > 0) {
                                    foreach ($schedules as $schedule) {
                                        if ($schedule->RouteScheduleMSTR->route_id == $allRoute->id) {
                                            $tripServedIn = false;
                                            $tripServedOut = false;
            
                                            if($schedule->RouteScheduleMSTR->trip_code == 1) {
                                                //Inbound
                                                $countTripPlannedIn++;
                                                $plannedIn['route_name'] = $routeNameIn;
                                                $plannedIn['trip_date'] = $all_date;
                                                $plannedIn['service_time'] = $schedule->RouteScheduleMSTR->schedule_start_time;
                                                $plannedIn['trip_no'] = 'T' . $countTripPlannedIn;
                                                if($schedule->RouteScheduleMSTR->bus_id != NULL) {
                                                    $plannedIn['bus_reg_no'] = $schedule->RouteScheduleMSTR->Bus->bus_registration_number;
                                                    $plannedIn['bus_age'] = $schedule->RouteScheduleMSTR->Bus->bus_age;
                                                }else{
                                                    $plannedIn['bus_reg_no'] = 'NO DATA';
                                                    $plannedIn['bus_age'] = 'NO DATA';
                                                }
                                                $plannedIn['km_rate'] = $charge;
                
                                                if (count($allInboundTrips) > 0) {
                                                    foreach ($allInboundTrips as $allInboundTrip) {
                                                        if ($schedule->RouteScheduleMSTR->id == $allInboundTrip->route_schedule_mstr_id) {
                                                            $tripServedIn = true;
                                                        }
                                                    }
                                                }

                                                if ($tripServedIn == false) {
                                                    $plannedIn['status'] = "MISSED TRIP";
                                                } else {
                                                    $plannedIn['status'] = "TRIP SERVED";
                                                }
                                                $tripIn[$countTripPlannedIn] = $plannedIn;
                                            }else{
                                                //Outbound
                                                $countTripPlannedOut++;
                                                $plannedOut['route_name'] = $routeNameOut;
                                                $plannedOut['trip_date'] = $all_date;
                                                $plannedOut['service_time'] = $schedule->RouteScheduleMSTR->schedule_start_time;
                                                $plannedOut['trip_no'] = 'T' . $countTripPlannedOut;
                                                if($schedule->RouteScheduleMSTR->bus_id != NULL) {
                                                    $plannedOut['bus_reg_no'] = $schedule->RouteScheduleMSTR->Bus->bus_registration_number;
                                                    $plannedOut['bus_age'] = $schedule->RouteScheduleMSTR->Bus->bus_age;
                                                }else{
                                                    $plannedOut['bus_reg_no'] = 'NO DATA';
                                                    $plannedOut['bus_age'] = 'NO DATA';
                                                }
                                                $plannedOut['km_rate'] = $charge;
                
                                                if (count($allOutboundTrips) > 0) {
                                                    foreach ($allOutboundTrips as $allOutboundTrip) {
                                                        if ($schedule->RouteScheduleMSTR->id == $allOutboundTrip->route_schedule_mstr_id) {
                                                            $tripServedOut = true;
                                                        }
                                                    }
                                                }
                                                if ($tripServedOut == false) {
                                                    $plannedOut['status'] = "MISSED TRIP";
                                                } else {
                                                    $plannedOut['status'] = "TRIP SERVED";
                                                }
                                                $tripOut[$countTripPlannedOut] = $plannedOut;
                                            }
                                        }
                                    }
                                    $inbound['allTripIn'] = $tripIn;
                                    $inbound['total_per_inbound'] = $countTripPlannedIn;
                                    $outbound['allTripOut'] = $tripOut;
                                    $outbound['total_per_outbound'] = $countTripPlannedOut;
                                }
            
                                if ($countTripPlannedIn != 0 && $countTripPlannedOut != 0) {
                                    $trip_data[$routeNameIn] = $inbound;
                                    $trip_data[$routeNameOut] = $outbound;
                                    $trip_data['total_per_date'] = $countTripPlannedIn + $countTripPlannedOut;
                                } elseif ($countTripPlannedIn > 0 && $countTripPlannedOut == 0) {
                                    $trip_data[$routeNameIn] = $inbound;
                                    $trip_data[$routeNameOut] = [];
                                    $trip_data['total_per_date'] = $countTripPlannedIn;
                                } elseif ($countTripPlannedIn == 0 && $countTripPlannedOut > 0) {
                                    $trip_data[$routeNameIn] = [];
                                    $trip_data[$routeNameOut] = $outbound;
                                    $trip_data['total_per_date'] = $countTripPlannedOut;
                                } else {
                                    $trip_data[$routeNameIn] = [];
                                    $trip_data[$routeNameOut] = [];
                                    $trip_data['total_per_date'] = 0;
                                }
            
                                $tripPerDate[$all_date] = $trip_data;
            
                                $totalTripPlannedIn += $countTripPlannedIn;
                                $totalTripPlannedOut += $countTripPlannedOut;
                            }
                            $sumTotal = $totalTripPlannedIn + $totalTripPlannedOut;
                            if($sumTotal==0){
                                $perDate = [];
                            }else{
                                $perDate['allDate'] = $tripPerDate;
                                $perDate['total_per_route'] = $sumTotal;
                            }
            
                            $route[$allRoute->route_number] = $perDate;
            
                            $grandTripPlannedIn += $totalTripPlannedIn;
                            $grandTripPlannedOut += $totalTripPlannedOut;
                        }
                        $sumGrand = $grandTripPlannedIn + $grandTripPlannedOut ;
                        if($sumGrand==0){
                            $grand = [];
                        }else{
                            $grand['allRoute'] = $route;
                            $grand['grand'] = $sumGrand;
                        }
                        $tripPlanned->add($grand);
                    }
                }
            }else{
                $companyDetails = Company::where('id', $this->selectedCompany)->first();
                $networkArea = $companyDetails->company_name;
                if($companyDetails->id==29){
                    $charge = 3.42;
                }else{
                    $charge = 1.33;
                }

                if(!empty($validatedData['route_id'])) {
                    //TripPlanned all route for specific company
                    if($validatedData['route_id']=='All'){
                        $routeByCompanies = Route::where('company_id', $companyDetails->id)->orderBy('route_number')->get();
        
                        foreach($routeByCompanies as $routeByCompany){
                            $routeNameOut = $routeByCompany->route_name;
                            $routeNameIn = implode(" - ",array_reverse(explode("-", $routeByCompany->route_name)));
                            $totalTripPlannedIn = 0;
                            $totalTripPlannedOut = 0;
                            $trip_data = [];
                            $tripIn = [];
                            $tripOut = [];
        
                            foreach($all_dates as $all_date) {
                                $firstDate = new Carbon($all_date);
                                $lastDate = new Carbon($all_date . '23:59:59');$countTripPlannedIn = 0;
                                $countTripPlannedOut = 0;
        
                                //Trip Planned
                                $schedules = RouteSchedulerDetail::whereBetween('schedule_date', [$firstDate, $lastDate])->get();
        
                                //Inbound
                                $allInboundTrips = TripDetail::where('route_id', $routeByCompany->id)
                                    ->whereBetween('start_trip', [$firstDate, $lastDate])
                                    ->where('trip_code', 1)
                                    ->get();
        
                                //Outbound
                                $allOutboundTrips = TripDetail::where('route_id', $routeByCompany->id)
                                    ->whereBetween('start_trip', [$firstDate, $lastDate])
                                    ->where('trip_code', 0)
                                    ->get();
        
                                if (count($schedules) > 0) {
                                    foreach ($schedules as $schedule) {
                                        if ($schedule->RouteScheduleMSTR->route_id == $routeByCompany->id) {
                                            $tripServedIn = false;
                                            $tripServedOut = false;
        
                                            if($schedule->RouteScheduleMSTR->trip_code == 1){
                                                //inbound
                                                $countTripPlannedIn++;
                                                $plannedIn['route_name'] = $routeNameIn;
                                                $plannedIn['trip_date'] = $all_date;
                                                $plannedIn['service_time'] = $schedule->RouteScheduleMSTR->schedule_start_time;
                                                $plannedIn['trip_no'] = 'T' . $countTripPlannedIn;
                                                if($schedule->RouteScheduleMSTR->bus_id != NULL) {
                                                    $plannedIn['bus_reg_no'] = $schedule->RouteScheduleMSTR->Bus->bus_registration_number;
                                                    $plannedIn['bus_age'] = $schedule->RouteScheduleMSTR->Bus->bus_age;
                                                }else{
                                                    $plannedIn['bus_reg_no'] = 'NO DATA';
                                                    $plannedIn['bus_age'] = 'NO DATA';
                                                }
                                                $plannedIn['km_rate'] = $charge;
            
                                                if (count($allInboundTrips) > 0) {
                                                    foreach ($allInboundTrips as $allInboundTrip) {
                                                        if ($schedule->RouteScheduleMSTR->id == $allInboundTrip->route_schedule_mstr_id) {
                                                            $tripServedIn = true;
                                                        }
                                                    }
                                                }
                                                if ($tripServedIn == false) {
                                                    $plannedIn['status'] = "MISSED TRIP";
                                                } else {
                                                    $plannedIn['status'] = "TRIP SERVED";
                                                }
                                                $tripIn[$countTripPlannedIn] = $plannedIn;

                                            }else{
                                                //Outbound
                                                $countTripPlannedOut++;
                                                $plannedOut['route_name'] = $routeNameOut;
                                                $plannedOut['trip_date'] = $all_date;
                                                $plannedOut['service_time'] = $schedule->RouteScheduleMSTR->schedule_start_time;
                                                $plannedOut['trip_no'] = 'T' . $countTripPlannedOut;
                                                if($schedule->RouteScheduleMSTR->bus_id != NULL) {
                                                    $plannedOut['bus_reg_no'] = $schedule->RouteScheduleMSTR->Bus->bus_registration_number;
                                                    $plannedOut['bus_age'] = $schedule->RouteScheduleMSTR->Bus->bus_age;
                                                }else{
                                                    $plannedOut['bus_reg_no'] = 'NO DATA';
                                                    $plannedOut['bus_age'] = 'NO DATA';
                                                }
                                                $plannedOut['km_rate'] = $charge;
            
                                                if (count($allOutboundTrips) > 0) {
                                                    foreach ($allOutboundTrips as $allOutboundTrip) {
                                                        if ($schedule->RouteScheduleMSTR->id == $allOutboundTrip->route_schedule_mstr_id) {
                                                            $tripServedOut = true;
                                                        }
                                                    }
                                                }
                                                if ($tripServedOut == false) {
                                                    $plannedOut['status'] = "MISSED TRIP";
                                                } else {
                                                    $plannedOut['status'] = "TRIP SERVED";
                                                }
                                                $tripOut[$countTripPlannedOut] = $plannedOut;
                                            }
                                        }
                                    }
                                    $inbound['allTripIn'] = $tripIn;
                                    $inbound['total_per_inbound'] = $countTripPlannedIn;
                                    $outbound['allTripOut'] = $tripOut;
                                    $outbound['total_per_outbound'] = $countTripPlannedOut;
                                }
        
                                if ($countTripPlannedIn != 0 && $countTripPlannedOut != 0) {
                                    $trip_data[$routeNameIn] = $inbound;
                                    $trip_data[$routeNameOut] = $outbound;
                                    $trip_data['total_per_date'] = $countTripPlannedIn + $countTripPlannedOut;
                                } elseif ($countTripPlannedIn > 0 && $countTripPlannedOut == 0) {
                                    $trip_data[$routeNameIn] = $inbound;
                                    $trip_data[$routeNameOut] = [];
                                    $trip_data['total_per_date'] = $countTripPlannedIn;
                                } elseif ($countTripPlannedIn == 0 && $countTripPlannedOut > 0) {
                                    $trip_data[$routeNameIn] = [];
                                    $trip_data[$routeNameOut] = $outbound;
                                    $trip_data['total_per_date'] = $countTripPlannedOut;
                                } else {
                                    $trip_data[$routeNameIn] = [];
                                    $trip_data[$routeNameOut] = [];
                                    $trip_data['total_per_date'] = 0;
                                }
        
                                $tripPerDate[$all_date] = $trip_data;
        
                                $totalTripPlannedIn += $countTripPlannedIn;
                                $totalTripPlannedOut += $countTripPlannedOut;
                            }
                            $sumTotal = $totalTripPlannedIn + $totalTripPlannedOut;
                            if($sumTotal==0){
                                $perDate = [];
                            }else{
                                $perDate['allDate'] = $tripPerDate;
                                $perDate['total_per_route'] = $sumTotal;
                            }
        
                            $route[$routeByCompany->route_number] = $perDate;
        
                            $grandTripPlannedIn += $totalTripPlannedIn;
                            $grandTripPlannedOut += $totalTripPlannedOut;
                        }
                        $sumGrand = $grandTripPlannedIn + $grandTripPlannedOut ;
                        if($sumGrand==0){
                            $grand = [];
                        }else{
                            $grand['allRoute'] = $route;
                            $grand['grand'] = $sumGrand;
                        }
                        $tripPlanned->add($grand);
                    }
                    //TripPlanned certain route for specific company
                    else{
                        $selectedRoute = Route::where('id', $validatedData['route_id'])->first();
                        $routeNameIn = $selectedRoute->route_name;
                        $routeNameOut = implode(" - ",array_reverse(explode("-", $routeNameIn)));
                        $totalTripPlannedIn = 0;
                        $totalTripPlannedOut = 0;
                        $trip_data = [];
                        
        
                        foreach($all_dates as $all_date) {
                            $firstDate = new Carbon($all_date);
                            $lastDate = new Carbon($all_date . '23:59:59');
                            $countTripPlannedIn = 0;
                            $countTripPlannedOut = 0;
                            $tripIn = [];
                            $tripOut = [];
        
                            //Trip Planned
                            $schedules = RouteSchedulerDetail::whereBetween('schedule_date', [$firstDate, $lastDate])->get();
        
                            //Inbound
                            $allInboundTrips = TripDetail::where('route_id', $selectedRoute->id)
                                ->whereBetween('start_trip', [$firstDate, $lastDate])
                                ->where('trip_code', 1)
                                ->get();
        
                            //Outbound
                            $allOutboundTrips = TripDetail::where('route_id', $selectedRoute->id)
                                ->whereBetween('start_trip', [$firstDate, $lastDate])
                                ->where('trip_code', 0)
                                ->get();
        
                            if (count($schedules) > 0) {
                                foreach ($schedules as $schedule) {
                                    if ($schedule->RouteScheduleMSTR->route_id == $selectedRoute->id) {
                                        $tripServedIn = false;
                                        $tripServedOut = false;
        
                                        if($schedule->RouteScheduleMSTR->trip_code){
                                            //Inbound
                                            $countTripPlannedIn++;
                                            $plannedIn['route_name'] = $routeNameIn;
                                            $plannedIn['trip_date'] = $all_date;
                                            $plannedIn['service_time'] = $schedule->RouteScheduleMSTR->schedule_start_time;
                                            $plannedIn['trip_no'] = 'T' . $countTripPlannedIn;
                                            if($schedule->RouteScheduleMSTR->bus_id != NULL) {
                                                $plannedIn['bus_reg_no'] = $schedule->RouteScheduleMSTR->Bus->bus_registration_number;
                                                $plannedIn['bus_age'] = $schedule->RouteScheduleMSTR->Bus->bus_age;
                                            }else{
                                                $plannedIn['bus_reg_no'] = 'NO DATA';
                                                $plannedIn['bus_age'] = 'NO DATA';
                                            }
                                            $plannedIn['km_rate'] = $charge;
            
                                            foreach ($allInboundTrips as $allInboundTrip) {
                                                if ($schedule->RouteScheduleMSTR->id == $allInboundTrip->route_schedule_mstr_id) {
                                                    $tripServedIn = true;
                                                }
                                            }
                                            if ($tripServedIn == false) {
                                                $plannedIn['status'] = "MISSED TRIP";
                                            } else {
                                                $plannedIn['status'] = "TRIP SERVED";
                                            }
                                            $tripIn[$countTripPlannedIn] = $plannedIn;
                                        }else{
                                            //Outbound
                                            $countTripPlannedOut++;
                                            $plannedOut['route_name'] = $routeNameOut;
                                            $plannedOut['trip_date'] = $all_date;
                                            $plannedOut['service_time'] = $schedule->RouteScheduleMSTR->schedule_start_time;
                                            $plannedOut['trip_no'] = 'T' . $countTripPlannedOut;
                                            if($schedule->RouteScheduleMSTR->bus_id != NULL) {
                                                $plannedOut['bus_reg_no'] = $schedule->RouteScheduleMSTR->Bus->bus_registration_number;
                                                $plannedOut['bus_age'] = $schedule->RouteScheduleMSTR->Bus->bus_age;
                                            }else{
                                                $plannedOut['bus_reg_no'] = 'NO DATA';
                                                $plannedOut['bus_age'] = 'NO DATA';
                                            }
                                            $plannedOut['km_rate'] = $charge;
            
                                            foreach ($allOutboundTrips as $allOutboundTrip) {
                                                if ($schedule->RouteScheduleMSTR->id == $allOutboundTrip->route_schedule_mstr_id) {
                                                    $tripServedOut = true;
                                                }
                                            }
                                            if ($tripServedOut == false) {
                                                $plannedOut['status'] = "MISSED TRIP";
                                            } else {
                                                $plannedOut['status'] = "TRIP SERVED";
                                            }
                                            $tripOut[$countTripPlannedOut] = $plannedOut;
                                        }
                                    }
                                }
                                $inbound['allTripIn'] = $tripIn;
                                $inbound['total_per_inbound'] = $countTripPlannedIn;
                                $outbound['allTripOut'] = $tripOut;
                                $outbound['total_per_outbound'] = $countTripPlannedOut;
                            }
        
                            if ($countTripPlannedIn != 0 && $countTripPlannedOut != 0) {
                                $trip_data[$routeNameIn] = $inbound;
                                $trip_data[$routeNameOut] = $outbound;
                                $trip_data['total_per_date'] = $countTripPlannedIn + $countTripPlannedOut;
                            } elseif ($countTripPlannedIn > 0 && $countTripPlannedOut == 0) {
                                $trip_data[$routeNameIn] = $inbound;
                                $trip_data[$routeNameOut] = [];
                                $trip_data['total_per_date'] = $countTripPlannedIn;
                            } elseif ($countTripPlannedIn == 0 && $countTripPlannedOut > 0) {
                                $trip_data[$routeNameIn] = [];
                                $trip_data[$routeNameOut] = $outbound;
                                $trip_data['total_per_date'] = $countTripPlannedOut;
                            } else {
                                $trip_data[$routeNameIn] = [];
                                $trip_data[$routeNameOut] = [];
                                $trip_data['total_per_date'] = 0;
                            }
        
                            $tripPerDate[$all_date] = $trip_data;
        
                            $totalTripPlannedIn += $countTripPlannedIn;
                            $totalTripPlannedOut += $countTripPlannedOut;
                        }
                        $sumTotal = $totalTripPlannedIn + $totalTripPlannedOut;
                        if($sumTotal==0){
                            $grand = [];
                        }else{
                            $perDate['allDate'] = $tripPerDate;
                            $perDate['total_per_route'] = $sumTotal;
                            $sumGrand = $sumTotal;
                            $route[$selectedRoute->route_number] = $perDate;
                            $grand['allRoute'] = $route;
                            $grand['grand'] = $sumGrand;
                        }
        
                        $tripPlanned->add($grand);
                    }
                }
            }
            return Excel::download(new SPADTripPlanned($tripPlanned, $validatedData['dateFrom'], $validatedData['dateTo'], $networkArea), 'Trip_Planned_Report_SPAD_'.Carbon::now()->format('YmdHis').'.xlsx');
        }else{
            $this->dispatchBrowserEvent('company-required');
        }
    }
}
